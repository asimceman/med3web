{"version":3,"sources":["serviceWorker.js","demo/store/ActionTypes.js","demo/store/ModeView.js","demo/store/Modes2d.js","demo/store/Modes3d.js","demo/store/Modes3droi.js","demo/store/Store.js","demo/ui/UiMainMpr.js","demo/ui/UiCtrl2d.js","demo/engine/tools2d/ToolPick.js","demo/engine/tools2d/ToolZoom.js","demo/engine/tools2d/ToolDistance.js","demo/engine/tools2d/ToolClear.js","demo/engine/tools2d/ToolAngle.js","demo/engine/tools2d/ToolArea.js","demo/engine/tools2d/ToolRect.js","demo/engine/tools2d/ToolText.js","demo/engine/tools2d/ToolEdit.js","demo/engine/tools2d/ToolDelete.js","demo/engine/tools2d/ToolTypes.js","demo/engine/Segm2d.js","demo/engine/loaders/roipalette.js","demo/engine/Graphics2d.js","demo/ui/UiTools2d.js","demo/ui/UiSegm2d.js","demo/engine/Texture3D.js","demo/engine/Volume.js","demo/ui/UiVolIcon.js","demo/ui/UiVolumeSel.js","demo/ui/UiMain2d.js","demo/engine/TransFunc.js","demo/ui/UiHistogram.js","demo/ui/UiTF.js","demo/ui/UiTFroi.js","demo/ui/UiRoiSelect.js","demo/ui/UiCtrl3dLight.js","demo/ui/UiCtrl3d.js","demo/engine/GlSelector.js","demo/engine/orbitcontrol.js","demo/engine/shaders/backface.vert","demo/engine/shaders/backface.frag","demo/engine/gfx/matbackface.js","demo/engine/shaders/frontface.vert","demo/engine/shaders/frontface.frag","demo/engine/gfx/matfrontface.js","demo/engine/gfx/matwireframecull.js","demo/engine/gfx/matscreentexmapping.js","demo/engine/shaders/clipplane.vert","demo/engine/shaders/clipplane.frag","demo/engine/gfx/matclipplane.js","demo/engine/shaders/rendertotexture.vert","demo/engine/shaders/rendertotexture.frag","demo/engine/gfx/matrendertotexture.js","demo/engine/shaders/interpolation.vert","demo/engine/shaders/interpolation.frag","demo/engine/gfx/matinterpolation.js","demo/engine/shaders/volumerender.vert","demo/engine/shaders/volumerender.frag","demo/engine/gfx/matvolumerender.js","demo/engine/shaders/blur.vert","demo/engine/shaders/blur.frag","demo/engine/gfx/matblur.js","demo/engine/shaders/createAO.vert","demo/engine/shaders/createAO.frag","demo/engine/gfx/matAO.js","demo/engine/actvolume/pointlink.js","demo/engine/actvolume/pointset.js","demo/engine/actvolume/triindices.js","demo/engine/actvolume/triangleset.js","demo/engine/actvolume/trianglesingle.js","demo/engine/actvolume/trianglestack.js","demo/engine/actvolume/tetra.js","demo/engine/ambientTexture.js","demo/engine/transferTexture.js","demo/engine/Eraser.js","demo/engine/volumeFilter3d.js","demo/engine/tools23d/canvastext.js","demo/engine/tools23d/text2d.js","demo/engine/gfx/mattplain.js","demo/engine/tools23d/meshtext2d.js","demo/engine/gfx/matcolor2d.js","demo/engine/tools23d/line2d.js","demo/engine/tools23d/distancetool.js","demo/engine/tools23d/graphics23d.js","demo/engine/VolumeRenderer3d.js","demo/engine/Graphics3d.js","demo/ui/UiMain3dLight.js","demo/ui/UiMain.js","demo/engine/LoadResult.js","demo/engine/loaders/FileLoader.js","demo/engine/loaders/LoaderKtx.js","demo/engine/loaders/LoaderNifti.js","demo/engine/loaders/dicomdict.js","demo/engine/loaders/dicominfo.js","demo/engine/loaders/dicomtag.js","demo/engine/utils/Hash.js","demo/engine/loaders/dicomslice.js","demo/engine/loaders/dicomserie.js","demo/engine/loaders/dicomslicesvolume.js","demo/engine/loaders/dicomsliceinfo.js","demo/engine/loaders/dicomtaginfo.js","demo/engine/loaders/FileTools.js","demo/engine/loaders/LoaderDicom.js","demo/engine/loaders/LoadPromise.js","demo/engine/loaders/LoaderHdr.js","demo/engine/VolumeSet.js","demo/ui/UiModalDemo.js","demo/ui/UiModalGoogle.js","demo/ui/UiModalWinCW.js","demo/engine/loaders/LoaderUrlDicom.js","demo/engine/loaders/LoaderDcmDaikon.js","demo/engine/loaders/LoadDcmUrlDiakon.js","demo/config/config.js","demo/ui/UiOpenMenu.js","demo/ui/UiViewMode.js","demo/ui/UiSkelAni.js","demo/ui/UiAbout.js","demo/engine/savers/SaverNifti.js","demo/ui/UiModalSaveNifti.js","demo/ui/UiSaveMenu.js","demo/ui/UiModalDicomTags.js","demo/engine/utils/Screenshot.js","demo/ui/UiReportMenu.js","demo/engine/actvolume/lungsfill/floodfill.js","demo/engine/actvolume/lungsfill/seedPoints.js","demo/engine/actvolume/lungsfill/lft.js","demo/engine/actvolume/georender.js","demo/engine/actvolume/lapsmooth.js","demo/engine/actvolume/floodfill.js","demo/engine/actvolume/volgen.js","demo/engine/loaders/voltools.js","demo/engine/actvolume/actvol.js","demo/engine/imgproc/Sobel.js","demo/engine/imgproc/BilateralHW.js","demo/engine/imgproc/Gauss.js","demo/ui/UiModalBilateral.js","demo/ui/UiFilterMenu.js","demo/ui/UiModalText.js","demo/ui/UiModalAlert.js","demo/ui/UiErrConsole.js","demo/engine/utils/BrowserDetector.js","demo/ui/UiApp.js","demo/App.js","index.js"],"names":["Boolean","window","location","hostname","match","StoreActionType","SET_IS_LOADED","SET_FILENAME","SET_VOLUME_SET","SET_VOLUME_INDEX","SET_TEXTURE3D","SET_MODE_VIEW","SET_MODE_2D","SET_SLIDER_2D","SET_MODE_3D","SET_SLIDER_3DR","SET_SLIDER_3DG","SET_SLIDER_3DB","SET_SLIDER_Opacity","SET_SLIDER_Isosurface","SET_SLIDER_Brightness","SET_SLIDER_Cut","SET_SLIDER_Quality","SET_SLIDER_ErRadius","SET_SLIDER_ErDepth","SET_VOLUME_Renderer","SET_2D_TOOLS_INDEX","SET_2D_ZOOM","SET_2D_X_POS","SET_2D_Y_POS","SET_GRAPHICS_2D","SET_UI_APP","SET_DICOM_INFO","SET_IS_TOOL3D","SET_SLIDER_Contrast3D","SET_ERR_ARRAY","SET_MODE_3Droi","SET_DICOM_SERIES","SET_LOADER_DICOM","ModeView","VIEW_NA","VIEW_MPR","VIEW_2D","VIEW_3D_LIGHT","VIEW_3D","VIEW_COUNT","Modes2d","NA","SAGGITAL","CORONAL","TRANSVERSE","Modes3d","ISO","RAYCAST","RAYFAST","EREASER","Modes3droi","initialState","isLoaded","fileName","volumeSet","volumeIndex","texture3d","modeView","mode2d","slider2d","slider3d_r","slider3d_g","slider3d_b","mode3d","mode3droi","sliderOpacity","sliderIsosurface","sliderBrightness","sliderCut","sliderQuality","sliderErRadius","sliderErDepth","volumeRenderer","indexTools2d","render2dZoom","render2dxPos","render2dyPos","graphics2d","uiApp","dicomInfo","isTool3D","sliderContrast3D","arrErrors","dicomSeries","loaderDicom","medReducer","state","action","type","Object","assign","UiMainMpr","React","Component","connect","store","UiCtrl2d","props","onModeSaggital","bind","onModeCoronal","onModeTransverse","onMode","m_updateEnable","indexMode","this","gra2d","dispatch","m_mode2d","clear","forceUpdate","forceRender","undefined","refs","val","aval","slider1","slider","get","Number","parseFloat","volSet","volIndex","vol","getVolume","xDim","yDim","zDim","m_xDim","m_yDim","m_zDim","slideRangeMax","valNormalizedTo01","valSlider","varSag","varCor","varTra","getNumVolumes","rangeDescr","wArr","Math","floor","formatterInt","to","valNum","toString","from","valStr","parseInt","jsxSlider","className","onSlide","onChangeSliderSlice","ref","range","start","step","format","tooltips","jsxSliceSelector","Card","Body","ButtonGroup","aria-label","OverlayTrigger","key","placement","overlay","Tooltip","Button","variant","onClick","Header","ToolPick","objGra","m_objGraphics2d","m_wScreen","m_hScreen","m_strMessage","m_xMessage","m_yMessage","m_timeStart","onTimerEnd","wScr","hScr","xScr","yScr","vTex","x","y","z","sliderPosition","zoom","xPos","yPos","xRatioImage","yRatioImage","screenToTexture","bpp","m_bytesPerVoxel","off","m_dataArray","Date","now","setTimeout","console","log","ctx","fillStyle","font","sizeTextRect","measureText","width","textAlign","textBaseline","fillText","ToolZoom","setScreenDim","onMouseWheel","onMouseDown","onMouseUp","onMouseMove","mouseDown","xMouse","yMouse","dx","dy","dxMove","dyMove","evt","max","min","deltaY","detail","zoomNew","xPosNew","yPosNew","ToolDistance","m_pointStart","m_lines","m_mouseDown","m_objEdit","m_xPixelSize","m_yPixelSize","xs","ys","vScr","numLines","length","i","objLine","vScrS","textureToScreen","vs","vScrE","ve","getDistMm","vVolOld","vVolNew","distMm","ind","indexOf","splice","sqrt","push","vEnd","objLastLine","pop","lineWidth","strokeStyle","vsTex","veTex","beginPath","moveTo","lineTo","stroke","xText","yText","strMsg","toFixed","xRel","yRel","xTex","yTex","ToolClear","ToolAngle","m_points","m_numClicks","m_angles","render","numObj","objAngle","vScr0","points","vScr1","vScr2","getAngleForObj","ang","getAngle","angle","v1x","v1y","v2x","v2y","cosAlp","acos","idx","vTex0","vTex1","vs0","numAngles","a","ToolArea","m_areas","m_inCreateMode","m_objSelfIntersect","numAreas","objArea","j","vScrProj","hasSelfIntersection","m_area","getPolyArea","vNew","numPoints","objInter","polyNew","m_vIntersection","m_lineIndex","vAdd","xSize","m_boxSize","ySize","zSize","xScale","yScale","area","vi","vj","areaTri","addPointToPolygon","m_isClosed","v0","v1","pt","getSelfIntersectPoint","arc","TWO","isClosed","xScrCenter","yScrCenter","iPoly","v2","v3","v23","n23","v01","v02","dotUp","dotDn","TOO_SMALL","abs","t01","v20","n01","dotProdDn","t23","iNext","vA","vB","jNext","vC","vD","getLineIntersection","vLast0","vLast1","limPoints","vLine0","vLine1","vIntersect","MIN_DIST","ToolRect","m_rects","m_store","numRects","objRect","vScrMin","vMin","vScrMax","vMax","getRectArea","vTexMin","vTexMax","ToolText","m_texts","m_pointPressed","setText","numTexts","objText","point","str","m_text","text","onShowModalText","ToolEdit","m_mousePressed","m_pointTracked","m_toolTracked","vTexNew","moveEditPoint","tools","m_toolDistance","m_toolAngle","m_toolArea","m_toolRect","m_toolText","trackedBefore","numTools","objTool","vDetect","getEditPoint","trackedNow","fill","ToolDelete","deleteObject","Tools2dType","INTENSITY","DISTANCE","ANGLE","AREA","RECT","TEXT","EDIT","DELETE","CLEAR","ZOOM","DEFAULT","FILTER","NONE","OUT_W","OUT_H","Segm2d","objGraphics2d","stage","model","tensorIndices","imgData","pixels","srcImageData","wSrc","hSrc","onLoadModel","startApplyImage","m_needApplySegmentation","tensor","numValues","shape","tensorData","dataSync","strDebug","numCols","numRows","strOut","pixelsSrcInt","pixelsDst","wDst","hDst","ySrcAcc","iDst","ySrcBase","ySrcOff","xSrcAcc","xSrcBase","xSrc","tf","strict","modelLoaded","output","imgTensor","fromPixels","toFloat","imgResized","resizeBilinear","mean","imgNormalized","sub","imgReshaped","reshape","prediction","predict","outpTensor","as2D","outRes","tensorPreData","tensorIndData","iSrc","bestIndex","valMax","pixelsUpScale","Uint8ClampedArray","scaleUp","palette","random","w","h","strMessage","getStageString","fillRect","strMsgPrint","createImageData","pixDst","data","numBytes","putImageData","RoiPalette","m_palette","createBytePalette256","m_palette256","Uint8Array","PAL_SIZE","numPalColors","strIndexPalette","roiId","arrColor","roiColor","split","rCol","gCol","bCol","Graphics2d","m_sliceRatio","m_zoom","m_xPos","m_yPos","m_isMounted","wRender","hRender","stateMouseDown","segm2d","m_isSegmented","m_toolPick","m_toolZoom","m_toolClear","m_toolEdit","m_toolDelete","m_roiPalette","prepareImageForRender","renderReadyImage","m_mount","clientWidth","clientHeight","setState","wShot","hShot","toDataURL","FONT_SZ","patName","m_patientName","patBirth","m_patientBirth","seriesDescr","m_seriesDescr","institutionName","m_institutionName","operatorsName","m_operatorsName","physicansName","m_physicansName","volIndexArg","objCanvas","getContext","sliceRatio","xyDim","dataSrc","dataDst","roiPal256","getPalette256","pbox","wScreen","hScreen","xyRratio","xPixelSize","yPixelSize","setPixelSize","zSlice","zOff","xStep","yStep","ay","yOff","ax","val4","yzRatio","xSlice","zStep","az","xzRatio","ySlice","setImageData","renderTextInfo","box","getBoundingClientRect","clientX","left","clientY","top","sliderValue","jsxGrapNonSized","mount","style","height","jsxGrapSized","onWheel","UiTools2d","onClickButtonTools","img","txt","ke","msgTp","btn","target","findIndex","obj","alt","gra","indexCur","map","d","strAttr","jsxBtn","id","src","msgTooltip","UiSegm2d","onChangeSegm2d","isSegmented","segm","Form","Check","inline","label","onChange","Text","Texture3D","m_texture","THREE","Volume","m_dataSize","m_xIcon","m_yIcon","m_dataIcon","xyzDim","assert","sizeSrcMax","scale","numPixelsIcon","xDstL","yDstT","yDst","ySrc","xDst","xWrite","yWrite","xDimNew","yDimNew","zDimNew","xyzDimNew","bytesPerVoxel","bufSizeBytes","datArrayNew","zOffDst","yOffDst","val0","val1","val2","val3","offDst","UiVolIcon","m_volIndex","numPixels","index","UiVolumeSel","onClickRow","indexSelected","makeDimensions4x","tex3d","createFromRawVolume","setVolumeIndex","vols","m_volumes","strPatName","strStudyDescr","m_studyDescr","strTitle","ListGroup","numSlices","strSer","strVo","ListGroupItem","active","UiMain2d","transfFuncObj","m_indexMoved","m_handleX","m_handleY","strMinHeight","minHeight","jsxVolSel","Container","fluid","Row","Col","md","lg","position","TransfFunc","m_numHandles","m_handleColors","r","g","b","m_proj","xMin","yMin","m_xMin","m_yMin","xPre","yPre","RAD_CIRCLE","m_radCircle","xFunc","yFunc","strRCol","strGCol","strBCol","strColor","ellipse","PI","xScrNew","yScrNew","UiHistogram","m_histogram","m_numColors","m_transfFunc","m_transfFuncCallback","m_transfFuncUpdateCallback","setSize","updateCanvas","addEventListener","handleResize","removeEventListener","objOwner","m_canvasOwner","dataArray","Array","scl","smoothHistogram","getMaxPeak","numColors","histogramArray","valMin","IND_MIN","found","m_peakIndex","hist","maxPeakVal","peakVal","sigma","needNormalize","SIZE_DIV","RAD","SIZE_LARGE","KOEF","newHist","maxVal","sum","sumW","di","ii","t","exp","canvasHistogram","volume","getVolumeHistogram","xMax","yMax","wRect","hRect","maxHistValue","valMark","v","closePath","setLineDash","transfFunc","transfFuncUpdate","cw","ch","UiTF","onAO","offAO","onStartEr","onStopEr","onUndo","onSave","isoThreshold","setAmbientTextureMode","offAmbientTextureMode","setEraserStart","undoEraser","volumeUpdater","updateVolumeTextureWithMask","sliderTF","nextProps","flag","wArrOpacity","wArrIsosurface","wArrErRadius","wArrErDepth","funcTra","transferFuncCallback","jsxVolumeTF","Item","onChangeSliderTF","onChangeSliderOpacity","jsxIsoTF","onChangeSliderIsosurface","jsxEreaser","onChangeSliderErRadius","onChangeSliderErDepth","UiTFroi","UiRoiSelect","m_setRoiFunc","onChangeSelectAll","onChangeRoiIndi","arrPal","getPalette","numPalElems","arrState","elem","ename","name","ecolor","eid","eposition","color","selected","allSelected","checkboxes","isCheck","checked","arrStates","numElems","setRoiFunc","strSel","Title","Group","controlId","strCol","UiCtrl3dLight","onModeA","onModeB","onModeC","onModeD","onModeroi","setEraserMode","arrayRoi","selectedROI","isSel","updateSelectedRoiMap","strA","strB","strC","strD","ERASER","jsxRenderControls","jsxROI","as","setRoi","indx","UiCtrl3d","updateTransferFuncTexture","funcTrTex","GlSelector","m_useWebGL2","canvas","document","createElementNS","context","OrbitControl","domElem","camera","scene","mesh","meshRotationCallback","m_callback","m_mesh","m_wireMesh","m_camera","m_target","m_scene","m_button","EVENT_BUTTON_NA","m_pressedLeft","m_pressedRight","m_prevMouse","m_prevTime","m_deltaTime","m_spherical","m_sphericalDelta","set","m_autoRotate","m_minDistance","m_maxDistance","m_minAzimuthAngle","Infinity","m_maxAzimuthAngle","m_minPolarAngle","m_maxPolarAngle","m_enableDamping","m_dampingFactor","isEraserMode","isOn","wireMesh","xx","offsetLeft","yy","offsetTop","curTimeMs","getTime","rotationY","rotationX","matrix","camDir","copy","normalize","makeRotationAxis","up","cross","identity","multiply","rotation","setFromRotationMatrix","ctrlKey","updateTime","delta","camPos","multiplyScalar","lookAt","updateMatrixWorld","EVENT_BUTTON_LEFT","EVENT_BUTTON_CENTER","EVENT_BUTTON_RIGHT","MaterialBF","m_strShaderVertex","m_strShaderFragment","callbackMat","vertexLoader","setResponseType","fragmentLoader","load","BACK_FACE_VERTEX_SHADER","strVertexSh","BACK_FACE_FRAGMENT_SHADER","strFragmentSh","material","vertexShader","fragmentShader","side","depthTest","depthFunc","blending","MaterialFF","m_uniforms","texBF","value","PlaneX","PlaneY","PlaneZ","textureBF","FRONT_FACE_VERTEX_SHADER","FRONT_FACE_FRAGMENT_SHADER","uniforms","e","status","statusText","MaterialWC","m_defines","backCullMode","texFF","textureFF","defines","wireframe","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","MaterialScreenTexMap","texBuffer","MaterialClipPlane","MVP","CLIP_VERTEX_SHADER","CLIP_FRAGMENT_SHADER","depthWrite","MaterialRenderToTexture","texTF","texVolume","texRoiId","texRoiColor","RoiVolumeTex","texVolumeMask","texVolumeAO","lightDir","t_function1min","t_function1max","t_function2min","t_function2max","stepSize","texSize","brightness3D","contrast3D","colorMap1D","heatMap1D","opacityBarrier","tileCountX","volumeSizeZ","ssaoOffsets","isoRenderFlag","MaskFlag","useAmbientTex","useWebGL2","texVol2d","texVolMask","texVolAO","texBackface","texFrontface","offsets","RENDER_TEXTURE_VERTEX_SHADER","RENDER_TEXTURE_FRAGMENT_SHADER","MaterialInterpolation","isoSurfTexel","texIsoSurface","renderTexture","INTERP_VERTEX_SHADER","INTERP_FRAGMENT_SHADER","MaterialVolumeRender","VOL_RENDER_VERTEX_SHADER","VOL_RENDER_FRAGMENT_SHADER","MaterialBlur","texVolumeRoi","texSegInUse","texelSize","blurSigma","contrast","brightness","curZ","save_flag","renderRoiMap","texture","texRoi","BLUR_VERTEX_SHADER","BLUR_FRAGMENT_SHADER","MaterialAO","TEXEL_SIZE_1_256","VOL_SIZE_Z","vectorsTex","vectorsSize","AO_VERTEX_SHADER","AO_FRAGMENT_SHADER","PointLink","m_point","m_next","PointSet","create","m_numPoints","m_numAllocatedPoints","m_voxels","PSET_NUM_VOXELS","dz","iSlow","findPointSlow","TriangleIndices","ia","ib","ic","m_indices","Int32Array","TriangleSet","numTriangles","m_numTriangles","m_numAllocatedTriangles","m_triangles","TriangleSingle","va","vb","vc","TriangleStack","m_numAllocated","m_numStacked","m_stack","depthLevel","numTiEstimate","TetrahedronGenerator","m_pointSet","m_triangleSet","vRadiusEllipse","numSubdividesOfOrigTetra","X","Z","vdata","tindices","i3","addPoint","addTriangle","subDivideMesh","getNumPoints","numVertices","strNumVertices","concat","strNumTriangles","vert","strX","strY","strZ","triIndices","strIndices","arr","TextEncoder","encode","blob","Blob","url","URL","createObjectURL","linkGen","createElement","setAttribute","eventGen","createEvent","initMouseEvent","dispatchEvent","strNumVerts","i0","i1","i2","strNumTri","triStackSrc","triStackDst","getNumTriangles","okPush","stackSrc","stackDst","iter","numStacked","getStackDepth","s","triSingle","v12","v31","addVectors","stackTmp","numTrisInStack","estimateNumVertices","isEmpty","indA","indB","indC","okAddTri","numPts","numTris","AmbientTexture","inParams","rendererBlur","renderer","sceneBlur","cameraOrtho","VAL_255","gen","vRadius","numAOVectors","getNumVertices","vectors","getVertex","wrapS","wrapT","magFilter","minFilter","needsUpdate","_setAOVectorTex","xDimAO","yDimAO","zDimAO","bufferTextureAO","depthBuffer","ambientVolumeTexCPU","isWebGL2","wrapR","mat","materialAO","zTexDivSqrt","setAmbientTextureWebGL2","frameBuf","gl","overrideMaterial","readPixels","RGBA","UNSIGNED_BYTE","zOffs","TransferTexture","selectedROIs","transferFuncRgba","transferFuncTexture","numRois","isRoiVolume","roiColors","numTfPixels","createSelectedRoiMap","createRoiColorMap","textureOut","alpha","SCALE","a1","A1","a3","A3","a4","a5","A5","pix","A2","colors","transferFuncCtrlPtsRgb","intensities","opacities","curPt","pixStart","pixEnd","lerpVal","colorX","colorY","colorZ","op1","op2","colorArray","colorROIs","selectedState","initMatBlure","Eraser","bufferBF","bufferFF","bufferRenderToTexture","volTextureMask","geometry","lastSize","lastDepth","lastRotationVector","lastTarget","lastMode","lastBackDistance","resetflag","bufferTextureCPU","params","buff","bufBF","bufFF","bufTex","bufferMask","updatableTextureMask","dispose","windowWidth","startflag","round","eraserMouseDown","cellInd","bigCellInd","dist","vX","vY","vZ","vDir","erasePixels","orbitControl","lockEraserBuffersUpdating","renderState","RENDER_STATE","ONCE","radius","depth","x_","y_","z_","targetX","targetY","targetZ","normal","normalGauss","SIGMA2","nX","nY","nZ","normFactor","k","gZ","gauss","curVal","radiusRatio","axis","quaternion","setFromUnitVectors","clone","prevDistance","queue","deleteflag","RotPoint","applyAxisAngle","mainX","mainY","mainZ","isoSurfaceBorder","tan","angleTo","targetLast","lastRotation","rxy","lastback","VolumeFilter3d","transferFunc","eraser","glSelector","createWebGLContext","canvas3d","getCanvas","ambientTexture","geometryBlur","init","origVolumeTex","add","switchToBlurRender","switchToRoiMapRender","setVolumeTexture","createTransferFuncTexture","ctrlPtsColorsHex","setTransferFuncColors","setVolumeTextureWebGL2","updatableTexture","zVolOff","yVolOff","offSrc","valInt","arrPixels","bufferR","bufferTexture","indxR","indxL","bufferRoi","xVol","valRoi","updateSelectedRoi","set3DTextureFrom4Bytes","set3DTextureFrom1Byte","volTexFormat","initRenderer","createUpdatableVolumeMask","FONT_FOR_TEXT_RENDER","CanvasText","m_textWidth","m_textHeight","m_canvas","m_ctx","strTextToRender","strTextColor","strText","getFontHeight","ceilPowerOfTwo","strFont","body","getElementsByTagName","dummy","dummyText","createTextNode","appendChild","result","offsetHeight","removeChild","valPwr","Text2D","m_align","m_side","m_antialias","updateText","m_font","antialias","MaterialTexturePlain2d","texture1","tex","m_material","blendEquation","blendSrc","blendDst","MeshText2D","m_renderedTextHeight","m_xMax","m_yMax","xc","yc","letterHeight","xAlign","yAlign","strTextBackColor","cleanUp","remove","drawText","psy","psx","m_matTexturePlain","m_geometry","X_TEXT_COORD_MAX","Y_TEXT_COORD_MAX","getXMin","getXMax","getYMin","getYMax","Z_COORD_TEXT","vertices","faceVertexUvs","getNormal","faces","boxCanvas","boxTexture","m_matTextureBox","m_boxMaterial","Z_COORD_BOX","m_boxGeometry","boxNormal","vb0","vb1","vb2","vb3","m_boxMesh","ALIGN_LEFT","ALIGN_RIGHT","ALIGN_CENTER","ALIGN_TOP","ALIGN_BOTTOM","MaterialColor2d","LINE_2D_Z_COORDINATE","Line2D","xe","ye","matColor2d","createWithMaterial","m_xS","m_yS","m_xE","m_yE","m_lineWidth","vLine","vNorm","m_geo","DistanceTool","m_runningState","linesMaterial","m_linesMaterial","m_distances","m_vertexes","m_xStart","m_yStart","m_textWidthScr","m_textColor","m_textBgColor","line","getRenderObject","posX","posY","xS","xZ","yS","yZ","xE","yE","getxS","getyS","getxE","getyE","tools2d","Graphics23d","m_width","m_height","m_materialsTex2d","m_savePosX","m_savePosY","m_posX","m_posY","m_move","m_wProjScreen","m_hProjScreen","m_showTileTexture","xw","yw","m_textTime","m_toolType","m_distanceTool","toolType","clearLines","m_angleTool","m_areaTool","m_rectTool","m_textTool","m_deleteTool","m_editTool","updateLines","fov","degToRad","radToDeg","atan","keyCode","debug","m_volumeData","m_volumeHeader","m_levelSetMode","xt","yt","m_moveTool","m_textArr","m_vertexes2","m_last_lengths","last_length","m_levelSetCircle","clearLevelSetCenter","drawLevelSetCenter","updateMove","updateVertexes","wheelDeltaY","m_zoomTool","updateZoom","createMarkLinesAndText","updateAll","coord","strRet","pnl","strBegin","substring","SHORT_ITEM_PART","strEnd","VOLUME_COLOR1_MIN_R","VOLUME_COLOR2_MIN_G","VOLUME_COLOR2_MIN_B","VOLUME_COLOR2_MAX_R","VOLUME_COLOR2_MAX_G","VOLUME_COLOR2_MAX_B","STEP_SIZE1","STEP_SIZE2","STEP_SIZE3","STEP_SIZE4","OPACITY_SCALE","VolumeRenderer3d","curFileDataType","sceneReadyCounter","renderCounter","sceneClipPlane","scene23D","graphics23d","sceneSphere","meshSphere","newScene","renderScene","planeGeometry","volTexture","bfTexture","ffTexture","renderToTexture","geometrySphere","geometryWireFrameSphere","matBF","matFF","matScreenTex","matWireFrame","matRenderToTexture","matVolumeRender","checkFrameBufferMode","eraserStarted","planeCenterPt","preserveDrawingBuffer","autoClearStencil","autoClearColor","windowHeight","camAspect","setClearColor","domElement","updateCutPlanes","updateLightDir","gammaInput","gammaOutput","ENABLED","DISABLED","fps","isEraseMode","eraserRadius","eraserDepth","eraserSrart","m_eraser","isSculptingMode","sculptingCapturedVertex","sculptingSphereCenter","sculptingSphereSize","vBoxVirt","okCreateTetra","positions","indices","normals","getTriangle","posAttribute","Float32Array","normalsAttribute","indAttribute","addAttribute","setIndex","computeGeometrySphereUVs","screenshotImage","originalAspect","aspect","originalFov","areaOfInterestTanFov2","fov2Tan","shotAspect","tan2Fov","updateProjectionMatrix","isTool23D","Tool23D","values","colorFlag","nonEmptyBoxMin","nonEmptyBoxMax","computeBoundingBox","boundingBox","offset","geo_offset1","geo_offset2","geo_scale","uvw","getAttribute","count","vx","getX","vy","getY","vz","getZ","plane","l2w","getInverse","invPerspective","projectionMatrix","invView","matrixWorld","applyMatrix4","s2w","isFULL3D","sideMax","thresholdIsosurf","removeSphereFromSphereScene","matWCloader","addSphereToSphereScene","matFfThreeGS","matIntetpl","fromGeometry","computeGeometryUVs","roiPalette","palB","MAGIC_COLOR","palG","palR","VolumeFilter3D","createUpdatableVolumeTex","getExtension","bufferBFTextureCPU","bufferFFTextureCPU","renderfTexture","xSmallTexSize","ySmallTexSize","bufferRenderToTextureCPU","createClipPlaneGeometry","setMesh","setWireMesh","matRenderToTextureThreeGS","colorMapTexture","thresholdTissue1","thresholdTissue2","opacityTissue","lightDirComp","matSkullThreeGS","switchToFullVolumeRender","switchToVolumeRender","mtx","extractRotation","xAxis","yAxis","zAxis","centerPt","dot","updateClipPlaneGeometry","setRenderTarget","buffers","setClear","glC","FLOAT","autoClearDepth","vPos","vProjScreen","vProj","project","W_HALF","H_HALF","xProj","yProj","vPrj","applyMatrix3","normalMatrix","setMaskFlag","undoLastErasing","eraserStart","eraseStart","onZoom","Graphics3d","stop","animate","setVolRenderToStore","onKeyDown","onKeyUp","m_volumeRenderer3D","m_renderer","m_frameId","m_prevMode","m_fileDataType","startRotX","startRotY","VolRender","requestAnimationFrame","cancelAnimationFrame","isIso","initWithVolume","focus","containerX","containerY","ereaseStart","stopPropagation","touches","changedTouches","numTouches","pageX","pageY","switchToTool23D","setTransferFuncVec3","switchToIsosurfRender","setIsoThresholdValue","switchToFLATRender","setEraserRadius","setEraserDepth","setOpacityBarrier","updateBrightness","updateZCutPlane","setStepsize","updateContrast","jsxCanvasNonSized","_onMouseMove","_onMouseDown","_onMouseUp","onTouchStart","onTouchEnd","onTouchMove","_onWheel","jsxCanvasSized","tabIndex","UiMain3dLight","modeViewIndex","wArrBrightness","wArrCut","wArrQuality","jsx3dLight","jsx3d","jsxArray","jsxRet","jsxView","onChangeSliderBrightness","overflow-scroll","onChangeSliderQuality","jsxTool","onChangeSliderContrast3D","sm","onChangeSliderCut","UiMain","jsxMainMpr","jsxMain2d","jsxMain3dLight","LoadResult","errorCode","SUCCESS","UNKNOWN","BAD_DICOM","BAD_HEADER","UNSUPPORTED_ENDIANNESS","UNSUPPORTED_COLOR_FORMAT","WRONG_HEADER_DATA_SIZE","WRONG_HEADER_DIMENSIONS","WRONG_HEADER_DATA_TYPE","WRONG_HEADER_BITS_PER_PIXEL","WRONG_HEADER_MAGIC","ERROR_PROCESS_HISTOGRAM","WRONG_IMAGE_DIM_X","WRONG_IMAGE_DIM_Y","WRONG_IMAGE_DIM_Z","ERROR_PIXELS_TAG_NOT_FOUND","ERROR_NO_MEMORY","ERROR_CANT_OPEN_URL","ERROR_WRONG_NUM_SLICES","ERROR_HISTOGRAM_DETECT_RIDGES","ERROR_SCALING","ERROR_INVALID_SLICE_INDEX","ERROR_TOO_SMALL_DATA_SIZE","ERROR_TOO_LARGE_DATA_SIZE","ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED","GInstanceFileLoader","FileLoader","strUrl","m_url","m_request","readFile","doneCallback","rejectCallback","XMLHttpRequest","open","responseType","event","arrBuf","response","enc","TextDecoder","sz","byteLength","bufHead","slice","strBuf","decode","substr","errMsg","send","KtxHeader","LoaderKtx","m_header","m_id","m_endianness","m_glType","m_glTypeSize","m_glFormat","m_glInternalFormat","m_glBaseInternalFormat","m_pixelWidth","m_pixelHeight","m_pixelDepth","m_numberOfArrayElements","m_numberOfFaces","m_numberOfMipmapLevels","m_bytesOfKeyValueData","volDst","callbackProgress","callbackComplete","bufBytes","bufOff","arrayHeaderSign","lenHeaderSign","isHeaderSignCorrect","String","fromCharCode","ENDIAN_CONST","readInt","strFoundEndns","head","MAX_DIM","zMin","zMax","udataOff","readFloat","pwr2","dataSizeCalculated","pwrFinish","progressMask","MM_PER_PIXEL","m_isLoadedSuccessfull","m_fileLoader","readFromBuffer","iVal","buf","arBuf","ArrayBuffer","DataView","setUint8","getFloat32","LoaderNifti","m_littleEndian","bufLen","NIFTI_HEADER_SIZE","headSize","readIntFromBuffer","numDimensions","readShortFromBuffer","dataType","bitPix","NIFTI_DATA_TYPE_INT8","NIFTI_DATA_TYPE_UINT16","isDataTypeCorrect","pixdim1","readFloatFromBuffer","pixdim2","pixdim3","arrDesc","OFF_DESC","strDescr","isGoodSym","numVoxels","dataOff","fval","histArray","histogram","assignArray","indMax","getLastMaxIndex","MAX_BYTE","dataSize","zOffMin","zOffMax","xOffMax","yOffMax","KTX_GL_RED","header","DicomDictionary","TAGS","group","element","vr","numTags","tagDesc","DicomInfo","m_patientDateOfBirth","m_studyDate","m_seriesTime","m_bodyPartExamined","m_patientId","m_patientGender","m_acquisionTime","m_manufacturerName","m_sliceInfo","TAG_TRANSFER_SYNTAX","TAG_META_LENGTH","TAG_PIXEL_DATA","DicomTag","offsetStart","offsetValue","offsetEnd","littleEndian","m_group","m_element","m_vr","m_value","m_offsetStart","m_offsetValue","m_offsetEnd","Hash","strInp","len","hash","charCodeAt","DicomSlice","m_image","m_sliceNumber","m_sliceLocation","m_hash","strMix","getHash","DicomSerie","m_slices","m_minSlice","m_maxSlice","DicomSlicesVolume","m_series","indSerie","getSerieIndex","serieNew","addSlice","numSeries","DicomSliceInfo","m_sliceName","m_fileName","m_tags","DicomTagInfo","m_tag","m_attrName","m_attrValue","FileTools","isValidA","isValidB","lastIndexOf","strFileName","request","strIn","dotFound","sym","c","DEBUG_PRINT_TAGS_INFO","MAGIC_DICM","UNDEFINED_LENGTH","LARGE_NUMBER","TAG_IMAGE_INSTANCE_NUMBER","TAG_BITS_ALLOCATED","TAG_IMAGE_ROWS","TAG_IMAGE_COLS","TAG_IMAGE_HIGH_BIT","TAG_IMAGE_SMALL_PIX_VAL","TAG_IMAGE_LARGE_PIX_VAL","TAG_PIXEL_PADDING_VALUE","TAG_PIXEL_SPACING","TAG_WINDOW_CENTER","TAG_WINDOW_WIDTH","TAG_RESCALE_INTERCEPT","TAG_RESCALE_SLOPE","TAG_RESCALE_TYPE","TAG_PIXEL_REPRESENTATION","TAG_IMAGE_POSITION","TAG_SLICE_LOCATION","TAG_SAMPLES_PER_PIXEL","TAG_SERIES_DESCRIPTION","TAG_SERIES_TIME","TAG_END_OF_ITEMS","TAG_END_OF_SEQUENCE","TAG_SERIES_NUMBER","TAG_SLICE_THICKNESS","TAG_BODY_PART_EXAMINED","TRANSFER_SYNTAX_COMPRESSION_JPEG","TRANSFER_SYNTAX_COMPRESSION_JPEG_LOSSLESS","TRANSFER_SYNTAX_COMPRESSION_JPEG_LOSSLESS_SEL1","TRANSFER_SYNTAX_COMPRESSION_JPEG_BASELINE_8BIT","TRANSFER_SYNTAX_COMPRESSION_JPEG_BASELINE_12BIT","TRANSFER_SYNTAX_COMPRESSION_JPEG_2000_LOSSLESS","TRANSFER_SYNTAX_COMPRESSION_JPEG_2000","TRANSFER_SYNTAX_COMPRESSION_RLE","TAG_PATIENT_NAME","TAG_PATIENT_ID","TAG_PATIENT_BIRTH_DATE","TAG_PATIENT_GENDER","TAG_STUDY_DATE","TAG_STUDY_DESCR","TAG_ACQUISION_TIME","TAG_INSTITUTION_NAME","TAG_PHYSICANS_NAME","TAG_MANUFACTURER_NAME","TAG_OPERATORS_NAME","LoaderDicom","numFiles","needScaleDownTexture","m_needScaleDownTexture","m_folder","m_dictionary","m_imageNumber","m_errors","m_transformSyntax","m_loaders","m_bitsPerPixel","m_padValue","m_windowCenter","m_windowWidth","m_rescaleIntercept","m_rescaleSlope","m_rescaleHounsfield","m_pixelRepresentaionSigned","m_samplesPerPixel","m_seriesNumber","m_nonEmptyBoxMin","m_nonEmptyBoxMax","m_slicesVolume","m_newTagEvent","CustomEvent","desc","imageNumber","m_dicomInfo","m_pixelSpacing","m_filesLoadedCounter","m_numLoadedFiles","m_imagePosMin","m_imagePosMax","m_sliceLocMin","m_sliceLocMax","runLoader","hashSelected","VolumeSet","addVolume","serie","slice0","zBox","imagePosBox","TOO_MIN","ser","sl","sliceData16","val16","slicePad","minVal","valData","BITS_IN_BYTE","srcSlices","numSlicesByTags","minSliceNum","maxSliceNum","num","sort","sliceSrc","dataSrc16","offZ","winMin","valScaled","numPixelsInVolume","XY_MAX_DIM","xDimDst","yDimDst","VolumeTools","scaleTextureDown","xOffMin","yOffMin","m_callbackComplete","createIcon","dataView","byteLengh","little","lenData","m_metaFinished","getUint16","m_metaFinishedOffset","m_metaFound","m_explicit","getStringAt","getVrsStringIndex","getVr","getUint32","getDataVrsStringIndex","dataValue","sqGroup","sqElement","sqLength","getNextTag","SIZE_DWORD","buffer","tag","getTextDesc","getAttrValueAsString","isTransformSyntax","tagDataLen","dvTag","strTagVal","m_needsDeflate","isMetaLength","ratioLoaded","strCtx","arrBufWoHead","indexFile","sliceInfo","strSlice","m_error","getUint8","pixelBitMask","pixelPaddingValue","pixelsTagReaded","isPixelData","numlices","tagInfo","numberToHexString","strTagName","strVal","dataLen","dv","strNum","dataLenPixRep","dvPixRep","highBit","getInt16","getInt32","strArr","zPos","strSliceThickness","strSliceLocation","sliceLoc","strTimeMerged","strHour","strMinute","strSec","strTimeBuild","getUtf8StringAt","trim","strDateMerged","strM","imageSizeBytes","volSlice","Int16Array","Uint16Array","buildHash","imageDst","imageSrc","b0","b1","b2","ft","isValidUrl","getFolderNameFromUrl","urlFileList","fileLoader","m_callbackProgress","m_fileListCounter","readReadyFileList","constructor","uint8Arr","strFileContent","apply","strLog","arrFileNames","endsWith","m_numFailsLoad","urlFile","loader","fromGoogle","m_fromGoogle","fileArrBu","readFromGoogleBuffer","series","getSeries","buildSeriesInfo","errStatus","createVolumeFromSlices","VRS","DATA_VRS","lengthBuf","char2","ch2","ch3","tmp","res","readBytes","toLocaleDateString","getFloat64","numLeadZeros","strZeros","LoadFilePromise","m_file","m_reader","file","Promise","resolve","FileReader","readAsArrayBuffer","reject","strError","loaded","total","LoaderHdr","volumeDst","sizeofHdr","strDataType","m_dataType","iExtents","iRegular","readByteFromBuffer","dim1","dim2","dim3","SIZE_SHORT","dataTypeH","bitPixH","pixDim1","pixDim2","pixDim3","m_imageBufferSize","m_arrBuf","bytesPerPixel","estimatedVolSize","dataArray16","volRoi","dataNew","dataArrayRoi8","getFileNameFromUrl","arrGrp","exec","namePrefix","fileNameIntensityHeader","fileNameIntensityImage","fileNameMaskHeader","fileNameMaskImage","arrUrls","readFromUrls","numUrls","urlHdr","urlImg","loaderHdr","loaderImg","indPointH","strCopy","readFromUrl","then","arrBufHdr","readFromBufferHeader","arrBufImg","readFromBufferImage","createVolumeFromHeaderAndImage","error","urlHdrInt","urlImgInt","urlHdrRoi","urlImgRoi","loaderHdrInt","loaderImgInt","loaderHdrRoi","loaderImgRoi","arrBufferHdr","arrBufferImg","createRoiVolumeFromHeaderAndImage","m_numVolumes","isInteger","UiModalDemo","onModalShow","onModalHide","onButton0","onButton1","onButton2","onButton3","onButton4","onButton5","onButton6","onButton7","onDemo","showModalDemo","onSelectFunc","onSelectDemo","onHideFunc","onHide","stateVis","iconsSet","tooltip","image","func","Modal","show","closeButton","strId","strTooltip","strImage","strAlt","funcCallback","delay","hide","Image","thumbnail","UiModalGoogle","prp","m_onHideFunc","strTextMenu","innerHTML","getIndex","m_arrMenu","m_funcDemo","arrMenu","strElem","UiModalWindowCenterWidth","m_objCanvas","m_dataMin","m_dataMax","onButtonCancel","onButtonApply","showModalWindowCenterWidth","windowMin","windowMax","reset","hashCode","onRef","renderPreview","slices","valSrc","wMin","wMax","wc","ww","drawSlice","arrVals","sliderRange","isValid","getDataMinMax","jsxCanvas","valDelta","valStep","rangeTwo","size","m_objCol","onSliderWindowRange","LoaderUrlDicom","m_arrFileNames","m_loaderDicom","callbackReadProgress","callbackReadComplete","ratio01","ratioPrc","uiapp","doShowProgressBar","doHideProgressBar","doSetProgressBarRatio","codeResult","strErr","getResultString","finalizeFailedLoadedVolume","m_volume","finalizeSuccessLoadedVolume","fileNameIn","SET_VOLUME","tp","fileTools","fileNameUrl","LoaderDcmDaikon","strContent","dataFile","daikon","Series","parseImage","err","TAG_DIRECTORY_REC","Utils","dec2hex","tagDirRec","tags","numEntries","dirEntry","numSub","elemSub","fold","fname","fileIndex","getRows","getCols","bits","getBitsAllocated","patientName","getPatientName","studyDescr","getImageDescription","studyDate","getStudyDate","seriesTime","getStudyTime","getSeriesDescription","knownTags","Tag","TAG_ROWS","TAG_COLS","TAG_ACQUISITION_MATRIX","TAG_NUMBER_OF_FRAMES","TAG_NUMBER_TEMPORAL_POSITIONS","TAG_SLICE_GAP","TAG_TR","TAG_FRAME_TIME","TAG_BITS_STORED","TAG_HIGH_BIT","TAG_PHOTOMETRIC_INTERPRETATION","TAG_PLANAR_CONFIG","TAG_PALETTE_RED","TAG_PALETTE_GREEN","TAG_PALETTE_BLUE","TAG_DATA_SCALE_SLOPE","TAG_DATA_SCALE_INTERCEPT","TAG_DATA_SCALE_ELSCINT","TAG_PIXEL_BANDWIDTH","TAG_IMAGE_MIN","TAG_IMAGE_MAX","TAG_STUDY_TIME","TAG_STUDY_DES","TAG_IMAGE_TYPE","TAG_IMAGE_COMMENTS","TAG_SEQUENCE_NAME","TAG_MODALITY","TAG_FRAME_OF_REF_UID","TAG_STUDY_UID","TAG_SERIES_INSTANCE_UID","TAG_ECHO_NUMBER","TAG_TEMPORAL_POSITION","TAG_IMAGE_NUM","TAG_IMAGE_ORIENTATION","TAG_SLICE_LOCATION_VECTOR","TAG_LUT_SHAPE","getSingleValueSafely","getTag","numKnownTags","tagSLoc","tagSlNum","sliceNumber","tagSamPerPix","samPerPixel","tagPPV","valPad","tagWinCen","tagWinWid","tagResInt","tagResSlo","tagResTyp","tagPixRep","tagPS","arrSpa","tagSLT","arrThick","tagImPos","tagTraSyn","getRawData","pixSrc","bVal","gVal","rVal","loadSingleSlice","ret","LoaderDcmUrlDaikon","m_loaderDaikon","demoUrls","googleCloudDemoActivce","arrMenuGoogle","demoWomanPelvisPrefix","demoWomanPelvisUrls","demoLungsPrefix","demoLungsUrls","UiOpenMenu","onButtonLocalFile","handleFileSelected","onFileContentReadSingleFile","onFileContentReadMultipleDicom","onFileContentReadMultipleHdr","setErrorString","onModalUrlShow","onModalUrlHide","onClickLoadUrl","callbackReadCompleteUrlKtxNii","onModalDemoOpenShow","onModalDemoOpenHide","onDemoSelected","onModalWindowCWHide","onModalGoogleShow","onModalGoogleHide","onGoogleSelected","onModalDicomSeriesHide","onDicomSerieSelected","callbackReadSingleDicomComplete","callbackReadMultipleComplete","callbackCompleteMultipleDicom","m_fileNameOnLoad","m_fileIndex","m_fileReader","showModalUrl","showModalGoogle","showModalWindowCW","onLoadCounter","m_volumeSet","m_volumeRoi","roiMode","errCode","arrErr","m_loader","childModalWindowCenterWidth","initWindowRange","callbackCompleteSingleDicom","readFromKtx","readFromNifti","m_numFiles","readFromDicom","onFileReadSingleBuffer","ratioLoad","readSlice","loaderDcm","readSingleSlice","isHdr","fnameArr","detectedMask","detectedIntensity","readOk","ok","FAIL","onloadend","m_files","readStatus","readSliceDicomViaDaikon","STEP_PROGRESS","files","m_unzippedBuffer","gunzip","zlib","createGunzip","createReadStream","pipe","on","readSize","allSize","ratio100","dataCollectedSize","arrNew","sizeBuffer","headTemplate","correctHead0","correctHead1","numFilesNew","fileSelector","onchange","preventDefault","m_fileSelector","click","readFromKtxUrl","readFromNiiUrl","readFromHdrUrl","loadFromUrl","arrNums","numLet","n","config","decodeUrl","strPrefix","strFn","loadFromUrlArray","needShow","buildFileSelector","fileNameOnLoad","isGoogle","jsGoo","NavDropdown","jsDemo","href","jsVidiver","Divider","title","display","InputGroup","Prepend","FormControl","placeholder","aria-describedby","onChangeUrlString","Append","UiViewMode","m_needModeMpr","m_needMode2d","m_needMode3dLight","m_needMode3d","onModeMpr","onMode2d","onMode3dLight","onMode3d","onTool3d","onView3d","onTool_View","viewMode","str2d","str3dLight","str3d","strTool3Don","strTool3Doff","jsxViewTool","needShow3d","ButtonToolbar","ria-label","UiSkelAni","renderWithCtx","border","min-width","timeCur","w2","H_REF","MARK_WIDTH","tHeight","timeArg","wCur","cos","shp","numPointsInShape","numCurves2nd","x1","y1","x2","y2","quadraticCurveTo","xHeart","yHeart","isMirroredX","animParam","W_REF","hp","vec0","vec1","vecTransform","gx0","gy0","gx1","gy1","grad","createLinearGradient","addColorStop","x0","y0","vessels","numVessels","ves","xp","yp","drawLeave","drawCentral","lAnim","lScale","rAnim","rScale","drawHeart","vec","xRelCenter","yRelCenter","sin","UiAbout","modalShow","onShow","strVer","packageJson","version","strName","strDescription","description","strAuthor","author","strYear","year","strButtonOnly","strButtonWithTrigger","strBtnDynamic","Nav","Footer","IS_LITTLE_ENDIAN","SaverNifti","setInt32","setInt16","setFloat32","freq","phase","volumeData","volumeSize","xGrid","yGrid","zGrid","writeIntToBuffer","dimInfo","fpsToDimInfo","writeShortToBuffer","writeFloatToBuffer","volDataUInt16","UiModalSaveNifti","onButtonSave","onTexChange","handleFormSubmit","onSaveNifti","m_hideFunc","showModalSaveNifti","volSize","volData","vR","niiArr","writeBuffer","textToSaveAsBlob","textToSaveAsURL","downloadLink","download","onclick","onSubmit","Table","Control","required","defaultValue","Label","xl","UiSaveMenu","onModalSaveNiftiShow","onModalSaveNiftiHide","strDisabled","disabled","UiModalDicomTags","currentSlice","slicesInfo","tagsList","onSelectSlice","striped","bordered","responsive","strTag","strNam","Screenshot","binary","atob","bytes","btoa","uri","parts","partsCount","bytesFromBase64","imageUri","write","dataUriToBlob","navigator","msSaveBlob","lnk","date","getUTCFullYear","mn","formatTwoDigits","getUTCMonth","dd","getUTCDate","hh","getHours","mi","getMinutes","ss","getSeconds","engineRender","shotW","shotH","screenshot","strFmtDate","getFormattedDateString","saveScreenShotToFile","UiReportMenu","onModalDicomTagsShow","onModalDicomTagsHide","onModalScreenshot","showModalDicomTags","makeScreenshot","volRender","FloodFill","m_stack3d","m_maxStack3d","m_indexStack3d","m_numFilled3d","vSeed","threshold","stack","VIS","isVisible","vTaken","xL","xR","setYLess","setYMore","setZLess","setZMore","TOO_MIN_VAL","SeedPoints","m_volTexSrc","zCenter","yCenter","MIN_LINE_RATIO","numWhitePixels","yMinNew","NUM_45","yMaxNew","NUM_60","goodHistogramDetected","valThreshold","xCenter","cx","cy","pixelsSrc","holeFound","sizeBlackAreaMin","cyOff","numWhiteBarriers","minv","col","zz","zzOff","yyOff","LungsFillTool","VESSEL","xBorderMin","yBorderMin","xBorderMax","yBorderMax","m_volTexMask","m_volTexMask1","m_volTexMask2","m_ratioUpdate","xDimHalf","yDimHalf","z1","resFind","seedPoints","findSeedPointOnCentralSlice","fillTool","FloodFillTool","floodFill3dThreshold","detectNonEmptyBox","delatation","erosion","findSeedPointOnFirstSlice","RESULT_NA","RESULT_COMPLETED","RESULT_BAD_HIST","RESULT_SEED_X_NOT_FOUND","GeoRender","m_numVertices","m_vertices","m_normals","m_numTrianglesAllocated","m_matColor","m_isWireframe","m_boxCenter","Uint32Array","geoBuffered","geo","fromBufferGeometry","mergeVertices","face","vCenter","numSegmentsHor","numSegmentsVert","M_PI","numQuads","ANGLE_QUATER","angleVert","angleHor","horProj","indRowStart","i4","triNormals","vab","vbc","subVectors","vTriNormal","crossVectors","lengthSq","LAPSMOOTH_NUM_NEIBS","LaplasianSmoother","m_vertNeib","vertSrc4","vertDst","iNeib","getVerticesNeighbours","scaleCenter","distAve","vAve","numNeibs","indNeib","vertOffset","vCur","RATIO_CUR","distanceTo","NUM_ELLEMS","addNeib","indFrom","indTo","numPixelsAll","vaSeedPoints","maxSeedPoints","zDimHalf","numItersY","numItersZ","numSeedPointsDetected","zIter","yIter","okCreate","createStack3d","stack3dPush","stack3dEIsEmpty","stack3dPop","vPu","destroyStack3d","VolumeGenerator","verts","dist01","dist02","dist12","distMax","numIters","vLScale","vRScale","vL","vLR","vScale","iterSide","withFillInside","getIndices","getVertices","renderTriangle","pixelsFill","vaSeeds","numSeedPoints","detectSeedPoint3d","foundGoodFill","okFill","floodFill3d","MAX_VOLUME_SIDE_INPUT","m_gaussWeights","GAUSS_SMOOTH_MAX_SIDE","volBuffer","gaussRadius","gaussSigma","side3","koefSpatial","weightSum","dist2","offConv","iSum","histSrc","histDst","windowSize","sumKoef","koef","xyDimSrc","xyDimDst","offSrcZ","offDstZ","offSrcY","offDstY","aveSrc","zDimDst","ACC_BITS","xDimSrc","yDimSrc","zDimSrc","indDst","zSrcAccL","zSrcAccH","zDst","zSrcL","zSrcH","ySrcAccL","ySrcAccH","ySrcL","ySrcH","xSrcAccL","xSrcAccH","xSrcL","xSrcH","zScale","zSrcMin","zSrcMax","ySrcMin","ySrcMax","xSrcMin","xSrcMax","valAve","numPixelsAve","radSmooth","sigmaSmooth","multiplier","needConsoleLog","VOLTOOLS_ERROR_BAD_NUMBER","VOLTOOLS_ERROR_BAD_ARRAY","VOLTOOLS_ERROR_BAD_MULTIPLIER","MAX_POSSIBLE_MULTIPLIER","VOLTOOLS_ERROR_BAD_DIMENSION","MAX_POSSIBLE_DIM","gaussWeights","zc","valSmoothed","offImage","valDif","MIN_DIF_UNSHARP_VAL","valAdd","valSharpened","MAX_COLOR","MASK_MANY","HUNDR","VOLTOOLS_ERROR_OK","numPixelsNew","zOffSrc","yOffSrc","sliceType","sliceIndex","numPixVol","off4","tilesHor","fx","fy","fz","vec2coord","tileScale","zSliceIndex","isRoi","zDimSqrt","lenSrc","VAL255","get2dCoordFromTiled3dCoord","vpwr","vpwrNext","vpwrLess","xShift","yShift","numPixelsSrc","numBytesPerPixel","numPixelsDst","offSrc4","offDst4","numPix","valA","valR","valG","valB","boxMin","boxMax","zBorderMin","zBorderMax","AV_NUM_COLORS","ActiveVolume","m_state","m_pixelsSrc","m_xWorldBox","m_yWorldBox","m_zWorldBox","m_imageGauss","m_imageUniformity","m_verticesNew","m_lapSmoother","m_imageSrc","m_imageGrad","m_gaussStage","m_uniformityStage","m_geoStage","m_colorProbability","m_colorKoefs","m_sphereCenter","m_sphereRadius","m_indexMinColor","m_updateCounter","m_geoRender","m_wasAllocated","m_xScale","m_yScale","m_zScale","xRadius","yRadius","zRadius","xWorldBox","yWorldBox","zWorldBox","zSrcOff","volTexDst","resBoolFill","generateFromFaces","genTetra","geoRender","createFromTetrahedronGenerator","geoSrc","verticesSrc","geoDst","faceNew","computeBoundingSphere","volTexSrc","geoSphere","vBoxVirtX","vBoxVirtY","vBoxVirtZ","numVerts","yVol","zVol","volMask","resFill","valBarrier01","modeEvolve","sphereCenter","TEX_MAX_SIDE","attrVertices","numCompsVert","itemSize","attrNormals","numNormals","numCompsNorm","HALF","DIAG_ONE_TRI","J_START","J_END","VAL_MIN_BORDER","vSrc","vn","SPHERE_EVOLVE_FROM_OUTSIDE","xLocMin","yLocMin","zLocMin","valPrev","hasFoundMinBorder","xv","yv","zv","setXYZ","SPHERE_EVOLVE_FROM_INSIDE","SKAL","xV_","yV_","zV_","xV","yV","zV","vx1","vx2","createType","needLog","TOO_MUCH_SIZE","REMOVE_SKULL","CREATE_MASK","volSizeSrc","numPixSrc","xDim2","yDim2","zDim2","numPredSteps","getPredictedStepsForActiveVolumeUpdate","strType","m_isFinished","m_numPredSteps","m_createType","m_volTexDst","m_needLog","updateGeo","isFinished","hx","hy","hz","xyMax","ACT_VOL_NUM_SMOOTH_STAGES","maxScale","xScaled","yScaled","zScaled","pixelsScaled","scaleDown","zStart","zEnd","pixelsGrad","koefAlpha","cz","SCALE_ALL_ELEMS","ze","czOff","sumDx","sumDy","sumDz","gradLen","rad","dia","m_gaussMatrix","GAUSS_MAX_DIA","wSum","weight","numGaussElems","gScale","zs","smoothArray","indBrightColor","isLocMax","isLarger","indDarkColor","indScanMax","indBrightHalf","isExitFromBrightZoneDetected","numPixelsDarkZone","isCurGreat","valOrig","indDarkColorMax","isLocMin","isLess","smoothStep","createNormalsForGeometry","method","okCreateNormals","startImageSmooth","applyPartGaussSmooth","makeUniformityImage","getHistogram","stopImageSmooth","updateNormals","updateUniformity","updateColorKoefs","updateGeoByVertexNormals","updateGeoByVertexNormalsAndUniformity","updateGeoNormalsUniformityColors","uniAve","inDebugMode","saveGeoToObjFile","normalSpeed","getNormals","performSmoothStep","DEEP_DEBUG","sphereTouchEdge","uni","valGaussCur","compSum","nx","ny","nz","nextOff","valGaussNext","isColorMatch","vAddSmooth","vAddGeo","KOEF_ADD_SMOOTH","errAve","finalizeUpdatesGeo","aveUni","getAveUniformityForGeoVertices","pixStride","totalBufSize","SIZE_HEADER","BYTE_MASK","bfSize","bfOffBits","biSize","biWidth","biHeight","biSizeImage","offSlice","valGrey","minRange","maxRange","arg","gaussRad","dst","mult","ci","sumWeight","MAX_SQRT","SobelEdgeDetector","m_vol","m_z","m_iter","m_pixelsDst","m_sqrtTable","zNext","kx","ky","kz","dotProd","BilateralHW","m_bufferTextureCPU","distSigma","valSigma","kernelSize","STEP","m_frameBuf","koefDist","koefVal","GaussSmoother","needHw","m_needHw","m_kernel","m_bilateralHw","getImageDst","xyzKernel","tz","ty","tx","sigmaDist","createKernel","m_kernelSize","vTexelSize","update","arrKernel","offKer","SZ","createEmptyBytesVolume","getPixelsDst","srcVal","xOff","UiModalBilateral","onButtonStart","onChangeSliderKoefDist","onChangeSliderKoefVal","onBilateralCallback","m_gauss","showModalGauss","m_koefDist","m_koefVal","m_timerId","ratioUpdate","getRatio","clearInterval","slider2","wArrDist","wArrVal","paddingBottom","UiFilterMenu","onButtonLungsSeg","onLungsFillerCallback","onButtonDetectBrain","onSkullRemoveCallback","onButtonSobel","onSobelCallback","onButtonBilateral","showModalBilateral","hideModalBilateral","lungsFiller","run","sobel","m_sobel","normalizeDstImage","volTextureSrc","volTextureDst","CREATE_TYPE","actVolume","m_actVolume","skullRemoveStart","skullRemoveUpdate","skullRemoveStop","UiModalText","onButtonOk","m_showFunc","onTextEntered","onShowFunc","autoFocus","UiModalAlert","UiErrConsole","strKey","BrowserDetector","m_strUserAgent","m_strVendor","m_isOpera","m_isFirefox","m_isSafari","m_isIE","m_isChrome","m_isMobileBrowser","createCanvas","userAgent","toLowerCase","vendor","test","InstallTrigger","search","documentMode","m_isEdge","appVersion","strTitleFinal","isValidBrowserType","mobileArr","innerWidth","innerHeight","UiApp","onHideModalText","onShowModalAlert","onHideModalAlert","m_modalText","showModalText","showProgressBar","progressBarRatio","showModalAlert","strAlertTitle","strAlertText","strProgressMessage","strSearch","browserDetector","isWebGl20supported","checkWebGlSupported","checkValidBrowser","strProgressMsg","ratio","arrErrorsLoadedd","strMessageOnMenu","objPrgBarVis","ProgressBar","animated","objProgressBar","Navbar","bg","expand","Brand","Toggle","aria-controls","Collapse","App","rootElement","getElementById","createStore","rootReducer","ReactDOM","serviceWorker","ready","registration","unregister"],"mappings":"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","file":"static/js/main.a2777081.chunk.js","sourcesContent":["// This optional code is used to register a service worker.\r\n// register() is not called by default.\r\n\r\n// This lets the app load faster on subsequent visits in production, and gives\r\n// it offline capabilities. However, it also means that developers (and users)\r\n// will only see deployed updates on subsequent visits to a page, after all the\r\n// existing tabs open on the page have been closed, since previously cached\r\n// resources are updated in the background.\r\n\r\n// To learn more about the benefits of this model and instructions on how to\r\n// opt-in, read http://bit.ly/CRA-PWA\r\nconst isLocalhost = Boolean(window.location.hostname === 'localhost' ||\r\n    // [::1] is the IPv6 localhost address.\r\n    window.location.hostname === '[::1]' ||\r\n    // 127.0.0.1/8 is considered localhost for IPv4.\r\n    window.location.hostname.match(/^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));\r\nexport function register(config) {\r\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\r\n    // The URL constructor is available in all browsers that support SW.\r\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\r\n    if (publicUrl.origin !== window.location.origin) {\r\n      // Our service worker won't work if PUBLIC_URL is on a different origin\r\n      // from what our page is served on. This might happen if a CDN is used to\r\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\r\n      return;\r\n    }\r\n    window.addEventListener('load', () => {\r\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\r\n      if (isLocalhost) {\r\n        // This is running on localhost. Let's check if a service worker still exists or not.\r\n        checkValidServiceWorker(swUrl, config);\r\n\r\n        // Add some additional logging to localhost, pointing developers to the\r\n        // service worker/PWA documentation.\r\n        navigator.serviceWorker.ready.then(() => {\r\n          console.log('This web app is being served cache-first by a service ' +\r\n              'worker. To learn more, visit http://bit.ly/CRA-PWA');\r\n        });\r\n      } else {\r\n        // Is not localhost. Just register service worker\r\n        registerValidSW(swUrl, config);\r\n      }\r\n    });\r\n  }\r\n}\r\nfunction registerValidSW(swUrl, config) {\r\n  navigator.serviceWorker\r\n    .register(swUrl)\r\n    .then(registration => {\r\n      registration.onupdatefound = () => {\r\n        const installingWorker = registration.installing;\r\n        if (installingWorker == null) {\r\n          return;\r\n        }\r\n        installingWorker.onstatechange = () => {\r\n          if (installingWorker.state === 'installed') {\r\n            if (navigator.serviceWorker.controller) {\r\n              // At this point, the updated precached content has been fetched,\r\n              // but the previous service worker will still serve the older\r\n              // content until all client tabs are closed.\r\n              console.log('New content is available and will be used when all ' +\r\n                  'tabs for this page are closed. See http://bit.ly/CRA-PWA.');\r\n\r\n              // Execute callback\r\n              if (config && config.onUpdate) {\r\n                config.onUpdate(registration);\r\n              }\r\n            } else {\r\n              // At this point, everything has been precached.\r\n              // It's the perfect time to display a\r\n              // \"Content is cached for offline use.\" message.\r\n              console.log('Content is cached for offline use.');\r\n\r\n              // Execute callback\r\n              if (config && config.onSuccess) {\r\n                config.onSuccess(registration);\r\n              }\r\n            }\r\n          }\r\n        };\r\n      };\r\n    })\r\n    .catch(error => {\r\n      console.error('Error during service worker registration:', error);\r\n    });\r\n}\r\nfunction checkValidServiceWorker(swUrl, config) {\r\n  // Check if the service worker can be found. If it can't reload the page.\r\n  fetch(swUrl)\r\n    .then(response => {\r\n      // Ensure service worker exists, and that we really are getting a JS file.\r\n      const contentType = response.headers.get('content-type');\r\n      if (\r\n        response.status === 404 ||\r\n        (contentType != null && contentType.indexOf('javascript') === -1)\r\n      ) {\r\n        // No service worker found. Probably a different app. Reload the page.\r\n        navigator.serviceWorker.ready.then(registration => {\r\n          registration.unregister().then(() => {\r\n            window.location.reload();\r\n          });\r\n        });\r\n      } else {\r\n        // Service worker found. Proceed as normal.\r\n        registerValidSW(swUrl, config);\r\n      }\r\n    })\r\n    .catch(() => {\r\n      console.log('No internet connection found. ' +\r\n        'App is running in offline mode.');\r\n    });\r\n}\r\nexport function unregister() {\r\n  if ('serviceWorker' in navigator) {\r\n    navigator.serviceWorker.ready.then(registration => {\r\n      registration.unregister();\r\n    });\r\n  }\r\n}\r\n","//\r\n// Action type for redux reducer\r\n//\r\nconst StoreActionType = {\r\n  SET_IS_LOADED: 0,\r\n  SET_FILENAME: 1,\r\n  SET_VOLUME_SET: 2,\r\n  SET_VOLUME_INDEX: 3,\r\n  SET_TEXTURE3D: 4,\r\n  SET_MODE_VIEW: 5,\r\n  SET_MODE_2D: 6,\r\n  SET_SLIDER_2D: 7,\r\n  SET_MODE_3D: 8,\r\n  SET_SLIDER_3DR: 9,\r\n  SET_SLIDER_3DG: 10,\r\n  SET_SLIDER_3DB: 11,\r\n  SET_SLIDER_Opacity: 12,\r\n  SET_SLIDER_Isosurface: 13,\r\n  SET_SLIDER_Brightness: 14,\r\n  SET_SLIDER_Cut: 15,\r\n  SET_SLIDER_Quality: 16,\r\n  SET_SLIDER_ErRadius: 17,\r\n  SET_SLIDER_ErDepth: 18,\r\n  SET_VOLUME_Renderer: 19,\r\n  SET_2D_TOOLS_INDEX: 20,\r\n  SET_2D_ZOOM: 21,\r\n  SET_2D_X_POS: 22,\r\n  SET_2D_Y_POS: 23,\r\n  SET_GRAPHICS_2D: 24,\r\n  SET_UI_APP: 25,\r\n  SET_DICOM_INFO: 26,\r\n  SET_IS_TOOL3D: 27,\r\n  SET_SLIDER_Contrast3D: 28,\r\n  SET_ERR_ARRAY: 29,\r\n  SET_MODE_3Droi: 30,\r\n  SET_DICOM_SERIES: 31,\r\n  SET_LOADER_DICOM: 32,\r\n};\r\nexport default StoreActionType;\r\n","const ModeView = {\r\n  VIEW_NA: -1,\r\n  VIEW_MPR: 0,\r\n  VIEW_2D: 1,\r\n  VIEW_3D_LIGHT: 2,\r\n  VIEW_3D: 3,\r\n  VIEW_COUNT: 4\r\n};\r\n\r\nexport default ModeView;\r\n","/**\r\n * @fileOverview Modes2d\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\nconst Modes2d = {\r\n  NA: -1,\r\n  SAGGITAL: 0,\r\n  CORONAL: 1,\r\n  TRANSVERSE: 2\r\n};\r\n\r\nexport default Modes2d;","\r\nconst Modes3d = {\r\n  NA: -1,\r\n  ISO: 0,\r\n  RAYCAST: 1,\r\n  RAYFAST: 2,\r\n  EREASER: 3\r\n};\r\n\r\nexport default Modes3d;\r\n","\r\nconst Modes3droi = {\r\n  NA: -1,\r\n  ISO: 0,\r\n  RAYCAST: 1,\r\n};\r\n\r\nexport default Modes3droi;\r\n","//\r\n\r\nimport StoreActionType from './ActionTypes';\r\nimport ModeView from './ModeView';\r\nimport Modes2d from './Modes2d';\r\nimport Modes3d from './Modes3d';\r\nimport Modes3droi from './Modes3droi';\r\n\r\n//\r\n// Global app settings with initial configuration\r\n//\r\nexport const initialState = {\r\n  isLoaded: false,\r\n  fileName: 'brain.ktx',\r\n  volumeSet: null,\r\n  volumeIndex: 0,\r\n  texture3d: null,\r\n  modeView: ModeView.VIEW_2D,\r\n  mode2d: Modes2d.TRANSVERSE,\r\n  slider2d: 0.5,\r\n  slider3d_r: 0.09,\r\n  slider3d_g: 0.3,\r\n  slider3d_b: 0.46,\r\n  mode3d: Modes3d.RAYCAST,\r\n  mode3droi: Modes3droi.RAYCAST,\r\n  sliderOpacity: 0.53,\r\n  sliderIsosurface: 0.46,\r\n  sliderBrightness: 0.56,\r\n  sliderCut: 1.0,\r\n  sliderQuality: 0.35,\r\n  sliderErRadius: 50.0,\r\n  sliderErDepth: 50.0,\r\n  volumeRenderer: null,\r\n  indexTools2d: 0,\r\n  render2dZoom: 1.0,\r\n  render2dxPos: 0.0,\r\n  render2dyPos: 0.0,\r\n  graphics2d: null,\r\n  uiApp: null,\r\n  dicomInfo: null,\r\n  isTool3D: false,\r\n  sliderContrast3D: 0.0,\r\n  arrErrors: [],\r\n  dicomSeries: [],\r\n  loaderDicom: null,\r\n};\r\n//\r\n// App reducer\r\n//\r\nconst medReducer = (state = initialState, action) => {\r\n  switch (action.type) {\r\n  case StoreActionType.SET_IS_LOADED:\r\n    return Object.assign({}, state, { isLoaded: action.isLoaded });\r\n  case StoreActionType.SET_FILENAME:\r\n    return Object.assign({}, state, { fileName: action.fileName });\r\n  case StoreActionType.SET_VOLUME_SET:\r\n    return Object.assign({}, state, { volumeSet: action.volumeSet });\r\n  case StoreActionType.SET_VOLUME_INDEX:\r\n    return Object.assign({}, state, { volumeIndex: action.volumeIndex });\r\n  case StoreActionType.SET_TEXTURE3D:\r\n    return Object.assign({}, state, { texture3d: action.texture3d });\r\n  case StoreActionType.SET_MODE_VIEW:\r\n    return Object.assign({}, state, { modeView: action.modeView });\r\n  case StoreActionType.SET_MODE_2D:\r\n    return Object.assign({}, state, { mode2d: action.mode2d });\r\n  case StoreActionType.SET_SLIDER_2D:\r\n    return Object.assign({}, state, { slider2d: action.slider2d });\r\n  case StoreActionType.SET_MODE_3D:\r\n    return Object.assign({}, state, { mode3d: action.mode3d });\r\n  case StoreActionType.SET_MODE_3Droi:\r\n    return Object.assign({}, state, { mode3droi: action.mode3droi });\r\n  case StoreActionType.SET_SLIDER_3DR:\r\n    return Object.assign({}, state, { slider3d_r: action.slider3d_r });\r\n  case StoreActionType.SET_SLIDER_3DG:\r\n    return Object.assign({}, state, { slider3d_g: action.slider3d_g });\r\n  case StoreActionType.SET_SLIDER_3DB:\r\n    return Object.assign({}, state, { slider3d_b: action.slider3d_b });\r\n  case StoreActionType.SET_SLIDER_Opacity:\r\n    return Object.assign({}, state, { sliderOpacity: action.sliderOpacity });\r\n  case StoreActionType.SET_SLIDER_Isosurface:\r\n    return Object.assign({}, state, { sliderIsosurface: action.sliderIsosurface });\r\n  case StoreActionType.SET_SLIDER_ErRadius:\r\n    return Object.assign({}, state, { sliderErRadius: action.sliderErRadius });\r\n  case StoreActionType.SET_SLIDER_ErDepth:\r\n    return Object.assign({}, state, { sliderErDepth: action.sliderErDepth });\r\n  case StoreActionType.SET_VOLUME_Renderer:\r\n    return Object.assign({}, state, { volumeRenderer: action.volumeRenderer });\r\n  case StoreActionType.SET_SLIDER_Brightness:\r\n    return Object.assign({}, state, { sliderBrightness: action.sliderBrightness });\r\n  case StoreActionType.SET_SLIDER_Cut:\r\n    return Object.assign({}, state, { sliderCut: action.sliderCut });\r\n  case StoreActionType.SET_SLIDER_Quality:\r\n    return Object.assign({}, state, { sliderQuality: action.sliderQuality });\r\n  case StoreActionType.SET_2D_TOOLS_INDEX:\r\n    return Object.assign({}, state, { indexTools2d: action.indexTools2d });\r\n  case StoreActionType.SET_2D_ZOOM:\r\n    return Object.assign({}, state, { render2dZoom: action.render2dZoom });\r\n  case StoreActionType.SET_2D_X_POS:\r\n    return Object.assign({}, state, { render2dxPos: action.render2dxPos });\r\n  case StoreActionType.SET_2D_Y_POS:\r\n    return Object.assign({}, state, { render2dyPos: action.render2dyPos });\r\n  case StoreActionType.SET_GRAPHICS_2D:\r\n    return Object.assign({}, state, { graphics2d: action.graphics2d });\r\n  case StoreActionType.SET_UI_APP:\r\n    return Object.assign({}, state, { uiApp: action.uiApp });\r\n  case StoreActionType.SET_DICOM_INFO:\r\n    return Object.assign({}, state, { dicomInfo: action.dicomInfo });\r\n  case StoreActionType.SET_IS_TOOL3D:\r\n    return Object.assign({}, state, { isTool3D: action.isTool3D });\r\n  case StoreActionType.SET_SLIDER_Contrast3D:\r\n    return Object.assign({}, state, { sliderContrast3D: action.sliderContrast3D });\r\n  case StoreActionType.SET_ERR_ARRAY:\r\n    return Object.assign({}, state, { arrErrors: action.arrErrors });\r\n  case StoreActionType.SET_DICOM_SERIES:\r\n    return Object.assign({}, state, { dicomSeries: action.dicomSeries });\r\n  case StoreActionType.SET_LOADER_DICOM:\r\n    return Object.assign({}, state, { loaderDicom: action.loaderDicom });\r\n  default:\r\n    return state;\r\n  }\r\n}\r\n\r\nexport default medReducer;\r\n","/**\r\n * @fileOverview UiMainMpr\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiMainMpr some text later...\r\n */\r\nclass UiMainMpr extends React.Component {\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    const jsxRet = <p>MPR is not implemented yet</p>;\r\n    return jsxRet;\r\n  };\r\n}\r\n\r\nexport default connect(store => store)(UiMainMpr);\r\n","/**\r\n * @fileOverview UiCtrl2d\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\n// special css for NoUiSlioder\r\nimport 'nouislider/distribute/nouislider.css';\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { Card, ButtonGroup, Button } from 'react-bootstrap';\r\nimport { OverlayTrigger, Tooltip } from 'react-bootstrap';\r\n\r\nimport Nouislider from 'react-nouislider';\r\n\r\nimport Modes2d from '../store/Modes2d';\r\nimport StoreActionType from '../store/ActionTypes';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiCtrl2d some text later...\r\n */\r\nclass UiCtrl2d extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.onModeSaggital = this.onModeSaggital.bind(this);\r\n    this.onModeCoronal = this.onModeCoronal.bind(this);\r\n    this.onModeTransverse = this.onModeTransverse.bind(this);\r\n    this.onMode = this.onMode.bind(this);\r\n    this.m_updateEnable = true;\r\n  }\r\n\r\n  onMode(indexMode) {\r\n    const store = this.props;\r\n    const gra2d = store.graphics2d;\r\n\r\n    this.m_updateEnable = true;\r\n    store.dispatch({ type: StoreActionType.SET_MODE_2D, mode2d: indexMode });\r\n    gra2d.m_mode2d = indexMode;\r\n    gra2d.clear();\r\n\r\n    store.dispatch({ type: StoreActionType.SET_2D_ZOOM, render2dZoom: 1.0 });\r\n    store.dispatch({ type: StoreActionType.SET_2D_X_POS, render2dxPos: 0.0 });\r\n    store.dispatch({ type: StoreActionType.SET_2D_Y_POS, render2dyPos: 0.0 });\r\n\r\n    // build render image\r\n    gra2d.forceUpdate();\r\n    // render just builded image\r\n    gra2d.forceRender();\r\n  }\r\n\r\n  onModeSaggital() {\r\n    this.onMode(Modes2d.SAGGITAL);\r\n  }\r\n\r\n  onModeCoronal() {\r\n    this.onMode(Modes2d.CORONAL);\r\n  }\r\n\r\n  onModeTransverse() {\r\n    this.onMode(Modes2d.TRANSVERSE);\r\n  }\r\n\r\n  onChangeSliderSlice() {\r\n    if (this.refs === undefined) {\r\n      return;\r\n    }\r\n    this.m_updateEnable = false;\r\n    let val = 0.0;\r\n    const aval = this.refs.slider1.slider.get();\r\n    if (typeof (aval) === 'string') {\r\n      val = Number.parseFloat(aval);\r\n      // console.log(`onSlider. val = ${val}`);\r\n      // convert slider value from [0.. ?dim] to [0..1]\r\n      const store = this.props;\r\n      const mode2d = store.mode2d;\r\n      const volSet = store.volumeSet;\r\n      const volIndex = store.volumeIndex;\r\n      const vol = volSet.getVolume(volIndex);\r\n      let xDim = 0, yDim = 0, zDim = 0;\r\n      if (vol !== null) {\r\n        xDim = vol.m_xDim;\r\n        yDim = vol.m_yDim;\r\n        zDim = vol.m_zDim;\r\n      }\r\n  \r\n      let slideRangeMax = 0;\r\n      if (mode2d === Modes2d.SAGGITAL) {\r\n        slideRangeMax = xDim;\r\n      } else if (mode2d === Modes2d.CORONAL) {\r\n        slideRangeMax = yDim;\r\n      } else if (mode2d === Modes2d.TRANSVERSE) {\r\n        slideRangeMax = zDim;\r\n      }\r\n      const valNormalizedTo01 = val / slideRangeMax; \r\n      store.dispatch({ type: StoreActionType.SET_SLIDER_2D, slider2d: valNormalizedTo01 });\r\n      // clear all 2d tools\r\n      const gra2d = store.graphics2d;\r\n      gra2d.clear();\r\n\r\n      // re-render (and rebuild segm if present)\r\n      gra2d.forceUpdate();\r\n\r\n      // render just builded image\r\n      gra2d.forceRender();\r\n    }\r\n  }\r\n\r\n  shouldComponentUpdate() {\r\n    // return false;\r\n    // return true;\r\n    return this.m_updateEnable;\r\n  }\r\n\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    const store = this.props;\r\n    const valSlider = store.slider2d;\r\n    const mode2d = store.mode2d;\r\n\r\n    const strSlider1 = 'slider1';\r\n\r\n    const varSag = (mode2d === Modes2d.SAGGITAL) ? 'primary' : 'secondary';\r\n    const varCor = (mode2d === Modes2d.CORONAL) ? 'primary' : 'secondary';\r\n    const varTra = (mode2d === Modes2d.TRANSVERSE) ? 'primary' : 'secondary';\r\n\r\n    let xDim = 0, yDim = 0, zDim = 0;\r\n    const volSet = store.volumeSet;\r\n    if (volSet.getNumVolumes() > 0) {\r\n      const volIndex = store.volumeIndex;\r\n      const vol = volSet.getVolume(volIndex);\r\n      if (vol !== null) {\r\n        xDim = vol.m_xDim;\r\n        yDim = vol.m_yDim;\r\n        zDim = vol.m_zDim;\r\n      }\r\n    } // if more 0 volumes\r\n    // slider maximum value is depend on current x or y or z 2d mode selection\r\n    let slideRangeMax = 0;\r\n    if (mode2d === Modes2d.SAGGITAL) {\r\n      slideRangeMax = xDim - 1;\r\n    } else if (mode2d === Modes2d.CORONAL) {\r\n      slideRangeMax = yDim - 1;\r\n    } else if (mode2d === Modes2d.TRANSVERSE) {\r\n      slideRangeMax = zDim - 1;\r\n    }\r\n    const rangeDescr = {\r\n      'min': 0,\r\n      'max': slideRangeMax\r\n    };\r\n\r\n    const wArr = [Math.floor(valSlider * slideRangeMax)];\r\n    const valToolTps = true;\r\n    // special formatter interface for show only intefer numbers\r\n    // in slider: \r\n    // provide two conversion functions:\r\n    // to (int -> string)\r\n    // from (string -> int)\r\n    const formatterInt = {\r\n      to(valNum) {\r\n        const i = Math.floor(valNum);\r\n        return i.toString();\r\n      },\r\n      from(valStr) {\r\n        return parseInt(valStr);\r\n      }\r\n    };\r\n\r\n    const jsxSlider = (slideRangeMax > 0) ?\r\n      <ul className=\"list-group list-group-flush\">\r\n        <li className=\"list-group-item\">\r\n          <p> Select </p>\r\n          < Nouislider onSlide={this.onChangeSliderSlice.bind(this)} ref={strSlider1}\r\n            range={rangeDescr}\r\n            start={wArr} step={1}\r\n            format={formatterInt}\r\n            tooltips={valToolTps} />\r\n        </li>\r\n      </ul> : <p></p>;\r\n\r\n    const jsxSliceSelector = (slideRangeMax > 0) ?\r\n      <Card.Body>\r\n        <ButtonGroup className=\"mr-2\" aria-label=\"Ctrl2d group\">\r\n          <OverlayTrigger key=\"zx\" placement=\"bottom\" overlay={\r\n            <Tooltip>\r\n              Show slices along x axis\r\n            </Tooltip>\r\n          }>\r\n            <Button variant={varSag} onClick={this.onModeSaggital} >\r\n              Saggital\r\n            </Button>\r\n          </OverlayTrigger>\r\n\r\n          <OverlayTrigger key=\"zy\" placement=\"bottom\" overlay={\r\n            <Tooltip>\r\n              Show slices along y axis\r\n            </Tooltip>\r\n          }>\r\n            <Button variant={varCor} onClick={this.onModeCoronal} >\r\n              Coronal\r\n            </Button>\r\n          </OverlayTrigger>\r\n\r\n          <OverlayTrigger key=\"za\" placement=\"bottom\" overlay={\r\n            <Tooltip>\r\n              Show slices along z axis\r\n            </Tooltip>\r\n          }>\r\n            <Button variant={varTra} onClick={this.onModeTransverse} >\r\n              Transverse\r\n            </Button>\r\n          </OverlayTrigger>\r\n        </ButtonGroup>\r\n      </Card.Body> : <p></p>\r\n\r\n    const jsxRenderControls =\r\n      <Card>\r\n        <Card.Header>\r\n          Plane (slice) view\r\n        </Card.Header>\r\n        {jsxSliceSelector}\r\n        {jsxSlider}\r\n      </Card>\r\n    return jsxRenderControls;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiCtrl2d);\r\n","/**\r\n * @fileOverview ToolPick\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\nimport Modes2d from '../../store/Modes2d';\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass ToolPick {\r\n  constructor(objGra) {\r\n    this.m_objGraphics2d = objGra;\r\n    this.m_wScreen = 0;\r\n    this.m_hScreen = 0;\r\n    this.m_strMessage = '';\r\n    this.m_xMessage = 0;\r\n    this.m_yMessage = 0;\r\n    this.m_timeStart = 0;\r\n\r\n    this.onTimerEnd = this.onTimerEnd.bind(this);\r\n  }\r\n\r\n  setScreenDim(wScr, hScr) {\r\n    this.m_wScreen = wScr;\r\n    this.m_hScreen = hScr;\r\n  }\r\n\r\n  /**\r\n  * @param {number} xScr - relative x screen position. In [0..1]\r\n  * @param {number} yScr - relative y screen position. In [0..1]\r\n  * @param {object} store - global parameters store\r\n  * @return object with props x,y,z - texture coordinates\r\n  */\r\n  screenToTexture(xScr, yScr, store) {\r\n    const vTex = {\r\n      x: 0.0,\r\n      y: 0.0,\r\n      z: 0.0,\r\n    };\r\n    const mode2d = store.mode2d;\r\n    const sliderPosition = store.slider2d;\r\n\r\n    const volSet = store.volumeSet;\r\n    const volIndex = store.volumeIndex;\r\n    const vol = volSet.getVolume(volIndex);\r\n\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    const zoom = store.render2dZoom;\r\n    const xPos = store.render2dxPos;\r\n    const yPos = store.render2dyPos;\r\n    if (mode2d === Modes2d.TRANSVERSE) {\r\n      // z: const\r\n      vTex.x = Math.floor((xPos + xScr * zoom) * xDim);\r\n      vTex.y = Math.floor((yPos + yScr * zoom) * yDim);\r\n      vTex.z = Math.floor(sliderPosition * zDim);\r\n    }\r\n    if (mode2d === Modes2d.SAGGITAL) {\r\n      // x: const\r\n      vTex.x = Math.floor(sliderPosition * xDim);\r\n      vTex.y = Math.floor((xPos + xScr * zoom) * yDim);\r\n      vTex.z = Math.floor((yPos + yScr * zoom) * zDim);\r\n    }\r\n    if (mode2d === Modes2d.CORONAL) {\r\n      // y: const\r\n      vTex.x = Math.floor((xPos + xScr * zoom) * xDim);\r\n      vTex.y = Math.floor(sliderPosition * yDim);\r\n      vTex.z = Math.floor((yPos + yScr * zoom) * zDim);\r\n    }\r\n    return vTex;\r\n  }\r\n\r\n  onMouseDown(xScr, yScr, store) {\r\n    if ((this.m_wScreen === 0) || (this.m_hScreen === 0)) {\r\n      console.log('ToolPick. onMouseDown. Bad screen size');\r\n      return;\r\n    }\r\n\r\n    const xRatioImage = xScr / this.m_wScreen;\r\n    const yRatioImage = yScr / this.m_hScreen;\r\n    if ((xRatioImage > 1.0) || (yRatioImage > 1.0)) {\r\n      // out if rendered image\r\n      return;\r\n    }\r\n    const vTex = this.screenToTexture(xRatioImage, yRatioImage, store);\r\n\r\n    const volSet = store.volumeSet;\r\n    const vol = volSet.getVolume(store.volumeIndex);\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    /*\r\n    if (mode2d === Modes2d.SAGGITAL) {\r\n      // x\r\n      xVol = Math.floor(sliderPosition * (this.m_volume.m_xDim - 1));\r\n      yVol = Math.floor(xRatioImage * (this.m_volume.m_yDim - 1));\r\n      zVol = Math.floor(yRatioImage * (this.m_volume.m_zDim - 1));\r\n    } else if (mode2d === Modes2d.CORONAL) {\r\n      // y\r\n      xVol = Math.floor(xRatioImage * (this.m_volume.m_xDim - 1));\r\n      yVol = Math.floor(sliderPosition * (this.m_volume.m_yDim - 1));\r\n      zVol = Math.floor(yRatioImage * (this.m_volume.m_zDim - 1));\r\n    } else if (mode2d === Modes2d.TRANSVERSE) {\r\n      // z\r\n      xVol = Math.floor(xRatioImage * (this.m_volume.m_xDim - 1));\r\n      yVol = Math.floor(yRatioImage * (this.m_volume.m_yDim - 1));\r\n      zVol = Math.floor(sliderPosition * (this.m_volume.m_zDim - 1));\r\n    }\r\n    const off = xVol + (yVol * this.m_volume.m_xDim) + (zVol * this.m_volume.m_xDim * this.m_volume.m_yDim);\r\n    */\r\n\r\n    const ONE = 1;\r\n    const FOUR = 4;\r\n    const bpp = vol.m_bytesPerVoxel;\r\n    let off = vTex.x + (vTex.y * xDim) + (vTex.z * xDim * yDim);\r\n    let val = 0;\r\n    if (bpp === ONE) {\r\n      val = vol.m_dataArray[off];\r\n    } else if (bpp === FOUR) {\r\n      off = off * FOUR;\r\n      val = vol.m_dataArray[off];\r\n    }\r\n    \r\n    this.m_xMessage = xScr;\r\n    this.m_yMessage = yScr;\r\n    this.m_strMessage = 'x,y,z = ' + (vTex.x).toString() + ', ' + (vTex.y).toString() + ', ' + (vTex.z).toString() + \r\n      '. val = ' + val.toString();\r\n    // console.log(`ToolPick. onMouseDown. ${this.m_strMessage}`);\r\n    this.m_timeStart = Date.now();\r\n    setTimeout(this.onTimerEnd, 1500);\r\n\r\n  } // end onMouseDown\r\n\r\n  onTimerEnd() {\r\n    this.m_objGraphics2d.forceUpdate();\r\n  }\r\n\r\n  render(ctx) {\r\n    if (this.m_timeStart === 0) {\r\n      return;\r\n    }\r\n    const TIME_SHOW_MS = 1200;\r\n    const timeCur = Date.now();\r\n    const timeDelta = timeCur - this.m_timeStart;\r\n    // console.log(`ToolPick. dt = ${timeDelta}`);\r\n    if (timeDelta < TIME_SHOW_MS) {\r\n      // render message\r\n      // console.log('ToolPick. Render message on ctx');\r\n      ctx.fillStyle = 'white';\r\n      const FONT_SZ = 16;\r\n      ctx.font = FONT_SZ.toString() + 'px Arial';\r\n      const sizeTextRect = ctx.measureText(this.m_strMessage);\r\n      // console.log(`ToolPick. draw text. x = ${this.m_xMessage}, szRect = ${sizeTextRect.width}, wScr = ${this.m_wScreen}`);\r\n      if (this.m_xMessage + sizeTextRect.width < this.m_wScreen) {\r\n        ctx.textAlign = 'left';\r\n      } else {\r\n        ctx.textAlign = 'right';\r\n      }\r\n      if (this.m_yMessage + FONT_SZ < this.m_hScreen) {\r\n        ctx.textBaseline = 'top';\r\n      } else {\r\n        ctx.textBaseline = 'bottom';\r\n      }\r\n\r\n      ctx.fillText(this.m_strMessage, this.m_xMessage, this.m_yMessage);\r\n    }\r\n  }\r\n}\r\nexport default ToolPick;\r\n","/**\r\n * @fileOverview ToolZoom\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\n\r\n// import React from 'react';\r\n// import { connect } from 'react-redux';\r\n\r\nimport StoreActionType from '../../store/ActionTypes';\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass ToolZoom {\r\n  constructor(objGra) {\r\n    this.m_objGraphics2d = objGra;\r\n    this.m_wScreen = 0;\r\n    this.m_hScreen = 0;\r\n\r\n    this.setScreenDim = this.setScreenDim.bind(this);\r\n    this.onMouseWheel = this.onMouseWheel.bind(this);\r\n    this.onMouseDown = this.onMouseDown.bind(this);\r\n    this.onMouseUp = this.onMouseUp.bind(this);\r\n    this.onMouseMove = this.onMouseMove.bind(this);\r\n\r\n    this.state = {\r\n      mouseDown: false,\r\n      xMouse: 0,\r\n      yMouse: 0,\r\n    };\r\n  }\r\n\r\n  setScreenDim(wScr, hScr) {\r\n    this.m_wScreen = wScr;\r\n    this.m_hScreen = hScr;\r\n  }\r\n\r\n  onMouseDown(xScr, yScr) {\r\n    this.state.mouseDown = true;\r\n    this.state.xMouse = xScr;\r\n    this.state.yMouse = yScr;\r\n  }\r\n\r\n  onMouseUp() {\r\n    this.state.mouseDown = false;\r\n  }\r\n\r\n  onMouseMove(store, xScr, yScr) {\r\n    if (this.state.mouseDown) {\r\n      const dx = xScr - this.state.xMouse;\r\n      const dy = yScr - this.state.yMouse;\r\n\r\n      this.state.xMouse = xScr;\r\n      this.state.yMouse = yScr;\r\n\r\n\r\n      const zoom = store.render2dZoom;\r\n      const dxMove = (dx / this.m_wScreen) * zoom;\r\n      const dyMove = (dy / this.m_hScreen) * zoom;\r\n      // console.log(`dxyMove = ${dxMove}, ${dyMove}`);\r\n      const xPos = store.render2dxPos - dxMove;\r\n      const yPos = store.render2dyPos - dyMove;\r\n\r\n      // check new 2d transform is valid (not clipped)\r\n      if ((xPos >= 0.0) && (xPos + zoom <= 1.0) && \r\n        (yPos >= 0.0) && (yPos + zoom <= 1.0)) {\r\n        store.dispatch({ type: StoreActionType.SET_2D_X_POS, render2dxPos: xPos });\r\n        store.dispatch({ type: StoreActionType.SET_2D_Y_POS, render2dyPos: yPos });\r\n        const gra = store.graphics2d;\r\n        gra.forceUpdate();\r\n      }\r\n    }\r\n  }\r\n\r\n  onMouseWheel(store, evt) {\r\n    const delta = Math.max(-1, Math.min(1, (evt.deltaY || -evt.detail)));\r\n    const MULT_STEP = 0.04;\r\n    const step = -delta * MULT_STEP;\r\n    // console.log(`onMouseWheel. step = ${step}`);\r\n\r\n    const zoom = store.render2dZoom;\r\n    let zoomNew = zoom + step;\r\n    if (zoomNew > 1.0) {\r\n      zoomNew -= step;\r\n    }\r\n    if (zoomNew <= 0.0) {\r\n      zoomNew += step;\r\n    }\r\n    if (zoomNew !== zoom) {\r\n      const xPos = store.render2dxPos;\r\n      const yPos = store.render2dyPos;\r\n      const xPosNew = xPos - step * 0.5;\r\n      const yPosNew = yPos - step * 0.5;\r\n      // console.log(`onMouseWheel. zoomNew = ${zoomNew}, xyPos = ${xPosNew},${yPosNew}`);\r\n      store.dispatch({ type: StoreActionType.SET_2D_ZOOM, render2dZoom: zoomNew });\r\n      store.dispatch({ type: StoreActionType.SET_2D_X_POS, render2dxPos: xPosNew });\r\n      store.dispatch({ type: StoreActionType.SET_2D_Y_POS, render2dyPos: yPosNew });\r\n\r\n      const gra = store.graphics2d;\r\n      gra.forceUpdate();\r\n    }\r\n  } // end on mouse wheel\r\n\r\n}\r\n// export default connect(store => store)(ToolZoom);\r\nexport default ToolZoom;\r\n","/**\r\n * @fileOverview ToolDistance\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\n\r\nimport Modes2d from '../../store/Modes2d';\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass ToolDistance {\r\n  constructor(objGra) {\r\n    this.m_objGraphics2d = objGra;\r\n    this.m_wScreen = 0;\r\n    this.m_hScreen = 0;\r\n  \r\n    this.m_pointStart = null;\r\n    this.m_lines = [];\r\n    this.m_mouseDown = false;\r\n\r\n    this.m_objEdit = null;\r\n\r\n    this.m_xPixelSize = 0;\r\n    this.m_yPixelSize = 0;\r\n  }\r\n\r\n  setScreenDim(wScr, hScr) {\r\n    this.m_wScreen = wScr;\r\n    this.m_hScreen = hScr;\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @param {number} xs - world units hor / volume pixels (x)\r\n   * @param {number} ys - world units ver / volume pixels (y) \r\n   */\r\n  setPixelSize(xs, ys) {\r\n    this.m_xPixelSize = xs;\r\n    this.m_yPixelSize = ys;\r\n  }\r\n\r\n  /**\r\n   * Determine intersection with points in lines set.\r\n   * Input - screen coordinates of pick point\r\n   * Output - volume coordinate\r\n   *  \r\n   * @param {object} vScr - screen coordinates of poick\r\n   * @param {object} store - global store\r\n   */\r\n  getEditPoint(vScr, store) {\r\n    const numLines = this.m_lines.length;\r\n    for (let i = 0; i < numLines; i++) {\r\n      const objLine = this.m_lines[i];\r\n      const vScrS = ToolDistance.textureToScreen(objLine.vs.x, objLine.vs.y, this.m_wScreen, this.m_hScreen, store);\r\n      const vScrE = ToolDistance.textureToScreen(objLine.ve.x, objLine.ve.y, this.m_wScreen, this.m_hScreen, store);\r\n      const MIN_DIST = 4.0;\r\n      if (this.getDistMm(vScr, vScrS) <= MIN_DIST) {\r\n        this.m_objEdit = objLine;\r\n        return objLine.vs;\r\n      }\r\n      if (this.getDistMm(vScr, vScrE) <= MIN_DIST) {\r\n        this.m_objEdit = objLine;\r\n        return objLine.ve;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Move edited point into new pos\r\n   * \r\n   * @param {object} vVolOld \r\n   * @param {object} vVolNew \r\n   */\r\n  moveEditPoint(vVolOld, vVolNew) {\r\n    vVolOld.x = vVolNew.x;\r\n    vVolOld.y = vVolNew.y;\r\n    // update line len\r\n    this.m_objEdit.distMm = this.getDistMm(this.m_objEdit.vs, this.m_objEdit.ve);\r\n  }\r\n\r\n  /**\r\n   * Remove highlighted object\r\n   */\r\n  deleteObject() {\r\n    if (this.m_objEdit != null) {\r\n      const ind = this.m_lines.indexOf(this.m_objEdit);\r\n      if (ind >= 0) {\r\n        this.m_lines.splice(ind, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  static screenToTexture(xScr, yScr, wScr, hScr, store) {\r\n    const xRel = xScr / wScr;\r\n    const yRel = yScr / hScr;\r\n\r\n    const mode2d = store.mode2d;\r\n\r\n    const volSet = store.volumeSet;\r\n    const volIndex = store.volumeIndex;\r\n    const vol = volSet.getVolume(volIndex);\r\n\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    const zoom = store.render2dZoom;\r\n    const xPos = store.render2dxPos;\r\n    const yPos = store.render2dyPos;\r\n\r\n    const vTex = {\r\n      x: 0.0,\r\n      y: 0.0,\r\n    };\r\n    if (mode2d === Modes2d.TRANSVERSE) {\r\n      // z const\r\n      vTex.x = Math.floor((xPos + xRel * zoom) * xDim);\r\n      vTex.y = Math.floor((yPos + yRel * zoom) * yDim);\r\n    }\r\n    if (mode2d === Modes2d.SAGGITAL) {\r\n      // x const\r\n      vTex.x = Math.floor((xPos + xRel * zoom) * yDim);\r\n      vTex.y = Math.floor((yPos + yRel * zoom) * zDim);\r\n    }\r\n    if (mode2d === Modes2d.CORONAL) {\r\n      // y const\r\n      vTex.x = Math.floor((xPos + xRel * zoom) * xDim);\r\n      vTex.y = Math.floor((yPos + yRel * zoom) * zDim);\r\n    }\r\n    return vTex;\r\n  }\r\n\r\n  static textureToScreen(xTex, yTex, wScr, hScr, store) {\r\n    const vScr = {\r\n      x: 0.0,\r\n      y: 0.0,\r\n    };\r\n    const mode2d = store.mode2d;\r\n    const volSet = store.volumeSet; \r\n    const vol = volSet.getVolume(store.volumeIndex);\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    const zoom = store.render2dZoom;\r\n    const xPos = store.render2dxPos;\r\n    const yPos = store.render2dyPos;\r\n    if (mode2d === Modes2d.TRANSVERSE) {\r\n      // z const\r\n      vScr.x = ((xTex / xDim) - xPos) / zoom;\r\n      vScr.y = ((yTex / yDim) - yPos) / zoom;\r\n    }\r\n    if (mode2d === Modes2d.SAGGITAL) {\r\n      // x const\r\n      vScr.x = ((xTex / yDim) - xPos) / zoom;\r\n      vScr.y = ((yTex / zDim) - yPos) / zoom;\r\n    }\r\n    if (mode2d === Modes2d.CORONAL) {\r\n      // y const\r\n      vScr.x = ((xTex / xDim) - xPos) / zoom;\r\n      vScr.y = ((yTex / zDim) - yPos) / zoom;\r\n    }\r\n    vScr.x *= wScr;\r\n    vScr.y *= hScr;\r\n    return vScr;\r\n  }\r\n\r\n  getDistMm(vs, ve) {\r\n    const dx = vs.x - ve.x;\r\n    const dy = vs.y - ve.y;\r\n    const dist = Math.sqrt(dx * dx * this.m_xPixelSize * this.m_xPixelSize +\r\n      dy * dy * this.m_yPixelSize * this.m_yPixelSize);\r\n    return dist;\r\n  }\r\n\r\n  onMouseDown(xScr, yScr, store) {\r\n    const vTex = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n    const vStart = {\r\n      x: vTex.x,\r\n      y: vTex.y,\r\n    };\r\n    const vEnd = {\r\n      x: vTex.x,\r\n      y: vTex.y\r\n    };\r\n    const objLine = {\r\n      vs: vStart,\r\n      ve: vEnd,\r\n      distMm: 0.0,\r\n    };\r\n    this.m_lines.push(objLine);\r\n    this.m_mouseDown = true;\r\n    // this.m_pointStart = v;\r\n    // console.log(`onMouseDown: ${xScr}, ${yScr}`);\r\n  }\r\n\r\n  onMouseMove(xScr, yScr, store) {\r\n    if (!this.m_mouseDown) {\r\n      return;\r\n    }\r\n    const vTex = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n    // get last line and change end\r\n    const vEnd = {\r\n      x: vTex.x,\r\n      y: vTex.y,\r\n    };\r\n    const numLines = this.m_lines.length;\r\n    if (numLines > 0) {\r\n      const objLastLine = this.m_lines[numLines - 1];\r\n      objLastLine.ve = vEnd;\r\n      objLastLine.distMm = this.getDistMm(objLastLine.vs, objLastLine.ve);\r\n      const MIN_DIST_MM = 0.00001;\r\n      if (objLastLine.distMm > MIN_DIST_MM) {\r\n        // invoke render event\r\n        this.m_objGraphics2d.forceUpdate();\r\n      } // if last line is long enough\r\n    } // if num lines more 0\r\n  }\r\n\r\n  onMouseUp() { // omitted args: xScr, yScr, store\r\n    this.m_mouseDown = false;\r\n    const numLines = this.m_lines.length;\r\n    if (numLines > 0) {\r\n      const objLastLine = this.m_lines[numLines - 1];\r\n      objLastLine.distMm = this.getDistMm(objLastLine.vs, objLastLine.ve);\r\n      const MIN_DIST_MM = 0.00001;\r\n      if (objLastLine.distMm <= MIN_DIST_MM) {\r\n        // remove last line\r\n        this.m_lines.pop();\r\n        console.log('ToolDistance: pop last line');\r\n      } // if last line is long enough\r\n    } // if num lines more 0\r\n\r\n  }\r\n\r\n  clear() {\r\n    this.m_lines = [];\r\n  }\r\n\r\n  //\r\n  // render lines on screen\r\n  // \r\n  render(ctx, store) {\r\n    const numLines = this.m_lines.length;\r\n    ctx.lineWidth = 2;\r\n    ctx.strokeStyle = 'yellow';\r\n    ctx.fillStyle = 'white';\r\n    const FONT_SZ = 16;\r\n    ctx.font = FONT_SZ.toString() + 'px Arial';\r\n    ctx.textAlign = 'center';\r\n    ctx.textBaseline = 'center';\r\n    for (let i = 0; i < numLines; i++) {\r\n      const objLine = this.m_lines[i];\r\n      const distMm = objLine.distMm;\r\n      const vsTex = objLine.vs;\r\n      const veTex = objLine.ve;\r\n      const vs = ToolDistance.textureToScreen(vsTex.x, vsTex.y, this.m_wScreen, this.m_hScreen, store);\r\n      const ve = ToolDistance.textureToScreen(veTex.x, veTex.y, this.m_wScreen, this.m_hScreen, store);\r\n      ctx.beginPath();\r\n      ctx.moveTo(vs.x, vs.y);\r\n      ctx.lineTo(ve.x, ve.y);\r\n      ctx.stroke();\r\n      // draw text\r\n      const xText = Math.floor((vs.x + ve.x) * 0.5);\r\n      const yText = Math.floor((vs.y + ve.y) * 0.5);\r\n      const strMsg = distMm.toFixed(3) + ' mm';\r\n      ctx.fillText(strMsg, xText, yText);\r\n    }\r\n  }\r\n\r\n} // end class\r\n\r\nexport default ToolDistance;\r\n","/**\r\n * @fileOverview ToolClear\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass ToolClear {\r\n  constructor(objGra) {\r\n    this.m_objGraphics2d = objGra;\r\n  }\r\n\r\n  clear() {\r\n    this.m_objGraphics2d.clear();\r\n  }\r\n}\r\nexport default ToolClear;\r\n","/**\r\n * @fileOverview ToolAngle\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\n\r\n// import Modes2d from '../../store/Modes2d';\r\nimport ToolDistance from './ToolDistance';\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass ToolAngle {\r\n  constructor(objGra) {\r\n    this.m_objGraphics2d = objGra;\r\n    this.m_wScreen = 0;\r\n    this.m_hScreen = 0;\r\n\r\n    const v0 = {\r\n      x: 0.0, y: 0.0\r\n    };\r\n    const v1 = {\r\n      x: 0.0, y: 0.0\r\n    };\r\n    const v2 = {\r\n      x: 0.0, y: 0.0\r\n    };\r\n    this.m_points = [ v0, v1, v2 ];\r\n    this.m_numClicks = 0;\r\n    this.m_angles = [];\r\n\r\n    this.m_objEdit = null;\r\n\r\n    this.m_xPixelSize = 0;\r\n    this.m_yPixelSize = 0;\r\n\r\n    this.onMouseDown = this.onMouseDown.bind(this);\r\n    this.onMouseUp = this.onMouseUp.bind(this);\r\n    this.onMouseMove = this.onMouseMove.bind(this);\r\n    this.render = this.render.bind(this);\r\n  }\r\n\r\n  setScreenDim(wScr, hScr) {\r\n    this.m_wScreen = wScr;\r\n    this.m_hScreen = hScr;\r\n  }\r\n\r\n  setPixelSize(xs, ys) {\r\n    this.m_xPixelSize = xs;\r\n    this.m_yPixelSize = ys;\r\n  }\r\n\r\n  /**\r\n   * Determine intersection with points in lines set.\r\n   * Input - screen coordinates of pick point\r\n   * Output - volume coordinate\r\n   *  \r\n   * @param {object} vScr - screen coordinates of poick\r\n   * @param {object} store - global store \r\n   */\r\n  getEditPoint(vScr, store) {\r\n    const numObj = this.m_angles.length;\r\n    for (let i = 0; i < numObj; i++) {\r\n      const objAngle = this.m_angles[i];\r\n      const vScr0 = ToolDistance.textureToScreen(objAngle.points[0].x, objAngle.points[0].y, this.m_wScreen, this.m_hScreen, store);\r\n      const vScr1 = ToolDistance.textureToScreen(objAngle.points[1].x, objAngle.points[1].y, this.m_wScreen, this.m_hScreen, store);\r\n      const vScr2 = ToolDistance.textureToScreen(objAngle.points[2].x, objAngle.points[2].y, this.m_wScreen, this.m_hScreen, store);\r\n      const MIN_DIST = 4.0;\r\n      if (this.getDistMm(vScr, vScr0) <= MIN_DIST) {\r\n        this.m_objEdit = objAngle;\r\n        return objAngle.points[0];\r\n      }\r\n      if (this.getDistMm(vScr, vScr1) <= MIN_DIST) {\r\n        this.m_objEdit = objAngle;\r\n        return objAngle.points[1];\r\n      }\r\n      if (this.getDistMm(vScr, vScr2) <= MIN_DIST) {\r\n        this.m_objEdit = objAngle;\r\n        return objAngle.points[2];\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  moveEditPoint(vVolOld, vVolNew) {\r\n    vVolOld.x = vVolNew.x;\r\n    vVolOld.y = vVolNew.y;\r\n    // update angle dist\r\n    this.getAngleForObj(this.m_objEdit);\r\n  }\r\n    \r\n  /**\r\n   * Remove highlighted object\r\n   */\r\n  deleteObject() {\r\n    if (this.m_objEdit != null) {\r\n      const ind = this.m_angles.indexOf(this.m_objEdit);\r\n      if (ind >= 0) {\r\n        this.m_angles.splice(ind, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  getDistMm(vs, ve) {\r\n    const dx = vs.x - ve.x;\r\n    const dy = vs.y - ve.y;\r\n    const dist = Math.sqrt(dx * dx * this.m_xPixelSize * this.m_xPixelSize +\r\n      dy * dy * this.m_yPixelSize * this.m_yPixelSize);\r\n    return dist;\r\n  }\r\n\r\n  getAngleForObj(objAngle) {\r\n    for (let i = 0; i < 3; i++) {\r\n      this.m_points[i].x = objAngle.points[i].x;\r\n      this.m_points[i].y = objAngle.points[i].y;\r\n    }\r\n    const ang = this.getAngle();\r\n    objAngle.angle = ang;\r\n  }\r\n\r\n  getAngle() {\r\n    const v1x = this.m_points[1].x - this.m_points[0].x;\r\n    const v1y = this.m_points[1].y - this.m_points[0].y;\r\n    const v2x = this.m_points[2].x - this.m_points[0].x;\r\n    const v2y = this.m_points[2].y - this.m_points[0].y;\r\n    const dotProd = v1x * v2x + v1y * v2y;\r\n    const v1len = Math.sqrt(v1x * v1x + v1y * v1y);\r\n    const v2len = Math.sqrt(v2x * v2x + v2y * v2y);\r\n    const cosAlp = dotProd / (v1len * v2len);\r\n    const M_180 = 180.0;\r\n    const M_PI = 3.1415926535;\r\n    if (cosAlp > 1.0) {\r\n      // console.log('get Angle > 1');\r\n      return 0.0;\r\n    }\r\n    if (cosAlp < -1.0) {\r\n      // console.log('get Angle < -1');\r\n      return 180.0;\r\n    }\r\n    const ang = Math.acos(cosAlp) * M_180 / M_PI;\r\n    return ang;\r\n  }\r\n\r\n  onMouseDown(xScr, yScr, store) {\r\n    const vTex = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n    if (this.m_numClicks === 0) {\r\n      // assign all 3 points at the same place\r\n      for (let i = 0; i < 3; i++) {\r\n        this.m_points[i].x = vTex.x;\r\n        this.m_points[i].y = vTex.y;\r\n      }\r\n\r\n      this.m_numClicks++;\r\n      // console.log('1st click: add 3 points');\r\n    } else if (this.m_numClicks === 1) {\r\n      this.m_numClicks++;\r\n      // console.log(`2st click: points are: ${this.m_points[0].x}, ${this.m_points[0].y} -> ${this.m_points[1].x}, ${this.m_points[1].y}`);\r\n    } else {\r\n      console.log('3rd click: finalize angle');\r\n      // this.m_numClicks === 2\r\n      const v0 = {\r\n        x: this.m_points[0].x,\r\n        y: this.m_points[0].y,\r\n      };\r\n      const v1 = {\r\n        x: this.m_points[1].x,\r\n        y: this.m_points[1].y,\r\n      };\r\n      const v2 = {\r\n        x: this.m_points[2].x,\r\n        y: this.m_points[2].y,\r\n      };\r\n      const ang = this.getAngle();\r\n\r\n      const objAngle = {\r\n        points: [ v0, v1, v2 ],\r\n        angle: ang,\r\n      };\r\n      this.m_angles.push(objAngle);\r\n      this.m_numClicks = 0;\r\n    }\r\n  }\r\n\r\n  onMouseMove(xScr, yScr, store) {\r\n    if (this.m_numClicks === 0) {\r\n      return;\r\n    }\r\n    // modify point in points array\r\n    const vTex = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n    const NUM_3 = 3;\r\n    for (let idx = this.m_numClicks; idx < NUM_3; idx++) {\r\n      this.m_points[idx].x = vTex.x;\r\n      this.m_points[idx].y = vTex.y;\r\n      // console.log(`onMouseMove. modify point[${idx}]: now = ${vTex.x}, ${vTex.y}`);\r\n    }\r\n    // invoke redraw\r\n    this.m_objGraphics2d.forceUpdate();\r\n  }\r\n\r\n  onMouseUp() { // ommited args: xScr, yScr, store\r\n  }\r\n\r\n  clear() {\r\n    this.m_angles = [];\r\n    this.m_numClicks = 0;\r\n  }\r\n\r\n  //\r\n  // render lines on screen\r\n  // \r\n  render(ctx, store) {\r\n    const NUM_3 = 3;\r\n\r\n    ctx.lineWidth = 2;\r\n    ctx.strokeStyle = 'yellow';\r\n    ctx.fillStyle = 'white';\r\n    const FONT_SZ = 16;\r\n    ctx.font = FONT_SZ.toString() + 'px Arial';\r\n    ctx.textAlign = 'center';\r\n    ctx.textBaseline = 'top';\r\n\r\n    if (this.m_numClicks > 0) {\r\n      for(let i = 1; i < NUM_3; i++) {\r\n        const vTex0 = this.m_points[0];\r\n        const vTex1 = this.m_points[i];\r\n        const vs = ToolDistance.textureToScreen(vTex0.x, vTex0.y, this.m_wScreen, this.m_hScreen, store);\r\n        const ve = ToolDistance.textureToScreen(vTex1.x, vTex1.y, this.m_wScreen, this.m_hScreen, store);\r\n        const dx = vs.x - ve.x;\r\n        const dy = vs.y - ve.y;\r\n        const MIN_DIST2 = 2 * 2;\r\n        if ((dx * dx) + (dy * dy) >= MIN_DIST2) {\r\n          ctx.beginPath();\r\n          ctx.moveTo(vs.x, vs.y);\r\n          ctx.lineTo(ve.x, ve.y);\r\n          ctx.stroke();\r\n        } // if line is not degradate to point\r\n      } // for all 3 vertices\r\n      // draw angle\r\n      let ang = 0.0;\r\n      if (this.m_numClicks >= 2) {\r\n        ang = this.getAngle();\r\n      }\r\n      const strMsg = ang.toFixed(3) + '°';\r\n      const vTex0 = this.m_points[0];\r\n      const vs0 = ToolDistance.textureToScreen(vTex0.x, vTex0.y, this.m_wScreen, this.m_hScreen, store);\r\n      const SHIFT_UP = 8;\r\n      const xText = vs0.x;\r\n      const yText = vs0.y + SHIFT_UP;\r\n      ctx.fillText(strMsg, xText, yText);\r\n\r\n    } // if we have angle under build\r\n\r\n    // draw ready angles\r\n    const numAngles = this.m_angles.length;\r\n    for (let a = 0; a < numAngles; a++) {\r\n      const objAngle = this.m_angles[a];\r\n      for (let i = 1; i < NUM_3; i++) {\r\n        const vTex0 = objAngle.points[0];\r\n        const vTex1 = objAngle.points[i];\r\n        const vs = ToolDistance.textureToScreen(vTex0.x, vTex0.y, this.m_wScreen, this.m_hScreen, store);\r\n        const ve = ToolDistance.textureToScreen(vTex1.x, vTex1.y, this.m_wScreen, this.m_hScreen, store);\r\n        ctx.beginPath();\r\n        ctx.moveTo(vs.x, vs.y);\r\n        ctx.lineTo(ve.x, ve.y);\r\n        ctx.stroke();\r\n      } // for points in angle\r\n      // draw angle\r\n      const strMsg = objAngle.angle.toFixed(3) + '°';\r\n      const vTex0 = objAngle.points[0];\r\n      const vs0 = ToolDistance.textureToScreen(vTex0.x, vTex0.y, this.m_wScreen, this.m_hScreen, store);\r\n      const SHIFT_UP = 8;\r\n      const xText = vs0.x;\r\n      const yText = vs0.y + SHIFT_UP;\r\n      ctx.fillText(strMsg, xText, yText);\r\n\r\n    } // for all angles\r\n  } // end render\r\n\r\n\r\n} // end class\r\nexport default ToolAngle;\r\n\r\n","/**\r\n * @fileOverview ToolArea\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\n\r\nimport Modes2d from '../../store/Modes2d';\r\nimport ToolDistance from './ToolDistance';\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass ToolArea {\r\n  constructor(objGra) {\r\n    this.m_objGraphics2d = objGra;\r\n    this.m_wScreen = 0;\r\n    this.m_hScreen = 0;\r\n\r\n    this.m_areas = [];\r\n    this.m_inCreateMode = false;\r\n    this.m_objSelfIntersect = null;\r\n\r\n    this.m_xPixelSize = 0;\r\n    this.m_yPixelSize = 0;\r\n\r\n    this.m_objEdit = null;\r\n    this.store = null;\r\n\r\n    this.onMouseDown = this.onMouseDown.bind(this);\r\n    this.onMouseUp = this.onMouseUp.bind(this);\r\n    this.onMouseMove = this.onMouseMove.bind(this);\r\n    this.render = this.render.bind(this);\r\n  }\r\n\r\n  setScreenDim(wScr, hScr) {\r\n    this.m_wScreen = wScr;\r\n    this.m_hScreen = hScr;\r\n  }\r\n\r\n  setPixelSize(xs, ys) {\r\n    this.m_xPixelSize = xs;\r\n    this.m_yPixelSize = ys;\r\n  }\r\n\r\n  clear() {\r\n    this.m_areas = [];\r\n    this.m_inCreateMode = false;\r\n    this.m_objSelfIntersect = null;\r\n  }\r\n\r\n  /**\r\n   * Determine intersection with points in areas set.\r\n   * Input - screen coordinates of pick point\r\n   * Output - volume coordinate\r\n   *  \r\n   * @param {object} vScr - screen coordinates of poick\r\n   * @param {object} store - global store\r\n   */\r\n  getEditPoint(vScr, store) {\r\n    this.store = store;\r\n    const numAreas = this.m_areas.length;\r\n    for(let i = 0 ; i < numAreas; i++) {\r\n      const objArea = this.m_areas[i];\r\n      for (let j = 0; j < objArea.m_points.length; j++) {\r\n        const vScrProj = ToolDistance.textureToScreen(objArea.m_points[j].x, objArea.m_points[j].y, this.m_wScreen, this.m_hScreen, store);\r\n        const MIN_DIST = 4.0;\r\n        if (this.getDistMm(vScr, vScrProj) <= MIN_DIST) {\r\n          this.m_objEdit = objArea;\r\n          return objArea.m_points[j];\r\n        } // if too close pick\r\n      } // for (j) all point in area\r\n    } // for (i) all areas\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Move edited point into new pos\r\n   * \r\n   * @param {object} vVolOld \r\n   * @param {object} vVolNew \r\n   */\r\n  moveEditPoint(vVolOld, vVolNew) {\r\n    const x = vVolOld.x;\r\n    const y = vVolOld.y;\r\n    vVolOld.x = vVolNew.x;\r\n    vVolOld.y = vVolNew.y;\r\n    //const vObjSelfInters = ToolArea.getSelfIntersectPoint(this.m_objEdit.m_points);\r\n    //if (vObjSelfInters !== null) {\r\n    const hasInters = ToolArea.hasSelfIntersection(this.m_objEdit.m_points);\r\n    if (hasInters) {\r\n      // console.log('ToolArea. self inters found');\r\n      vVolOld.x = x;\r\n      vVolOld.y = y;\r\n    }\r\n    // update line len\r\n    const store = this.store;\r\n    this.m_objEdit.m_area = this.getPolyArea(this.m_objEdit.m_points, store);\r\n  }\r\n\r\n  /**\r\n   * Remove highlighted object\r\n   */\r\n  deleteObject() {\r\n    if (this.m_objEdit != null) {\r\n      const ind = this.m_areas.indexOf(this.m_objEdit);\r\n      if (ind >= 0) {\r\n        this.m_areas.splice(ind, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  getDistMm(vs, ve) {\r\n    const dx = vs.x - ve.x;\r\n    const dy = vs.y - ve.y;\r\n    const dist = Math.sqrt(dx * dx * this.m_xPixelSize * this.m_xPixelSize +\r\n      dy * dy * this.m_yPixelSize * this.m_yPixelSize);\r\n    return dist;\r\n  }\r\n\r\n  /**\r\n   * Get lines intersection in 2d\r\n   * \r\n   * @param {object} v0 \r\n   * @param {object} v1 \r\n   * @param {object} v2 \r\n   * @param {object} v3 \r\n   * @return {object} point (object with x,y) of intersection or null\r\n   */\r\n  static getLineIntersection(v0, v1, v2, v3) {\r\n    const v23 = {\r\n      x: v3.x - v2.x,\r\n      y: v3.y - v2.y,\r\n    };\r\n    const n23 = {\r\n      x: -v23.y,\r\n      y: v23.x,\r\n    };\r\n    const v01 = {\r\n      x: v1.x - v0.x,\r\n      y: v1.y - v0.y,\r\n    };\r\n    const v02 = {\r\n      x: v2.x - v0.x,\r\n      y: v2.y - v0.y,\r\n    };\r\n    const dotUp = v02.x * n23.x + v02.y * n23.y;\r\n    const dotDn = v01.x * n23.x + v01.y * n23.y;\r\n    const TOO_SMALL = 1.0e-6;\r\n    if (Math.abs(dotDn) < TOO_SMALL) {\r\n      return null;\r\n    }\r\n    const t01 = dotUp / dotDn; // should be in [0..1]\r\n    if ((t01 < 0.0) || (t01 > 1.0)) {\r\n      return null;\r\n    }\r\n    // check intersect from 2nd line\r\n    const v20 = {\r\n      x: -v02.x,\r\n      y: -v02.y,\r\n    };\r\n    const n01 = {\r\n      x: -v01.y,\r\n      y: v01.x\r\n    };\r\n    const dotProdDn = v23.x * n01.x + v23.y * n01.y;\r\n    if (Math.abs(dotProdDn) < TOO_SMALL) {\r\n      return null;\r\n    }\r\n    const dotProdUp = v20.x * n01.x + v20.y * n01.y;\r\n    const t23 = dotProdUp / dotProdDn; // should be in [0..1]\r\n    if ((t23 < 0.0) || (t23 > 1.0)) {\r\n      return null;\r\n    }\r\n    const vIntersection = {\r\n      x: v0.x + v01.x * t01,\r\n      y: v0.y + v01.y * t01\r\n    };\r\n    return vIntersection;\r\n  }\r\n\r\n  static hasSelfIntersection(points) {\r\n    let i, j;\r\n    for (i = 0; i < points.length; i++) {\r\n      const iNext = (i + 1 < points.length) ? (i + 1) : 0;\r\n      const vA = points[i];\r\n      const vB = points[iNext];\r\n      for (j = 0; j < points.length; j++) {\r\n        const jNext = (j + 1 < points.length) ? (j + 1) : 0;\r\n        if ((i !== j) && (i !== jNext) && (iNext !== j) && (iNext !== jNext)) {\r\n          const vC = points[j];\r\n          const vD = points[jNext];\r\n          const vIntersect = ToolArea.getLineIntersection(vA, vB, vC, vD);\r\n          if (vIntersect !== null) {\r\n            return true;\r\n          }\r\n        } // if not same index\r\n        \r\n      } // for (j)\r\n    } // for (i)\r\n    return false;\r\n  }\r\n\r\n  static getSelfIntersectPoint(points) {\r\n    const numPoints = points.length;\r\n    if (numPoints <= 3) {\r\n      return null;\r\n    }\r\n    const vLast0 = points[numPoints - 2];\r\n    const vLast1 = points[numPoints - 1];\r\n    const limPoints = numPoints - 3;\r\n    for (let i = 0; i < limPoints; i++) {\r\n      const vLine0 = points[i + 0];\r\n      const vLine1 = points[i + 1];\r\n      const vIntersect = ToolArea.getLineIntersection(vLast0, vLast1, vLine0, vLine1);\r\n      if (vIntersect !== null) {\r\n        const objInter = {\r\n          m_vIntersection: vIntersect,\r\n          m_lineIndex: i\r\n        }\r\n        return objInter;\r\n      }\r\n    } // for (i) checked points in poly\r\n    // check dist to first\r\n    const dx = vLast1.x - points[0].x;\r\n    const dy = vLast1.y - points[0].y;\r\n    const MIN_DIST = 2.5;\r\n    const MIN_DIST_SQ = MIN_DIST * MIN_DIST;\r\n    if (dx * dx + dy * dy <= MIN_DIST_SQ) {\r\n      const vInter = {\r\n        x: vLast1.x,\r\n        y: vLast1.y,\r\n      };\r\n      const objInter = {\r\n        m_vIntersection: vInter,\r\n        m_lineIndex: 0\r\n      }\r\n      // console.log('getSelfIntersection: detect with start');\r\n      return objInter;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @param {object} vNew - new added point\r\n   * @param {array} points - array of polygon's points\r\n   * @return true, if polygon is finished\r\n   */\r\n  addPointToPolygon(vNew, points) {\r\n    const numPoints = points.length;\r\n    if (numPoints === 0) {\r\n      points.push(vNew);\r\n      return false;\r\n    }\r\n    const objInter = this.m_objSelfIntersect;\r\n    if (objInter !== null) {\r\n      const polyNew = [];\r\n      polyNew.push(objInter.m_vIntersection);\r\n      for (let i = objInter.m_lineIndex + 1; i < numPoints - 1; i++) {\r\n        const vAdd = {\r\n          x: points[i].x,\r\n          y: points[i].y\r\n        }\r\n        polyNew.push(vAdd);\r\n      }\r\n      // copy to points\r\n      points.length = polyNew.length;\r\n      for (let i = 0; i < polyNew.length; i++) {\r\n        points[i].x = polyNew[i].x;\r\n        points[i].y = polyNew[i].y;\r\n      }\r\n      this.m_objSelfIntersect = null;\r\n      return true;\r\n    } // if has some intersect point\r\n\r\n    // just add point to poly\r\n    points.push(vNew);\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @param {array} points - array of points (x,y) props\r\n   */\r\n  getPolyArea(points, store) {\r\n    const volSet = store.volumeSet;\r\n    const volIndex = store.volumeIndex;\r\n    const vol = volSet.getVolume(volIndex);\r\n\r\n    const xSize = vol.m_boxSize.x;\r\n    const ySize = vol.m_boxSize.y;\r\n    const zSize = vol.m_boxSize.z;\r\n    const mode2d = store.mode2d;\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    // const zDim = vol.m_zDim;\r\n    let xScale = 0.0, yScale = 0.0;\r\n    if (mode2d === Modes2d.TRANSVERSE) {\r\n      // z const\r\n      xScale = xSize / xDim;\r\n      yScale = ySize / yDim;\r\n    } else if (mode2d === Modes2d.SAGGITAL) {\r\n      // x const\r\n      xScale = ySize / xDim;\r\n      // yScale = zSize / yDim;\r\n      yScale = zSize / zDim;\r\n    } else {\r\n      // y const\r\n      xScale = xSize / xDim;\r\n      // yScale = zSize / yDim;\r\n      yScale = zSize / zDim;\r\n    }\r\n\r\n    let area = 0.0;\r\n    const numPoints = points.length;\r\n    let j = numPoints - 1;\r\n    for (let i = 0; i < numPoints; i++) {\r\n      const vi = points[i];\r\n      const vj = points[j];\r\n      let areaTri = (vj.x + vi.x) * (vj.y - vi.y) * xScale * yScale;\r\n      areaTri = (areaTri > 0.0) ? areaTri : (-areaTri);\r\n      area += areaTri;\r\n      j = i;\r\n    }\r\n    return area * 0.5;\r\n  }\r\n\r\n  /**\r\n   * When mouse button is pressed\r\n   * \r\n   * @param {number} xScr - x screen coordinate\r\n   * @param {number} yScr - y screen coordinate\r\n   * @param {object} store  - global store with all app parameters\r\n   */\r\n  onMouseDown(xScr, yScr, store) {\r\n    const vTex = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n    if (!this.m_inCreateMode) {\r\n      this.m_inCreateMode = true;\r\n      // create new area\r\n      const v0 = {\r\n        x: vTex.x,\r\n        y: vTex.y,\r\n      }\r\n      const v1 = {\r\n        x: vTex.x,\r\n        y: vTex.y,\r\n      }\r\n      const objArea = {\r\n        m_isClosed: false,\r\n        m_points: [],\r\n        m_area: 0.0\r\n      };\r\n      objArea.m_points.push(v0);\r\n      objArea.m_points.push(v1);\r\n      this.m_areas.push(objArea);\r\n    } else {\r\n      // add new point to polygon\r\n      const vNew = {\r\n        x: vTex.x,\r\n        y: vTex.y\r\n      };\r\n      const numAreas = this.m_areas.length;\r\n      const objArea = this.m_areas[numAreas - 1];\r\n\r\n      const isFinished = this.addPointToPolygon(vNew, objArea.m_points);\r\n      if (isFinished) {\r\n        objArea.m_isClosed = true;\r\n        objArea.m_area = this.getPolyArea(objArea.m_points, store);\r\n        console.log(`ToolArea. area = ${objArea.m_area}`);\r\n        // prepare to new added polygon\r\n        this.m_inCreateMode = false;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When mouse is moved\r\n   * \r\n   * @param {number} xScr - x screen coordinate\r\n   * @param {number} yScr - y screen coordinate\r\n   * @param {object} store  - global store with all app parameters\r\n   */\r\n  onMouseMove(xScr, yScr, store) {\r\n    if (!this.m_inCreateMode) {\r\n      return;\r\n    }\r\n    const vTex = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n    // modify last point in last area\r\n    const numAreas = this.m_areas.length;\r\n    const objArea = this.m_areas[numAreas - 1];\r\n    const numPoints = objArea.m_points.length;\r\n    objArea.m_points[numPoints - 1].x = vTex.x;\r\n    objArea.m_points[numPoints - 1].y = vTex.y;\r\n    const pt = ToolArea.getSelfIntersectPoint(objArea.m_points);\r\n    this.m_objSelfIntersect = pt;\r\n    this.m_objGraphics2d.forceUpdate();\r\n  }\r\n\r\n  onMouseUp() { // ommited args: xScr, yScr, store\r\n  }\r\n\r\n  /**\r\n   * Render all areas on screen in 2d mode\r\n   * \r\n   * @param {object} ctx - html5 canvas context\r\n   * @param {object} store - global store with app parameters\r\n   */\r\n  render(ctx, store) {\r\n    ctx.lineWidth = 2;\r\n    ctx.strokeStyle = 'yellow';\r\n    ctx.fillStyle = 'white';\r\n    const FONT_SZ = 16;\r\n    ctx.font = FONT_SZ.toString() + 'px Arial';\r\n    ctx.textAlign = 'center';\r\n    ctx.textBaseline = 'bottom';\r\n\r\n    // render possible self intersect point\r\n    if (this.m_objSelfIntersect !== null) {\r\n      const vTex = this.m_objSelfIntersect.m_vIntersection;\r\n      const vScr = ToolDistance.textureToScreen(vTex.x, vTex.y, this.m_wScreen, this.m_hScreen, store);\r\n      ctx.strokeStyle = 'red';\r\n      ctx.beginPath();\r\n      const RAD_CIRCLE = 5.0;\r\n      const M_PI = 3.1415926535;\r\n      const TWO = 2;\r\n      ctx.arc(vScr.x, vScr.y, RAD_CIRCLE, 0.0, TWO * M_PI);\r\n      ctx.stroke();\r\n\r\n    }\r\n\r\n    ctx.strokeStyle = 'yellow';\r\n    const numAreas = this.m_areas.length;\r\n    for (let a = 0; a < numAreas; a++) {\r\n      const objArea = this.m_areas[a];\r\n      const isClosed = objArea.m_isClosed;\r\n      const numPoints = (isClosed) ? (objArea.m_points.length + 1) : (objArea.m_points.length);\r\n      // console.log(`ToolArea. render ${numPoints} points in poly`);\r\n\r\n      // calc area centroid in screen\r\n      let xScrCenter = 0.0;\r\n      let yScrCenter = 0.0;\r\n\r\n      ctx.beginPath();\r\n      for (let i = 0; i < numPoints; i++) {\r\n        const iPoly = (i < objArea.m_points.length) ? (i) : 0;\r\n        const vTex0 = objArea.m_points[iPoly];\r\n        // console.log(`ToolArea. render point ${vTex0.x}, ${vTex0.y} `);\r\n        const vScr = ToolDistance.textureToScreen(vTex0.x, vTex0.y, this.m_wScreen, this.m_hScreen, store);\r\n        if (i === 0) {\r\n          ctx.moveTo(vScr.x, vScr.y);\r\n        } else {\r\n          ctx.lineTo(vScr.x, vScr.y);\r\n        }\r\n        xScrCenter += vScr.x;\r\n        yScrCenter += vScr.y;\r\n      } // for (i) all points in poly\r\n      ctx.stroke();\r\n\r\n      if (numPoints > 0) {\r\n        xScrCenter /= numPoints;\r\n        yScrCenter /= numPoints;\r\n      }\r\n\r\n      // draw area\r\n      if (isClosed) {\r\n        const strMsg = objArea.m_area.toFixed(2) + ' mm^2';\r\n        // const SHIFT_UP = 8;\r\n        //const vTex0 = objArea.m_points[0];\r\n        //const vs0 = ToolDistance.textureToScreen(vTex0.x, vTex0.y, this.m_wScreen, this.m_hScreen, store);\r\n        //const xText = vs0.x;\r\n        //const yText = vs0.y - SHIFT_UP;\r\n        // ctx.fillText(strMsg, xText, yText);\r\n\r\n        ctx.fillText(strMsg, xScrCenter, yScrCenter);\r\n      } // if this poly closed\r\n    } // for (a) all polys\r\n  }\r\n\r\n} // end class\r\nexport default ToolArea;\r\n","/**\r\n * @fileOverview ToolRect\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\n\r\nimport ToolDistance from './ToolDistance';\r\nimport Modes2d from '../../store/Modes2d';\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass ToolRect {\r\n  constructor(objGra) {\r\n    this.m_objGraphics2d = objGra;\r\n    this.m_wScreen = 0;\r\n    this.m_hScreen = 0;\r\n\r\n    this.m_rects = [];\r\n    this.m_inCreateMode = false;\r\n\r\n    this.m_xPixelSize = 0;\r\n    this.m_yPixelSize = 0;\r\n\r\n    this.m_store = null;\r\n    this.m_objEdit = null;\r\n\r\n    this.onMouseDown = this.onMouseDown.bind(this);\r\n    this.onMouseUp = this.onMouseUp.bind(this);\r\n    this.onMouseMove = this.onMouseMove.bind(this);\r\n    this.render = this.render.bind(this);\r\n  }\r\n\r\n  setScreenDim(wScr, hScr) {\r\n    this.m_wScreen = wScr;\r\n    this.m_hScreen = hScr;\r\n  }\r\n\r\n  setPixelSize(xs, ys) {\r\n    this.m_xPixelSize = xs;\r\n    this.m_yPixelSize = ys;\r\n  }\r\n\r\n  clear() {\r\n    this.m_rects = [];\r\n    this.m_inCreateMode = false;\r\n  }\r\n\r\n  getDistMm(vs, ve) {\r\n    const dx = vs.x - ve.x;\r\n    const dy = vs.y - ve.y;\r\n    const dist = Math.sqrt(dx * dx * this.m_xPixelSize * this.m_xPixelSize +\r\n      dy * dy * this.m_yPixelSize * this.m_yPixelSize);\r\n    return dist;\r\n  }\r\n\r\n  /**\r\n   * Determine intersection with points in rect set.\r\n   * Input - screen coordinates of pick point\r\n   * Output - volume coordinate\r\n   *  \r\n   * @param {object} vScr - screen coordinates of pick\r\n   * @param {object} store - global store\r\n   */\r\n  getEditPoint(vScr, store) {\r\n    const numRects = this.m_rects.length;\r\n    for (let i = 0; i < numRects; i++) {\r\n      const objRect = this.m_rects[i];\r\n      const vScrMin = ToolDistance.textureToScreen(objRect.vMin.x, objRect.vMin.y, this.m_wScreen, this.m_hScreen, store);\r\n      const vScrMax = ToolDistance.textureToScreen(objRect.vMax.x, objRect.vMax.y, this.m_wScreen, this.m_hScreen, store);\r\n\r\n      const MIN_DIST = 4.0;\r\n      if (this.getDistMm(vScr, vScrMin) <= MIN_DIST) {\r\n        this.m_objEdit = objRect;\r\n        return objRect.vMin;\r\n      }\r\n      if (this.getDistMm(vScr, vScrMax) <= MIN_DIST) {\r\n        this.m_objEdit = objRect;\r\n        return objRect.vMax;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Move edited point into new pos\r\n   * \r\n   * @param {object} vVolOld \r\n   * @param {object} vVolNew \r\n   */\r\n  moveEditPoint(vVolOld, vVolNew) {\r\n    vVolOld.x = vVolNew.x;\r\n    vVolOld.y = vVolNew.y;\r\n    // update line len\r\n    this.getRectArea(this.m_objEdit, this.m_store);\r\n  }\r\n\r\n  /**\r\n   * Remove highlighted object\r\n   * \r\n   */\r\n  deleteObject() {\r\n    if (this.m_objEdit != null) {\r\n      const ind = this.m_rects.indexOf(this.m_objEdit);\r\n      if (ind >= 0) {\r\n        this.m_rects.splice(ind, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  getRectArea(objRect, store) {\r\n    const volSet = store.volumeSet;\r\n    const volIndex = store.volumeIndex;\r\n    const vol = volSet.getVolume(volIndex);\r\n                                          \r\n    const xSize = vol.m_boxSize.x;\r\n    const ySize = vol.m_boxSize.y;\r\n    const zSize = vol.m_boxSize.z;\r\n    const mode2d = store.mode2d;\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    let xScale = 0.0, yScale = 0.0;\r\n    if (mode2d === Modes2d.TRANSVERSE) {\r\n      // z const\r\n      xScale = xSize / xDim;\r\n      yScale = ySize / yDim;\r\n    } else if (mode2d === Modes2d.SAGGITAL) {\r\n      // x const\r\n      xScale = ySize / xDim;\r\n      yScale = zSize / zDim;\r\n    } else {\r\n      // y const\r\n      xScale = xSize / xDim;\r\n      yScale = zSize / zDim;\r\n    }\r\n    const dx = Math.abs(objRect.vMax.x - objRect.vMin.x); \r\n    const dy = Math.abs(objRect.vMax.y - objRect.vMin.y); \r\n    objRect.area = xScale * yScale * dx * dy; \r\n  }\r\n\r\n  onMouseDown(xScr, yScr, store) {\r\n    this.m_store = store;\r\n    const vTex = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n    if (!this.m_inCreateMode)\r\n    {\r\n      this.m_inCreateMode = true;\r\n      // start add rect\r\n      const objRect = {\r\n        vMin: {\r\n          x: vTex.x,\r\n          y: vTex.y,\r\n        },\r\n        vMax: {\r\n          x: vTex.x,\r\n          y: vTex.y,\r\n        },\r\n        area: 0.0,\r\n      };\r\n      this.m_rects.push(objRect);\r\n    } else {\r\n      this.m_inCreateMode = false;\r\n    }\r\n  }\r\n\r\n  onMouseMove(xScr, yScr, store) {\r\n    if (this.m_inCreateMode) {\r\n      const vTex = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n      const numRects = this.m_rects.length;\r\n      const objRect = this.m_rects[numRects - 1];\r\n      objRect.vMax.x = vTex.x;\r\n      objRect.vMax.y = vTex.y;\r\n      this.getRectArea(objRect, store);\r\n      this.m_objGraphics2d.forceUpdate();\r\n    } // if in create rect mode\r\n  }\r\n\r\n  onMouseUp() { // ommitred args: xScr, yScr, store\r\n  }\r\n\r\n  /**\r\n   * Render all areas on screen in 2d mode\r\n   * \r\n   * @param {object} ctx - html5 canvas context\r\n   * @param {object} store - global store with app parameters\r\n   */\r\n  render(ctx, store) {\r\n    ctx.lineWidth = 2;\r\n    ctx.strokeStyle = 'yellow';\r\n    ctx.fillStyle = 'white';\r\n    const FONT_SZ = 16;\r\n    ctx.font = FONT_SZ.toString() + 'px Arial';\r\n    ctx.textAlign = 'center';\r\n    ctx.textBaseline = 'bottom';\r\n\r\n    const numRects = this.m_rects.length;\r\n    for (let i = 0; i < numRects; i++) {\r\n      const objRect = this.m_rects[i];\r\n      const vTexMin = objRect.vMin;\r\n      const vTexMax = objRect.vMax;\r\n      const vScrMin = ToolDistance.textureToScreen(vTexMin.x, vTexMin.y, this.m_wScreen, this.m_hScreen, store);\r\n      const vScrMax = ToolDistance.textureToScreen(vTexMax.x, vTexMax.y, this.m_wScreen, this.m_hScreen, store);\r\n      ctx.beginPath();\r\n      ctx.moveTo(vScrMin.x, vScrMin.y);\r\n      ctx.lineTo(vScrMax.x, vScrMin.y);\r\n      ctx.lineTo(vScrMax.x, vScrMax.y);\r\n      ctx.lineTo(vScrMin.x, vScrMax.y);\r\n      ctx.lineTo(vScrMin.x, vScrMin.y);\r\n      ctx.stroke();\r\n      // draw text\r\n      const xText = Math.floor((vScrMin.x + vScrMax.x) * 0.5);\r\n      const yText = Math.floor((vScrMin.y + vScrMax.y) * 0.5);\r\n      const strMsg = objRect.area.toFixed(2) + ' mm^2';\r\n      ctx.fillText(strMsg, xText, yText);\r\n\r\n    } // for (i) all rects\r\n  } // end render\r\n} // end class ToolRect\r\n\r\nexport default ToolRect;\r\n","/**\r\n * @fileOverview ToolText\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\n\r\nimport ToolDistance from './ToolDistance';\r\n// import UiModalText from '../../ui/UiModalText';\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass ToolText {\r\n  constructor(objGra) {\r\n    this.m_objGraphics2d = objGra;\r\n    this.m_wScreen = 0;\r\n    this.m_hScreen = 0;\r\n\r\n    this.m_texts = [];\r\n    this.m_pointPressed = null;\r\n\r\n    this.m_objEdit = null;\r\n\r\n    this.m_xPixelSize = 0;\r\n    this.m_yPixelSize = 0;\r\n\r\n    this.onMouseDown = this.onMouseDown.bind(this);\r\n    this.onMouseUp = this.onMouseUp.bind(this);\r\n    this.onMouseMove = this.onMouseMove.bind(this);\r\n    this.render = this.render.bind(this);\r\n    this.setText = this.setText.bind(this);\r\n  }\r\n\r\n  setScreenDim(wScr, hScr) {\r\n    this.m_wScreen = wScr;\r\n    this.m_hScreen = hScr;\r\n  }\r\n\r\n  setPixelSize(xs, ys) {\r\n    this.m_xPixelSize = xs;\r\n    this.m_yPixelSize = ys;\r\n  }\r\n\r\n  /**\r\n   * Determine intersection with points in all texts.\r\n   * Input - screen coordinates of pick point\r\n   * Output - volume coordinate\r\n   *  \r\n   * @param {object} vScr - screen coordinates of poick\r\n   * @param {object} store - global store\r\n   */\r\n  getEditPoint(vScr, store) {\r\n    const numTexts = this.m_texts.length;\r\n    for (let i = 0; i < numTexts; i++) {\r\n      const objText = this.m_texts[i];\r\n      const vScrProj = ToolDistance.textureToScreen(objText.point.x, objText.point.y, this.m_wScreen, this.m_hScreen, store);\r\n      const MIN_DIST = 4.0;\r\n      if (this.getDistMm(vScr, vScrProj) <= MIN_DIST) {\r\n        this.m_objEdit = objText;\r\n        return objText.point;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Move edited point into new pos\r\n   * \r\n   * @param {object} vVolOld \r\n   * @param {object} vVolNew \r\n   */\r\n  moveEditPoint(vVolOld, vVolNew) {\r\n    vVolOld.x = vVolNew.x;\r\n    vVolOld.y = vVolNew.y;\r\n    // update info about text\r\n  }\r\n\r\n  /**\r\n   * Remove highlighted object\r\n   * \r\n   */\r\n  deleteObject() {\r\n    if (this.m_objEdit != null) {\r\n      const ind = this.m_texts.indexOf(this.m_objEdit);\r\n      if (ind >= 0) {\r\n        this.m_texts.splice(ind, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  getDistMm(vs, ve) {\r\n    const dx = vs.x - ve.x;\r\n    const dy = vs.y - ve.y;\r\n    const dist = Math.sqrt(dx * dx * this.m_xPixelSize * this.m_xPixelSize +\r\n      dy * dy * this.m_yPixelSize * this.m_yPixelSize);\r\n    return dist;\r\n  }\r\n\r\n  setText(str) {\r\n    this.m_text = str;\r\n    console.log(`set text = ${str}`);\r\n    const objText = {\r\n      point: {\r\n        x: this.m_pointPressed.x,\r\n        y: this.m_pointPressed.y\r\n      },\r\n      text: str\r\n    };\r\n    this.m_texts.push(objText);\r\n    // invoke render\r\n    this.m_objGraphics2d.forceUpdate();\r\n  }\r\n\r\n  clear() {\r\n    this.m_texts = [];\r\n  }\r\n\r\n  /**\r\n   * When mouse pressed down\r\n   * \r\n   * @param {number} xScr - x coordinate of click on screen\r\n   * @param {number} yScr - y coordinate of click on screen\r\n   * @param {object} store - global storage\r\n   */  \r\n  onMouseDown(xScr, yScr, store) {\r\n    const vTex = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n    this.m_pointPressed = vTex;\r\n\r\n    const uiApp = store.uiApp;\r\n    uiApp.onShowModalText();\r\n  }\r\n\r\n  onMouseMove() { // args ommited: xScr, yScr, store\r\n  }\r\n\r\n  onMouseUp() { // args ommited: xScr, yScr, store\r\n  }\r\n\r\n  /**\r\n   * Render all areas on screen in 2d mode\r\n   * \r\n   * @param {object} ctx - html5 canvas context\r\n   * @param {object} store - global store with app parameters\r\n   */\r\n  render(ctx, store) {\r\n    ctx.lineWidth = 2;\r\n    ctx.strokeStyle = 'yellow';\r\n    ctx.fillStyle = 'white';\r\n    const FONT_SZ = 16;\r\n    ctx.font = FONT_SZ.toString() + 'px Arial';\r\n    ctx.textAlign = 'center';\r\n    ctx.textBaseline = 'bottom';\r\n\r\n    const numTexts = this.m_texts.length;\r\n    for (let i = 0; i < numTexts; i++) {\r\n      const objText = this.m_texts[i];\r\n      const vTex = objText.point;\r\n      const vScr = ToolDistance.textureToScreen(vTex.x, vTex.y, this.m_wScreen, this.m_hScreen, store);\r\n      const strMsg = objText.text;\r\n      ctx.fillText(strMsg, vScr.x, vScr.y);\r\n    } // for (i)\r\n\r\n    /*\r\n    const numRects = this.m_rects.length;\r\n    for (let i = 0; i < numRects; i++) {\r\n      const objRect = this.m_rects[i];\r\n      const vTexMin = objRect.vMin;\r\n      const vTexMax = objRect.vMax;\r\n      const vScrMin = ToolDistance.textureToScreen(vTexMin.x, vTexMin.y, this.m_wScreen, this.m_hScreen, store);\r\n      const vScrMax = ToolDistance.textureToScreen(vTexMax.x, vTexMax.y, this.m_wScreen, this.m_hScreen, store);\r\n      ctx.beginPath();\r\n      ctx.moveTo(vScrMin.x, vScrMin.y);\r\n      ctx.lineTo(vScrMax.x, vScrMin.y);\r\n      ctx.lineTo(vScrMax.x, vScrMax.y);\r\n      ctx.lineTo(vScrMin.x, vScrMax.y);\r\n      ctx.lineTo(vScrMin.x, vScrMin.y);\r\n      ctx.stroke();\r\n      // draw text\r\n      const xText = Math.floor((vScrMin.x + vScrMax.x) * 0.5);\r\n      const yText = Math.floor((vScrMin.y + vScrMax.y) * 0.5);\r\n      const strMsg = objRect.area.toFixed(2) + ' mm^2';\r\n      ctx.fillText(strMsg, xText, yText);\r\n\r\n    } // for (i) all rects\r\n    */\r\n  } // end render\r\n} // end class ToolText\r\n\r\nexport default ToolText;\r\n","/**\r\n * @fileOverview ToolEdit\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\n\r\nimport ToolDistance from \"./ToolDistance\";\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass ToolEdit {\r\n  constructor(objGra) {\r\n    this.m_objGraphics2d = objGra;\r\n    this.m_wScreen = 0;\r\n    this.m_hScreen = 0;\r\n\r\n    this.m_xPixelSize = 0;\r\n    this.m_yPixelSize = 0;\r\n\r\n    this.onMouseDown = this.onMouseDown.bind(this);\r\n    this.onMouseUp = this.onMouseUp.bind(this);\r\n    this.onMouseMove = this.onMouseMove.bind(this);\r\n    this.render = this.render.bind(this);\r\n\r\n    this.m_mousePressed = false;\r\n    this.m_pointTracked = null;\r\n    this.m_toolTracked = null;\r\n  }\r\n\r\n  setScreenDim(wScr, hScr) {\r\n    this.m_wScreen = wScr;\r\n    this.m_hScreen = hScr;\r\n  }\r\n\r\n  setPixelSize(xs, ys) {\r\n    this.m_xPixelSize = xs;\r\n    this.m_yPixelSize = ys;\r\n  }\r\n\r\n  clear() {\r\n    this.m_mousePressed = false;\r\n    this.m_pointTracked = null;\r\n    this.m_toolTracked = null;\r\n  }\r\n\r\n  /**\r\n   * When mouse pressed down\r\n   * \r\n   * @param {number} xScr - x coordinate of click on screen\r\n   * @param {number} yScr - y coordinate of click on screen\r\n   * @param {object} store - global storage\r\n   */  \r\n  onMouseDown() { // ommited args: xScr, yScr, store\r\n    this.m_mousePressed = true;\r\n  }\r\n\r\n  onMouseMove(xScr, yScr, store) {\r\n    if (!this.m_mousePressed) {\r\n      // fly mouse over objects on 2d screen\r\n      // const vTex = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n      const vScr = {\r\n        x: xScr, y: yScr\r\n      };\r\n\r\n      const toolDist = this.m_objGraphics2d.m_toolDistance;\r\n      const toolAngle = this.m_objGraphics2d.m_toolAngle;\r\n      const toolArea = this.m_objGraphics2d.m_toolArea;\r\n      const toolRect = this.m_objGraphics2d.m_toolRect;\r\n      const toolText = this.m_objGraphics2d.m_toolText;\r\n      const tools = [\r\n        toolDist, toolAngle, toolArea, toolRect, toolText\r\n      ];\r\n      const trackedBefore = (this.m_pointTracked !== null);\r\n      this.m_pointTracked = null;\r\n      const numTools = tools.length;\r\n      for (let i = 0; i < numTools; i++) {\r\n        const objTool = tools[i];\r\n        const vDetect = objTool.getEditPoint(vScr, store);\r\n        if (vDetect !== null) {\r\n          // console.log(`ToolEdit. point tracked: ${vDetect.x}, ${vDetect.y}`);\r\n          this.m_pointTracked = vDetect;\r\n          this.m_toolTracked = objTool;\r\n          break;\r\n        }\r\n      } // for i all tools\r\n      const trackedNow = (this.m_pointTracked !== null);\r\n      if (trackedNow || (trackedBefore && !trackedNow)) {\r\n        // invoke forced 2d render\r\n        this.m_objGraphics2d.forceUpdate();\r\n      }\r\n\r\n    } else {\r\n      if (this.m_pointTracked !== null) {\r\n        const vTexNew = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n        this.m_toolTracked.moveEditPoint(this.m_pointTracked, vTexNew);\r\n        // invoke forced 2d render\r\n        this.m_objGraphics2d.forceUpdate();\r\n      } // if we have tracked point\r\n    }\r\n  }\r\n\r\n  onMouseUp() { // ommited args : xScr, yScr, store\r\n    this.m_mousePressed = false;\r\n  }\r\n\r\n  /**\r\n   * Render all areas on screen in 2d mode\r\n   * \r\n   * @param {object} ctx - html5 canvas context\r\n   * @param {object} store - global store with app parameters\r\n   */\r\n  render(ctx, store) {\r\n    if (this.m_pointTracked !== null) {\r\n      const vScr = ToolDistance.textureToScreen(this.m_pointTracked.x, this.m_pointTracked.y, this.m_wScreen, this.m_hScreen, store);\r\n      const RAD_CIRCLE_EDIT = 4;\r\n      //ctx.lineWidth = 2;\r\n      //ctx.strokeStyle = 'green';\r\n      ctx.fillStyle = 'rgb(120, 250, 120)';\r\n      ctx.beginPath();\r\n      ctx.arc(vScr.x, vScr.y, RAD_CIRCLE_EDIT, 0.0, 2 * 3.1415962, false);\r\n      // ctx.stroke();\r\n      ctx.fill();\r\n    }\r\n  } // end render\r\n} // end class ToolText\r\n\r\nexport default ToolEdit;\r\n","/**\r\n * @fileOverview ToolDelete\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\n\r\nimport ToolDistance from './ToolDistance';\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass ToolDelete {\r\n  constructor(objGra) {\r\n    this.m_objGraphics2d = objGra;\r\n    this.m_wScreen = 0;\r\n    this.m_hScreen = 0;\r\n\r\n    this.m_xPixelSize = 0;\r\n    this.m_yPixelSize = 0;\r\n\r\n    this.onMouseDown = this.onMouseDown.bind(this);\r\n    this.onMouseUp = this.onMouseUp.bind(this);\r\n    this.onMouseMove = this.onMouseMove.bind(this);\r\n    this.render = this.render.bind(this);\r\n\r\n    this.m_mousePressed = false;\r\n    this.m_pointTracked = null;\r\n    this.m_toolTracked = null;\r\n  }\r\n\r\n  setScreenDim(wScr, hScr) {\r\n    this.m_wScreen = wScr;\r\n    this.m_hScreen = hScr;\r\n  }\r\n\r\n  setPixelSize(xs, ys) {\r\n    this.m_xPixelSize = xs;\r\n    this.m_yPixelSize = ys;\r\n  }\r\n\r\n  clear() {\r\n    this.m_mousePressed = false;\r\n    this.m_pointTracked = null;\r\n    this.m_toolTracked = null;\r\n  }\r\n\r\n  /**\r\n   * When mouse pressed down\r\n   */  \r\n  onMouseDown() { // ommited args: xScr, yScr, store\r\n    this.m_mousePressed = true;\r\n\r\n    if (this.m_pointTracked !== null) {\r\n      this.m_toolTracked.deleteObject(this.m_pointTracked);\r\n      this.m_pointTracked = null;\r\n      // invoke forced 2d render\r\n      this.m_objGraphics2d.forceUpdate();\r\n    }\r\n  }\r\n\r\n  onMouseMove(xScr, yScr, store) {\r\n    if (!this.m_mousePressed) {\r\n      // fly mouse over objects on 2d screen\r\n      const vScr = {\r\n        x: xScr, y: yScr\r\n      };\r\n\r\n      const toolDist = this.m_objGraphics2d.m_toolDistance;\r\n      const toolAngle = this.m_objGraphics2d.m_toolAngle;\r\n      const toolArea = this.m_objGraphics2d.m_toolArea;\r\n      const toolRect = this.m_objGraphics2d.m_toolRect;\r\n      const toolText = this.m_objGraphics2d.m_toolText;\r\n      const tools = [\r\n        toolDist, toolAngle, toolArea, toolRect, toolText\r\n      ];\r\n      const trackedBefore = (this.m_pointTracked !== null);\r\n      this.m_pointTracked = null;\r\n      const numTools = tools.length;\r\n      for (let i = 0; i < numTools; i++) {\r\n        const objTool = tools[i];\r\n        const vDetect = objTool.getEditPoint(vScr, store);\r\n        if (vDetect !== null) {\r\n          // console.log(`ToolEdit. point tracked: ${vDetect.x}, ${vDetect.y}`);\r\n          this.m_pointTracked = vDetect;\r\n          this.m_toolTracked = objTool;\r\n          break;\r\n        }\r\n      } // for i all tools\r\n      const trackedNow = (this.m_pointTracked !== null);\r\n      if (trackedNow || (trackedBefore && !trackedNow)) {\r\n        // invoke forced 2d render\r\n        this.m_objGraphics2d.forceUpdate();\r\n      }\r\n\r\n    } else {\r\n      /*\r\n      if (this.m_pointTracked !== null) {\r\n        const vTexNew = ToolDistance.screenToTexture(xScr, yScr, this.m_wScreen, this.m_hScreen, store);\r\n        this.m_toolTracked.moveEditPoint(this.m_pointTracked, vTexNew);\r\n        // invoke forced 2d render\r\n        this.m_objGraphics2d.forceUpdate();\r\n      } // if we have tracked point\r\n      */\r\n    }\r\n  }\r\n\r\n  onMouseUp() { // ommited args: xScr, yScr, store\r\n    this.m_mousePressed = false;\r\n  }\r\n\r\n  /**\r\n   * Render all areas on screen in 2d mode\r\n   * \r\n   * @param {object} ctx - html5 canvas context\r\n   * @param {object} store - global store with app parameters\r\n   */\r\n  render(ctx, store) {\r\n    if (this.m_pointTracked !== null) {\r\n      const vScr = ToolDistance.textureToScreen(this.m_pointTracked.x, this.m_pointTracked.y, this.m_wScreen, this.m_hScreen, store);\r\n      const RAD_CIRCLE_EDIT = 4;\r\n      //ctx.lineWidth = 2;\r\n      //ctx.strokeStyle = 'green';\r\n      ctx.fillStyle = 'rgb(250, 120, 120)';\r\n      ctx.beginPath();\r\n      ctx.arc(vScr.x, vScr.y, RAD_CIRCLE_EDIT, 0.0, 2 * 3.1415962, false);\r\n      // ctx.stroke();\r\n      ctx.fill();\r\n    }\r\n  } // end render\r\n} // end class ToolText\r\n\r\nexport default ToolDelete;\r\n","/**\r\n * @fileOverview ToolTypes\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n \r\nconst Tools2dType = {\r\n  INTENSITY: 0,\r\n  DISTANCE: 1,\r\n  ANGLE: 2,\r\n  AREA: 3,\r\n  RECT: 4,\r\n  TEXT: 5,\r\n  EDIT: 6,\r\n  DELETE: 7,\r\n  CLEAR: 8,\r\n  ZOOM: 9,\r\n  DEFAULT: 10,\r\n  FILTER: 11,\r\n  NONE: 12,\r\n};\r\nexport default Tools2dType;\r\n","/**\r\n * @fileOverview Segm2d\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport * as tf from '@tensorflow/tfjs';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// where VGG_UNET ready model file located to download\r\n// this folder should contain following files:\r\n// - model.json: description of machine learning model koefficienst\r\n// - group1-shard1of12.bin: 1st binary koeeficient file\r\n// - group1-shard2of12.bin: 2nd binary koeeficient file\r\n// - ...\r\n// - group1-shard12of12.bin: last binary koeeficient file\r\n// - .htaccess: file to prevent CORS issue\r\n\r\nconst PATH_MODEL = 'http://lugachai.ru/med3web/tfjs/model.json';\r\n\r\n// stages\r\nconst STAGE_MODEL_NOT_LOADED = 0;\r\nconst STAGE_MODEL_IS_LOADING = 1;\r\nconst STAGE_MODEL_READY = 2;\r\nconst STAGE_IMAGE_PROCESSED = 3;\r\nconst STAGE_SEGMENTATION_READY = 4;\r\n// const STAGE_READY_NEXT_IMAGE = 5;\r\n\r\n\r\nconst OUT_W = 240;\r\nconst OUT_H = 160;\r\nconst NUM_CLASSES = 96;\r\n\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\nclass Segm2d\r\n{\r\n  constructor(objGraphics2d) {\r\n    this.stage = STAGE_MODEL_NOT_LOADED;\r\n    this.objGraphics2d = objGraphics2d;\r\n    this.model = null;\r\n    this.tensorIndices = null;\r\n    this.imgData = null;\r\n    this.pixels = null;\r\n\r\n    // source image for segmentation\r\n    this.srcImageData = null;\r\n    this.wSrc = -1;\r\n    this.hSrc = -1;\r\n\r\n    this.onLoadModel = this.onLoadModel.bind(this);\r\n    this.startApplyImage = this.startApplyImage.bind(this);\r\n\r\n    this.m_needApplySegmentation = false;\r\n  }\r\n\r\n  // debug\r\n  printTensor(tensor, numValues = 64 * 3) {\r\n    console.log('tensor shape = ' + tensor.shape);\r\n    const tensorData = tensor.dataSync();\r\n    let strDebug = ''\r\n    for (let i = 0; i < numValues; i++) {\r\n      strDebug += tensorData[i].toString() + \", \";\r\n    }\r\n    console.log(\"tensor raw data = \" + strDebug);\r\n  }\r\n\r\n  // debug\r\n  printTensorIndices(tensor) {\r\n    const numCols = tensor.shape[1];\r\n    const numRows = tensor.shape[0];\r\n    const tensorData = tensor.dataSync();\r\n    console.log('Tensor indices');\r\n    let i = 0;\r\n    for (let y = 0; y < numRows; y++) {\r\n      let strOut = '';\r\n      for (let x = 0; x < numCols; x++) {\r\n        const val = tensorData[i++];\r\n        strOut += val.toString();\r\n      } // for (x)\r\n      console.log(strOut);\r\n    } // for (y)\r\n  }\r\n\r\n  scaleUp(pixelsSrcInt, wSrc, hSrc, pixelsDst, wDst, hDst) {\r\n    // float scales\r\n    const xScale = wSrc / wDst;\r\n    const yScale = hSrc / hDst;\r\n    let ySrcAcc = 0.0;\r\n    let iDst = 0;\r\n    for (let y = 0; y < hDst; y++, ySrcAcc += yScale) {\r\n      const ySrcBase = Math.floor(ySrcAcc);\r\n      const yRem = ySrcAcc - ySrcBase;\r\n      const ySrcInd = (yRem < 0.5) ? 0 : 1;\r\n      const ySrc = ySrcBase + ySrcInd;\r\n      const ySrcOff = ySrc * wSrc;\r\n\r\n      let xSrcAcc = 0.0;\r\n      for (let x = 0; x < wDst; x++, xSrcAcc += xScale) {\r\n        const xSrcBase = Math.floor(xSrcAcc);\r\n        const xRem = xSrcAcc - xSrcBase;\r\n        const xSrcInd = (xRem < 0.5) ? 0 : 1;\r\n        const xSrc = xSrcBase + xSrcInd;\r\n        pixelsDst[iDst++] = pixelsSrcInt[xSrc + ySrcOff];\r\n          \r\n      } // for (x)\r\n    } // for (y)\r\n  }\r\n\r\n  //\r\n  // Load model\r\n  async onLoadModel() {\r\n    this.stage = STAGE_MODEL_IS_LOADING;\r\n    this.pixels = null;\r\n\r\n    console.log('Loading tfjs model...');\r\n    const modelLoaded = await tf.loadLayersModel(PATH_MODEL, { strict: false } );\r\n\r\n    this.model = modelLoaded;\r\n    this.stage = STAGE_MODEL_READY;\r\n\r\n    // print success model loading\r\n    console.log(\"Model is loaded shape = \" + modelLoaded.output.shape);\r\n    //this.objGraphics2d.forceUpdate();\r\n    this.startApplyImage();\r\n  }\r\n\r\n  async startApplyImage() {\r\n    this.stage = STAGE_IMAGE_PROCESSED;\r\n    console.log(\"Start apply segm to image ...\");\r\n\r\n    // prepare tensor\r\n    const imgTensor = tf.browser.fromPixels(this.srcImageData).toFloat();\r\n    // this.printTensor(imgTensor);\r\n\r\n    // resize\r\n    const IN_W = 320;\r\n    const IN_H = 480;\r\n    const imgResized = imgTensor.resizeBilinear([IN_W, IN_H]);\r\n\r\n    // normalize to [-127..+127]\r\n    const mean = tf.tensor([123.0, 116.0, 103.0])\r\n    const imgNormalized = imgResized.sub(mean);\r\n\r\n    // reshape tensor => [1, 320, 480, 3]\r\n    const imgReshaped = imgNormalized.reshape([1, IN_W, IN_H, 3]); \r\n\r\n    // apply prediction\r\n    const prediction = this.model.predict(imgReshaped);\r\n    // this.printTensor(prediction, 150*3);\r\n\r\n    const outpTensor = prediction.as2D(OUT_W * OUT_H, NUM_CLASSES);\r\n    const outRes = outpTensor.reshape([OUT_H, OUT_W, NUM_CLASSES]);\r\n\r\n    // get argmax: replace vec float[96] with index of maximum element\r\n    const tensorPreData = outRes.dataSync();\r\n    this.tensorIndices = new tf.zeros([OUT_H, OUT_W], 'int32');\r\n    const tensorIndData = this.tensorIndices.dataSync();\r\n\r\n    let iSrc = 0;\r\n    let iDst = 0;\r\n\r\n    for (let y = 0; y < OUT_H; y++) {\r\n      for (let x = 0; x < OUT_W; x++) {\r\n        let bestIndex = -1;\r\n        let valMax = -0.1;\r\n        for (let i = 0; i < NUM_CLASSES; i++) {\r\n          if (tensorPreData[iSrc + i] > valMax) {\r\n            valMax = tensorPreData[iSrc + i];\r\n            bestIndex = i;\r\n          } // if\r\n        } // for (i)\r\n        tensorIndData[iDst] = bestIndex;\r\n        iSrc += NUM_CLASSES;\r\n        iDst += 1;\r\n      } // for (x)\r\n    } // for (y)\r\n\r\n    // debug print tesor indices\r\n    // this.printTensorIndices(this.tensorIndices, 200*3);\r\n\r\n    // scale up image with indices\r\n    const pixelsUpScale = new Uint8ClampedArray(this.wSrc * this.hSrc);\r\n    this.scaleUp(tensorIndData, OUT_W, OUT_H, pixelsUpScale, this.wSrc, this.hSrc);\r\n\r\n    // generate 96-colors palette\r\n    const palette = new Uint8ClampedArray(256 * 4);\r\n    let i, j;\r\n    i = 0; j = 0;\r\n    // fill 5 first elements by hand\r\n    palette[j++] = 0;\r\n    palette[j++] = 0;\r\n    palette[j++] = 255;\r\n    palette[j++] = 255;\r\n    i++;\r\n\r\n    palette[j++] = 0;\r\n    palette[j++] = 255;\r\n    palette[j++] = 0;\r\n    palette[j++] = 255;\r\n    i++;\r\n\r\n    palette[j++] = 255;\r\n    palette[j++] = 0;\r\n    palette[j++] = 0;\r\n    palette[j++] = 255;\r\n    i++;\r\n\r\n    palette[j++] = 255;\r\n    palette[j++] = 0;\r\n    palette[j++] = 255;\r\n    palette[j++] = 255;\r\n    i++;\r\n\r\n    palette[j++] = 64;\r\n    palette[j++] = 200;\r\n    palette[j++] = 255;\r\n    palette[j++] = 255;\r\n    i++;\r\n\r\n    for (; i < 256; i++, j += 4) {\r\n      palette[j + 0] = Math.floor(Math.random() * 255);\r\n      palette[j + 1] = Math.floor(Math.random() * 255);\r\n      palette[j + 2] = Math.floor(Math.random() * 255);\r\n      palette[j + 3] = 255;\r\n    }\r\n\r\n    // convert 96-classes output image into colors image\r\n    this.pixels = new Uint8ClampedArray(this.wSrc * this.hSrc * 4);\r\n    const pixels = this.pixels;\r\n\r\n    const w = this.wSrc;\r\n    const h = this.hSrc;\r\n\r\n    i = 0; j = 0;\r\n    for (let y = 0; y < h; y++) {\r\n      for (let x = 0; x < w; x++) {\r\n        const ind = pixelsUpScale[i];\r\n        pixels[j + 0] = palette[ind * 4 + 0];\r\n        pixels[j + 1] = palette[ind * 4 + 1];\r\n        pixels[j + 2] = palette[ind * 4 + 2];\r\n        pixels[j + 3] = 255;\r\n\r\n        i++; j += 4;\r\n      }\r\n    }\r\n\r\n    this.stage = STAGE_SEGMENTATION_READY;\r\n    console.log(\"Segm complete now \");\r\n\r\n    this.objGraphics2d.forceRender();\r\n  }\r\n\r\n  getStageString() {\r\n    const msgArr = [\r\n      'Wait. Model is not loaded', // const STAGE_MODEL_NOT_LOADED = 0;\r\n      'Wait. Model is loading ...',  // const STAGE_MODEL_IS_LOADING = 1;\r\n      'Model is ready', // const STAGE_MODEL_READY = 2;\r\n      'Image is processed ...',  // const STAGE_IMAGE_PROCESSED = 3;\r\n      'Segmentation is ready', // const STAGE_SEGMENTATION_READY = 4;\r\n    ];\r\n    const strMessage = msgArr[this.stage];\r\n    return strMessage;\r\n  }\r\n\r\n  setImageData(imgData) {\r\n    this.srcImageData = imgData;\r\n  }\r\n\r\n  render(ctx, w, h, imgData) {\r\n    this.srcImageData = imgData;\r\n    this.wSrc = w;\r\n    this.hSrc = h;\r\n\r\n    // debug\r\n    console.log('Segm2d render. VGG model ' + ((this.model === null) ? 'not loaded' : 'loaded') );\r\n    const strMessage = this.getStageString();\r\n    console.log('Segm2d render. stage = ' + strMessage );\r\n\r\n    /*\r\n    // load model\r\n    if (this.model === null) {\r\n      this.onLoadModel();\r\n    } else {\r\n      // change slider or similar: need to rebuild segm for the new source image\r\n      if (this.stage === STAGE_MODEL_READY) {\r\n        this.startApplyImage();\r\n        return;\r\n      }\r\n    } // if model non null\r\n    */\r\n    \r\n    if ((this.stage === STAGE_SEGMENTATION_READY) && (this.pixels !== null)) {\r\n      // draw pixels array on screen\r\n      this.imgData = ctx.createImageData(w, h);\r\n      const pixDst = this.imgData.data;\r\n      // this.imgData.data = this.pixels;\r\n      const numBytes = w * h * 4;\r\n      for (let i = 0; i < numBytes; i++) {\r\n        pixDst[i] = this.pixels[i];\r\n      }\r\n      ctx.putImageData(this.imgData, 0, 0);\r\n      return;\r\n    }\r\n\r\n\r\n\r\n    // clear screen\r\n    ctx.fillStyle = 'rgb(64, 64, 64)';\r\n    ctx.fillRect(0,0, w, h);\r\n    // draw cross\r\n    ctx.strokeStyle = '#FF0000';\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(0, 0);\r\n    ctx.lineTo(w - 1, h - 1);\r\n    ctx.stroke();\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(w - 1 , 0);\r\n    ctx.lineTo(0, h - 1);\r\n    ctx.stroke();\r\n    // draw wait message\r\n    const strMsgPrint = this.getStageString();\r\n    ctx.font = '24px serif';\r\n    ctx.fillStyle = 'rgb(64, 255, 64)';\r\n    ctx.fillText(strMsgPrint, w / 2, h / 2);\r\n  }\r\n}\r\n\r\nexport default Segm2d;\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n'License'); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n/**\r\n* Nifti file loader\r\n* @module lib/scripts/loaders/roipalette\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// ******************************************************************\r\n// Class\r\n// ******************************************************************\r\n\r\nexport default class RoiPalette {\r\n  /**\r\n  * Create loader\r\n  */\r\n  constructor() {\r\n    this.m_palette = [\r\n      {\r\n        'name': 'amygdala',\r\n        'roiColor': '0.247059 0.584314 0.270588 1',\r\n        'roiId': 139,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'amygdala',\r\n        'roiColor': '0.309804 0.929412 0.054902 1',\r\n        'roiId': 118,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'angular gyrus',\r\n        'roiColor': '0.686275 0.231373 0.152941 1',\r\n        'roiId': 19,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'angular gyrus',\r\n        'roiColor': '0.811765 0.486275 0.117647 1',\r\n        'roiId': 159,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'anterior limb of internal capsule',\r\n        'roiColor': '0.309804 0.203922 0.462745 1',\r\n        'roiId': 128,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'anterior limb of internal capsule',\r\n        'roiColor': '0.435294 0.733333 0.027451 1',\r\n        'roiId': 43,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'roiColor': '0.937255 0.94902 0.513725 1',\r\n        'roiId': 20,\r\n        'name': 'brain stem',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'caudate nucleus',\r\n        'roiColor': '0.74902 0.278431 0.141176 1',\r\n        'roiId': 53,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'caudate nucleus',\r\n        'roiColor': '0.184314 0.0745098 0.356863 1',\r\n        'roiId': 39,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'cerebellum',\r\n        'roiColor': '0.811765 0.458824 0.952941 1',\r\n        'roiId': 76,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'cerebellum',\r\n        'roiColor': '0.247059 0.113725 0.843137 1',\r\n        'roiId': 67,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'cingulate region',\r\n        'roiColor': '0.623529 0.45098 0.666667 1',\r\n        'roiId': 7,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'cingulate region',\r\n        'roiColor': '0.937255 0.631373 0.505882 1',\r\n        'roiId': 27,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'roiColor': '0.937255 0.301961 0.470588 1',\r\n        'roiId': 133,\r\n        'name': 'corpus callosum',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'cuneus',\r\n        'roiColor': '0.435294 0.513725 0.768627 1',\r\n        'roiId': 175,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'cuneus',\r\n        'roiColor': '0.937255 0.729412 0.192157 1',\r\n        'roiId': 54,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'fornix',\r\n        'roiColor': '0.937255 0.415686 0.847059 1',\r\n        'roiId': 254,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'fornix',\r\n        'roiColor': '0.811765 0.67451 0.980392 1',\r\n        'roiId': 29,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'roiColor': '0.247059 0.466667 0.105882 1',\r\n        'roiId': 233,\r\n        'name': 'fourth ventricle',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'frontal lobe WM',\r\n        'roiColor': '0.560784 0.290196 0.215686 1',\r\n        'roiId': 17,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'frontal lobe WM',\r\n        'roiColor': '0.498039 0.662745 0.101961 1',\r\n        'roiId': 30,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'globus palladus',\r\n        'roiColor': '0.0588235 0.843137 0.168627 1',\r\n        'roiId': 11,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'globus palladus',\r\n        'roiColor': '0.247059 0.74902 0.447059 1',\r\n        'roiId': 12,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'hippocampal formation',\r\n        'roiColor': '0.498039 0.709804 0.619608 1',\r\n        'roiId': 36,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'hippocampal formation',\r\n        'roiColor': '0.121569 0.4 0.972549 1',\r\n        'roiId': 101,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'inferior frontal gyrus',\r\n        'roiColor': '0.247059 0.85098 0.0666667 1',\r\n        'roiId': 75,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'inferior frontal gyrus',\r\n        'roiColor': '0.937255 0.662745 0.329412 1',\r\n        'roiId': 15,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'inferior occipital gyrus',\r\n        'roiColor': '0.0588235 0.643137 0.643137 1',\r\n        'roiId': 97,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'inferior occipital gyrus',\r\n        'roiColor': '0.247059 0.411765 0.568627 1',\r\n        'roiId': 37,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'inferior temporal gyrus',\r\n        'roiColor': '0.247059 0.00392157 0.796078 1',\r\n        'roiId': 140,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'inferior temporal gyrus',\r\n        'roiColor': '0.87451 0.819608 0.541176 1',\r\n        'roiId': 164,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'insula',\r\n        'roiColor': '0.623529 0.886275 0.356863 1',\r\n        'roiId': 4,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'insula',\r\n        'roiColor': '0.560784 0.698039 0.12549 1',\r\n        'roiId': 108,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'lateral front-orbital gyrus',\r\n        'roiColor': '0.435294 0.501961 0.203922 1',\r\n        'roiId': 6,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'lateral front-orbital gyrus',\r\n        'roiColor': '1 0.8 0.00784314 1',\r\n        'roiId': 90,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'lateral occipitotemporal gyrus',\r\n        'roiColor': '0.0588235 0.027451 0.470588 1',\r\n        'roiId': 99,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'lateral occipitotemporal gyrus',\r\n        'roiColor': '0.937255 0.101961 0.913725 1',\r\n        'roiId': 196,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'lateral ventricle',\r\n        'roiColor': '0.435294 0.176471 0.568627 1',\r\n        'roiId': 8,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'lateral ventricle',\r\n        'roiColor': '0.74902 0.764706 0.247059 1',\r\n        'roiId': 3,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'lingual gyrus',\r\n        'roiColor': '0.435294 0.458824 0.47451 1',\r\n        'roiId': 112,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'lingual gyrus',\r\n        'roiColor': '0.811765 0.0941176 0.301961 1',\r\n        'roiId': 69,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'medial front-orbital gyrus',\r\n        'roiColor': '0.87451 0.364706 0.384314 1',\r\n        'roiId': 1,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'medial front-orbital gyrus',\r\n        'roiColor': '0.811765 0.160784 0.247059 1',\r\n        'roiId': 85,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'medial frontal gyrus',\r\n        'roiColor': '0.435294 0.615686 0.0705882 1',\r\n        'roiId': 114,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'medial frontal gyrus',\r\n        'roiColor': '0.184314 0.372549 0.423529 1',\r\n        'roiId': 9,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'medial occipitotemporal gyrus',\r\n        'roiColor': '0.247059 0.368627 0.211765 1',\r\n        'roiId': 165,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'medial occipitotemporal gyrus',\r\n        'roiColor': '1 0.843137 0.254902 1',\r\n        'roiId': 119,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'middle frontal gyrus',\r\n        'roiColor': '0.623529 0.905882 0.113725 1',\r\n        'roiId': 2,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'middle frontal gyrus',\r\n        'roiColor': '0.686275 0.0901961 0.811765 1',\r\n        'roiId': 50,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'middle occipital gyrus',\r\n        'roiColor': '0.686275 0.933333 0.698039 1',\r\n        'roiId': 63,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'middle occipital gyrus',\r\n        'roiColor': '0.435294 0.0588235 0.964706 1',\r\n        'roiId': 154,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'middle temporal gyrus',\r\n        'roiColor': '0.937255 0.498039 0.67451 1',\r\n        'roiId': 130,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'middle temporal gyrus',\r\n        'roiColor': '0.498039 0.768627 0.439216 1',\r\n        'roiId': 64,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'nucleus accumbens',\r\n        'roiColor': '1 0.807843 0.529412 1',\r\n        'roiId': 25,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'nucleus accumbens',\r\n        'roiColor': '0.0588235 0.65098 0.0509804 1',\r\n        'roiId': 72,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'occipital lobe WM',\r\n        'roiColor': '0.0588235 0.368627 0.552941 1',\r\n        'roiId': 45,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'occipital lobe WM',\r\n        'roiColor': '0.0588235 0.639216 0.839216 1',\r\n        'roiId': 73,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'occipital pole',\r\n        'roiColor': '0.74902 0.494118 0.419608 1',\r\n        'roiId': 132,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'occipital pole',\r\n        'roiColor': '0.247059 0.807843 0.74902 1',\r\n        'roiId': 251,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'parahippocampal gyrus',\r\n        'roiColor': '0.121569 0.847059 0.00392157 1',\r\n        'roiId': 125,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'parahippocampal gyrus',\r\n        'roiColor': '0.247059 0.0705882 0.321569 1',\r\n        'roiId': 18,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'parietal lobe WM',\r\n        'roiColor': '1 0.4 0.223529 1',\r\n        'roiId': 105,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'parietal lobe WM',\r\n        'roiColor': '0.309804 0.678431 0.639216 1',\r\n        'roiId': 57,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'postcentral gyrus',\r\n        'roiColor': '0.560784 0.478431 0.2 1',\r\n        'roiId': 110,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'postcentral gyrus',\r\n        'roiColor': '0.498039 0.576471 0.027451 1',\r\n        'roiId': 74,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'posterior limb of internal capsule inc. cerebral peduncle',\r\n        'roiColor': '1 0.917647 0.576471 1',\r\n        'roiId': 35,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'posterior limb of internal capsule inc. cerebral peduncle',\r\n        'roiColor': '0.435294 0.490196 0.0784314 1',\r\n        'roiId': 34,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'precentral gyrus',\r\n        'roiColor': '0.184314 0.709804 0.615686 1',\r\n        'roiId': 5,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'precentral gyrus',\r\n        'roiColor': '0.87451 0.560784 1 1',\r\n        'roiId': 80,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'precuneus',\r\n        'roiColor': '1 0.654902 0.223529 1',\r\n        'roiId': 32,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'precuneus',\r\n        'roiColor': '1 0 0.211765 1',\r\n        'roiId': 56,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'putamen',\r\n        'roiColor': '1 0.831373 0.227451 1',\r\n        'roiId': 16,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'putamen',\r\n        'roiColor': '0.372549 0.678431 0.32549 1',\r\n        'roiId': 14,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'subthalamic nucleus',\r\n        'roiColor': '0.184314 0.545098 0.619608 1',\r\n        'roiId': 23,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'subthalamic nucleus',\r\n        'roiColor': '0.309804 0.686275 0.243137 1',\r\n        'roiId': 33,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'superior frontal gyrus',\r\n        'roiColor': '0.87451 0.380392 0.768627 1',\r\n        'roiId': 10,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'superior frontal gyrus',\r\n        'roiColor': '1 0.113725 0.396078 1',\r\n        'roiId': 70,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'superior occipital gyrus',\r\n        'roiColor': '0.372549 0.0431373 0.537255 1',\r\n        'roiId': 38,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'superior occipital gyrus',\r\n        'roiColor': '0.623529 0.301961 0.2 1',\r\n        'roiId': 98,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'superior parietal lobule',\r\n        'roiColor': '0.247059 0.843137 0.407843 1',\r\n        'roiId': 88,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'superior parietal lobule',\r\n        'roiColor': '0.87451 0.533333 0.254902 1',\r\n        'roiId': 52,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'superior temporal gyrus',\r\n        'roiColor': '0.498039 0.721569 0.996078 1',\r\n        'roiId': 145,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'superior temporal gyrus',\r\n        'roiColor': '1 0.67451 0.45098 1',\r\n        'roiId': 61,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'supramarginal gyrus',\r\n        'roiColor': '0.87451 0.45098 0.270588 1',\r\n        'roiId': 60,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'supramarginal gyrus',\r\n        'roiColor': '0.623529 0.0235294 0.654902 1',\r\n        'roiId': 41,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'temporal lobe WM',\r\n        'roiColor': '0.498039 0.603922 0.768627 1',\r\n        'roiId': 59,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'temporal lobe WM',\r\n        'roiColor': '0.87451 0.411765 0.368627 1',\r\n        'roiId': 83,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'thalamus',\r\n        'roiColor': '0.0588235 0.796078 0.866667 1',\r\n        'roiId': 203,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'thalamus',\r\n        'roiColor': '0.74902 0.984314 0.341176 1',\r\n        'roiId': 102,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'roiColor': '0.811765 0.258824 0.823529 1',\r\n        'roiId': 232,\r\n        'name': 'third ventricle',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'uncus',\r\n        'roiColor': '0.121569 0.352941 0.196078 1',\r\n        'roiId': 26,\r\n        'position': 'right',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'uncus',\r\n        'roiColor': '0.623529 0.117647 0.14902 1',\r\n        'roiId': 62,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'xxx_brain_internal',\r\n        'roiColor': '0.8 0.8 0.1 1',\r\n        'roiId': 150,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n      {\r\n        'name': 'xxx_brain_core',\r\n        'roiColor': '0.2 0.8 0.2 1',\r\n        'roiId': 250,\r\n        'position': 'left',\r\n        'isBrain': true,\r\n      },\r\n    ];\r\n    this.createBytePalette256();\r\n  }\r\n\r\n  /**\r\n  * Transform array of objects into uint32 color array with 256 entries\r\n  */\r\n  createBytePalette256() {\r\n    const PAL_SIZE = 256;\r\n    const MAX_PAL_COLOR = 255.0;\r\n    const BYTES_PER_COLOR = 4;\r\n    const OFFS_0 = 0;\r\n    const OFFS_1 = 1;\r\n    const OFFS_2 = 2;\r\n    const OFFS_3 = 3;\r\n    this.m_palette256 = new Uint8Array(PAL_SIZE * BYTES_PER_COLOR);\r\n    let i;\r\n    // init palette with black colors\r\n    for (i = 0; i < PAL_SIZE * BYTES_PER_COLOR; i++) {\r\n      this.m_palette256[i] = 0;\r\n    }\r\n    // load colors\r\n    const numPalColors = this.m_palette.length;\r\n    for (i = 0; i < numPalColors; i++) {\r\n      const strIndexPalette = this.m_palette[i].roiId;\r\n      const strColor = this.m_palette[i].roiColor;\r\n      const arrColor = strColor.split(' ');\r\n      const rCol = Math.floor(parseFloat(arrColor[OFFS_0]) * MAX_PAL_COLOR);\r\n      const gCol = Math.floor(parseFloat(arrColor[OFFS_1]) * MAX_PAL_COLOR);\r\n      const bCol = Math.floor(parseFloat(arrColor[OFFS_2]) * MAX_PAL_COLOR);\r\n      const aCol = 255;\r\n      const ind = parseInt(strIndexPalette, 10) * BYTES_PER_COLOR;\r\n      this.m_palette256[ind + OFFS_0] = rCol;\r\n      this.m_palette256[ind + OFFS_1] = gCol;\r\n      this.m_palette256[ind + OFFS_2] = bCol;\r\n      this.m_palette256[ind + OFFS_3] = aCol;\r\n    }\r\n  }\r\n\r\n  /**\r\n  * Return palette array of objects\r\n  */\r\n  getPalette() {\r\n    return this.m_palette;\r\n  }\r\n\r\n  /**\r\n  * Return array of uints8 with 256 entries * 4\r\n  */\r\n  getPalette256() {\r\n    return this.m_palette256;\r\n  }\r\n}\r\n","/**\r\n * @fileOverview Graphics2d\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport Modes2d from '../store/Modes2d';\r\nimport StoreActionType from '../store/ActionTypes';\r\nimport ToolPick from './tools2d/ToolPick';\r\nimport ToolZoom from './tools2d/ToolZoom';\r\nimport ToolDistance from './tools2d/ToolDistance';\r\nimport ToolClear from './tools2d/ToolClear';\r\nimport ToolAngle from './tools2d/ToolAngle';\r\nimport ToolArea from './tools2d/ToolArea';\r\nimport ToolRect from './tools2d/ToolRect';\r\nimport ToolText from './tools2d/ToolText';\r\nimport ToolEdit from './tools2d/ToolEdit';\r\nimport ToolDelete from './tools2d/ToolDelete';\r\n\r\nimport Tools2dType from './tools2d/ToolTypes';\r\nimport Segm2d  from './Segm2d';\r\n\r\nimport RoiPalette from './loaders/roipalette';\r\n\r\n// import { timingSafeEqual } from 'crypto';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class Graphics2d some text later...\r\n */\r\nclass Graphics2d extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.onMouseDown = this.onMouseDown.bind(this);\r\n    this.onMouseUp = this.onMouseUp.bind(this);\r\n    this.onMouseMove = this.onMouseMove.bind(this);\r\n    this.onMouseWheel = this.onMouseWheel.bind(this);\r\n\r\n    this.m_sliceRatio = 0.5;\r\n    this.m_mode2d = Modes2d.TRANSVERSE;\r\n\r\n    // scale\r\n    this.m_zoom = 1;\r\n    this.m_xPos = 0;\r\n    this.m_yPos = 0;\r\n    \r\n    // mounted\r\n    this.m_isMounted = false;\r\n\r\n    // animation\r\n    // this.animate = this.animate.bind(this);\r\n    // this.m_frameId = null;\r\n\r\n    // actual render window dimenison\r\n    this.state = {\r\n      wRender: 0,\r\n      hRender: 0,\r\n      stateMouseDown: false,\r\n      xMouse: -1,\r\n      yMouse: -1,\r\n    };\r\n    // segm 2d\r\n    this.segm2d = new Segm2d(this);\r\n    this.m_isSegmented = false;\r\n\r\n    // tools2d\r\n    this.m_toolPick = new ToolPick(this);\r\n    this.m_toolDistance = new ToolDistance(this);\r\n    this.m_toolZoom = new ToolZoom(this);\r\n    this.m_toolClear = new ToolClear(this);\r\n    this.m_toolAngle = new ToolAngle(this);\r\n    this.m_toolArea = new ToolArea(this);\r\n    this.m_toolRect = new ToolRect(this);\r\n    this.m_toolText = new ToolText(this);\r\n    this.m_toolEdit = new ToolEdit(this);\r\n    this.m_toolDelete = new ToolDelete(this);\r\n\r\n    // roi\r\n    this.m_roiPalette = new RoiPalette();\r\n\r\n    // store\r\n    const store = props;\r\n    store.dispatch({ type: StoreActionType.SET_GRAPHICS_2D, graphics2d: this });\r\n\r\n  }\r\n\r\n  /*\r\n  start() {\r\n    if (this.m_frameId === null) {\r\n      this.m_frameId = requestAnimationFrame(this.animate);\r\n    }\r\n  }\r\n  stop() {\r\n    cancelAnimationFrame(this.m_frameId);\r\n    this.m_frameId = null;\r\n  }\r\n  animate() {\r\n    // this.renderScene();\r\n    // this.m_frameId = window.requestAnimationFrame(this.animate);\r\n  }\r\n  */\r\n  componentDidMount() {\r\n    this.m_isMounted = true;\r\n    // this.start();\r\n    // this.renderScene();\r\n\r\n    this.prepareImageForRender();\r\n    this.renderReadyImage();\r\n\r\n\r\n    // detect actual render window dims\r\n    const w = this.m_mount.clientWidth;\r\n    const h = this.m_mount.clientHeight;\r\n    if (this.state.wRender === 0) {\r\n      this.setState({ wRender: w });\r\n      this.setState({ hRender: h });\r\n    }\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    this.m_isMounted = false;\r\n  }\r\n\r\n  componentDidUpdate() {\r\n    // this.prepareImageForRender();\r\n    if (this.m_isMounted) {\r\n      this.renderReadyImage();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get screenshot\r\n   * \r\n   * @param {nuimber} wShot - x size of screenshot\r\n   * @param {nuimber} hShot - y size of screenshot\r\n   */\r\n  screenshot(wShot, hShot) {\r\n    console.log(`get screenshot from 2d canvas: ${wShot}*${hShot}`);\r\n    const objCanvas = this.m_mount;\r\n    //const ctx = objCanvas.getContext('2d');\r\n    //const imageData = ctx.getImageData(0, 0, wShot, hShot);\r\n    //console.log(`image data: ${imageData}`);\r\n    const dataUrl = objCanvas.toDataURL();\r\n    return dataUrl;\r\n  }\r\n\r\n  /**\r\n   * Render text info about volume\r\n   * \r\n   * @param {object} ctx - render context\r\n   * @param {VolumeSet} volSet - volume set to rener\r\n   */\r\n  renderTextInfo(ctx, volSet, vol) {\r\n    let strMsg;\r\n    let xText = 4;\r\n    let yText = 4;\r\n    const FONT_SZ = 16;\r\n    ctx.font = FONT_SZ.toString() + 'px Arial';\r\n    ctx.textAlign = 'left';\r\n    ctx.textBaseline = 'top';\r\n    ctx.fillStyle = 'grey';\r\n\r\n    strMsg = 'volume dim = ' + vol.m_xDim.toString() + ' * ' + \r\n      vol.m_yDim.toString() + ' * ' + \r\n      vol.m_zDim.toString();\r\n    ctx.fillText(strMsg, xText, yText);\r\n    yText += FONT_SZ;\r\n\r\n    const xSize = Math.floor(vol.m_boxSize.x);\r\n    const ySize = Math.floor(vol.m_boxSize.y);\r\n    const zSize = Math.floor(vol.m_boxSize.z);\r\n    strMsg = 'vol phys size = ' + xSize.toString() + ' * ' + \r\n      ySize.toString() + ' * ' + \r\n      zSize.toString();\r\n    ctx.fillText(strMsg, xText, yText);\r\n    yText += FONT_SZ;\r\n\r\n    const patName = volSet.m_patientName;\r\n    if (patName.length > 1) {\r\n      strMsg = 'patient name = ' + patName; \r\n      ctx.fillText(strMsg, xText, yText);\r\n      yText += FONT_SZ;\r\n    }\r\n    const patBirth = volSet.m_patientBirth;\r\n    if (patBirth.length > 1) {\r\n      strMsg = 'patient birth = ' + patBirth;\r\n      ctx.fillText(strMsg, xText, yText);\r\n      yText += FONT_SZ;\r\n    }\r\n    const seriesDescr = volSet.m_seriesDescr;\r\n    if (seriesDescr.length > 1) {\r\n      strMsg = 'series descr = ' + seriesDescr;\r\n      ctx.fillText(strMsg, xText, yText);\r\n      yText += FONT_SZ;\r\n    }\r\n    const institutionName = volSet.m_institutionName;\r\n    if (institutionName.length > 1) {\r\n      strMsg = 'institution name = ' + institutionName;\r\n      ctx.fillText(strMsg, xText, yText);\r\n      yText += FONT_SZ;\r\n    }\r\n    const operatorsName = volSet.m_operatorsName;\r\n    if (operatorsName.length > 1) {\r\n      strMsg = 'operators name = ' + operatorsName;\r\n      ctx.fillText(strMsg, xText, yText);\r\n      yText += FONT_SZ;\r\n    }\r\n    const physicansName = volSet.m_physicansName;\r\n    if (physicansName.length > 1) {\r\n      strMsg = 'physicans name = ' + physicansName;\r\n      ctx.fillText(strMsg, xText, yText);\r\n      yText += FONT_SZ;\r\n    }\r\n      \r\n  }\r\n\r\n  prepareImageForRender(volIndexArg) {\r\n    // console.log('prepareImageForRender ...');\r\n    const objCanvas = this.m_mount;\r\n    if (objCanvas === null) {\r\n      return;\r\n    }\r\n    const ctx = objCanvas.getContext('2d');\r\n    const w = objCanvas.clientWidth;\r\n    const h = objCanvas.clientHeight;\r\n    if (w * h === 0) {\r\n      return;\r\n    }\r\n\r\n    const store = this.props;\r\n\r\n    ctx.fillStyle = 'rgb(64, 64, 64)';\r\n    ctx.fillRect(0,0, w, h);\r\n    // console.log(`render scene 2d. screen = ${w} * ${h}`);\r\n\r\n    // Test draw chessboard\r\n    const NEED_TEST_RAINBOW = false;\r\n    if (NEED_TEST_RAINBOW) {\r\n      const wImg = 800;\r\n      const hImg = 600;\r\n      const imgData = ctx.createImageData(wImg, hImg);\r\n      const dataDst = imgData.data;\r\n      let j = 0;\r\n      for (let y = 0; y < hImg; y++) {\r\n        for (let x = 0; x < wImg; x++) {\r\n          dataDst[j + 0] = Math.floor(255 * x / wImg);\r\n          dataDst[j + 1] = Math.floor(255 * y / hImg);\r\n          dataDst[j + 2] = 120;\r\n          dataDst[j + 3] = 255;\r\n          j += 4;\r\n        } // for (x)\r\n      } // for (y)\r\n      ctx.putImageData(imgData, 0, 0); \r\n    }\r\n\r\n    const volSet = store.volumeSet;\r\n    // const volIndex = this.m_volumeIndex;\r\n    const volIndex = (volIndexArg !== undefined) ? volIndexArg : store.volumeIndex;\r\n\r\n    const vol = volSet.getVolume(volIndex);\r\n    const mode2d = this.m_mode2d;\r\n    const sliceRatio = store.slider2d;\r\n\r\n    if (vol !== null) {\r\n      if (vol.m_dataArray === null) {\r\n        console.log('Graphics2d. Volume has no data array');\r\n        return;\r\n      }\r\n      const xDim = vol.m_xDim;\r\n      const yDim = vol.m_yDim;\r\n      const zDim = vol.m_zDim;\r\n      const xyDim = xDim * yDim;\r\n      const dataSrc = vol.m_dataArray; // 1 or 4 bytes array of pixels\r\n      if (dataSrc.length !== xDim * yDim * zDim * vol.m_bytesPerVoxel) {\r\n        console.log(`Bad src data len = ${dataSrc.length}, but expect ${xDim}*${yDim}*${zDim}`);\r\n      }\r\n\r\n      // console.log(`Graphics2d. prepareImageForRender. mode= ${mode2d}`);\r\n\r\n      const ONE = 1;\r\n      const FOUR = 4;\r\n      const OFF_3 = 3;\r\n\r\n      let imgData = null;\r\n      let dataDst = null;\r\n\r\n      const roiPal256 = this.m_roiPalette.getPalette256();\r\n\r\n      // determine actual render square (not w * h - viewport)\r\n      // calculate area using physical volume dimension\r\n      const TOO_SMALL = 1.0e-5;\r\n      const pbox = vol.m_boxSize;\r\n      if (pbox.x * pbox.y * pbox.z < TOO_SMALL) {\r\n        console.log(`Bad physical dimensions for rendered volume = ${pbox.x}*${pbox.y}*${pbox.z} `);\r\n      }\r\n      let wScreen = 0, hScreen = 0;\r\n\r\n      const xPos = store.render2dxPos;\r\n      const yPos = store.render2dyPos;\r\n      const zoom = store.render2dZoom;\r\n      // console.log(`Gra2d. RenderScene. zoom=${zoom}, xyPos=${xPos}, ${yPos}`);\r\n      if (mode2d === Modes2d.TRANSVERSE) {\r\n        // calc screen rect based on physics volume slice size (z slice)\r\n        const xyRratio = pbox.x / pbox.y;\r\n        wScreen = w;\r\n        hScreen = Math.floor(w / xyRratio);\r\n        if (hScreen > h) {\r\n          hScreen = h;\r\n          wScreen = Math.floor(h * xyRratio);\r\n          if (wScreen > w) {\r\n            console.log(`logic error! wScreen * hScreen = ${wScreen} * ${hScreen}`);\r\n          }\r\n        }\r\n        hScreen = (hScreen > 0) ? hScreen : 1;\r\n        // console.log(`gra2d. render: wScreen*hScreen = ${wScreen} * ${hScreen}, but w*h=${w}*${h} `);\r\n\r\n        this.m_toolPick.setScreenDim(wScreen, hScreen);\r\n        this.m_toolZoom.setScreenDim(wScreen, hScreen);\r\n        this.m_toolDistance.setScreenDim(wScreen, hScreen);\r\n        this.m_toolAngle.setScreenDim(wScreen, hScreen);\r\n        this.m_toolArea.setScreenDim(wScreen, hScreen);\r\n        this.m_toolRect.setScreenDim(wScreen, hScreen);\r\n        this.m_toolText.setScreenDim(wScreen, hScreen);\r\n        this.m_toolEdit.setScreenDim(wScreen, hScreen);\r\n        this.m_toolDelete.setScreenDim(wScreen, hScreen);\r\n\r\n        // setup pixel size for 2d tools\r\n        const xPixelSize = vol.m_boxSize.x / xDim;\r\n        const yPixelSize = vol.m_boxSize.y / yDim;\r\n        // console.log(`xyPixelSize = ${xPixelSize} * ${yPixelSize}`);\r\n        this.m_toolDistance.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolAngle.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolArea.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolRect.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolText.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolEdit.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolDelete.setPixelSize(xPixelSize, yPixelSize);\r\n\r\n        // create image data\r\n        imgData = ctx.createImageData(wScreen, hScreen);\r\n        dataDst = imgData.data;\r\n        if (dataDst.length !== wScreen * hScreen * 4) {\r\n          console.log(`Bad dst data len = ${dataDst.length}, but expect ${wScreen}*${hScreen}*4`);\r\n        }\r\n  \r\n        // z slice\r\n        let zSlice = Math.floor(zDim * sliceRatio);\r\n        zSlice = (zSlice < zDim) ? zSlice : (zDim - 1);\r\n        const zOff = zSlice * xyDim;\r\n        const xStep = zoom * xDim / wScreen;\r\n        const yStep = zoom * yDim / hScreen;\r\n        let j = 0;\r\n        let ay = yPos * yDim;\r\n        if (vol.m_bytesPerVoxel === ONE) {\r\n          for (let y = 0; y < hScreen; y++, ay += yStep) {\r\n            const ySrc = Math.floor(ay);\r\n            const yOff = ySrc * xDim;\r\n            let ax = xPos * xDim;\r\n            for (let x = 0; x < wScreen; x++, ax += xStep) {\r\n              const xSrc = Math.floor(ax);\r\n              const val = dataSrc[zOff + yOff + xSrc];\r\n              dataDst[j + 0] = val;\r\n              dataDst[j + 1] = val;\r\n              dataDst[j + 2] = val;\r\n              dataDst[j + 3] = 255; // opacity\r\n              j += 4;\r\n            } // for (x)\r\n          } // for (y)\r\n\r\n        } else if (vol.m_bytesPerVoxel === FOUR) {\r\n          for (let y = 0; y < hScreen; y++, ay += yStep) {\r\n            const ySrc = Math.floor(ay);\r\n            const yOff = ySrc * xDim;\r\n            let ax = xPos * xDim;\r\n            for (let x = 0; x < wScreen; x++, ax += xStep) {\r\n              const xSrc = Math.floor(ax);\r\n              const val = dataSrc[(zOff + yOff + xSrc) * FOUR + OFF_3];\r\n              const val4 = val * FOUR;\r\n              const rCol = roiPal256[val4 + 0];\r\n              const gCol = roiPal256[val4 + 1];\r\n              const bCol = roiPal256[val4 + 2];\r\n  \r\n              dataDst[j + 0] = bCol;\r\n              dataDst[j + 1] = gCol;\r\n              dataDst[j + 2] = rCol;\r\n              dataDst[j + 3] = 255;\r\n              j += 4;\r\n            } // for (x)\r\n          } // for (y)\r\n\r\n        } // if 4 bpp\r\n\r\n      } else if (mode2d === Modes2d.SAGGITAL) {\r\n        // calc screen rect based on physics volume slice size (x slice)\r\n        const yzRatio = pbox.y / pbox.z;\r\n        wScreen = w;\r\n        hScreen = Math.floor(w / yzRatio);\r\n        if (hScreen > h) {\r\n          hScreen = h;\r\n          wScreen = Math.floor(h * yzRatio);\r\n          if (wScreen > w) {\r\n            console.log(`logic error! wScreen * hScreen = ${wScreen} * ${hScreen}`);\r\n          }\r\n        }\r\n        hScreen = (hScreen > 0) ? hScreen : 1;\r\n        // console.log(`gra2d. render: wScreen*hScreen = ${wScreen} * ${hScreen}, but w*h=${w}*${h} `);\r\n\r\n        this.m_toolPick.setScreenDim(wScreen, hScreen);\r\n        this.m_toolZoom.setScreenDim(wScreen, hScreen);\r\n        this.m_toolDistance.setScreenDim(wScreen, hScreen);\r\n        this.m_toolAngle.setScreenDim(wScreen, hScreen);\r\n        this.m_toolArea.setScreenDim(wScreen, hScreen);\r\n        this.m_toolRect.setScreenDim(wScreen, hScreen);\r\n        this.m_toolText.setScreenDim(wScreen, hScreen);\r\n        this.m_toolEdit.setScreenDim(wScreen, hScreen);\r\n        this.m_toolDelete.setScreenDim(wScreen, hScreen);\r\n\r\n        // setup pixel size for 2d tools\r\n        const xPixelSize = vol.m_boxSize.y / yDim;\r\n        const yPixelSize = vol.m_boxSize.z / zDim;\r\n        // console.log(`xyPixelSize = ${xPixelSize} * ${yPixelSize}`);\r\n        this.m_toolDistance.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolAngle.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolArea.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolRect.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolText.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolEdit.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolDelete.setPixelSize(xPixelSize, yPixelSize);\r\n\r\n        // create image data\r\n        imgData = ctx.createImageData(wScreen, hScreen);\r\n        dataDst = imgData.data;\r\n        if (dataDst.length !== wScreen * hScreen * 4) {\r\n          console.log(`Bad dst data len = ${dataDst.length}, but expect ${wScreen}*${hScreen}*4`);\r\n        }\r\n\r\n        // x slice\r\n        let xSlice = Math.floor(xDim * sliceRatio);\r\n        xSlice = (xSlice < xDim) ? xSlice : (xDim - 1);\r\n\r\n        const yStep = zoom * yDim / wScreen;\r\n        const zStep = zoom * zDim / hScreen;\r\n        let j = 0;\r\n        let az = yPos * zDim;\r\n        if (vol.m_bytesPerVoxel === ONE) {\r\n          for (let y = 0; y < hScreen; y++, az += zStep) {\r\n            const zSrc = Math.floor(az);\r\n            const zOff = zSrc * xDim * yDim;\r\n            let ay = xPos * yDim;\r\n            for (let x = 0; x < wScreen; x++, ay += yStep) {\r\n              const ySrc = Math.floor(ay);\r\n              const yOff = ySrc * xDim;\r\n              const val = dataSrc[zOff + yOff + xSlice];\r\n\r\n              dataDst[j + 0] = val;\r\n              dataDst[j + 1] = val;\r\n              dataDst[j + 2] = val;\r\n              dataDst[j + 3] = 255; // opacity\r\n\r\n              j += 4;\r\n            } // for (x)\r\n          } // for (y)\r\n        } else if (vol.m_bytesPerVoxel === FOUR) {\r\n          for (let y = 0; y < hScreen; y++, az += zStep) {\r\n            const zSrc = Math.floor(az);\r\n            const zOff = zSrc * xDim * yDim;\r\n            let ay = xPos * yDim;\r\n            for (let x = 0; x < wScreen; x++, ay += yStep) {\r\n              const ySrc = Math.floor(ay);\r\n              const yOff = ySrc * xDim;\r\n              const val = dataSrc[(zOff + yOff + xSlice) * FOUR + OFF_3];\r\n              const val4 = val * FOUR;\r\n              const rCol = roiPal256[val4 + 0];\r\n              const gCol = roiPal256[val4 + 1];\r\n              const bCol = roiPal256[val4 + 2];\r\n\r\n              dataDst[j + 0] = bCol;\r\n              dataDst[j + 1] = gCol;\r\n              dataDst[j + 2] = rCol;\r\n              dataDst[j + 3] = 255; // opacity\r\n\r\n              j += 4;\r\n            } // for (x)\r\n          } // for (y)\r\n        } // if 4 bppp\r\n      } else if (mode2d === Modes2d.CORONAL) {\r\n        // calc screen rect based on physics volume slice size (y slice)\r\n        const xzRatio = pbox.x / pbox.z;\r\n        wScreen = w;\r\n        hScreen = Math.floor(w / xzRatio);\r\n        if (hScreen > h) {\r\n          hScreen = h;\r\n          wScreen = Math.floor(h * xzRatio);\r\n          if (wScreen > w) {\r\n            console.log(`logic error! wScreen * hScreen = ${wScreen} * ${hScreen}`);\r\n          }\r\n        }\r\n        hScreen = (hScreen > 0) ? hScreen : 1;\r\n        // console.log(`gra2d. render: wScreen*hScreen = ${wScreen} * ${hScreen}, but w*h=${w}*${h} `);\r\n\r\n        this.m_toolPick.setScreenDim(wScreen, hScreen);\r\n        this.m_toolZoom.setScreenDim(wScreen, hScreen);\r\n        this.m_toolDistance.setScreenDim(wScreen, hScreen);\r\n        this.m_toolAngle.setScreenDim(wScreen, hScreen);\r\n        this.m_toolArea.setScreenDim(wScreen, hScreen);\r\n        this.m_toolRect.setScreenDim(wScreen, hScreen);\r\n        this.m_toolText.setScreenDim(wScreen, hScreen);\r\n        this.m_toolEdit.setScreenDim(wScreen, hScreen);\r\n        this.m_toolDelete.setScreenDim(wScreen, hScreen);\r\n\r\n        // setup pixel size for 2d tools\r\n        const xPixelSize = vol.m_boxSize.x / xDim;\r\n        const yPixelSize = vol.m_boxSize.z / zDim;\r\n        // console.log(`xyPixelSize = ${xPixelSize} * ${yPixelSize}`);\r\n        this.m_toolDistance.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolAngle.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolArea.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolRect.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolText.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolEdit.setPixelSize(xPixelSize, yPixelSize);\r\n        this.m_toolDelete.setPixelSize(xPixelSize, yPixelSize);\r\n\r\n        // create image data\r\n        imgData = ctx.createImageData(wScreen, hScreen);\r\n        dataDst = imgData.data;\r\n        if (dataDst.length !== wScreen * hScreen * 4) {\r\n          console.log(`Bad dst data len = ${dataDst.length}, but expect ${wScreen}*${hScreen}*4`);\r\n        }\r\n\r\n        // y slice\r\n        let ySlice = Math.floor(yDim * sliceRatio);\r\n        ySlice = (ySlice < yDim) ? ySlice : (yDim - 1);\r\n        const yOff = ySlice * xDim;\r\n\r\n        const xStep = zoom * xDim / wScreen;\r\n        const zStep = zoom * zDim / hScreen;\r\n        let j = 0;\r\n        let az = yPos * zDim;\r\n        if (vol.m_bytesPerVoxel === ONE) {\r\n          for (let y = 0; y < hScreen; y++, az += zStep) {\r\n            const zSrc = Math.floor(az);\r\n            const zOff = zSrc * xDim * yDim;\r\n            let ax = xPos * xDim;\r\n            for (let x = 0; x < wScreen; x++, ax += xStep) {\r\n              const xSrc = Math.floor(ax);\r\n              const val = dataSrc[zOff + yOff + xSrc];\r\n\r\n              dataDst[j + 0] = val;\r\n              dataDst[j + 1] = val;\r\n              dataDst[j + 2] = val;\r\n              dataDst[j + 3] = 255; // opacity\r\n\r\n              j += 4;\r\n            } // for (x)\r\n          } // for (y)\r\n        } else if (vol.m_bytesPerVoxel === FOUR) {\r\n          for (let y = 0; y < hScreen; y++, az += zStep) {\r\n            const zSrc = Math.floor(az);\r\n            const zOff = zSrc * xDim * yDim;\r\n            let ax = xPos * xDim;\r\n            for (let x = 0; x < wScreen; x++, ax += xStep) {\r\n              const xSrc = Math.floor(ax);\r\n              const val = dataSrc[(zOff + yOff + xSrc) * FOUR + OFF_3];\r\n              const val4 = val * FOUR;\r\n              const rCol = roiPal256[val4 + 0];\r\n              const gCol = roiPal256[val4 + 1];\r\n              const bCol = roiPal256[val4 + 2];\r\n\r\n              dataDst[j + 0] = bCol;\r\n              dataDst[j + 1] = gCol;\r\n              dataDst[j + 2] = rCol;\r\n              dataDst[j + 3] = 255; // opacity\r\n\r\n              j += 4;\r\n            } // for (x)\r\n          } // for (y)\r\n        } // end if 4 bpp\r\n      }\r\n\r\n      // check is segmentation 2d mode is active\r\n      // const isSegm = store.graphics2dModeSegmentation;\r\n      // console.log(\"Segm2d mode = \" + isSegm);\r\n\r\n      this.imgData = imgData;\r\n      this.segm2d.setImageData(imgData);\r\n    } // if vol not null\r\n  } // prepareImageForRender\r\n\r\n  renderReadyImage() {\r\n    // console.log('renderReadyImage ...');\r\n    if (!this.m_isMounted) {\r\n      return;\r\n    }\r\n\r\n    const objCanvas = this.m_mount;\r\n    if (objCanvas === null) {\r\n      return;\r\n    }\r\n    const ctx = objCanvas.getContext('2d');\r\n    const store = this.props;\r\n\r\n    const volSet = store.volumeSet;\r\n    if (volSet.getNumVolumes() === 0) {\r\n      return;\r\n    }\r\n    const volIndex = store.volumeIndex;\r\n    const vol = volSet.getVolume(volIndex);\r\n    if (vol === null) {\r\n      return;\r\n    }\r\n\r\n    const isSegm = this.m_isSegmented;\r\n    if (isSegm) {\r\n      const w = this.m_toolPick.m_wScreen;\r\n      const h = this.m_toolPick.m_hScreen;\r\n      this.segm2d.render(ctx, w, h, this.imgData);\r\n    } else {\r\n      ctx.putImageData(this.imgData, 0, 0);\r\n    }\r\n    // render text info\r\n    this.renderTextInfo(ctx, volSet, vol);\r\n    // render all tools\r\n    this.m_toolPick.render(ctx);\r\n    this.m_toolDistance.render(ctx, store);\r\n    this.m_toolAngle.render(ctx, store);\r\n    this.m_toolArea.render(ctx, store);\r\n    this.m_toolRect.render(ctx, store);\r\n    this.m_toolText.render(ctx, store);\r\n    this.m_toolEdit.render(ctx, store);\r\n    this.m_toolDelete.render(ctx, store);\r\n  }\r\n\r\n  onMouseWheel(evt) {\r\n    const store = this.props;\r\n    const indexTools2d = store.indexTools2d;\r\n    if (indexTools2d === Tools2dType.ZOOM) {\r\n      this.m_toolZoom.onMouseWheel(store, evt);\r\n    }\r\n  }\r\n\r\n  onMouseUp(evt) {\r\n    const store = this.props;\r\n    const indexTools2d = store.indexTools2d;\r\n    if (indexTools2d === Tools2dType.ZOOM) {\r\n      this.m_toolZoom.onMouseUp();\r\n    }\r\n    if (indexTools2d === Tools2dType.DISTANCE) {\r\n      const store = this.props;\r\n      const box = this.m_mount.getBoundingClientRect();\r\n      const xScr = evt.clientX - box.left;\r\n      const yScr = evt.clientY - box.top;\r\n      this.m_toolDistance.onMouseUp(xScr, yScr, store);\r\n    }\r\n    if (indexTools2d === Tools2dType.ANGLE) {\r\n      const store = this.props;\r\n      const box = this.m_mount.getBoundingClientRect();\r\n      const xScr = evt.clientX - box.left;\r\n      const yScr = evt.clientY - box.top;\r\n      this.m_toolAngle.onMouseUp(xScr, yScr, store);\r\n    }\r\n    if (indexTools2d === Tools2dType.AREA) {\r\n      const store = this.props;\r\n      const box = this.m_mount.getBoundingClientRect();\r\n      const xScr = evt.clientX - box.left;\r\n      const yScr = evt.clientY - box.top;\r\n      this.m_toolArea.onMouseUp(xScr, yScr, store);\r\n    }\r\n    if (indexTools2d === Tools2dType.RECT) {\r\n      const store = this.props;\r\n      const box = this.m_mount.getBoundingClientRect();\r\n      const xScr = evt.clientX - box.left;\r\n      const yScr = evt.clientY - box.top;\r\n      this.m_toolRect.onMouseUp(xScr, yScr, store);\r\n    }\r\n    if (indexTools2d === Tools2dType.EDIT) {\r\n      const store = this.props;\r\n      const box = this.m_mount.getBoundingClientRect();\r\n      const xScr = evt.clientX - box.left;\r\n      const yScr = evt.clientY - box.top;\r\n      this.m_toolEdit.onMouseUp(xScr, yScr, store);\r\n    }\r\n    if (indexTools2d === Tools2dType.DELETE) {\r\n      const store = this.props;\r\n      const box = this.m_mount.getBoundingClientRect();\r\n      const xScr = evt.clientX - box.left;\r\n      const yScr = evt.clientY - box.top;\r\n      this.m_toolDelete.onMouseUp(xScr, yScr, store);\r\n    }\r\n  }\r\n\r\n  onMouseMove(evt) {\r\n    const store = this.props;\r\n    const indexTools2d = store.indexTools2d;\r\n    const box = this.m_mount.getBoundingClientRect();\r\n    const xContainer = evt.clientX - box.left;\r\n    const yContainer = evt.clientY - box.top;\r\n    const xScr = xContainer;\r\n    const yScr = yContainer;\r\n\r\n    if (indexTools2d === Tools2dType.ZOOM) {\r\n      this.m_toolZoom.onMouseMove(store, xScr, yScr);\r\n    }\r\n    if (indexTools2d === Tools2dType.DISTANCE) {\r\n      this.m_toolDistance.onMouseMove(xScr, yScr, store);\r\n    }\r\n    if (indexTools2d === Tools2dType.ANGLE) {\r\n      this.m_toolAngle.onMouseMove(xScr, yScr, store);\r\n    }\r\n    if (indexTools2d === Tools2dType.AREA) {\r\n      this.m_toolArea.onMouseMove(xScr, yScr, store);\r\n    }\r\n    if (indexTools2d === Tools2dType.RECT) {\r\n      this.m_toolRect.onMouseMove(xScr, yScr, store);\r\n    }\r\n    if (indexTools2d === Tools2dType.EDIT) {\r\n      this.m_toolEdit.onMouseMove(xScr, yScr, store);\r\n    }\r\n    if (indexTools2d === Tools2dType.DELETE) {\r\n      this.m_toolDelete.onMouseMove(xScr, yScr, store);\r\n    }\r\n  }\r\n\r\n  onMouseDown(evt) {\r\n    const box = this.m_mount.getBoundingClientRect();\r\n    const xContainer = evt.clientX - box.left;\r\n    const yContainer = evt.clientY - box.top;\r\n    const xScr = xContainer;\r\n    const yScr = yContainer;\r\n    // console.log(`onMouseDown. down = ${xScr}, ${yScr}`);\r\n\r\n    const store = this.props;\r\n    const indexTools2d = store.indexTools2d;\r\n    // console.log(`onMouseDown. tool index = ${indexTools2d}`);\r\n\r\n\r\n    switch (indexTools2d) {\r\n    case Tools2dType.INTENSITY:\r\n      this.m_toolPick.onMouseDown(xScr, yScr, store);\r\n      break;\r\n    case Tools2dType.DISTANCE:\r\n      this.m_toolDistance.onMouseDown(xScr, yScr, store);\r\n      break;\r\n    case Tools2dType.ZOOM:\r\n      this.m_toolZoom.onMouseDown(xScr, yScr);\r\n      break;\r\n    case Tools2dType.ANGLE:\r\n      this.m_toolAngle.onMouseDown(xScr, yScr, store);\r\n      break;\r\n    case Tools2dType.AREA:\r\n      this.m_toolArea.onMouseDown(xScr, yScr, store);\r\n      break;\r\n    case Tools2dType.RECT:\r\n      this.m_toolRect.onMouseDown(xScr, yScr, store);\r\n      break;\r\n    case Tools2dType.TEXT:\r\n      this.m_toolText.onMouseDown(xScr, yScr, store);\r\n      break;\r\n    case Tools2dType.EDIT:\r\n      this.m_toolEdit.onMouseDown(xScr, yScr, store);\r\n      break;\r\n    case Tools2dType.DELETE:\r\n      this.m_toolDelete.onMouseDown(xScr, yScr, store);\r\n      break;\r\n    default:\r\n      // not defined\r\n    } // switch\r\n    // force update\r\n    this.forceUpdate();\r\n  } // onMouseDown\r\n\r\n  /**\r\n   * Invoke clear all tools\r\n   */\r\n  clear() {\r\n    this.m_toolDistance.clear();\r\n    this.m_toolAngle.clear();\r\n    this.m_toolArea.clear();\r\n    this.m_toolRect.clear();\r\n    this.m_toolText.clear();\r\n    this.m_toolEdit.clear();\r\n    this.m_toolDelete.clear();\r\n  }\r\n\r\n  /**\r\n   * Invoke forced rendering, after some tool visual changes\r\n   */\r\n  forceUpdate(volIndex) {\r\n    // console.log('forceUpdate ...');\r\n    this.prepareImageForRender(volIndex);\r\n    // this.forceRender();\r\n    if (this.m_isSegmented) { // need to draw segmented image\r\n      if (this.segm2d.model !== null) {\r\n        // we have loaded model: applt it to image\r\n        this.segm2d.startApplyImage();\r\n      }\r\n    } else {\r\n      this.forceRender();\r\n    } // if not segmented image\r\n  }\r\n\r\n  forceRender() {\r\n    if (this.m_isMounted) {\r\n      // console.log('forceRender ...');\r\n      this.setState({ state: this.state });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    // const store = this.props;\r\n    // const volSet = store.volumeSet;\r\n    this.m_sliceRatio = this.props.sliderValue;\r\n    this.m_mode2d = this.props.mode2d;\r\n\r\n    const styleObj = {\r\n      width: '100%',\r\n      height: '100%',\r\n    };\r\n\r\n    const jsxGrapNonSized = <canvas ref={ (mount) => {this.m_mount = mount} } style={styleObj} />\r\n    const jsxGrapSized = <canvas ref={ (mount) => {this.m_mount = mount} } width={this.state.wRender} height={this.state.hRender}\r\n      onMouseDown={this.onMouseDown} onMouseUp={this.onMouseUp} onMouseMove={this.onMouseMove} onWheel={this.onMouseWheel} />\r\n    const jsx = (this.state.wRender > 0) ? jsxGrapSized : jsxGrapNonSized;\r\n    return jsx;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(Graphics2d);\r\n","/**\r\n * @fileOverview UiTools2d\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport StoreActionType from '../store/ActionTypes';\r\nimport Tools2dType from '../engine/tools2d/ToolTypes';\r\n\r\nimport { OverlayTrigger, Tooltip } from 'react-bootstrap';\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\nclass UiTools2d extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n    this.onClickButtonTools = this.onClickButtonTools.bind(this);\r\n    this.state = {\r\n      data: [\r\n        { img: 'images/icon_tools2d_intensity.png', txt: 'intensity', ke: Tools2dType.INTENSITY, msgTp: 'Get voxel intensity' },\r\n        { img: 'images/icon_tools2d_distance.png', txt: 'distance', ke: Tools2dType.DISTANCE, msgTp: 'Measure distance between voxels' },\r\n        { img: 'images/icon_tools2d_angle.png', txt: 'angle', ke: Tools2dType.ANGLE, msgTp: 'Measure angle between lines' },\r\n        { img: 'images/icon_tools2d_area.png', txt: 'area', ke: Tools2dType.AREA, msgTp: 'Calculate arbitrary area' },\r\n        { img: 'images/icon_tools2d_rect.png', txt: 'rect', ke: Tools2dType.RECT, msgTp: 'Calculate rectangular area' },\r\n        { img: 'images/icon_tools2d_text.png', txt: 'text', ke: Tools2dType.TEXT, msgTp: 'Add annotation text' },\r\n        { img: 'images/icon_tools2d_edit.png', txt: 'edit', ke: Tools2dType.EDIT, msgTp: 'Move annotation text' },\r\n        { img: 'images/icon_tools2d_delete.png', txt: 'delete', ke: Tools2dType.DELETE, msgTp: 'Delete annotation object' },\r\n        { img: 'images/icon_tools2d_clear.png', txt: 'clear', ke: Tools2dType.CLEAR, msgTp: 'Clear all objects' },\r\n        { img: 'images/icon_tools2d_zoom.png', txt: 'zoom', ke: Tools2dType.ZOOM, msgTp: 'Zoom in/out' },\r\n        { img: 'images/icon_tools2d_default.png', txt: 'default', ke: Tools2dType.DEFAULT, msgTp: 'Zoom to default' },\r\n        // { img: 'images/icon_tools2d_filter.png', txt: 'filter', ke: Tools2dType.FILTER },\r\n        { img: 'images/icon_tools2d_empty.png', txt: 'none', ke: Tools2dType.NONE, msgTp: 'Empty' },\r\n      ],\r\n    };\r\n  }\r\n\r\n  onClickButtonTools(evt) {\r\n    // console.log('UiTools2d. onClickButtonTools');\r\n    const btn = evt.target;\r\n    const idx = this.state.data.findIndex(obj => (obj.txt === btn.alt) );\r\n    if (idx >= 0) {\r\n      // set new toools 2s index to global store\r\n      const store = this.props;\r\n      store.dispatch({ type: StoreActionType.SET_2D_TOOLS_INDEX, indexTools2d: idx });\r\n      // console.log(`UiTools2d. onClickButton index = ${idx}`);\r\n      if( idx === Tools2dType.DEFAULT) {\r\n        store.dispatch({ type: StoreActionType.SET_2D_ZOOM, render2dZoom: 1.0 });\r\n        store.dispatch({ type: StoreActionType.SET_2D_X_POS, render2dxPos: 0.0 });\r\n        store.dispatch({ type: StoreActionType.SET_2D_Y_POS, render2dyPos: 0.0 });\r\n\r\n        const gra = store.graphics2d;\r\n        gra.forceUpdate();\r\n        gra.forceRender();\r\n      }\r\n      if( idx === Tools2dType.CLEAR) {\r\n        const gra2d = store.graphics2d;\r\n        if (gra2d !== null) {\r\n          gra2d.clear();\r\n        }\r\n      }\r\n\r\n    } // if button index valid\r\n  } // end of onClickButtonTools\r\n\r\n  render() {\r\n    const strTitle = 'Tools';\r\n\r\n    const store = this.props;\r\n    const indexCur = store.indexTools2d;\r\n\r\n    const jsx = \r\n    <div className=\"card\" >\r\n      <div className=\"card-header\">\r\n        {strTitle}\r\n      </div>\r\n      <div className=\"card-body\">\r\n        <div className=\"btn-group row\">\r\n\r\n          {this.state.data.map(d => \r\n          {\r\n            const strAttr = (indexCur === d.ke) ? 'col-2 btn btn-outline-secondary' : 'col-2 btn';\r\n\r\n            const jsxBtn = <button type='button' className={strAttr} key={d.ke} id={d.ke} onClick={this.onClickButtonTools} >\r\n              <img className='img-thumbnail' src={d.img} alt={d.txt} />\r\n            </button>\r\n            const msgTooltip = d.msgTp;\r\n            const jsxOverlay = <OverlayTrigger key={d.txt} placement=\"bottom\" overlay={\r\n              <Tooltip>\r\n                {msgTooltip}\r\n              </Tooltip>\r\n            }>\r\n              {jsxBtn} \r\n            </OverlayTrigger>\r\n\r\n            return jsxOverlay; \r\n          })}\r\n\r\n        </div>\r\n      </div>\r\n    </div>\r\n    return jsx;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiTools2d);\r\n\r\n","/**\r\n * @fileOverview UiSegm2d\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\n// import StoreActionType from '../store/ActionTypes';\r\n// import Tools2dType from '../engine/tools2d/ToolTypes';\r\nimport { Form, Card, OverlayTrigger, Tooltip } from 'react-bootstrap';\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\nclass UiSegm2d extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n    this.onChangeSegm2d = this.onChangeSegm2d.bind(this);\r\n    this.state = {\r\n      isSegmented: false,\r\n    };\r\n  }\r\n\r\n  onChangeSegm2d() {\r\n    // console.log('UiSegm2d. onChangeSegm2d ...');\r\n    this.setState({ isSegmented: !this.state.isSegmented });\r\n\r\n    const store = this.props;\r\n    const gra2d = store.graphics2d;\r\n    if (gra2d !== null) {\r\n\r\n      gra2d.m_isSegmented = !this.state.isSegmented;\r\n      gra2d.forceUpdate();\r\n      gra2d.forceRender();\r\n      const segm = gra2d.segm2d;\r\n      if ((segm !== null)  && (!this.state.isSegmented)) {\r\n        if (segm.model == null) {\r\n          //console.log('onChangeSegm2d. onLoadModel ...');\r\n          segm.onLoadModel();\r\n        } else {\r\n          //console.log('onChangeSegm2d. start apply image ...');\r\n          //segm.startApplyImage();\r\n        }\r\n      }\r\n    }\r\n  } // end of onChangeSegm2d\r\n\r\n  // render UI for 2d segmentation on screen\r\n  render() {\r\n    const strTitle = 'Segmentation 2d (brain only)';\r\n    const jsx = \r\n    <Card>\r\n      <Card.Header>\r\n        {strTitle}\r\n      </Card.Header>\r\n      <Card.Body>\r\n        <OverlayTrigger \r\n          key=\"about\"\r\n          placement=\"bottom\"\r\n          overlay = {\r\n            <Tooltip>\r\n              You can use automatic 2d image segmentation only for brain-like data\r\n            </Tooltip>\r\n          }\r\n        >\r\n          <Form>\r\n            <Form.Check inline type=\"checkbox\" label=\"Segmentation 2d\" id=\"idseg2d\" onChange={this.onChangeSegm2d} >\r\n            </Form.Check>\r\n          </Form>\r\n\r\n        </OverlayTrigger>\r\n\r\n        <Card.Text>\r\n          Switch checker above on and see segmentation result on right\r\n        </Card.Text>\r\n\r\n      </Card.Body>\r\n    </Card>\r\n    return jsx;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiSegm2d);\r\n\r\n","/**\r\n * @fileOverview Texture3D\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport * as THREE from 'three';\r\n\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class Texture3D  some text later...\r\n */\r\nexport default class Texture3D {\r\n  constructor() {\r\n    this.m_texture = -1;\r\n  }\r\n\r\n  createFromRawVolume(vol) {\r\n    this.m_texture = new THREE.DataTexture3D(vol.m_dataArray, vol.m_xDim, vol.m_yDim, vol.m_zDim);\r\n  }\r\n}\r\n","/**\r\n * @fileOverview Volume\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\n\r\n//import LoaderKtx from './loaders/LoaderKtx';\r\n//import LoaderNifti from './loaders/LoaderNifti';\r\n//import LoaderDicom from './loaders/LoaderDicom';\r\n//import LoaderHdr from './loaders/LoaderHdr';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\nexport const VOLUME_ICON_SIDE = 64;\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class Volume  \r\n * \r\n * Result volume, loaded from Dicom, Ktx, Nifti, ... files\r\n */\r\nclass Volume extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.m_xDim = 0;\r\n    this.m_yDim = 0;\r\n    this.m_zDim = 0;\r\n    this.m_bytesPerVoxel = 0;\r\n    this.m_dataArray = null;\r\n    this.m_dataSize = 0;\r\n    this.m_boxSize = {\r\n      x: 0.0, y: 0.0, z: 0.0\r\n    };\r\n    // icon to show\r\n    this.m_xIcon = 0;\r\n    this.m_yIcon = 0;\r\n    this.m_dataIcon = null;\r\n  }\r\n\r\n  createEmptyBytesVolume(xDim, yDim, zDim) {\r\n    this.m_xDim = xDim;\r\n    this.m_yDim = yDim;\r\n    this.m_zDim = zDim;\r\n    const xyzDim = xDim * yDim * zDim;\r\n    this.m_bytesPerVoxel = 1;\r\n    this.m_dataArray = new Uint8Array(xyzDim);\r\n    this.m_dataSize = xyzDim;\r\n    this.m_boxSize = {\r\n      x: xDim, y: yDim, z: zDim\r\n    };\r\n    for (let i = 0; i < xyzDim; i++) {\r\n      this.m_dataArray[i] = 0;\r\n    }\r\n  }\r\n\r\n  // Create icon for volume\r\n  createIcon() {\r\n    console.assert(this.m_xDim > 0);\r\n    console.assert(this.m_yDim > 0);\r\n    console.assert(this.m_zDim > 0);\r\n    console.assert(this.m_dataArray !== null);\r\n    const sizeSrcMax = (this.m_xDim > this.m_yDim) ? this.m_xDim : this.m_yDim;\r\n    const scale = sizeSrcMax / VOLUME_ICON_SIDE;\r\n\r\n    // central slice\r\n    const zCenter = Math.floor(this.m_zDim / 2);\r\n    const zOff = zCenter * this.m_xDim * this.m_yDim;\r\n\r\n    this.m_xIcon = VOLUME_ICON_SIDE;\r\n    this.m_yIcon = this.m_xIcon;\r\n    const numPixelsIcon = this.m_xIcon * this.m_yIcon;\r\n    this.m_dataIcon = new Uint8Array(numPixelsIcon);\r\n    for (let i = 0; i < numPixelsIcon; i++){\r\n      this.m_dataIcon[i] = 0;\r\n    }\r\n    // actual size in icon (dest image)\r\n    const wDst = Math.floor(VOLUME_ICON_SIDE * this.m_xDim / sizeSrcMax);\r\n    const hDst = Math.floor(VOLUME_ICON_SIDE * this.m_yDim / sizeSrcMax);\r\n    // top left corner in dst image\r\n    const xDstL = Math.floor(this.m_xIcon / 2 - wDst / 2);\r\n    const yDstT = Math.floor(this.m_yIcon / 2 - hDst / 2);\r\n    for (let yDst = 0; yDst < hDst; yDst++) {\r\n      const ySrc = Math.floor(yDst * scale);\r\n      for (let xDst = 0; xDst < wDst; xDst++) {\r\n        const xSrc = Math.floor(xDst * scale);\r\n        const val = this.m_dataArray[xSrc + ySrc * this.m_xDim + zOff];\r\n        // write result\r\n        const xWrite = xDst + xDstL;\r\n        const yWrite = yDst + yDstT;\r\n        this.m_dataIcon[xWrite + yWrite * this.m_xIcon] = val;\r\n      } // for xDst\r\n    } // for yDst\r\n  } // end createIcon\r\n\r\n  //\r\n  // Make each volume texture size equal to 4 * N\r\n  //\r\n  makeDimensions4x() {\r\n    // do nothing if z slices less then 4 (was less 1)\r\n    if (this.m_zDim < 4) {\r\n      return;\r\n    }\r\n    const xDimNew = (this.m_xDim + 3) & (~3);\r\n    const yDimNew = (this.m_yDim + 3) & (~3);\r\n    const zDimNew = (this.m_zDim + 3) & (~3);\r\n    if ((this.m_xDim === xDimNew) && (this.m_yDim === yDimNew) && (this.m_zDim === zDimNew)) {\r\n      return; // do nothing\r\n    } // if new size the same as current\r\n    // perfom convert adding black pixels\r\n    console.log(`Volume. makeDimensions4x. Convert into ${xDimNew}*${yDimNew}*${zDimNew}`);\r\n    const xyzDimNew  = xDimNew * yDimNew * zDimNew;\r\n    const bytesPerVoxel = this.m_bytesPerVoxel;\r\n    const bufSizeBytes = xyzDimNew * bytesPerVoxel;\r\n    const datArrayNew = new Uint8Array(xyzDimNew * bytesPerVoxel);\r\n    let i;\r\n    for (i = 0; i < bufSizeBytes; i++) {\r\n      datArrayNew[i] = 0;\r\n    }\r\n\r\n    const ONE = 1;\r\n    const FOUR = 4;\r\n    const OFF_0 = 0; const OFF_1 = 1;\r\n    const OFF_2 = 2; const OFF_3 = 3;\r\n\r\n    console.log(`Volume info: xyzDim = ${this.m_xDim}*${this.m_yDim}*${this.m_zDim}`);\r\n    console.log(`Volume info: bpp = ${this.m_bytesPerVoxel}`);\r\n    console.log(`Volume info: dataSize = ${this.m_dataSize}`);\r\n\r\n    const xyDim = this.m_xDim * this.m_yDim;\r\n    if (this.m_bytesPerVoxel === ONE) {\r\n      for (let z = 0; z < this.m_zDim; z++) {\r\n        const zOff = z * xyDim;\r\n        const zOffDst = z * xDimNew * yDimNew;\r\n        for (let y = 0; y < this.m_yDim; y++) {\r\n          const yOff = y * this.m_xDim;\r\n          const yOffDst = y * xDimNew;\r\n          for (let x = 0; x < this.m_xDim; x++) {\r\n            const off = x + yOff + zOff;\r\n            const val = this.m_dataArray[off];\r\n            const offDst = x + yOffDst + zOffDst;\r\n            datArrayNew[offDst] = val;\r\n          } // for (x)\r\n        } // for (y)\r\n      } // for (z)\r\n    } else if (this.m_bytesPerVoxel === FOUR) {\r\n      for (let z = 0; z < this.m_zDim; z++) {\r\n        const zOff = z * xyDim;\r\n        const zOffDst = z * xDimNew * yDimNew;\r\n        for (let y = 0; y < this.m_yDim; y++) {\r\n          const yOff = y * this.m_xDim;\r\n          const yOffDst = y * xDimNew;\r\n          for (let x = 0; x < this.m_xDim; x++) {\r\n            const off = (x + yOff + zOff) * FOUR;\r\n            const val0 = this.m_dataArray[off + OFF_0];\r\n            const val1 = this.m_dataArray[off + OFF_1];\r\n            const val2 = this.m_dataArray[off + OFF_2];\r\n            const val3 = this.m_dataArray[off + OFF_3];\r\n            const offDst = (x + yOffDst + zOffDst) * FOUR;\r\n            datArrayNew[offDst + OFF_0] = val0;\r\n            datArrayNew[offDst + OFF_1] = val1;\r\n            datArrayNew[offDst + OFF_2] = val2;\r\n            datArrayNew[offDst + OFF_3] = val3;\r\n          } // for (x)\r\n        } // for (y)\r\n      } // for (z)\r\n    }\r\n\r\n    this.m_xDim = xDimNew;\r\n    this.m_yDim = yDimNew;\r\n    this.m_zDim = zDimNew;\r\n    this.m_dataArray = datArrayNew;\r\n    this.m_dataSize = xyzDimNew;\r\n  } // end\r\n\r\n  // do nothing. But we need to implement render() to run Volume tests\r\n  render() {\r\n    return <p>></p>;\r\n  }\r\n\r\n} // end class Volume\r\n\r\nexport default Volume;\r\n","/**\r\n * @fileOverview UiVolIcon\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { VOLUME_ICON_SIDE } from '../engine/Volume';\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\nclass UiVolIcon extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n    this.m_volIndex = -1;\r\n  }\r\n\r\n  componentDidMount() {\r\n    // console.log(\"UiVlIcon.componentDidMount\");\r\n    const store = this.props;\r\n    const volSet = store.volumeSet;\r\n    const vol = volSet.getVolume(this.m_volIndex);\r\n    // console.log(`vol icon = ${vol.m_xIcon} * ${vol.m_yIcon}`);\r\n\r\n    const objCanvas = this.m_mount;\r\n    if (objCanvas === null) {\r\n      return;\r\n    }\r\n    const ctx = objCanvas.getContext('2d');\r\n    const w = objCanvas.clientWidth;\r\n    const h = objCanvas.clientHeight;\r\n    if (w * h === 0) {\r\n      return;\r\n    }\r\n    // clear dest image\r\n    ctx.fillStyle = 'rgb(64, 64, 64)';\r\n    ctx.fillRect(0,0, w, h);\r\n\r\n    if (vol.m_xIcon <= 0) {\r\n      // draw cross on whole image\r\n      ctx.beginPath();\r\n      ctx.moveTo(0, 0);\r\n      ctx.lineTo(w - 1, h - 1);\r\n      ctx.stroke();\r\n\r\n      ctx.beginPath();\r\n      ctx.moveTo(w - 1, 0);\r\n      ctx.lineTo(0, h - 1);\r\n      ctx.stroke();\r\n      return;\r\n    }\r\n    // copy icon data to screen\r\n    const imgData = ctx.createImageData(w, h);\r\n    const dataDst = imgData.data;\r\n    const numPixels = w * h;\r\n    let j = 0;\r\n    for (let i = 0; i < numPixels; i++) {\r\n      const val = vol.m_dataIcon[i];\r\n      dataDst[j + 0] = val;\r\n      dataDst[j + 1] = val;\r\n      dataDst[j + 2] = val;\r\n      dataDst[j + 3] = 255;\r\n      j += 4;\r\n    }\r\n    ctx.putImageData(imgData, 0, 0);\r\n  }\r\n\r\n  // render on screen\r\n  render() {\r\n    const side = VOLUME_ICON_SIDE;\r\n    this.m_volIndex = this.props.index;;\r\n    const jsxCanvas = <canvas ref={ (mount) => {this.m_mount = mount} } width={side} height={side} />\r\n    return jsxCanvas;\r\n  }\r\n\r\n} // end class UiVolIcon\r\nexport default connect(store => store)(UiVolIcon);\r\n","/**\r\n * @fileOverview UiVolumeSel\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport { Card, ListGroup, ListGroupItem } from 'react-bootstrap';\r\n\r\nimport StoreActionType from '../store/ActionTypes';\r\n// import LoaderDicom from '../engine/loaders/LoaderDicom';\r\nimport Texture3D from '../engine/Texture3D';\r\n// import ModeView from '../store/ModeView';\r\n// import Modes3d from '../store/Modes3d';\r\n\r\nimport UiVolIcon from './UiVolIcon';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\nconst NEED_TEXTURE_SIZE_4X = true;\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\nclass UiVolumeSel extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n    this.onClickRow = this.onClickRow.bind(this);\r\n    // this.state = {\r\n    //   index: 0,\r\n    // };\r\n  }\r\n\r\n  setVolumeIndex(indexSelected) {\r\n    const store = this.props;\r\n    // const series = store.dicomSeries;\r\n    // const serieSelected = series[indexSelected];\r\n    // const hash = serieSelected.m_hash;\r\n    const volumeSet = store.volumeSet;\r\n    \r\n    // const loaderDicom = store.loaderDicom;\r\n\r\n    // volumes are already created from slices\r\n    // loaderDicom.createVolumeFromSlices(volumeSet, indexSelected, hash);\r\n    \r\n    // finalize load\r\n    const vol = volumeSet.getVolume(indexSelected);\r\n    console.assert(vol !== null, \"setVolumeIndex: vol should be non zero volume\");\r\n\r\n    if (vol.m_dataArray !== null) {\r\n      // console.log(`success loaded volume from ${fileNameIn}`);\r\n      if (NEED_TEXTURE_SIZE_4X) {\r\n        vol.makeDimensions4x();\r\n      }\r\n      // invoke notification\r\n    \r\n      // send update (repaint) if was loaded prev model\r\n      if (store.isLoaded) {\r\n        store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: false });  \r\n      }\r\n\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_SET, volumeSet: volumeSet });\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_INDEX, volumeIndex: indexSelected });\r\n      // store.dispatch({ type: StoreActionType.SET_FILENAME, fileName: fileNameIn });\r\n      // store.dispatch({ type: StoreActionType.SET_ERR_ARRAY, arrErrors: [] });\r\n      const tex3d = new Texture3D();\r\n      tex3d.createFromRawVolume(vol);\r\n      store.dispatch({ type: StoreActionType.SET_TEXTURE3D, texture3d: tex3d });\r\n      // store.dispatch({ type: StoreActionType.SET_MODE_VIEW, modeView: ModeView.VIEW_2D });\r\n      // store.dispatch({ type: StoreActionType.SET_MODE_3D, mode3d: Modes3d.RAYCAST });\r\n      store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: true });\r\n\r\n      const gra = store.graphics2d;\r\n      gra.clear();\r\n      gra.forceUpdate(indexSelected);\r\n      gra.forceRender();\r\n\r\n    } // if vol data not null\r\n  }\r\n\r\n  onClickRow(ind) {\r\n    console.assert(typeof(ind) == 'number');\r\n    const store = this.props;\r\n    if (ind !== store.volumeIndex) {\r\n      // set global selected volume index\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_INDEX, volumeIndex: ind });\r\n      this.setVolumeIndex(ind);\r\n    }\r\n  }\r\n\r\n  render() {\r\n    const store = this.props;\r\n    const volumeSet = store.volumeSet;\r\n    const vols = volumeSet.m_volumes;\r\n    const volumeIndex = store.volumeIndex;\r\n\r\n    const strPatName = store.dicomInfo.m_patientName;\r\n    const strStudyDescr = store.dicomInfo.m_studyDescr;\r\n    const strTitle = `Volume select. [${strPatName}]: ${strStudyDescr}`;\r\n\r\n    // const slices = store.dicomInfo.m_sliceInfo;\r\n\r\n    const jsx = \r\n    <Card>\r\n      <Card.Header>\r\n        {strTitle}\r\n      </Card.Header>\r\n      <Card.Body>\r\n        <ListGroup>\r\n          {vols.map( (vol, i) => {\r\n            const numSlices = vol.m_zDim;\r\n            const strSer = vol.m_seriesDescr;\r\n            const strVo = `vol ${strSer} [${numSlices}] slices`;\r\n            let jsxListItem;\r\n            if (i === volumeIndex) {\r\n              jsxListItem = <ListGroupItem key={i} onClick={() => {this.onClickRow(i)} } active>{strVo} <UiVolIcon index={i} /> </ListGroupItem>;\r\n            } else {\r\n              jsxListItem = <ListGroupItem key={i} onClick={() => {this.onClickRow(i)} }>{strVo} <UiVolIcon index={i} /> </ListGroupItem>;\r\n            }\r\n            return jsxListItem;\r\n          })}\r\n        </ListGroup>\r\n\r\n      </Card.Body>\r\n    </Card>\r\n    return jsx;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiVolumeSel);\r\n\r\n","/**\r\n * @fileOverview UiMain2d\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { Row, Col, Container } from 'react-bootstrap';\r\n\r\nimport UiCtrl2d from './UiCtrl2d';\r\nimport Graphics2d from '../engine/Graphics2d';\r\nimport UiTools2d from './UiTools2d';\r\nimport UiSegm2d from './UiSegm2d';\r\nimport UiVolumeSel from './UiVolumeSel'\r\n\r\n// import UiHistCard from './UiHistCard';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiMain2d some text later...\r\n */\r\nclass UiMain2d extends React.Component {\r\n  transferFuncCallback(transfFuncObj) {\r\n    const i = transfFuncObj.m_indexMoved;\r\n    const x = transfFuncObj.m_handleX[i];\r\n    const y = transfFuncObj.m_handleY[i];\r\n    console.log(`moved point[${i}] = ${x}, ${y}  `);\r\n  }\r\n\r\n  /*\r\n   *\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    const MIN_HEIGHT = 800;\r\n    const strMinHeight = {\r\n      minHeight: MIN_HEIGHT.toString() + 'px'\r\n    };\r\n    const store = this.props;\r\n    // const dicomSeries = store.dicomSeries;\r\n    // const numSer = dicomSeries.length;\r\n    const volSet = store.volumeSet;\r\n    const vols = volSet.m_volumes;\r\n    const numVols = vols.length;\r\n    const jsxVolSel = (numVols > 1) ? <UiVolumeSel /> : <br />\r\n\r\n\r\n    const jsxMain2d = \r\n      <Container fluid=\"true\" style={{ height: '100%', minHeight:'100%' }} >\r\n        <Row>\r\n          <Col xs md lg=\"4\" style={{ height: '100%', position: 'relative' }} >\r\n            <UiCtrl2d />\r\n            <UiTools2d />\r\n            <UiSegm2d />\r\n            {jsxVolSel}\r\n\r\n            { /*            \r\n            <UiHistCard volume={vol} transfFunc={funcTra} />\r\n            */ }\r\n            \r\n          </Col>\r\n          <Col xs md lg=\"8\" style={strMinHeight} >\r\n            <Graphics2d  />\r\n          </Col>\r\n        </Row>\r\n      </Container>\r\n\r\n    return jsxMain2d;\r\n  };\r\n}\r\n\r\nexport default connect(store => store)(UiMain2d);\r\n","/**\r\n * @fileOverview TransfFunc\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nclass TransfFunc {\r\n  constructor() {\r\n    this.m_mouseDown = false;\r\n    this.m_indexMoved = -1;\r\n\r\n    this.m_numHandles = 10;\r\n    this.m_handleColors = [\r\n      { r: 0, g: 0, b: 0 },\r\n      { r: 255, g: 128, b: 64 },\r\n      { r: 255, g: 0, b: 0 },\r\n      { r: 128, g: 64, b: 64 },\r\n      { r: 128, g: 0, b: 0 },\r\n      { r: 64, g: 64, b: 64 },\r\n      { r: 128, g: 128, b: 128 },\r\n      { r: 192, g: 192, b: 192 },\r\n      { r: 255, g: 255, b: 255 },\r\n      { r: 255, g: 255, b: 255 },\r\n    ];\r\n    this.m_handleX = [\r\n      0, 22, 40, 55, 61, 115, 118, 125, 160, 255\r\n    ];\r\n    this.m_handleY = [\r\n      0, 0, 0.3, 0.12, 0, 0, 0.4, 0.8, 0.95, 1.0\r\n    ];\r\n    // screen projections\r\n    this.m_proj = [\r\n      { x: 0, y: 0 },\r\n      { x: 0, y: 0 },\r\n      { x: 0, y: 0 },\r\n      { x: 0, y: 0 },\r\n      { x: 0, y: 0 },\r\n      { x: 0, y: 0 },\r\n      { x: 0, y: 0 },\r\n      { x: 0, y: 0 },\r\n      { x: 0, y: 0 },\r\n      { x: 0, y: 0 }\r\n    ];\r\n    // check correct array size\r\n    if (this.m_handleColors.length !== this.m_numHandles) {\r\n      console.log(`Wrong array this.m_handleColors: ${this.m_handleColors.length} !== ${this.m_numHandles}`);\r\n    }\r\n  } // end constructor\r\n\r\n  render(ctx, xMin, yMin, wScreen, hScreen) {\r\n\r\n    this.m_xMin = xMin;\r\n    this.m_yMin = yMin;\r\n    this.m_wScreen = wScreen;\r\n    this.m_hScreen = hScreen;\r\n\r\n    const X_MAX = 255;\r\n    const Y_MAX = 1.0;\r\n    const RAD_CIRCLE = Math.floor(wScreen / 50.0);\r\n    this.m_radCircle = RAD_CIRCLE;\r\n    ctx.lineWidth = 1;\r\n    ctx.strokeStyle = '#000000'\r\n    let xPre, yPre;\r\n\r\n    // draw lines\r\n    xPre = -1; yPre = -1;\r\n    for (let i = 0; i < this.m_numHandles; i++) {\r\n      const xFunc = this.m_handleX[i];\r\n      const yFunc = this.m_handleY[i];\r\n      const x = xMin + Math.floor(wScreen * xFunc / X_MAX);\r\n      const y = yMin + Math.floor(hScreen - 1 - hScreen * yFunc / Y_MAX);\r\n      this.m_proj[i].x = x;\r\n      this.m_proj[i].y = y;\r\n      if (i > 0) {\r\n        ctx.beginPath();\r\n        ctx.moveTo(xPre, yPre);\r\n        ctx.lineTo(x, y);\r\n        ctx.stroke();\r\n      }\r\n      xPre = x;\r\n      yPre = y;\r\n    } // for (i) all handle points\r\n    // draw ellipses\r\n    for (let i = 0; i < this.m_numHandles; i++) {\r\n      const xFunc = this.m_handleX[i];\r\n      const yFunc = this.m_handleY[i];\r\n      const x = xMin + Math.floor(wScreen * xFunc / X_MAX);\r\n      const y = yMin + Math.floor(hScreen - 1 - hScreen * yFunc / Y_MAX);\r\n      let strRCol = this.m_handleColors[i].r.toString(16);\r\n      let strGCol = this.m_handleColors[i].g.toString(16);\r\n      let strBCol = this.m_handleColors[i].b.toString(16);\r\n      strRCol = (strRCol.length === 1) ? ('0' + strRCol) : strRCol;\r\n      strGCol = (strGCol.length === 1) ? ('0' + strGCol) : strGCol;\r\n      strBCol = (strBCol.length === 1) ? ('0' + strBCol) : strBCol;\r\n      const strColor = `#${strRCol}${strGCol}${strBCol}`;\r\n      // console.log(`strColor = ${strColor}`);\r\n      ctx.fillStyle = strColor;\r\n      ctx.beginPath();\r\n      ctx.ellipse(x, y, RAD_CIRCLE, RAD_CIRCLE, 0.0, 0.0, Math.PI * 2.0);\r\n      ctx.fill();\r\n      ctx.stroke();\r\n    } // for (i) all handle points\r\n\r\n  } // end render\r\n\r\n  onMouseDown(xScr, yScr) {\r\n    for (let i = 0; i < this.m_numHandles; i++) {\r\n      const dx = xScr - this.m_proj[i].x;\r\n      const dy = yScr - this.m_proj[i].y;\r\n      const dist2 = dx * dx + dy * dy;\r\n      const MIN_DIST_2 = this.m_radCircle * this.m_radCircle;\r\n      if (dist2 <= MIN_DIST_2) {\r\n        console.log(`Picked point ${i}`);\r\n        this.m_mouseDown = true;\r\n        this.m_indexMoved = i;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * on mouse up even t handler\r\n   * \r\n   * @param {number} xScr - mouse x position on screen\r\n   * @param {number} yScr - mouse y position on screen\r\n   */\r\n  onMouseUp() {\r\n    this.m_mouseDown = false;\r\n    return false;\r\n  }\r\n\r\n  onMouseMove(xScr, yScr) {\r\n    if (this.m_mouseDown) {\r\n      const isBorderPoint = (this.m_indexMoved === 0) || (this.m_indexMoved === this.m_numHandles - 1);\r\n      let xScrNew;\r\n      let yScrNew;\r\n      if (isBorderPoint) {\r\n        xScrNew = this.m_proj[this.m_indexMoved].x;\r\n      } else {\r\n        xScrNew = xScr;\r\n        xScrNew = (xScrNew < this.m_proj[this.m_indexMoved - 1].x) ? this.m_proj[this.m_indexMoved - 1].x : xScrNew;\r\n        xScrNew = (xScrNew > this.m_proj[this.m_indexMoved + 1].x) ? this.m_proj[this.m_indexMoved + 1].x : xScrNew;\r\n      }\r\n\r\n      yScrNew = yScr;\r\n      if (yScrNew < this.m_yMin) {\r\n        yScrNew = this.m_yMin;\r\n        // console.log('Clip by min y');\r\n      }\r\n      if (yScrNew > this.m_yMin + this.m_hScreen) {\r\n        yScrNew = this.m_yMin + this.m_hScreen;\r\n        // console.log('Clip by max y');\r\n      }\r\n      this.m_proj[this.m_indexMoved].x = xScrNew;\r\n      this.m_proj[this.m_indexMoved].y = yScrNew;\r\n\r\n      const X_MAX = 255;\r\n      const Y_MAX = 1.0;\r\n      const xFunc = (xScrNew - this.m_xMin) * X_MAX / this.m_wScreen;\r\n      const yFunc = (this.m_yMin + this.m_hScreen - 1 - yScrNew) * Y_MAX / this.m_hScreen;\r\n      this.m_handleX[this.m_indexMoved] = xFunc;\r\n      this.m_handleY[this.m_indexMoved] = yFunc;\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n}; //end class TransfFunc\r\n\r\nexport default TransfFunc;\r\n","/**\r\n * @fileOverview UiHistogram\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\n\r\nimport TransfFunc from '../engine/TransFunc';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\nconst DEFAULT_HEIGHT = 220;\r\nconst NEED_TO_DRAW_VERTICAL_MARKS = false;\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiHistogram some text later...\r\n */\r\nexport default class UiHistogram extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.m_histogram = [];\r\n    this.m_numColors = 0;\r\n\r\n    this.m_transfFunc = new TransfFunc();\r\n    this.m_transfFuncCallback = undefined;\r\n    this.m_transfFuncUpdateCallback = undefined;\r\n\r\n    this.setSize = this.setSize.bind(this);\r\n    this.onMouseDown = this.onMouseDown.bind(this);\r\n    this.onMouseUp = this.onMouseUp.bind(this);\r\n    this.onMouseMove = this.onMouseMove.bind(this);\r\n\r\n    this.state = {\r\n      width: 0,\r\n      height: DEFAULT_HEIGHT,\r\n    };\r\n  }\r\n\r\n  componentDidMount() {\r\n    this.updateCanvas();\r\n    window.addEventListener('resize', this.handleResize, false);\r\n    this.setSize();    \r\n  }\r\n\r\n  componentDidUpdate() {\r\n    this.updateCanvas();\r\n    window.removeEventListener('resize', this.handleResize, false);\r\n  }\r\n\r\n  handleResize() {\r\n    this.setSize();\r\n  }\r\n\r\n  setSize() {\r\n    const objOwner = this.m_canvasOwner;\r\n    if (objOwner !== null) {\r\n      const w = objOwner.clientWidth - 2;\r\n      const h = objOwner.clientHeight - 2;\r\n      // console.log(`UiHistogram. setSize. = ${w} * ${h}`);\r\n      this.setState({ width: w });\r\n      this.setState({ height: h });\r\n    }\r\n  }\r\n\r\n  getVolumeHistogram(vol) {\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    const dataArray = vol.m_dataArray;\r\n    const xyzDim = xDim * yDim * zDim;\r\n    const NUM_COLORS = 256;\r\n    this.m_numColors = NUM_COLORS;\r\n    this.m_histogram = new Array(this.m_numColors);\r\n    let i;\r\n    for (i = 0; i < this.m_numColors; i++) {\r\n      this.m_histogram[i] = 0;\r\n    }\r\n    for (i = 0; i < xyzDim; i++) {\r\n      const ind = dataArray[i];\r\n      this.m_histogram[ind]++;\r\n    }\r\n    // calc max value in histogram\r\n    let valMax = 0;\r\n    for (i = 0; i < this.m_numColors; i++) {\r\n      valMax = (this.m_histogram[i] > valMax) ? this.m_histogram[i] : valMax;\r\n    }\r\n    const SOME_SMALL_ADD = 0.001;\r\n    valMax += SOME_SMALL_ADD;\r\n    // scale values to [0..1]\r\n    const scl = 1.0 / valMax;\r\n    for (i = 0; i < this.m_numColors; i++) {\r\n      this.m_histogram[i] *= scl;\r\n    }\r\n    this.smoothHistogram();\r\n    this.getMaxPeak();\r\n  }\r\n\r\n  assignArray(numColors, histogramArray) {\r\n    this.m_numColors = numColors;\r\n    this.m_histogram = histogramArray;\r\n  }\r\n\r\n  getLastMaxIndex(valMin = 0.0) {\r\n    const IND_MIN = 4;\r\n    let i;\r\n\r\n    let found = false;\r\n    for (i = this.m_numColors - IND_MIN; i > IND_MIN; i--) {\r\n      if (this.m_histogram[i] > valMin) {\r\n        if ((this.m_histogram[i] > this.m_histogram[i - 2]) && \r\n          (this.m_histogram[i] > this.m_histogram[i + 2])) {\r\n          found = true; break;\r\n        } // if local maximum\r\n      } // if mor min\r\n    } // for (i)\r\n    if (!found) {\r\n      console.log(`getLastMaxIndex. Not found!`);\r\n      return -1;\r\n    }\r\n    return i;\r\n\r\n  } // end get last max index\r\n\r\n  //\r\n  //\r\n  getMaxPeak() {\r\n    this.m_peakIndex = -1;\r\n    let i;\r\n    const hist = this.m_histogram;\r\n    const MIN_SCAN = 12;\r\n    const MAX_SCAN = this.m_numColors - 4;\r\n    let maxPeakVal = 0;\r\n    for (i = MAX_SCAN; i > MIN_SCAN; i--) {\r\n      if ((hist[i] > hist[i - 1]) && (hist[i] > hist[i + 1]) && \r\n        (hist[i] > hist[i - 2]) && (hist[i] > hist[i + 2])) {\r\n        const peakVal = hist[i];\r\n        if (peakVal > maxPeakVal) {\r\n          maxPeakVal = peakVal;\r\n          this.m_peakIndex = i;\r\n        }\r\n        // console.log(`Local histogram peak in ${this.m_peakIndex}`);\r\n      } // if (ha slocal peak)\r\n    } // for (all colors to scan) \r\n  }\r\n\r\n  smoothHistogram(sigma = 1.2, needNormalize = true) {\r\n    const SIZE_DIV = 60;\r\n    let RAD = Math.floor(this.m_numColors / SIZE_DIV);\r\n    // avoid too large neighbourhood window size\r\n    const SIZE_LARGE = 32;\r\n    if (RAD > SIZE_LARGE) {\r\n      RAD = SIZE_LARGE;\r\n    }\r\n    // console.log(`smoothHistogram. RAD = ${RAD}`);\r\n\r\n    const KOEF = 1.0 / (2 * sigma * sigma);\r\n    const newHist = new Array(this.m_numColors);\r\n    let i;\r\n    let maxVal = 0;\r\n    for (i = 0; i < this.m_numColors; i++) {\r\n      let sum = 0;\r\n      let sumW = 0;\r\n      for (let di = -RAD; di <= RAD; di++) {\r\n        const ii = i + di;\r\n        const t = di / RAD;\r\n        const w = Math.exp(-t * t * KOEF);\r\n        if ((ii >= 0) && (ii < this.m_numColors)) {\r\n          sum += this.m_histogram[ii] * w;\r\n          sumW += w;\r\n        }\r\n      }\r\n      sum /= sumW;\r\n      maxVal = (sum > maxVal) ? sum : maxVal;\r\n\r\n      newHist[i] = sum;\r\n    } // for (i)\r\n    // copy back to hist\r\n    if (needNormalize) {\r\n      for (i = 0; i < this.m_numColors; i++) {\r\n        this.m_histogram[i] = newHist[i] / maxVal;\r\n      } // for (i)\r\n    } else {\r\n      for (i = 0; i < this.m_numColors; i++) {\r\n        this.m_histogram[i] = newHist[i];\r\n      } // for (i)\r\n    }\r\n  } // smoothHistogram\r\n\r\n  onMouseDown(evt) {\r\n    if ((this.m_transfFuncCallback === undefined) ||\r\n      (this.m_transfFuncUpdateCallback === undefined)) {\r\n      return;\r\n    }\r\n    const box = this.refs.canvasHistogram.getBoundingClientRect();\r\n    const xScr = evt.clientX - box.left;\r\n    const yScr = evt.clientY - box.top;\r\n    const needRender = this.m_transfFunc.onMouseDown(xScr, yScr);\r\n    if (needRender) {\r\n      this.forceRender();\r\n    }\r\n  }\r\n\r\n  onMouseUp(evt) {\r\n    if ((this.m_transfFuncCallback === undefined) ||\r\n      (this.m_transfFuncUpdateCallback === undefined)) {\r\n      return;\r\n    }\r\n    const box = this.refs.canvasHistogram.getBoundingClientRect();\r\n    const xScr = evt.clientX - box.left;\r\n    const yScr = evt.clientY - box.top;\r\n    const needRender = this.m_transfFunc.onMouseUp(xScr, yScr);\r\n    if (needRender) {\r\n      this.forceRender();\r\n    }\r\n  }\r\n\r\n  onMouseMove(evt) {\r\n    if ((this.m_transfFuncCallback === undefined) ||\r\n      (this.m_transfFuncUpdateCallback === undefined)) {\r\n      return;\r\n    }\r\n    const box = this.refs.canvasHistogram.getBoundingClientRect();\r\n    const xScr = evt.clientX - box.left;\r\n    const yScr = evt.clientY - box.top;\r\n    const needRender = this.m_transfFunc.onMouseMove(xScr, yScr);\r\n    if (needRender) {\r\n      this.forceRender();\r\n    }\r\n  }\r\n\r\n  updateCanvas() {\r\n    if (this.refs.canvasHistogram === undefined) {\r\n      return;\r\n    }\r\n    const ctx = this.refs.canvasHistogram.getContext('2d');\r\n    const w = this.refs.canvasHistogram.clientWidth;\r\n    const h = this.refs.canvasHistogram.clientHeight;\r\n    ctx.fillStyle = 'rgb(220, 220, 220)';\r\n    ctx.fillRect(0,0, w, h);\r\n\r\n    // was 300 * 250\r\n    // console.log(`updateCanvas. canvas dim = ${w} * ${h}`); \r\n\r\n    const vol = this.props.volume;\r\n    if (vol !== null) {\r\n      this.getVolumeHistogram(vol);\r\n    }\r\n\r\n    // rect inside\r\n    // const xMin = Math.floor(0.10 * w);\r\n    // const xMax = Math.floor(0.95 * w);\r\n    const xMin = Math.floor(0.01 * w);\r\n    const xMax = Math.floor(0.99 * w);\r\n    const yMin = Math.floor(0.05 * h);\r\n    const yMax = Math.floor(0.95 * h);\r\n    const wRect = xMax - xMin;\r\n    const hRect = yMax - yMin;\r\n\r\n    ctx.lineWidth = 1;\r\n    ctx.strokeStyle = '#0a0a0a';\r\n\r\n    ctx.moveTo(xMin, yMax);\r\n    ctx.lineTo(xMin, yMin);\r\n    ctx.stroke();\r\n\r\n    ctx.moveTo(xMin, yMax);\r\n    ctx.lineTo(xMax, yMax);\r\n    ctx.stroke();\r\n\r\n    ctx.font = '10px Arial';\r\n    ctx.fillStyle = 'rgb(120, 20, 20)';\r\n    ctx.textBaseline = 'top';\r\n    ctx.textAlign = 'center';\r\n\r\n    // detect max visible value in hist\r\n    let maxHistValue = 1.0;\r\n    if (this.m_peakIndex > 0) {\r\n      maxHistValue = this.m_histogram[this.m_peakIndex] * 2;\r\n      maxHistValue = (maxHistValue > 1.0) ? 1.0 : maxHistValue;\r\n    }\r\n\r\n    // draw marks horizontal\r\n    let i;\r\n    const NUM_X_MARKS = 4;\r\n    for (i = 0; i <= NUM_X_MARKS; i++) {\r\n      const x = xMin + Math.floor(wRect * i / NUM_X_MARKS);\r\n      ctx.moveTo(x, yMax);\r\n      ctx.lineTo(x, yMax + 6);\r\n      ctx.stroke();\r\n      const valMark = Math.floor(0 + this.m_numColors * i / NUM_X_MARKS);\r\n      if (i === 0) {\r\n        ctx.textAlign = 'left';\r\n      } else if (i === NUM_X_MARKS) {\r\n        ctx.textAlign = 'right';\r\n      } else {\r\n        ctx.textAlign = 'center';\r\n      }\r\n      ctx.fillText(valMark.toString(), x, yMax + 4);\r\n    }\r\n    // draw marks vertical\r\n    if (NEED_TO_DRAW_VERTICAL_MARKS) {\r\n      ctx.textBaseline = 'bottom';\r\n      ctx.textAlign = 'left';\r\n      ctx.fillStyle = 'rgb(120, 60, 60)';\r\n      const NUM_Y_MARKS = 4;\r\n      for (i = 0; i <= NUM_Y_MARKS; i++) {\r\n        if (i === NUM_Y_MARKS) {\r\n          ctx.textBaseline = 'top';\r\n        }\r\n        const y = yMax - Math.floor(hRect * i / NUM_Y_MARKS);\r\n        ctx.moveTo(xMin, y);\r\n        ctx.lineTo(xMin - 4, y);\r\n        ctx.stroke();\r\n        const valMark = (0 + maxHistValue * i / NUM_Y_MARKS);\r\n        ctx.fillText(valMark.toFixed(2), xMin + 6, y);\r\n      }\r\n    }\r\n\r\n    ctx.lineWidth = 2;\r\n    ctx.strokeStyle = '#080808';\r\n    ctx.fillStyle = '#707070';\r\n    // draw histogram function line\r\n    ctx.beginPath();\r\n    {\r\n      ctx.moveTo(xMin, yMax);\r\n      let i;\r\n      let x, y;\r\n      for (i = 0; i < this.m_numColors; i++) {\r\n        x = xMin + Math.floor(wRect * i / this.m_numColors);\r\n        let v = this.m_histogram[i] / maxHistValue;\r\n        v = (v >= 1.0) ? 1.0 : v;\r\n        y = yMax - Math.floor(hRect * v);\r\n        ctx.lineTo(x, y);\r\n      } // for (i) all colors\r\n      y = yMax;\r\n      ctx.lineTo(x, y);\r\n    }\r\n    ctx.closePath();\r\n    ctx.fill();\r\n    // draw peak\r\n    if (this.m_peakIndex > 0) {\r\n      ctx.lineWidth = 1;\r\n      ctx.strokeStyle = '#eeeeee';\r\n      const x = xMin + Math.floor(wRect * this.m_peakIndex / this.m_numColors);\r\n      let v = this.m_histogram[this.m_peakIndex] / maxHistValue;\r\n      v = (v >= 1.0) ? 1.0 : v;\r\n      let y = yMax - Math.floor(hRect * v);\r\n      ctx.beginPath();\r\n      ctx.setLineDash([5, 15]);\r\n      ctx.moveTo(x, y);\r\n      y = yMax;\r\n      ctx.lineTo(x, y);\r\n      ctx.stroke();\r\n      ctx.setLineDash([]);\r\n    }\r\n    // render points and lines for modified transfer fucntion\r\n    if ((this.m_transfFuncCallback !== undefined) &&\r\n      (this.m_transfFuncUpdateCallback !== undefined)) {\r\n      this.m_transfFunc.render(ctx, xMin, yMin, wRect, hRect);\r\n    }\r\n  } // end update canvas\r\n\r\n  forceRender() {\r\n    this.setState({ state: this.state });\r\n    if (this.m_transfFuncCallback !== undefined) {\r\n      this.m_transfFuncCallback(this.m_transfFunc);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    const vol = this.props.volume;\r\n    if (vol === undefined) {\r\n      return <p>UiHistogram.props volume is not defined !!!</p>;\r\n    }\r\n    if (vol === null) {\r\n      return <p></p>;\r\n    }\r\n    this.m_transfFuncCallback = this.props.transfFunc;\r\n    this.m_transfFuncUpdateCallback = this.props.transfFuncUpdate;\r\n  \r\n    const cw = this.state.width;\r\n    const ch = this.state.height;\r\n\r\n    const jsxHist = \r\n      <div ref={ (mount) => {this.m_canvasOwner = mount} }>\r\n        <canvas ref=\"canvasHistogram\" width={cw} height={ch} \r\n          onMouseDown={this.onMouseDown} onMouseUp={this.onMouseUp} onMouseMove={this.onMouseMove} />\r\n      </div>;\r\n    return jsxHist;\r\n  }\r\n}\r\n","/**\r\n * @fileOverview UiTF\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\n// special css for NoUiSlioder\r\nimport 'nouislider/distribute/nouislider.css';\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { ListGroup } from 'react-bootstrap';\r\n\r\nimport Nouislider from 'react-nouislider';\r\nimport StoreActionType from '../store/ActionTypes';\r\nimport UiHistogram from './UiHistogram';\r\n\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n/**\r\n * Class UiTF some text later...\r\n */\r\nclass UiTF extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n    //this.onUndo = this.onUndo.bind(this);\r\n    this.m_updateEnable = true;\r\n    this.onAO = this.onAO.bind(this);\r\n    this.offAO = this.offAO.bind(this);\r\n    this.onStartEr = this.onStartEr.bind(this);\r\n    this.onStopEr = this.onStopEr.bind(this);\r\n    this.onUndo = this.onUndo.bind(this); \r\n    this.onSave = this.onSave.bind(this); \r\n  }\r\n\r\n  onAO() {\r\n    const store = this.props;\r\n    const isoThreshold = store.sliderIsosurface;//this.refs.sliderIsosurface.slider.get();\r\n    store.volumeRenderer.setAmbientTextureMode(isoThreshold);\r\n  }\r\n\r\n  offAO() {\r\n    const store = this.props;\r\n    store.volumeRenderer.offAmbientTextureMode();\r\n  }\r\n\r\n  onStartEr() {\r\n    const store = this.props;\r\n    store.volumeRenderer.setEraserStart(true);\r\n  }\r\n\r\n  onStopEr() {\r\n    const store = this.props;\r\n    store.volumeRenderer.setEraserStart(false);\r\n  }\r\n\r\n  onUndo() {\r\n    const store = this.props;\r\n    store.volumeRenderer.undoEraser();\r\n  }\r\n\r\n  onSave() {\r\n    const store = this.props;\r\n    store.volumeRenderer.volumeUpdater.updateVolumeTextureWithMask();\r\n    console.log(`onSave`);\r\n  }\r\n\r\n  onChangeSliderTF() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderTF.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_3DR, slider3d_r: Number.parseFloat(aval[0]) });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_3DG, slider3d_g: Number.parseFloat(aval[1]) });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_3DB, slider3d_b: Number.parseFloat(aval[2]) });\r\n  }\r\n\r\n  shouldComponentUpdate(nextProps) {\r\n    //return this.m_updateEnable;\r\n    let flag = this.m_updateEnable;\r\n    if (this.props.mode3d !== nextProps.mode3d) {\r\n      flag = true;\r\n    }\r\n    return flag;\r\n    //return true;\r\n  }\r\n\r\n  onChangeSliderOpacity() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderOpacity.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Opacity, sliderOpacity: Number.parseFloat(aval) });\r\n  }\r\n\r\n  onChangeSliderIsosurface() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderIsosurface.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Isosurface, sliderIsosurface: Number.parseFloat(aval) });\r\n  }\r\n\r\n  onChangeSliderErRadius() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderErRadius.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_ErRadius, sliderErRadius: Number.parseFloat(aval) });\r\n  }\r\n\r\n  onChangeSliderErDepth() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderErDepth.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_ErDepth, sliderErDepth: Number.parseFloat(aval) });\r\n  }\r\n\r\n  transferFuncCallback(transfFuncObj) {\r\n    const i = transfFuncObj.m_indexMoved;\r\n    const x = transfFuncObj.m_handleX[i];\r\n    const y = transfFuncObj.m_handleY[i];\r\n    console.log(`moved point[${i}] = ${x}, ${y}  `);\r\n  }\r\n\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    const store = this.props;\r\n    const mode3d = store.mode3d;\r\n    const slider3dr = store.slider3d_r;\r\n    const slider3dg = store.slider3d_g;\r\n    const slider3db = store.slider3d_b;\r\n    const sliderOpacity = store.sliderOpacity;\r\n    const sliderIsosurface = store.sliderIsosurface;\r\n    const sliderErRadius = store.sliderErRadius;\r\n    const sliderErDepth = store.sliderErDepth;\r\n    const wArr = [slider3dr, slider3dg, slider3db];\r\n    const wArrOpacity = [sliderOpacity];\r\n    const wArrIsosurface = [sliderIsosurface];\r\n    const wArrErRadius = [sliderErRadius];\r\n    const wArrErDepth = [sliderErDepth];\r\n\r\n    let vol = null;\r\n    const volSet = store.volumeSet;\r\n    if (volSet.getNumVolumes() > 0) {\r\n      const volIndex = store.volumeIndex;\r\n      vol = volSet.getVolume(volIndex);\r\n    }\r\n\r\n    const NEED_TANSF_FUNC = true;\r\n    const funcTra = (NEED_TANSF_FUNC) ? this.transferFuncCallback : undefined;\r\n    //store.volumeRenderer.updateTransferFuncTexture(this.m_transfFunc.m_handleX, this.m_transfFunc.m_handleY);\r\n    /*\r\n    const styleObj = {\r\n      margin: '30px 0px 0px'\r\n    };\r\n    */\r\n    const jsxVolumeTF =\r\n    <ListGroup>\r\n      <ListGroup.Item>\r\n        <UiHistogram volume={vol} transfFunc={funcTra} />\r\n      </ListGroup.Item>\r\n      <ListGroup.Item>\r\n        <p> Set </p>\r\n        <Nouislider onSlide={this.onChangeSliderTF.bind(this)} ref={'sliderTF'}\r\n          range={{ min: 0.0, max: 1.0 }}\r\n          start={wArr} connect={[false, true, false, true]} step={0.02} tooltips={true} />\r\n      </ListGroup.Item>\r\n      <ListGroup.Item>\r\n        <p> Opacity </p>\r\n        <Nouislider onSlide={this.onChangeSliderOpacity.bind(this)} ref={'sliderOpacity'}\r\n          range={{ min: 0.0, max: 1.0 }}\r\n          start={wArrOpacity} connect={[true, false]} step={0.02} tooltips={true} />\r\n      </ListGroup.Item>\r\n    </ListGroup>;\r\n\r\n    const jsxIsoTF =\r\n      <ul className=\"list-group\">\r\n        <li className=\"list-group-item\">\r\n          <UiHistogram volume={vol} transfFunc={funcTra}  />\r\n        </li>\r\n        <li className=\"list-group-item\">\r\n          <p> Isosurface </p>\r\n          <Nouislider onSlide={this.onChangeSliderIsosurface.bind(this)} ref={'sliderIsosurface'}\r\n            range={{ min: 0.0, max: 1.0 }}\r\n            start={wArrIsosurface} connect={[true, false]} step={0.02} tooltips={true} />\r\n        </li>\r\n        <li className=\"list-group-item\">\r\n          Ambient Oclusion -> \r\n          <button type=\"button\" className={'btn btn-outline-dark'} onClick={this.onAO} >\r\n            On\r\n          </button>\r\n          <button type=\"button\" className={'btn btn-outline-dark'} onClick={this.offAO} >\r\n            Off\r\n          </button>\r\n          <button type=\"button\" className={'btn btn-outline-dark'} onClick={this.onAO} >\r\n            Reset\r\n          </button>\r\n        </li>\r\n      </ul>\r\n    const jsxEreaser =\r\n      <div className=\"card\">\r\n        <div className=\"card-header\">\r\n          Press Control + Mouse Down [+ Mouse Move] for erease\r\n        </div>\r\n        <ul className=\"list-group list-group-flush\">\r\n          <li className=\"list-group-item\">\r\n            <p> Radius </p>\r\n            <Nouislider onSlide={this.onChangeSliderErRadius.bind(this)} ref={'sliderErRadius'}\r\n              range={{ min: 1.0, max: 100.0 }}\r\n              start={wArrErRadius} connect={[true, false]} step={0.02} tooltips={true} />\r\n          </li>\r\n          <li className=\"list-group-item\">\r\n            <p> Depth </p>\r\n            <Nouislider onSlide={this.onChangeSliderErDepth.bind(this)} ref={'sliderErDepth'}\r\n              range={{ min: 1.0, max: 100.0 }}\r\n              start={wArrErDepth} connect={[true, false]} step={0.02} tooltips={true} />\r\n          </li>\r\n          <li className=\"list-group-item\">\r\n            <p> Isosurface </p>\r\n            <Nouislider onSlide={this.onChangeSliderIsosurface.bind(this)} ref={'sliderIsosurface'}\r\n              range={{ min: 0.0, max: 1.0 }}\r\n              start={wArrIsosurface} connect={[true, false]} step={0.02} tooltips={true} />\r\n          </li>\r\n          <li className=\"list-group-item\">\r\n            <button type=\"button\" className={'btn btn-outline-dark'} onClick={this.onUndo} >\r\n              Undo\r\n            </button>\r\n            <button type=\"button\" className={'btn btn-outline-dark'} onClick={this.onSave} >\r\n              Save\r\n            </button>\r\n          </li>\r\n        </ul>\r\n      </div>\r\n\r\n    const jsxRayfastTF = null\r\n\r\n    console.log(`UiTF . mode = ${mode3d}`);\r\n    const jsxArray = [jsxIsoTF, jsxVolumeTF, jsxRayfastTF, jsxEreaser];\r\n    const jsxRet = jsxArray[mode3d];\r\n    return jsxRet;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiTF);\r\n","/**\r\n * @fileOverview UiTF\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\n// special css for NoUiSlioder\r\nimport 'nouislider/distribute/nouislider.css';\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport Nouislider from 'react-nouislider';\r\nimport StoreActionType from '../store/ActionTypes';\r\n\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n/**\r\n * Class UiTF some text later...\r\n */\r\nclass UiTFroi extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n    this.m_updateEnable = true;\r\n  }\r\n\r\n  shouldComponentUpdate(nextProps) {\r\n    //return this.m_updateEnable;\r\n    let flag = this.m_updateEnable;\r\n    if (this.props.mode3d !== nextProps.mode3d) {\r\n      flag = true;\r\n    }\r\n    return flag;\r\n  }\r\n\r\n  onChangeSliderTF() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderTF.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_3DR, slider3d_r: Number.parseFloat(aval[0]) });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_3DG, slider3d_g: Number.parseFloat(aval[1]) });\r\n  }\r\n\r\n  onChangeSliderOpacity() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderOpacity.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Opacity, sliderOpacity: Number.parseFloat(aval) });\r\n  }\r\n\r\n  onChangeSliderIsosurface() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderIsosurface.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Isosurface, sliderIsosurface: Number.parseFloat(aval) });\r\n  }\r\n\r\n  /**\r\n   * Main component render func callback\r\n    const jsxRet = jsxArray[mode3d];\r\n   */\r\n  render() {\r\n    const store = this.props;\r\n    let mode3d = store.mode3d;\r\n    if (mode3d > 1) {\r\n      mode3d = 1;\r\n    }\r\n    const slider3dr = store.slider3d_r;\r\n    const slider3dg = store.slider3d_g;\r\n    const wArr = [slider3dr, slider3dg];\r\n    const sliderOpacity = store.sliderOpacity;\r\n    const sliderIsosurface = store.sliderIsosurface;\r\n    const wArrOpacity = [sliderOpacity];\r\n    const wArrIsosurface = [sliderIsosurface];\r\n\r\n    const jsxVolumeTF =\r\n      <ul className=\"list-group\" >\r\n        <li className=\"list-group-item\">\r\n          <Nouislider onSlide={this.onChangeSliderTF.bind(this)} ref={'sliderTF'}\r\n            range={{ min: 0.0, max: 1.0 }}\r\n            start={wArr} connect={[false, true, false]} step={0.02} tooltips={true} />\r\n        </li>\r\n        <li className=\"list-group-item\">\r\n          <p> Opacity </p>\r\n          <Nouislider onSlide={this.onChangeSliderOpacity.bind(this)} ref={'sliderOpacity'}\r\n            range={{ min: 0.0, max: 1.0 }}\r\n            start={wArrOpacity} connect={[false, true]} step={0.02} tooltips={true} />\r\n        </li>\r\n      </ul>\r\n    const jsxIsoTF =\r\n      <ul className=\"list-group\">\r\n        <li className=\"list-group-item\">\r\n          <p> Isosurface </p>\r\n          <Nouislider onSlide={this.onChangeSliderIsosurface.bind(this)} ref={'sliderIsosurface'}\r\n            range={{ min: 0.0, max: 1.0 }}\r\n            start={wArrIsosurface} connect={[false, true]} step={0.02} tooltips={true} />\r\n        </li>\r\n      </ul>\r\n    const jsxArray = [jsxIsoTF, jsxVolumeTF];\r\n    const jsxRet = jsxArray[1];\r\n    return jsxRet;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiTFroi);\r\n","/**\r\n * @fileOverview UiRoiSelect\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { Form, Card } from 'react-bootstrap';\r\nimport { Row, Col } from 'react-bootstrap';\r\n\r\nimport RoiPalette from '../engine/loaders/roipalette';\r\n\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\nclass UiRoiSelect extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.m_setRoiFunc = undefined;\r\n\r\n    this.onChangeSelectAll = this.onChangeSelectAll.bind(this);\r\n    this.onChangeRoiIndi = this.onChangeRoiIndi.bind(this);\r\n\r\n    this.m_roiPalette = new RoiPalette();\r\n    const arrPal = this.m_roiPalette.getPalette();\r\n    const numPalElems = arrPal.length;\r\n    \r\n    const NUM_PAL_ELEMS = 94;\r\n    if (numPalElems !== NUM_PAL_ELEMS) {\r\n      console.log(`numPalElems = ${numPalElems}, but expected = ${NUM_PAL_ELEMS} `);\r\n    }\r\n\r\n    const arrState = arrPal.map( (elem) => {\r\n      const ename = elem.name;\r\n      const ecolor = elem.roiColor;\r\n      const eid = elem.roiId;\r\n      const eposition = elem.position;\r\n\r\n      const arrColor = ecolor.split(' ');\r\n      const rCol = Math.floor(arrColor[0] * 255);\r\n      const gCol = Math.floor(arrColor[1] * 255);\r\n      const bCol = Math.floor(arrColor[2] * 255);\r\n      const strCol = '#' + rCol.toString(16) + gCol.toString(16) + bCol.toString(16);\r\n      // console.log(`palElem = ${strCol} `);\r\n\r\n      const obj  = {\r\n        name: ename,\r\n        color: ecolor,\r\n        strColor: strCol,\r\n        id: eid,\r\n        position: eposition,\r\n        selected: false,\r\n      };\r\n      // console.log(`palElem = ${obj.name}, ${rcol}, ${rid}, ${posi} `);\r\n      return obj;\r\n    });\r\n    this.state = {\r\n      allSelected: false,\r\n      checkboxes: arrState,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * On change individual\r\n   * \r\n   * @param {object} evt - event\r\n   */\r\n  onChangeRoiIndi(evt) {\r\n    // obj is type: HTMLInputElement\r\n    const obj = evt.target;\r\n    const isCheck = obj.checked;\r\n    const id = Number.parseInt(obj.id);\r\n    const ind = this.state.checkboxes.findIndex( elem => {\r\n      const isEq = (elem.id === id);\r\n      return isEq;\r\n    });\r\n    // console.log(`id = ${id}`);\r\n    // console.log(`ind = ${ind}`);\r\n    // console.log(`isCheck = ${isCheck}`);\r\n\r\n    const arrStates = this.state.checkboxes;\r\n    if (ind >= 0) {\r\n      arrStates[ind].selected = isCheck;\r\n      this.setState({ checkboxes: arrStates });\r\n\r\n      if (this.m_setRoiFunc !== undefined) {\r\n        this.m_setRoiFunc(arrStates);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On select all chech box event handler\r\n   * \r\n   * @param {object} evt  - event\r\n   */\r\n  onChangeSelectAll(evt) {\r\n    const isCheck = evt.target.checked;\r\n    // console.log(`isCheck = ${isCheck}`);\r\n    const arrStates = this.state.checkboxes;\r\n    const numElems = arrStates.length;\r\n    for (let i = 0; i < numElems; i++) {\r\n      arrStates[i].selected = isCheck;\r\n    }\r\n    this.setState({ checkboxes: arrStates });\r\n    this.setState({ allSelected: isCheck });\r\n    if (this.m_setRoiFunc !== undefined) {\r\n      this.m_setRoiFunc(arrStates);\r\n    }\r\n  }\r\n\r\n  render() {\r\n    this.m_setRoiFunc = this.props.setRoiFunc;\r\n    const isAllSel = this.state.allSelected;\r\n    const strSel = (isAllSel) ? 'Select none' : 'Select all';\r\n    const jsxRoiCard =\r\n      <Card style={{ height: '350px', 'overflowY': 'auto' }}>\r\n        <Card.Body>\r\n          <Card.Title>\r\n            ROI Selector\r\n          </Card.Title>\r\n          <Form.Group controlId=\"ROI selector\">\r\n            <Form.Check type=\"checkbox\" key=\"selall\" label={strSel} onChange={this.onChangeSelectAll}/>\r\n            {this.state.checkboxes.map(elem => {\r\n              const strCol = elem.strColor;\r\n              const obj = \r\n                  <Row key={elem.id} id={elem.id} >\r\n                    <Col xs lg=\"11\">\r\n                      <Form.Check type=\"checkbox\" label={elem.name} key={elem.id}\r\n                        id={elem.id}\r\n                        checked={elem.selected}\r\n                        onChange={this.onChangeRoiIndi} />\r\n                    </Col>\r\n                    <Col xs lg=\"1\">\r\n                      <i className=\"fa fa-square\" style={{ 'color': strCol }}>  </i>\r\n                    </Col>\r\n                  </Row>\r\n              return obj;\r\n            })}\r\n          </Form.Group>\r\n        </Card.Body>\r\n      </Card>;\r\n\r\n    return jsxRoiCard;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiRoiSelect);\r\n","/**\r\n * @fileOverview UiCtrl3dLight\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\n// special css for NoUiSlioder\r\nimport 'nouislider/distribute/nouislider.css';\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { Card, ListGroup, Button, ButtonGroup } from 'react-bootstrap';\r\nimport { OverlayTrigger, Tooltip } from 'react-bootstrap';\r\n\r\n//import Nouislider from 'react-nouislider';\r\n\r\nimport Modes3d from '../store/Modes3d';\r\nimport Modes3droi from '../store/Modes3droi';\r\nimport StoreActionType from '../store/ActionTypes';\r\nimport UiTF from './UiTF';\r\nimport UiTFroi from './UiTFroi';\r\nimport UiRoiSelect from './UiRoiSelect';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiCtrl3dLight some text later...\r\n */\r\nclass UiCtrl3dLight extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.onModeA = this.onModeA.bind(this);\r\n    this.onModeB = this.onModeB.bind(this);\r\n    this.onModeC = this.onModeC.bind(this);\r\n    this.onModeD = this.onModeD.bind(this);\r\n    this.onMode = this.onMode.bind(this);\r\n    this.onModeroi = this.onModeroi.bind(this);\r\n    this.m_updateEnable = true;\r\n  }\r\n\r\n  onMode(indexMode) {\r\n    this.m_updateEnable = true;\r\n    this.props.dispatch({ type: StoreActionType.SET_MODE_3D, mode3d: indexMode });\r\n    const store = this.props;\r\n    store.volumeRenderer.offAmbientTextureMode();\r\n  }\r\n\r\n  onModeA() {\r\n    this.onMode(Modes3d.ISO);\r\n    this.props.volumeRenderer.setEraserMode(false);\r\n  }\r\n\r\n  onModeB() {\r\n    this.onMode(Modes3d.RAYCAST);\r\n    this.props.volumeRenderer.setEraserMode(false);\r\n  }\r\n\r\n  onModeC() {\r\n    this.onMode(Modes3d.RAYFAST);\r\n    this.props.volumeRenderer.setEraserMode(false);\r\n  }\r\n\r\n  onModeD() {\r\n    this.onMode(Modes3d.EREASER);\r\n    this.props.volumeRenderer.setEraserMode(true);\r\n  }\r\n\r\n  onModeroi(indexMode) {\r\n    this.m_updateEnable = true;\r\n    this.props.dispatch({ type: StoreActionType.SET_MODE_3Droi, mode3droi: indexMode });\r\n  }\r\n\r\n  onModeAroi() {\r\n    this.onModeroi(Modes3droi.ISO);\r\n  }\r\n\r\n  onModeBroi() {\r\n    this.onModeroi(Modes3droi.RAYCAST);\r\n  }\r\n\r\n  shouldComponentUpdate() {\r\n    return this.m_updateEnable;\r\n    //return true;\r\n  }\r\n\r\n  /**\r\n   * Callback, invoked after any ROI setup array change\r\n   * \r\n   * @param {object} arrayRoi - array of objects with props: id, name, selected, see (UiRoiSelect)\r\n   */\r\n  setRoi(arrayRoi) {\r\n    // This is demo code:\r\n    // just print all states of all roi elements, according to the UI\r\n    const numElems = arrayRoi.length;\r\n    const store = this.props;\r\n    const MAXELEM = 256;\r\n    const selectedROI = new Uint8Array(MAXELEM);\r\n    //const BYTES_IN_COLOR = 4;\r\n    for (let i = 0; i < MAXELEM; i++) {\r\n      selectedROI[i] = false;\r\n    }\r\n    for (let i = 0; i < numElems; i++) {\r\n      const id = arrayRoi[i].id;\r\n      const name = arrayRoi[i].name;\r\n      const isSel = arrayRoi[i].selected;\r\n      selectedROI[id] = isSel;\r\n      console.log(`setRoi: [${i}]: name=${name} id= ${id} isSel=${isSel} `);\r\n    }\r\n    store.volumeRenderer.updateSelectedRoiMap(selectedROI);\r\n  }\r\n\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    const store = this.props;\r\n    const mode3d = store.mode3d;\r\n    // const mode3droi = store.mode3droi;\r\n\r\n    const strA = (mode3d === Modes3d.ISO) ? 'primary' : 'secondary';\r\n    const strB = (mode3d === Modes3d.RAYCAST) ? 'primary' : 'secondary';\r\n    const strC = (mode3d === Modes3d.RAYFAST) ? 'primary' : 'secondary';\r\n    const strD = (mode3d === Modes3d.ERASER) ? 'primary' : 'secondary';\r\n    // const strAroi = (mode3droi === Modes3droi.ISO) ? 'primary' : 'secondary';\r\n    // const strBroi = (mode3droi === Modes3droi.RAYCAST) ? 'primary' : 'secondary';\r\n\r\n    const jsxRenderControls =\r\n      <div>\r\n        <Card>\r\n          <Card.Title>\r\n            3d mode selection\r\n          </Card.Title>\r\n          <Card.Body>\r\n\r\n            <ButtonGroup>\r\n              <OverlayTrigger key=\"iso\" placement=\"bottom\" overlay={\r\n                <Tooltip>\r\n                  Show just barrier value surface, 1st ray intersection\r\n                </Tooltip>\r\n              }>\r\n                <Button variant={strA} onClick={this.onModeA}  >\r\n                  Iso\r\n                </Button>\r\n              </OverlayTrigger>\r\n\r\n              <OverlayTrigger key=\"vre\" placement=\"bottom\" overlay={\r\n                <Tooltip>\r\n                  Show complete 3d volumetric rendering\r\n                </Tooltip>\r\n              }>\r\n                <Button variant={strB} onClick={this.onModeB} >\r\n                  Vol\r\n                </Button>\r\n              </OverlayTrigger>\r\n\r\n              <OverlayTrigger key=\"maxproj\" placement=\"bottom\" overlay={\r\n                <Tooltip>\r\n                  Show maximum projection rendering\r\n                </Tooltip>\r\n              }>\r\n                <Button variant={strC} onClick={this.onModeC} >\r\n                  MaxPrj\r\n                </Button>\r\n              </OverlayTrigger>\r\n\r\n              <OverlayTrigger key=\"volera\" placement=\"bottom\" overlay={\r\n                <Tooltip>\r\n                  Special volume eraser tool\r\n                </Tooltip>\r\n              }>\r\n                <Button variant={strD} onClick={this.onModeD} >\r\n                  Eraser\r\n                </Button>\r\n              </OverlayTrigger>\r\n\r\n            </ButtonGroup>\r\n\r\n          </Card.Body>\r\n        </Card>\r\n        <UiTF />\r\n      </div>\r\n\r\n    const jsxROI =\r\n      <ListGroup as=\"ul\" variant=\"flush\">\r\n\r\n        <ListGroup.Item as=\"li\">\r\n          <UiRoiSelect setRoiFunc={this.setRoi}/>\r\n        </ListGroup.Item>\r\n\r\n        <UiTFroi/>\r\n      </ListGroup>\r\n    let indx = 0;\r\n\r\n    const volSet = store.volumeSet;\r\n    if (volSet.getNumVolumes() > 0) {\r\n      const volIndex = store.volumeIndex;\r\n      const vol = volSet.getVolume(volIndex);\r\n\r\n      const FOUR = 4;\r\n      if (vol.m_bytesPerVoxel === FOUR) {\r\n        indx = 1;\r\n      }\r\n    } // end if more 0 volumes\r\n    const jsxArray = [jsxRenderControls, jsxROI];\r\n    const jsxRet = jsxArray[indx];\r\n    return jsxRet;\r\n\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiCtrl3dLight);\r\n\r\n","/**\r\n * @fileOverview UiCtrl3dLight\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\n// special css for NoUiSlioder\r\nimport 'nouislider/distribute/nouislider.css';\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport Nouislider from 'react-nouislider';\r\nimport StoreActionType from '../store/ActionTypes';\r\nimport UiHistogram from './UiHistogram';\r\n\r\n/**\r\n * Class UiCtrl3dLight some text later...\r\n */\r\nclass UiCtrl3d extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.transferFuncCallback = this.transferFuncCallback.bind(this);\r\n    this.m_updateEnable = true;\r\n  }\r\n\r\n  onChangeSliderOpacity() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderOpacity.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Opacity, sliderOpacity: Number.parseFloat(aval) });\r\n  }\r\n\r\n  shouldComponentUpdate() {\r\n    return this.m_updateEnable;\r\n    //return true;\r\n  }\r\n\r\n  transferFuncCallback(transfFuncObj) {\r\n    const i = transfFuncObj.m_indexMoved;\r\n    const x = transfFuncObj.m_handleX[i];\r\n    const y = transfFuncObj.m_handleY[i];\r\n    console.log(`moved point[${i}] = ${x}, ${y}  `);\r\n    const vr = this.props.volumeRenderer;\r\n    vr.updateTransferFuncTexture(transfFuncObj.m_handleX, transfFuncObj.m_handleY);\r\n  }\r\n\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    const store = this.props;\r\n    const sliderOpacity = store.sliderOpacity;\r\n    const wArrOpacity = [sliderOpacity];\r\n\r\n    const volSet = store.volumeSet;\r\n    const volIndex = store.volumeIndex;\r\n    const vol = volSet.getVolume(volIndex);\r\n\r\n    const NEED_TANSF_FUNC = true;\r\n    const funcTra = (NEED_TANSF_FUNC) ? this.transferFuncCallback : undefined;\r\n    const funcTrTex = (store.volumeRenderer === null) ? null : store.volumeRenderer;    \r\n    //const store = this.props;\r\n    //const mode3d = store.mode3d;\r\n\r\n\r\n    // console.log(`UiCtr3dLight. render. flags = ${bCheckedSag}+${bCheckedCor}+${bCheckedTra}`);\r\n\r\n    // btn-default active\r\n\r\n    const jsxRenderControls =\r\n    <ul className=\"list-group\" >\r\n      <li className=\"list-group-item\">\r\n        <UiHistogram volume={vol}  transfFunc={funcTra} transfFuncUpdate={funcTrTex}/>\r\n      </li>\r\n      <li className=\"list-group-item\">\r\n        <p> Opacity </p>\r\n        <Nouislider onSlide={this.onChangeSliderOpacity.bind(this)} ref={'sliderOpacity'}\r\n          range={{ min: 0.0, max: 1.0 }}\r\n          start={wArrOpacity} connect={[true, false]} step={0.02} tooltips={true} />\r\n      </li>\r\n    </ul>\r\n    return jsxRenderControls;\r\n\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiCtrl3d);\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n// import * as THREE from 'three';\r\n\r\n/**\r\n* OpenGL, WebGL renderer selector\r\n* @module lib/scripts/graphics3d/glselector\r\n*/\r\n\r\nexport default class GlSelector {\r\n  /** constructor: defines fields\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_useWebGL2 = undefined;\r\n  }\r\n\r\n  /** Create compatible canvas\r\n   *\r\n   */\r\n  createWebGLContext() {\r\n    this.canvas = document.createElementNS('http://www.w3.org/1999/xhtml', 'canvas');\r\n    let context = this.canvas.getContext('webgl2');\r\n    this.m_useWebGL2 = 1;\r\n    if (context == null) {\r\n      console.log('WebGL 2 not supported, moving to webgl 1');\r\n      context = this.canvas.getContext('webgl');\r\n      this.m_useWebGL2 = 0;\r\n    } else {\r\n      console.log('WebGL 2 context created');\r\n    }\r\n    return context;\r\n  }\r\n\r\n  /** return canvas */\r\n  getCanvas() {\r\n    return this.canvas;\r\n  }\r\n\r\n  /** Create compatible canvas\r\n   *\r\n   */\r\n  useWebGL2() {\r\n    return this.m_useWebGL2;\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Orbit control\r\n* @module lib/scripts/controls/orbitcontrol\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\n// import MaterialVlm from '../gfx/matvlm';\r\n\r\n// const CONTROL_CAMERA_MIN_ZOOM = 1.1;\r\nconst CONTROL_CAMERA_MIN_ZOOM = 0.3;\r\nconst CONTROL_CAMERA_MAX_ZOOM = 2.5;\r\nconst CONTROL_CAMERA_ROTATION_SPEED = 0.008;\r\nconst CONTROL_CAMERA_ZOOM_SPEED = 0.2;\r\n\r\n// ******************************************************************\r\n// class\r\n// ******************************************************************\r\n\r\n/** Class Graphics2d is used for simple debug style 2d render */\r\nexport default class OrbitControl {\r\n\r\n  /**\r\n  * Initialize render\r\n  * @return {Object} Intsance of this class (singleton)\r\n  */\r\n  constructor(domElem, camera, scene, mesh, meshRotationCallback) {\r\n    this.m_callback = meshRotationCallback;\r\n    this.m_mesh = mesh;\r\n    this.m_wireMesh = null;\r\n    this.m_camera = camera;\r\n    this.m_target = new THREE.Vector3(0, 0, 0);\r\n    this.m_scene = scene;\r\n    this.m_button = OrbitControl.EVENT_BUTTON_NA;\r\n    this.domElem = domElem;\r\n    this.m_pressedLeft = false;\r\n    this.m_pressedRight = false;\r\n    this.m_prevMouse = { x: -1, y: -1 };\r\n    this.m_prevTime = -1;\r\n    this.m_deltaTime = 0;\r\n    this.m_spherical = new THREE.Spherical();\r\n    this.m_sphericalDelta = new THREE.Spherical();\r\n    this.m_spherical.set(0, 0, 0);\r\n    this.m_sphericalDelta.set(0, 0, 0);\r\n    this.m_autoRotate = false;\r\n\r\n    this.m_minDistance = CONTROL_CAMERA_MIN_ZOOM;\r\n    this.m_maxDistance = CONTROL_CAMERA_MAX_ZOOM;\r\n\r\n    this.m_minAzimuthAngle = -Infinity; // radians\r\n    this.m_maxAzimuthAngle = Infinity; // radians\r\n    // How far you can orbit vertically, upper and lower limits.\r\n    // Range is 0 to Math.PI radians.\r\n    this.m_minPolarAngle = 0; // radians\r\n    // eslint-disable-next-line\r\n    this.m_maxPolarAngle = Math.PI * 2.0; // radians\r\n\r\n    // Set to true to enable damping (inertia)\r\n    // If damping is enabled, you must call controls.update() in your animation loop\r\n    this.m_enableDamping = false;\r\n    this.m_dampingFactor = 0.25;\r\n    //console.log(`Mouse container: ${this.m_container.offsetLeft}, ${this.m_container.offsetTop}`);\r\n    this.isEraserMode = false;\r\n  }\r\n\r\n  setEraserMode(isOn) {\r\n    this.isEraserMode = isOn;\r\n  }\r\n\r\n  setMesh(mesh) {\r\n    this.m_mesh = mesh;\r\n  }\r\n\r\n  setWireMesh(wireMesh) {\r\n    this.m_wireMesh = wireMesh;\r\n  }\r\n\r\n  setScene(scene) {\r\n    this.m_scene = scene;\r\n  }\r\n\r\n  getX(xx) {\r\n    return xx - this.domElem.offsetLeft;\r\n  }\r\n\r\n  getY(yy) {\r\n    return yy - this.domElem.offsetTop;\r\n  }\r\n\r\n  // updateTime(dx, dy, useCallback = true) {\r\n  updateTime(dx, dy) {\r\n    if (dx === 0 && dy === 0) {\r\n      return;\r\n    }\r\n    // time update\r\n    const curTimeMs = new Date().getTime();\r\n    this.m_prevTime = (this.m_prevTime > 0) ? this.m_prevTime : curTimeMs;\r\n    this.m_deltaTime = curTimeMs - this.m_prevTime;\r\n    this.m_prevTime = curTimeMs;\r\n    if (!this.m_mesh) {\r\n      return;\r\n    }\r\n\r\n    // this.m_mesh.rotation.y += dx * CONTROL_CAMERA_ROTATION_SPEED;\r\n    // this.m_mesh.rotation.x += dy * CONTROL_CAMERA_ROTATION_SPEED;\r\n\r\n    const rotationY = new THREE.Matrix4();\r\n    const rotationX = new THREE.Matrix4();\r\n    const matrix = new THREE.Matrix4();\r\n    const camDir = new THREE.Vector3();\r\n\r\n    camDir.copy(this.m_target).sub(this.m_camera.position).normalize();\r\n    rotationX.makeRotationAxis(this.m_camera.up, dx * CONTROL_CAMERA_ROTATION_SPEED);\r\n    rotationY.makeRotationAxis(camDir.cross(this.m_camera.up), dy * CONTROL_CAMERA_ROTATION_SPEED);\r\n    matrix.identity();\r\n    matrix.multiply(rotationX).multiply(rotationY).multiply(this.m_mesh.matrix);\r\n\r\n    this.m_mesh.rotation.setFromRotationMatrix(matrix);\r\n    if (this.m_wireMesh) {\r\n      matrix.identity();\r\n      matrix.multiply(rotationX).multiply(rotationY).multiply(this.m_wireMesh.matrix);\r\n      this.m_wireMesh.rotation.setFromRotationMatrix(matrix);\r\n    }\r\n    this.m_callback();\r\n  }\r\n\r\n  onMouseDown(xMouse, yMouse, ctrlKey) {\r\n    this.m_pressedLeft = true;\r\n    this.m_prevMouse = { x: xMouse, y: yMouse };\r\n    this.m_spherical.set(0, 0, 0);\r\n    this.m_sphericalDelta.set(0, 0, 0);\r\n    this.m_prevTime = new Date().getTime();// -1;\r\n    this.ctrlKey = ctrlKey;\r\n  }\r\n\r\n  onMouseUp() {\r\n    this.m_pressedLeft = false;\r\n    this.m_prevMouse.x = -1;\r\n    this.m_prevMouse.y = -1;\r\n  }\r\n\r\n  onMouseMove(x, y) {\r\n    if (this.m_prevMouse.x < 0) {\r\n      this.m_prevMouse.x = x;\r\n      this.m_prevMouse.y = y;\r\n    }\r\n    const dx = x - this.m_prevMouse.x;\r\n    const dy = y - this.m_prevMouse.y;\r\n    // const dx = 1;\r\n    // const dy = 0;\r\n    this.m_prevMouse.x = x;\r\n    this.m_prevMouse.y = y;\r\n\r\n    if (this.m_pressedLeft) {\r\n      this.updateTime(dx, dy);\r\n    }\r\n  }\r\n\r\n  /*addCallbacks() {\r\n    this.m_container.on('mousedown', (event) => {\r\n      event = event || window.event;\r\n      const buttonIndex = event.which - 1;\r\n      this.m_button = buttonIndex;\r\n      // const arrButtonNames = ['Left', 'Center', 'Right'];\r\n      // console.log(`Mouse down event: ${arrButtonNames[buttonIndex]}`);\r\n      if (buttonIndex === OrbitControl.EVENT_BUTTON_LEFT) {\r\n      //console.log(\"X,Y: \"+this.getX(event.clientX)+ \" \"+ this.getY(event.clientY));\r\n        if (this.isEraserMode && event.ctrlKey) {\r\n          return;\r\n        }\r\n        this.onMouseDown(this.getX(event.clientX), this.getY(event.clientY));\r\n        // this.m_pressedLeft = true;\r\n        // this.m_prevMouse = { x: this.getX(event.clientX), y: this.getY(event.clientY) };\r\n        // this.m_spherical.set(0, 0, 0);\r\n        // this.m_sphericalDelta.set(0, 0, 0);\r\n        // this.m_prevTime = new Date().getTime();// -1;\r\n      }\r\n    });\r\n\r\n    this.m_container.on('mouseup', (event) => {\r\n      event = event || window.event;\r\n      const buttonIndex = event.which - 1;\r\n      this.m_button = buttonIndex;\r\n      if (buttonIndex === OrbitControl.EVENT_BUTTON_LEFT) {\r\n        if (this.isEraserMode && event.ctrlKey) {\r\n          return;\r\n        }\r\n        this.onMouseUp();\r\n        // this.m_pressedLeft = false;\r\n        // this.m_prevMouse.x = -1;\r\n        // this.m_prevMouse.y = -1;\r\n      }\r\n    });\r\n\r\n    this.m_container.on('mousemove', (event) => {\r\n      const x = this.getX(event.clientX);\r\n      const y = this.getY(event.clientY);\r\n      // console.log(`mouse move event at ${x}, ${y}`);\r\n      if (this.isEraserMode && event.ctrlKey) {\r\n        return;\r\n      }\r\n      this.onMouseMove(x, y);\r\n    });\r\n\r\n    this.m_container.on('mousewheel', (event) => {\r\n      const e = window.event || event; // old IE support\r\n      const delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));\r\n      // console.log(`mouse wheel event . delta = ${delta}`);\r\n      this.onZoom(delta);\r\n    });\r\n\r\n    this.m_container.on('touchstart', (event) => {\r\n      if (event.touches.length === 1) {\r\n        const domElem = this.m_container.get(0);\r\n        const box = domElem.getBoundingClientRect();\r\n        const d = domElem.ownerDocument.documentElement;\r\n        const scrLeft = box.left + window.pageXOffset - d.clientLeft;\r\n        const scrTop = box.top + window.pageYOffset - d.clientTop;\r\n        this.onMouseDown(event.touches[0].pageX - scrLeft, event.touches[0].pageY - scrTop);\r\n        // console.log(`touchstart: ${this.m_prevMouse.x},${this.m_prevMouse.y}`);\r\n      }\r\n    });*/\r\n  /*eslint-disable no-unused-vars*/\r\n  /*\r\n    this.m_container.on('touchend', (event) => {\r\n      this.onMouseUp();\r\n    });*/\r\n  /*eslint-enable no-unused-vars*/\r\n  /*\r\n    this.m_container.on('touchmove', (event) => {\r\n      const domElem = this.m_container.get(0);\r\n      const box = domElem.getBoundingClientRect();\r\n      const d = domElem.ownerDocument.documentElement;\r\n      const scrLeft = box.left + window.pageXOffset - d.clientLeft;\r\n      const scrTop = box.top + window.pageYOffset - d.clientTop;\r\n      const x = event.touches[0].pageX - scrLeft;\r\n      const y = event.touches[0].pageY - scrTop;\r\n      this.onMouseMove(x, y);\r\n    });\r\n\r\n    this.m_container.on('DOMMouseScroll', (event) => {\r\n      const e = window.event || event; // old IE support\r\n      const delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));\r\n      // console.log(`mouse scroll event . delta = ${delta}`);\r\n      this.onZoom(delta);\r\n    });\r\n  } // addCallbacks\r\n  */\r\n  onZoom(delta) {\r\n    const step = delta * CONTROL_CAMERA_ZOOM_SPEED;\r\n    let camPos = this.m_camera.position.length();\r\n    // console.log(`camPos = ${camPos}`);\r\n    const camDir = this.m_camera.position.sub(this.m_target);\r\n    // console.log(`camDirOld = ${camDir.x}, ${camDir.y}, ${camDir.z}`);\r\n    camDir.normalize();\r\n    camPos += step;\r\n    // console.log(`camPosNew = ${camPos}`);\r\n    camPos = Math.max(camPos, CONTROL_CAMERA_MIN_ZOOM);\r\n    camPos = Math.min(camPos, CONTROL_CAMERA_MAX_ZOOM);\r\n    // console.log(`camPosNewFixed = ${camPos}`);\r\n    camDir.multiplyScalar(camPos);\r\n    // console.log(`camDirNew = ${camDir.x}, ${camDir.y}, ${camDir.z}`);\r\n    this.m_camera.position.set(camDir.x, camDir.y, camDir.z);\r\n    this.m_camera.lookAt(this.m_target);\r\n    this.m_camera.updateMatrixWorld();\r\n  }\r\n\r\n} // class\r\n\r\nOrbitControl.EVENT_BUTTON_NA = -1;\r\nOrbitControl.EVENT_BUTTON_LEFT = 0;\r\nOrbitControl.EVENT_BUTTON_CENTER = 1;\r\nOrbitControl.EVENT_BUTTON_RIGHT = 2;\r\n","export default __webpack_public_path__ + \"static/media/backface.3dc9d515.vert\";","export default __webpack_public_path__ + \"static/media/backface.84a75448.frag\";","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Backface material, used for cube backface rendering\r\n* @module lib/scripts/gfx/matbackface\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\nimport BACK_FACE_VERTEX_SHADER from '../shaders/backface.vert';\r\nimport BACK_FACE_FRAGMENT_SHADER from '../shaders/backface.frag';\r\n\r\n/** Class @class MaterialBF for volume backface rendering */\r\nexport default class MaterialBF {\r\n  /** Backface material constructor\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n  }\r\n\r\n  /** Backface material constructor\r\n  * @return {object} Three.js material with this shader\r\n  */\r\n  create(callbackMat) {\r\n    // Init uniforms\r\n\r\n    // create shader loaders\r\n    const vertexLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    vertexLoader.setResponseType('text');\r\n    const fragmentLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    fragmentLoader.setResponseType('text');\r\n\r\n    vertexLoader.load(BACK_FACE_VERTEX_SHADER, (strVertexSh) => {\r\n      this.m_strShaderVertex = strVertexSh;\r\n      // console.log(`Load callback success. text = : ${strVertexSh} ...`);\r\n      fragmentLoader.load(BACK_FACE_FRAGMENT_SHADER, (strFragmentSh) => {\r\n        this.m_strShaderFragment = strFragmentSh;\r\n\r\n        // log\r\n        // {\r\n        //   const strLoaded = JSON.stringify(this.m_strShaderVertex);\r\n        //   console.log(`Readed vertex shader is: ${strLoaded} ...`);\r\n        // }\r\n\r\n        const material = new THREE.ShaderMaterial({\r\n          vertexShader: this.m_strShaderVertex,\r\n          fragmentShader: this.m_strShaderFragment,\r\n          side: THREE.BackSide,\r\n          depthTest: true,\r\n          depthFunc: THREE.GreaterEqualDepth,\r\n          blending: THREE.NoBlending,\r\n        });\r\n        if (callbackMat) {\r\n          callbackMat(material);\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n","export default __webpack_public_path__ + \"static/media/frontface.6197e7b1.vert\";","export default __webpack_public_path__ + \"static/media/frontface.7ecf0644.frag\";","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Frontface material, used for cube frontface rendering\r\n* @module lib/scripts/gfx/matfrontface\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\nimport FRONT_FACE_VERTEX_SHADER from '../shaders/frontface.vert'\r\nimport FRONT_FACE_FRAGMENT_SHADER from '../shaders/frontface.frag'\r\n\r\n\r\n/** Class @class MaterialFF for volume frontface rendering */\r\nexport default class MaterialFF {\r\n  /** Frontface material constructor\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n    this.m_uniforms = {\r\n      texBF: { type: 't', value: null },\r\n      PlaneX: { type: 'v4', value: new THREE.Vector4(-1.0, 0.0, 0.0, 0.5) },\r\n      PlaneY: { type: 'v4', value: new THREE.Vector4(0.0, -1.0, 0.0, 0.5) },\r\n      PlaneZ: { type: 'v4', value: new THREE.Vector4(0.0, 0.0, -1.0, 0.5) },\r\n    };\r\n  }\r\n\r\n  /** Frontface material constructor\r\n  * @return {object} Three.js material with this shader\r\n  */\r\n  create(textureBF, callbackMat) {\r\n    // Init uniforms    \r\n    this.m_uniforms.texBF.value = textureBF;\r\n    // create shader loaders\r\n    const vertexLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    vertexLoader.setResponseType('text');\r\n    const fragmentLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    fragmentLoader.setResponseType('text');\r\n    vertexLoader.load(FRONT_FACE_VERTEX_SHADER, (strVertexSh) => {\r\n      this.m_strShaderVertex = strVertexSh;\r\n      //console.log(`Load callback success. text = : ${strVertexSh} ...`);\r\n      fragmentLoader.load(FRONT_FACE_FRAGMENT_SHADER, (strFragmentSh) => {\r\n        this.m_strShaderFragment = strFragmentSh;\r\n\r\n        const NEED_LOG = false;\r\n        if (NEED_LOG) {\r\n          const strLoadedVert = JSON.stringify(this.m_strShaderVertex);\r\n          console.log(`Readed vertex shader is: ${strLoadedVert} ...`);\r\n          const strLoadedFrag = JSON.stringify(this.m_strShaderFragment);\r\n          console.log(`Readed fragment shader is: ${strLoadedFrag} ...`);\r\n        }\r\n        const material = new THREE.ShaderMaterial({\r\n          uniforms: this.m_uniforms,\r\n          vertexShader: this.m_strShaderVertex,\r\n          fragmentShader: this.m_strShaderFragment,\r\n          side: THREE.FrontSide,\r\n          depthTest: true,\r\n          depthFunc: THREE.LessEqualDepth,\r\n          blending: THREE.NoBlending,\r\n        });\r\n        if (callbackMat) {\r\n          callbackMat(material);\r\n        }\r\n      },\r\n      /*(strFragmentSh) => {},*/\r\n      (e) => {\r\n        console.log(\"Shader load failed! because of error \" + e.target.status + \", \" + e.target.statusText);\r\n      });\r\n    });\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Material to enable back/front face culling with wireframe geom\r\n* @module lib/scripts/gfx/matwireframecull\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\n/** Class @class MaterialWC back/front face culling with wireframe rendering */\r\nexport default class MaterialWC {\r\n\r\n  /** Wireframe material constructor\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n    this.m_defines = {\r\n      backCullMode: 1,\r\n    };\r\n    this.m_uniforms = {\r\n      texBF: { type: 't', value: null },\r\n      texFF: { type: 't', value: null },\r\n    };\r\n  }\r\n\r\n  /** Wireframe material constructor\r\n  * @return {object} Three.js material with this shader\r\n  */\r\n  create(textureBF, textureFF) {\r\n    // Init uniforms\r\n    this.m_uniforms.texBF.value = textureBF;\r\n    this.m_uniforms.texFF.value = textureFF;\r\n\r\n    this.m_strShaderVertex = `\r\n      varying vec3 pos;\r\n      attribute vec3 uvw;\r\n      varying vec4 screenpos;\r\n      void main() {\r\n        pos = uvw;\r\n        screenpos = (projectionMatrix  * modelViewMatrix * vec4(position, 1.0));\r\n        gl_Position =  screenpos;\r\n      }\r\n    `;\r\n    this.m_strShaderFragment = `\r\n      precision highp float;\r\n      precision highp int;\r\n      uniform sampler2D texFF;\r\n      uniform sampler2D texBF;\r\n\r\n      varying vec3 pos;\r\n      varying vec4 screenpos;\r\n      void main() {\r\n      vec2 tc = screenpos.xy / screenpos.w * 0.5 + 0.5;\r\n      vec3 back  = texture2D(texBF, tc, 0.0).xyz;\r\n      vec3 front = texture2D(texFF, tc, 0.0).xyz;\r\n      float cullvalue = length(pos - back) - length(front - back);\r\n\r\n\r\n      #if backCullMode == 1\r\n        if (cullvalue < -0.001)\r\n          discard;\r\n      #endif\r\n      #if backCullMode == 0\r\n        if (cullvalue > 0.001)\r\n          discard;\r\n      #endif\r\n\r\n        gl_FragColor = vec4(0.5, 0.0, 1.0, 1.0);\r\n        //gl_FragColor = vec4(cullvalue, cullvalue, cullvalue, 1.0);\r\n        //gl_FragColor = vec4(front, 1.0);\r\n      }\r\n    `;\r\n    const material = new THREE.ShaderMaterial({\r\n      uniforms: this.m_uniforms,\r\n      defines: this.m_defines,\r\n      vertexShader: this.m_strShaderVertex,\r\n      fragmentShader: this.m_strShaderFragment,\r\n      side: THREE.FrontSide,\r\n      wireframe: true,\r\n      depthTest: false,\r\n      polygonOffset: false,\r\n      polygonOffsetFactor: -4.0,\r\n      polygonOffsetUnits: -4.0,\r\n    });\r\n    return material;\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Material to map texture using screen positions of the fragments\r\n* @module lib/scripts/gfx/matscreentexmapping\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\n/** Class @class MaterialScreenTexMap to aux backface texture rendering for the\r\n *  frontface geometry to avoid z-fighting\r\n */\r\nexport default class MaterialScreenTexMap {\r\n  /** Wireframe material constructor\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n\r\n    this.m_uniforms = {\r\n      texBuffer: { type: 't', value: null },\r\n    };\r\n  }\r\n\r\n  /** material constructor\r\n  * @return {object} Three.js material with this shader\r\n  */\r\n  create(texBuffer) {\r\n    // Init uniforms\r\n    this.m_uniforms.texBuffer.value = texBuffer;\r\n    this.m_strShaderVertex = `\r\n      varying vec4 screenpos;\r\n      void main() {\r\n        screenpos = (projectionMatrix  * modelViewMatrix * vec4(position, 1.0));\r\n        gl_Position =  screenpos;\r\n      }\r\n    `;\r\n    this.m_strShaderFragment = `\r\n      precision highp float;\r\n      precision highp int;\r\n      uniform sampler2D texBuffer;\r\n\r\n      varying vec4 screenpos;\r\n      void main() {\r\n        vec2 tc = screenpos.xy / screenpos.w * 0.5 + 0.5;\r\n        gl_FragColor = texture2D(texBuffer, tc, 0.0);\r\n      }\r\n    `;\r\n    const material = new THREE.ShaderMaterial({\r\n      uniforms: this.m_uniforms,\r\n      vertexShader: this.m_strShaderVertex,\r\n      fragmentShader: this.m_strShaderFragment,\r\n      side: THREE.FrontSide,\r\n      depthTest: true,\r\n      depthFunc: THREE.LessEqualDepth,\r\n      blending: THREE.NoBlending,\r\n    });\r\n    return material;\r\n  }\r\n}\r\n","export default __webpack_public_path__ + \"static/media/clipplane.7ba65be0.vert\";","export default __webpack_public_path__ + \"static/media/clipplane.d594e568.frag\";","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Clipping plane material, used for rendering of near camera plane as a part ray-casting pipeline\r\n* @module lib/scripts/gfx/matcliplane\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\nimport CLIP_VERTEX_SHADER from '../shaders/clipplane.vert';\r\nimport CLIP_FRAGMENT_SHADER from '../shaders/clipplane.frag';\r\n\r\n/** Class @class MaterialClipPlane for volume clip plane rendering */\r\nexport default class MaterialClipPlane {\r\n  /** ClipPlane material constructor\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n    this.m_uniforms = {\r\n      MVP: { type: 'm4' },\r\n      texBF: { type: 't' },\r\n    };\r\n  }\r\n\r\n  /** Frontface material constructor\r\n  * @return {object} Three.js material with this shader\r\n  */\r\n  create(textureBF, callbackMat) {\r\n    // Init uniforms\r\n    this.m_uniforms.texBF.value = textureBF;\r\n    // create shader loaders\r\n    const vertexLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    vertexLoader.setResponseType('text');\r\n    const fragmentLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    fragmentLoader.setResponseType('text');\r\n\r\n    vertexLoader.load(CLIP_VERTEX_SHADER, (strVertexSh) => {\r\n      this.m_strShaderVertex = strVertexSh;\r\n      // console.log(`Load callback success. text = : ${strVertexSh} ...`);\r\n      fragmentLoader.load(CLIP_FRAGMENT_SHADER, (strFragmentSh) => {\r\n        this.m_strShaderFragment = strFragmentSh;\r\n\r\n        // log\r\n        // {\r\n        //   const strLoaded = JSON.stringify(this.m_strShaderVertex);\r\n        //   console.log(`Readed vertex shader is: ${strLoaded} ...`);\r\n        // }\r\n\r\n        const material = new THREE.ShaderMaterial({\r\n          uniforms: this.m_uniforms,\r\n          vertexShader: this.m_strShaderVertex,\r\n          fragmentShader: this.m_strShaderFragment,\r\n          side: THREE.DoubleSide,\r\n          depthTest: false,\r\n          depthWrite: false,\r\n        });\r\n        if (callbackMat) {\r\n          callbackMat(material);\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n","export default __webpack_public_path__ + \"static/media/rendertotexture.b51229d9.vert\";","export default __webpack_public_path__ + \"static/media/rendertotexture.f0ef0a21.frag\";","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Low resolution isosurface rendering material for CT dataset\r\n* @module lib/scripts/gfx/matrendertotexture\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\nimport RENDER_TEXTURE_VERTEX_SHADER from '../shaders/rendertotexture.vert';\r\nimport RENDER_TEXTURE_FRAGMENT_SHADER from '../shaders/rendertotexture.frag';\r\n\r\n/** Class @class MaterialRenderToTexture for\r\n* rough isosurface computation: a ray-casting optimization\r\n*/\r\nexport default class MaterialRenderToTexture {\r\n  /** Simple material constructor\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n    this.m_uniforms = {\r\n      texTF: { type: 't', value: null },\r\n      texVolume: { type: 't', value: null },\r\n      texRoiId: { type: 't', value: null },\r\n      texRoiColor: { type: 't', value: null },\r\n      RoiVolumeTex: { type: 't', value: null },\r\n      texVolumeMask: { type: 't', value: null },\r\n      texVolumeAO: { type: 't', value: null },\r\n      lightDir: { type: 'v3', value: new THREE.Vector3(0.0, 0.0, 0.0) },\r\n      texBF: { type: 't', value: null },\r\n      texFF: { type: 't', value: null },\r\n      t_function1min: { type: 'v4', value: new THREE.Vector4(0.0, 0.0, 0.0, 0.0) },\r\n      t_function1max: { type: 'v4', value: new THREE.Vector4(0.0, 0.0, 0.0, 0.0) },\r\n      t_function2min: { type: 'v4', value: new THREE.Vector4(0.0, 0.0, 0.0, 0.0) },\r\n      t_function2max: { type: 'v4', value: new THREE.Vector4(0.0, 0.0, 0.0, 0.0) },\r\n      stepSize: { type: 'v4', value: new THREE.Vector4(0.0, 0.0, 0.0, 0.0) },\r\n      texSize: { type: 'f', value: 0.0 },\r\n      isoThreshold: { type: 'f', value: 0.0 },\r\n      brightness3D: { type: 'f', value: 0.0 },\r\n      contrast3D: { type: 'f', value: 0.0 },\r\n      colorMap1D: { type: 't', value: null },\r\n      heatMap1D: { type: 't', value: null },\r\n      opacityBarrier: { type: 'f', value: 0.0 },\r\n      tileCountX: { type: 'f', value: 0.0 },\r\n      volumeSizeZ: { type: 'f', value: 0.0 },\r\n      xDim: { type: 'f', value: 0.0 },\r\n      yDim: { type: 'f', value: 0.0 },\r\n      zDim: { type: 'f', value: 0.0 },\r\n      ssaoOffsets: { type: 'v3v' },\r\n    };\r\n    this.m_defines = {\r\n      isoRenderFlag: 0,\r\n      MaskFlag: 0,\r\n      useAmbientTex: 0,\r\n      useWebGL2: 1,\r\n    };\r\n  }\r\n\r\n  /** Simple material constructor\r\n  * @return {object} Three.js material with this shader\r\n  */\r\n  create(texTF, texVol2d, texVolMask, texVolAO, texBackface, texFrontface, offsets, callbackMat) {\r\n    // Init uniforms\r\n    this.m_uniforms.texTF.value = texTF;\r\n    this.m_uniforms.texVolume.value = texVol2d;\r\n    this.m_uniforms.texVolumeMask.value = texVolMask;\r\n    this.m_uniforms.texVolumeAO.value = texVolAO;\r\n    this.m_uniforms.texBF.value = texBackface;\r\n    this.m_uniforms.texFF.value = texFrontface;\r\n    this.m_uniforms.ssaoOffsets.value = offsets;\r\n    // create shader loaders\r\n    const vertexLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    vertexLoader.setResponseType('text');\r\n    const fragmentLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    fragmentLoader.setResponseType('text');\r\n\r\n    vertexLoader.load(RENDER_TEXTURE_VERTEX_SHADER, (strVertexSh) => {\r\n      this.m_strShaderVertex = strVertexSh;\r\n      // console.log(`Load callback success. text = : ${strVertexSh} ...`);\r\n      fragmentLoader.load(RENDER_TEXTURE_FRAGMENT_SHADER, (strFragmentSh) => {\r\n        this.m_strShaderFragment = strFragmentSh;\r\n\r\n        const material = new THREE.ShaderMaterial({\r\n          uniforms: this.m_uniforms,\r\n          defines: this.m_defines,\r\n          vertexShader: this.m_strShaderVertex,\r\n          fragmentShader: this.m_strShaderFragment,\r\n          side: THREE.BackSide,\r\n          depthTest: true,\r\n          depthFunc: THREE.GreaterEqualDepth,\r\n          blending: THREE.NoBlending,\r\n        });\r\n        if (callbackMat) {\r\n          callbackMat(material);\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n","export default __webpack_public_path__ + \"static/media/interpolation.ae2f2bf4.vert\";","export default __webpack_public_path__ + \"static/media/interpolation.b65fb94f.frag\";","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Final isosurface rendering material for CT dataset\r\n* @module lib/scripts/gfx/matinterpolation\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\nimport INTERP_VERTEX_SHADER from '../shaders/interpolation.vert';\r\nimport INTERP_FRAGMENT_SHADER from '../shaders/interpolation.frag';\r\n\r\n/** Class @class MaterialVolumeRender for create skull volume render shader material */\r\nexport default class MaterialInterpolation {\r\n\r\n  /** Simple material constructor\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n    this.m_uniforms = {\r\n      isoSurfTexel: { type: 'v2', value: null },\r\n      texIsoSurface: { type: 't', value: null },\r\n    };\r\n    this.m_defines = {\r\n      isoRenderFlag: 0,\r\n    };\r\n  }\r\n\r\n  /** Simple material constructor\r\n  * @return {object} Three.js material with this shader\r\n  */\r\n  create(renderTexture, callbackMat) {\r\n    // Init uniforms\r\n    this.m_uniforms.texIsoSurface.value = renderTexture;\r\n\r\n    // create shader loaders\r\n    const vertexLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    vertexLoader.setResponseType('text');\r\n    const fragmentLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    fragmentLoader.setResponseType('text');\r\n\r\n    vertexLoader.load(INTERP_VERTEX_SHADER, (strVertexSh) => {\r\n      this.m_strShaderVertex = strVertexSh;\r\n      // console.log(`Load callback success. text = : ${strVertexSh} ...`);\r\n      fragmentLoader.load(INTERP_FRAGMENT_SHADER, (strFragmentSh) => {\r\n        this.m_strShaderFragment = strFragmentSh;\r\n\r\n        // log\r\n        // {\r\n        //   const strLoaded = JSON.stringify(this.m_strShaderVertex);\r\n        //   console.log(`Readed vertex shader is: ${strLoaded} ...`);\r\n        // }\r\n\r\n        const material = new THREE.ShaderMaterial({\r\n          uniforms: this.m_uniforms,\r\n          defines: this.m_defines,\r\n          vertexShader: this.m_strShaderVertex,\r\n          fragmentShader: this.m_strShaderFragment,\r\n          side: THREE.BackSide\r\n        });\r\n        if (callbackMat) {\r\n          callbackMat(material);\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n","export default __webpack_public_path__ + \"static/media/volumerender.0fdf551f.vert\";","export default __webpack_public_path__ + \"static/media/volumerender.fb827430.frag\";","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Final isosurface rendering material for CT dataset\r\n* @module lib/scripts/gfx/matvolumerender\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\nimport VOL_RENDER_VERTEX_SHADER from '../shaders/volumerender.vert';\r\nimport VOL_RENDER_FRAGMENT_SHADER from '../shaders/volumerender.frag';\r\n\r\n/** Class @class MaterialVolumeRender for create skull volume render shader material */\r\nexport default class MaterialVolumeRender {\r\n\r\n  /** Simple material constructor\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n    this.m_uniforms = {\r\n      isoSurfTexel: { type: 'v2', value: null },\r\n      lightDir: { type: 'v3', value: new THREE.Vector3(0.0, 0.0, 0.0) },\r\n      texTF: { type: 't', value: null },\r\n      texVolume: { value: null },\r\n      texRoiId: { type: 't', value: null },\r\n      texRoiColor: { type: 't', value: null },\r\n      RoiVolumeTex: { type: 't', value: null },\r\n      texVolumeMask: { type: 't', value: null },\r\n      texVolumeAO: { type: 't', value: null },\r\n      texBF: { type: 't', value: null },\r\n      texFF: { type: 't', value: null },\r\n      texIsoSurface: { type: 't', value: null },\r\n      colorMap1D: { type: 't', value: null },\r\n      heatMap1D: { type: 't', value: null },\r\n      t_function1min: { type: 'v4', value: new THREE.Vector4(0.0, 0.0, 0.0, 0.0) },\r\n      t_function1max: { type: 'v4', value: new THREE.Vector4(0.0, 0.0, 0.0, 0.0) },\r\n      t_function2min: { type: 'v4', value: new THREE.Vector4(0.0, 0.0, 0.0, 0.0) },\r\n      t_function2max: { type: 'v4', value: new THREE.Vector4(0.0, 0.0, 0.0, 0.0) },\r\n      stepSize: { type: 'v4', value: new THREE.Vector4(0.0, 0.0, 0.0, 0.0) },\r\n      texSize: { type: 'f', value: 0.0 },\r\n      isoThreshold: { type: 'f', value: 0.0 },\r\n      brightness3D: { type: 'f', value: 0.0 },\r\n      contrast3D: { type: 'f', value: 0.0 },\r\n      tileCountX: { type: 'f', value: 0.0 },\r\n      volumeSizeZ: { type: 'f', value: 0.0 },\r\n      opacityBarrier: { type: 'f', value: 0.0 },\r\n      xDim: { type: 'f', value: 0.0 },\r\n      yDim: { type: 'f', value: 0.0 },\r\n      zDim: { type: 'f', value: 0.0 },\r\n      ssaoOffsets: { type: 'v3v' },\r\n    };\r\n    this.m_defines = {\r\n      isoRenderFlag: 0,\r\n      MaskFlag: 0,\r\n      useAmbientTex: 0,\r\n      useWebGL2: 1,\r\n    };\r\n  }\r\n\r\n  /** Simple material constructor\r\n  * @return {object} Three.js material with this shader\r\n  */\r\n  create(texTF, texVol2d,\r\n    texVolMask, texVolAO, texBackface, texFrontface, renderTexture, offsets, callbackMat) {\r\n    // Init uniforms\r\n    this.m_uniforms.texTF.value = texTF;\r\n    this.m_uniforms.texVolume.value = texVol2d;\r\n    this.m_uniforms.texVolumeMask.value = texVolMask;\r\n    this.m_uniforms.texVolumeAO.value = texVolAO;\r\n    this.m_uniforms.texBF.value = texBackface;\r\n    this.m_uniforms.texFF.value = texFrontface;\r\n    this.m_uniforms.texIsoSurface.value = renderTexture;\r\n    this.m_uniforms.ssaoOffsets.value = offsets;\r\n\r\n    // create shader loaders\r\n    const vertexLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    vertexLoader.setResponseType('text');\r\n    const fragmentLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    fragmentLoader.setResponseType('text');\r\n\r\n    vertexLoader.load(VOL_RENDER_VERTEX_SHADER, (strVertexSh) => {\r\n      this.m_strShaderVertex = strVertexSh;\r\n      // console.log(`Load callback success. text = : ${strVertexSh} ...`);\r\n      fragmentLoader.load(VOL_RENDER_FRAGMENT_SHADER, (strFragmentSh) => {\r\n        this.m_strShaderFragment = strFragmentSh;\r\n\r\n        const material = new THREE.ShaderMaterial({\r\n          uniforms: this.m_uniforms,\r\n          defines: this.m_defines,\r\n          vertexShader: this.m_strShaderVertex,\r\n          fragmentShader: this.m_strShaderFragment,\r\n          side: THREE.BackSide,\r\n          depthTest: true,\r\n          depthFunc: THREE.GreaterEqualDepth,\r\n          blending: THREE.NoBlending,\r\n        });\r\n        if (callbackMat) {\r\n          callbackMat(material);\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n","export default __webpack_public_path__ + \"static/media/blur.a62df0a0.vert\";","export default __webpack_public_path__ + \"static/media/blur.d95db93c.frag\";","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Blur material, used for rendering of blurred volume slices\r\n* @module lib/scripts/gfx/matblur\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\nimport BLUR_VERTEX_SHADER from '../shaders/blur.vert';\r\nimport BLUR_FRAGMENT_SHADER from '../shaders/blur.frag';\r\n\r\n/** Class @class MaterialBlur for volume slice blurring */\r\nexport default class MaterialBlur {\r\n  /** Backface material constructor\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n    const TILE_COUNT_X = 16.0;\r\n    const VOL_SIZE_Z = 256.0;\r\n    const BLUR_SIGMA = 0.8;\r\n    const CONTRAST = 1.0;\r\n    const BRIGHTNESS = 0.0;\r\n    const SAVE_FLAG = true;\r\n    this.m_uniforms = {\r\n      texVolume: { type: 't', value: null },\r\n      texVolumeRoi: { type: 't', value: null },\r\n      texRoiColor: { type: 't', value: null },\r\n      texSegInUse: { type: 't', value: null },\r\n      texelSize: { type: 'v3', value: null },\r\n      tileCountX: { type: 'f', value: TILE_COUNT_X },\r\n      volumeSizeZ: { type: 'f', value: VOL_SIZE_Z },\r\n      xDim: { type: 'f', value: VOL_SIZE_Z },\r\n      yDim: { type: 'f', value: VOL_SIZE_Z },\r\n      blurSigma:   { type: 'f', value: BLUR_SIGMA },\r\n      contrast: { type: 'f', value: CONTRAST },\r\n      brightness: { type: 'f', value: BRIGHTNESS },\r\n      curZ: { type: 'f', value: 0.0 },\r\n      save_flag: { type: 'b', value: SAVE_FLAG }\r\n    };\r\n    this.m_defines = {\r\n      renderRoiMap: 0,\r\n      useWebGL2: 1,\r\n    };\r\n  }\r\n\r\n  /** Backface material constructor\r\n  * @return {object} Three.js material with this shader\r\n  */\r\n  create(texture, texRoi, texelSize, texRoiColor, texRoiId, callbackMat) {\r\n    // Init uniforms\r\n    this.m_uniforms.texVolume.value = texture;\r\n    this.m_uniforms.texVolume.value = texture;\r\n    this.m_uniforms.texVolumeRoi.value = texRoi;\r\n    this.m_uniforms.texRoiColor.value = texRoiColor;\r\n    this.m_uniforms.texSegInUse.value = texRoiId;\r\n    this.m_uniforms.texelSize.value = texelSize;\r\n    // create shader loaders\r\n    const vertexLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    vertexLoader.setResponseType('text');\r\n    const fragmentLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    fragmentLoader.setResponseType('text');\r\n\r\n    vertexLoader.load(BLUR_VERTEX_SHADER, (strVertexSh) => {\r\n      this.m_strShaderVertex = strVertexSh;\r\n      // console.log(`Load callback success. text = : ${strVertexSh} ...`);\r\n      fragmentLoader.load(BLUR_FRAGMENT_SHADER, (strFragmentSh) => {\r\n        this.m_strShaderFragment = strFragmentSh;\r\n\r\n        const material = new THREE.ShaderMaterial({\r\n          uniforms: this.m_uniforms,\r\n          defines: this.m_defines,\r\n          vertexShader: this.m_strShaderVertex,\r\n          fragmentShader: this.m_strShaderFragment\r\n        });\r\n        if (callbackMat) {\r\n          callbackMat(material);\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n","export default __webpack_public_path__ + \"static/media/createAO.a62df0a0.vert\";","export default __webpack_public_path__ + \"static/media/createAO.bae764f9.frag\";","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Blur material, used for rendering of blurred volume slices\r\n* @module lib/scripts/gfx/matblur\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\nimport AO_VERTEX_SHADER from '../shaders/createAO.vert';\r\nimport AO_FRAGMENT_SHADER from '../shaders/createAO.frag';\r\n\r\n/** Class @class MaterialBlur for volume slice blurring */\r\nexport default class MaterialAO {\r\n\r\n  /** Backface material constructor\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n    const TEX_SIZE = 256.0;\r\n    const TEXEL_SIZE_1_256 = 1.0 / TEX_SIZE;\r\n    const TILE_COUNT_X = 16.0;\r\n    const VOL_SIZE_Z = 256.0;\r\n    this.m_uniforms = {\r\n      texVolume: { type: 't', value: null },\r\n      vectorsTex: { type: 't', value: null },\r\n      texelSize: { type: 'v3', value: new THREE.Vector3(TEXEL_SIZE_1_256, TEXEL_SIZE_1_256, TEXEL_SIZE_1_256) },\r\n      tileCountX: { type: 'f', value: TILE_COUNT_X },\r\n      volumeSizeZ: { type: 'f', value: VOL_SIZE_Z },\r\n      xDim: { type: 'f', value: VOL_SIZE_Z },\r\n      yDim: { type: 'f', value: VOL_SIZE_Z },\r\n      curZ: { type: 'f', value: VOL_SIZE_Z },\r\n      isoThreshold: { type: 'f', value: VOL_SIZE_Z },\r\n      vectorsSize: { type: 'i', value: null },\r\n    };\r\n    this.m_defines = {\r\n      useWebGL2: 1,\r\n    };\r\n  }\r\n\r\n  /** Backface material constructor\r\n  * @return {object} Three.js material with this shader\r\n  */\r\n  create(texture, texelSize, vectorsTex, vectorsSize, isoThreshold, callbackMat) {\r\n    // Init uniforms\r\n    this.m_uniforms.texVolume.value = texture;\r\n    this.m_uniforms.vectorsTex.value = vectorsTex;\r\n    this.m_uniforms.texelSize.value = texelSize;\r\n    this.m_uniforms.vectorsSize.value = vectorsSize;\r\n    this.m_uniforms.isoThreshold.value = isoThreshold;\r\n    // create shader loaders\r\n    const vertexLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    vertexLoader.setResponseType('text');\r\n    const fragmentLoader = new THREE.FileLoader(THREE.DefaultLoadingManager);\r\n    fragmentLoader.setResponseType('text');\r\n\r\n    vertexLoader.load(AO_VERTEX_SHADER, (strVertexSh) => {\r\n      this.m_strShaderVertex = strVertexSh;\r\n      // console.log(`Load callback success. text = : ${strVertexSh} ...`);\r\n      fragmentLoader.load(AO_FRAGMENT_SHADER, (strFragmentSh) => {\r\n        this.m_strShaderFragment = strFragmentSh;\r\n\r\n        const material = new THREE.ShaderMaterial({\r\n          uniforms: this.m_uniforms,\r\n          defines: this.m_defines,\r\n          vertexShader: this.m_strShaderVertex,\r\n          fragmentShader: this.m_strShaderFragment\r\n        });\r\n        if (callbackMat) {\r\n          callbackMat(material);\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Simple point link\r\n* @module lib/scripts/actvolume/pointlink\r\n*/\r\n\r\n// absolute imports\r\nimport * as THREE from 'three';\r\n\r\n// relative imports\r\n// import PointLink from './pointlink';\r\n\r\n/**\r\n* Class PointLink define link entry\r\n* @class PointLink\r\n*/\r\nexport default class PointLink {\r\n  /**\r\n  * Init all internal data\r\n  * @constructs PointLink\r\n  */\r\n  constructor() {\r\n    this.m_point = new THREE.Vector3();\r\n    this.m_next = null;\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Simple point set with voxelization\r\n* @module lib/scripts/actvolume/pointset\r\n*/\r\n\r\n// absolute imports\r\n// import TetrahedronGenerator from 'tetra';\r\n\r\n// relative imports\r\nimport PointLink from './pointlink';\r\n\r\nconst PSET_NUM_VOXELS = 16;\r\nconst PSET_NUM_LINKS = (PSET_NUM_VOXELS * PSET_NUM_VOXELS * PSET_NUM_VOXELS);\r\n\r\n/**\r\n* Class PointSet define set of 3d points\r\n* @class PointSet\r\n*/\r\nexport default class PointSet {\r\n  /**\r\n  * Init all internal data\r\n  * @constructs PointSet\r\n  */\r\n  constructor(numPoints) {\r\n    this.create(numPoints);\r\n  }\r\n\r\n  /**\r\n  * create points set, not initialized\r\n  * @param {number} numPoints Number of points in set estimated\r\n  */\r\n  create(numPoints) {\r\n    this.m_numPoints = 0;\r\n    this.m_numAllocatedPoints = numPoints;\r\n    this.m_points = new Array(numPoints);\r\n    this.m_voxels = new Array(PSET_NUM_LINKS);\r\n    for (let i = 0; i < numPoints; i++) {\r\n      this.m_points[i] = new PointLink();\r\n      this.m_points[i].m_point.set(0.0, 0.0, 0.0);\r\n      this.m_points[i].m_next = null;\r\n    } // for (i) all points\r\n  }\r\n\r\n  getNumPoints() {\r\n    return this.m_numPoints;\r\n  }\r\n\r\n  findPointSlow(x, y, z) {\r\n    for (let i = 0; i < this.m_numPoints; i++) {\r\n      const dx = x - this.m_points[i].m_point.x;\r\n      const dy = y - this.m_points[i].m_point.y;\r\n      const dz = z - this.m_points[i].m_point.z;\r\n      const dist2 = dx * dx + dy * dy + dz * dz;\r\n      const TOO_SMALL = 1.0e-8;\r\n      if (dist2 < TOO_SMALL) {\r\n        return i;\r\n      }\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  /**\r\n  * Add point to set\r\n  * @param {number} x coordinate x\r\n  * @param {number} y coordinate y\r\n  * @param {number} z coordinate z\r\n  */\r\n  addPoint(x, y, z) {\r\n    const iSlow = this.findPointSlow(x, y, z);\r\n    // check if exist\r\n    if (iSlow >= 0) {\r\n      return iSlow;\r\n    }\r\n    // check allocated space\r\n    if (this.m_numPoints >= this.m_numAllocatedPoints) {\r\n      return -1;\r\n    }\r\n    // add new point\r\n    const index = this.m_numPoints;\r\n    this.m_points[index] = new PointLink();\r\n    this.m_points[index].m_point.set(x, y, z);\r\n    this.m_points[index].m_next = null;\r\n    this.m_numPoints++;\r\n    return index;\r\n  } // addPoint\r\n\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Triangle indices\r\n* @module lib/scripts/actvolume/triindices\r\n*/\r\n\r\n// absolute imports\r\n// import TetrahedronGenerator from 'tetra';\r\n\r\n// relative imports\r\n// import TriangleIndices from './triindices';\r\n\r\n/**\r\n* Class TriangleIndices define 3 indices of triangle\r\n* @class TriangleIndices\r\n*/\r\nexport default class TriangleIndices {\r\n  /**\r\n  * Init all internal data\r\n  * @constructs TriangleIndices\r\n  */\r\n  constructor(ia, ib, ic) {\r\n    const NUM_VERTS_IN_TRIANGLE = 3;\r\n    this.m_indices = new Int32Array(NUM_VERTS_IN_TRIANGLE);\r\n    this.m_indices[0] = ia;\r\n    this.m_indices[1] = ib;\r\n    this.m_indices[2] = ic;\r\n  }\r\n}  // TriangleIndices\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Triangle set\r\n* @module lib/scripts/actvolume/triangleset\r\n*/\r\n\r\n// absolute imports\r\n// import TetrahedronGenerator from 'tetra';\r\n\r\n// relative imports\r\nimport TriangleIndices from './triindices';\r\n\r\n/**\r\n* Class TriangleSet define set of trinagles\r\n* @class TriangleSet\r\n*/\r\nexport default class TriangleSet {\r\n  /**\r\n  * Init all internal data\r\n  * @constructs TriangleSet\r\n  */\r\n  constructor(numTriangles) {\r\n    this.create(numTriangles);\r\n  } // constructor\r\n\r\n  create(numTriangles) {\r\n    this.m_numTriangles = 0;\r\n    this.m_numAllocatedTriangles = numTriangles;\r\n    this.m_triangles = new Array(numTriangles);\r\n    const STRANGE_VALUE = -1;\r\n    for (let i = 0; i < numTriangles; i++) {\r\n      this.m_triangles[i] = new TriangleIndices(STRANGE_VALUE, STRANGE_VALUE, STRANGE_VALUE);\r\n    }\r\n  } // create\r\n\r\n  /**\r\n  * Get number of triangles\r\n  * @return {number}\r\n  */\r\n  getNumTriangles() {\r\n    return this.m_numTriangles;\r\n  }\r\n\r\n  /**\r\n  * Add triangle to set\r\n  * @return 1, if success\r\n  */\r\n  addTriangle(ia, ib, ic) {\r\n    if (this.m_numTriangles >= this.m_numAllocatedTriangles) {\r\n      return -1;\r\n    }\r\n    this.m_triangles[this.m_numTriangles].m_indices[0] = ia;\r\n    this.m_triangles[this.m_numTriangles].m_indices[1] = ib;\r\n    this.m_triangles[this.m_numTriangles].m_indices[2] = ic;\r\n    this.m_numTriangles++;\r\n    return 1;\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Single triagle\r\n* @module lib/scripts/actvolume/trianglesingle\r\n*/\r\n\r\n// absolute imports\r\nimport * as THREE from 'three';\r\n\r\n// relative imports\r\n\r\n/**\r\n* Class TriangleSingle is one triangle\r\n* @class TriangleSingle\r\n*/\r\nexport default class TriangleSingle {\r\n  constructor() {\r\n    this.va = new THREE.Vector3();\r\n    this.vb = new THREE.Vector3();\r\n    this.vc = new THREE.Vector3();\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Triagle stack\r\n* @module lib/scripts/actvolume/trianglestack\r\n*/\r\n\r\n\r\n// relative imports\r\nimport TriangleSingle from './trianglesingle';\r\n\r\n/**\r\n* Class TriangleStack builds stack for triangles\r\n* @class TriangleStack\r\n*/\r\nexport default class TriangleStack {\r\n  constructor() {\r\n    this.m_numAllocated = 0;\r\n    this.m_numStacked = 0;\r\n    this.m_stack = null;\r\n  }\r\n\r\n  /*\r\n  * Create triangle stack\r\n  * @param {number} depthLevel number of triangles in stack\r\n  */\r\n  create(depthLevel) {\r\n    const ESTIM = 20;\r\n    const MUL_INCREMENT = 4;\r\n    let numTiEstimate = ESTIM;\r\n    for (let i = 0; i < depthLevel; i++) {\r\n      numTiEstimate *= MUL_INCREMENT;\r\n    }\r\n    this.m_numAllocated  = numTiEstimate;\r\n    this.m_stack         = new Array(this.m_numAllocated);\r\n    for (let i = 0; i < this.m_numAllocated; i++) {\r\n      this.m_stack[i] = new TriangleSingle();\r\n    }\r\n    this.m_numStacked    = 0;\r\n  } // create\r\n\r\n  /*\r\n  * Get stack depth\r\n  * @return {number} number of triangles in stack\r\n  */\r\n  getStackDepth() {\r\n    return this.m_numStacked;\r\n  }\r\n\r\n  /*\r\n  * Chech is stack empty\r\n  * @return {boolean} true, if empty\r\n  */\r\n  isEmpty() {\r\n    return (this.m_numStacked === 0);\r\n  }\r\n\r\n  /*\r\n  * Push triangle onto stack\r\n  * @param {object} va triangle a (THREE.Vector3)\r\n  * @param {object} vb triangle b (THREE.Vector3)\r\n  * @param {object} vc triangle c (THREE.Vector3)\r\n  */\r\n  push(va, vb, vc) {\r\n    if (this.m_numStacked >= this.m_numAllocated) {\r\n      return -1;\r\n    }\r\n    this.m_stack[this.m_numStacked].va = va;\r\n    this.m_stack[this.m_numStacked].vb = vb;\r\n    this.m_stack[this.m_numStacked].vc = vc;\r\n    this.m_numStacked++;\r\n    return 1;\r\n  } // push triangle\r\n\r\n  /*\r\n  * Pop triangle from stack\r\n  * @return {object} TriangleSingle object\r\n  */\r\n  pop() {\r\n    if (this.m_numStacked <= 0) {\r\n      return null;\r\n    }\r\n    this.m_numStacked--;\r\n    return this.m_stack[this.m_numStacked];\r\n  } // pop triangle\r\n\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Tetrahedron generator\r\n* @module lib/scripts/actvolume/tetra\r\n*/\r\n\r\n// absolute imports\r\nimport * as THREE from 'three';\r\n\r\n// relative imports\r\nimport PointSet from './pointset';\r\nimport TriangleSet from './triangleset';\r\nimport TriangleStack from './trianglestack';\r\n\r\nconst NUM_VERTICES_TETRA = 12;\r\nconst NUM_TRIANGLES_TETRA = 20;\r\n\r\n/**\r\n* Class TetrahedronGenerator builds good sphere-looked tri mesh\r\n* @class TetrahedronGenerator\r\n*/\r\nexport default class TetrahedronGenerator {\r\n  /**\r\n  * Init all internal data\r\n  * @constructs TetrahedronGenerator\r\n  */\r\n  constructor() {\r\n    this.m_pointSet = null;\r\n    this.m_triangleSet = null;\r\n  }\r\n\r\n  /**\r\n  * Create triangle mesh structure\r\n  * @param {number} vRadiusEllipse Ellipse radius\r\n  * @param {number} numSubdividesOfOrigTetra number of sub divides\r\n  */\r\n  create(vRadiusEllipse, numSubdividesOfOrigTetra) {\r\n    // console.log(`vRadiusEllipse = ${vRadiusEllipse}`);\r\n    // console.log(`numSubdividesOfOrigTetra = ${numSubdividesOfOrigTetra}`);\r\n    const X = 0.5257311121;\r\n    const Z = 0.8506508083;\r\n    // { -X, 0.0f, Z },{ X, 0.0f, Z },{ -X, 0.0f, -Z },{ X, 0.0f, -Z },\r\n    // { 0.0f, Z, X },{ 0.0f, Z, -X },{ 0.0f, -Z, X },{ 0.0f, -Z, -X },\r\n    // { Z, X, 0.0f },{ -Z, X, 0.0f },{ Z, -X, 0.0f },{ -Z, -X, 0.0f }\r\n    const vdata = [\r\n      -X, 0.0, +Z,\r\n      +X, 0.0, +Z,\r\n      -X, 0.0, -Z,\r\n      +X, 0.0, -Z,\r\n      0.0, +Z, +X,\r\n      0.0, +Z, -X,\r\n      0.0, -Z, +X,\r\n      0.0, -Z, -X,\r\n      +Z, +X, 0.0,\r\n      -Z, +X, 0.0,\r\n      +Z, -X, 0.0,\r\n      -Z, -X, 0.0,\r\n    ];\r\n    /*eslint-disable no-magic-numbers*/\r\n    const tindices = [\r\n      0, 4, 1, 0, 9, 4, 9, 5, 4, 4, 5, 8, 4, 8, 1,\r\n      8, 10, 1, 8, 3, 10, 5, 3, 8, 5, 2, 3, 2, 7, 3,\r\n      7, 10, 3, 7, 6, 10, 7, 11, 6, 11, 0, 6, 0, 1, 6,\r\n      6, 1, 10, 9, 0, 11, 9, 11, 2, 9, 2, 5, 7, 2, 11\r\n    ];\r\n    this.m_pointSet = new PointSet(NUM_VERTICES_TETRA);\r\n    let i3 = 0;\r\n    for (let i = 0; i < NUM_VERTICES_TETRA; i++, i3 += 3) {\r\n      const x = vdata[i3 + 0];\r\n      const y = vdata[i3 + 1];\r\n      const z = vdata[i3 + 2];\r\n      this.m_pointSet.addPoint(x, y, z);\r\n    } // for (i) all vertices in tetrahedron structure\r\n    // m_triangleSet.create(NUM_TRIANGLES_TETRA);\r\n    this.m_triangleSet = new TriangleSet(NUM_TRIANGLES_TETRA);\r\n    i3 = 0;\r\n    for (let i = 0; i < NUM_TRIANGLES_TETRA; i++, i3 += 3) {\r\n      const ia = tindices[i3 + 0];\r\n      const ib = tindices[i3 + 1];\r\n      const ic = tindices[i3 + 2];\r\n      // use inverse points order to reach correct plane visibility and correct normal directions\r\n      this.m_triangleSet.addTriangle(ia, ic, ib);\r\n    }\r\n    this.subDivideMesh(numSubdividesOfOrigTetra);\r\n\r\n    // scale to given input ellipse\r\n    const numPoints = this.m_pointSet.getNumPoints();\r\n    for (let i = 0; i < numPoints; i++) {\r\n      this.m_pointSet.m_points[i].m_point.x *= vRadiusEllipse.x;\r\n      this.m_pointSet.m_points[i].m_point.y *= vRadiusEllipse.y;\r\n      this.m_pointSet.m_points[i].m_point.z *= vRadiusEllipse.z;\r\n      // console.log(`DEEP DEB. x = ${this.m_pointSet.m_points[i].m_point.x}`);\r\n    } // for (i) all points in set\r\n\r\n    // test save geo into file\r\n    // const TEST_FILE_NAME = 'tetra.obj';\r\n    // this.saveGeoToObjFile(TEST_FILE_NAME);\r\n\r\n    return 1;\r\n  } // create\r\n\r\n  getNumTriangles() {\r\n    return this.m_triangleSet.m_numTriangles;\r\n  }\r\n\r\n  getNumVertices() {\r\n    return this.m_pointSet.m_numPoints;\r\n  }\r\n\r\n  getVertex(i) {\r\n    return this.m_pointSet.m_points[i].m_point;\r\n  }\r\n\r\n  getTriangle(i) {\r\n    return this.m_triangleSet.m_triangles[i].m_indices;\r\n  }\r\n\r\n  /**\r\n  * Save tetrahedron geometry into given file (PLY type)\r\n  * see PLY format description here:\r\n  * https://en.wikipedia.org/wiki/PLY_(file_format)\r\n  */\r\n  saveGeoToPlyFile(fileName) {\r\n    let strOut = 'ply\\nformat ascii 1.0\\ncomment tetrahedron mesh\\n';\r\n    const numVertices = this.m_pointSet.m_numPoints;\r\n    const strNumVertices = numVertices.toString();\r\n    strOut = strOut.concat('element vertex ');\r\n    strOut = strOut.concat(strNumVertices);\r\n    strOut = strOut.concat('\\n');\r\n    strOut = strOut.concat('property float x\\nproperty float y\\nproperty float z\\n');\r\n    strOut = strOut.concat('element face ');\r\n    const numTriangles = this.m_triangleSet.m_numTriangles;\r\n    const strNumTriangles = numTriangles.toString();\r\n    strOut = strOut.concat(strNumTriangles);\r\n    strOut = strOut.concat('\\n');\r\n    strOut = strOut.concat('property list uchar int vertex_indices\\n');\r\n    strOut = strOut.concat('end_header\\n');\r\n\r\n    // Write vertices\r\n    for (let i = 0; i < numVertices; i++) {\r\n      const vert = this.m_pointSet.m_points[i].m_point;\r\n      const strX = vert.x.toString();\r\n      const strY = vert.y.toString();\r\n      const strZ = vert.z.toString();\r\n      // console.log(`DEEP DEB. xyz = ${strX} ${strY} ${strZ} `);\r\n      strOut = strOut.concat(strX);\r\n      strOut = strOut.concat(' ');\r\n      strOut = strOut.concat(strY);\r\n      strOut = strOut.concat(' ');\r\n      strOut = strOut.concat(strZ);\r\n      strOut = strOut.concat(' 1.0\\n');\r\n    }\r\n    // Write triangles\r\n    for (let i = 0; i < numTriangles; i++) {\r\n      const triIndices = this.m_triangleSet.m_triangles[i].m_indices;\r\n      // console.log(`DEEP DEB. indices = ${triIndices[0]} ${triIndices[1]} ${triIndices[2]} `);\r\n      const strIndices = `3 ${triIndices[0]} ${triIndices[1]} ${triIndices[2]}\\n`;\r\n      strOut = strOut.concat(strIndices);\r\n    }\r\n\r\n    const encoder = new TextEncoder();\r\n    const arr = encoder.encode(strOut);\r\n\r\n    const blob = new Blob([arr], { type: 'application/octet-stream' });\r\n    // saveAs(blob, TEST_FILE_NAME);\r\n    const url = URL.createObjectURL(blob);\r\n    const linkGen = document.createElement('a');\r\n    linkGen.setAttribute('href', url);\r\n    linkGen.setAttribute('download', fileName);\r\n    const eventGen = document.createEvent('MouseEvents');\r\n    eventGen.initMouseEvent('click', true, true, window, 1, 0, 0, 0, 0, false, false, false, false, 0, null);\r\n    linkGen.dispatchEvent(eventGen);\r\n  } // saveGeoToPlyFile\r\n\r\n  /**\r\n  * Save tetrahedron geometry into given file (OBJ type)\r\n  */\r\n  saveGeoToObjFile(fileName) {\r\n    let strOut = '# Tetrahedron test geo\\n';\r\n    const numVertices = this.m_pointSet.m_numPoints;\r\n    const strNumVertices = numVertices.toString();\r\n    const numTriangles = this.m_triangleSet.m_numTriangles;\r\n    const strNumTriangles = numTriangles.toString();\r\n\r\n    // Write vertices\r\n    for (let i = 0; i < numVertices; i++) {\r\n      const vert = this.m_pointSet.m_points[i].m_point;\r\n      const strX = vert.x.toString();\r\n      const strY = vert.y.toString();\r\n      const strZ = vert.z.toString();\r\n      strOut = strOut.concat('v  ');\r\n      strOut = strOut.concat(strX);\r\n      strOut = strOut.concat(' ');\r\n      strOut = strOut.concat(strY);\r\n      strOut = strOut.concat(' ');\r\n      strOut = strOut.concat(strZ);\r\n      strOut = strOut.concat('\\n');\r\n    }\r\n    // write num verts\r\n    const strNumVerts = `# ${strNumVertices} vertices\\n`;\r\n    strOut = strOut.concat(strNumVerts);\r\n    strOut = strOut.concat('g TetraObj\\n');\r\n\r\n    // Write triangles\r\n    for (let i = 0; i < numTriangles; i++) {\r\n      const triIndices = this.m_triangleSet.m_triangles[i].m_indices;\r\n      // console.log(`DEEP DEB. indices = ${triIndices[0]} ${triIndices[1]} ${triIndices[2]} `);\r\n      const i0 = 1 + triIndices[0];\r\n      const i1 = 1 + triIndices[1];\r\n      const i2 = 1 + triIndices[2];\r\n      const strIndices = `f ${i0} ${i1} ${i2}\\n`;\r\n      strOut = strOut.concat(strIndices);\r\n    }\r\n    // write num tri\r\n    const strNumTri = `# ${strNumTriangles} triangles\\n`;\r\n    strOut = strOut.concat(strNumTri);\r\n\r\n    const encoder = new TextEncoder();\r\n    const arr = encoder.encode(strOut);\r\n\r\n    const blob = new Blob([arr], { type: 'application/octet-stream' });\r\n    // saveAs(blob, TEST_FILE_NAME);\r\n    const url = URL.createObjectURL(blob);\r\n    const linkGen = document.createElement('a');\r\n    linkGen.setAttribute('href', url);\r\n    linkGen.setAttribute('download', fileName);\r\n    const eventGen = document.createEvent('MouseEvents');\r\n    eventGen.initMouseEvent('click', true, true, window, 1, 0, 0, 0, 0, false, false, false, false, 0, null);\r\n    linkGen.dispatchEvent(eventGen);\r\n  } // saveGeoToObjFile\r\n\r\n  /*\r\n  * Sub divide source mesh\r\n  * @param {number} numSubdividesOfOrigTetra number of sub divides\r\n  */\r\n  subDivideMesh(numSubdividesOfOrigTetra) {\r\n    if (numSubdividesOfOrigTetra === 0) {\r\n      return 1;\r\n    }\r\n    const triStackSrc = new TriangleStack();\r\n    triStackSrc.create(numSubdividesOfOrigTetra);\r\n    const triStackDst = new TriangleStack();\r\n    triStackDst.create(numSubdividesOfOrigTetra);\r\n\r\n    const numTriangles = this.m_triangleSet.getNumTriangles();\r\n    for (let t = 0; t < numTriangles; t++) {\r\n      const triIndices = this.m_triangleSet.m_triangles[t].m_indices;\r\n      const ia = triIndices[0];\r\n      const ib = triIndices[1];\r\n      const ic = triIndices[2];\r\n      const va = this.m_pointSet.m_points[ia].m_point;\r\n      const vb = this.m_pointSet.m_points[ib].m_point;\r\n      const vc = this.m_pointSet.m_points[ic].m_point;\r\n      const okPush = triStackSrc.push(va, vb, vc);\r\n      if (okPush < 1) {\r\n        return okPush;\r\n      }\r\n    } // for (t) all triangles, push em all\r\n    let stackSrc = triStackSrc;\r\n    let stackDst = triStackDst;\r\n    for (let iter = 0; iter < numSubdividesOfOrigTetra; iter++) {\r\n      const numStacked = stackSrc.getStackDepth();\r\n      for (let s = 0; s < numStacked; s++) {\r\n        // pop tri from stack\r\n        const triSingle = stackSrc.pop();\r\n        if (triSingle === null) {\r\n          return -1;\r\n        }\r\n        const v1 = triSingle.va;\r\n        const v2 = triSingle.vb;\r\n        const v3 = triSingle.vc;\r\n\r\n        // create additional vertices\r\n        const v12 = new THREE.Vector3();\r\n        const v23 = new THREE.Vector3();\r\n        const v31 = new THREE.Vector3();\r\n        v12.addVectors(v1, v2);\r\n        v12.normalize();\r\n        v23.addVectors(v2, v3);\r\n        v23.normalize();\r\n        v31.addVectors(v3, v1);\r\n        v31.normalize();\r\n\r\n        stackDst.push(v1, v12, v31);\r\n        stackDst.push(v2, v23, v12);\r\n        stackDst.push(v3, v31, v23);\r\n        stackDst.push(v12, v23, v31);\r\n      } // for (s) stacked triangles\r\n      // exchange stack\r\n      const stackTmp = stackSrc;\r\n      stackSrc = stackDst;\r\n      stackDst = stackTmp;\r\n    } // for (iter) all stack depth, subdivide iterations\r\n    // now we have stack src\r\n    const numTrisInStack = stackSrc.getStackDepth();\r\n    // vertices should not be more than 12/20 == 0.6\r\n    const estimateNumVertices = Math.floor(numTrisInStack * 3 * 0.6);\r\n    this.m_triangleSet.create(numTrisInStack);\r\n    this.m_pointSet.create(estimateNumVertices);\r\n    // let numTrisFromStack = 0;\r\n    while (!stackSrc.isEmpty()) {\r\n      // V3f va, vb, vc;\r\n      // stackSrc->pop(va, vb, vc);\r\n      const triSingle = stackSrc.pop();\r\n      const va = triSingle.va;\r\n      const vb = triSingle.vb;\r\n      const vc = triSingle.vc;\r\n      const indA = this.m_pointSet.addPoint(va.x, va.y, va.z);\r\n      const indB = this.m_pointSet.addPoint(vb.x, vb.y, vb.z);\r\n      const indC = this.m_pointSet.addPoint(vc.x, vc.y, vc.z);\r\n\r\n      const okAddTri = this.m_triangleSet.addTriangle(indA, indB, indC);\r\n      if (okAddTri !== 1) {\r\n        return okAddTri;\r\n      }\r\n      // numTrisFromStack++;\r\n    } // while\r\n    // assert(m_pointsSet.getNumPoints() <= estimateNumVertices);\r\n    // assert(m_triangleSet.getNumTriangles() <= numTrisInStack);\r\n    const numPts = this.m_pointSet.getNumPoints();\r\n    const numTris = this.m_triangleSet.getNumTriangles();\r\n    const ERR_ESTIMATE = -10;\r\n    if (numPts > estimateNumVertices) {\r\n      return ERR_ESTIMATE;\r\n    }\r\n    if (numTris > numTrisInStack) {\r\n      return ERR_ESTIMATE;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n}\r\n","import MaterialAO from './gfx/matAO';\r\nimport TetrahedronGenerator from './actvolume/tetra';\r\nimport * as THREE from 'three';\r\n\r\n/**\r\n * 3D ambient texture processing engine\r\n * @module lib/scripts/graphics3d/ambientTexture\r\n */\r\nexport default class AmbientTexture {\r\n  constructor(inParams) {\r\n    //this.rendererBlur.render(this.sceneBlur, this.cameraOrtho\r\n    this.rendererBlur = inParams.renderer;\r\n    this.sceneBlur = inParams.scene;\r\n    this.cameraOrtho = inParams.camera;\r\n    this.xDim = inParams.xDim;\r\n    this.yDim = inParams.yDim;\r\n    this.zDim = inParams.zDim;\r\n    this.texVolumeAO = null;\r\n    this.vectorsTex = null;\r\n  }\r\n\r\n  _setAOVectorTex() {\r\n    const VAL_4 = 4;\r\n    const VAL_255 = 255;\r\n    const gen = new TetrahedronGenerator();\r\n    const vRadius = new THREE.Vector3(0.5, 0.5, 0.5);\r\n    const NUM_SUBDIVIDES = 2;\r\n    const okCreateTetra = gen.create(vRadius, NUM_SUBDIVIDES);\r\n    if (okCreateTetra < 1) {\r\n      return;\r\n    }\r\n    this.numAOVectors = gen.getNumVertices();\r\n\r\n    this.vectors = new Uint8Array(VAL_4 * this.numAOVectors);\r\n\r\n    for (let i = 0; i < this.numAOVectors; i++) {\r\n      const vert = gen.getVertex(i);\r\n      this.vectors[i * VAL_4 + 0] = (vert.x + 0.5) * VAL_255;\r\n      this.vectors[i * VAL_4 + 1] = (vert.y + 0.5) * VAL_255;\r\n      this.vectors[i * VAL_4 + 2] = (vert.z + 0.5) * VAL_255;\r\n      this.vectors[i * VAL_4 + 3] = VAL_255;\r\n    }\r\n\r\n    this.vectorsTex = new THREE.DataTexture(this.vectors, this.numAOVectors, 1, THREE.RGBAFormat);\r\n    this.vectorsTex.wrapS = THREE.ClampToEdgeWrapping;\r\n    this.vectorsTex.wrapT = THREE.ClampToEdgeWrapping;\r\n    this.vectorsTex.magFilter = THREE.NearestFilter;\r\n    this.vectorsTex.minFilter = THREE.NearestFilter;\r\n    this.vectorsTex.needsUpdate = true;\r\n  }\r\n\r\n  set(texVolume, isoThreshold) {\r\n    if (this.vectorsTex === null) {\r\n      this._setAOVectorTex();\r\n    }\r\n    this.xDimAO = this.xDim;\r\n    this.yDimAO = this.yDim;\r\n    this.zDimAO = this.zDim;\r\n    this.bufferTextureAO = new THREE.WebGLRenderTarget(this.xDimAO,\r\n      this.yDimAO, {\r\n        minFilter: THREE.LinearFilter,\r\n        magFilter: THREE.LinearFilter,\r\n        format: THREE.RGBAFormat,\r\n        type: THREE.UnsignedByteType,\r\n        depthBuffer: false,\r\n      });\r\n\r\n    this.ambientVolumeTexCPU = new Uint8Array(this.xDimAO * this.yDimAO * this.zDimAO);\r\n    if (this.isWebGL2 === 0) {\r\n      this.texVolumeAO = new THREE.DataTexture(this.ambientVolumeTexCPU, this.xTex, this.yTex, THREE.AlphaFormat);\r\n    } else {\r\n      this.texVolumeAO = new THREE.DataTexture3D(this.ambientVolumeTexCPU, this.xDimAO, this.yDimAO, this.zDimAO);\r\n      this.texVolumeAO.format = THREE.RedFormat;\r\n      //this.texVolumeAO.type = THREE.UnsignedByteType;\r\n    }\r\n    this.texVolumeAO.wrapS = THREE.ClampToEdgeWrapping;\r\n    this.texVolumeAO.wrapT = THREE.ClampToEdgeWrapping;\r\n    this.texVolumeAO.wrapR = THREE.ClampToEdgeWrapping;\r\n    this.texVolumeAO.magFilter = THREE.LinearFilter;\r\n    this.texVolumeAO.minFilter = THREE.LinearFilter;\r\n    this.texVolumeAO.needsUpdate = true;\r\n\r\n    const texelSize = new THREE.Vector3(1.0 / this.xDim, 1.0 / this.yDim, 1.0 / this.zDim);\r\n    const matAO = new MaterialAO();\r\n    matAO.create(texVolume, texelSize, this.vectorsTex, this.numAOVectors, isoThreshold, (mat) => {\r\n      this.materialAO = mat;\r\n      mat.uniforms.tileCountX.value = this.zTexDivSqrt;\r\n      mat.uniforms.volumeSizeZ.value = this.zDim;\r\n      this.setAmbientTextureWebGL2();\r\n      this.texVolumeAO.needsUpdate = true;\r\n    });\r\n  }\r\n\r\n  setAmbientTextureWebGL2() {\r\n    const VAL_4 = 4;\r\n    const frameBuf = new Uint8Array(VAL_4 * this.xDimAO * this.yDimAO);\r\n    const gl = this.rendererBlur.getContext();\r\n    console.log('AO WebGL2');\r\n    for (let z = 0; z < this.zDimAO; ++z) {\r\n      this.materialAO.uniforms.curZ.value = z / (this.zDimAO - 1);\r\n      this.materialAO.uniforms.curZ.needsUpdate = true;\r\n      this.sceneBlur.overrideMaterial = this.materialAO;\r\n      this.rendererBlur.render(this.sceneBlur, this.cameraOrtho, this.bufferTextureAO);\r\n      this.sceneBlur.overrideMaterial = null;\r\n      gl.readPixels(0, 0, this.xDimAO, this.yDimAO, gl.RGBA, gl.UNSIGNED_BYTE, frameBuf);\r\n      const zOffs = z * this.xDimAO * this.yDimAO;\r\n      for (let y = 0; y < this.yDimAO; y++) {\r\n        for (let x = 0; x < this.xDimAO; x++) {\r\n          this.ambientVolumeTexCPU[x + y * this.xDimAO + zOffs] = \r\n            frameBuf[VAL_4 * (x + y * this.xDimAO)]; //256.0 * k / this.zDim;\r\n        }\r\n      }\r\n    }\r\n    console.log('AO WebGL2 End');\r\n  }\r\n\r\n  get() {\r\n    return this.texVolumeAO;\r\n  }\r\n}\r\n","/* eslint-disable no-magic-numbers */\r\n/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n * 3D volume processing engine: transfer texture\r\n * @module lib/scripts/graphics3d/transferTexture\r\n */\r\nimport * as THREE from 'three';\r\n/** Class for transfer texture computation and rendering */\r\nexport default class TransferTexture {\r\n  constructor() {    \r\n    this.selectedROIs = null;\r\n    this.transferFuncRgba = null;\r\n    this.transferFuncTexture = null;\r\n    this.texRoiColor = null;\r\n    this.texRoiId = null;    \r\n    this.numRois = 256;\r\n    this.m_handleColors = [\r\n      { r: 0, g: 0, b: 0 },\r\n      { r: 255, g: 128, b: 64 },\r\n      { r: 255, g: 0, b: 0 },\r\n      { r: 128, g: 64, b: 64 },\r\n      { r: 128, g: 0, b: 0 },\r\n      { r: 64, g: 64, b: 64 },\r\n      { r: 128, g: 128, b: 128 },\r\n      { r: 192, g: 192, b: 192 },\r\n      { r: 255, g: 255, b: 255 },\r\n      { r: 255, g: 255, b: 255 },\r\n    ];\r\n  }\r\n\r\n  /**\r\n   * Filtering the source data and building the normals on the GPU\r\n   * @param isRoiVolume\r\n   * @param roiColors Array of roi colors in RGBA format\r\n   */\r\n  init(isRoiVolume, roiColors) {\r\n    const c4 = 4; \r\n    // eslint-disable-next-line\r\n    this.selectedROIs = new Uint8Array(c4 * this.numRois);\r\n    this.numTfPixels = 256;\r\n    // eslint-disable-next-line\r\n    this.transferFuncRgba = new Uint8Array(c4 * this.numTfPixels);\r\n    this.texRoiColor = null;\r\n    if (isRoiVolume) {\r\n      this.texRoiId = this.createSelectedRoiMap();\r\n      this.texRoiColor = this.createRoiColorMap(roiColors);\r\n    }    \r\n  }\r\n\r\n  /**\r\n   * Create 2D texture containing transfer func colors\r\n  */\r\n  createTransferFuncTexture() {\r\n    let textureOut = null;\r\n    let alpha = 0;\r\n    const SCALE = 255;\r\n    const SCALE1 = 12.0;\r\n    const SCALE2 = 3.0;\r\n    const A1 = 0.09;\r\n    const A2 = 0.2;\r\n    const A3 = 0.3;\r\n    const A4 = 0.43;\r\n    const A5 = 0.53;\r\n    const a1 = A1 * SCALE;\r\n    const a2 = A2 * SCALE;\r\n    const a3 = A3 * SCALE;\r\n    const a4 = A4 * SCALE;\r\n    const a5 = A5 * SCALE;\r\n    const COLOR_R = 255;\r\n    const COLOR_G = 210;\r\n    const COLOR_B = 180;\r\n    const FOUR = 4;\r\n    for (let pix = 0; pix < this.numTfPixels; pix++) {\r\n      if (pix > a1 && pix < a2) {\r\n        alpha = (pix - a1) / (a2 - a1);\r\n      }\r\n      if (pix > a2 && pix < a3) {\r\n        alpha = (a3 - pix) / (a3 - a2);\r\n      }\r\n      if (pix > a4 && pix < a5) {\r\n        alpha = (pix - a4) / (a5 - a4);\r\n      }\r\n      if (pix > a5) {\r\n        alpha = 1;\r\n      }\r\n      // eslint-disable-next-line\r\n      this.transferFuncRgba[pix * FOUR + 0] = SCALE;\r\n      // eslint-disable-next-line\r\n      this.transferFuncRgba[pix * FOUR + 1] = 0;\r\n      // eslint-disable-next-line\r\n      this.transferFuncRgba[pix * FOUR + 1 + 1] = 0;\r\n      // eslint-disable-next-line\r\n      this.transferFuncRgba[pix * FOUR + 1 + 1 + 1] = SCALE * alpha / SCALE1;\r\n      if (pix > a4) {\r\n        this.transferFuncRgba[pix * FOUR + 0] = COLOR_R;\r\n        // eslint-disable-next-line\r\n        this.transferFuncRgba[pix * FOUR + 1] = COLOR_G;\r\n        // eslint-disable-next-line\r\n        this.transferFuncRgba[pix * FOUR + 1 + 1] = COLOR_B;\r\n        this.transferFuncRgba[pix * FOUR + 1 + 1 + 1] = SCALE * alpha / SCALE2;\r\n      }\r\n    }\r\n    textureOut = new THREE.DataTexture(this.transferFuncRgba, this.numTfPixels, 1, THREE.RGBAFormat);\r\n    textureOut.wrapS = THREE.ClampToEdgeWrapping;\r\n    textureOut.wrapT = THREE.ClampToEdgeWrapping;\r\n    textureOut.magFilter = THREE.NearestFilter;\r\n    textureOut.minFilter = THREE.NearestFilter;\r\n    textureOut.needsUpdate = true;\r\n    this.transferFuncTexture = textureOut;\r\n    return textureOut;\r\n  }\r\n\r\n  /**\r\n   * Creates transfer function color map\r\n   * @param ctrlPts Array of control points of type HEX  = color value\r\n   */\r\n  setTransferFuncColors(colors) {\r\n    this.transferFuncCtrlPtsRgb = [];\r\n    for (let i = 0; i < colors.length; i++) {\r\n      this.transferFuncCtrlPtsRgb.push(new THREE.Vector3(colors[i].r, colors[i].g, colors[i].b));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates transfer function color map\r\n   * @param ctrlPts Array of Vector2 where (x,y) = x coordinate in [0, 1], alpha value in [0, 1]\r\n   */\r\n  updateTransferFuncTexture(intensities, opacities) {\r\n    if (this.transferFuncRgba === null) {\r\n      return null;\r\n    }\r\n    for (let curPt = 0; curPt < intensities.length - 1; curPt++) {\r\n      const pixStart = Math.floor(intensities[curPt]);\r\n      const pixEnd = Math.floor(intensities[curPt + 1]);\r\n      for (let pix = pixStart; pix < pixEnd; pix++) {\r\n        const lerpVal = (pix - pixStart) / (pixEnd - pixStart);\r\n        const colorX = (1.0 - lerpVal) * this.m_handleColors[curPt].r + lerpVal * this.m_handleColors[curPt + 1].r\r\n        const colorY = (1.0 - lerpVal) * this.m_handleColors[curPt].g + lerpVal * this.m_handleColors[curPt + 1].g;\r\n        const colorZ = (1.0 - lerpVal) * this.m_handleColors[curPt].b + lerpVal * this.m_handleColors[curPt + 1].b;\r\n        // eslint-disable-next-line\r\n        this.transferFuncRgba[pix * 4 + 0] = colorX;\r\n        // eslint-disable-next-line\r\n        this.transferFuncRgba[pix * 4 + 1] = colorY;\r\n        // eslint-disable-next-line\r\n        this.transferFuncRgba[pix * 4 + 2] = colorZ;\r\n        // eslint-disable-next-line\r\n        const op1 = (opacities[curPt] > 0.0) ? opacities[curPt] : 0.0;\r\n        const op2 = (opacities[curPt + 1] > 0.0) ? opacities[curPt + 1] : 0.0;\r\n        this.transferFuncRgba[pix * 4 + 3] = (op2 * lerpVal + (1.0 - lerpVal) * op1) * 255;\r\n      }\r\n    }\r\n    this.transferFuncTexture.needsUpdate = true;\r\n    return this.transferFuncRgba;\r\n  }\r\n\r\n  /**\r\n   * Create 2D texture containing roi color map\r\n   * @param colorArray 256 RGBA roi colors\r\n   */\r\n  createRoiColorMap(colorArray) {\r\n    let textureOut = null;\r\n    if (colorArray !== null) {\r\n      //textureOut = new THREE.DataTexture(colorArray, this.numRois, 1, THREE.RGBAFormat);\r\n      textureOut = new THREE.DataTexture(colorArray, 256, 1, THREE.RGBAFormat);\r\n    } else {\r\n      // eslint-disable-next-line\r\n      const colorROIs = new Uint8Array(4 * this.numRois);\r\n      for (let pix = 0; pix < this.numRois; pix++) {\r\n        // eslint-disable-next-line\r\n        colorROIs[pix * 4 + 0] = 255;\r\n        // eslint-disable-next-line\r\n        colorROIs[pix * 4 + 1] = 0;\r\n        // eslint-disable-next-line\r\n        colorROIs[pix * 4 + 2] = 0;\r\n        // eslint-disable-next-line\r\n        colorROIs[pix * 4 + 3] = 255;\r\n      }\r\n      textureOut = new THREE.DataTexture(colorROIs, this.numRois, 1, THREE.RGBAFormat);\r\n    }\r\n    textureOut.wrapS = THREE.ClampToEdgeWrapping;\r\n    textureOut.wrapT = THREE.ClampToEdgeWrapping;\r\n    textureOut.magFilter = THREE.NearestFilter;\r\n    textureOut.minFilter = THREE.NearestFilter;\r\n    textureOut.needsUpdate = true;\r\n    return textureOut;\r\n  }\r\n\r\n  /**\r\n   * Create 2D texture containing selected ROIs\r\n   */\r\n  createSelectedRoiMap() {\r\n    const a1 = 50;\r\n    const a2 = 240;\r\n    const c1 = 1;\r\n    const c2 = 2;\r\n    const c3 = 3;\r\n    const BYTES_IN_COLOR = 4;\r\n    for (let pix = 0; pix < this.numRois; pix++) {\r\n      if (pix < a1 || pix > a2) {\r\n        this.selectedROIs[pix * BYTES_IN_COLOR] = 0;\r\n      } else {\r\n        this.selectedROIs[pix * BYTES_IN_COLOR] = 255;\r\n      }\r\n      this.selectedROIs[pix * BYTES_IN_COLOR + c1] = 0;\r\n      this.selectedROIs[pix * BYTES_IN_COLOR + c2] = 0;\r\n      this.selectedROIs[pix * BYTES_IN_COLOR + c3] = 0;\r\n    }\r\n    //const textureOut = new THREE.DataTexture(this.selectedROIs, this.numRois, 1, THREE.RGBAFormat);\r\n    const textureOut = new THREE.DataTexture(this.selectedROIs, 256, 1, THREE.RGBAFormat);\r\n    textureOut.wrapS = THREE.ClampToEdgeWrapping;\r\n    textureOut.wrapT = THREE.ClampToEdgeWrapping;\r\n    textureOut.magFilter = THREE.NearestFilter;\r\n    textureOut.minFilter = THREE.NearestFilter;\r\n    textureOut.needsUpdate = true;\r\n    return textureOut;\r\n  }\r\n\r\n  /**\r\n   * Create 2D texture containing selected ROIs\r\n   * @param selectedROIs 256 byte roi values\r\n   */\r\n  updateSelectedRoiMap(selectedROI) {\r\n    const roiTexelBpp = 4;\r\n    const roiSelectedTrue = 255;\r\n    const roiSelectedFalse = 0;\r\n    for (let pix = 0; pix < this.numRois; pix++) {\r\n      if (selectedROI[pix]) {\r\n        this.selectedROIs[pix * roiTexelBpp] = roiSelectedTrue;\r\n      } else {\r\n        this.selectedROIs[pix * roiTexelBpp] = roiSelectedFalse;\r\n      }\r\n    }\r\n    this.texRoiId.needsUpdate = true;\r\n    //this.setVolumeTexture(1.0);\r\n  }\r\n  /**\r\n   * Update roi selection map\r\n   * @param roiId ROI id from 0..255\r\n   * @param selectedState True if roi must be visible\r\n   */\r\n  // eslint-disable-next-line\r\n  updateSelectedRoi(roiId, selectedState) {\r\n    const roiTexelBpp = 4;\r\n    const roiChecked = 255;\r\n    const roiUnchecked = 0;\r\n    if (selectedState) {\r\n      this.selectedROIs[roiTexelBpp * roiId] = roiChecked;\r\n    } else {\r\n      this.selectedROIs[roiTexelBpp * roiId] = roiUnchecked;\r\n    }\r\n    console.log(`initMatBlure: ${this.initMatBlure}`);\r\n    this.texRoiId.needsUpdate = true;\r\n    //this.setVolumeTexture(1.0);\r\n  }\r\n} // class TransferTexture\r\n","/**\r\n * @fileOverview Eraser\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************/**\r\nimport * as THREE from 'three';\r\n// ********************************************************\r\n// Class Eraser is used for erasing of volume data part\r\n// ********************************************************\r\nexport default class Eraser {\r\n  constructor() {\r\n    this.bufferBF = null;\r\n    this.bufferFF = null;\r\n    this.bufferRenderToTexture = null;\r\n    this.isoThreshold = 0;\r\n    this.volTextureMask = null;\r\n    this.geometry = null;\r\n    this.lastSize = [];\r\n    this.lastDepth = [];\r\n    this.lastRotationVector = [];\r\n    this.lastTarget = [];\r\n    this.lastMode = [];\r\n    this.lastBackDistance = [];\r\n    this.resetflag = false;\r\n    this.bufferTextureCPU = null;\r\n  }\r\n\r\n  createUpdatableVolumeMask(params, buff) {\r\n    this.xDim = params.xDim;\r\n    this.yDim = params.yDim;\r\n    this.zDim = params.zDim;\r\n    this.bufferBF = params.bufBF;\r\n    this.bufferFF = params.bufFF;\r\n    this.bufferRenderToTexture = params.bufTex;\r\n    this.bufferMask = new Uint8Array(this.xDim * this.yDim * this.zDim);\r\n    this.bufferTextureCPU = buff;\r\n    for (let z = 0; z < this.zDim; z++) {\r\n      for (let y = 0; y < this.yDim; y++) {\r\n        for (let x = 0; x < this.xDim; x++) {\r\n          this.bufferMask[x + y * this.xDim + z * this.xDim * this.yDim] = 255;\r\n        }\r\n      }\r\n    }\r\n    if (this.updatableTextureMask) {\r\n      this.updatableTextureMask.dispose();\r\n    }\r\n    this.updatableTextureMask = new THREE.DataTexture3D(this.bufferMask, this.xDim, this.yDim, this.zDim);\r\n    this.updatableTextureMask.format = THREE.RedFormat;\r\n    this.updatableTextureMask.type = THREE.UnsignedByteType;\r\n    this.updatableTextureMask.wrapS = THREE.ClampToEdgeWrapping;\r\n    this.updatableTextureMask.wrapT = THREE.ClampToEdgeWrapping;\r\n    this.updatableTextureMask.magFilter = THREE.LinearFilter;\r\n    this.updatableTextureMask.minFilter = THREE.LinearFilter;\r\n    this.updatableTextureMask.needsUpdate = true;\r\n    return this.updatableTextureMask;\r\n  }\r\n\r\n  eraseStart(xx, yy, windowWidth, isoThreshold, startflag) {\r\n    this.isoThreshold = isoThreshold;\r\n    const x = Math.round(xx);\r\n    const y = Math.round(yy);\r\n    this.eraserMouseDown = true;\r\n    const OFF0 = 0;\r\n    const OFF1 = 1;\r\n    const OFF2 = 2;\r\n    const OFF3 = 3;\r\n    const GPU_CELL_SIZE = 4;\r\n    const cellInd = (y * windowWidth + x) * GPU_CELL_SIZE;\r\n    const THREE3 = 3;\r\n    const bigCellInd = (Math.floor(y / THREE3) * Math.floor(windowWidth / THREE3) +\r\n      Math.floor(x / THREE3)) * GPU_CELL_SIZE;\r\n    const dist = this.bufferRenderToTexture[bigCellInd + OFF3];\r\n    const NO_MATERIAL = 2;\r\n    if (dist === NO_MATERIAL) {\r\n      return;\r\n    }\r\n    let vX = this.bufferBF[cellInd + OFF0] - this.bufferFF[cellInd + OFF0];\r\n    let vY = this.bufferBF[cellInd + OFF1] - this.bufferFF[cellInd + OFF1];\r\n    let vZ = this.bufferBF[cellInd + OFF2] - this.bufferFF[cellInd + OFF2];\r\n    const vDir = new THREE.Vector3(vX, vY, vZ);\r\n    const length = Math.sqrt(vX * vX + vY * vY + vZ * vZ);\r\n    const COORD_SHIFT = 0.5;\r\n    vX = vX / length * dist + COORD_SHIFT + this.bufferFF[cellInd + OFF0];\r\n    vY = vY / length * dist + COORD_SHIFT + this.bufferFF[cellInd + OFF1];\r\n    vZ = vZ / length * dist + COORD_SHIFT + this.bufferFF[cellInd + OFF2];\r\n    this.erasePixels(vX, vY, vZ, vDir, startflag, dist);\r\n    this.updatableTextureMask.needsUpdate = true;\r\n  }\r\n\r\n  onMouseUp() {\r\n    this.orbitControl.onMouseUp();\r\n    this.lockEraserBuffersUpdating = false;\r\n    this.eraserMouseDown = false;\r\n    this.renderState = this.RENDER_STATE.ONCE;\r\n  }\r\n\r\n  setEraserRadius(radius) {\r\n    this.radius = radius;\r\n  }\r\n\r\n  setEraserDepth(depth) {\r\n    this.depth = depth;\r\n  }\r\n\r\n  erasePixels(x_, y_, z_, vDir, startflag, length) {\r\n    const targetX = Math.floor(x_ * this.xDim);\r\n    const targetY = Math.floor(y_ * this.yDim);\r\n    const targetZ = Math.floor(z_ * this.zDim);\r\n    const normal = new THREE.Vector3();\r\n    const normalGauss = new THREE.Vector3();\r\n    const GAUSS_R = 2;\r\n    const SIGMA = 1.4;\r\n    const SIGMA2 = SIGMA * SIGMA;\r\n    let nX = 0;\r\n    let nY = 0;\r\n    let nZ = 0;\r\n    let normFactor = 0;\r\n    let offDst = 0;\r\n    const VAL_2 = 2; // getting normal of surface\r\n    for (let k = -Math.min(GAUSS_R, targetZ); k <= Math.min(GAUSS_R, this.zDim - 1 - targetZ); k++) {\r\n      for (let j = -Math.min(GAUSS_R, targetY); j <= Math.min(GAUSS_R, this.yDim - 1 - targetY); j++) {\r\n        for (let i = -Math.min(GAUSS_R, targetX); i <= Math.min(GAUSS_R, this.xDim - 1 - targetX); i++) {\r\n          // handling voxel: (targetX + i; ,targetY+ j; targetZ + k);\r\n          const gX = targetX + i;\r\n          const gY = targetY + j;\r\n          const gZ = targetZ + k;\r\n          offDst = gX + gY * this.xDim + gZ * this.xDim * this.yDim;\r\n          const gauss = 1 - Math.exp(-(i * i + j * j + k * k) / (VAL_2 * SIGMA2));\r\n          normFactor += gauss;\r\n          const curVal = this.bufferTextureCPU[offDst];\r\n          nX += curVal * gauss * (-i / SIGMA2);\r\n          nY += curVal * gauss * (-j / SIGMA2);\r\n          nZ += curVal * gauss * (-k / SIGMA2);\r\n        }\r\n      }\r\n    }// end gauss summation\r\n    normalGauss.set(nX / normFactor, nY / normFactor, nZ / normFactor);\r\n    normal.copy(normalGauss);\r\n    normal.normalize();\r\n    const pi = 180;// pi (just for console output)\r\n    const radiusRatio = this.xDim / this.zDim;\r\n    const geometry = new THREE.CylinderGeometry(this.radius, this.radius, this.depth, pi, this.depth);\r\n    const mesh = new THREE.Mesh(geometry, null);\r\n    const axis = new THREE.Vector3(0, 0, 1);\r\n    mesh.quaternion.setFromUnitVectors(axis, normal.clone().normalize().multiplyScalar(-1));\r\n    mesh.position.copy(new THREE.Vector3(targetX, targetY, targetZ));\r\n\r\n    if (startflag === true) {\r\n      this.prevDistance = length;\r\n      this.resetflag = false;\r\n    }\r\n    const radius = 0.05;\r\n    if (this.resetflag === false) {\r\n      if (Math.abs(this.prevDistance - length) < radius) {\r\n        this.prevDistance = length;\r\n        this.point = new THREE.Vector3(0, 0, 0);\r\n        this.queue = [];\r\n        this.queue.push(this.point);\r\n        const normalBack = -5;\r\n        let backZ = 0;\r\n        backZ = normalBack;\r\n        let deleteflag = false;\r\n        while (this.queue.length > 0) {\r\n          this.point = this.queue.pop();\r\n          const RotPoint = this.point.clone();\r\n          RotPoint.z *= radiusRatio;\r\n          RotPoint.applyAxisAngle(new THREE.Vector3(1, 0, 0), -mesh.rotation.x);\r\n          RotPoint.applyAxisAngle(new THREE.Vector3(0, 1, 0), -mesh.rotation.y);\r\n          RotPoint.applyAxisAngle(new THREE.Vector3(0, 0, 1), mesh.rotation.z);\r\n          if (Math.sqrt(RotPoint.x * RotPoint.x + RotPoint.y * RotPoint.y) > this.radius ||\r\n            Math.abs(RotPoint.z) > this.depth || RotPoint.z < backZ) {\r\n            continue;\r\n          }\r\n          for (let x = this.point.x - 1; x <= this.point.x + 1; x++) {\r\n            for (let y = this.point.y - 1; y <= this.point.y + 1; y++) {\r\n              for (let z = this.point.z - 1; z <= this.point.z + 1; z++) {\r\n                const mainX = targetX + Math.round(x);\r\n                const mainY = targetY + Math.round(y);\r\n                const mainZ = targetZ + Math.round(z);\r\n                offDst = mainX + mainY * this.xDim + mainZ * this.xDim * this.yDim;\r\n                if (this.bufferMask[offDst] === 0) {\r\n                  continue;\r\n                }\r\n                const bitconst = 255.0;\r\n                const borderinclude = 0.01;\r\n                const isoSurfaceBorder = this.isoThreshold * bitconst - borderinclude * bitconst;\r\n                if (this.bufferTextureCPU[offDst] >= isoSurfaceBorder) {\r\n                  deleteflag = true;\r\n                  this.bufferMask[offDst] = 0;\r\n                  this.queue.push(new THREE.Vector3(x, y, z));\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n        if (deleteflag === true) {\r\n          this.lastSize.push(this.radius);\r\n          this.lastDepth.push(this.depth);\r\n          this.lastRotationVector.push(new THREE.Vector3(-mesh.rotation.x, -mesh.rotation.y, mesh.rotation.z));\r\n          this.lastTarget.push(new THREE.Vector3(targetX, targetY, targetZ));\r\n          this.lastBackDistance.push(-Math.round(Math.abs(Math.tan(vDir.normalize().angleTo(normalGauss.normalize())))\r\n            * (this.radius)));\r\n        } \r\n        this.updatableTextureMask.needsUpdate = true;\r\n        \r\n      } else {\r\n        this.resetflag = false;\r\n      }\r\n    }\r\n  }\r\n\r\n  undoLastErasing() {\r\n    if (this.lastSize.length === 0) {\r\n      return;\r\n    }\r\n    const targetLast = this.lastTarget.pop();\r\n    const lastRotation = this.lastRotationVector.pop();\r\n    const rxy = Math.round(this.lastSize.pop());\r\n    const lastDepth = this.lastDepth.pop();\r\n    const lastback = this.lastBackDistance.pop();\r\n    const radiusRatio = this.xDim / this.zDim;\r\n    this.point = new THREE.Vector3(0, 0, 0);\r\n    this.queue = [];\r\n    this.queue.push(this.point);\r\n    while (this.queue.length > 0) {\r\n      this.point = this.queue.pop();\r\n      const RotPoint = this.point.clone();\r\n      RotPoint.z *= radiusRatio;\r\n      RotPoint.applyAxisAngle(new THREE.Vector3(1, 0, 0), lastRotation.x);\r\n      RotPoint.applyAxisAngle(new THREE.Vector3(0, 1, 0), lastRotation.y);\r\n      RotPoint.applyAxisAngle(new THREE.Vector3(0, 0, 1), lastRotation.z);\r\n      if (Math.sqrt(RotPoint.x * RotPoint.x + RotPoint.y * RotPoint.y) > rxy ||\r\n        RotPoint.z > lastDepth || RotPoint.z < lastback) {\r\n        continue;\r\n      }\r\n      let offDst = 0;\r\n      for (let x = this.point.x - 1; x <= this.point.x + 1; x++) {\r\n        for (let y = this.point.y - 1; y <= this.point.y + 1; y++) {\r\n          for (let z = this.point.z - 1; z <= this.point.z + 1; z++) {\r\n            const mainX = targetLast.x + Math.round(x);\r\n            const mainY = targetLast.y + Math.round(y);\r\n            const mainZ = targetLast.z + Math.round(z);\r\n            offDst = mainX + mainY * this.xDim + mainZ * this.xDim * this.xDim;\r\n            if (this.bufferMask[offDst] === 0) {\r\n              this.bufferMask[offDst] = 255.0;\r\n              this.queue.push(new THREE.Vector3(x, y, z));\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    this.updatableTextureMask.needsUpdate = true;\r\n  }\r\n} // class Eraser\r\n","\r\n/**\r\n * 3D volume processing engine: blur, contrast filter\r\n * @module lib/scripts/graphics3d/volumeFilter3d\r\n */\r\n\r\nimport * as THREE from 'three';\r\nimport MaterialBlur from './gfx/matblur';\r\nimport GlSelector from './GlSelector';\r\nimport AmbientTexture from './ambientTexture';\r\nimport TransferTexture from './transferTexture'\r\nimport Eraser from './Eraser';\r\n/** Class VolumeFilter3d is used for 3d render */\r\nexport default class VolumeFilter3d {\r\n  constructor() {\r\n    this.transferFunc = null;\r\n    this.xDim = 0;\r\n    this.yDim = 0;\r\n    this.zDim = 0;\r\n    this.bufferTextureCPU = null;\r\n    this.eraser = null;\r\n  }\r\n\r\n  /**\r\n   * Filtering the source data and building the normals on the GPU\r\n   * @param isRoiVolume\r\n   * @param roiColors Array of roi colors in RGBA format\r\n   */\r\n  initRenderer(isRoiVolume, roiColors) {\r\n    this.sceneBlur = new THREE.Scene();\r\n    const blurSigma = 0.8;\r\n    this.numRois = 256;\r\n    // eslint-disable-next-line\r\n    this.cameraOrtho = new THREE.OrthographicCamera(this.xDim / -2, this.xDim / 2, this.yDim / 2, this.yDim / -2, 0.1, 100);\r\n    const glSelector = new GlSelector();\r\n    this.context = glSelector.createWebGLContext();\r\n    this.canvas3d = glSelector.getCanvas();\r\n    this.rendererBlur = new THREE.WebGLRenderer({\r\n      canvas: this.canvas3d,\r\n      context: this.context\r\n    });\r\n    this.ambientTexture = new AmbientTexture({\r\n      xDim: this.xDim,\r\n      yDim: this.yDim,\r\n      zDim: this.zDim,\r\n      renderer: this.rendererBlur,\r\n      scene: this.sceneBlur,\r\n      camera: this.cameraOrtho,\r\n    });\r\n\r\n    console.log('rendererBlur done');\r\n    const geometryBlur = new THREE.PlaneGeometry(1.0, 1.0);\r\n    this.rendererBlur.setSize(this.xDim, this.yDim);\r\n    //\r\n    this.transferFunc = new TransferTexture();\r\n    this.transferFunc.init(isRoiVolume, roiColors);\r\n    const texelSize = new THREE.Vector3(1.0 / this.xDim, 1.0 / this.yDim, 1.0 / this.zDim);\r\n    const matBlur = new MaterialBlur();\r\n\r\n    matBlur.create(this.origVolumeTex, this.RoiVolumeTex, texelSize, this.transferFunc.texRoiColor, this.transferFunc.texRoiId, (mat) => {\r\n      const mesh = new THREE.Mesh(geometryBlur, mat);\r\n      mat.uniforms.volumeSizeZ.value = this.zDim;\r\n      mat.uniforms.xDim.value = this.xDim;\r\n      mat.uniforms.yDim.value = this.yDim;\r\n      mat.defines.useWebGL2 = this.isWebGL2;\r\n      this.material = mat;\r\n      this.sceneBlur.add(mesh);\r\n      if (isRoiVolume === false) {\r\n        this.switchToBlurRender();\r\n      } else {\r\n        this.switchToRoiMapRender();\r\n      }\r\n      // render with blur and copy pixels back to this.bufferRgba\r\n      console.log(`isRoiVolume: ${isRoiVolume}`);\r\n      this.setVolumeTexture(blurSigma);\r\n    });\r\n    this.vectorsTex = null;\r\n  }\r\n\r\n  /**\r\n   * Create 2D texture containing transfer func colors\r\n  */\r\n  createTransferFuncTexture() {\r\n    if (this.transferFunc !== null) {\r\n      return this.transferFunc.createTransferFuncTexture();\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Creates transfer function color map\r\n   * @param ctrlPts Array of control points of type HEX  = color value\r\n   */\r\n  setTransferFuncColors(ctrlPtsColorsHex) {\r\n    this.transferFunc.setTransferFuncColors(ctrlPtsColorsHex);\r\n  }\r\n\r\n  /**\r\n   * Creates transfer function color map\r\n   * @param ctrlPts Array of Vector2 where (x,y) = x coordinate in [0, 1], alpha value in [0, 1]\r\n   * //intensity [0,255] opacity [0,1]\r\n   */\r\n  updateTransferFuncTexture(intensities, opacities) {\r\n    return this.transferFunc.updateTransferFuncTexture(intensities, opacities);\r\n  }\r\n\r\n  /**\r\n   * Setting a variable for conditional compilation (Roi Render)\r\n   */\r\n  switchToRoiMapRender() {\r\n    this.material.defines.renderRoiMap = 1;\r\n    this.material.needsUpdate = true;\r\n  }\r\n\r\n  /**\r\n   * Setting a variable for conditional compilation (Blur)\r\n   */\r\n  switchToBlurRender() {\r\n    this.material.defines.renderRoiMap = 0;\r\n    this.material.needsUpdate = true;\r\n  }\r\n\r\n  /**\r\n   * Filtering the source data and building the normals on the GPU\r\n   * @param blurSigma Gauss sigma parameter\r\n   */\r\n  setVolumeTexture(blurSigma) {\r\n    if ((!this.material) || (typeof this.material === 'undefined')) {\r\n      console.log('blur material null');\r\n      return;\r\n    }\r\n    console.log('blur material NOT null');\r\n    this.setVolumeTextureWebGL2(blurSigma);\r\n    this.updatableTexture.needsUpdate = true;\r\n  }\r\n\r\n  updateVolumeTextureWithMask() {\r\n    if (this.eraser.bufferMask === null){\r\n      console.log('volTextureMask null');\r\n    }\r\n    for (let z = 0; z < this.zDim; z++) {\r\n      const zVolOff = z * this.xDim * this.yDim;\r\n      for (let y = 0; y < this.yDim; y++) {\r\n        const yVol = y;\r\n        const yVolOff = yVol * this.xDim;\r\n        for (let x = 0; x < this.xDim; x++) {\r\n          const xVol = x;\r\n          const offSrc = (xVol + yVolOff + zVolOff);\r\n          let valInt = this.arrPixels[offSrc];\r\n          const offDst = offSrc;\r\n          if ((this.zDim > 5) && ((z === 0) || (z === this.zDim - 1) || (this.eraser.bufferMask[offSrc] === 0))) {\r\n            valInt = 0;\r\n          }\r\n          this.bufferR[offDst] = valInt;\r\n        }\r\n      }\r\n    }\r\n    this.origVolumeTex.needsUpdate = true;\r\n    this.setVolumeTexture(1.0);\r\n  }\r\n\r\n  setVolumeTextureWebGL2(blurSigma) {\r\n    this.material.uniforms.blurSigma.value = blurSigma;\r\n    this.material.uniforms.blurSigma.needsUpdate = true;\r\n    const VAL_1 = 1;\r\n    const VAL_2 = 2;\r\n    const VAL_3 = 3;\r\n    const VAL_4 = 4;\r\n    const frameBuf = new Uint8Array(VAL_4 * this.xDim * this.yDim);\r\n    const gl = this.rendererBlur.getContext();\r\n    for (let z = 1; z < this.zDim - 1; ++z) {\r\n      this.material.uniforms.curZ.value = z / this.zDim;\r\n      this.material.uniforms.curZ.needsUpdate = true;\r\n\r\n      this.rendererBlur.render(this.sceneBlur, this.cameraOrtho, this.bufferTexture);\r\n      gl.readPixels(0, 0, this.xDim, this.yDim, gl.RGBA, gl.UNSIGNED_BYTE, frameBuf);\r\n      const zOffs = z * this.xDim * this.yDim;\r\n      for (let y = 0; y < this.yDim; y++) {\r\n        for (let x = 0; x < this.xDim; x++) {\r\n          if (this.isRoiVolume) {\r\n            const indxR = VAL_4 * (x + y * this.xDim);\r\n            const indxL = indxR + zOffs * VAL_4;\r\n            this.bufferTextureCPU[indxL] = frameBuf[indxR];\r\n            this.bufferTextureCPU[indxL + VAL_1] = frameBuf[indxR + VAL_1];\r\n            this.bufferTextureCPU[indxL + VAL_2] = frameBuf[indxR + VAL_2];\r\n            this.bufferTextureCPU[indxL + VAL_3] = frameBuf[indxR + VAL_3];\r\n          } else {\r\n            this.bufferTextureCPU[x + y * this.xDim + zOffs] =\r\n            frameBuf[VAL_4 * (x + y * this.xDim)]; //256.0 * k / this.zDim;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Copies the source data into the buffer (bufferRgba) from which the 3� texture is created\r\n   */\r\n  set3DTextureFrom1Byte() {\r\n    const OFF0 = 0;\r\n    this.bufferTextureCPU = new Uint8Array(this.xDim * this.yDim * this.zDim);\r\n    this.bufferR = new Uint8Array(this.xDim * this.yDim * this.zDim);\r\n    // Fill initial rgba array\r\n    for (let z = 0; z < this.zDim; z++) {\r\n      const zVolOff = z * this.xDim * this.yDim;\r\n      for (let y = 0; y < this.yDim; y++) {\r\n        const yVol = y;\r\n        const yVolOff = yVol * this.xDim;\r\n        for (let x = 0; x < this.xDim; x++) {\r\n          const xVol = x;\r\n          const offSrc = (xVol + yVolOff + zVolOff);\r\n          let valInt = this.arrPixels[offSrc + 0];\r\n          const offDst = offSrc;\r\n          if (this.zDim > 5 && (z === 0 || z === this.zDim - 1)) {\r\n            valInt = 0;\r\n          }\r\n          this.bufferR[offDst + OFF0] = valInt;\r\n          this.bufferTextureCPU[offDst + OFF0] = valInt;\r\n        }\r\n      }\r\n    }\r\n    console.log('setBufferRgbaFrom1Bytes for 3d texture');\r\n  }\r\n\r\n  /**\r\n   * Copies the source data into the buffer (bufferRgba) from which the 3� texture is created\r\n   */\r\n  set3DTextureFrom4Bytes() {\r\n    const OFF0 = 0;\r\n    const OFF1 = 1;\r\n    const OFF2 = 2;\r\n    const OFF3 = 3;\r\n    const BID = 4;\r\n    if (this.isRoiVolume) {\r\n      this.bufferRoi = new Uint8Array(this.xDim * this.yDim * this.zDim);\r\n      this.bufferTextureCPU = new Uint8Array(BID * this.xDim * this.yDim * this.zDim);\r\n      console.log('ROI');\r\n    }\r\n    this.bufferR = new Uint8Array(this.xDim * this.yDim * this.zDim);\r\n    // Fill initial rgba array\r\n    for (let z = 0; z < this.zDim; z++) {\r\n      const zVolOff = z * this.xDim * this.yDim;\r\n      for (let y = 0; y < this.yDim; y++) {\r\n        const yVol = y;\r\n        const yVolOff = yVol * this.xDim;\r\n        for (let x = 0; x < this.xDim; x++) {\r\n          const xVol = x;\r\n\r\n          const offSrc = (xVol + yVolOff + zVolOff) * BID;\r\n          const valInt = this.arrPixels[offSrc + 0];\r\n          const valRoi = this.arrPixels[offSrc + OFF3];\r\n          //const valRoi = this.arrPixels[offSrc + 0];\r\n          //const valInt = this.arrPixels[offSrc + OFF3];\r\n          const offDst = xVol + yVolOff + zVolOff;\r\n          //if (x === 0 || x === this.xDim - 1 || y === 0 || y === this.yDim - 1 || z === 0 || z === this.zDim - 1)\r\n          if (x < 2 || x > this.xDim - 4 || y < 2 || y > this.yDim - 4 || z < 2 || z > this.zDim - 4)\r\n            this.bufferR[offDst + OFF0] = 0;\r\n          else\r\n            this.bufferR[offDst + OFF0] = valInt;\r\n          this.bufferTextureCPU[BID * offDst + OFF0] = valInt;\r\n          this.bufferTextureCPU[BID * offDst + OFF1] = valInt;\r\n          this.bufferTextureCPU[BID * offDst + OFF2] = valInt;\r\n          this.bufferTextureCPU[BID * offDst + OFF3] = valInt;\r\n          this.bufferRoi[offDst + OFF0] = valRoi;\r\n        }\r\n      }\r\n    }\r\n    console.log('setBufferRgbaFrom4Bytes for 3D texture');\r\n  }\r\n\r\n  /**\r\n   * Create 2D texture containing roi color map\r\n   * @param colorArray 256 RGBA roi colors\r\n   */\r\n  createRoiColorMap(colorArray) {\r\n    return this.transferFunc.createRoiColorMap(colorArray);\r\n  }\r\n\r\n  /**\r\n   * Create 2D texture containing selected ROIs\r\n   * @param colorArray 256 RGBA roi colors\r\n   */\r\n  createSelectedRoiMap() {\r\n    return this.createSelectedRoiMap();\r\n  }\r\n\r\n  /**\r\n   * Create 2D texture containing selected ROIs\r\n   * @param selectedROIs 256 byte roi values\r\n   */\r\n  updateSelectedRoiMap(selectedROIs) {\r\n    this.transferFunc.updateSelectedRoiMap(selectedROIs);\r\n    this.setVolumeTexture(1.0);\r\n  }\r\n  /**\r\n   * Update roi selection map\r\n   * @param roiId ROI id from 0..255\r\n   * @param selectedState True if roi must be visible\r\n   */\r\n  // eslint-disable-next-line\r\n  updateSelectedRoi(roiId, selectedState) {\r\n    this.transferFunc.updateSelectedRoi(roiId, selectedState);\r\n    this.setVolumeTexture(1.0);\r\n  }\r\n\r\n  /**\r\n   * Create 3D texture containing filtered source data and calculated normal values\r\n   * @param props An object that contains all volume-related info\r\n   * @param\r\n\r\n   * @param roiColors Array of roi colors in RGBA format\r\n   * @return (object) Created texture\r\n   */\r\n  createUpdatableVolumeTex(volume, isRoiVolume, roiColors) {\r\n    this.isWebGL2 = 1;\r\n    this.arrPixels = volume.m_dataArray;\r\n    const xDim = volume.m_xDim;\r\n    const yDim = volume.m_yDim;\r\n    const zDim = volume.m_zDim;\r\n    this.xDim = xDim;\r\n    this.yDim = yDim;\r\n    this.zDim = zDim;\r\n    this.isRoiVolume = isRoiVolume;\r\n\r\n    this.RoiVolumeTex = null;\r\n    if (!isRoiVolume) {\r\n      this.set3DTextureFrom1Byte();\r\n    } else {\r\n      this.set3DTextureFrom4Bytes();\r\n      this.RoiVolumeTex = new THREE.DataTexture3D(this.bufferRoi, this.xDim, this.yDim, this.zDim);\r\n      this.RoiVolumeTex.format = THREE.RedFormat; //RedFormat?\r\n      this.RoiVolumeTex.type = THREE.UnsignedByteType;\r\n      this.RoiVolumeTex.wrapS = THREE.ClampToEdgeWrapping;\r\n      this.RoiVolumeTex.wrapT = THREE.ClampToEdgeWrapping;\r\n      this.RoiVolumeTex.magFilter = THREE.NearestFilter;\r\n      this.RoiVolumeTex.minFilter = THREE.NearestFilter;\r\n      this.RoiVolumeTex.needsUpdate = true;\r\n    }\r\n    this.bufferTexture = new THREE.WebGLRenderTarget(this.xDim,\r\n      this.yDim, {\r\n        minFilter: THREE.LinearFilter,\r\n        magFilter: THREE.LinearFilter,\r\n        format: THREE.RGBAFormat,\r\n        type: THREE.UnsignedByteType,\r\n        depthBuffer: false,\r\n      });\r\n\r\n    if (this.origVolumeTex) {\r\n      this.origVolumeTex.dispose();\r\n    }\r\n\r\n    this.origVolumeTex = new THREE.DataTexture3D(this.bufferR, this.xDim, this.yDim, this.zDim);\r\n    this.origVolumeTex.format = THREE.RedFormat;\r\n    this.origVolumeTex.type = THREE.UnsignedByteType;\r\n    this.origVolumeTex.wrapR = THREE.ClampToEdgeWrapping;\r\n    this.origVolumeTex.wrapS = THREE.ClampToEdgeWrapping;\r\n    this.origVolumeTex.wrapT = THREE.ClampToEdgeWrapping;\r\n    this.origVolumeTex.magFilter = THREE.NearestFilter;//THREE.LinearFilter;\r\n    this.origVolumeTex.minFilter = THREE.NearestFilter;//THREE.LinearFilter;\r\n    this.origVolumeTex.needsUpdate = true;\r\n\r\n    let volTexFormat = THREE.RedFormat;\r\n    if (isRoiVolume) {\r\n      volTexFormat = THREE.RGBAFormat;\r\n    }\r\n    this.updatableTexture = new THREE.DataTexture3D(this.bufferTextureCPU, this.xDim, this.yDim, this.zDim);\r\n    this.updatableTexture.format = volTexFormat;\r\n    this.updatableTexture.type = THREE.UnsignedByteType;\r\n    this.updatableTexture.wrapR = THREE.ClampToEdgeWrapping;\r\n    this.updatableTexture.wrapS = THREE.ClampToEdgeWrapping;\r\n    this.updatableTexture.wrapT = THREE.ClampToEdgeWrapping;\r\n    this.updatableTexture.magFilter = THREE.LinearFilter;\r\n    this.updatableTexture.minFilter = THREE.LinearFilter;\r\n    if (this.zDim > 1) {\r\n      this.initRenderer(isRoiVolume, roiColors);\r\n    }\r\n    this.updatableTexture.needsUpdate = true;\r\n    this.eraser = new Eraser();\r\n    return this.updatableTexture;\r\n  }\r\n\r\n  /**\r\n   * Create 3D texture containing mask of data which were erase\r\n   * @param volume An object that contains all volume-related info\r\n   * @return (object) Created texture\r\n   */\r\n  createUpdatableVolumeMask(params) {\r\n    return this.eraser.createUpdatableVolumeMask(params, this.bufferTextureCPU);\r\n  }\r\n} // class VolumeFilter3d\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Text rendering to canvas\r\n* @module lib/scripts/graphics2d/canvastext\r\n*/\r\n\r\n// import * as THREE from 'three';\r\n\r\nconst FONT_FOR_TEXT_RENDER = '72px Arial';\r\n\r\n/** Class CanvasText is used for render text to canvas via HTML5 interface */\r\nexport default class CanvasText {\r\n  /**\r\n  * Initialize Canvas text renderer\r\n  */\r\n  constructor() {\r\n    this.m_textWidth = 0;\r\n    this.m_textHeight = 0;\r\n    this.m_canvas = document.createElement('canvas');\r\n    this.m_ctx = this.m_canvas.getContext('2d');\r\n  }\r\n\r\n  get width() {\r\n    return this.m_canvas.width;\r\n  }\r\n\r\n  get height() {\r\n    return this.m_canvas.height;\r\n  }\r\n\r\n  get textWidth() {\r\n    return this.m_textWidth;\r\n  }\r\n\r\n  get textHeight() {\r\n    return this.m_textHeight;\r\n  }\r\n\r\n  static getFontHeight(strFont) {\r\n    const body = document.getElementsByTagName('body')[0];\r\n    const dummy = document.createElement('div');\r\n    const dummyText = document.createTextNode('GyW~ig^');\r\n    dummy.appendChild(dummyText);\r\n    dummy.setAttribute('style', `font:${strFont};position:absolute;top:0;left:0`);\r\n    body.appendChild(dummy);\r\n    const result = dummy.offsetHeight;\r\n    // fontHeightCache[fontStyle] = result;\r\n    body.removeChild(dummy);\r\n    return result;\r\n  }\r\n\r\n  /**\r\n  * Returns the smallest power of 2 that is greater than or equal to val.\r\n  * @param (number) val - value to search closest power of 2.\r\n  * @return {number} the smallest power of 2 that is greater than or equal to val\r\n  */\r\n  static ceilPowerOfTwo(val) {\r\n    const FAIL = -1;\r\n    const MAX_PWR = 30;\r\n    for (let i = 1; i < MAX_PWR; i++) {\r\n      const valPwr = 1 << i;\r\n      if (valPwr >= val) {\r\n        return valPwr;\r\n      }\r\n    }\r\n    return FAIL;\r\n  }\r\n\r\n  /**\r\n  * Initialize Canvas text renderer\r\n  * @param (strint) strTextToRender - text to render\r\n  * @return {Object} Canvas with rendered text\r\n  */\r\n  drawText(strTextToRender, strTextColor) {\r\n    // clear screen\r\n    this.m_canvas.width = 1024;\r\n    this.m_canvas.height = 512;\r\n    this.m_ctx.fillStyle = 'rgba(255, 255, 255, 0)';\r\n    const MAX_EXTENT_X = 512;\r\n    const MAX_EXTENT_Y = 128;\r\n    this.m_ctx.fillRect(0, 0, MAX_EXTENT_X, MAX_EXTENT_Y);\r\n\r\n    this.m_ctx.font = FONT_FOR_TEXT_RENDER;\r\n    this.m_ctx.fillStyle = strTextColor;\r\n    this.m_ctx.strokeStyle = strTextColor;\r\n    this.m_ctx.textAlign = 'left';\r\n    this.m_ctx.textBaseline = 'top';\r\n    this.m_ctx.lineWidth = 2;\r\n\r\n    const strText = (strTextToRender.length === 0) ? '?' : strTextToRender;\r\n\r\n    this.m_textWidth = Math.floor(this.m_ctx.measureText(strText).width);\r\n    this.m_textHeight = CanvasText.getFontHeight(FONT_FOR_TEXT_RENDER);\r\n\r\n\r\n    // set canvas size to desired dimension\r\n    // this.m_canvas.width = THREE.Math.ceilPowerOfTwo(this.m_textWidth);\r\n    // this.m_canvas.height = THREE.Math.ceilPowerOfTwo(this.m_textHeight);\r\n    this.m_canvas.width = CanvasText.ceilPowerOfTwo(this.m_textWidth);\r\n    this.m_canvas.height = CanvasText.ceilPowerOfTwo(this.m_textHeight);\r\n\r\n    // console.log(`CanvasText canvas size = ${this.m_canvas.width} * ${this.m_canvas.height}`);\r\n    // console.log(`CanvasText  text size = ${this.m_textWidth} * ${this.m_textHeight}`);\r\n\r\n    // clear screen\r\n    this.m_ctx.fillStyle = 'rgba(255, 255, 255, 0)';\r\n    this.m_ctx.fillRect(0, 0, this.m_canvas.width, this.m_canvas.height);\r\n\r\n    // render text string\r\n    this.m_ctx.font = FONT_FOR_TEXT_RENDER;\r\n    this.m_ctx.fillStyle = strTextColor;\r\n    this.m_ctx.strokeStyle = strTextColor;\r\n    this.m_ctx.textAlign = 'left';\r\n    this.m_ctx.textBaseline = 'top';\r\n    this.m_ctx.fillText(strText, 0, 0);\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* 2d text render\r\n* @module lib/scripts/graphics2d/text2d\r\n*/\r\n\r\nimport * as THREE from 'three';\r\n\r\nimport CanvasText from './canvastext';\r\n\r\n/** Class Text2D is used for render text to canvas via HTML5 interface */\r\nexport default class Text2D extends THREE.Object3D {\r\n  constructor(strText) {\r\n    super();\r\n    this.m_canvas = new CanvasText();\r\n    this.m_align = new THREE.Vector2(0, 0);\r\n    this.m_side = THREE.DoubleSide;\r\n    this.m_antialias = true;\r\n    this.m_text = strText;\r\n  }\r\n\r\n  getText() {\r\n    return this.m_text;\r\n  }\r\n\r\n  setText(val) {\r\n    if (this.m_text !== val) {\r\n      this.m_text = val;\r\n      this.updateText();\r\n    }\r\n  }\r\n\r\n  getFont() {\r\n    return this.m_font;\r\n  }\r\n\r\n  updateText() {\r\n    console.log(`Use virtual method for ${this.m_text}`);\r\n  }\r\n\r\n  cleanUp() {\r\n    if (this.texture) {\r\n      this.texture.dispose();\r\n    }\r\n  }\r\n\r\n  applyAntiAlias() {\r\n    if (this.antialias === false) {\r\n      this.texture.magFilter = THREE.NearestFilter;\r\n      this.texture.minFilter = THREE.LinearMipMapLinearFilter;\r\n    }\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* 2d texture simplest render\r\n* @module lib/scripts/gfx/mattplain\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\n/** Class @class MaterialTexturePlain2d for create artifical volume */\r\nexport default class MaterialTexturePlain2d {\r\n\r\n  /** Simple material constructor\r\n  * @constructor\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n    this.m_uniforms = {\r\n      texture1: { type: 't', value: null },\r\n    };\r\n    this.m_strShaderVertex = `\r\n      varying vec3 vecNormal;\r\n      varying vec3 vecPos;\r\n      varying vec2 vecUV;\r\n      void main() {\r\n        vecPos = position;\r\n        vecNormal = normal;\r\n        vecUV = uv;\r\n        gl_Position = vec4(position, 1.0);\r\n      }\r\n    `;\r\n    this.m_strShaderFragment = `\r\n      varying vec3 vecNormal;\r\n      varying vec3 vecPos;\r\n      varying vec2 vecUV;\r\n\r\n      uniform sampler2D texture1;\r\n\r\n      void main() {\r\n        vec2 texCoord = vecUV;\r\n        vec4 vColTex = texture2D(texture1, texCoord, 0.0);\r\n        float sum = (vColTex.x + vColTex.y + vColTex.z) / 3.0;\r\n        if (sum < 20.0 / 256.0)\r\n          discard;\r\n        gl_FragColor = vec4(vColTex.x, vColTex.y, vColTex.z, sum);\r\n      }\r\n    `;\r\n  }\r\n\r\n  /** Simple material constructor\r\n  * @return {object} Three.js material with this shader\r\n  */\r\n  create(tex) {\r\n    // Init uniforms\r\n    this.m_uniforms.texture1.value = tex;\r\n\r\n    this.m_material = new THREE.ShaderMaterial({\r\n      blending: THREE.CustomBlending,\r\n      blendEquation: THREE.AddEquation,\r\n      blendSrc: THREE.SrcAlphaFactor,\r\n      blendDst: THREE.OneMinusSrcAlphaFactor,\r\n      uniforms: this.m_uniforms,\r\n      vertexShader: this.m_strShaderVertex,\r\n      fragmentShader: this.m_strShaderFragment\r\n    });\r\n    this.m_material.needsUpdate = true;\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Mesh with 2d text\r\n* @module lib/scripts/graphics2d/meshtext2d\r\n*/\r\n\r\nimport * as THREE from 'three';\r\n\r\nimport Text2D from './text2d';\r\nimport MaterialTexturePlain2d from '../gfx/mattplain';\r\n\r\nexport default class MeshText2D extends Text2D {\r\n  constructor(strText) {\r\n    super(strText);\r\n    this.m_mesh = null;\r\n    this.m_material = null;\r\n    this.m_renderedTextHeight = 0.0;\r\n    this.m_xMin = 3.0;\r\n    this.m_xMax = -3.0;\r\n    this.m_yMin = 3.0;\r\n    this.m_yMax = -3.0;\r\n  }\r\n\r\n  static getXMin(xc, xAlign, psx) {\r\n    if (xAlign === MeshText2D.ALIGN_LEFT) {\r\n      return xc;\r\n    } else if (xAlign === MeshText2D.ALIGN_RIGHT) {\r\n      return xc - psx;\r\n    } else if (xAlign === MeshText2D.ALIGN_CENTER) {\r\n      return xc - psx * 0.5;\r\n    }\r\n    return 0.0;\r\n  }\r\n\r\n  static getXMax(xc, xAlign, psx) {\r\n    if (xAlign === MeshText2D.ALIGN_LEFT) {\r\n      return xc + psx;\r\n    } else if (xAlign === MeshText2D.ALIGN_RIGHT) {\r\n      return xc;\r\n    } else if (xAlign === MeshText2D.ALIGN_CENTER) {\r\n      return xc + psx * 0.5;\r\n    }\r\n    return 0.0;\r\n  }\r\n\r\n  static getYMin(yc, yAlign, psy) {\r\n    if (yAlign === MeshText2D.ALIGN_TOP) {\r\n      return yc - psy;\r\n    } else if (yAlign === MeshText2D.ALIGN_BOTTOM) {\r\n      return yc;\r\n    } else if (yAlign === MeshText2D.ALIGN_CENTER) {\r\n      return yc - psy * 0.5;\r\n    }\r\n    return 0.0;\r\n  }\r\n\r\n  static getYMax(yc, yAlign, psy) {\r\n    if (yAlign === MeshText2D.ALIGN_TOP) {\r\n      return yc;\r\n    } else if (yAlign === MeshText2D.ALIGN_BOTTOM) {\r\n      return yc + psy;\r\n    } else if (yAlign === MeshText2D.ALIGN_CENTER) {\r\n      return yc + psy * 0.5;\r\n    }\r\n    return 0.0;\r\n  }\r\n\r\n  getRenderedTextHeight() {\r\n    return this.m_renderedTextHeight;\r\n  }\r\n\r\n  /**\r\n  * Update text 2d object: create mesh in desired position, content and width\r\n  * @param (object) container - object container for 3d rendering\r\n  * @param (int) xc - text anchor x coordinate\r\n  * @param (int) yc - text anchor y coordinate\r\n  * @param (float) letterHeight - single letter height in range [-1..+1]\r\n  * @param (string ) strTextBackColor - Background color, like rgba(255, 0, 0, 255), i.e. red color\r\n  */\r\n  updateText(xc, yc, letterHeight, xAlign, yAlign, strTextBackColor, strTextColor) {\r\n    // console.log('MeshText2D.updateText()...');\r\n    this.cleanUp();\r\n\r\n    if (this.m_mesh !== null) {\r\n      this.remove(this.m_mesh);\r\n      this.m_mesh = null;\r\n      this.m_material = null;\r\n    }\r\n\r\n    this.m_canvas.drawText(this.m_text, strTextColor);\r\n\r\n    this.m_renderedTextHeight = letterHeight;\r\n    const wPerHRatio = this.m_canvas.m_textWidth / this.m_canvas.m_textHeight;\r\n    const psy = letterHeight;\r\n    const psx = psy * wPerHRatio;\r\n\r\n    // console.log(`2dtext. text box = ${psx} * ${psy}, Ratio = ${wPerHRatio}`);\r\n\r\n    this.m_texture = new THREE.Texture(this.m_canvas.m_canvas);\r\n    this.m_texture.needsUpdate = true;\r\n    if (this.m_material === null) {\r\n      this.m_matTexturePlain = new MaterialTexturePlain2d();\r\n      this.m_matTexturePlain.create(this.m_texture);\r\n\r\n      this.m_material = this.m_matTexturePlain.m_material;\r\n\r\n      this.m_material.blending = THREE.CustomBlending;\r\n      this.m_material.blendEquation = THREE.AddEquation; // default\r\n      this.m_material.blendSrc = THREE.SrcAlphaFactor; // default\r\n      this.m_material.blendDst = THREE.OneMinusSrcAlphaFactor; // default\r\n\r\n      // create quad geometry\r\n      this.m_geometry = new THREE.Geometry();\r\n      // v2 ----- v3\r\n      // |        |\r\n      // |        |\r\n      // v0 ----- v1\r\n\r\n      // tex coordinate max\r\n      const X_TEXT_COORD_MAX = this.m_canvas.m_textWidth / this.m_canvas.m_canvas.width;\r\n      const Y_TEXT_COORD_MAX = this.m_canvas.m_textHeight / this.m_canvas.m_canvas.height;\r\n\r\n      // console.log(`2dtext. texture coord max = ${X_TEXT_COORD_MAX} * ${Y_TEXT_COORD_MAX}`);\r\n      // console.log(`text canvas dim on screen = ${this.m_canvas.m_textWidth} * ${this.m_canvas.m_textHeight}`);\r\n      // console.log(`psx = ${psx}, psy = ${psy}`);\r\n\r\n      this.m_xMin = MeshText2D.getXMin(xc, xAlign, psx);\r\n      this.m_xMax = MeshText2D.getXMax(xc, xAlign, psx);\r\n      this.m_yMin = MeshText2D.getYMin(yc, yAlign, psy);\r\n      this.m_yMax = MeshText2D.getYMax(yc, yAlign, psy);\r\n\r\n      const Z_COORD_TEXT = 0.05;\r\n      const v0 = new THREE.Vector3(this.m_xMin, this.m_yMin, Z_COORD_TEXT);\r\n      const v1 = new THREE.Vector3(this.m_xMax, this.m_yMin, Z_COORD_TEXT);\r\n      const v2 = new THREE.Vector3(this.m_xMin, this.m_yMax, Z_COORD_TEXT);\r\n      const v3 = new THREE.Vector3(this.m_xMax, this.m_yMax, Z_COORD_TEXT);\r\n\r\n      this.m_geometry.vertices.push(v0);\r\n      this.m_geometry.vertices.push(v1);\r\n      this.m_geometry.vertices.push(v2);\r\n      this.m_geometry.vertices.push(v3);\r\n\r\n      // console.log(`Texture text render max = ${X_TEXT_COORD_MAX} , ${Y_TEXT_COORD_MAX}`);\r\n\r\n      // add texture coordinates\r\n      this.m_geometry.faceVertexUvs[0].push([\r\n        new THREE.Vector2(0.0, 1.0 - Y_TEXT_COORD_MAX),\r\n        new THREE.Vector2(X_TEXT_COORD_MAX, 1.0 - Y_TEXT_COORD_MAX),\r\n        new THREE.Vector2(0.0, 1.0),\r\n      ]);\r\n      this.m_geometry.faceVertexUvs[0].push([\r\n        new THREE.Vector2(X_TEXT_COORD_MAX, 1.0),\r\n        new THREE.Vector2(0.0, 1.0),\r\n        new THREE.Vector2(X_TEXT_COORD_MAX, 1.0 - Y_TEXT_COORD_MAX),\r\n      ]);\r\n      const normal = new THREE.Vector3();\r\n      THREE.Triangle.getNormal(v0, v1, v2, normal);\r\n\r\n      // eslint-disable-next-line\r\n      this.m_geometry.faces.push(new THREE.Face3(0, 1, 2, normal));\r\n      // eslint-disable-next-line\r\n      this.m_geometry.faces.push(new THREE.Face3(3, 2, 1, normal));\r\n\r\n      this.m_mesh = new THREE.Mesh(this.m_geometry, this.m_material);\r\n      this.add(this.m_mesh);\r\n\r\n      // create text box with solid fill\r\n      const boxCanvas = document.createElement('canvas');\r\n      const context = boxCanvas.getContext('2d');\r\n      boxCanvas.width = 32;\r\n      boxCanvas.height = 32;\r\n      // green color as box background\r\n      context.fillStyle = strTextBackColor;\r\n      context.fillRect(0, 0, boxCanvas.width, boxCanvas.height);\r\n      const boxTexture = new THREE.Texture(boxCanvas);\r\n      boxTexture.needsUpdate = true;\r\n      this.m_matTextureBox = new MaterialTexturePlain2d();\r\n      this.m_matTextureBox.create(boxTexture, (mat) => {\r\n        this.m_boxMaterial = mat;\r\n\r\n        // box geometry and mesh with this 2d simple texture material\r\n        const Z_COORD_BOX = 0.06;\r\n        this.m_boxGeometry = new THREE.Geometry();\r\n        const vb0 = new THREE.Vector3(this.m_xMin, this.m_yMin, Z_COORD_BOX);\r\n        const vb1 = new THREE.Vector3(this.m_xMax, this.m_yMin, Z_COORD_BOX);\r\n        const vb2 = new THREE.Vector3(this.m_xMin, this.m_yMax, Z_COORD_BOX);\r\n        const vb3 = new THREE.Vector3(this.m_xMax, this.m_yMax, Z_COORD_BOX);\r\n        this.m_boxGeometry.vertices.push(vb0);\r\n        this.m_boxGeometry.vertices.push(vb1);\r\n        this.m_boxGeometry.vertices.push(vb2);\r\n        this.m_boxGeometry.vertices.push(vb3);\r\n        let boxNormal;\r\n        THREE.Triangle.getNormal(vb0, vb1, vb2, boxNormal);\r\n\r\n        // eslint-disable-next-line\r\n        this.m_boxGeometry.faces.push(new THREE.Face3(0, 1, 2, boxNormal));\r\n        // eslint-disable-next-line\r\n        this.m_boxGeometry.faces.push(new THREE.Face3(3, 2, 1, boxNormal));\r\n        this.m_boxMesh = new THREE.Mesh(this.m_boxGeometry, this.m_boxMaterial);\r\n        this.add(this.m_boxMesh);\r\n      });\r\n    } else {\r\n      this.m_material.map = this.m_texture;\r\n    }\r\n  } // updateText\r\n}\r\n// consts\r\nMeshText2D.ALIGN_LEFT = 0;\r\nMeshText2D.ALIGN_RIGHT = 1;\r\nMeshText2D.ALIGN_TOP = 2;\r\nMeshText2D.ALIGN_BOTTOM = 3;\r\nMeshText2D.ALIGN_CENTER = 4;\r\n\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Simple 2d mode material wiithout texture and lighting, only ambient color used\r\n* @module lib/scripts/gfx/matcolor2d\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n// absoulte imports\r\nimport * as THREE from 'three';\r\n\r\n/** Class @class MaterialColor2d for create 2d lines, etc */\r\nexport default class MaterialColor2d {\r\n  /** Simple material constructor\r\n  * @constructor\r\n  * @param (float) r - color component(red) in [0..1]\r\n  * @param (float) g - color component(green) in [0..1]\r\n  * @param (float) b - color component(blue) in [0..1]\r\n  */\r\n  constructor() {\r\n    this.m_strShaderVertex = '';\r\n    this.m_strShaderFragment = '';\r\n  }\r\n\r\n  create() {\r\n    this.m_strShaderVertex = `\r\n      void main() {\r\n        gl_Position = vec4(position, 1.0);\r\n      }\r\n    `;\r\n    this.m_strShaderFragment = `\r\n      void main() {\r\n        gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);\r\n      }\r\n    `;\r\n    const material = new THREE.ShaderMaterial({\r\n      vertexShader: this.m_strShaderVertex,\r\n      fragmentShader: this.m_strShaderFragment,\r\n      //side: THREE.FrontSide,\r\n      wireframe: true,\r\n      //depthTest: false\r\n      //clipping: false,\r\n    });\r\n    return material;\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Render 2d lines in scene\r\n* @module app/scripts/graphics2d/line2d\r\n*/\r\n\r\nimport * as THREE from 'three';\r\n\r\n// image z coord == 0.8\r\nconst LINE_2D_Z_COORDINATE = 0.11;\r\n\r\n/** Class LineD is used for render lines in 2d mode */\r\nexport default class Line2D {\r\n  /**\r\n  * Constructor. Create line 2d mode and add to scene on render\r\n  * @param (object) scene - Scene where object will be rendered\r\n  * @param (float) lineWidth - Line width in scale [-1..+1]\r\n  * @param (float) xs - Line start, x coordinate\r\n  * @param (float) ys - Line start, y coordinate\r\n  * @param (float) xe - Line end, x coordinate\r\n  * @param (float) ye - Line end, y coordinate\r\n  * @param (object) matColor2d - MaterialColor2d\r\n  */\r\n  constructor(scene, lineWidth, xs, ys, xe, ye, matColor2d) {\r\n    this.createWithMaterial(scene, lineWidth, xs, ys, xe, ye, matColor2d);\r\n    this.m_xS = xs;\r\n    this.m_yS = ys;\r\n    this.m_xE = xe;\r\n    this.m_yE = ye;\r\n  }\r\n\r\n  createWithMaterial(scene,\r\n    lineWidth,\r\n    xs, ys, xe, ye,\r\n    matColor2d) {\r\n    this.m_scene = scene;\r\n    this.m_lineWidth = lineWidth;\r\n\r\n    const vLine = new THREE.Vector2(xe - xs, ye - ys);\r\n    const vNorm = new THREE.Vector2(+vLine.y, -vLine.x);\r\n    vNorm.normalize();\r\n    vNorm.multiplyScalar(lineWidth);\r\n\r\n    //      0   start    1\r\n    //      +-----+------+    ----> vNorm\r\n    //      |\\           |\r\n    //      | \\          |\r\n    //      |  \\         |\r\n    //      |   \\        |\r\n    //      |    \\       |\r\n    //      |     \\      |\r\n    //      |      \\     |\r\n    //      |       \\    |\r\n    //      |        \\   |\r\n    //      |         \\  |\r\n    //      |          \\ |\r\n    //      |           \\|\r\n    //      +-----+------+\r\n    //      2    end     3\r\n    //\r\n    const v0 = new THREE.Vector3(xs - vNorm.x, ys - vNorm.y, LINE_2D_Z_COORDINATE);\r\n    const v1 = new THREE.Vector3(xs + vNorm.x, ys + vNorm.y, LINE_2D_Z_COORDINATE);\r\n    const v2 = new THREE.Vector3(xe - vNorm.x, ye - vNorm.y, LINE_2D_Z_COORDINATE);\r\n    const v3 = new THREE.Vector3(xe + vNorm.x, ye + vNorm.y, LINE_2D_Z_COORDINATE);\r\n\r\n    this.m_geo = new THREE.Geometry();\r\n    this.m_geo.vertices.push(v0);\r\n    this.m_geo.vertices.push(v1);\r\n    this.m_geo.vertices.push(v2);\r\n    this.m_geo.vertices.push(v3);\r\n\r\n    const normal = new THREE.Vector3(0.0, 0.0, 1.0);\r\n    // eslint-disable-next-line\r\n    this.m_geo.faces.push(new THREE.Face3(0, 1, 3, normal));\r\n    // eslint-disable-next-line\r\n    this.m_geo.faces.push(new THREE.Face3(3, 2, 0, normal));\r\n\r\n    //this.planeGeometry = new THREE.PlaneBufferGeometry(0.5, 0.5);\r\n    //const plane = new THREE.Mesh(this.planeGeometry, matColor2d.m_material);\r\n    //this.m_scene.add(plane);\r\n\r\n    //this.m_mesh = new THREE.Mesh(this.m_geo, matColor2d.m_material);\r\n    this.m_mesh = new THREE.Mesh(this.m_geo, matColor2d);\r\n    this.m_scene.add(this.m_mesh);\r\n    console.log(`Line added to scene: ${xs},${ys} -> ${xe},${ye} `);\r\n  }\r\n\r\n  /**\r\n  * Get object for further scene addition. Need to remove old line from scene\r\n  * @return (object) line object\r\n  */\r\n  getRenderObject() {\r\n    return this.m_mesh;\r\n  }\r\n\r\n  /**\r\n  * Return coordinate x of start point\r\n  * @return (float) x\r\n  */\r\n  getxS() {\r\n    return this.m_xS;\r\n  }\r\n\r\n  /**\r\n  * Return coordinate y of start point\r\n  * @return (float) y\r\n  */\r\n  getyS() {\r\n    return this.m_yS;\r\n  }\r\n\r\n  /**\r\n  * Return coordinate x of end point\r\n  * @return (float) x\r\n  */\r\n  getxE() {\r\n    return this.m_xE;\r\n  }\r\n\r\n  /**\r\n  * Return coordinate y of end point\r\n  * @return (float) y\r\n  */\r\n  getyE() {\r\n    return this.m_yE;\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n * 2d distance tool\r\n * @module app/scripts/graphics2d/distancetool\r\n */\r\n\r\nimport MeshText2D from './meshtext2d';\r\nimport MaterialColor2d from '../gfx/matcolor2d';\r\nimport Line2D from './line2d';\r\n\r\nexport default class DistanceTool {\r\n\r\n  /**\r\n   * Initialize distance tool\r\n   * @param (object) scene - scene object\r\n   * @param (object) lineWidth - width of all lines\r\n   */\r\n  constructor(scene, lineWidth) {\r\n    /** @property {Object} m_scene - scene object */\r\n    this.m_scene = scene;\r\n    /** @property {float} m_lineWidth - width for all lines */\r\n    this.m_lineWidth = lineWidth;\r\n    /** @property {boolean} m_runningState - true if last line has not been fixed yet */\r\n    this.m_runningState = false;\r\n    /** @property {float} m_xPixelSize - canvas pixel size in mm for x axis */\r\n    this.m_xPixelSize = -1; // in mm\r\n    /** @property {float} yPixelSize - canvas pixel size in mm for y axis */\r\n    this.m_yPixelSize = -1; // in mm\r\n    /** @property {Object} m_linesMaterial - line material object */\r\n    //const R_MATERIAL = 0.86;\r\n    //const G_MATERIAL = 0.59;\r\n    //const B_MATERIAL = 0.17;\r\n    //this.m_linesMaterial = new MaterialColor2d(R_MATERIAL, G_MATERIAL, B_MATERIAL);\r\n    const linesMaterial = new MaterialColor2d();\r\n    this.m_linesMaterial = linesMaterial.create();\r\n    /** @property {Array} m_distances - array of pairs (line, text), contains all visible measurements */\r\n    this.m_distances = [];\r\n    /** @property {Array} m_vertexes - array of pairs (x, y) */\r\n    this.m_vertexes = [];\r\n    /** @property {float} m_xStart - start x coordinate for current not fixed line */\r\n    this.m_xStart = -1;\r\n    /** @property {float} m_yStart - start y coordinate for current not fixed line */\r\n    this.m_yStart = -1;\r\n    /** @property {float} m_textWidthScr - text width in [0..2] */\r\n    this.m_textWidthScr = 0.03;\r\n    /** @property {Object} m_textColor - text color */\r\n    this.m_textColor = 'rgba(255, 255, 255, 255)';\r\n    /** @property {Object} m_textBgColor - text background color */\r\n    this.m_textBgColor = 'rgb(65, 65, 65)';\r\n    /** @property {float} m_zoom - size zoom */\r\n    this.m_zoom = 1;\r\n  }\r\n\r\n  /**\r\n   * Remove all distance lines from scene\r\n   */\r\n  clearLines() {\r\n    const length = this.m_distances.length;\r\n    for (let i = 0; i < length; ++i) {\r\n      const dist = this.m_distances.pop();\r\n      this.m_scene.remove(dist.line.getRenderObject());\r\n      this.m_scene.remove(dist.text);\r\n    }\r\n    this.m_runningState = false;\r\n    this.m_vertexes = [];\r\n  }\r\n\r\n  /**\r\n   * Redraw all lines\r\n   */\r\n  updateLines(zoom, posX, posY) {\r\n    const COUNT_POINTS = 2;\r\n    const MODULO_1 = 1;\r\n    const length = this.m_distances.length;\r\n    for (let i = 0; i < length; ++i) {\r\n      this.m_scene.remove(this.m_distances[i].line.getRenderObject());\r\n      this.m_scene.remove(this.m_distances[i].text);\r\n      const xS = (this.m_vertexes[COUNT_POINTS * i].xZ - posX) / zoom - (1 - 1 / zoom);\r\n      const yS = (this.m_vertexes[COUNT_POINTS * i].yZ - posY) / zoom + (1 - 1 / zoom);\r\n      if (this.m_vertexes[COUNT_POINTS * i + 1] == null) {\r\n        break;\r\n      }\r\n      const xE = (this.m_vertexes[COUNT_POINTS * i + MODULO_1].xZ - posX) / zoom - (1 - 1 / zoom);\r\n      const yE = (this.m_vertexes[COUNT_POINTS * i + MODULO_1].yZ - posY) / zoom + (1 - 1 / zoom);\r\n      const line = new Line2D(this.m_scene, this.m_lineWidth, xS, yS, xE, yE, this.m_linesMaterial);\r\n      this.m_distances[i].line = line;\r\n      this.m_distances[i].text.updateText(0.5 * (xS + xE) - 0.00, 0.5 * (yS + yE) - 0.00, this.m_textWidthScr,\r\n        MeshText2D.ALIGN_CENTER, MeshText2D.ALIGN_CENTER, this.m_textBgColor, this.m_textColor);\r\n      this.m_scene.add(this.m_distances[i].text);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update zoom\r\n   */\r\n  updateZoom(zoom) {\r\n    this.m_zoom = zoom;\r\n  }\r\n\r\n  /**\r\n   * Set pixel size in mm\r\n   * @param (float) xPixelSize - canvas pixel size in mm for x axis\r\n   * @param (float) yPixelSize - canvas pixel size in mm for y axis\r\n   */\r\n  setPixelSize(xPixelSize, yPixelSize) { // in mm\r\n    this.m_xPixelSize = xPixelSize;\r\n    this.m_yPixelSize = yPixelSize;\r\n  }\r\n\r\n  /**\r\n   * Return running state\r\n   * @return {boolean} True if last line has not been fixed yet\r\n   */\r\n  isRunning() {\r\n    return this.m_runningState;\r\n  }\r\n\r\n  /**\r\n   * Mouse down events handler\r\n   * @param (float) x - mouse x coordinate\r\n   * @param (float) y - mouse y coordinate\r\n   */\r\n  onMouseDown(x, y, zoom, posX, posY) {\r\n    this.m_runningState = !this.m_runningState;\r\n    const xZ = (x + (1 - 1 / zoom)) * zoom + posX;\r\n    const yZ = (y - (1 - 1 / zoom)) * zoom + posY;\r\n    if (this.m_runningState) {\r\n      this.m_xStart = x;\r\n      this.m_yStart = y;\r\n\r\n      const line = new Line2D(this.m_scene, this.m_lineWidth, x, y, x, y, this.m_linesMaterial);\r\n      const strMsg = '0 mm';\r\n      const text = new MeshText2D(strMsg);\r\n      text.updateText(x, y, this.m_textWidthScr, MeshText2D.ALIGN_CENTER,\r\n        MeshText2D.ALIGN_CENTER, this.m_textBgColor, this.m_textColor);\r\n      this.m_scene.add(text);\r\n      this.m_distances.push({ line, text });\r\n      this.m_vertexes.push({ xZ, yZ });\r\n    } else {\r\n      this.m_vertexes.push({ xZ, yZ });\r\n      this.m_xStart = -1;\r\n      this.m_yStart = -1;\r\n    }\r\n  }\r\n\r\n  test() {\r\n    new Line2D(this.m_scene, this.m_lineWidth, -1.0, 1.0, -0.5, 0.5, this.m_linesMaterial);\r\n  }\r\n\r\n  /**\r\n   * Mouse move events handler\r\n   * @param (float) x - mouse x coordinate\r\n   * @param (float) y - mouse y coordinate\r\n   */\r\n  onMouseMove(x, y, zoom) {\r\n    if (this.m_runningState) {\r\n      const dist = this.m_distances.pop();\r\n      this.m_scene.remove(dist.line.getRenderObject());\r\n      const line = new Line2D(this.m_scene, this.m_lineWidth, this.m_xStart, this.m_yStart, x, y, this.m_linesMaterial);\r\n      this.m_scene.remove(dist.text);\r\n      const strMsg = `${(zoom * (Math.sqrt((x - this.m_xStart) * (x - this.m_xStart)\r\n        * this.m_xPixelSize * this.m_xPixelSize +\r\n        // eslint-disable-next-line\r\n        (y - this.m_yStart) * (y - this.m_yStart) * this.m_yPixelSize * this.m_yPixelSize))).toFixed(2)} mm`;\r\n      const text = new MeshText2D(strMsg);\r\n      text.updateText(0.5 * (x + this.m_xStart) - 0.00, 0.5 * (y + this.m_yStart) - 0.00, this.m_textWidthScr,\r\n        MeshText2D.ALIGN_CENTER, MeshText2D.ALIGN_CENTER, this.m_textBgColor, this.m_textColor);\r\n      this.m_scene.add(text);\r\n      this.m_distances.push({ line, text });\r\n    }\r\n  }\r\n\r\n  updateVertexes(zoom, posX, posY) {\r\n    this.m_vertexes = [];\r\n    for (let i = 0; i < this.m_distances.length; ++i) {\r\n      let xZ = (this.m_distances[i].line.getxS() + (1 - 1 / zoom)) * zoom + posX;\r\n      let yZ = (this.m_distances[i].line.getyS() - (1 - 1 / zoom)) * zoom + posY;\r\n      this.m_vertexes.push({ xZ, yZ });\r\n      xZ = (this.m_distances[i].line.getxE() + (1 - 1 / zoom)) * zoom + posX;\r\n      yZ = (this.m_distances[i].line.getyE() - (1 - 1 / zoom)) * zoom + posY;\r\n      this.m_vertexes.push({ xZ, yZ });\r\n    }\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* 2d simplest graphics engine\r\n* @module app/scripts/graphics2d/graphics23d\r\n*/\r\n\r\nimport * as THREE from 'three';\r\n\r\n// import MaterialTex2d from '../gfx/mattex2d';\r\n// import MaterialColor2d from '../gfx/matcolor2d';\r\n// import MeshText2D from './meshtext2d';\r\n// import Line2D from './line2d';\r\n// import Circle2D from './circle2d';\r\nimport DistanceTool from './distancetool';\r\n// import AngleTool from './angletool';\r\n// import AreaTool from './areatool';\r\n// import ZoomTool from './zoomtool';\r\n// import RectTool from './recttool';\r\n// import MoveTool from './movetool';\r\n// import DeleteTool from './deletetool';\r\n// import EditTool from './edittool';\r\n// import TextTool from './texttool';\r\n\r\n/**  @constant {number} SCENE_3D_BACKGROUND_COLOR - backgroudn color for 3d window */\r\n// const SCENE_2D_BACKGROUND_COLOR = 0xbbbbff; // 0x00\r\n\r\n/** Possible 2d tools */\r\nconst tools2d = {\r\n  INTENSITY: 'intensity',\r\n  DISTANCE: 'distance',\r\n  ANGLE: 'angle',\r\n  AREA: 'area',\r\n  RECT: 'rect',\r\n  TEXT: 'text',\r\n  GRAD: 'grad',\r\n  COBR: 'cobr',\r\n  BIFI: 'bifi',\r\n  ZOOM: 'zoom',\r\n  DELETE: 'delete',\r\n  EDIT: 'edit',\r\n};\r\n\r\n/** Class Graphics2d is used for simple debug style 2d render */\r\nexport default class Graphics23d {\r\n\r\n  /**\r\n  * Initialize render\r\n  * @param (object) container - object container for 3d rendering\r\n  * @param (int) width - 2d canvas width\r\n  * @param (int) height - 2d canvas height\r\n  * @return {Object} Intsance of this class (singleton)\r\n  */\r\n  constructor(scene, width, height) {\r\n    this.m_width = width;\r\n    this.m_height = height;\r\n    this.m_material = null;\r\n    this.m_mesh = null;\r\n    console.log(`Graphics2d create size = ${width} * ${height}`);\r\n    this.m_scene = scene;\r\n\r\n    this.m_materialsTex2d = null;\r\n    this.m_material = null;\r\n\r\n    //construct edit and move tools\r\n    this.m_zoom = 1;\r\n    this.m_savePosX = 0;\r\n    this.m_savePosY = 0;\r\n    this.m_posX = 0;\r\n    this.m_posY = 0;\r\n    this.m_move = false;\r\n    this.m_wProjScreen = width;\r\n    this.m_hProjScreen = height;\r\n\r\n    this.m_showTileTexture = false;\r\n\r\n    // prepare for render 2d lines on screen\r\n    const xw = 1.0 / width;\r\n    const yw = 1.0 / height;\r\n    const TWICE = 2.0;\r\n    this.m_lineWidth = TWICE * ((xw > yw) ? xw : yw);\r\n    this.m_lineWidth = 0.002;\r\n\r\n    this.m_textTime = -1000;\r\n    this.m_text = null;\r\n    this.m_toolType = tools2d.DISTANCE;\r\n    //this.m_toolType = tools2d.INTENSITY;\r\n    this.m_distanceTool = new DistanceTool(this.m_scene, this.m_lineWidth);\r\n    /*this.m_angleTool = new AngleTool(this.m_scene, this.m_lineWidth);\r\n    this.m_areaTool = new AreaTool(this.m_scene, this.m_lineWidth);\r\n    this.m_rectTool = new RectTool(this.m_scene, this.m_lineWidth);\r\n    this.m_textTool = new TextTool(this.m_scene);\r\n    this.m_zoomTool = new ZoomTool(this.m_zoom);\r\n    this.m_moveTool = new MoveTool(this.m_zoom, this.m_posX, this.m_posY);\r\n    this.m_deleteTool = new DeleteTool(this.m_scene, this.m_lineWidth);\r\n    this.m_editTool = new EditTool(this.m_scene, this.m_lineWidth);\r\n    */\r\n    //this.m_distanceTool.test();\r\n  } // end of constructor\r\n\r\n  set2dToolType(toolType) {\r\n    this.m_toolType = toolType;\r\n  }\r\n\r\n  /**\r\n   * Callback on file loaded\r\n   */\r\n  onFileLoaded() {\r\n    this.m_distanceTool.clearLines();\r\n    this.m_angleTool.clearLines();\r\n    this.m_areaTool.clearLines();\r\n    this.m_rectTool.clearLines();\r\n    this.m_textTool.clear();\r\n    this.m_deleteTool.clearLines();\r\n    this.m_editTool.clearLines();\r\n  }\r\n\r\n  clear2DTools() {\r\n    this.m_distanceTool.clearLines();\r\n    this.m_angleTool.clearLines();\r\n    this.m_areaTool.clearLines();\r\n    this.m_rectTool.clearLines();\r\n    this.m_textTool.clear();\r\n    this.m_deleteTool.clearLines();\r\n    this.m_editTool.clearLines();\r\n  }\r\n\r\n  default2DTools() {\r\n    this.m_zoom = 1;\r\n    this.m_posX = 0;\r\n    this.m_posY = 0;\r\n    this.m_savePosX = 0;\r\n    this.m_savePosY = 0;\r\n    this.m_materialsTex2d.m_uniforms.posX.value = this.m_posX;\r\n    this.m_materialsTex2d.m_uniforms.posY.value = this.m_posY;\r\n    this.m_materialsTex2d.m_uniforms.zoom.value = this.m_zoom;\r\n    this.updateLines();\r\n  }\r\n\r\n  fov2Tan(fov) {\r\n    const HALF = 0.5;\r\n    return Math.tan(THREE.Math.degToRad(HALF * fov));\r\n  }\r\n\r\n  tan2Fov(tan) {\r\n    const TWICE = 2.0;\r\n    return THREE.Math.radToDeg(Math.atan(tan)) * TWICE;\r\n  }\r\n\r\n  /**\r\n  * Keyboard event handler\r\n  * @param (number) keyCode - keyboard code\r\n  * @param (Boolean) debug - true if debug false otherwise\r\n  */\r\n  onKeyDown(keyCode, debug) {\r\n    // console.log(`onKeyDown: ${keyCode}`);\r\n    // const KEY_CODE_G = 71;\r\n    if (debug) {\r\n      // if (keyCode === KEY_CODE_G) {\r\n      //   this.debugShowSliceFrom2dTiles();\r\n      // }\r\n    }\r\n  }\r\n\r\n  /**\r\n  * Mouse events handler\r\n  * xScr, yScr in [0..1] is normalized mouse coordinate in screen\r\n  */\r\n  onMouseDown(xScr, yScr) {\r\n    if ((this.m_volumeData === null) || (this.m_volumeHeader === null)) {\r\n      return;\r\n    }\r\n    if ((xScr > this.m_wProjScreen) || (yScr > this.m_hProjScreen)) {\r\n      // out of image\r\n      return;\r\n    }\r\n    if (this.m_levelSetMode) {\r\n      return;\r\n    }\r\n\r\n    const TWICE = 2.0;\r\n    const xt = xScr * TWICE - 1.0;\r\n    const yt = yScr * TWICE - 1.0;\r\n    //const yt = (1.0 - yScr) * TWICE - 1.0;\r\n\r\n    switch (this.m_toolType) {\r\n    case tools2d.DISTANCE:\r\n      this.m_distanceTool.onMouseDown(xt, yt, this.m_zoom, this.m_posX * (this.m_wProjScreen),\r\n        this.m_posY * (this.m_hProjScreen));\r\n      break;\r\n    case tools2d.ANGLE:\r\n      this.m_angleTool.onMouseDown(xt, yt, this.m_zoom, this.m_posX * (this.m_wProjScreen),\r\n        this.m_posY * (this.m_hProjScreen));\r\n      break;\r\n    case tools2d.TEXT:\r\n      this.m_textTool.onMouseDown(xt, yt, this.m_zoom, this.m_posX * (this.m_wProjScreen),\r\n        this.m_posY * (this.m_hProjScreen));\r\n      break;\r\n    case tools2d.AREA:\r\n      this.m_areaTool.onMouseDown(xt, yt, this.m_zoom, this.m_posX * (this.m_wProjScreen),\r\n        this.m_posY * (this.m_hProjScreen));\r\n      break;\r\n    case tools2d.RECT:\r\n      this.m_rectTool.onMouseDown(xt, yt, this.m_zoom, this.m_posX * (this.m_wProjScreen),\r\n        this.m_posY * (this.m_hProjScreen));\r\n      break;\r\n    case tools2d.GRAD:\r\n      break;\r\n    case tools2d.COBR:\r\n    /*this.m_contrastBrightTool.onMouseDown(xt, yt);\r\n          this.m_materialsTex2d.m_uniforms.contrast.value = this.m_contrastBrightTool.m_contrast;\r\n          this.m_materialsTex2d.m_uniforms.brightness.value = this.m_contrastBrightTool.m_brightness;\r\n          this.m_materialsTex2d.m_uniforms.COBRflag.value = this.m_contrastBrightTool.m_COBRflag;*/\r\n      break;\r\n    case tools2d.BIFI:\r\n      /*this.m_filterTool.onMouseDown(xt, yt);\r\n          this.m_materialsTex2d.m_uniforms.sigma.value = this.m_filterTool.m_sigma;\r\n          this.m_materialsTex2d.m_uniforms.sigmaB.value = this.m_filterTool.m_sigmaB;\r\n          this.m_materialsTex2d.m_uniforms.BIFIflag.value = this.m_filterTool.m_BIFIflag;*/\r\n      break;\r\n    case tools2d.ZOOM:\r\n      this.m_move = true;\r\n      this.m_moveTool.onMouseDown(xt, yt);\r\n      break;\r\n    case tools2d.DELETE:\r\n      this.m_deleteTool.onMouseDown(xt, yt, this.m_distanceTool.m_distances, this.m_angleTool.m_angles,\r\n        this.m_rectTool.m_areas, this.m_areaTool.m_distances, this.m_textTool.m_textArr,\r\n        this.m_distanceTool.m_vertexes, this.m_angleTool.m_vertexes, this.m_rectTool.m_vertexes,\r\n        this.m_areaTool.m_vertexes2, this.m_areaTool.m_last_lengths, this.m_areaTool.m_vertexes, this.m_areaTool,\r\n        this.m_textTool.m_vertexes);\r\n      console.log(`${this.m_areaTool.last_length}`);\r\n      break;\r\n    case tools2d.EDIT:\r\n      this.m_editTool.onMouseDown();\r\n      break;\r\n    default:\r\n      console.log('Unexpected 2d tool');\r\n      break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Mouse events handler\r\n   * xScr, yScr in [0..1] is normalized mouse coordinate in screen\r\n   */\r\n  onMouseUp(xScr, yScr) {\r\n    if ((this.m_volumeData === null) || (this.m_volumeHeader === null)) {\r\n      return;\r\n    }\r\n    if ((xScr > this.m_wProjScreen) || (yScr > this.m_hProjScreen)) {\r\n      // out of image\r\n      return;\r\n    }\r\n    const TWICE = 2.0;\r\n    const xt = xScr * TWICE - 1.0;\r\n    const yt = yScr * TWICE - 1.0;\r\n    //const yt = (1.0 - yScr) * TWICE - 1.0;\r\n\r\n    if (this.m_levelSetMode) {\r\n      // only for first step of level set\r\n      if (this.m_levelSetCircle !== null) {\r\n        this.clearLevelSetCenter();\r\n      }\r\n      this.drawLevelSetCenter(xt, yt);\r\n      return;\r\n    }\r\n    switch (this.m_toolType) {\r\n    case tools2d.DISTANCE:\r\n      break;\r\n    case tools2d.ANGLE:\r\n      break;\r\n    case tools2d.AREA:\r\n      break;\r\n    case tools2d.RECT:\r\n      break;\r\n    case tools2d.TEXT:\r\n      break;\r\n    case tools2d.COBR:\r\n      break;\r\n    case tools2d.BIFI:\r\n      break;\r\n    case tools2d.ZOOM:\r\n      this.m_move = false;\r\n      this.m_moveTool.onMouseUp();\r\n      this.m_savePosX = this.m_posX;\r\n      this.m_savePosY = this.m_posY;\r\n      break;\r\n    case tools2d.DELETE:\r\n      break;\r\n    case tools2d.EDIT:\r\n      this.m_editTool.onMouseUp();\r\n      break;\r\n    default:\r\n      console.log('Unexpected 2d tool');\r\n      break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Mouse move event handler\r\n   * @param (float) xScr - normalized mouse x coordinate in screen\r\n   * @param (float) yScr - normalized mouse y coordinate in screen\r\n   */\r\n  onMouseMove(xScr, yScr) {\r\n    if ((this.m_volumeData === null) || (this.m_volumeHeader === null)) {\r\n      return;\r\n    }\r\n    if ((xScr > this.m_wProjScreen) || (yScr > this.m_hProjScreen)) {\r\n      // out of image\r\n      return;\r\n    }\r\n    const TWICE = 2.0;\r\n    const xt = xScr * TWICE - 1.0;\r\n    const yt = yScr * TWICE - 1.0;\r\n    //const yt = (1.0 - yScr) * TWICE - 1.0;\r\n\r\n    switch (this.m_toolType) {\r\n    case tools2d.DISTANCE:\r\n      this.m_distanceTool.onMouseMove(xt, yt, this.m_zoom);\r\n      break;\r\n    case tools2d.ANGLE:\r\n      this.m_angleTool.onMouseMove(xt, yt);\r\n      break;\r\n    case tools2d.AREA:\r\n      this.m_areaTool.onMouseMove(xt, yt);\r\n      break;\r\n    case tools2d.RECT:\r\n      this.m_rectTool.onMouseMove(xt, yt, this.m_zoom);\r\n      break;\r\n    case tools2d.TEXT:\r\n      break;\r\n    case tools2d.GRAD:\r\n      break;\r\n    case tools2d.COBR:\r\n      /*this.m_contrastBrightTool.onMouseMove(xt, yt);\r\n        this.m_materialsTex2d.m_uniforms.contrast.value = this.m_contrastBrightTool.m_contrast;\r\n        this.m_materialsTex2d.m_uniforms.brightness.value = this.m_contrastBrightTool.m_brightness;\r\n        this.m_materialsTex2d.m_uniforms.COBRflag.value = this.m_contrastBrightTool.m_COBRflag;*/\r\n      break;\r\n    case tools2d.BIFI:\r\n      /*this.m_filterTool.onMouseMove(xt, yt);\r\n        this.m_materialsTex2d.m_uniforms.sigma.value = this.m_filterTool.m_sigma;\r\n        this.m_materialsTex2d.m_uniforms.sigmaB.value = this.m_filterTool.m_sigmaB;\r\n        this.m_materialsTex2d.m_uniforms.BIFIflag.value = this.m_filterTool.m_BIFIflag;*/\r\n      break;\r\n    case tools2d.ZOOM:\r\n      if (this.m_move) {\r\n        this.updateMove(xt, yt);\r\n      }\r\n      break;\r\n    case tools2d.DELETE:\r\n      this.m_deleteTool.onMouseMove(xt, yt, this.m_zoom, this.m_distanceTool.m_distances, this.m_angleTool.m_angles,\r\n        this.m_rectTool.m_areas, this.m_areaTool.m_distances, this.m_textTool.m_textArr);\r\n      break;\r\n    case tools2d.EDIT: // TO DO: add text tool\r\n      this.m_editTool.onMouseMove(xt, yt, this.m_zoom, this.m_distanceTool.m_distances, this.m_angleTool.m_angles,\r\n        this.m_rectTool.m_areas, this.m_areaTool.m_distances, this.m_areaTool, this.m_textTool,\r\n        this.m_posX * (this.m_wProjScreen), this.m_posY * (this.m_hProjScreen));\r\n      //this.m_areaTool.updateVertexes(this.m_zoom, this.m_posX * (this.m_wProjScreen), this.m_posY *\r\n      // (this.m_hProjScreen));\r\n      this.m_distanceTool.updateVertexes(this.m_zoom, this.m_posX * (this.m_wProjScreen),\r\n        this.m_posY * (this.m_hProjScreen));\r\n      this.m_angleTool.updateVertexes(this.m_zoom, this.m_posX * (this.m_wProjScreen),\r\n        this.m_posY * (this.m_hProjScreen));\r\n      break;\r\n    default:\r\n      console.log('Unexpected 2d tool');\r\n      break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Mouse events handler\r\n   * xScr, yScr in [0..1] is normalized mouse coordinate in screen\r\n   */\r\n  onMouseWheel(wheelDeltaY) {\r\n    switch (this.m_toolType) {\r\n    case tools2d.DISTANCE:\r\n      break;\r\n    case tools2d.ANGLE:\r\n      break;\r\n    case tools2d.AREA:\r\n      break;\r\n    case tools2d.RECT:\r\n      break;\r\n    case tools2d.TEXT:\r\n      break;\r\n    case tools2d.COBR:\r\n      break;\r\n    case tools2d.BIFI:\r\n      break;\r\n    case tools2d.ZOOM:\r\n      this.m_zoomTool.onMouseWheel(wheelDeltaY);\r\n      this.updateZoom();\r\n      this.createMarkLinesAndText();\r\n      break;\r\n    case tools2d.DELETE:\r\n      break;\r\n    case tools2d.EDIT:\r\n      break;\r\n    default:\r\n      console.log('Unexpected 2d tool');\r\n      break;\r\n    }\r\n  }\r\n\r\n  updateLines() {\r\n    this.m_distanceTool.updateLines(this.m_zoom, this.m_posX * this.m_wProjScreen, this.m_posY * this.m_hProjScreen);\r\n    this.m_angleTool.updateLines(this.m_zoom, this.m_posX * this.m_wProjScreen, this.m_posY * this.m_hProjScreen);\r\n    this.m_rectTool.updateLines(this.m_zoom, this.m_posX * this.m_wProjScreen, this.m_posY * this.m_hProjScreen);\r\n    this.m_textTool.updateAll(this.m_zoom, this.m_posX * this.m_wProjScreen, this.m_posY * this.m_hProjScreen);\r\n    this.m_areaTool.updateLines(this.m_zoom, this.m_posX * this.m_wProjScreen, this.m_posY * this.m_hProjScreen);\r\n    this.m_deleteTool.updateLines(this.m_zoom, this.m_posX * this.m_wProjScreen, this.m_posY * this.m_hProjScreen);\r\n    this.m_editTool.updateLines(this.m_zoom, this.m_posX * this.m_wProjScreen, this.m_posY * this.m_hProjScreen);\r\n  }\r\n\r\n  updateMove(xt, yt) {\r\n    const TWICE = 2;\r\n    const delta = (TWICE - TWICE * this.m_zoom);\r\n    const coord = this.m_moveTool.onMouseMove(xt, yt);\r\n    if (((this.m_savePosX + coord.x) <= Math.abs(delta)) && ((this.m_savePosX + coord.x) > 0)) {\r\n      this.m_posX = this.m_savePosX + coord.x;\r\n      this.m_materialsTex2d.m_uniforms.posX.value = this.m_posX;\r\n    } else if (this.m_savePosX + coord.x > Math.abs(delta)) {\r\n      this.m_posX = Math.abs(delta);\r\n      this.m_materialsTex2d.m_uniforms.posX.value = this.m_posX;\r\n    } else {\r\n      this.m_posX = 0;\r\n      this.m_materialsTex2d.m_uniforms.posX.value = this.m_posX;\r\n    }\r\n\r\n    if (((this.m_savePosY + coord.y) >= (-1) * Math.abs(delta)) && ((this.m_savePosY + coord.y) < 0)) {\r\n      this.m_posY = this.m_savePosY + coord.y;\r\n      this.m_materialsTex2d.m_uniforms.posY.value = this.m_posY;\r\n    } else if (this.m_savePosY + coord.y < (-1) * Math.abs(delta)) {\r\n      this.m_posY = (-1) * Math.abs(delta);\r\n      this.m_materialsTex2d.m_uniforms.posY.value = this.m_posY;\r\n    } else {\r\n      this.m_posY = 0;\r\n      this.m_materialsTex2d.m_uniforms.posY.value = this.m_posY;\r\n    }\r\n    this.updateLines();\r\n  }\r\n\r\n  updateZoom() {\r\n    const TWICE = 2;\r\n    this.m_materialsTex2d.m_uniforms.zoom.value = this.m_zoomTool.m_zoom;\r\n    this.m_zoom = this.m_zoomTool.m_zoom;\r\n    const delta = (TWICE - TWICE * this.m_zoom);\r\n    if (this.m_posX > delta) {\r\n      this.m_posX = delta;\r\n      this.m_materialsTex2d.m_uniforms.posX.value = this.m_posX;\r\n    }\r\n    if ((this.m_posY < (-1) * delta) && (this.m_posY < 0)) {\r\n      this.m_posY = (-1) * delta;\r\n      this.m_materialsTex2d.m_uniforms.posY.value = this.m_posY;\r\n    }\r\n    this.updateLines();\r\n  }\r\n\r\n  updateText() {\r\n    //this.m_pickTool.update();\r\n  }\r\n\r\n  static shortenString(str) {\r\n    const MAX_ITEM_LEN = 20;\r\n    const SHORT_ITEM_PART = 5;\r\n    let strRet = str;\r\n    const pnl = str.length;\r\n    if (pnl > MAX_ITEM_LEN) {\r\n      const strBegin = str.substring(0, SHORT_ITEM_PART + 1);\r\n      const strEnd = str.substring(pnl - SHORT_ITEM_PART, pnl);\r\n      strRet = `${strBegin}...${strEnd}`;\r\n    }\r\n    return strRet;\r\n  }\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n * 3D volume/isosurface rendering engine\r\n * @module app/scripts/engine/VolumeRenderer3d\r\n */\r\n\r\nimport * as THREE from 'three';\r\n// import swal from 'sweetalert';\r\n\r\nimport GlSelector from './GlSelector';\r\nimport OrbitControl from './orbitcontrol';\r\nimport MaterialBF from './gfx/matbackface';\r\nimport MaterialFF from './gfx/matfrontface';\r\nimport MaterialWC from './gfx/matwireframecull';\r\nimport MaterialScreenTexMap from './gfx/matscreentexmapping';\r\nimport MaterialClipPlane from './gfx/matclipplane';\r\nimport MaterialRenderToTexture from './gfx/matrendertotexture';\r\nimport MaterialInterpolation from './gfx/matinterpolation';\r\nimport MaterialVolumeRender from './gfx/matvolumerender';\r\nimport VolumeFilter3D from './volumeFilter3d';\r\nimport RoiPalette from './loaders/roipalette';\r\nimport TetrahedronGenerator from './actvolume/tetra';\r\nimport Graphics23d from './tools23d/graphics23d';\r\n// import MaterialColor2d from './gfx/matcolor2d';\r\n\r\n\r\n// import GlCheck from './glcheck';\r\n// import GeoRender from '../actvolume/georender';\r\n\r\n/**  @constant {number} SCENE_3D_BACKGROUND_COLOR - backgroudn color for 3d window */\r\nconst SCENE_3D_BACKGROUND_COLOR = 0x0;\r\nconst VOLUME_COLOR1_MIN_R = 0.1;\r\nconst VOLUME_COLOR1_MIN_G = 0.0;\r\nconst VOLUME_COLOR1_MIN_B = 0.0;\r\nconst VOLUME_COLOR3_MIN_R = 0.0;\r\nconst VOLUME_COLOR3_MIN_G = 0.8;\r\nconst VOLUME_COLOR3_MIN_B = 0.0;\r\nconst VOLUME_COLOR1_MAX_R = 1.0;\r\nconst VOLUME_COLOR1_MAX_G = 0.0;\r\nconst VOLUME_COLOR1_MAX_B = 0.0;\r\nconst VOLUME_COLOR2_MIN_R = 1.0;\r\nconst VOLUME_COLOR2_MIN_G = 0.902;\r\nconst VOLUME_COLOR2_MIN_B = 0.773;\r\nconst VOLUME_COLOR2_MAX_R = 0.5;\r\nconst VOLUME_COLOR2_MAX_G = 0.4;\r\nconst VOLUME_COLOR2_MAX_B = 0.3;\r\nconst STEP_SIZE1 = 0.0025;\r\nconst STEP_SIZE2 = 0.0033;\r\nconst STEP_SIZE3 = 0.0025;\r\n//const STEP_SIZE3 = 0.0039;\r\nconst STEP_SIZE4 = 0.0029;\r\nconst OPACITY_SCALE = 175.0;\r\n//const MIN_FPS = 10;\r\n\r\n// Special values to check frame buffer\r\nconst CHECK_MODE_NOT_CHECKED = 0;\r\nconst CHECK_MODE_RESULT_OK = 1;\r\n// const CHECK_MODE_RESULT_BAD = 2;\r\n\r\n// When scene is ready (how much materials are created via arrow functions)\r\nconst SCENE_READY_COUNTER_OK = 5;\r\n\r\n// Scene render type\r\nconst SCENE_TYPE_RAYCAST = 0;\r\nconst SCENE_TYPE_SPHERE = 1;\r\n\r\n/** Class Graphics3d is used for 3d render */\r\nexport default class VolumeRenderer3d {\r\n\r\n  /**\r\n   * Initialize render\r\n   * @param (object) props - object container for various properties\r\n   * @param (object) curFileDataType - file type\r\n   * @return {Object} Instance of this class (singleton)\r\n   */\r\n  constructor(props) {\r\n    this.curFileDataType = props.curFileDataType;\r\n    this.sceneReadyCounter = 0;\r\n    this.renderCounter = 0;\r\n    this.scene = new THREE.Scene();\r\n    this.sceneClipPlane = new THREE.Scene();\r\n\r\n    // tetra scene seems to be unused!\r\n    // this.sceneTetra = new THREE.Scene();\r\n\r\n    this.scene23D = new THREE.Scene();\r\n    this.graphics23d = null;\r\n    this.sceneSphere = new THREE.Scene();\r\n    this.meshSphere = null;\r\n    this.newScene = new THREE.Scene();\r\n    this.renderScene = SCENE_TYPE_RAYCAST;\r\n\r\n    this.planeGeometry = null;\r\n    this.props = props;\r\n    this.mesh = null;\r\n    this.renderer = null;\r\n    this.texTF = null;\r\n    this.volTexture = null;\r\n    this.origVolumeTex = null;\r\n    this.texRoiId = null;\r\n    this.texRoiColor = null;\r\n    this.RoiVolumeTex = null;\r\n    this.volTextureMask = null;\r\n    this.texVolumeAO = null;\r\n    this.bfTexture = null;\r\n    this.ffTexture = null;\r\n    this.renderToTexture = null;\r\n    this.geometry = null;\r\n    this.geometrySphere = null;\r\n    this.geometryWireFrameSphere = null;\r\n    this.matBF = null;\r\n    this.matFF = null;\r\n    this.matScreenTex = null;\r\n    this.matWireFrame = null;\r\n    this.matRenderToTexture = null;\r\n    //this.matInterpolation = null;\r\n    this.matVolumeRender = null;\r\n    this.volumeUpdater = null;\r\n    this.checkFrameBufferMode = CHECK_MODE_NOT_CHECKED;\r\n    this.eraserStarted = false;\r\n    this.lockEraserBuffersUpdating = false;\r\n\r\n    // eslint-disable-next-line\r\n    this.planeCenterPt = new THREE.Vector3(-0.5, -0.5, 0.5 * 1.4);\r\n    // this.renderer = new THREE.WebGLRenderer({ antialias: false, logarithmicDepthBuffer: false });\r\n    // this.renderer = new THREE.WebGLRenderer({ antialias: false }\r\n    // this.canvas3d = document.createElementNS('http://www.w3.org/1999/xhtml', 'canvas');\r\n    const glSelector = new GlSelector();\r\n    this.context = glSelector.createWebGLContext();\r\n    this.isWebGL2 = glSelector.useWebGL2();\r\n    this.canvas3d = glSelector.getCanvas();\r\n    this.renderer = new THREE.WebGLRenderer({\r\n      antialias: false, canvas: this.canvas3d,\r\n      preserveDrawingBuffer: true, context: this.context\r\n    });\r\n    this.renderer.autoClearStencil = false;\r\n    this.renderer.autoClearColor = false;\r\n    if (!this.renderer) {\r\n      console.log('cant create 3d renderer');\r\n    }\r\n\r\n    // Assign current window to render area\r\n    this.windowWidth = Math.floor(props.width);\r\n    // eslint-disable-next-line\r\n    this.windowHeight = Math.floor(props.height);\r\n    // console.log(\"Window: \" + this.windowWidth + \"x\" + this.windowHeight);\r\n    console.log(`Window: ${this.windowWidth} x ${this.windowHeight}`);\r\n    const camAspect = this.windowWidth / this.windowHeight;\r\n    // eslint-disable-next-line\r\n    this.camera = new THREE.PerspectiveCamera(60, camAspect, 0.01, 3);\r\n    this.camera.position.z = 10;\r\n    this.renderer.setSize(this.windowWidth, this.windowHeight);\r\n\r\n    this.renderer.setClearColor(SCENE_3D_BACKGROUND_COLOR);\r\n\r\n    /*if (root3dContainer.length === 1) {\r\n      root3dContainer.append(this.renderer.domElement);\r\n    } else {\r\n      console.log('containter with id=med3web-container-3d not found in scene');\r\n    }*/\r\n    props.mount.appendChild(this.renderer.domElement);\r\n    // When rotating an object, it is necessary to reverse the rotation of\r\n    // the cutting plane and the direction vector onto the light source\r\n    // this.orbitControl = new OrbitControl(root3dContainer, this.camera, this.scene, this.meshSphere, () => {\r\n    this.orbitControl = new OrbitControl(this.renderer.domElement, this.camera, this.scene, this.mesh, () => {\r\n      if (true) {\r\n      //  if (this.checkFrameBufferMode === CHECK_MODE_RESULT_OK) {\r\n        this.updateCutPlanes();\r\n        this.updateLightDir();\r\n        //this.updateMeshSphere();\r\n      }\r\n    });\r\n    //this.orbitControl.addCallbacks();\r\n\r\n    // tetra geometry seems to be unused!\r\n    // this.createTetraGeometry();\r\n\r\n    this.renderer.gammaInput = true;\r\n    this.renderer.gammaOutput = true;\r\n\r\n    this.RENDER_STATE = {\r\n      ENABLED : 0,\r\n      ONCE : 1,\r\n      DISABLED : 2\r\n    };\r\n\r\n    this.renderState = this.RENDER_STATE.ENABLED;\r\n    this.fps = 0;\r\n    this.isoThreshold = 0.0;\r\n    /*root3dContainer.on('mousedown', (event) => {\r\n      const domElem = root3dContainer.get(0);\r\n      const box = domElem.getBoundingClientRect();\r\n      const containerX = event.clientX - box.left;\r\n      const containerY = event.clientY - box.top;\r\n      this.onMouseDown(containerX, this.windowHeight - containerY, event.ctrlKey);\r\n    });\r\n    root3dContainer.on('mouseup', () => { this.onMouseUp(); });\r\n    root3dContainer.on('mousemove', (event) => {\r\n      const domElem = root3dContainer.get(0);\r\n      const box = domElem.getBoundingClientRect();\r\n      const containerX = event.clientX - box.left;\r\n      const containerY = event.clientY - box.top;\r\n      this.onMouseMove(containerX, this.windowHeight - containerY, event.ctrlKey);\r\n    });\r\n    root3dContainer.on('DOMMouseScroll', (e) => { this.onMouseWheel(e); });\r\n    root3dContainer.on('mousewheel', (e) => { this.onMouseWheel(e); });*/\r\n    this.isEraseMode = false;\r\n    this.eraserRadius = 10;\r\n    this.eraserDepth = 20;\r\n    this.eraserSrart = false;\r\n    this.lockEraserBuffersUpdating = false;\r\n    this.eraserMouseDown = false;\r\n    this.m_eraser = null;\r\n\r\n    this.isSculptingMode = false;\r\n    this.sculptingCapturedVertex = null;\r\n    this.sculptingSphereCenter = new THREE.Vector3(0.0, 0.0, 0.0);\r\n    this.sculptingSphereSize = 1.0;\r\n    this.vBoxVirt = {\r\n      x: 1.0,\r\n      y: 1.0,\r\n      z: 1.0,\r\n    };\r\n\r\n  }\r\n\r\n  setFileDataType(curFileDataType) {\r\n    this.curFileDataType = curFileDataType;\r\n  }\r\n\r\n  /**\r\n  * Special scene with sphere: remove old before adding new one\r\n  */\r\n  removeSphereFromSphereScene() {\r\n    if (this.meshSphere !== null) {\r\n      this.sceneSphere.remove(this.meshSphere);\r\n    }\r\n    this.meshSphere = null;\r\n    this.geometrySphere = null;\r\n  }\r\n\r\n  /**\r\n  * Special scene with sphere: add new generated Three js geometry (sphere)\r\n  */\r\n  addSphereToSphereScene() {\r\n    const gen = new TetrahedronGenerator();\r\n    const vRadius = new THREE.Vector3(0.5, 0.5, 0.5);\r\n    const NUM_SUBDIVIDES = 2;\r\n    const okCreateTetra = gen.create(vRadius, NUM_SUBDIVIDES);\r\n    if (okCreateTetra < 1) {\r\n      return okCreateTetra;\r\n    }\r\n    const numVertices = gen.getNumVertices();\r\n    const numTriangles = gen.getNumTriangles();\r\n    const INDICES_IN_TRI = 3;\r\n\r\n    // console.log(`TetrahedronGenerator. numVertices = ${numVertices}, numTriangles = ${numTriangles}`);\r\n\r\n    const NUM_0 = 0;\r\n    const NUM_1 = 1;\r\n    const NUM_2 = 2;\r\n    const NUM_3 = 3;\r\n    const positions = [];\r\n    const indices = [];\r\n    const normals = [];\r\n    // copy vertices from generator\r\n    for (let i = 0; i < numVertices; i++) {\r\n      const vert = gen.getVertex(i);\r\n      const vNew = new THREE.Vector3(vert.x, vert.y, vert.z);\r\n      positions.push(vert.x, vert.y, vert.z);\r\n      vNew.normalize();\r\n      normals.push(vNew.x, vNew.y, vNew.z);\r\n    } // for (i) all vertices\r\n    // copy triangles from generator\r\n    for (let i = 0, j = 0; i < numTriangles; i++, j += INDICES_IN_TRI) {\r\n      const triIndices = gen.getTriangle(i);\r\n      //const faceNew = new THREE.Face3(triIndices[NUM_0], triIndices[NUM_1], triIndices[NUM_2]);\r\n      indices.push(triIndices[NUM_0], triIndices[NUM_1], triIndices[NUM_2]);\r\n    } // for (i) all triangles\r\n    // old style: buffered geometry\r\n    this.geometrySphere = new THREE.BufferGeometry();\r\n    const posAttribute = new Float32Array(positions);\r\n    const normalsAttribute = new Float32Array(normals);\r\n    const indAttribute = new Uint8Array(indices);\r\n\r\n    this.geometrySphere.addAttribute('position', new THREE.BufferAttribute(posAttribute, NUM_3));\r\n    this.geometrySphere.addAttribute('normal', new THREE.BufferAttribute(normalsAttribute, NUM_3));\r\n    this.geometrySphere.setIndex(new THREE.BufferAttribute(indAttribute, 1));\r\n    this.computeGeometrySphereUVs();\r\n    this.meshSphere = new THREE.Mesh(this.geometrySphere);\r\n    this.sceneSphere.add(this.meshSphere);\r\n    return this.meshSphere;\r\n  }\r\n\r\n  /**\r\n  * Special scene with sphere: copy rotated (by mouse) orientation from\r\n  * main mesh to sphere mesh\r\n  */\r\n  updateMeshSphere() {\r\n  /*\r\n    if (this.meshSphere !== null) {\r\n      const pos = this.mesh.position;\r\n      const quat = this.mesh.quaternion;\r\n      this.meshSphere.position.copy(pos);\r\n      this.meshSphere.quaternion.copy(quat);\r\n      this.meshSphere.updateMatrix();\r\n    }\r\n  */\r\n  }\r\n\r\n  /**\r\n   * Returns true if the maderial for VolumeRender is set\r\n   */\r\n  isVolumeLoaded() {\r\n    return (this.matVolumeRender !== null);\r\n  }\r\n\r\n  fov2Tan(fov) {\r\n    const HALF = 0.5;\r\n    return Math.tan(THREE.Math.degToRad(HALF * fov));\r\n  }\r\n\r\n  tan2Fov(tan) {\r\n    const TWICE = 2.0;\r\n    return THREE.Math.radToDeg(Math.atan(tan)) * TWICE;\r\n  }\r\n\r\n  /**\r\n   * Get screen copy image from current render\r\n   *\r\n   * @param {number} width Desired image width\r\n   * @param {number} height Desired image height\r\n   * @return {Object} Image with 3d renderer output (as URI string)\r\n   */\r\n  screenshot(width, height) {\r\n    if (this.renderer === null) {\r\n      return null;\r\n    }\r\n    let screenshotImage = null;\r\n    if (typeof width === 'undefined') {\r\n      screenshotImage = this.renderer.domElement.toDataURL('image/png');\r\n    } else {\r\n      // width and height are specified\r\n      const originalAspect = this.camera.aspect;\r\n      const originalFov = this.camera.fov;\r\n      const originalTanFov2 = this.fov2Tan(this.camera.fov);\r\n\r\n      // screen shot should contain the principal area of interest (a centered square touching screen sides)\r\n      const areaOfInterestSize = Math.min(this.windowWidth, this.windowHeight);\r\n      const areaOfInterestTanFov2 = originalTanFov2 * areaOfInterestSize / this.windowHeight;\r\n\r\n      // set appropriate camera aspect & FOV\r\n      const shotAspect = width / height;\r\n      this.camera.aspect = shotAspect;\r\n      this.camera.fov = this.tan2Fov(areaOfInterestTanFov2 / Math.min(shotAspect, 1.0));\r\n      this.camera.updateProjectionMatrix();\r\n\r\n      // resize canvas to the required size of screen shot\r\n      this.renderer.setSize(width, height);\r\n\r\n      // make screen shot\r\n      this.render();\r\n      screenshotImage = this.renderer.domElement.toDataURL('image/png');\r\n\r\n      // restore original camera & canvas proportions\r\n      this.camera.aspect = originalAspect;\r\n      this.camera.fov = originalFov;\r\n      this.camera.updateProjectionMatrix();\r\n      this.renderer.setSize(this.windowWidth, this.windowHeight);\r\n      this.render();\r\n    }\r\n    return screenshotImage;\r\n  }\r\n\r\n  /**\r\n   * Setting a MaskFlag\r\n   */\r\n  setMaskFlag(MaskFlag) {\r\n    this.matVolumeRender.defines.MaskFlag = MaskFlag;\r\n    this.matVolumeRender.needsUpdate = true;\r\n    this.matRenderToTexture.defines.MaskFlag = MaskFlag;\r\n    this.matRenderToTexture.needsUpdate = true;\r\n  }\r\n\r\n  /**\r\n   * Setting a variable for conditional compilation (Volume Render)\r\n   */\r\n  switchToTool23D(isTool23D) {\r\n    this.Tool23D = isTool23D;\r\n    if (this.Tool23D) {\r\n      this.graphics23d = new Graphics23d(this.scene23D, this.windowWidth, this.windowHeight);\r\n    }\r\n    else {\r\n      this.graphics23d = null;\r\n    }\r\n  }\r\n\r\n  switchToVolumeRender() {\r\n    if (this.matVolumeRender !== null && this.matRenderToTexture !== null) {\r\n      if (this.isRoiVolume > 0) {\r\n        this.matVolumeRender.defines.isoRenderFlag = 4;\r\n        this.matVolumeRender.needsUpdate = true;\r\n        //this.matInterpolation.defines.isoRenderFlag = 4;\r\n        //this.matInterpolation.needsUpdate = true;\r\n        this.matRenderToTexture.defines.isoRenderFlag = 4;\r\n        this.matRenderToTexture.needsUpdate = true;\r\n        this.renderState = this.RENDER_STATE.ONCE;\r\n      } else {\r\n        this.matVolumeRender.defines.isoRenderFlag = 0;\r\n        this.matVolumeRender.needsUpdate = true;\r\n        //this.matInterpolation.defines.isoRenderFlag = 0;\r\n        //this.matInterpolation.needsUpdate = true;\r\n        this.matRenderToTexture.defines.isoRenderFlag = 0;\r\n        this.matRenderToTexture.needsUpdate = true;\r\n        this.renderState = this.RENDER_STATE.ONCE;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setting a variable for conditional compilation (Full Volume Render)\r\n   */\r\n  switchToFullVolumeRender() {\r\n    if (this.matVolumeRender !== null && this.matRenderToTexture !== null) {\r\n      if (this.isRoiVolume > 0) {\r\n        this.matVolumeRender.defines.isoRenderFlag = 4;\r\n        this.matVolumeRender.needsUpdate = true;\r\n        //this.matInterpolation.defines.isoRenderFlag = 4;\r\n        //this.matInterpolation.needsUpdate = true;\r\n        this.matRenderToTexture.defines.isoRenderFlag = 4;\r\n        this.matRenderToTexture.needsUpdate = true;\r\n        this.renderState = this.RENDER_STATE.ONCE;\r\n      } else {\r\n        this.matVolumeRender.defines.isoRenderFlag = 3;\r\n        this.matVolumeRender.needsUpdate = true;\r\n        //this.matInterpolation.defines.isoRenderFlag = 3;\r\n        //this.matInterpolation.needsUpdate = true;\r\n        this.matRenderToTexture.defines.isoRenderFlag = 3;\r\n        this.matRenderToTexture.needsUpdate = true;\r\n        this.renderState = this.RENDER_STATE.ONCE;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setting a variable for conditional compilation (Isosurface render)\r\n   */\r\n  switchToIsosurfRender() {\r\n    if (this.matVolumeRender !== null && this.matRenderToTexture !== null) {\r\n      if (this.isRoiVolume > 0) {\r\n        this.matVolumeRender.defines.isoRenderFlag = 5;\r\n        this.matVolumeRender.needsUpdate = true;\r\n        //this.matInterpolation.defines.isoRenderFlag = 5;\r\n        //this.matInterpolation.needsUpdate = true;\r\n        this.matRenderToTexture.defines.isoRenderFlag = 5;\r\n        this.matRenderToTexture.needsUpdate = true;\r\n        this.renderState = this.RENDER_STATE.ONCE;\r\n        this.volumeUpdater.switchToRoiMapRender();\r\n      } else {\r\n        this.matVolumeRender.defines.isoRenderFlag = 1;\r\n        this.matVolumeRender.needsUpdate = true;\r\n        //this.matInterpolation.defines.isoRenderFlag = 1;\r\n        //this.matInterpolation.needsUpdate = true;\r\n        this.matRenderToTexture.defines.isoRenderFlag = 1;\r\n        this.matRenderToTexture.needsUpdate = true;\r\n        this.renderState = this.RENDER_STATE.ONCE;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setting a variable for conditional compilation (Max projection render)\r\n   */\r\n  switchToFLATRender() {\r\n    if (this.matVolumeRender !== null && this.matRenderToTexture !== null) {\r\n      this.matVolumeRender.defines.isoRenderFlag = 2;\r\n      this.matVolumeRender.needsUpdate = true;\r\n      //this.matInterpolation.defines.isoRenderFlag = 2;\r\n      //this.matInterpolation.needsUpdate = true;\r\n      this.matRenderToTexture.defines.isoRenderFlag = 2;\r\n      this.matRenderToTexture.needsUpdate = true;\r\n      this.renderState = this.RENDER_STATE.ONCE;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setting isosurface threshold\r\n   */\r\n  setIsoThresholdValue(sliderValue) {\r\n    if (this.matVolumeRender !== null && this.matRenderToTexture !== null) {\r\n      this.matRenderToTexture.uniforms.isoThreshold.value = sliderValue;\r\n      this.matRenderToTexture.uniforms.isoThreshold.needsUpdate = true;\r\n      this.matVolumeRender.uniforms.isoThreshold.value = sliderValue;\r\n      this.matVolumeRender.uniforms.isoThreshold.needsUpdate = true;\r\n      this.isoThreshold = sliderValue;\r\n      this.renderState = this.RENDER_STATE.ONCE;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setting volume opacity\r\n   * @param (number) sliderValue - slider ration in 0..1\r\n   */\r\n  setOpacityBarrier(sliderValue) {\r\n    if (this.matVolumeRender !== null && this.matRenderToTexture !== null) {\r\n      this.matVolumeRender.uniforms.opacityBarrier.value = OPACITY_SCALE * sliderValue;\r\n      this.matVolumeRender.uniforms.opacityBarrier.needsUpdate = true;\r\n      this.matRenderToTexture.uniforms.opacityBarrier.value = OPACITY_SCALE * sliderValue;\r\n      this.matRenderToTexture.uniforms.opacityBarrier.needsUpdate = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setting Brightness\r\n   * @param (number) value - brightness of ???\r\n   */\r\n  updateBrightness(value) {\r\n    if (this.matRenderToTexture !== null) {\r\n      this.matRenderToTexture.uniforms.brightness3D.value = value;\r\n      this.matRenderToTexture.uniforms.brightness3D.needsUpdate = true;\r\n    }\r\n    if (this.matVolumeRender !== null) {\r\n      this.matVolumeRender.uniforms.brightness3D.value = value;\r\n      this.matVolumeRender.uniforms.brightness3D.needsUpdate = true;\r\n      // this.volumeUpdater.updateVolumeTexture(0.1 + 1.5*value);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Setting Contrast\r\n   * @param (number) value - constrast of ???\r\n   */\r\n  updateContrast(value) {\r\n    if (this.matVolumeRender !== null && this.matRenderToTexture !== null) {\r\n      this.matRenderToTexture.uniforms.contrast3D.value = value;\r\n      this.matVolumeRender.uniforms.contrast3D.value = value;\r\n      this.matRenderToTexture.uniforms.contrast3D.needsUpdate = true;\r\n      this.matVolumeRender.uniforms.contrast3D.needsUpdate = true;\r\n    }\r\n  }\r\n\r\n  setAmbientTextureMode(isoThreshold) {\r\n    if (this.texVolumeAO) {\r\n      this.texVolumeAO.dispose();\r\n    }\r\n    this.volumeUpdater.ambientTexture.set(this.volTexture, isoThreshold);\r\n    this.texVolumeAO = this.volumeUpdater.ambientTexture.get();\r\n    this.matRenderToTexture.defines.useAmbientTex = 1;\r\n    this.matVolumeRender.defines.useAmbientTex = 1;\r\n    this.matRenderToTexture.needsUpdate = true;\r\n    this.matVolumeRender.needsUpdate = true;\r\n    this.matRenderToTexture.uniforms.texVolumeAO.value = this.texVolumeAO;\r\n    this.matRenderToTexture.uniforms.texVolumeAO.needsUpdate = true;\r\n    this.matVolumeRender.uniforms.texVolumeAO.value = this.texVolumeAO;\r\n    this.matVolumeRender.uniforms.texVolumeAO.needsUpdate = true;\r\n  }\r\n\r\n  offAmbientTextureMode() {\r\n    if (this.texVolumeAO) {\r\n      this.texVolumeAO.dispose();\r\n    }\r\n    this.matRenderToTexture.defines.useAmbientTex = 0;\r\n    this.matVolumeRender.defines.useAmbientTex = 0;\r\n    this.matRenderToTexture.needsUpdate = true;\r\n    this.matVolumeRender.needsUpdate = true;\r\n  }\r\n\r\n  /**\r\n   * Setting Cut Plane\r\n   * @param (number) value - ???\r\n   */\r\n  updateZCutPlane(value) {\r\n    const Z_MULTIPLIER = 1.4;\r\n    this.planeCenterPt.z = Z_MULTIPLIER * value;\r\n    this.updateCutPlanes();\r\n  }\r\n\r\n  /**\r\n   * Setting Transfer Function Params\r\n   * @param (array) values - 3 threshold values for volumetric render\r\n   */\r\n  setTransferFuncVec3(values, colorFlag) {\r\n    if (this.matRenderToTexture !== null) {\r\n      if (colorFlag === 0) {\r\n        this.matRenderToTexture.uniforms.t_function1min.value =\r\n          new THREE.Vector4(VOLUME_COLOR1_MIN_R, VOLUME_COLOR1_MIN_G, VOLUME_COLOR1_MIN_B, values[0]);\r\n      } else {\r\n        this.matRenderToTexture.uniforms.t_function1min.value =\r\n          new THREE.Vector4(VOLUME_COLOR3_MIN_R, VOLUME_COLOR3_MIN_G, VOLUME_COLOR3_MIN_B, values[0]);\r\n      }\r\n      this.matRenderToTexture.uniforms.t_function1min.needsUpdate = true;\r\n      this.matRenderToTexture.uniforms.t_function1max.value =\r\n        new THREE.Vector4(VOLUME_COLOR1_MAX_R, VOLUME_COLOR1_MAX_G, VOLUME_COLOR1_MAX_B, values[1]);\r\n      this.matRenderToTexture.uniforms.t_function1max.needsUpdate = true;\r\n      this.matRenderToTexture.uniforms.t_function2min.value =\r\n        new THREE.Vector4(VOLUME_COLOR2_MIN_R, VOLUME_COLOR2_MIN_G, VOLUME_COLOR2_MIN_B, values[2]);\r\n      this.matRenderToTexture.uniforms.t_function2min.needsUpdate = true;\r\n      this.matRenderToTexture.uniforms.t_function2max.value =\r\n        new THREE.Vector4(VOLUME_COLOR2_MAX_R, VOLUME_COLOR2_MAX_G, VOLUME_COLOR2_MAX_B, values[2]);\r\n      this.matRenderToTexture.uniforms.t_function2max.needsUpdate = true;\r\n      this.matRenderToTexture.uniforms.stepSize.value =\r\n        new THREE.Vector4(STEP_SIZE1, STEP_SIZE2, STEP_SIZE3, STEP_SIZE4);\r\n      this.matRenderToTexture.uniforms.stepSize.needsUpdate = true;\r\n      if (colorFlag === 0) {\r\n        this.matVolumeRender.uniforms.t_function1min.value =\r\n          new THREE.Vector4(VOLUME_COLOR1_MIN_R, VOLUME_COLOR1_MIN_G, VOLUME_COLOR1_MIN_B, values[0]);\r\n      } else {\r\n        this.matVolumeRender.uniforms.t_function1min.value =\r\n          new THREE.Vector4(VOLUME_COLOR3_MIN_R, VOLUME_COLOR3_MIN_G, VOLUME_COLOR3_MIN_B, values[0]);\r\n      }\r\n      this.matVolumeRender.uniforms.t_function1min.needsUpdate = true;\r\n      this.matVolumeRender.uniforms.t_function1max.value =\r\n        new THREE.Vector4(VOLUME_COLOR1_MAX_R, VOLUME_COLOR1_MAX_G, VOLUME_COLOR1_MAX_B, values[1]);\r\n      this.matVolumeRender.uniforms.t_function1max.needsUpdate = true;\r\n      this.matVolumeRender.uniforms.t_function2min.value =\r\n        new THREE.Vector4(VOLUME_COLOR2_MIN_R, VOLUME_COLOR2_MIN_G, VOLUME_COLOR2_MIN_B, values[2]);\r\n      this.matVolumeRender.uniforms.t_function2min.needsUpdate = true;\r\n      this.matVolumeRender.uniforms.t_function2max.value =\r\n        new THREE.Vector4(VOLUME_COLOR2_MAX_R, VOLUME_COLOR2_MAX_G, VOLUME_COLOR2_MAX_B, values[2]);\r\n      this.matVolumeRender.uniforms.t_function2max.needsUpdate = true;\r\n      this.matVolumeRender.uniforms.stepSize.value =\r\n        new THREE.Vector4(STEP_SIZE1, STEP_SIZE2, STEP_SIZE3, STEP_SIZE4);\r\n      this.matVolumeRender.uniforms.stepSize.needsUpdate = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Compute 3D texture coordinates on BBOX\r\n   * @param (object) nonEmptyBoxMin - Min corner for non empty box in volume\r\n   * @param (object) nonEmptyBoxMax - Max corner for non empty box in volume\r\n   */\r\n  computeGeometryUVs(nonEmptyBoxMin, nonEmptyBoxMax) {\r\n    this.geometry.computeBoundingBox();\r\n    const VAL_3 = 3;\r\n    const HALF = 0.5;\r\n\r\n    const max = this.geometry.boundingBox.max;\r\n    const min = this.geometry.boundingBox.min;\r\n    const offset = new THREE.Vector3(0 - min.x, 0 - min.y, 0 - min.z);\r\n    const range = new THREE.Vector3(max.x - min.x, max.y - min.y, max.z - min.z);\r\n    this.geo_offset1 = new THREE.Vector3(0, 0, 0);\r\n    this.geo_offset1 = offset;\r\n    this.geo_offset2 = new THREE.Vector3(0, 0, 0);\r\n    this.geo_offset2.x = nonEmptyBoxMin.x + HALF;\r\n    this.geo_offset2.y = nonEmptyBoxMin.y - HALF;\r\n    this.geo_offset2.z = nonEmptyBoxMin.z - HALF;\r\n    this.geo_scale = new THREE.Vector3(0, 0, 0);\r\n    this.geo_scale.x = (nonEmptyBoxMax.x - nonEmptyBoxMin.x) / range.x;\r\n    this.geo_scale.y = (nonEmptyBoxMax.y - nonEmptyBoxMin.y) / range.y;\r\n    this.geo_scale.z = (nonEmptyBoxMax.z - nonEmptyBoxMin.z) / range.z;\r\n\r\n    const NEED_GEO_UVW = true;\r\n    if (NEED_GEO_UVW) {\r\n      const uvw = new Float32Array(this.geometry.getAttribute('position').count * VAL_3);\r\n      for (let i = 0; i < this.geometry.getAttribute('position').count; i++) {\r\n        const vx = this.geometry.getAttribute('position').getX(i);\r\n        const vy = this.geometry.getAttribute('position').getY(i);\r\n        const vz = this.geometry.getAttribute('position').getZ(i);\r\n        // eslint-disable-next-line\r\n        uvw[i * VAL_3 + 0] = -vx;\r\n        // eslint-disable-next-line\r\n        uvw[i * VAL_3 + 1] = vy;\r\n        // eslint-disable-next-line\r\n        uvw[i * VAL_3 + 2] = vz;\r\n      }\r\n      this.geometry.addAttribute('uvw', new THREE.BufferAttribute(uvw, VAL_3));\r\n      this.geometry.getAttribute('uvw').needsUpdate = true;\r\n    }\r\n  }\r\n\r\n  computeGeometrySphereUVs() {\r\n    const VAL_3 = 3;\r\n    // Need calculate uvw coords for sphere geo\r\n    const NEED_SPHERE_UVW = true;\r\n    if (NEED_SPHERE_UVW) {\r\n      // console.log(`vBoxVirt = ${this.vBoxVirt.x}, ${this.vBoxVirt.y}, ${this.vBoxVirt.z}`);\r\n      const uvw = new Float32Array(this.geometrySphere.getAttribute('position').count * VAL_3);\r\n      for (let i = 0; i < this.geometrySphere.getAttribute('position').count; i++) {\r\n        const vx = this.geometrySphere.getAttribute('position').getX(i);\r\n        const vy = this.geometrySphere.getAttribute('position').getY(i);\r\n        const vz = this.geometrySphere.getAttribute('position').getZ(i);\r\n        // eslint-disable-next-line\r\n        uvw[i * VAL_3 + 0] = -vx / this.vBoxVirt.x;// / this.vBoxVirt.x; //-(vx + this.geo_offset1.x) * this.geo_scale.x  + this.geo_offset2.x;\r\n        // eslint-disable-next-line\r\n        uvw[i * VAL_3 + 1] = +vy / this.vBoxVirt.y;// / this.vBoxVirt.y; //(vy + this.geo_offset1.y) * this.geo_scale.y  + this.geo_offset2.y;\r\n        // eslint-disable-next-line\r\n        uvw[i * VAL_3 + 2] = +vz / this.vBoxVirt.z;// / this.vBoxVirt.z; //(vz + this.geo_offset1.z) * this.geo_scale.z  + this.geo_offset2.z;\r\n      }\r\n      this.geometrySphere.addAttribute('uvw', new THREE.BufferAttribute(uvw, VAL_3));\r\n      this.geometrySphere.getAttribute('uvw').needsUpdate = true;\r\n    }\r\n\r\n    const NEED_FACE_VERTEX_UVW = false;\r\n    if (NEED_FACE_VERTEX_UVW) {\r\n      this.geometrySphere.faceVertexUvs = [];\r\n      const numVertices = this.geometrySphere.vertices.count;\r\n      const OFF_0 = 0, OFF_1 = 1, OFF_2 = 2;\r\n      const uvw = new Float32Array(numVertices * VAL_3);\r\n      let j = 0;\r\n      for (let i = 0; i < numVertices; i++, j += VAL_3) {\r\n        const vx = this.geometrySphere.vertices[i].x;\r\n        const vy = this.geometrySphere.vertices[i].y;\r\n        const vz = this.geometrySphere.vertices[i].z;\r\n        // this.geometrySphere.faceVertexUvs.push(new THREE.Vector2(vx, vy));\r\n        uvw[j + OFF_0] = -vx;\r\n        uvw[j + OFF_1] = vy;\r\n        uvw[j + OFF_2] = vz;\r\n      } // for (i)\r\n      // this.geometrySphere.addAttribute('uvw', new THREE.BufferAttribute(uvw, VAL_3));\r\n      this.geometrySphere.uvw = uvw;\r\n    } // if need face uv\r\n  }\r\n\r\n  createClipPlaneGeometry() {\r\n    const matClipPlane = new MaterialClipPlane();\r\n    matClipPlane.create(this.bfTexture, (mat) => {\r\n      // eslint-disable-next-line\r\n      this.planeGeometry = new THREE.PlaneBufferGeometry(2, 2);\r\n      const plane = new THREE.Mesh(this.planeGeometry, mat);\r\n      this.sceneClipPlane.add(plane);\r\n    });\r\n  }\r\n\r\n  updateClipPlaneGeometry() {\r\n    const VAL_3 = 3;\r\n    const uvw = new Float32Array(this.planeGeometry.getAttribute('position').count * VAL_3);\r\n    const l2w = new THREE.Matrix4();\r\n    l2w.getInverse(this.mesh.matrix);\r\n    const invPerspective = new THREE.Matrix4();\r\n    invPerspective.getInverse(this.camera.projectionMatrix);\r\n    const invView = new THREE.Matrix4();\r\n    invView.copy(this.camera.matrixWorld);\r\n    for (let i = 0; i < this.planeGeometry.getAttribute('position').count; i++) {\r\n      const v = new THREE.Vector3();\r\n      const SOME_SMALL_ADD = 0.001;\r\n      v.x = this.planeGeometry.getAttribute('position').getX(i);\r\n      v.y = this.planeGeometry.getAttribute('position').getY(i);\r\n      v.z = this.planeGeometry.getAttribute('position').getZ(i) + SOME_SMALL_ADD;\r\n      v.applyMatrix4(invPerspective);\r\n      v.applyMatrix4(invView);\r\n      v.applyMatrix4(l2w);\r\n      //v.applyMatrix4(this.getScreen2WorldTransform());\r\n      //uvw[i * VAL_3 + 1] = (v.y + this.geo_offset1.y) * this.geo_scale.y + this.geo_offset2.y;\r\n      //uvw[i * VAL_3 + 0] = -(v.x + this.geo_offset1.x) * this.geo_scale.x + this.geo_offset2.x;\r\n      //// eslint-disable-next-line\r\n      //uvw[i * VAL_3 + 1] = (v.y + this.geo_offset1.y) * this.geo_scale.y + this.geo_offset2.y;\r\n      //// eslint-disable-next-line\r\n      //uvw[i * VAL_3 + 2] = (v.z + this.geo_offset1.z) * this.geo_scale.z + this.geo_offset2.z;\r\n\r\n      // eslint-disable-next-line\r\n      uvw[i * VAL_3 + 0] = -v.x;\r\n      // eslint-disable-next-line\r\n      uvw[i * VAL_3 + 1] = v.y;\r\n      // eslint-disable-next-line\r\n      uvw[i * VAL_3 + 2] = v.z;\r\n\r\n    }\r\n    this.planeGeometry.addAttribute('uvw', new THREE.BufferAttribute(uvw, VAL_3));\r\n    this.planeGeometry.getAttribute('uvw').needsUpdate = true;\r\n  }\r\n\r\n  getScreen2WorldTransform() {\r\n    const l2w = new THREE.Matrix4();\r\n    l2w.getInverse(this.mesh.matrix);\r\n    const s2w = new THREE.Matrix4();\r\n    s2w.getInverse(this.camera.projectionMatrix);\r\n    const invView = new THREE.Matrix4();\r\n    invView.copy(this.camera.matrixWorld);\r\n    s2w.multiply(invView);\r\n    s2w.multiply(l2w);\r\n    return s2w;\r\n  }\r\n\r\n  /**\r\n   * Create geometry and materials for 3D rendering\r\n   * @param (object) box - physic volume box dimensions\r\n   * @param (object) nonEmptyBoxMin - Min corner for non empty box in volume\r\n   * @param (object) nonEmptyBoxMin - Min corner for non empty box in volume\r\n   * @param (bool) isRoiVolume) - is roi volume\r\n   */\r\n  initWithVolume(volume, box, nonEmptyBoxMin, nonEmptyBoxMax, isRoiVolume, isFULL3D) {\r\n    let sideMax = (box.x > box.y) ? box.x : box.y;\r\n    sideMax = (box.z > sideMax) ? box.z : sideMax;\r\n    this.vBoxVirt.x = box.x / sideMax;\r\n    this.vBoxVirt.y = box.y / sideMax;\r\n    this.vBoxVirt.z = box.z / sideMax;\r\n    this.isoThreshold = this.curFileDataType.thresholdIsosurf;    \r\n    this.volume = volume;\r\n    this.nonEmptyBoxMin = nonEmptyBoxMin;\r\n    this.nonEmptyBoxMax = nonEmptyBoxMax;\r\n    // remove old sphere\r\n    this.matWireFrame = null;\r\n    this.removeSphereFromSphereScene();\r\n\r\n    // create new sphere\r\n    const matWCloader = new MaterialWC();\r\n    this.matWireFrame = matWCloader.create(this.bfTexture, this.ffTexture);\r\n    // const matColor = new MaterialColor2d();\r\n    // this.matColor23d = matColor.create();\r\n\r\n    /*\r\n    console.log(`this.bfTexture`);\r\n    if (this.bfTexture === null) {\r\n      console.log(`this.bfTexture === null`);\r\n      return 1;\r\n    }\r\n    */\r\n    this.addSphereToSphereScene();\r\n\r\n    this.renderScene = SCENE_TYPE_RAYCAST;\r\n    this.sceneReadyCounter = 0;\r\n    this.renderCounter = 0;\r\n    let matBfThreeGS = null;\r\n    let matFfThreeGS = null;\r\n    let matIntetpl = null;\r\n    let matScreenTex = null;\r\n    if (this.sceneClipPlane) {\r\n      this.sceneClipPlane = new THREE.Scene();\r\n    }\r\n    if (!this.scene) {\r\n      return;\r\n    }\r\n    // remove old mesh\r\n    if (this.mesh !== null) {\r\n      this.scene.remove(this.mesh);\r\n    }\r\n\r\n    if (this.geometry !== null) {\r\n      this.geometry.dispose();\r\n    }\r\n    this.mesh = null;\r\n    // Create geometry\r\n    this.geometry = new THREE.BufferGeometry();\r\n    //this.geometry.fromGeometry(new THREE.BoxGeometry(this.vBoxVirt.x, this.vBoxVirt.y, this.vBoxVirt.z));\r\n    this.geometry.fromGeometry(new THREE.BoxGeometry(1.0, 1.0, 1.0));\r\n    // Compute texture coordinates\r\n\r\n    // compute UVW\r\n    this.computeGeometryUVs(nonEmptyBoxMin, nonEmptyBoxMax);\r\n    this.geometry.scale(this.vBoxVirt.x, this.vBoxVirt.y, this.vBoxVirt.z);\r\n\r\n    // Set camera\r\n    // eslint-disable-next-line\r\n    this.camera.position.set(0.0, 0.0, 1.5);\r\n    // eslint-disable-next-line\r\n    this.camera.lookAt(new THREE.Vector3(0.0, 0.0, 0.0));\r\n    // Create 3D texture    \r\n    const xDim = this.volume.m_xDim;\r\n    const yDim = this.volume.m_yDim;\r\n    const zDim = this.volume.m_zDim;\r\n    console.log(`3D tex size = ${xDim} ${yDim} ${zDim}`);\r\n    if (this.volTexture) {\r\n      this.volTexture.dispose();\r\n    }\r\n    this.eraserStarted = false;\r\n    this.isRoiVolume = isRoiVolume;\r\n    this.roiPalette = null;\r\n    if (isRoiVolume === true) {\r\n      const palette = new RoiPalette();\r\n      this.roiPalette = palette.getPalette256();\r\n      const BYTES_PER_COLOR = 4;\r\n      const MAGIC_COLOR = 250;\r\n      const OFFS_0 = 0;\r\n      const OFFS_1 = 1;\r\n      const OFFS_2 = 2;\r\n\r\n      const palB = this.roiPalette[MAGIC_COLOR * BYTES_PER_COLOR + OFFS_0];\r\n      const palG = this.roiPalette[MAGIC_COLOR * BYTES_PER_COLOR + OFFS_1];\r\n      const palR = this.roiPalette[MAGIC_COLOR * BYTES_PER_COLOR + OFFS_2];\r\n      console.log(`RoiPalette: pal[250] = ${palR}, ${palG}, ${palB}`);\r\n    }\r\n    this.volumeUpdater = new VolumeFilter3D();\r\n    // this.engine2d.volumeUpdater = this.volumeUpdater;\r\n    /*const props = {\r\n      volume: this.volume,\r\n      isWebGL2: this.isWebGL2\r\n    };*/\r\n    this.volTexture = this.volumeUpdater.createUpdatableVolumeTex(this.volume, isRoiVolume, this.roiPalette);\r\n    this.origVolumeTex = this.volumeUpdater.origVolumeTex;\r\n    this.texTF = this.volumeUpdater.createTransferFuncTexture();\r\n    //this.volTextureMask = this.volumeUpdater.createUpdatableVolumeMask(this.volume);\r\n\r\n    if (this.volTextureMask) {\r\n      this.volTextureMask.dispose();\r\n    }\r\n    if (this.texVolumeAO) {\r\n      this.texVolumeAO.dispose();\r\n    }\r\n    //this.texVolumeAO = this.volumeUpdater.gettexVolumeAO();\r\n\r\n    if (this.renderer.getContext().getExtension('EXT_color_buffer_float')) {\r\n      if (this.bfTexture) {\r\n        this.bfTexture.dispose();\r\n      }\r\n      // Create Render Target for back face render\r\n      //this.bfTexture = new THREE.WebGLRenderTarget(this.windowWidth * window.devicePixelRatio,\r\n      //this.windowHeight * window.devicePixelRatio, {\r\n      this.bfTexture = new THREE.WebGLRenderTarget(this.windowWidth, this.windowHeight, {\r\n        minFilter: THREE.LinearFilter,\r\n        magFilter: THREE.LinearFilter,\r\n        format: THREE.RGBAFormat,\r\n        type: THREE.FloatType,\r\n        depthBuffer: true,\r\n      });\r\n      const VAL_4 = 4;\r\n      this.bufferBFTextureCPU = new Float32Array(VAL_4 * this.windowWidth * this.windowHeight);\r\n\r\n      if (this.ffTexture) {\r\n        this.ffTexture.dispose();\r\n      }\r\n      // Create Render Target for front face render\r\n      //this.ffTexture = new THREE.WebGLRenderTarget(this.windowWidth * window.devicePixelRatio,\r\n      //this.windowHeight * window.devicePixelRatio, {\r\n      this.ffTexture = new THREE.WebGLRenderTarget(this.windowWidth,\r\n        this.windowHeight, {\r\n          minFilter: THREE.LinearFilter,\r\n          magFilter: THREE.LinearFilter,\r\n          format: THREE.RGBAFormat,\r\n          type: THREE.FloatType,\r\n          depthBuffer: true,\r\n        });\r\n      this.bufferFFTextureCPU = new Float32Array(VAL_4 * this.windowWidth * this.windowHeight);\r\n\r\n      if (this.renderfTexture) {\r\n        this.renderToTexture.dispose();\r\n      }\r\n      // Create Render Target for volume render to texture\r\n      const VAL_3 = 3;\r\n      this.xSmallTexSize = Math.floor(this.windowWidth / VAL_3);\r\n      this.ySmallTexSize = Math.floor(this.windowHeight / VAL_3);\r\n      //this.renderToTexture = new THREE.WebGLRenderTarget((this.windowWidth * window.devicePixelRatio) / VAL_3,\r\n      //(this.windowHeight * window.devicePixelRatio) / VAL_3, {\r\n      this.renderToTexture = new THREE.WebGLRenderTarget(this.xSmallTexSize,\r\n        this.ySmallTexSize, {\r\n          minFilter: THREE.NearestFilter,\r\n          magFilter: THREE.NearestFilter,\r\n          format: THREE.RGBAFormat,\r\n          type: THREE.FloatType,\r\n          depthBuffer: true,\r\n        });\r\n      this.bufferRenderToTextureCPU = new Float32Array(VAL_4 * this.xSmallTexSize * this.ySmallTexSize);\r\n    } else {\r\n      console.log('cant create float texture');\r\n    }\r\n\r\n    this.createClipPlaneGeometry();\r\n\r\n    if (this.matWireFrame) {\r\n      this.matWireFrame.uniforms.texBF.value = this.bfTexture;\r\n      this.matWireFrame.uniforms.texBF.needsUpdate = true;\r\n      this.matWireFrame.uniforms.texFF.value = this.ffTexture;\r\n      this.matWireFrame.uniforms.texFF.needsUpdate = true;\r\n    }\r\n\r\n    // create material for screen texture mapping\r\n    // Used to map backface texture to frontface geom\r\n    matScreenTex = new MaterialScreenTexMap();\r\n    this.matScreenTex = matScreenTex.create(this.ffTexture);\r\n    // Create material for back face render\r\n    matBfThreeGS = new MaterialBF();\r\n    matBfThreeGS.create((mat) => {\r\n      this.matBF = mat;\r\n      this.sceneReadyCounter++;\r\n    });\r\n\r\n    // Create material for front face render\r\n    matFfThreeGS = new MaterialFF();\r\n    matFfThreeGS.m_uniforms.PlaneX.value = new THREE.Vector4(-1.0, 0.0, 0.0, 0.5);\r\n    matFfThreeGS.m_uniforms.PlaneY.value = new THREE.Vector4(0.0, -1.0, 0.0, 0.5);\r\n    matFfThreeGS.m_uniforms.PlaneZ.value = new THREE.Vector4(0.0, 0.0, -1.0, 0.5);\r\n    matFfThreeGS.create(this.bfTexture.texture, (mat) => {\r\n      this.matFF = mat;\r\n      this.sceneReadyCounter++;\r\n    });\r\n\r\n    // Create mesh\r\n    this.mesh = new THREE.Mesh(this.geometry);\r\n    //console.log(`startRot = ${this.curFileDataType.startRotX} ${this.curFileDataType.startRotY}`);\r\n    this.orbitControl.setMesh(this.mesh);\r\n    this.orbitControl.setWireMesh(this.meshSphere);\r\n\r\n\r\n    // Create material for volume render to texture\r\n    const offsets = [];\r\n    const nOffs = 64;\r\n    // create offsets for ssao\r\n    for (let i = 0; i < nOffs; ++i) {\r\n      // eslint-disable-next-line\r\n      const x = Math.random() * 2 - 1;\r\n      // eslint-disable-next-line\r\n      const y = Math.random() * 2 - 1;\r\n      // eslint-disable-next-line\r\n//      const z = Math.random() * 2 - 1;\r\n      const z = -Math.random();\r\n      offsets.push(new THREE.Vector3(x, y, z));\r\n    }\r\n    this.matRenderToTextureThreeGS = new MaterialRenderToTexture();\r\n    this.matRenderToTextureThreeGS.m_uniforms.colorMap1D.value = this.colorMapTexture;\r\n    this.matRenderToTextureThreeGS.create(this.texTF, this.volTexture,\r\n      null, this.texVolumeAO, this.bfTexture.texture, this.ffTexture.texture, offsets,\r\n      //this.volTextureMask, this.texVolumeAO, this.bfTexture.texture, this.ffTexture.texture, offsets,\r\n      (mat) => {\r\n        mat.uniforms.t_function1min.value =\r\n          new THREE.Vector4(VOLUME_COLOR1_MIN_R, VOLUME_COLOR1_MIN_G, VOLUME_COLOR1_MIN_B,\r\n            this.curFileDataType.thresholdTissue1);\r\n        mat.uniforms.t_function1max.value =\r\n          new THREE.Vector4(VOLUME_COLOR1_MAX_R, VOLUME_COLOR1_MAX_G, VOLUME_COLOR1_MAX_B,\r\n            this.curFileDataType.thresholdTissue2);\r\n        mat.uniforms.t_function2min.value =\r\n          new THREE.Vector4(VOLUME_COLOR2_MIN_R, VOLUME_COLOR2_MIN_G, VOLUME_COLOR2_MIN_B,\r\n            this.curFileDataType.thresholdIsosurf);\r\n        mat.uniforms.t_function2max.value =\r\n          new THREE.Vector4(VOLUME_COLOR2_MAX_R, VOLUME_COLOR2_MAX_G, VOLUME_COLOR2_MAX_B,\r\n            this.curFileDataType.thresholdIsosurf);\r\n        mat.uniforms.stepSize.value =\r\n          new THREE.Vector4(STEP_SIZE1, STEP_SIZE2, STEP_SIZE3, STEP_SIZE4);\r\n        mat.uniforms.texSize.value = xDim;//this.engine2d.m_volumeHeader.m_pixelWidth;\r\n        mat.uniforms.isoThreshold.value = this.curFileDataType.thresholdIsosurf;\r\n        mat.uniforms.brightness3D.value = this.curFileDataType.brightness;\r\n        mat.uniforms.opacityBarrier.value = OPACITY_SCALE * this.curFileDataType.opacityTissue;\r\n        mat.uniforms.volumeSizeZ.value = zDim;\r\n\r\n        mat.uniforms.xDim.value = xDim;\r\n        mat.uniforms.yDim.value = yDim;\r\n\r\n        mat.uniforms.lightDir.value = new THREE.Vector3(this.curFileDataType.lightDirComp,\r\n          this.curFileDataType.lightDirComp, this.curFileDataType.lightDirComp);\r\n        mat.uniforms.needsUpdate = true;\r\n        this.matRenderToTexture = mat;\r\n        this.sceneReadyCounter++;\r\n      });\r\n\r\n    // Create material for interpolation\r\n    matIntetpl = new MaterialInterpolation();\r\n    const VAL_3 = 3.0;\r\n    matIntetpl.m_uniforms.isoSurfTexel.value = new THREE.Vector2(VAL_3 / this.windowWidth,\r\n      VAL_3 / this.windowHeight);\r\n    matIntetpl.create(this.renderToTexture.texture, (mat) => {\r\n      mat.uniforms.needsUpdate = true;\r\n      //this.matInterpolation = mat;\r\n      this.sceneReadyCounter++;\r\n    });\r\n\r\n    // Create material for main pass of volume render\r\n    this.matSkullThreeGS = new MaterialVolumeRender();\r\n    this.matSkullThreeGS.m_uniforms.isoSurfTexel.value = new THREE.Vector2(VAL_3 / this.windowWidth,\r\n      VAL_3 / this.windowHeight);\r\n    this.matSkullThreeGS.m_uniforms.colorMap1D.value = this.colorMapTexture;\r\n    this.matSkullThreeGS.create(this.texTF, this.volTexture,\r\n      null, this.texVolumeAO, this.bfTexture.texture, this.ffTexture.texture,\r\n      //this.volTextureMask, this.texVolumeAO, this.bfTexture.texture, this.ffTexture.texture,\r\n      this.renderToTexture.texture, offsets, (mat) => {\r\n        mat.uniforms.t_function1min.value =\r\n          new THREE.Vector4(VOLUME_COLOR1_MIN_R, VOLUME_COLOR1_MIN_G, VOLUME_COLOR1_MIN_B,\r\n            this.curFileDataType.thresholdTissue1);\r\n        mat.uniforms.t_function1max.value =\r\n          new THREE.Vector4(VOLUME_COLOR1_MAX_R, VOLUME_COLOR1_MAX_G, VOLUME_COLOR1_MAX_B,\r\n            this.curFileDataType.thresholdTissue2);\r\n        mat.uniforms.t_function2min.value =\r\n          new THREE.Vector4(VOLUME_COLOR2_MIN_R, VOLUME_COLOR2_MIN_G, VOLUME_COLOR2_MIN_B,\r\n            this.curFileDataType.thresholdIsosurf);\r\n        mat.uniforms.t_function2max.value =\r\n          new THREE.Vector4(VOLUME_COLOR2_MAX_R, VOLUME_COLOR2_MAX_G, VOLUME_COLOR2_MAX_B,\r\n            this.curFileDataType.thresholdIsosurf);\r\n        mat.uniforms.stepSize.value =\r\n          new THREE.Vector4(STEP_SIZE1, STEP_SIZE2, STEP_SIZE3, STEP_SIZE4);\r\n        mat.uniforms.texSize.value = xDim;\r\n        mat.uniforms.isoThreshold.value = this.curFileDataType.thresholdIsosurf;\r\n        mat.uniforms.brightness3D.value = this.curFileDataType.brightness;\r\n        mat.uniforms.volumeSizeZ.value = zDim;\r\n\r\n        mat.uniforms.xDim.value = xDim;\r\n        mat.uniforms.yDim.value = yDim;\r\n\r\n        mat.uniforms.opacityBarrier.value = OPACITY_SCALE * this.curFileDataType.opacityTissue;\r\n        mat.uniforms.lightDir.value = new THREE.Vector3(this.curFileDataType.lightDirComp,\r\n          this.curFileDataType.lightDirComp, this.curFileDataType.lightDirComp);\r\n        mat.uniforms.needsUpdate = true;\r\n        this.scene.add(this.mesh);\r\n        this.matVolumeRender = mat;\r\n        if (isFULL3D) {\r\n          this.switchToFullVolumeRender() \r\n        } else {\r\n          this.switchToVolumeRender();      \r\n        }\r\n        this.mesh.material = this.matVolumeRender;\r\n        this.meshSphere.material = this.matVolumeRender;\r\n        this.sceneReadyCounter++;\r\n      });\r\n    //this.tools23d.set2dToolType(toolType);\r\n    //matSkullThreeGS.m_uniforms.texVolumeMask.value = this.volTextureMask;\r\n  } // callbackCreateCubeVolume\r\n\r\n  /**\r\n   * Creates transfer function color map\r\n   * @param ctrlPts Array of control points of type HEX  = color value\r\n   */\r\n  setTransferFuncColors(ctrlPtsColorsHex) {\r\n    this.volumeUpdater.setTransferFuncColors(ctrlPtsColorsHex);\r\n  }\r\n\r\n  /**\r\n   * Creates transfer function color map\r\n   * @param ctrlPts Array of Vector2 where (x,y) = x coordinate in [0, 1], alpha value in [0, 1]\r\n   * //intensity [0,255] opacity [0,1]\r\n   */\r\n  updateTransferFuncTexture(intensities, opacities) {\r\n    return this.volumeUpdater.updateTransferFuncTexture(intensities, opacities);\r\n  }\r\n\r\n  /**\r\n   * Create 2D texture containing selected ROIs\r\n   * @param selectedROIs 256 byte roi values\r\n   */\r\n  updateSelectedRoiMap(selectedROIs) {\r\n    this.volumeUpdater.updateSelectedRoiMap(selectedROIs);\r\n  }  /**\r\n   * Rotate Cut Plane (Rotation is inverse to the object)\r\n   */\r\n\r\n  updateCutPlanes() {\r\n    if (!this.mesh) {\r\n      return;\r\n    }\r\n    const mtx = new THREE.Matrix4();\r\n    if (this.renderScene === SCENE_TYPE_SPHERE) {\r\n      mtx.getInverse(mtx.extractRotation(this.meshSphere.matrix));\r\n    } else {\r\n      mtx.getInverse(mtx.extractRotation(this.mesh.matrix));\r\n    }\r\n    const xAxis = new THREE.Vector3(-1.0, 0.0, 0.0);\r\n    const yAxis = new THREE.Vector3(0.0, -1.0, 0.0);\r\n    const zAxis = new THREE.Vector3(0.0, 0.0, -1.0);\r\n    const centerPt = new THREE.Vector3().copy(this.planeCenterPt);\r\n    centerPt.applyMatrix4(mtx);\r\n    xAxis.applyMatrix4(mtx);\r\n    yAxis.applyMatrix4(mtx);\r\n    zAxis.applyMatrix4(mtx);\r\n    if (this.matFF !== null) {\r\n      this.matFF.uniforms.PlaneX.value.x = xAxis.x;\r\n      this.matFF.uniforms.PlaneX.value.y = xAxis.y;\r\n      this.matFF.uniforms.PlaneX.value.z = xAxis.z;\r\n      this.matFF.uniforms.PlaneX.value.w = -centerPt.dot(xAxis);\r\n\r\n      this.matFF.uniforms.PlaneY.value.x = yAxis.x;\r\n      this.matFF.uniforms.PlaneY.value.y = yAxis.y;\r\n      this.matFF.uniforms.PlaneY.value.z = yAxis.z;\r\n      this.matFF.uniforms.PlaneY.value.w = -centerPt.dot(yAxis);\r\n\r\n      this.matFF.uniforms.PlaneZ.value.x = -zAxis.x;\r\n      this.matFF.uniforms.PlaneZ.value.y = zAxis.y;\r\n      this.matFF.uniforms.PlaneZ.value.z = zAxis.z;\r\n      this.matFF.uniforms.PlaneZ.value.w = -centerPt.dot(zAxis);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Rotate light direction (Rotation is inverse to the object)\r\n   */\r\n  updateLightDir() {\r\n    if (!this.mesh) {\r\n      console.log('UpdateLightDir call mesh is not created');\r\n      return;\r\n    }\r\n\r\n    const mtx = new THREE.Matrix4();\r\n    //mtx.getInverse(mtx.extractRotation(this.mesh.matrix));\r\n    if (this.renderScene === SCENE_TYPE_RAYCAST) {\r\n      mtx.getInverse(mtx.extractRotation(this.mesh.matrix));\r\n    } else {\r\n      mtx.getInverse(mtx.extractRotation(this.meshSphere.matrix));\r\n    }\r\n    const lightDir = new THREE.Vector3(1.0, 1.0, 1.0);\r\n    lightDir.normalize();\r\n    lightDir.applyMatrix4(mtx);\r\n    lightDir.x = -lightDir.x;\r\n    this.matRenderToTexture.uniforms.lightDir.value = lightDir;\r\n    this.matRenderToTexture.uniforms.lightDir.needsUpdate = true;\r\n    this.matVolumeRender.uniforms.lightDir.value = lightDir;\r\n    this.matVolumeRender.uniforms.lightDir.needsUpdate = true;\r\n  }\r\n\r\n  /** Check is scene ready to render */\r\n  isReadyToRender() {\r\n    if (this.sceneReadyCounter !== SCENE_READY_COUNTER_OK) {\r\n      return false;\r\n    }\r\n    const matReady = (this.matVolumeRender !== null) && (this.matBF !== null) &&\r\n      (this.matFF !== null) && (this.matRenderToTexture !== null);\r\n    if (!matReady) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /** Render 3d scene */\r\n  render() {\r\n    /*if (this.sceneReadyCounter !== SCENE_READY_COUNTER_OK) {\r\n      // render empty scene to show \"black\" empty screen\r\n      this.renderer.render(this.scene, this.camera);\r\n      return;\r\n    }*/\r\n    // if (!this.isReadyToRender()) {\r\n    //   console.log(\"Life is but a dream2\");\r\n    //   return;\r\n    // }\r\n    const matReady = (this.matVolumeRender !== null) && (this.matBF !== null) &&\r\n      (this.matFF !== null) && (this.matRenderToTexture !== null);\r\n    if (!matReady) {\r\n      // do nothing\r\n    } else {\r\n      \r\n      \r\n      // check once render target\r\n      if (this.checkFrameBufferMode === CHECK_MODE_NOT_CHECKED) {\r\n        // const isGood = true;// GlCheck.checkFrameBuffer(this.renderer, this.bfTexture);\r\n        this.checkFrameBufferMode = CHECK_MODE_RESULT_OK;\r\n      }\r\n\r\n      if (this.renderScene === SCENE_TYPE_RAYCAST) {\r\n        this.updateLightDir();\r\n        this.updateClipPlaneGeometry();\r\n        this.updateCutPlanes();\r\n        \r\n        this.renderer.setRenderTarget(this.bfTexture);\r\n        this.renderer.clear();\r\n        this.renderer.state.buffers.depth.setClear(0);\r\n        this.scene.overrideMaterial = this.matBF;\r\n        this.renderer.render(this.scene, this.camera, this.bfTexture);\r\n        const glC = this.renderer.getContext();\r\n        if (this.isEraseMode && !this.lockEraserBuffersUpdating) {\r\n          glC.readPixels(0, 0, this.windowWidth, this.windowHeight, glC.RGBA, glC.FLOAT, this.bufferBFTextureCPU);\r\n        }\r\n        this.renderer.setRenderTarget(this.ffTexture);\r\n        this.renderer.clear();\r\n        this.renderer.state.buffers.depth.setClear(1);\r\n        // render clip plane without depth test\r\n        this.renderer.render(this.sceneClipPlane, this.camera, this.ffTexture);\r\n        // enable test again\r\n        this.scene.overrideMaterial = this.matFF;\r\n        this.renderer.render(this.scene, this.camera, this.ffTexture);\r\n        if (this.isEraseMode && !this.lockEraserBuffersUpdating) {\r\n          glC.readPixels(0, 0, this.windowWidth, this.windowHeight, glC.RGBA, glC.FLOAT, this.bufferFFTextureCPU);\r\n        }\r\n\r\n        this.renderer.setRenderTarget();\r\n        this.renderer.clear();\r\n        this.renderer.state.buffers.depth.setClear(0);\r\n\r\n        this.scene.overrideMaterial = this.matRenderToTexture;\r\n        this.renderer.render(this.scene, this.camera, this.renderToTexture);\r\n        if (this.isEraseMode && !this.lockEraserBuffersUpdating) {\r\n          glC.readPixels(0, 0, this.xSmallTexSize, this.ySmallTexSize, glC.RGBA, glC.FLOAT,\r\n            this.bufferRenderToTextureCPU);\r\n        }\r\n        // get a reference to the internal WebGL rendering context\r\n        this.scene.overrideMaterial = null;\r\n        this.renderer.render(this.scene, this.camera);\r\n        // Render wireframe mesh\r\n        this.renderer.autoClearDepth = false;\r\n        \r\n        //this.matWireFrame\r\n        //this.renderer.clear();\r\n        if (this.Tool23D) {\r\n          this.renderer.render(this.scene23D, this.camera);\r\n        }\r\n        //this.renderer.render(this.sceneSphereWireFrame, this.camera);\r\n        this.renderer.autoClearDepth = true;\r\n        //this.renderer.clear();\r\n        /*\r\n        this.renderer.clear();\r\n        this.renderer.render(this.scene23D, this.camera);\r\n        */\r\n      }\r\n      this.renderCounter++;\r\n    }\r\n  }\r\n\r\n  setStepsize(sliderValue) {\r\n    const A = 100.0;\r\n    const B = 700.0;\r\n    const h = 1.0 / (A + B * sliderValue);\r\n    if (this.matRenderToTexture !== null) {\r\n      this.matRenderToTexture.uniforms.stepSize.value = new THREE.Vector4(h, h, h, h);\r\n      this.matRenderToTexture.uniforms.needsUpdate = true;\r\n    }\r\n    if (this.matVolumeRender !== null) {\r\n      this.matVolumeRender.uniforms.stepSize.value = new THREE.Vector4(h, h, h, h);\r\n      this.matVolumeRender.uniforms.needsUpdate = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n  * Get object's vertex (3d) projection on screen, using current object transformation\r\n  *\r\n  * param vPos(THREE.Vector3) - sphere vertex of object\r\n  * param vProjScreen(THREE.Vector2) - screen projection of vertex above\r\n  * return z coordinate of projection on screen. If > 0, then visible\r\n  */\r\n  getVertexProjectionToScreen(vPos, vProjScreen) {\r\n    const vProj = vPos.clone();\r\n    vProj.applyMatrix4(this.meshSphere.matrixWorld);\r\n    vProj.project(this.camera);\r\n    const W_HALF = this.windowWidth * 0.5;\r\n    const H_HALF = this.windowHeight * 0.5;\r\n    const xProj = W_HALF + (W_HALF * vProj.x);\r\n    // it should be H_HALF - (...\r\n    // but we have y axis up in mouse coord system\r\n    const yProj = H_HALF + (H_HALF * vProj.y);\r\n    vProjScreen.x = xProj;\r\n    vProjScreen.y = yProj;\r\n\r\n    const vPrj = vPos.clone();\r\n    vPrj.applyMatrix4(this.meshSphere.matrixWorld);\r\n    vPrj.applyMatrix3(this.camera.normalMatrix);\r\n    // return vProj.z;\r\n    return vPrj.z;\r\n  }\r\n\r\n  setEraserMode(isOn) {\r\n    this.isEraseMode = isOn;\r\n    this.orbitControl.setEraserMode(isOn);\r\n    if (!this.eraserStarted && isOn) {\r\n      this.eraserStarted = true;\r\n      const params = {\r\n        xDim: this.volume.m_xDim,\r\n        yDim: this.volume.m_yDim,\r\n        zDim: this.volume.m_zDim,\r\n        bufBF: this.bufferBFTextureCPU,\r\n        bufFF: this.bufferFFTextureCPU,\r\n        bufTex: this.bufferRenderToTextureCPU,\r\n      };\r\n      this.volTextureMask = this.volumeUpdater.createUpdatableVolumeMask(params);\r\n      this.matSkullThreeGS.m_uniforms.texVolumeMask.value = this.volTextureMask;\r\n      this.matRenderToTextureThreeGS.m_uniforms.texVolumeMask.value = this.volTextureMask;\r\n    }\r\n    if (isOn) {\r\n      this.setMaskFlag(1);\r\n    } else {\r\n      this.setMaskFlag(0);\r\n    }\r\n  }\r\n\r\n  undoEraser() {\r\n    this.volumeUpdater.eraser.undoLastErasing();\r\n  }\r\n\r\n  setEraserStart(isOn) {\r\n    this.eraserStart = isOn;\r\n  }\r\n\r\n  onMouseDown(xx, yy) {\r\n    if (this.Tool23D) {\r\n      this.graphics23d.onMouseDown(xx / this.windowWidth, yy / this.windowHeight);\r\n      return;\r\n    }\r\n    this.orbitControl.onMouseDown(xx, yy);\r\n    //this.tools23d.onMouseDown(xx /this.windowWidth, yy / this.windowHeight);\r\n    if (this.checkFrameBufferMode !== CHECK_MODE_RESULT_OK) {\r\n      return;\r\n    }\r\n    this.renderState = this.RENDER_STATE.ENABLED;\r\n    this.eraserMouseDown = true;\r\n    if (this.isEraseMode && this.eraserStart) {\r\n      this.lockEraserBuffersUpdating = true;\r\n      this.volumeUpdater.eraser.eraseStart(xx, yy, this.windowWidth, this.matVolumeRender.uniforms.isoThreshold.value, true);\r\n    }\r\n  }\r\n\r\n  onMouseMove(xx, yy) {\r\n    //this.tools23d.onMouseMove(xx / this.windowWidth, yy / this.windowHeight);\r\n    if (this.Tool23D) {\r\n      this.graphics23d.onMouseMove(xx / this.windowWidth, yy / this.windowHeight);\r\n      return;\r\n    }\r\n    if (this.checkFrameBufferMode !== CHECK_MODE_RESULT_OK) {\r\n      return;\r\n    }\r\n    this.renderState = this.RENDER_STATE.ENABLED;\r\n    if (!(this.isEraseMode && this.eraserMouseDown && this.eraserStart)) {\r\n      this.orbitControl.onMouseMove(xx, yy);\r\n    }\r\n    else {\r\n      this.volumeUpdater.eraser.eraseStart(xx, yy, this.windowWidth, this.matVolumeRender.uniforms.isoThreshold.value, false);\r\n    }\r\n  }\r\n\r\n  onMouseUp( xx, yy ) {\r\n    if (this.Tool23D) {\r\n      this.graphics23d.onMouseUp(xx / this.windowWidth, yy / this.windowHeight);\r\n      return;\r\n    }\r\n    //this.tools23d.onMouseUp(xx / this.windowWidth, yy / this.windowHeight);\r\n    this.orbitControl.onMouseUp();\r\n    if (this.checkFrameBufferMode !== CHECK_MODE_RESULT_OK) {\r\n      return;\r\n    }\r\n    this.lockEraserBuffersUpdating = false;\r\n    this.eraserMouseDown = false;\r\n    this.renderState = this.RENDER_STATE.ONCE;\r\n  }\r\n\r\n  onMouseWheel(e) {\r\n    //const e = window.event || event; // old IE support\r\n    const delta = Math.max(-1, Math.min(1, (e.deltaY || -e.detail)));\r\n    // console.log(`mouse wheel event . delta = ${delta}`);\r\n    this.orbitControl.onZoom(-delta);\r\n    if (this.checkFrameBufferMode !== CHECK_MODE_RESULT_OK) {\r\n      return;\r\n    }\r\n    this.renderState = this.RENDER_STATE.ONCE;\r\n    // e.preventDefault();\r\n  }\r\n} // class Graphics3d\r\n","/**\r\n * @fileOverview Graphics3d\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport ModeView from '../store/ModeView';\r\nimport Modes3d from '../store/Modes3d';\r\nimport StoreActionType from '../store/ActionTypes';\r\nimport VolumeRenderer3d from './VolumeRenderer3d'\r\n//import DistanceTool from '../tools23d/distancetool'\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class Graphics2d some text later...\r\n */\r\nclass Graphics3d extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.onMode = this.onMode.bind(this);\r\n    this.isLoaded = false;\r\n    this.volume = null;\r\n\r\n    this.start = this.start.bind(this);\r\n    this.stop = this.stop.bind(this);\r\n    this.animate = this.animate.bind(this);\r\n    this.renderScene = this.renderScene.bind(this);\r\n    this.setVolRenderToStore = this.setVolRenderToStore.bind(this);\r\n    this.onKeyDown = this.onKeyDown.bind(this);\r\n    this.onKeyUp = this.onKeyUp.bind(this);\r\n\r\n    this.m_mount = null;\r\n    this.m_volumeRenderer3D = null;\r\n    this.m_distanceTool = null;\r\n    this.m_renderer = null;\r\n    // animation\r\n    this.m_frameId = null;\r\n    this.m_prevMode = Modes3d.RAYCAST;\r\n    // settings\r\n    this.m_fileDataType = {\r\n      thresholdIsosurf: 0.46,\r\n      thresholdTissue1: 0.09,\r\n      thresholdTissue2: 0.30,\r\n      opacityTissue: 0.53,\r\n      startRotX: -Math.PI * 0.5,\r\n      startRotY: Math.PI,\r\n      lightDirComp: -0.5773,\r\n      brightness: 0.56,\r\n    };\r\n    // actual render window dimenison\r\n    this.state = {\r\n      wRender: 0,\r\n      hRender: 0,\r\n    };\r\n  }\r\n\r\n  setVolRenderToStore(VolRender) {\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_VOLUME_Renderer, volumeRenderer: VolRender });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_3DR, slider3d_r: Number.parseFloat(0.09) });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_3DG, slider3d_g: Number.parseFloat(0.3) });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_3DB, slider3d_b: Number.parseFloat(0.46) });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Opacity, sliderOpacity: Number.parseFloat(0.53) });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Isosurface, sliderIsosurface: Number.parseFloat(0.46) });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Brightness, sliderBrightness: Number.parseFloat(0.56) });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Cut, sliderCut: Number.parseFloat(1.0) });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Quality, sliderQuality: Number.parseFloat(0.35) });\r\n  }\r\n\r\n  start() {\r\n    if (this.m_frameId === null) {\r\n      this.m_frameId = requestAnimationFrame(this.animate);\r\n    }\r\n  }\r\n\r\n  stop() {\r\n    cancelAnimationFrame(this.m_frameId);\r\n    this.m_frameId = null;\r\n  }\r\n\r\n  animate() {\r\n    /*this.m_mesh.rotation.x += 0.01;\r\n    this.m_mesh.rotation.y += 0.01;\r\n    this.m_material.color.setRGB(this.m_slider3dr, this.m_slider3dg, this.m_slider3db);\r\n    this.m_material.wireframe = (this.m_mode3d === Modes3d.ISO);*/\r\n \r\n    this.renderScene();\r\n    this.m_frameId = window.requestAnimationFrame(this.animate);\r\n  }\r\n\r\n  renderScene() {\r\n    // this.m_renderer.render(this.m_scene, this.m_camera);\r\n    if (this.m_volumeRenderer3D !== null) {\r\n      this.m_volumeRenderer3D.render();\r\n    }\r\n  }\r\n\r\n  onMode(indexMode) {\r\n    //this.m_updateEnable = true;\r\n    this.props.dispatch({ type: StoreActionType.SET_MODE_3D, mode3d: indexMode });\r\n  }\r\n\r\n  componentDidMount() {\r\n    // detect actual render window dims\r\n    const MIN_DIM = 200;\r\n    const w = (this.m_mount.clientWidth > 0) ? this.m_mount.clientWidth : MIN_DIM;\r\n    const h = (this.m_mount.clientHeight > 0) ? this.m_mount.clientHeight : MIN_DIM;\r\n    if (this.state.wRender === 0) {\r\n      this.setState({ wRender: w });\r\n      this.setState({ hRender: h });\r\n    }\r\n\r\n    /*const w = this.m_mount.clientWidth;\r\n    const h = this.m_mount.clientHeight;\r\n    this.m_scene = new THREE.Scene();\r\n    this.m_camera = new THREE.PerspectiveCamera(75, w / h, 0.1, 1000);\r\n    this.m_camera.position.z = 4;\r\n\r\n    this.m_renderer = new THREE.WebGLRenderer({ antialias: true });\r\n    this.m_renderer.setClearColor('#000000');\r\n    this.m_renderer.setSize(w, h);\r\n    this.m_mount.appendChild(this.m_renderer.domElement);\r\n\r\n    this.m_geometry = new THREE.BoxGeometry(1, 1, 1);\r\n    this.m_material = new THREE.MeshBasicMaterial({ color: '#ff1122' });\r\n    this.m_mesh = new THREE.Mesh(this.m_geometry, this.m_material);\r\n    this.m_scene.add(this.m_mesh);\r\n    const store = this.props;\r\n    this.m_fileDataType.thresholdIsosurf = store.slider3d_b;\r\n    this.m_fileDataType.Tissue1 = store.slider3d_r;\r\n    this.m_fileDataType.Tissue2 = store.slider3d_g;\r\n    */\r\n    if (this.m_volumeRenderer3D === null) {\r\n      this.m_volumeRenderer3D = new VolumeRenderer3d({\r\n        curFileDataType: this.m_fileDataType,\r\n        width: w,\r\n        height: h,\r\n        mount: this.m_mount\r\n      });\r\n    }\r\n    this.setVolRenderToStore(this.m_volumeRenderer3D);\r\n    if (this.volume !== null && this.isLoaded === false && this.m_volumeRenderer3D !== null) { \r\n      const store = this.props;\r\n      const volSet = store.volumeSet;\r\n      const volIndex = store.volumeIndex;\r\n      const vol = volSet.getVolume(volIndex);\r\n      const FOUR = 4;\r\n      const isIso = (vol.m_bytesPerVoxel === FOUR) ? true : false;    \r\n      const modeView = store.modeView; \r\n      //let tst = 0;\r\n      //if (this.volume.m_zDim < 4)\r\n      if (modeView === ModeView.VIEW_3D) {\r\n        this.m_volumeRenderer3D.initWithVolume(this.volume, this.volume.m_boxSize, { x: 0, y: 0, z: 0 }, { x: 1, y: 1, z: 1 }, isIso, true);\r\n      } else {\r\n        this.m_volumeRenderer3D.initWithVolume(this.volume, this.volume.m_boxSize, { x: 0, y: 0, z: 0 }, { x: 1, y: 1, z: 1 }, isIso, false);\r\n      }\r\n      //if (tst) {\r\n      //  return;\r\n      //}\r\n      this.isLoaded = true;\r\n    }\r\n    this.start();\r\n    // setup keyboard\r\n    this.m_mount.focus();\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    this.stop()\r\n    if (this.m_renderer !== null) {\r\n      this.m_mount.removeChild(this.m_renderer.domElement);\r\n    }\r\n    this.m_volumeRenderer3D = null;\r\n  }\r\n\r\n  _onMouseMove(e) {\r\n    // console.log(`${e.x}, ${e.y}\\n`);\r\n    if (this.m_volumeRenderer3D !== null) {\r\n      const box = this.m_mount.getBoundingClientRect();\r\n      const containerX = e.clientX - box.left;\r\n      const containerY = e.clientY - box.top;\r\n      this.m_volumeRenderer3D.onMouseMove(containerX, -(this.state.hRender - containerY), this.props.ereaseStart);\r\n    }\r\n  }\r\n\r\n  _onMouseDown(e) {\r\n    //console.log(`${e.x}, ${e.y}\\n`);\r\n    if (this.m_volumeRenderer3D !== null) {\r\n      const box = this.m_mount.getBoundingClientRect();\r\n      const containerX = e.clientX - box.left;\r\n      const containerY = e.clientY - box.top;\r\n      this.m_volumeRenderer3D.onMouseDown(containerX, -(this.state.hRender - containerY), this.props.ereaseStart);\r\n    }\r\n  }\r\n\r\n  _onMouseUp() { // ommited args: evt\r\n    //console.log(`${e.x}, ${e.y}\\n`);\r\n    if (this.m_volumeRenderer3D !== null) {\r\n      this.m_volumeRenderer3D.onMouseUp();\r\n    }\r\n  }\r\n\r\n  _onWheel(e) {\r\n    //console.log(`${e.x}, ${e.y}\\n`);\r\n    if (this.m_volumeRenderer3D !== null) {\r\n      this.m_volumeRenderer3D.onMouseWheel(e);\r\n    }\r\n  }\r\n\r\n  onClick(evt) {\r\n    evt.stopPropagation();\r\n  }\r\n\r\n  onTouchStart(evt) {\r\n    if ((this.m_mount !== undefined) && (this.m_mount !== null)) {\r\n      // evt.preventDefault();\r\n      const touches = evt.changedTouches;\r\n      const numTouches = touches.length;\r\n      if (numTouches >= 2) {\r\n        console.log(`onTouchStart. numTouches == 2`);\r\n      }\r\n      if (numTouches >= 1) {\r\n        const box = this.m_mount.getBoundingClientRect();\r\n        // const containerX = evt.clientX - box.left;\r\n        // const containerY = evt.clientY - box.top;\r\n        const x = touches[numTouches - 1].pageX - box.left;\r\n        const y = touches[numTouches - 1].pageY - box.top;\r\n        // console.log(`onTouchStart. start at ${x}, ${y}`);\r\n        if (this.m_volumeRenderer3D !== null) {\r\n          this.m_volumeRenderer3D.onMouseDown(x, this.state.hRender - y, this.props.ereaseStart);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  onTouchMove(evt) {\r\n    if ((this.m_mount !== undefined) && (this.m_mount !== null)) {\r\n      // evt.preventDefault();\r\n      const touches = evt.changedTouches;\r\n      const numTouches = touches.length;\r\n      if (numTouches >= 2) {\r\n        console.log(`onTouchStart. numTouches == 2`);\r\n      }\r\n      if (numTouches >= 1) {\r\n        const box = this.m_mount.getBoundingClientRect();\r\n        const x = touches[numTouches - 1].pageX - box.left;\r\n        const y = touches[numTouches - 1].pageY - box.top;\r\n        // console.log(`onTouchMove. move at ${x}, ${y}`);\r\n        if (this.m_volumeRenderer3D !== null) {\r\n          this.m_volumeRenderer3D.onMouseMove(x, this.state.hRender - y, this.props.ereaseStart);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  onTouchEnd() {\r\n    if (this.m_volumeRenderer3D !== null) {\r\n      this.m_volumeRenderer3D.onMouseUp();\r\n    }\r\n  }\r\n\r\n  onKeyDown(evt) {\r\n    const key = evt.key;\r\n    if (key === 'Control') {\r\n      //console.log(`Pressed key = ${key}`);\r\n      console.log('Ctrl key was pressed');\r\n      const store = this.props;\r\n      store.volumeRenderer.setEraserStart(true);\r\n  \r\n    }\r\n  }\r\n\r\n  onKeyUp(evt) {\r\n    const key = evt.key;\r\n    if (key === 'Control') {\r\n      //console.log(`Pressed key = ${key}`);\r\n      console.log('Ctrl key was released');\r\n      const store = this.props;\r\n      store.volumeRenderer.setEraserStart(false);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    const store = this.props;\r\n    let vol = null;\r\n    const volSet = store.volumeSet;\r\n    if (volSet.getNumVolumes() > 0) {\r\n      const volIndex = store.volumeIndex;\r\n      vol = volSet.getVolume(volIndex);\r\n    }\r\n    // const tex3d = this.props.texture3d;\r\n    if (vol !== null) {\r\n      this.volume = vol;\r\n    }\r\n    const ZCUTSHIFT = 0.5;\r\n    const mode3d = store.mode3d;\r\n    const modeView = store.modeView;\r\n    if (this.m_volumeRenderer3D !== null) {\r\n      // console.log(`Graphics3d . mode = ${mode3d}`);\r\n      this.m_volumeRenderer3D.switchToTool23D(store.isTool3D);\r\n      if (modeView !== ModeView.VIEW_3D) {\r\n        if (mode3d === Modes3d.RAYCAST) {\r\n          //if (this.m_prevMode === Modes3d.EREASER) {\r\n          //this.m_volumeRenderer3D.setEraserMode(false);\r\n          //}\r\n          this.m_prevMode = Modes3d.RAYCAST;\r\n          this.m_volumeRenderer3D.setTransferFuncVec3([store.slider3d_r, store.slider3d_g, store.slider3d_b], 0);\r\n          this.m_volumeRenderer3D.switchToVolumeRender();      \r\n        }\r\n        if (mode3d === Modes3d.ISO) {\r\n          //if (this.m_prevMode === Modes3d.EREASER) {\r\n          //  this.m_volumeRenderer3D.setEraserMode(false);\r\n          //}\r\n          this.m_prevMode = Modes3d.ISO;\r\n          this.m_volumeRenderer3D.switchToIsosurfRender();      \r\n          this.m_volumeRenderer3D.setIsoThresholdValue(store.sliderIsosurface);\r\n        }\r\n        if (mode3d === Modes3d.RAYFAST) {\r\n          //if (this.m_prevMode === Modes3d.EREASER) {\r\n          //  this.m_volumeRenderer3D.setEraserMode(false);\r\n          //}\r\n          this.m_prevMode = Modes3d.RAYFAST;\r\n          this.m_volumeRenderer3D.switchToFLATRender();\r\n        }\r\n        if (mode3d === Modes3d.EREASER) {\r\n          //if (this.m_prevMode !== Modes3d.EREASER) {\r\n          //  this.m_volumeRenderer3D.setEraserMode(true);\r\n          //}\r\n          this.m_prevMode = Modes3d.RAYFAST;\r\n          this.m_volumeRenderer3D.switchToIsosurfRender();     \r\n          this.m_volumeRenderer3D.setIsoThresholdValue(store.sliderIsosurface);\r\n          this.m_volumeRenderer3D.volumeUpdater.eraser.setEraserRadius(store.sliderErRadius);\r\n          this.m_volumeRenderer3D.volumeUpdater.eraser.setEraserDepth(store.sliderErDepth);\r\n        }\r\n      } else {\r\n        this.m_volumeRenderer3D.switchToFullVolumeRender() \r\n      }\r\n      this.m_volumeRenderer3D.setOpacityBarrier(store.sliderOpacity);\r\n      this.m_volumeRenderer3D.updateBrightness(store.sliderBrightness);\r\n      this.m_volumeRenderer3D.updateZCutPlane(store.sliderCut - ZCUTSHIFT);\r\n      this.m_volumeRenderer3D.setStepsize(store.sliderQuality);\r\n      this.m_volumeRenderer3D.updateContrast(store.sliderContrast3D);\r\n    }\r\n    if (this.m_volumeRenderer3D !== null) {\r\n      this.m_volumeRenderer3D.render();\r\n    }\r\n\r\n    const styleObj = {\r\n      width: '100%',\r\n      height: '100%',\r\n    };\r\n\r\n    const jsxCanvasNonSized = <div\r\n      style={styleObj}\r\n      ref={ (mount) => {this.m_mount = mount} }\r\n      onMouseMove={this._onMouseMove.bind(this)} \r\n      onMouseDown={this._onMouseDown.bind(this)} \r\n      onMouseUp={this._onMouseUp.bind(this)} \r\n      onTouchStart={this.onTouchStart.bind(this)}\r\n      onTouchEnd={this.onTouchEnd.bind(this)}\r\n      onTouchMove={this.onTouchMove.bind(this)}\r\n      onClick={this.onClick.bind(this)}\r\n      onWheel={this._onWheel.bind(this)} />\r\n    const jsxCanvasSized = <div\r\n      width={this.state.wRender} height={this.state.hRender}\r\n      ref={ (mount) => {this.m_mount = mount} }\r\n      onMouseMove={this._onMouseMove.bind(this)} \r\n      onMouseDown={this._onMouseDown.bind(this)} \r\n      onMouseUp={this._onMouseUp.bind(this)} \r\n      onTouchStart={this.onTouchStart.bind(this)}\r\n      onTouchEnd={this.onTouchEnd.bind(this)}\r\n      onTouchMove={this.onTouchMove.bind(this)}\r\n      onClick={this.onClick.bind(this)}\r\n      tabIndex=\"1\"\r\n      onKeyDown={(evt) => this.onKeyDown(evt)}\r\n      onKeyUp={(evt) => this.onKeyUp(evt)}\r\n      onWheel={this._onWheel.bind(this)} />\r\n    const jsx = (this.state.wRender > 0) ? jsxCanvasSized : jsxCanvasNonSized;\r\n    return jsx;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(Graphics3d);\r\n","/**\r\n * @fileOverview UiMain3dLight\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { Row, Col } from 'react-bootstrap';\r\n\r\nimport UiCtrl3dLight from './UiCtrl3dLight';\r\nimport UiCtrl3d from './UiCtrl3d';\r\nimport Graphics3d from '../engine/Graphics3d';\r\nimport 'nouislider/distribute/nouislider.css';\r\n\r\nimport { ListGroup } from 'react-bootstrap';\r\n\r\nimport Nouislider from 'react-nouislider';\r\n\r\n//import Modes3d from '../store/Modes3d';\r\n\r\nimport StoreActionType from '../store/ActionTypes';\r\nimport ModeView from '../store/ModeView';\r\nimport UiTools2d from './UiTools2d';\r\n\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiMain3dLight some text later...\r\n */\r\nclass UiMain3dLight extends React.Component {\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.m_updateEnable = true;\r\n  }\r\n\r\n  onChangeSliderBrightness() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderBrightness.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Brightness, sliderBrightness: Number.parseFloat(aval) });\r\n  }\r\n\r\n  onChangeSliderCut() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderCut.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Cut, sliderCut: Number.parseFloat(aval) });\r\n  }\r\n\r\n  onChangeSliderQuality() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderQuality.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Quality, sliderQuality: Number.parseFloat(aval) });    \r\n  }\r\n\r\n  onChangeSliderContrast3D() {\r\n    this.m_updateEnable = false;\r\n    const aval = this.refs.sliderContrast3D.slider.get();\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Contrast3D, sliderContrast3D: Number.parseFloat(aval) });    \r\n  }\r\n\r\n  /*\r\n  shouldComponentUpdate() {\r\n    //return this.m_updateEnable;\r\n    return true;\r\n  }\r\n  */\r\n  shouldComponentUpdate(nextProps) {\r\n    //return this.m_updateEnable;\r\n    let flag = this.m_updateEnable;\r\n    if (this.props.isTool3D !== nextProps.isTool3D || this.props.modeView !== nextProps.modeView) {\r\n      flag = true;\r\n    }\r\n    return flag;\r\n    //return true;\r\n  }\r\n\r\n  //{(store.isTool3D === false) ? jsxView : jsxTool}\r\n  render() {\r\n    const store = this.props;\r\n    const modeViewIndex = store.modeView;\r\n\r\n    const sliderBrightness = store.sliderBrightness;\r\n    const sliderCut = store.sliderCut;\r\n    const sliderQuality = store.sliderQuality;\r\n\r\n    const wArrBrightness = [sliderBrightness];\r\n    const wArrCut = [sliderCut];\r\n    const wArrQuality = [sliderQuality];\r\n    const jsx3dLight = <UiCtrl3dLight></UiCtrl3dLight>;\r\n    const jsx3d = <UiCtrl3d></UiCtrl3d>;\r\n\r\n    const jsxArray = new Array(ModeView.VIEW_COUNT);\r\n    jsxArray[ModeView.VIEW_3D_LIGHT] = jsx3dLight ;\r\n    jsxArray[ModeView.VIEW_3D] = jsx3d;\r\n    const jsxRet = jsxArray[modeViewIndex];\r\n    const jsxView =\r\n      <ListGroup as=\"ul\" variant=\"flush\">\r\n        <ListGroup.Item>\r\n          <p> Brightness </p>\r\n          <Nouislider onSlide={this.onChangeSliderBrightness.bind(this)} ref={'sliderBrightness'}\r\n            range={{ min: 0.0, max: 1.0 }}\r\n            overflow-scroll={'true'}\r\n            start={wArrBrightness} connect={[false, false]} step={0.02} tooltips={true} />\r\n        </ListGroup.Item>\r\n        <ListGroup.Item>\r\n          <p> Quality </p>\r\n          <Nouislider onSlide={this.onChangeSliderQuality.bind(this)} ref={'sliderQuality'}\r\n            range={{ min: 0.0, max: 1.0 }}\r\n            overflow-scroll={'true'}\r\n            start={wArrQuality} connect={[false, false]} step={0.02} tooltips={true} />\r\n        </ListGroup.Item>\r\n\r\n      </ListGroup>\r\n    const jsxTool =\r\n    <ListGroup as=\"ul\" variant=\"flush\">\r\n      <ListGroup.Item>\r\n        <p> Cut plane opacity </p>\r\n        <Nouislider onSlide={this.onChangeSliderContrast3D.bind(this)} ref={'sliderContrast3D'}\r\n          range={{ min: 0.0, max: 1.0 }}\r\n          overflow-scroll={'true'}\r\n          start={wArrBrightness} connect={[false, false]} step={0.02} tooltips={true} />\r\n      </ListGroup.Item>\r\n      <UiTools2d />\r\n    </ListGroup>\r\n    const MIN_HEIGHT = 882;\r\n    const strMinHeight = {\r\n      minHeight: MIN_HEIGHT.toString() + 'px'\r\n    };\r\n\r\n\r\n    const jsxMain3dLight = \r\n      <Row>\r\n        <Col xs={12} sm md lg={4}  >\r\n          {jsxRet}\r\n          <ListGroup.Item as=\"ul\" variant=\"flush\">\r\n            <p> Cut </p>\r\n            <Nouislider onSlide={this.onChangeSliderCut.bind(this)} ref={'sliderCut'}\r\n              range={{ min: 0.0, max: 1.0 }}\r\n              overflow-scroll={'true'}\r\n              start={wArrCut} connect={[false, false]} step={0.01} tooltips={true} />\r\n          </ListGroup.Item>\r\n          {(store.isTool3D === false) ? jsxView : jsxTool}\r\n        </Col>\r\n        <Col xs={12} sm md lg={8} style={strMinHeight}  >\r\n          <Graphics3d  />\r\n        </Col>\r\n      </Row> ; \r\n    \r\n    return jsxMain3dLight;\r\n  };\r\n}\r\n\r\nexport default connect(store => store)(UiMain3dLight);\r\n","import React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport UiMainMpr from './UiMainMpr';\r\nimport UiMain2d from './UiMain2d';\r\nimport UiMain3dLight from './UiMain3dLight';\r\n\r\nimport ModeView from '../store/ModeView';\r\n\r\nclass UiMain extends React.Component {\r\n  render() {\r\n    const store = this.props;\r\n    const modeViewIndex = store.modeView;\r\n    const jsxMainMpr = <UiMainMpr></UiMainMpr>;\r\n    const jsxMain2d = <UiMain2d></UiMain2d>;\r\n    const jsxMain3dLight = <UiMain3dLight></UiMain3dLight>;\r\n\r\n    const jsxArray = new Array(ModeView.VIEW_COUNT);\r\n    jsxArray[ModeView.VIEW_MPR] = jsxMainMpr;\r\n    jsxArray[ModeView.VIEW_2D] = jsxMain2d;\r\n    jsxArray[ModeView.VIEW_3D_LIGHT] = jsxMain3dLight ;\r\n    jsxArray[ModeView.VIEW_3D] = jsxMain3dLight;\r\n    const jsxRet = jsxArray[modeViewIndex];\r\n    return jsxRet;\r\n  };\r\n}\r\n\r\nexport default connect(store => store)(UiMain);\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Loading result codes\r\n* @module lib/scripts/loaders/loadresult\r\n*/\r\n\r\n// ******************************************************************\r\n// imports\r\n// ******************************************************************\r\n\r\n/** Class LoadResult to report loading status of binary files  (Ktx, Dicom, Nifti)*/\r\nexport default class LoadResult {\r\n  static getResultString(errorCode) {\r\n    switch (errorCode) {\r\n    case LoadResult.SUCCESS:\r\n      return 'Success';\r\n    case LoadResult.UNKNOWN:\r\n      return 'Unknown';\r\n    case LoadResult.BAD_DICOM:\r\n      return 'Bad Dicom';\r\n    case LoadResult.BAD_HEADER:\r\n      return 'Bad header';\r\n    case LoadResult.UNSUPPORTED_ENDIANNESS:\r\n      return 'Unsupported endianness';\r\n    case LoadResult.UNSUPPORTED_COLOR_FORMAT:\r\n      return 'Unsupported color format';\r\n    case LoadResult.WRONG_HEADER_DATA_SIZE:\r\n      return 'Wrong header data size';\r\n    case LoadResult.WRONG_HEADER_DIMENSIONS:\r\n      return 'Wrong header dimensions';\r\n    case LoadResult.WRONG_HEADER_DATA_TYPE:\r\n      return 'Wrong header data type';\r\n    case LoadResult.WRONG_HEADER_BITS_PER_PIXEL:\r\n      return 'Wrong header bits per pixel';\r\n    case LoadResult.WRONG_HEADER_MAGIC:\r\n      return 'Wrong header magic';\r\n    case LoadResult.ERROR_PROCESS_HISTOGRAM:\r\n      return 'Wrong histogram';\r\n    case LoadResult.WRONG_IMAGE_DIM_X:\r\n      return 'Wrong image dim x';\r\n    case LoadResult.WRONG_IMAGE_DIM_Y:\r\n      return 'Wrong image dim y';\r\n    case LoadResult.WRONG_IMAGE_DIM_Z:\r\n      return 'Wrong image dim z';\r\n    case LoadResult.ERROR_PIXELS_TAG_NOT_FOUND:\r\n      return 'Pixels tag is not found';\r\n    case LoadResult.ERROR_NO_MEMORY:\r\n      return 'No memory during loading';\r\n    case LoadResult.ERROR_CANT_OPEN_URL:\r\n      return 'Cant open file via url';\r\n    case LoadResult.ERROR_WRONG_NUM_SLICES:\r\n      return 'Wrong number of slices';\r\n    case LoadResult.ERROR_HISTOGRAM_DETECT_RIDGES:\r\n      return 'Error detect histogram ridges';\r\n    case LoadResult.ERROR_SCALING:\r\n      return 'Error scaling 16 bit data into 8 bit';\r\n    case LoadResult.ERROR_INVALID_SLICE_INDEX:\r\n      return 'Invalid slice index. Possible reason: incomplete dicom folder';\r\n    case LoadResult.ERROR_TOO_SMALL_DATA_SIZE:\r\n      return 'Too small input data size';\r\n    case LoadResult.ERROR_TOO_LARGE_DATA_SIZE:\r\n      return 'Too large input data size';\r\n    case LoadResult.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED:\r\n      return 'Compressed image formats read is not supported';\r\n    default:\r\n      return 'Unknown error code';\r\n    } // switch\r\n  }  // getResultString\r\n} // class LoadResult\r\n\r\nLoadResult.SUCCESS = 0;\r\nLoadResult.UNKNOWN = 1;\r\nLoadResult.BAD_DICOM = 2;\r\nLoadResult.BAD_HEADER = 3;\r\nLoadResult.UNSUPPORTED_ENDIANNESS = 4;\r\nLoadResult.UNSUPPORTED_COLOR_FORMAT = 5;\r\nLoadResult.WRONG_HEADER_DATA_SIZE = 6;\r\nLoadResult.WRONG_HEADER_DIMENSIONS = 7;\r\nLoadResult.WRONG_HEADER_DATA_TYPE = 8;\r\nLoadResult.WRONG_HEADER_BITS_PER_PIXEL = 9;\r\nLoadResult.WRONG_HEADER_MAGIC = 10;\r\nLoadResult.ERROR_PROCESS_HISTOGRAM = 11;\r\nLoadResult.WRONG_IMAGE_DIM_X = 12;\r\nLoadResult.WRONG_IMAGE_DIM_Y = 13;\r\nLoadResult.ERROR_PIXELS_TAG_NOT_FOUND = 14;\r\nLoadResult.ERROR_NO_MEMORY = 15;\r\nLoadResult.ERROR_CANT_OPEN_URL = 16;\r\nLoadResult.ERROR_WRONG_NUM_SLICES = 17;\r\nLoadResult.ERROR_HISTOGRAM_DETECT_RIDGES = 18;\r\nLoadResult.ERROR_SCALING = 19;\r\nLoadResult.ERROR_INVALID_SLICE_INDEX = 20;\r\nLoadResult.ERROR_TOO_SMALL_DATA_SIZE = 21;\r\nLoadResult.ERROR_TOO_LARGE_DATA_SIZE = 22;\r\nLoadResult.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED = 23;\r\n\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Common binary file loader\r\n* @module src/demo/engine/loaders/FileLoader\r\n*/\r\n\r\n// ******************************************************************\r\n// File loader\r\n// ******************************************************************\r\n\r\n/** Instance habdle for loader */\r\nlet GInstanceFileLoader = null;\r\n\r\n/** Class FileLoader for load binary files */\r\nexport default class FileLoader {\r\n  /** Create empty loader\r\n  * @param {string} strUrl - URL for loaded file\r\n  */\r\n  constructor(strUrl) {\r\n    if (!GInstanceFileLoader) {\r\n      GInstanceFileLoader = this;\r\n    }\r\n    /** @property {string} m_url - Urlf ror file being read */\r\n    this.m_url = strUrl;\r\n    /** @property {object} m_request - XMLHttpRequest object, used for acees to resource */\r\n    this.m_request = null;\r\n    this.readFile = this.readFile.bind(this);\r\n  }\r\n\r\n  /** Read file\r\n  * @param {object} doneCallback - invoked callback\r\n  */\r\n  readFile(doneCallback, rejectCallback) {\r\n    const METHOD = 'GET';\r\n    this.m_request = new XMLHttpRequest();\r\n    if (!this.m_request) {\r\n      console.log('Cant create object request');\r\n    }\r\n    if ('withCredentials' in this.m_request) {\r\n      // this.m_request.withCredentials = true;\r\n      const NEED_ASYNC = true;\r\n      this.m_request.open(METHOD, this.m_url, NEED_ASYNC);\r\n    // } else if (typeof XDomainRequest !== 'undefined') {\r\n    //   console.log('HttpRequest: XDomainRequest will be used');\r\n    //   this.m_request = new XDomainRequest();\r\n    //   this.m_request.open(METHOD, this.m_url);\r\n    } else {\r\n      this.m_request = null;\r\n      console.log('This browser cant support CORS requests');\r\n      return;\r\n    }\r\n\r\n    this.m_request.responseType = 'arraybuffer';  // \"blob\"\r\n    this.m_request.addEventListener('load', (event) => {\r\n      const arrBuf = event.target.response;\r\n      if (arrBuf === null) {\r\n        console.log('Bad response type. Expect object type in response.');\r\n      } else if (doneCallback) {\r\n        // console.log(`FileFromServer response received. url = ${this.m_url}`);\r\n\r\n        // check wrong buffer content\r\n        const enc = new TextDecoder(\"utf-8\");\r\n        let sz = arrBuf.byteLength;\r\n        if (sz > 4000) {\r\n          sz = 4000;\r\n        }\r\n        const bufHead = arrBuf.slice(0, sz);\r\n        const strBuf = enc.decode(bufHead);\r\n        if (strBuf.substr(0, 9) === \"<!DOCTYPE\") {\r\n          console.log(\"Error load data from URL. Read result is \" + strBuf);\r\n        }\r\n        doneCallback(arrBuf);\r\n      }\r\n    }, false);\r\n\r\n    this.m_request.addEventListener('error', () => {\r\n      // console.log(`Error event happend for XMLHttpRequest: loaded = ${event.loaded}, total = ${event.total}`);\r\n      const errMsg = `Error accessing file ${this.m_url}`;\r\n      rejectCallback(errMsg);\r\n    }, false);\r\n\r\n    this.m_request.send();\r\n    const RES_FAIL_404 = 404;\r\n    if (this.m_request.status === RES_FAIL_404) {\r\n      const errMsg = `Cant access url =  ${this.m_url}`;\r\n      rejectCallback(errMsg);\r\n    }\r\n  }\r\n} // end class FileLoader\r\n","/**\r\n * @fileOverview LoaderKtx\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport LoadResult from '../LoadResult';\r\nimport FileLoader from './FileLoader';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\nexport const KtxHeader = {\r\n  KTX_GL_RED: 0x1903,\r\n  KTX_GL_RGB: 0x1907,\r\n  KTX_GL_RGBA: 0x1908,\r\n  KTX_GL_R8_EXT: 0x8229,\r\n  KTX_GL_RGB8_OES: 0x8051,\r\n  KTX_GL_RGBA8_OES: 0x8058,\r\n};\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class LoaderKtx some text later...\r\n */\r\nexport default class LoaderKtx {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor() {\r\n    this.m_header = {\r\n      m_id: '',\r\n      m_endianness: 0,\r\n      m_glType: 0,\r\n      m_glTypeSize: 0,\r\n      m_glFormat: 0,\r\n      m_glInternalFormat: 0,\r\n      m_glBaseInternalFormat: 0,\r\n      m_pixelWidth: 0,\r\n      m_pixelHeight: 0,\r\n      m_pixelDepth: 0,\r\n      m_numberOfArrayElements: 0,\r\n      m_numberOfFaces: 0,\r\n      m_numberOfMipmapLevels: 0,\r\n      m_bytesOfKeyValueData: 0\r\n    };\r\n    this.m_boxSize = {\r\n      x: 0.0,\r\n      y: 0.0,\r\n      z: 0.0\r\n    };\r\n  } // constructor\r\n\r\n  //\r\n  static readInt(bufBytes, bufOff) {\r\n    let iVal = 0;\r\n    const BYTES_IN_INT = 4;\r\n    const BITS_IN_BYTE = 8;\r\n    const LAST_INDEX = 3;\r\n    for (let i = 0; i < BYTES_IN_INT; i++) {\r\n      const iShifted = iVal << BITS_IN_BYTE;\r\n      iVal = iShifted + bufBytes[bufOff + LAST_INDEX - i];\r\n    }\r\n    return iVal;\r\n  }\r\n\r\n  //\r\n  static readFloat(buf, off) {\r\n    const BYTES_IN_FLOAT = 4;\r\n    const arBuf = new ArrayBuffer(BYTES_IN_FLOAT);\r\n    const dataArray = new DataView(arBuf);\r\n    const OFF_0 = 0; const OFF_1 = 1;\r\n    const OFF_2 = 2; const OFF_3 = 3;\r\n    dataArray.setUint8(OFF_0, buf[off + OFF_0]);\r\n    dataArray.setUint8(OFF_1, buf[off + OFF_1]);\r\n    dataArray.setUint8(OFF_2, buf[off + OFF_2]);\r\n    dataArray.setUint8(OFF_3, buf[off + OFF_3]);\r\n    const IS_LITTLE_ENDIAN = true;\r\n    const res = dataArray.getFloat32(0, IS_LITTLE_ENDIAN);\r\n    return res;\r\n  } // readFloat\r\n\r\n  //\r\n  //\r\n  //\r\n  readFromBuffer(volDst, arrBuf, callbackProgress, callbackComplete) {\r\n    // prepare KTX header\r\n    const bufBytes = new Uint8Array(arrBuf);\r\n    let bufOff = 0;\r\n    if (callbackProgress !== undefined) {\r\n      callbackProgress(0.0);\r\n    }\r\n    if (bufBytes.length === 0) {\r\n      if (callbackComplete !== undefined) {\r\n        callbackComplete(LoadResult.BAD_HEADER);\r\n      }\r\n      return LoadResult.BAD_HEADER;\r\n    }\r\n\r\n    // console.log(`readFromKtx. len = ${bufBytes.length}`);\r\n    // console.log(`readFromKtx. data = ${bufBytes}`);\r\n\r\n    // read header\r\n    const arrayHeaderSign = [0xAB, 0x4B, 0x54, 0x58, 0x20, 0x31, 0x31, 0xBB, 0x0D, 0x0A, 0x1A, 0x0A];\r\n    const lenHeaderSign = arrayHeaderSign.length;\r\n    let isHeaderSignCorrect = true;\r\n    let i;\r\n    // for (i = 0; i < lenHeaderSign; i++) {\r\n    //   console.log(`${bufBytes[i]}`);\r\n    // }\r\n    for (i = 0; i < lenHeaderSign; i++) {\r\n      if (bufBytes[bufOff] !== arrayHeaderSign[i]) {\r\n        isHeaderSignCorrect = false;\r\n        break;\r\n      }\r\n      this.m_header.m_id += String.fromCharCode(bufBytes[bufOff]);\r\n      bufOff += 1;\r\n    }\r\n    if (!isHeaderSignCorrect) {\r\n      console.log('KTX HEADER IS WRONG');\r\n      if (callbackComplete !== undefined) {\r\n        callbackComplete(LoadResult.BAD_HEADER);\r\n      }\r\n      return LoadResult.BAD_HEADER;\r\n    }\r\n    const SIZE_DWORD = 4;\r\n    const ENDIANNESS_16 = 16;\r\n    const ENDIAN_CONST = 0x04030201;\r\n    // read endianess\r\n    this.m_header.m_endianness = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n    if (this.m_header.m_endianness !== ENDIAN_CONST) {\r\n      const strFoundEndns = this.m_header.m_endianness.toString(ENDIANNESS_16);\r\n      // eslint-disable-next-line\r\n      console.log(`ENDIANNESS IS WRONG. Found = ${strFoundEndns} , but should be = ${ENDIAN_CONST.toString(16)}`);\r\n      if (callbackComplete !== undefined) {\r\n        callbackComplete(LoadResult.UNSUPPORTED_ENDIANNESS);\r\n      }\r\n      return LoadResult.UNSUPPORTED_ENDIANNESS;\r\n    }\r\n\r\n    // read\r\n    this.m_header.m_glType = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n    this.m_header.m_glTypeSize = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n    this.m_header.m_glFormat = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n\r\n    if (\r\n      (this.m_header.m_glFormat !== KtxHeader.KTX_GL_RED) &&\r\n      (this.m_header.m_glFormat !== KtxHeader.KTX_GL_RGB) &&\r\n      (this.m_header.m_glFormat !== KtxHeader.KTX_GL_RGBA)) {\r\n      console.log('KTX header.m_glFormat is WRONG');\r\n      if (callbackComplete !== undefined) {\r\n        callbackComplete(LoadResult.UNSUPPORTED_COLOR_FORMAT);\r\n      }\r\n      return LoadResult.UNSUPPORTED_COLOR_FORMAT;\r\n    }\r\n    this.m_header.m_glInternalFormat = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n    this.m_header.m_glBaseInternalFormat = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n    this.m_header.m_pixelWidth = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n    this.m_header.m_pixelHeight = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n    this.m_header.m_pixelDepth = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n\r\n    // save to result volume\r\n    volDst.m_xDim = this.m_header.m_pixelWidth;\r\n    volDst.m_yDim = this.m_header.m_pixelHeight;\r\n    volDst.m_zDim = this.m_header.m_pixelDepth;\r\n\r\n    // check dim\r\n    const head = this.m_header;\r\n    // console.log(`check dim: ${head.m_pixelWidth} * ${head.m_pixelHeight} * ${head.m_pixelDepth}`);\r\n    const MIN_DIM = 4;\r\n    const MAX_DIM = (1024 * 8);\r\n    if ((head.m_pixelWidth < MIN_DIM) || (head.m_pixelHeight < MIN_DIM) \r\n      || (head.m_pixelDepth < MIN_DIM)) {\r\n      console.log(`KTX dims too small: ${head.m_pixelWidth} * ${head.m_pixelHeight} * ${head.m_pixelDepth}`);\r\n      if (callbackComplete !== undefined) {\r\n        callbackComplete(LoadResult.WRONG_IMAGE_DIM_X);\r\n      }\r\n      return LoadResult.WRONG_IMAGE_DIM_X;\r\n    }\r\n    if ((head.m_pixelWidth > MAX_DIM) || (head.m_pixelHeight > MAX_DIM) \r\n      || (head.m_pixelDepth > MAX_DIM)) {\r\n      console.log(`KTX dims too large: ${head.m_pixelWidth} * ${head.m_pixelHeight} * ${head.m_pixelDepth}`);\r\n      if (callbackComplete !== undefined) {\r\n        callbackComplete(LoadResult.WRONG_IMAGE_DIM_X);\r\n      }\r\n      return LoadResult.WRONG_IMAGE_DIM_X;\r\n    }\r\n\r\n    this.m_header.m_numberOfArrayElements = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n    this.m_header.m_numberOfFaces = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n    this.m_header.m_numberOfMipmapLevels = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n    this.m_header.m_bytesOfKeyValueData = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n\r\n    let bytesPerVoxel = 0;\r\n    const SIZE_BYTE = 1;\r\n    const SIZE_COLOR3 = 3;\r\n    const SIZE_COLOR4 = 4;\r\n    if (this.m_header.m_glFormat === KtxHeader.KTX_GL_RED) {\r\n      bytesPerVoxel = SIZE_BYTE;\r\n    } else if (this.m_header.m_glFormat === KtxHeader.KTX_GL_RGB) {\r\n      bytesPerVoxel = SIZE_COLOR3;\r\n    } else if (this.m_header.m_glFormat === KtxHeader.KTX_GL_RGBA) {\r\n      bytesPerVoxel = SIZE_COLOR4;\r\n    }\r\n\r\n    // read user data\r\n    if (this.m_header.m_bytesOfKeyValueData > 0) {\r\n      let udataOff = bufOff;\r\n      bufOff += this.m_header.m_bytesOfKeyValueData;\r\n\r\n      let xMin, yMin, zMin, xMax, yMax, zMax;\r\n      while (udataOff < bufOff) {\r\n        // read pair len\r\n        // const pairLen = KtxLoader.readInt(bufBytes, udataOff);\r\n        udataOff += SIZE_DWORD;\r\n\r\n        // read string until 0\r\n        let str = '';\r\n        let b;\r\n        for (b = bufBytes[udataOff]; b !== 0; udataOff++) {\r\n          b = bufBytes[udataOff];\r\n          if (b !== 0) {\r\n            str = str.concat(String.fromCharCode(b));\r\n          }\r\n        } // for\r\n        console.log(`UDataString = ${str}`);\r\n        // read vector\r\n        if (str === 'fBoxMin') {\r\n          xMin = LoaderKtx.readFloat(bufBytes, udataOff); udataOff += SIZE_DWORD;\r\n          yMin = LoaderKtx.readFloat(bufBytes, udataOff); udataOff += SIZE_DWORD;\r\n          zMin = LoaderKtx.readFloat(bufBytes, udataOff); udataOff += SIZE_DWORD;\r\n          console.log(`vBoxMix = ${xMin} * ${yMin} * ${zMin}`);\r\n        } else if (str === 'fBoxMax') {\r\n          xMax = LoaderKtx.readFloat(bufBytes, udataOff); udataOff += SIZE_DWORD;\r\n          yMax = LoaderKtx.readFloat(bufBytes, udataOff); udataOff += SIZE_DWORD;\r\n          zMax = LoaderKtx.readFloat(bufBytes, udataOff); udataOff += SIZE_DWORD;\r\n          this.m_boxSize.x = xMax - xMin;\r\n          this.m_boxSize.y = yMax - yMin;\r\n          this.m_boxSize.z = zMax - zMin;\r\n          console.log(`vBox = ${this.m_boxSize.x} * ${this.m_boxSize.y} * ${this.m_boxSize.z}`);\r\n          break;\r\n        } // if fbox max\r\n      } // while udata not ended\r\n    } // if have key data\r\n    // read image data size\r\n    this.m_dataSize = LoaderKtx.readInt(bufBytes, bufOff); bufOff += SIZE_DWORD;\r\n    const dataSizeCalculated =\r\n      this.m_header.m_pixelWidth *\r\n      this.m_header.m_pixelHeight *\r\n      this.m_header.m_pixelDepth * bytesPerVoxel;\r\n    if (this.m_dataSize !== dataSizeCalculated) {\r\n      console.log('!!! not implemented yet');\r\n      if (callbackComplete !== undefined) {\r\n        callbackComplete(LoadResult.WRONG_HEADER_DATA_SIZE);\r\n      }\r\n      return LoadResult.WRONG_HEADER_DATA_SIZE;\r\n    }\r\n    this.m_dataArray = new Uint8Array(this.m_dataSize);\r\n    // get power of 2 for data size\r\n    let pwr2;\r\n    let pwrFinish = false;\r\n    const MAX_POWER = 29;\r\n    for (pwr2 = MAX_POWER; (pwr2 >= 0) && (!pwrFinish); pwr2--) {\r\n      const val = 1 << pwr2;\r\n      if (val < this.m_dataSize) {\r\n        pwrFinish = true;\r\n      }\r\n    }\r\n    pwr2++;\r\n    // build mask for progress update\r\n    const SOME_POWER_MIN = 3;\r\n    pwr2 -= SOME_POWER_MIN;\r\n    if (pwr2 <= 0) {\r\n      pwr2 = 1;\r\n    }\r\n    const progressMask = (1 << pwr2) - 1;\r\n\r\n    for (let i = 0; i < this.m_dataSize; i++) {\r\n      this.m_dataArray[i] = bufBytes[bufOff];\r\n      bufOff += 1;\r\n      // progress update\r\n      if ((callbackProgress !== undefined) && ((i & progressMask) === 0) && (i > 0)) {\r\n        const ratio = i / this.m_dataSize;\r\n        callbackProgress(ratio);\r\n      }\r\n    }\r\n    // update box, if not read\r\n    if (this.m_boxSize.x === 0.0) {\r\n      // Some artificial size: just proportional to pixels dimension\r\n      const MM_PER_PIXEL = 0.3;\r\n      this.m_boxSize.x = MM_PER_PIXEL * this.m_header.m_pixelWidth;\r\n      this.m_boxSize.x = MM_PER_PIXEL * this.m_header.m_pixelWidth;\r\n      this.m_boxSize.y = MM_PER_PIXEL * this.m_header.m_pixelHeight;\r\n      this.m_boxSize.z = MM_PER_PIXEL * this.m_header.m_pixelDepth;\r\n      console.log(`vBox = ${this.m_boxSize.x} * ${this.m_boxSize.y} * ${this.m_boxSize.z}`);\r\n    }\r\n\r\n    volDst.m_bytesPerVoxel = bytesPerVoxel;\r\n    volDst.m_dataArray = this.m_dataArray;\r\n    volDst.m_dataSize = this.m_dataSize;\r\n    volDst.m_boxSize = this.m_boxSize;\r\n    console.log(`KTX Loaded successfully with dim = ${volDst.m_xDim}*${volDst.m_yDim}*${volDst.m_zDim}. bpp=${volDst.m_bytesPerVoxel}`);\r\n\r\n    this.m_isLoadedSuccessfull = true;\r\n    if (callbackProgress !== undefined) {\r\n      callbackProgress(1.0);\r\n    }\r\n    if (callbackComplete !== undefined) {\r\n      callbackComplete(LoadResult.SUCCESS);\r\n    }\r\n    return LoadResult.SUCCESS;\r\n  } // end readFromBuffer\r\n\r\n  /**\r\n  *\r\n  * Read Ktx file from URL\r\n  * @param {object} volDst volume to read\r\n  * @param {string} strUrl from where\r\n  * @param {Function} callbackProgress invoke during loading\r\n  * @param {Function} callbackComplete invoke at the end with final success code\r\n  */\r\n  readFromUrl(volDst, strUrl, callbackProgress, callbackComplete) {\r\n    console.log(`LoadedKtx. staring read ${strUrl}`);\r\n    this.m_fileLoader = new FileLoader(strUrl);\r\n    this.m_fileLoader.readFile((arrBuf) => {\r\n      this.readFromBuffer(volDst, arrBuf, callbackProgress, callbackComplete);\r\n      return;\r\n    }, (errMsg) => {\r\n      console.log(`LoaderKtx. Error read file: ${errMsg}`);\r\n      callbackComplete(LoadResult.ERROR_CANT_OPEN_URL, null, 0, null);\r\n      return;\r\n    });\r\n  } // end of readFromUrl\r\n} // end class\r\n","/**\r\n * @fileOverview LoaderNifti\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport LoadResult from '../LoadResult';\r\nimport UiHistogram from '../../ui/UiHistogram';\r\nimport FileLoader from './FileLoader';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// const NEED_EVEN_TEXTURE_SIZE = false;\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class LoaderNifti some text later...\r\n */\r\nclass LoaderNifti {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor() {\r\n    this.m_littleEndian = true;\r\n    this.m_header = {\r\n      m_id: '',\r\n      m_endianness: 0,\r\n      m_glType: 0,\r\n      m_glTypeSize: 0,\r\n      m_glFormat: 0,\r\n      m_glInternalFormat: 0,\r\n      m_glBaseInternalFormat: 0,\r\n      m_pixelWidth: 0,\r\n      m_pixelHeight: 0,\r\n      m_pixelDepth: 0,\r\n      m_numberOfArrayElements: 0,\r\n      m_numberOfFaces: 0,\r\n      m_numberOfMipmapLevels: 0,\r\n      m_bytesOfKeyValueData: 0\r\n    };\r\n    this.m_xDim = 0;\r\n    this.m_yDim = 0;\r\n    this.m_zDim = 0;\r\n    this.m_boxSize = {\r\n      x: 0.0,\r\n      y: 0.0,\r\n      z: 0.0\r\n    };\r\n  } // constructor\r\n\r\n  /**\r\n  * Read 32 bit integer from input buffer\r\n  * @param {object} buf - source buffer\r\n  * @param {number} off - offset in buffer\r\n  * @return 32 bit integer number\r\n  */\r\n  readIntFromBuffer(buf, off) {\r\n    let res = 0;\r\n    if (this.m_littleEndian) {\r\n      res = ((buf[off + 0]) |\r\n        // eslint-disable-next-line\r\n        (buf[off + 1] << 8) |\r\n        // eslint-disable-next-line\r\n        (buf[off + 2] << 16) |\r\n        // eslint-disable-next-line\r\n        (buf[off + 3] << 24));\r\n    } else {\r\n      res = ((buf[off + 3]) |\r\n        // eslint-disable-next-line\r\n        (buf[off + 2] << 8) |\r\n        // eslint-disable-next-line\r\n        (buf[off + 1] << 16) |\r\n        // eslint-disable-next-line\r\n        (buf[off + 0] << 24));\r\n    }\r\n    return res;\r\n  }\r\n\r\n  /**\r\n  * Read 16 bit short integer from input buffer\r\n  * @param {object} buf - source buffer\r\n  * @param {number} off - offset in buffer\r\n  * @return 16 bit short integer number\r\n  */\r\n  readShortFromBuffer(buf, off) {\r\n    let res = 0;\r\n    if (this.m_littleEndian) {\r\n      // eslint-disable-next-line\r\n      res = ((buf[off + 0]) | (buf[off + 1] << 8));\r\n    } else {\r\n      // eslint-disable-next-line\r\n      res = ((buf[off + 1]) | (buf[off + 0] << 8));\r\n    }\r\n    return res;\r\n  }\r\n\r\n  /**\r\n  * Read 32 bit float from input buffer\r\n  * @param {object} buf - source buffer\r\n  * @param {number} off - offset in buffer\r\n  * @return float number, loaded from buffer\r\n  */\r\n  readFloatFromBuffer(buf, off) {\r\n    const BYTES_IN_FLOAT = 4;\r\n    const arBuf = new ArrayBuffer(BYTES_IN_FLOAT);\r\n    const dataArray = new DataView(arBuf);\r\n    // eslint-disable-next-line\r\n    dataArray.setUint8(0, buf[off + 0]);\r\n    // eslint-disable-next-line\r\n    dataArray.setUint8(1, buf[off + 1]);\r\n    // eslint-disable-next-line\r\n    dataArray.setUint8(2, buf[off + 2]);\r\n    // eslint-disable-next-line\r\n    dataArray.setUint8(3, buf[off + 3]);\r\n    const res = dataArray.getFloat32(0, this.m_littleEndian);\r\n    return res;\r\n  }\r\n\r\n  /**\r\n  * Read from local file buffer\r\n  * @param {object} volDst - Destination volume object to be fiiied\r\n  * @param {object} arrBuf - source byte buffer\r\n  * @param {func} callbackProgress - function invoked during read\r\n  * @param {func} callbackComplete - function invoked after reading\r\n  * @return true, if success\r\n  */\r\n  readFromBuffer(volDst, arrBuf, callbackProgress, callbackComplete) {\r\n    const bufBytes = new Uint8Array(arrBuf);\r\n    const bufLen = bufBytes.length;\r\n    const MIN_BUF_SIZE = 8;\r\n    const MAX_BUF_SIZE = (1024 * 1024 * 230);\r\n    if (bufLen < MIN_BUF_SIZE) {\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.ERROR_TOO_SMALL_DATA_SIZE , null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    if (bufLen >= MAX_BUF_SIZE) {\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.ERROR_TOO_LARGE_DATA_SIZE , null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    const NIFTI_HEADER_SIZE = 348;\r\n    // Nifti file header size is 348 bytes\r\n    if (bufLen < NIFTI_HEADER_SIZE) {\r\n      console.log('Nifti header too small');\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.BAD_HEADER, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n\r\n    console.log(`Nifti loader. Start parse ${bufLen} bytes...`);\r\n\r\n    const SIZE_DWORD = 4;\r\n    const SIZE_SHORT = 2;\r\n\r\n    let bufOff = 0;\r\n    let headSize = this.readIntFromBuffer(bufBytes, bufOff);\r\n    if (headSize > (2 << 24)) {\r\n      this.m_littleEndian = false;\r\n      headSize = this.readIntFromBuffer(bufBytes, bufOff);\r\n    }\r\n\r\n    bufOff += SIZE_DWORD;\r\n    if (headSize !== NIFTI_HEADER_SIZE) {\r\n      console.log(`Nifti first int wrong: ${headSize}, but should be ${NIFTI_HEADER_SIZE}`);\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.BAD_HEADER, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n\r\n    // data type\r\n    // eslint-disable-next-line\r\n    bufOff += 10;\r\n    // db name\r\n    // eslint-disable-next-line\r\n    bufOff += 18;\r\n    // extents\r\n    bufOff += SIZE_DWORD;\r\n    // session error\r\n    bufOff += SIZE_SHORT;\r\n    // regular\r\n    bufOff += 1;\r\n    // dim info\r\n    bufOff += 1;\r\n\r\n    // read number of dimensions\r\n    const numDimensions = this.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    const MIN_NUM_DIMS = 3;\r\n    if (numDimensions < MIN_NUM_DIMS) {\r\n      console.log(`Nifti header wrong num dimensions: ${numDimensions}, but should be at least 3`);\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.WRONG_HEADER_DIMENSIONS, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    this.m_xDim = this.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    this.m_yDim = this.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    this.m_zDim = this.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n\r\n    // eslint-disable-next-line\r\n    bufOff += 8;\r\n\r\n    // intent_p1\r\n    bufOff += SIZE_DWORD;\r\n    // intent_p2\r\n    bufOff += SIZE_DWORD;\r\n    // intent_p3\r\n    bufOff += SIZE_DWORD;\r\n    // intent_code\r\n    bufOff += SIZE_SHORT;\r\n    const dataType = this.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    const bitPix = this.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n\r\n    const NIFTI_DATA_TYPE_UINT8 = 2;\r\n    const NIFTI_DATA_TYPE_INT16 = 4;\r\n    const NIFTI_DATA_TYPE_FLOAT32 = 16;\r\n    const NIFTI_DATA_TYPE_INT8 = 256;\r\n    const NIFTI_DATA_TYPE_UINT16 = 512;\r\n\r\n    let isDataTypeCorrect = 0;\r\n    isDataTypeCorrect |= (dataType === NIFTI_DATA_TYPE_UINT8);\r\n    isDataTypeCorrect |= (dataType === NIFTI_DATA_TYPE_INT16);\r\n    isDataTypeCorrect |= (dataType === NIFTI_DATA_TYPE_FLOAT32);\r\n    isDataTypeCorrect |= (dataType === NIFTI_DATA_TYPE_INT8);\r\n    isDataTypeCorrect |= (dataType === NIFTI_DATA_TYPE_UINT16);\r\n  \r\n\r\n    if (!isDataTypeCorrect) {\r\n      console.log(`Nifti header read. This data type (${dataType}) is not supported`);\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.WRONG_HEADER_DATA_TYPE, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    const BIT_PIXELS_8 = 8;\r\n    const BIT_PIXELS_16 = 16;\r\n    const BIT_PIXELS_32 = 32;\r\n    const isSupported = (bitPix === BIT_PIXELS_8) | \r\n      (bitPix === BIT_PIXELS_16) | (bitPix === BIT_PIXELS_32);\r\n    if (!isSupported) {\r\n      console.log(`Nifti wrong bitPix: ${bitPix}, but should be 8,16 or 32`);\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.WRONG_HEADER_BITS_PER_PIXEL, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    // slice start\r\n    bufOff += SIZE_SHORT;\r\n\r\n    // grid spacing\r\n    // const pixdim0 = this.readFloatFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    const pixdim1 = this.readFloatFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    const pixdim2 = this.readFloatFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    const pixdim3 = this.readFloatFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n\r\n    // console.log(`Nifti pixdim0: ${pixdim0}`);\r\n    // console.log(`Nifti pixdim1: ${pixdim1}`);\r\n    // console.log(`Nifti pixdim2: ${pixdim2}`);\r\n    // console.log(`Nifti pixdim3: ${pixdim3}`);\r\n\r\n    this.m_boxSize.x = this.m_xDim * pixdim1;\r\n    this.m_boxSize.y = this.m_yDim * pixdim2;\r\n    this.m_boxSize.z = this.m_zDim * pixdim3;\r\n    const TOO_SMALL_SIZE = 1.0e-5;\r\n    if (this.m_boxSize.x < TOO_SMALL_SIZE) {\r\n      const SOME_MAGIC_BOX_DIM = 312.0;\r\n      this.m_boxSize.x = SOME_MAGIC_BOX_DIM;\r\n      this.m_boxSize.y = SOME_MAGIC_BOX_DIM;\r\n      this.m_boxSize.z = SOME_MAGIC_BOX_DIM;\r\n    }\r\n    console.log(`Nifti physic volume size: ${this.m_boxSize.x} * ${this.m_boxSize.y} * ${this.m_boxSize.z}`);\r\n\r\n    // read m_description field (max 80 characters)\r\n    const OFF_DESC = 148;\r\n    const MAX_STR_DECS = 80;\r\n    const arrDesc = bufBytes.slice(OFF_DESC, OFF_DESC + MAX_STR_DECS);\r\n    // const strDescr = decodeURIComponent(escape(String.fromCharCode.apply(null, arrDesc)));\r\n    let strDescr = '';\r\n    let isGoodSym = true;\r\n    const CODE_MIN = 20;\r\n    const CODE_MAX = 255;\r\n    for (let i = 0; (i < MAX_STR_DECS) && isGoodSym; i++) {\r\n      isGoodSym = ((arrDesc[i] >= CODE_MIN) && (arrDesc[i] < CODE_MAX));\r\n      if (isGoodSym) {\r\n        strDescr = strDescr.concat(String.fromCharCode(arrDesc[i]));\r\n      }\r\n    }\r\n    // console.log(`Nifti description = ${strDescr}`);\r\n\r\n    // create dicom info\r\n    /*\r\n    this.m_dicomInfo = new DicomInfo();\r\n    this.m_dicomInfo.m_patientName = strDescr;\r\n    this.m_dicomInfo.m_patientId = '';\r\n    this.m_dicomInfo.m_patientGender = '';\r\n    this.m_dicomInfo.m_patientDateOfBirth = '';\r\n    this.m_dicomInfo.m_studyDate = '';\r\n    this.m_dicomInfo.m_acquisionTime = '';\r\n    this.m_dicomInfo.m_institutionName = '';\r\n    this.m_dicomInfo.m_physicansName = '';\r\n    this.m_dicomInfo.m_manufacturerName = '';\r\n    */\r\n\r\n    // 4 last bytes are magic\r\n    bufOff = NIFTI_HEADER_SIZE - SIZE_DWORD;\r\n    // 'n' == 110, '+' == 43, '1' == 49\r\n    const MAG_0 = 110;\r\n    const MAG_1 = 43;\r\n    const MAG_2 = 49;\r\n    const isCorrectMagic = (bufBytes[bufOff + 0] === MAG_0) &&\r\n      // eslint-disable-next-line\r\n      (bufBytes[bufOff + 1] === MAG_1) &&\r\n      // eslint-disable-next-line\r\n      (bufBytes[bufOff + 2] === MAG_2);\r\n    if (!isCorrectMagic) {\r\n      // eslint-disable-next-line\r\n      console.log(`Nifti hdr bad magic: ${bufBytes[bufOff + 0]}, ${bufBytes[bufOff + 1]}, ${bufBytes[bufOff + 2]}`);\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.WRONG_HEADER_MAGIC, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    bufOff += SIZE_DWORD; // last magic bytes in header\r\n\r\n    const numVoxels = this.m_xDim * this.m_yDim * this.m_zDim;\r\n    const dataOff = bufOff;\r\n\r\n    // get power of 2 for data size\r\n    let pwr2;\r\n    let pwrFinish = false;\r\n    // eslint-disable-next-line\r\n    for (pwr2 = 29; (pwr2 >= 0) && (!pwrFinish); pwr2--) {\r\n      const val = 1 << pwr2;\r\n      if (val < numVoxels) {\r\n        pwrFinish = true;\r\n      }\r\n    }\r\n    pwr2++;\r\n    // console.log(`pwr2 = ${pwr2}`);\r\n    // build mask for progress update\r\n    // eslint-disable-next-line\r\n    pwr2 -= 3;\r\n    if (pwr2 <= 0) {\r\n      pwr2 = 1;\r\n    }\r\n    const progressMask = (1 << pwr2) - 1;\r\n\r\n    let i, j;\r\n    // scan min max in array\r\n    let valMax = 0;\r\n    j = 0;\r\n    if ((dataType === NIFTI_DATA_TYPE_INT16) || (dataType === NIFTI_DATA_TYPE_UINT16)) {\r\n      for (i = 0; i < numVoxels; i++) {\r\n        const val = this.readShortFromBuffer(bufBytes, dataOff + j);\r\n        // eslint-disable-next-line\r\n        j += 2;\r\n        if (val > valMax) {\r\n          valMax = val;\r\n        }\r\n        // progress update\r\n        if (callbackProgress && ((i & progressMask) === 0) && (i > 0)) {\r\n          const ratio = 0.0 + 0.5 * (i / numVoxels);\r\n          callbackProgress(ratio);\r\n        }\r\n      } // for (i) al voxels\r\n    }\r\n    if ((dataType === NIFTI_DATA_TYPE_INT8) || (dataType === NIFTI_DATA_TYPE_UINT8)) {\r\n      for (i = 0; i < numVoxels; i++) {\r\n        const val = bufBytes[dataOff + j];\r\n        // eslint-disable-next-line\r\n        j ++;\r\n        if (val > valMax) {\r\n          valMax = val;\r\n        }\r\n        // progress update\r\n        if (callbackProgress && ((i & progressMask) === 0) && (i > 0)) {\r\n          const ratio = 0.0 + 0.5 * (i / numVoxels);\r\n          callbackProgress(ratio);\r\n        }\r\n      } // for (i) al voxels\r\n    }\r\n    if (dataType === NIFTI_DATA_TYPE_FLOAT32) {\r\n      for (i = 0; i < numVoxels; i++) {\r\n        const fval = this.readFloatFromBuffer(bufBytes, dataOff + j);\r\n        const val = Math.floor(fval) + 1;\r\n        // eslint-disable-next-line\r\n        j += 4;\r\n        if (val > valMax) {\r\n          valMax = val;\r\n        }\r\n        // progress update\r\n        if (callbackProgress && ((i & progressMask) === 0) && (i > 0)) {\r\n          const ratio = 0.0 + 0.5 * (i / numVoxels);\r\n          callbackProgress(ratio);\r\n        }\r\n      } // for (i) al voxels\r\n    }\r\n\r\n    // console.log(`Nifti 16 data max val: ${valMax}`);\r\n\r\n    // create histogram\r\n    // const histArray = new Int32Array(valMax);\r\n    const histArray = new Float32Array(valMax + 1);\r\n    for (i = 0; i < valMax + 1; i++) {\r\n      histArray[i] = 0.0;\r\n    }\r\n    j = 0;\r\n    if ((dataType === NIFTI_DATA_TYPE_INT16) || (dataType === NIFTI_DATA_TYPE_UINT16)) {\r\n      for (i = 0; i < numVoxels; i++) {\r\n        const val = this.readShortFromBuffer(bufBytes, dataOff + j);\r\n        // eslint-disable-next-line\r\n        j += 2;\r\n        histArray[val] ++;\r\n      }\r\n    } // if\r\n    if (dataType === NIFTI_DATA_TYPE_FLOAT32) {\r\n      for (i = 0; i < numVoxels; i++) {\r\n        const val = Math.floor(this.readFloatFromBuffer(bufBytes, dataOff + j));\r\n        // eslint-disable-next-line\r\n        j += 4;\r\n        histArray[val] ++;\r\n      }\r\n    } // if\r\n    if ((dataType === NIFTI_DATA_TYPE_INT8) || (dataType === NIFTI_DATA_TYPE_UINT8)) {\r\n      for (i = 0; i < numVoxels; i++) {\r\n        const val = bufBytes[dataOff + j];\r\n        // eslint-disable-next-line\r\n        j ++;\r\n        histArray[val] ++;\r\n      }\r\n    } // if\r\n\r\n    const histogram = new UiHistogram();\r\n    histogram.assignArray(valMax, histArray);\r\n\r\n    const HIST_SMOOTH_SIGMA = 0.8;\r\n    const NORMALIZATION_APPLY = false;\r\n    histogram.smoothHistogram(HIST_SMOOTH_SIGMA, NORMALIZATION_APPLY);\r\n\r\n    // print histogram values\r\n    // for (i = 0; i < histogram.m_numColors; i++) {\r\n    //   console.log(`hist[ ${i} ] = ${histogram.m_histogram[i]}`);\r\n    // }\r\n\r\n    const VAL_MIN = 4.0;\r\n    // fix max index if maximum not found\r\n    let indMax = histogram.getLastMaxIndex(VAL_MIN);\r\n    if (indMax < 4) {\r\n      indMax = valMax;\r\n    }\r\n    console.log(`LoaderNifti. get Last max peak: ${indMax} / ${histogram.m_numColors}`);\r\n\r\n    // replace val max to extracted maximum from histogram\r\n    valMax = indMax;\r\n    const MAX_BYTE = 255;\r\n    // convert 16 bit data to 8 bit array\r\n    const BITS_IN_BYTE = 8;\r\n    const dataSize = numVoxels * (bitPix / BITS_IN_BYTE);\r\n    let dataArray = new Uint8Array(numVoxels);\r\n    const ACC_DEGREE = 9;\r\n    const scale = (MAX_BYTE << ACC_DEGREE) / valMax;\r\n    const TOO_MIN_SCALE = 4;\r\n    if (scale <= TOO_MIN_SCALE) {\r\n      console.log('Bad scaling: image will be 0');\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.ERROR_PROCESS_HISTOGRAM, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    j = 0;\r\n    if ((dataType === NIFTI_DATA_TYPE_INT16) || (dataType === NIFTI_DATA_TYPE_UINT16)) {\r\n      for (i = 0; i < numVoxels; i++) {\r\n        let val = this.readShortFromBuffer(bufBytes, dataOff + j);\r\n        // eslint-disable-next-line\r\n        j += 2;\r\n        // scale down to [0..255]\r\n        val = (val * scale) >> ACC_DEGREE;\r\n        // check [0..255] range for some voxels out from histogram peak\r\n        val = (val <= MAX_BYTE) ? val : MAX_BYTE;\r\n        dataArray[i] = val;\r\n        // progress update\r\n        if (callbackProgress && ((i & progressMask) === 0) && (i > 0)) {\r\n          const ratio = 0.5 + 0.5 * (i / numVoxels);\r\n          callbackProgress(ratio);\r\n        }\r\n      } // for (i) all voxels\r\n    } // if 16 bit\r\n    if ((dataType === NIFTI_DATA_TYPE_INT8) || (dataType === NIFTI_DATA_TYPE_UINT8)) {\r\n      for (i = 0; i < numVoxels; i++) {\r\n        let val = bufBytes[dataOff + j];\r\n        // eslint-disable-next-line\r\n        j ++;\r\n        // scale down to [0..255]\r\n        val = (val * scale) >> ACC_DEGREE;\r\n        // check [0..255] range for some voxels out from histogram peak\r\n        val = (val <= MAX_BYTE) ? val : MAX_BYTE;\r\n        dataArray[i] = val;\r\n        // progress update\r\n        if (callbackProgress && ((i & progressMask) === 0) && (i > 0)) {\r\n          const ratio = 0.5 + 0.5 * (i / numVoxels);\r\n          callbackProgress(ratio);\r\n        }\r\n      } // for (i) all voxels\r\n    } // if 8 bit\r\n    if (dataType === NIFTI_DATA_TYPE_FLOAT32) {\r\n      for (i = 0; i < numVoxels; i++) {\r\n        let val = Math.floor(this.readFloatFromBuffer(bufBytes, dataOff + j));\r\n        // eslint-disable-next-line\r\n        j += 4;\r\n        // scale down to [0..255]\r\n        val = (val * scale) >> ACC_DEGREE;\r\n        // check [0..255] range for some voxels out from histogram peak\r\n        val = (val <= MAX_BYTE) ? val : MAX_BYTE;\r\n        dataArray[i] = val;\r\n        // progress update\r\n        if (callbackProgress && ((i & progressMask) === 0) && (i > 0)) {\r\n          const ratio = 0.5 + 0.5 * (i / numVoxels);\r\n          callbackProgress(ratio);\r\n        }\r\n      } // for (i) all voxels\r\n    } // if 16 bit\r\n\r\n\r\n    let xyDim = this.m_xDim * this.m_yDim;\r\n    /*\r\n    // Scale down volume by slices\r\n    const numPixelsInVolume = this.m_xDim * this.m_yDim * this.m_zDim;\r\n    // eslint-disable-next-line\r\n    const MAX_VOLUME_PIXELS = 512 * 512 * 256;\r\n    if (this.m_needScaleDownTexture && (numPixelsInVolume > MAX_VOLUME_PIXELS)) {\r\n      const XY_MAX_DIM = 512;\r\n      const Z_LOW_DIM = 120;\r\n      const xDimDst = (this.m_xDim <= XY_MAX_DIM) ? this.m_xDim : XY_MAX_DIM;\r\n      const yDimDst = (this.m_yDim <= XY_MAX_DIM) ? this.m_yDim : XY_MAX_DIM;\r\n      const zDimDst = Z_LOW_DIM;\r\n      const dataNew = VolumeTools.scaleTextureDown(this, dataArray, xDimDst, yDimDst, zDimDst);\r\n      dataArray = dataNew;\r\n      xyDim = this.m_xDim * this.m_yDim;\r\n      console.log(`Volume scaled down to: ${xDimDst} * ${yDimDst} * ${zDimDst}.`);\r\n    }\r\n    */\r\n    /*\r\n    // Special volume texture size fix (z dim should be even)\r\n    if (NEED_EVEN_TEXTURE_SIZE) {\r\n      const xDim = this.m_xDim;\r\n      const yDim = this.m_yDim;\r\n      const zDim = this.m_zDim;\r\n      if ((zDim & 1) !== 0) {\r\n        const volDataAlignedSize = VolumeTools.makeTextureSizeEven(dataArray, xDim, yDim, zDim);\r\n        // Align all dims to 4*x\r\n        const NUM3 = 3;\r\n        this.m_xDim = (xDim + NUM3) & (~NUM3);\r\n        this.m_yDim = (yDim + NUM3) & (~NUM3);\r\n        this.m_zDim = (zDim + NUM3) & (~NUM3);\r\n        dataArray = volDataAlignedSize;\r\n      }\r\n    }\r\n    */\r\n    // clear borders\r\n    let x; let y;\r\n    let z;\r\n    const zOffMin = 0 * xyDim;\r\n    const zOffMax = (this.m_zDim - 1) * xyDim;\r\n    for (y = 0; y < this.m_yDim; y++) {\r\n      const yOff = y * this.m_xDim;\r\n      for (x = 0; x < this.m_xDim; x++) {\r\n        let off;\r\n        off = zOffMin + yOff + x;\r\n        dataArray[off] = 0;\r\n        off = zOffMax + yOff + x;\r\n        dataArray[off] = 0;\r\n      } // for (x)\r\n    }   // for (y)\r\n    const xOffMin = 0;\r\n    const xOffMax = this.m_xDim - 1;\r\n    for (z = 0; z < this.m_zDim; z++) {\r\n      const zOff = z * xyDim;\r\n      for (y = 0; y < this.m_yDim; y++) {\r\n        let off;\r\n        off = zOff + (y * this.m_xDim) + xOffMin;\r\n        dataArray[off] = 0;\r\n        off = zOff + (y * this.m_xDim) + xOffMax;\r\n        dataArray[off] = 0;\r\n      }\r\n    }\r\n    const yOffMin = 0;\r\n    const yOffMax = (this.m_yDim - 1) * this.m_xDim;\r\n    for (z = 0; z < this.m_zDim; z++) {\r\n      const zOff = z * xyDim;\r\n      for (x = 0; x < this.m_xDim; x++) {\r\n        let off;\r\n        off = zOff + yOffMin + x;\r\n        dataArray[off] = 0;\r\n        off = zOff + yOffMax + x;\r\n        dataArray[off] = 0;\r\n      }\r\n    }\r\n\r\n    // save to result volume\r\n    volDst.m_xDim = this.m_xDim;\r\n    volDst.m_yDim = this.m_yDim;\r\n    volDst.m_zDim = this.m_zDim;\r\n\r\n    const ONE = 1;\r\n    volDst.m_bytesPerVoxel = ONE;\r\n    volDst.m_dataArray = dataArray;\r\n    volDst.m_dataSize = numVoxels;\r\n    volDst.m_boxSize = this.m_boxSize;\r\n\r\n    console.log(`Nifti header read OK. Volume pixels = ${this.m_xDim} * ${this.m_yDim} * ${this.m_zDim}`);\r\n    \r\n    // Finally invoke user callback after file was read\r\n    const KTX_GL_RED = 0x1903;\r\n    const KTX_UNSIGNED_BYTE = 0x1401;\r\n    const header = {\r\n      m_pixelWidth: this.m_xDim,\r\n      m_pixelHeight: this.m_yDim,\r\n      m_pixelDepth: this.m_zDim,\r\n      m_glType: KTX_UNSIGNED_BYTE,\r\n      m_glTypeSize: 1,\r\n      m_glFormat: KTX_GL_RED,\r\n      m_glInternalFormat: KTX_GL_RED,\r\n      m_glBaseInternalFormat: KTX_GL_RED,\r\n    };\r\n    if (callbackProgress) {\r\n      callbackProgress(1.0);\r\n    }\r\n    if (callbackComplete) {\r\n      callbackComplete(LoadResult.SUCCESS, header, dataSize, dataArray);\r\n    } // if callbackComplete ready\r\n\r\n    return true;\r\n  } // end of readFromBuffer\r\n\r\n  /**\r\n  *\r\n  * Read Nifti file from URL\r\n  * @param {object} volDst volume to read\r\n  * @param {string} strUrl from where\r\n  * @param {Function} callbackProgress invoke during loading\r\n  * @param {Function} callbackComplete invoke at the end with final success code\r\n  */\r\n  readFromUrl(volDst, strUrl, callbackProgress, callbackComplete) {\r\n    console.log(`LoadedNifti. staring read ${strUrl}`);\r\n    this.m_fileLoader = new FileLoader(strUrl);\r\n    this.m_fileLoader.readFile((arrBuf) => {\r\n      const okRead = this.readFromBuffer(volDst, arrBuf, callbackProgress, callbackComplete);\r\n      return okRead;\r\n    }, (errMsg) => {\r\n      console.log(`LoadedNifti. Error read file: ${errMsg}`);\r\n      callbackComplete(LoadResult.ERROR_CANT_OPEN_URL, null, 0, null);\r\n    });\r\n    return true;\r\n  } // end of readFromUrl\r\n\r\n} // end class LoaderNifti\r\n\r\nexport default LoaderNifti;\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Dicom tags description\r\n* @module lib/scripts/loaders/dicomdict\r\n*/\r\n\r\n\r\nexport default class DicomDictionary {\r\n\r\n  constructor() {\r\n    this.TAGS = [\r\n      /* eslint-disable */\r\n      [0x0002, 0x0000, 'OB', 'FileMetaInfoGroupLength'],\r\n      [0x0002, 0x0001, 'OB', 'FileMetaInformationVersion'],\r\n      [0x0002, 0x0002, 'UI', 'MediaStoredSOPClassUID'],\r\n\r\n      [0x0002, 0x0003, 'UI', 'MediaStoredSOPInstanceUID'],\r\n      [0x0002, 0x0010, 'UI', 'TransferSyntaxUID'],\r\n      [0x0002, 0x0012, 'UI', 'ImplementationClassUID'],\r\n      [0x0002, 0x0013, 'UI', 'ImplementationVersionName'],\r\n      [0x0002, 0x0016, 'UI', 'SourceApplicationEntityTitle'],\r\n      [0x0002, 0x0100, 'UI', 'PrivateInformationCreatorUID'],\r\n      [0x0002, 0x0102, 'UI', 'PrivateInformation'],\r\n\r\n      [0x0008, 0x0000, 'UL', 'IdentifyingGroupLength'],\r\n      [0x0008, 0x0001, 'UI', 'LengthToEnd'],\r\n      [0x0008, 0x0005, 'CS', 'SpecificCharacterSet'],\r\n      [0x0008, 0x0006, 'SQ', 'LanguageCodeSequence'],\r\n      [0x0008, 0x0008, 'CS', 'ImageType'],\r\n      [0x0008, 0x0010, 'SH', 'RecognitionCode'],\r\n      [0x0008, 0x0012, 'DA', 'InstanceCreationDate'],\r\n      [0x0008, 0x0013, 'TM', 'InstanceCreationTime'],\r\n      [0x0008, 0x0014, 'UI', 'InstanceCreatorUID'],\r\n      [0x0008, 0x0016, 'UI', 'SOPClassUID'],\r\n      [0x0008, 0x0018, 'UI', 'SOPInstanceUID'],\r\n      [0x0008, 0x001A, 'UI', 'RelatedGeneralSOPClassUID'],\r\n      [0x0008, 0x001B, 'UI', 'OriginalSpecializedSOPClassUID'],\r\n      [0x0008, 0x0020, 'DA', 'StudyDate'],\r\n      [0x0008, 0x0021, 'DA', 'SeriesDate'],\r\n      [0x0008, 0x0022, 'DA', 'AcquisitionDate'],\r\n      [0x0008, 0x0023, 'DA', 'ContentDate'],\r\n      [0x0008, 0x0024, 'DA', 'OverlayDate'],\r\n      [0x0008, 0x0025, 'DA', 'CurveDate'],\r\n      [0x0008, 0x002A, 'DT', 'AcquisitionDateTime'],\r\n      [0x0008, 0x0030, 'TM', 'StudyTime'],\r\n      [0x0008, 0x0031, 'TM', 'SeriesTime'],\r\n      [0x0008, 0x0032, 'TM', 'AcquisitionTime'],\r\n      [0x0008, 0x0033, 'TM', 'ContentTime'],\r\n      [0x0008, 0x0034, 'TM', 'OverlayTime'],\r\n      [0x0008, 0x0035, 'TM', 'CurveTime'],\r\n      [0x0008, 0x0040, 'US', 'DataSetType'],\r\n      [0x0008, 0x0041, 'LO', 'DataSetSubtype'],\r\n      [0x0008, 0x0042, 'CS', 'NuclearMedicineSeriesType'],\r\n      [0x0008, 0x0050, 'SH', 'AccessionNumber'],\r\n      [0x0008, 0x0051, 'SQ', 'IssuerOfAccessionNumberSequence'],\r\n      [0x0008, 0x0052, 'CS', 'QueryRetrieveLevel'],\r\n      [0x0008, 0x0054, 'AE', 'RetrieveAETitle'],\r\n      [0x0008, 0x0056, 'CS', 'InstanceAvailability'],\r\n      [0x0008, 0x0058, 'UI', 'FailedSOPInstanceUIDList'],\r\n      [0x0008, 0x0060, 'CS', 'Modality'],\r\n      [0x0008, 0x0070, 'XX', 'Manufacturer'],\r\n      [0x0008, 0x0080, 'XX', 'InstitutionName'],\r\n      [0x0008, 0x0081, 'XX', 'InstitutionAddress'],\r\n      [0x0008, 0x0090, 'XX', 'ReferringPhysicansName'],\r\n      [0x0008, 0x1010, 'XX', 'StationName'],\r\n      [0x0008, 0x1030, 'XX', 'StudyDescription'],\r\n      [0x0008, 0x103E, 'LO', 'SeriesDescription'],\r\n      [0x0008, 0x1040, 'XX', 'InstitutionDepartmentName'],\r\n      [0x0008, 0x1050, 'XX', 'PerformingPhysicansName'],\r\n      [0x0008, 0x1060, '\"XX', '\"Unkown'],\r\n      [0x0008, 0x1080, 'XX', 'AdmittingDiagnosesDescription'],\r\n      [0x0008, 0x1090, 'XX', 'ManufacturterModelName'],\r\n      [0x0008, 0x1111, 'XX', 'ReferencedPerformedProcStepSeq'],\r\n      [0x0008, 0x1140, 'XX', 'ReferencedImageSequence'],\r\n      [0x0008, 0x1150, 'UI', 'ReferencedSOP​ClassUID'],\r\n      [0x0008, 0x1155, 'UI', 'ReferencedSOP​InstanceUID'],\r\n\r\n      [0x0008, 0x2111, '\"XX', '\"DerivationDescription'],\r\n      [0x0008, 0x2112, '\"XX', '\"SourceImageSequence'],\r\n    \r\n      [0x0009, 0x0010, 'LO', 'PrivateCreator'],\r\n      [0x0009, 0x0011, '??', '\"Unknown'],\r\n      [0x0009, 0x0012, '??', '\"Unknown'],\r\n    \r\n      [0x0009, 0x1001, 'XX', 'PrivateTag'],\r\n      [0x0009, 0x1002, 'XX', 'PrivateTag'],\r\n      [0x0009, 0x1004, 'XX', 'PrivateTag'],\r\n      [0x0009, 0x1027, 'XX', 'PrivateTag'],\r\n      [0x0009, 0x1030, 'XX', 'PrivateTag'],\r\n      [0x0009, 0x1031, 'XX', 'PrivateTag'],\r\n      [0x0009, 0x10E3, 'XX', 'PrivateTag'],\r\n      [0x0009, 0x10E9, 'XX', 'PrivateTag'],\r\n\r\n      [0x0010, 0x0000, 'UL', 'PatientGroupLength'],\r\n      [0x0010, 0x0010, 'PN', 'PatientName'],\r\n      [0x0010, 0x0020, 'LO', 'PatientID'],\r\n      [0x0010, 0x0021, 'LO', 'IssuerOfPatientID'],\r\n      [0x0010, 0x0022, 'CS', 'TypeOfPatientID'],\r\n      [0x0010, 0x0024, 'SQ', 'IssuerOfPatientIDQualifiersSequence'],\r\n      [0x0010, 0x0030, 'DA', 'PatientBirthDate'],\r\n      [0x0010, 0x0032, 'TM', 'PatientBirthTime'],\r\n      [0x0010, 0x0040, 'CS', 'PatientGender'],\r\n      [0x0010, 0x0050, 'SQ', 'PatientInsurancePlanCodeSequence'],\r\n      [0x0010, 0x0101, 'SQ', 'PatientPrimaryLanguageCodeSequence'],\r\n      [0x0010, 0x0102, 'SQ', 'PatientPrimaryLanguageModifierCodeSequence'],\r\n      [0x0010, 0x1000, 'LO', 'OtherPatientIDs'],\r\n      [0x0010, 0x1001, 'PN', 'OtherPatientNames'],\r\n      [0x0010, 0x1002, 'SQ', 'OtherPatientIDsSequence'],\r\n      [0x0010, 0x1005, 'PN', 'PatientBirthName'],\r\n      [0x0010, 0x1010, 'AS', 'PatientAge'],\r\n      [0x0010, 0x1020, 'DS', 'PatientSize'],\r\n      [0x0010, 0x1021, 'SQ', 'PatientSizeCodeSequence'],\r\n      [0x0010, 0x1030, 'DS', 'PatientWeight'],\r\n      [0x0010, 0x1040, 'LO', 'PatientAddress'],\r\n      [0x0010, 0x1050, 'LO', 'InsurancePlanIdentification'],\r\n      [0x0010, 0x1060, 'PN', 'PatientMotherBirthName'],\r\n      [0x0010, 0x1080, 'LO', 'MilitaryRank'],\r\n      [0x0010, 0x1081, 'LO', 'BranchOfService'],\r\n      [0x0010, 0x1090, 'LO', 'MedicalRecordLocator'],\r\n      [0x0010, 0x2000, 'LO', 'MedicalAlerts'],\r\n      [0x0010, 0x2110, 'LO', 'Allergies'],\r\n      [0x0010, 0x2150, 'LO', 'CountryOfResidence'],\r\n      [0x0010, 0x2152, 'LO', 'RegionOfResidence'],\r\n      [0x0010, 0x2154, 'SH', 'PatientTelephoneNumbers'],\r\n      [0x0010, 0x2160, 'SH', 'EthnicGroup'],\r\n      [0x0010, 0x2180, 'SH', 'Occupation'],\r\n      [0x0010, 0x21A0, 'CS', 'SmokingStatus'],\r\n      [0x0010, 0x21B0, 'LT', 'AdditionalPatientHistory'],\r\n      [0x0010, 0x21C0, 'US', 'PregnancyStatus'],\r\n      [0x0010, 0x21D0, 'DA', 'LastMenstrualDate'],\r\n      [0x0010, 0x21F0, 'LO', 'PatientReligiousPreference'],\r\n      [0x0010, 0x2201, 'LO', 'PatientSpeciesDescription'],\r\n      [0x0010, 0x2202, 'SQ', 'PatientSpeciesCodeSequence'],\r\n      [0x0010, 0x2203, 'CS', 'PatientSexNeutered'],\r\n      [0x0010, 0x2210, 'CS', 'AnatomicalOrientationType'],\r\n      [0x0010, 0x2292, 'LO', 'PatientBreedDescription'],\r\n      [0x0010, 0x2293, 'SQ', 'PatientBreedCodeSequence'],\r\n      [0x0010, 0x2294, 'SQ', 'BreedRegistrationSequence'],\r\n      [0x0010, 0x2295, 'LO', 'BreedRegistrationNumber'],\r\n      [0x0010, 0x2296, 'SQ', 'BreedRegistryCodeSequence'],\r\n      [0x0010, 0x2297, 'PN', 'ResponsiblePerson'],\r\n      [0x0010, 0x2298, 'CS', 'ResponsiblePersonRole'],\r\n      [0x0010, 0x2299, 'LO', 'ResponsibleOrganization'],\r\n      [0x0010, 0x4000, 'LT', 'PatientComments'],\r\n      [0x0010, 0x9431, 'FL', 'ExaminedBodyThickness'],\r\n\r\n      [0x0018, 0x0000, 'UL', 'AcquisitionGroupLength'],\r\n      [0x0018, 0x0020, 'XX', 'ScanningSequence'],\r\n      [0x0018, 0x0021, 'XX', 'SequenceVariant'],\r\n      [0x0018, 0x0022, 'XX', 'ScanOptions'],\r\n      [0x0018, 0x0023, 'XX', 'MrAcquisionType'],\r\n      // Add new tag from 2019-01-23\r\n      [0x0018, 0x0024, '??', '\"SequenceName'],\r\n      [0x0018, 0x0025, 'XX', 'AngioFlag'],\r\n      [0x0018, 0x0050, 'XX', 'SliceThickness'],\r\n      [0x0018, 0x0060, 'DS', 'KVP'],\r\n      [0x0018, 0x0080, 'XX', 'RepetitionTime'],\r\n      [0x0018, 0x0081, 'XX', 'EchoTime'],\r\n      [0x0018, 0x0082, 'XX', 'InversionTime'],\r\n      [0x0018, 0x0083, 'XX', 'NumberOfAverages'],\r\n      [0x0018, 0x0084, 'XX', 'ImagingFrequency'],\r\n      [0x0018, 0x0085, 'XX', 'ImagedNucleus'],\r\n      [0x0018, 0x0086, 'XX', 'EchoNumber'],\r\n      [0x0018, 0x0087, 'XX', 'MagneticFieldStrength'],\r\n      [0x0018, 0x0088, 'XX', 'SpacingBetweenSlices'],\r\n      [0x0018, 0x0089, 'XX', 'NumberOfPhaseEncodingSteps'],\r\n      [0x0018, 0x0090, 'XX', 'DataCollectionDiameter'],\r\n      [0x0018, 0x0091, 'XX', 'EchoTrainLength'],\r\n      [0x0018, 0x0093, 'XX', 'ProcentSampling'],\r\n      [0x0018, 0x0094, 'XX', 'ProcentPhaseFieldOfView'],\r\n      [0x0018, 0x0095, 'XX', 'PixelBandwidth'],\r\n      [0x0018, 0x1000, 'XX', 'DeviceSerialNumber'],\r\n      [0x0018, 0x1002, \"??\", 'DeviceUID'],\r\n      [0x0018, 0x1003, \"??\", 'DeviceID'],\r\n      [0x0018, 0x1004, \"??\", 'PlateID'],\r\n      [0x0018, 0x1005, \"??\", 'GeneratorID'],\r\n      [0x0018, 0x1006, \"??\", 'GridID'],\r\n      [0x0018, 0x1007, \"??\", '\"CassetteID'],\r\n      [0x0018, 0x1008, \"??\", 'GantryID'],\r\n      [0x0018, 0x1010, \"??\", 'SecondaryCaptureDeviceID'],\r\n      [0x0018, 0x1011, \"??\", 'HardcopyCreationDeviceID'],\r\n      [0x0018, 0x1012, \"??\", 'DateOfSecondaryCapture'],\r\n      [0x0018, 0x1014, \"??\", 'TimeOfSecondaryCapture'],\r\n      [0x0018, 0x1016, \"??\", 'SecondaryCaptureDeviceManufacturer'],\r\n      [0x0018, 0x1017, \"??\", 'HardcopyDeviceManufacturer'],\r\n      [0x0018, 0x1018, \"??\", 'SecondaryCaptureDeviceModelName'],\r\n      [0x0018, 0x1019, \"??\", 'SecondaryCaptureDeviceSoftwareVers'],\r\n      [0x0018, 0x101A, \"??\", 'HardcopyDeviceSoftwareVersion'],\r\n      [0x0018, 0x101B, \"??\", 'HardcopyDeviceModelName'],\r\n    \r\n      [0x0018, 0x1020, 'XX', 'SoftwareVersions'],\r\n      [0x0018, 0x1030, 'XX', 'ProtocolName'],\r\n      [0x0018, 0x1081, 'XX', '\"LowR-RValue'],\r\n      [0x0018, 0x1082, 'XX', '\"HiR-RValue'],\r\n      [0x0018, 0x1083, 'XX', '\"IntervalsAcquired'],\r\n      [0x0018, 0x1084, 'XX', '\"IntervalsRejected'],\r\n    \r\n      [0x0018, 0x1088, 'XX', 'HeartRate'],\r\n      [0x0018, 0x1090, 'XX', 'CardiacNumberOfImages'],\r\n      [0x0018, 0x1094, 'XX', 'TriggerWindow'],\r\n      [0x0018, 0x1100, 'XX', 'ReconstructionDiameter'],\r\n      [0x0018, 0x1110, 'XX', 'DistanceSourceToDetector'],\r\n      [0x0018, 0x1111, 'XX', 'DistanceSourceToPatient'],\r\n      [0x0018, 0x1115, 'XX', 'Unknown'],\r\n      [0x0018, 0x1120, 'XX', 'GantryDetectorTilt'],\r\n      [0x0018, 0x1130, 'XX', 'TableHeight'],\r\n      [0x0018, 0x1140, 'XX', 'RotationDirection'],\r\n      [0x0018, 0x1150, 'XX', 'ExposureTime'],\r\n      [0x0018, 0x1151, 'XX', 'XRayTubeCurrent'],\r\n      [0x0018, 0x1152, 'XX', 'Exposure'],\r\n      [0x0018, 0x115e, 'XX', '\"Unknown'],\r\n\r\n      [0x0018, 0x1160, 'XX', 'FilterType'],\r\n      [0x0018, 0x1164, 'XX', '\"unknown'],\r\n      [0x0018, 0x1166, 'XX', '\"unknown'],\r\n      [0x0018, 0x1168, 'XX', '\"unknown'],\r\n    \r\n      [0x0018, 0x1170, 'XX', 'GeneratorPower'],\r\n      [0x0018, 0x1180, 'XX', '\"Unknown'],\r\n      [0x0018, 0x1190, 'XX', 'FocalSpot'],\r\n      [0x0018, 0x1210, 'XX', 'ConvolutionKernel'],\r\n      [0x0018, 0x1250, 'XX', 'ReceiveCoilName'],\r\n      [0x0018, 0x1310, 'XX', 'AcquisionMatrix'],\r\n      [0x0018, 0x1312, 'XX', 'InPlanePhaseEncodingDirection'],\r\n      [0x0018, 0x1314, 'XX', 'FlipAngle'],\r\n      [0x0018, 0x1315, 'XX', 'VariableFlipAngleFlag'],\r\n      [0x0018, 0x1316, 'XX', 'SAR'],\r\n      [0x0018, 0x1400, 'XX', 'unknown'],\r\n\r\n      [0x0018, 0x1600, 'XX', '\"ShutterShape'],\r\n      [0x0018, 0x1602, 'XX', 'ShutterLeftVerticalEdge'],\r\n      [0x0018, 0x1604, 'XX', '\"ShutterRightVerticalEdge'],\r\n      [0x0018, 0x1606, 'XX', '\"ShutterUpperHorizontalEdge'],\r\n      [0x0018, 0x1608, 'XX', '\"ShutterLowerHorizontalEdge'],\r\n      [0x0018, 0x1610, 'XX', '\"CenterOfCircularShutter'],\r\n      [0x0018, 0x1612, 'XX', '\"RadiusOfCircularShutter'],\r\n      [0x0018, 0x1620, 'XX', '\"VerticesOfPolygonalShutter'],\r\n      [0x0018, 0x1622, 'XX', '\"ShutterPresentationValue'],\r\n      [0x0018, 0x1623, 'XX', '\"ShutterOverlayGroup'],\r\n      [0x0018, 0x1624, 'XX', '\"ShutterPresentationColorCIELabVal'],\r\n    \r\n      [0x0018, 0x1700, 'XX', 'Unknown'],\r\n      [0x0018, 0x1702, 'XX', 'Unknown'],\r\n      [0x0018, 0x1704, 'XX', 'Unknown'],\r\n      [0x0018, 0x1706, 'XX', 'Unknown'],\r\n      [0x0018, 0x1708, 'XX', 'Unknown'],\r\n\r\n      [0x0018, 0x4000, 'XX', '\"AcquisitionComments'],\r\n      [0x0018, 0x5000, 'XX', 'OutputPower'],\r\n      [0x0018, 0x5020, 'XX', 'Unknown'],\r\n      [0x0018, 0x5021, 'XX', '\"Unknown'],\r\n\r\n      [0x0018, 0x5100, 'XX', 'PatientPosition'],\r\n      [0x0018, 0x5101, 'XX', 'ViewPosition'],\r\n      [0x0018, 0x6000, 'XX', 'Unknown'],\r\n    \r\n      [0x0018, 0x9301, 'XX', 'CTAcquisitionTypeSequence'],\r\n      [0x0018, 0x9302, 'XX', 'AcquisitionType'],\r\n      [0x0018, 0x9303, 'XX', 'TubeAngle'],\r\n      [0x0018, 0x9304, 'XX', 'CTAcquisitionDetailsSequence'],\r\n      [0x0018, 0x9305, 'XX', 'RevolutionTime'],\r\n      [0x0018, 0x9306, 'XX', 'SingleCollimationWidth'],\r\n      [0x0018, 0x9307, 'XX', 'TotalCollimationWidth'],\r\n      [0x0018, 0x9308, 'XX', 'CTTableDynamicsSequence'],\r\n      [0x0018, 0x9309, 'XX', 'TableSpeed'],\r\n      [0x0018, 0x9310, 'XX', 'TableFeedPerRotation'],\r\n    \r\n      [0x0018, 0x9311, 'XX', 'SpiralPitchFactor'],\r\n      [0x0018, 0x9312, 'XX', 'CTGeometrySequence'],\r\n      [0x0018, 0x9313, 'XX', 'DataCollectionCenterPatient'],\r\n      [0x0018, 0x9314, 'XX', 'CTReconstructionSequence'],\r\n      [0x0018, 0x9315, 'XX', 'ReconstructionAlgorithm'],\r\n      [0x0018, 0x9316, 'XX', 'ConvolutionKernelGroup'],\r\n      [0x0018, 0x9317, 'XX', 'ReconstructionFieldOfView'],\r\n      [0x0018, 0x9318, 'XX', 'ReconstructionTargetCenterPatient'],\r\n      [0x0018, 0x9319, 'XX', 'ReconstructionAngle'],\r\n      [0x0018, 0x9320, 'XX', 'ImageFilter'],\r\n      [0x0018, 0x9321, 'XX', 'CTExposureSequenc'],\r\n      [0x0018, 0x9322, 'XX', 'ReconstructionPixelSpacing'],\r\n      [0x0018, 0x9323, 'XX', 'ExposureModulationType'],\r\n      [0x0018, 0x9324, 'XX', 'EstimatedDoseSaving'],\r\n      [0x0018, 0x9325, 'XX', 'CTXRayDetailsSequence'],\r\n      [0x0018, 0x9326, 'XX', 'CTPositionSequence'],\r\n      [0x0018, 0x9327, 'XX', 'TablePosition'],\r\n      [0x0018, 0x9328, 'XX', 'ExposureTimeInMilliSec'],\r\n      [0x0018, 0x9329, 'XX', 'CTImageFrameTypeSequence'],\r\n      [0x0018, 0x9330, 'XX', 'XRayTubeCurrentInMilliAmps'],\r\n    \r\n      [0x0019, 0x0010, 'LO', 'PrivateCreator'],\r\n      [0x0019, 0x1002, 'XX', 'NumberOfCellsInDetector'],\r\n      [0x0019, 0x1003, 'XX', 'CellsNumberAtTheta'],\r\n      [0x0019, 0x1004, 'XX', 'CellsSpacing'],\r\n      [0x0019, 0x100F, 'XX', 'HorizFrameOfRef'],\r\n      [0x0019, 0x1011, 'XX', 'SeriesContrast'],\r\n      [0x0019, 0x1012, 'XX', 'LastPSeq'],\r\n      [0x0019, 0x1013, 'XX', 'StartNumberOfBaseLine'],\r\n      [0x0019, 0x1014, 'XX', 'EndNumberOfBaseLine'],\r\n      [0x0019, 0x1015, 'XX', 'StartNumberForEnchancedScans'],\r\n      [0x0019, 0x1016, 'XX', 'EndNumberForEnchancedScans'],\r\n      [0x0019, 0x1017, 'XX', 'SeriesPlane'],\r\n      [0x0019, 0x1018, 'XX', 'FirstScanRas'],\r\n      [0x0019, 0x1019, 'XX', 'FirstScanLocation'],\r\n      [0x0019, 0x101A, 'XX', 'LastScanRas'],\r\n      [0x0019, 0x101B, 'XX', 'LastScanLoc'],\r\n      [0x0019, 0x101E, 'XX', 'DisplayFieldOfView'],\r\n      [0x0019, 0x1023, 'XX', 'TableSpeed'],\r\n      [0x0019, 0x1024, 'XX', 'MidScanTime'],\r\n      [0x0019, 0x1025, 'XX', 'MidScanFlag'],\r\n      [0x0019, 0x1026, 'XX', 'DegreesOfAzimuth'],\r\n      [0x0019, 0x1027, 'XX', 'GantryPeriod'],\r\n      [0x0019, 0x102A, 'XX', 'XRayOnPosition'],\r\n      [0x0019, 0x102B, 'XX', 'XRayOffPosition'],\r\n      [0x0019, 0x102C, 'XX', 'NumberOfTriggers'],\r\n      [0x0019, 0x102E, 'XX', 'AngleOfFirstView'],\r\n      [0x0019, 0x102F, 'XX', 'TriggerFrequency'],\r\n      [0x0019, 0x1039, 'XX', 'ScanFovType'],\r\n      [0x0019, 0x1040, 'XX', 'StatReconFlag'],\r\n      [0x0019, 0x1041, 'XX', 'ComputeType'],\r\n      [0x0019, 0x1042, 'XX', 'SegmentNumber'],\r\n      [0x0019, 0x1043, 'XX', 'TotalSegmentsRequested'],\r\n      [0x0019, 0x1044, 'XX', 'InterscanDelay'],\r\n      [0x0019, 0x1047, 'XX', 'ViewCompressionFactor'],\r\n      [0x0019, 0x104A, 'XX', 'TotalNoOfRefChannels'],\r\n      [0x0019, 0x104B, 'XX', 'DataSizeForScanData'],\r\n      [0x0019, 0x1052, 'XX', 'ReconPostProcflag'],\r\n      [0x0019, 0x1057, 'XX', 'CTWaterNumber'],\r\n      [0x0019, 0x1058, 'XX', 'CTBoneNumber'],\r\n      [0x0019, 0x105A, 'XX', 'AcquisitionDuration'],\r\n      [0x0019, 0x105E, 'XX', 'NumberOfChannels'],\r\n      [0x0019, 0x105F, 'XX', 'IncrementBetweenChannels'],\r\n      [0x0019, 0x1060, 'XX', 'StartingView'],\r\n      [0x0019, 0x1061, 'XX', 'NumberOfViews'],\r\n      [0x0019, 0x1062, 'XX', 'IncrementBetweenViews'],\r\n      [0x0019, 0x106A, 'XX', 'DependantOnNoViewsProcessed'],\r\n      [0x0019, 0x107D, 'DS', 'SecondEcho'],\r\n      [0x0019, 0x107E, 'SS', 'NumberOfEchoes'],\r\n      [0x0019, 0x107F, 'DS', 'TableDelta'],\r\n      [0x0019, 0x1081, 'SS', 'Contiguous'],\r\n      [0x0019, 0x1084, 'DS', 'PeakSAR'],\r\n      [0x0019, 0x1087, 'DS', 'CardiacRepetitionTime'],\r\n      [0x0019, 0x1088, 'SS', 'ImagesPerCardiacCycle'],\r\n      [0x0019, 0x108A, 'SS', 'ActualReceiveGainAnalog'],\r\n      [0x0019, 0x108B, 'SS', 'ActualReceiveGainDigital'],\r\n      [0x0019, 0x108D, 'DS', 'DelayAfterTrigger'],\r\n      [0x0019, 0x108F, 'SS', 'Swappf'],\r\n      [0x0019, 0x1090, 'SS', 'PauseInterval'],\r\n      [0x0019, 0x1091, 'DS', 'PulseTime'],\r\n      [0x0019, 0x1092, 'SL', 'SliceOffsetOnFreqAxis'],\r\n      [0x0019, 0x1093, 'DS', 'CenterFrequency'],\r\n      [0x0019, 0x1094, 'SS', 'TransmitGain'],\r\n      [0x0019, 0x1095, 'SS', 'AnalogReceiverGain'],\r\n      [0x0019, 0x1096, 'SS', 'DigitalReceiverGain'],\r\n      [0x0019, 0x1097, 'SL', 'BitmapDefiningCVs'],\r\n      [0x0019, 0x109B, 'SS', 'PulseSeqMode'],\r\n      [0x0019, 0x109C, 'LO', 'PulseSeqName'],\r\n      [0x0019, 0x109D, 'DT', 'PulseSeqDate'],\r\n      [0x0019, 0x109E, 'LO', 'InternalPulseSeqName'],\r\n      [0x0019, 0x109F, 'SS', 'TransmittingCoil'],\r\n      [0x0019, 0x10A0, 'SS', 'SurfaceCoilType'],\r\n      [0x0019, 0x10A1, 'SS', 'ExtremityCoilFlag'],\r\n      [0x0019, 0x10A2, 'SL', 'RawDataRunNumber'],\r\n      [0x0019, 0x10A3, 'UL', 'CalibratedFieldStrength'],\r\n      [0x0019, 0x10A4, 'SS', 'SATFatWaterBone'],\r\n      [0x0019, 0x10A7, 'DS', 'UserData01'],\r\n      [0x0019, 0x10A8, 'DS', 'UserData02'],\r\n      [0x0019, 0x10A9, 'DS', 'UserData03'],\r\n      [0x0019, 0x10AA, 'DS', 'UserData04'],\r\n      [0x0019, 0x10AB, 'DS', 'UserData05'],\r\n      [0x0019, 0x10AC, 'DS', 'UserData06'],\r\n      [0x0019, 0x10AD, 'DS', 'UserData07'],\r\n      [0x0019, 0x10AE, 'DS', 'UserData08'],\r\n      [0x0019, 0x10AF, 'DS', 'UserData09'],\r\n      [0x0019, 0x10B0, 'DS', 'UserData10'],\r\n      [0x0019, 0x10B1, 'DS', 'UserData11'],\r\n      [0x0019, 0x10B2, 'DS', 'UserData12'],\r\n      [0x0019, 0x10B3, 'DS', 'UserData13'],\r\n      [0x0019, 0x10B4, 'DS', 'UserData14'],\r\n      [0x0019, 0x10B5, 'DS', 'UserData15'],\r\n      [0x0019, 0x10B6, 'DS', 'UserData16'],\r\n      [0x0019, 0x10B7, 'DS', 'UserData17'],\r\n      [0x0019, 0x10B8, 'DS', 'UserData18'],\r\n      [0x0019, 0x10B9, 'DS', 'UserData19'],\r\n      [0x0019, 0x10BA, 'DS', 'UserData20'],\r\n      [0x0019, 0x10BB, 'DS', 'UserData21'],\r\n      [0x0019, 0x10BC, 'DS', 'UserData22'],\r\n      [0x0019, 0x10BD, 'DS', 'UserData23'],\r\n      [0x0019, 0x10BE, 'DS', 'ProjectionAngle'],\r\n      [0x0019, 0x10C0, 'SS', 'SaturationPlanes'],\r\n      [0x0019, 0x10C2, 'SS', 'SATLocationR'],\r\n      [0x0019, 0x10C3, 'SS', 'SATLocationL'],\r\n      [0x0019, 0x10C4, 'SS', 'SATLocationA'],\r\n      [0x0019, 0x10C5, 'SS', 'SATLocationP'],\r\n      [0x0019, 0x10C6, 'SS', 'SATLocationH'],\r\n      [0x0019, 0x10C7, 'SS', 'SATLocationF'],\r\n      [0x0019, 0x10C8, 'SS', 'SATThicknessR-L'],\r\n      [0x0019, 0x10C9, 'SS', 'SATThicknessA-P'],\r\n      [0x0019, 0x10CA, 'SS', 'SATThicknessH-F'],\r\n      [0x0019, 0x10CB, 'SS', 'PrescribedFlowAxis'],\r\n      [0x0019, 0x10CC, 'SS', 'VelocityEncoding'],\r\n      [0x0019, 0x10CD, 'SS', 'ThicknessDisclaimer'],\r\n      [0x0019, 0x10CE, 'SS', 'PrescanType'],\r\n      [0x0019, 0x10CF, 'SS', 'PrescanStatus'],\r\n      [0x0019, 0x10D2, 'SS', 'ProjectionAlgorithm'],\r\n      [0x0019, 0x10D3, 'SH', 'ProjectionAlgorithm'],\r\n      [0x0019, 0x10D5, 'SS', 'FractionalEcho'],\r\n      [0x0019, 0x10D7, 'SS', 'CardiacPhases'],\r\n      [0x0019, 0x10D8, 'SS', 'VariableEchoflag'],\r\n      [0x0019, 0x10D9, 'DS', 'ConcatenatedSAT'],\r\n      [0x0019, 0x10DF, 'DS', 'UserData'],\r\n      [0x0019, 0x10E0, 'DS', 'UserData'],\r\n      [0x0019, 0x10E2, 'DS', 'VelocityEncodeScale'],\r\n      [0x0019, 0x10F2, 'SS', 'FastPhases'],\r\n      [0x0019, 0x10F9, 'DS', 'TransmissionGain'],\r\n\r\n      [0x0020, 0x0000, 'UL', 'RelationshipGroupLength'],\r\n      [0x0020, 0x000D, 'UI', 'StudyInstanceID'],\r\n      [0x0020, 0x000E, 'UI', 'SeriesInstanceID'],\r\n      [0x0020, 0x0010, 'IS', 'StudyID'],\r\n      [0x0020, 0x0011, 'IS', 'SeriesNumber'],\r\n      [0x0020, 0x0012, 'IS', 'AcquisionNumber'],\r\n      [0x0020, 0x0013, 'IS', 'ImageNumber'],\r\n      [0x0020, 0x0020, 'IS', 'PatientOrientation'],\r\n      [0x0020, 0x0032, 'DS', 'ImagePosition'],\r\n      [0x0020, 0x0037, 'DS', 'ImageOrientation'],\r\n      [0x0020, 0x0040, 'XX', 'PositionReferenceIndicator'],\r\n      [0x0020, 0x0041, 'XX', 'SliceLocation'],\r\n      [0x0020, 0x0052, 'UI', 'FrameOfRefefernceID'],\r\n      [0x0020, 0x0060, 'XX', 'Laterality'],\r\n      [0x0020, 0x1002, 'XX', 'ImagesInAcquision'],\r\n      [0x0020, 0x1040, 'LO', 'PositionReferenceIndicator'],\r\n      [0x0020, 0x1041, 'DS', 'SliceLocation'],\r\n      [0x0020, 0x9056, 'XX', 'StackId'],\r\n      [0x0020, 0x9057, 'XX', 'InStackPositionNumber'],\r\n\r\n      [0x0021, 0x0010, 'LO', 'PrivateCreator'],\r\n      [0x0021, 0x1003, 'XX', 'SeriesFromWhichPrescribed'],\r\n      [0x0021, 0x1005, 'XX', 'GenesisVersionNow'],\r\n      [0x0021, 0x1007, 'XX', 'SeriesRecordChecksum'],\r\n      [0x0021, 0x1018, 'XX', 'GenesisVersionNow'],\r\n      [0x0021, 0x1019, 'XX', 'AcqreconRecordChecksum'],\r\n      [0x0021, 0x1020, 'XX', 'TableStartLocation'],\r\n      [0x0021, 0x1035, 'XX', 'SeriesFromWhichPrescribed'],\r\n      [0x0021, 0x1036, 'XX', 'ImageFromWhichPrescribed'],\r\n      [0x0021, 0x1037, 'XX', 'ScreenFormat'],\r\n      [0x0021, 0x104A, 'XX', 'AnatomicalReferenceForScout'],\r\n      [0x0021, 0x104F, 'XX', 'LocationsInAcquisition'],\r\n      [0x0021, 0x1050, 'XX', 'GraphicallyPrescribed'],\r\n      [0x0021, 0x1051, 'XX', 'RotationFromSourceXRot'],\r\n      [0x0021, 0x1052, 'XX', 'RotationFromSourceYRot'],\r\n      [0x0021, 0x1053, 'XX', 'RotationFromSourceZRot'],\r\n      [0x0021, 0x1054, 'XX', 'ImagePosition'],\r\n      [0x0021, 0x1055, 'XX', 'ImageOrientation'],\r\n      [0x0021, 0x1056, 'XX', 'IntegerSlop'],\r\n      [0x0021, 0x1057, 'XX', 'IntegerSlop'],\r\n      [0x0021, 0x1058, 'XX', 'IntegerSlop'],\r\n      [0x0021, 0x1059, 'XX', 'IntegerSlop'],\r\n      [0x0021, 0x105A, 'XX', 'IntegerSlop'],\r\n      [0x0021, 0x105B, 'XX', 'FloatSlop'],\r\n      [0x0021, 0x105C, 'XX', 'FloatSlop'],\r\n      [0x0021, 0x105D, 'XX', 'FloatSlop'],\r\n      [0x0021, 0x105E, 'XX', 'FloatSlop'],\r\n      [0x0021, 0x105F, 'XX', 'FloatSlop'],\r\n      [0x0021, 0x1081, 'XX', 'AutoWindowLevelAlpha'],\r\n      [0x0021, 0x1082, 'XX', 'AutoWindowLevelBeta'],\r\n      [0x0021, 0x1083, 'XX', 'AutoWindowLevelWindow'],\r\n      [0x0021, 0x1084, 'XX', 'ToWindowLevelLevel'],\r\n      [0x0021, 0x1090, 'XX', 'TubeFocalSpotPosition'],\r\n      [0x0021, 0x1091, 'XX', 'BiopsyPosition'],\r\n      [0x0021, 0x1092, 'XX', 'BiopsyTLocation'],\r\n      [0x0021, 0x1093, 'XX', 'BiopsyRefLocation'],\r\n\r\n      [0x0023, 0x0010, 'LO', 'PrivateCreator'],\r\n      [0x0023, 0x1001, 'XX', 'NumberOfSeriesInStudy'],\r\n      [0x0023, 0x1002, 'XX', 'NumberOfUnarchivedSeries'],\r\n      [0x0023, 0x1010, 'XX', 'ReferenceImageField'],\r\n      [0x0023, 0x1050, 'XX', 'SummaryImage'],\r\n      [0x0023, 0x1070, 'XX', 'StartTimeSecsInFirstAxial'],\r\n      [0x0023, 0x1074, 'SL', 'NoofUpdatesToHeader'],\r\n      [0x0023, 0x107d, 'SS', 'IndicatesIfTheStudyHasCompleteInfo'],\r\n      [0x0023, 0x1080, 'LO', 'CRFilmFormat'],\r\n\r\n      [0x0025, 0x0010, 'LO', 'PrivateCreator'],\r\n      [0x0025, 0x1006, 'SS', 'LastPulseSequenceUsed'],\r\n      [0x0025, 0x1007, 'SL', 'ImagesInSeries'],\r\n      [0x0025, 0x1010, 'SL', 'LandmarkCounter'],\r\n      [0x0025, 0x1011, 'SS', 'NumberOfAcquisitions'],\r\n      [0x0025, 0x1014, 'SL', 'IndicatesNoofUpdatesToHeader'],\r\n      [0x0025, 0x1017, 'SL', 'SeriesCompleteFlag'],\r\n      [0x0025, 0x1018, 'SL', 'NumberOfImagesArchived'],\r\n      [0x0025, 0x1019, 'SL', 'LastImageNumberUsed'],\r\n      [0x0025, 0x101A, 'SH', 'PrimaryReceiverSuiteAndHost'],\r\n      [0x0025, 0x101B, 'OB', 'ProtocolDataBlock'],\r\n\r\n      [0x0027, 0x0010, 'LO', 'PrivateCreator'],\r\n      [0x0027, 0x1006, 'XX', 'ImageArchiveFlag'],\r\n      [0x0027, 0x1010, 'XX', 'ScoutType'],\r\n      [0x0027, 0x101C, 'XX', 'VmaMamp'],\r\n      [0x0027, 0x101D, 'XX', 'VmaPhase'],\r\n      [0x0027, 0x101E, 'XX', 'VmaMod'],\r\n      [0x0027, 0x101F, 'XX', 'VmaClip'],\r\n      [0x0027, 0x1020, 'XX', 'SmartScanOnOffFlag'],\r\n      [0x0027, 0x1030, 'XX', 'ForeignImageRevision'],\r\n      [0x0027, 0x1031, 'XX', 'ImagingMode'],\r\n      [0x0027, 0x1032, 'XX', 'PulseSequence'],\r\n      [0x0027, 0x1033, 'XX', 'ImagingOptions'],\r\n      [0x0027, 0x1035, 'XX', 'PlaneType'],\r\n      [0x0027, 0x1036, 'XX', 'ObliquePlane'],\r\n      [0x0027, 0x1040, 'XX', 'RASLetterOfImageLocation'],\r\n      [0x0027, 0x1041, 'XX', 'ImageLocation'],\r\n      [0x0027, 0x1042, 'XX', 'CenterRCoordOfPlaneImage'],\r\n      [0x0027, 0x1043, 'XX', 'CenterACoordOfPlaneImage'],\r\n      [0x0027, 0x1044, 'XX', 'CenterSCoordOfPlaneImage'],\r\n      [0x0027, 0x1045, 'XX', 'NormalRCoord'],\r\n      [0x0027, 0x1046, 'XX', 'NormalACoord'],\r\n      [0x0027, 0x1047, 'XX', 'NormalSCoord'],\r\n      [0x0027, 0x1048, 'XX', 'RCoordOfTopRightCorner'],\r\n      [0x0027, 0x1049, 'XX', 'ACoordOfTopRightCorner'],\r\n      [0x0027, 0x104A, 'XX', 'SCoordOfTopRightCorner'],\r\n      [0x0027, 0x104B, 'XX', 'RCoordOfBottomRightCorner'],\r\n      [0x0027, 0x104C, 'XX', 'ACoordOfBottomRightCorner'],\r\n      [0x0027, 0x104D, 'XX', 'SCoordOfBottomRightCorner'],\r\n      [0x0027, 0x1050, 'XX', 'TableStartLocation'],\r\n      [0x0027, 0x1051, 'XX', 'TableEndLocation'],\r\n      [0x0027, 0x1060, 'FL', 'ImageDimensionX'],\r\n      [0x0027, 0x1061, 'FL', 'ImageDimensionY'],\r\n      [0x0027, 0x1062, 'FL', 'NumberOfExcitations'],\r\n\r\n      [0x0028, 0x0000, 'UL', 'ImagePresentationGroupLength'],\r\n      [0x0028, 0x0002, 'US', 'SamplesPerPixel'],\r\n      [0x0028, 0x0004, 'CS', 'PhotometricInterpretation'],\r\n      [0x0028, 0x0006, 'US', 'Planar​Configuration'],\r\n      [0x0028, 0x0008, 'XX', 'NumberOfFrames'],\r\n      [0x0028, 0x0010, 'US', 'Rows'],\r\n      [0x0028, 0x0011, 'US', 'Columns'],\r\n      [0x0028, 0x0030, 'DS', 'PixelSpacing'],\r\n      [0x0028, 0x0100, 'US', 'BitsAllocated'],\r\n      [0x0028, 0x0101, 'US', 'BitsStored'],\r\n      [0x0028, 0x0102, 'US', 'HighBit'],\r\n      [0x0028, 0x0103, 'US', 'PixelRepresentation'],\r\n      [0x0028, 0x0106, 'XX', 'SmallestImagePixelValue'],\r\n      [0x0028, 0x0107, 'XX', 'LargestImagePixelValue'],\r\n      [0x0028, 0x0120, 'US', 'PixelAddingValue'],\r\n      [0x0028, 0x0301, 'CS', 'BurnderInAnnotation'],\r\n      [0x0028, 0x0303, 'CS', 'Longitudinal​Temporal​Information​Modified'],\r\n      [0x0028, 0x1050, 'DS', 'WindowCenter'],\r\n      [0x0028, 0x1051, 'DS', 'WindowWidth'],\r\n      [0x0028, 0x1052, 'DS', 'RescaleIntercept'],\r\n      [0x0028, 0x1053, 'DS', 'RescaleSlope'],\r\n      [0x0028, 0x1054, 'LO', 'RescaleType'],\r\n      [0x0028, 0x1055, 'LO', 'Window​Center​Width​Explanation'],\r\n\r\n      [0x0029, 0x0010, 'LO', 'PrivateCreator'],\r\n      [0x0029, 0x1015, 'SL', 'LowerRangeOfPixels1h'],\r\n      [0x0029, 0x1016, 'SL', 'LowerRangeOfPixels1i'],\r\n      [0x0029, 0x1017, 'SL', 'LowerRangeOfPixels2'],\r\n      [0x0029, 0x1018, 'SL', 'UpperRangeOfPixels2'],\r\n      [0x0029, 0x1026, 'SS', 'VersionOfTheHdrStruct'],\r\n      [0x0029, 0x1031, 'LO', 'PrivateTag'],\r\n      [0x0029, 0x1032, 'UL', 'PrivateTag'],\r\n      [0x0029, 0x1033, 'UL', 'PrivateTag'],\r\n      [0x0029, 0x1034, 'SL', 'AdvantageCompOverflow'],\r\n      [0x0029, 0x1035, 'SL', 'AdvantageCompUnderflow'],\r\n\r\n      [0x0032, 0x0000, 'UL', 'StudyGroupLength'],\r\n      [0x0032, 0x000c, 'XX', 'StrudyPriorityId'],\r\n      [0x0032, 0x1020, 'XX', 'ScheduledStudyLocation'],\r\n      [0x0032, 0x1030, 'XX', 'ReasonForStudy'],\r\n      [0x0032, 0x1060, 'XX', 'RequestedProcedureDescription'],\r\n\r\n      [0x0038, 0x0010, 'XX', 'AdmissionId'],\r\n      [0x0038, 0x0050, 'XX', 'SpecialNeeds'],\r\n      [0x0038, 0x0500, 'XX', 'PatientState'],\r\n    \r\n      [0x0040, 0x0000, 'UL', 'TextGroupLength'],\r\n      [0x0040, 0x0242, 'XX', 'PerformedStationName'],\r\n      [0x0040, 0x0243, 'XX', 'PerformedLocation'],\r\n      [0x0040, 0x0244, 'XX', 'PerformedProcedureStepStartDate'],\r\n      [0x0040, 0x0245, 'XX', 'PerformedProcedureStepStartTime'],\r\n      [0x0040, 0x0253, 'XX', 'PerformedProcedureStepId'],\r\n      [0x0040, 0x0254, 'XX', 'PerformedProcedureStepDescription'],\r\n      [0x0040, 0x0255, 'LO', 'PerformedProcedureTypeDescription'],\r\n      [0x0040, 0x0280, 'XX', '\"CommentsOnPerformedProcedureStep'],\r\n      [0x0040, 0x0321, 'XX', 'FilmConsumptionSequence'],\r\n    \r\n      [0x0040, 0x1001, 'XX', 'RequestedProcedureId'],\r\n      [0x0040, 0x1002, 'XX', 'Unknown'],\r\n      [0x0040, 0x1003, 'XX', 'Unknown'],\r\n      [0x0040, 0x1004, 'XX', 'PatientTransportArrangments'],\r\n      [0x0040, 0x1005, 'XX', 'RequestedProcedureLocation'],\r\n      [0x0040, 0x1010, 'XX', 'NamesOfIntendentRecipientsOfResults'],\r\n      [0x0040, 0x1400, 'XX', 'RequestedProcedureComments'],\r\n\r\n      [0x0040, 0x2400, 'XX', 'ImagingServiceRequestComments'],\r\n      [0x0040, 0x3001, 'XX', 'Unknown'],\r\n    \r\n      [0x0043, 0x0010, 'LO', 'PrivateCreator'],\r\n      [0x0043, 0x1001, 'XX', 'BitmapOfPrescanOptions'],\r\n      [0x0043, 0x1002, 'XX', 'GradientOffsetInX'],\r\n      [0x0043, 0x1003, 'XX', 'GradientOffsetInY'],\r\n      [0x0043, 0x1004, 'XX', 'GradientOffsetInZ'],\r\n      [0x0043, 0x1005, 'XX', 'ImgIsOriginalOrUnoriginal'],\r\n      [0x0043, 0x1006, 'XX', 'NumberOfEPIShots'],\r\n      [0x0043, 0x1007, 'XX', 'ViewsPerSegment'],\r\n      [0x0043, 0x1008, 'XX', 'RespiratoryRateBpm'],\r\n      [0x0043, 0x1009, 'XX', 'RespiratoryTriggerPoint'],\r\n      [0x0043, 0x100A, 'XX', 'TypeOfReceiverUsed'],\r\n      [0x0043, 0x100B, 'XX', 'PeakRateOfChangeOfGradientField'],\r\n      [0x0043, 0x100C, 'XX', 'LimitsInUnitsOfPercent'],\r\n      [0x0043, 0x100D, 'XX', 'PSDEstimatedLimit'],\r\n      [0x0043, 0x100E, 'XX', 'PSDEstimatedLimitInTeslaPerSecond'],\r\n      [0x0043, 0x100F, 'XX', 'Saravghead'],\r\n      [0x0043, 0x1010, 'XX', 'WindowValue'],\r\n      [0x0043, 0x1011, 'XX', 'TotalInputViews'],\r\n      [0x0043, 0x1012, 'XX', 'XRayChain'],\r\n      [0x0043, 0x1013, 'XX', 'DeconKernelParameters'],\r\n      [0x0043, 0x1014, 'XX', 'CalibrationParameters'],\r\n      [0x0043, 0x1015, 'XX', 'TotalOutputViews'],\r\n      [0x0043, 0x1016, 'XX', 'NumberOfOverranges'],\r\n      [0x0043, 0x1017, 'XX', 'IBHImageScaleFactors'],\r\n      [0x0043, 0x1018, 'XX', 'BBHCoefficients'],\r\n      [0x0043, 0x1019, 'XX', 'NumberOfBBHChainsToBlend'],\r\n      [0x0043, 0x101A, 'XX', 'StartingChannelNumber'],\r\n      [0x0043, 0x101B, 'XX', 'PpscanParameters'],\r\n      [0x0043, 0x101C, 'XX', 'GEImageIntegrity'],\r\n      [0x0043, 0x101D, 'XX', 'LevelValue'],\r\n      [0x0043, 0x101E, 'XX', 'DeltaStartTime'],\r\n      [0x0043, 0x101F, 'XX', 'MaxOverrangesInAView'],\r\n      [0x0043, 0x1020, 'XX', 'AvgOverrangesAllViews'],\r\n      [0x0043, 0x1021, 'XX', 'CorrectedAfterGlowTerms'],\r\n      [0x0043, 0x1025, 'XX', 'ReferenceChannels'],\r\n      [0x0043, 0x1026, 'XX', 'NoViewsRefChansBlocked'],\r\n      [0x0043, 0x1027, 'XX', 'ScanPitchRatio'],\r\n      [0x0043, 0x1028, 'XX', 'UniqueImageIden'],\r\n      [0x0043, 0x1029, 'XX', 'HistogramTables'],\r\n      [0x0043, 0x102A, 'XX', 'UserDefinedData'],\r\n      [0x0043, 0x102B, 'XX', 'PrivateScanOptions'],\r\n      [0x0043, 0x102C, 'XX', 'EffectiveEchoSpacing'],\r\n      [0x0043, 0x102D, 'XX', 'StringSlopField1'],\r\n      [0x0043, 0x102E, 'XX', 'StringSlopField2'],\r\n      [0x0043, 0x102F, 'XX', 'RawDataType'],\r\n      [0x0043, 0x1030, 'XX', 'RawDataType'],\r\n      [0x0043, 0x1031, 'XX', 'RACordOfTargetReconCenter'],\r\n      [0x0043, 0x1032, 'XX', 'RawDataType'],\r\n      [0x0043, 0x1033, 'XX', 'NegScanspacing'],\r\n      [0x0043, 0x1034, 'XX', 'OffsetFrequency'],\r\n      [0x0043, 0x1035, 'XX', 'UserUsageTag'],\r\n      [0x0043, 0x1036, 'XX', 'UserFillMapMSW'],\r\n      [0x0043, 0x1037, 'XX', 'UserFillMapLSW'],\r\n      [0x0043, 0x1038, 'XX', 'User25_48'],\r\n      [0x0043, 0x1039, 'XX', 'SlopInt6_9'],\r\n      [0x0043, 0x1040, 'XX', 'TriggerOnPosition'],\r\n      [0x0043, 0x1041, 'XX', 'DegreeOfRotation'],\r\n      [0x0043, 0x1042, 'XX', 'DASTriggerSource'],\r\n      [0x0043, 0x1043, 'XX', 'DASFpaGain'],\r\n      [0x0043, 0x1044, 'XX', 'DASOutputSource'],\r\n      [0x0043, 0x1045, 'XX', 'DASAdInput'],\r\n      [0x0043, 0x1046, 'XX', 'DASCalMode'],\r\n      [0x0043, 0x1047, 'XX', 'DASCalFrequency'],\r\n      [0x0043, 0x1048, 'XX', 'DASRegXm'],\r\n      [0x0043, 0x1049, 'XX', 'DASAutoZero'],\r\n      [0x0043, 0x104A, 'XX', 'StartingChannelOfView'],\r\n      [0x0043, 0x104B, 'XX', 'DASXmPattern'],\r\n      [0x0043, 0x104C, 'XX', 'TGGCTriggerMode'],\r\n      [0x0043, 0x104D, 'XX', 'StartScanToXrayOnDelay'],\r\n      [0x0043, 0x104E, 'XX', 'DurationOfXrayOn'],\r\n      [0x0043, 0x1060, 'XX', 'SlopInt10_17'],\r\n      [0x0043, 0x1061, 'XX', 'ScannerStudyEntityUID'],\r\n      [0x0043, 0x1062, 'XX', 'ScannerStudyID'],\r\n      [0x0043, 0x106F, 'XX', 'ScannerTableEntry'],\r\n      [0x0043, 0x107D, 'US', 'ReconModeFlagWord '],\r\n      [0x0043, 0x1080, 'LO', 'CoilIDData'],\r\n      [0x0043, 0x1081, 'LO', 'GECoilName'],\r\n      [0x0043, 0x1082, 'LO', 'SystemConfigurationInformation'],\r\n      [0x0043, 0x1083, 'DS', 'AssetRFactors'],\r\n      [0x0043, 0x1084, 'LO', 'AdditionalAssetData'],\r\n      [0x0043, 0x1089, 'LO', 'GoverningBodyAndSARDefinition'],\r\n      [0x0043, 0x108A, 'CS', 'PrivateInPlanePhaseEncodingDirection'],\r\n      [0x0043, 0x1090, 'LO', 'SARDefinition'],\r\n      [0x0043, 0x1091, 'DS', 'SARValue'],\r\n      [0x0043, 0x1095, 'LO', 'PrescanReuseString'],\r\n      [0x0043, 0x1096, 'CS', 'ContentQualification'],\r\n      [0x0043, 0x1097, 'LO', 'ImageFilteringParameters'],\r\n      [0x0043, 0x109A, 'IS', 'RxStackIdentification'],\r\n      [0x0043, 0x10AA, 'LO', 'AdditionalFilteringParameters'],\r\n      [0x0043, 0x10B1, 'SS', 'ExcitationMode'],\r\n\r\n      [0x0045, 0x0010, 'LO', 'PrivateCreator'],\r\n      [0x0045, 0x1001, 'XX', 'NumberOfMacroRowsInDetector'],\r\n      [0x0045, 0x1002, 'XX', 'MacroWidthAtISOCenter'],\r\n      [0x0045, 0x1003, 'XX', 'DASType'],\r\n      [0x0045, 0x1004, 'XX', 'DASGain'],\r\n      [0x0045, 0x1006, 'XX', 'TableDirectionInOrOut'],\r\n      [0x0045, 0x1007, 'XX', 'ZSmoothingFactor'],\r\n      [0x0045, 0x1008, 'XX', 'ViewWeightingMode'],\r\n      [0x0045, 0x1009, 'XX', 'SigmaRowNumberWhichRowsWereUsed'],\r\n      [0x0045, 0x100A, 'XX', 'MinimumDasValueFoundInTheScanData'],\r\n      [0x0045, 0x100B, 'XX', 'MaximumOffsetShiftValueUsed'],\r\n      [0x0045, 0x100C, 'XX', 'NumberOfViewsShifted'],\r\n      [0x0045, 0x100D, 'XX', 'ZTrackingFlag'],\r\n      [0x0045, 0x100E, 'XX', 'MeanZError'],\r\n      [0x0045, 0x100F, 'XX', 'ZTrackingMaximumError'],\r\n      [0x0045, 0x1010, 'XX', 'StartingViewForRow2a'],\r\n      [0x0045, 0x1011, 'XX', 'NumberOfViewsInRow2a'],\r\n      [0x0045, 0x1012, 'XX', 'StartingViewForRow1a'],\r\n      [0x0045, 0x1013, 'XX', 'SigmaMode'],\r\n      [0x0045, 0x1014, 'XX', 'NumberOfViewsInRow1a'],\r\n      [0x0045, 0x1015, 'XX', 'StartingViewForRow2b'],\r\n      [0x0045, 0x1016, 'XX', 'NumberOfViewsInRow2b'],\r\n      [0x0045, 0x1017, 'XX', 'StartingViewForRow1b'],\r\n      [0x0045, 0x1018, 'XX', 'NumberOfViewsInRow1b'],\r\n      [0x0045, 0x1021, 'XX', 'PrivateTag'],\r\n      [0x0045, 0x1022, 'XX', 'PrivateTag'],\r\n      [0x0045, 0x1032, 'XX', 'PrivateTag'],\r\n\r\n\r\n      [0x0053, 0x0010, 'LO', 'PrivateCreator'],\r\n      [0x0053, 0x1020, 'XX', 'PrivateTag'],\r\n      [0x0053, 0x1040, 'XX', 'PrivateTag'],\r\n      [0x0053, 0x1041, 'XX', 'PrivateTag'],\r\n      [0x0053, 0x1042, 'XX', 'PrivateTag'],\r\n      [0x0053, 0x1043, 'XX', 'PrivateTag'],\r\n      [0x0053, 0x1062, 'XX', 'PrivateTag'],\r\n\r\n      [0x0088, 0x0140, 'XX', 'StorageMediaFileSetUid'],\r\n      [0x0088, 0x0200, 'XX', 'IconImageSequence'],\r\n\r\n      [0x2001, 0x1003, 'XX', 'Unknown'],\r\n      [0x2001, 0x100a, 'XX', 'Unknown'],\r\n      [0x2001, 0x106e, 'XX', 'Unknown'],\r\n      [0x2005, 0x0012, 'XX', 'Unknown'],\r\n      [0x2005, 0x0013, 'XX', 'Unknown'],\r\n      [0x2005, 0x0014, 'XX', 'Unknown'],\r\n      [0x2005, 0x1213, 'XX', 'Unknown'],\r\n      [0x2005, 0x1406, 'XX', 'Unknown'],\r\n\r\n      [0x5533, 0x1203, 'XX', '\"Unknown'],\r\n      [0x5533, 0x5511, 'XX', '\"Unknown'],\r\n\r\n      [0x7fe0, 0x0000, 'IM', 'PixelDataGroupLength'],\r\n      [0x7fe0, 0x0010, 'IM', 'PixelData'],\r\n      /* eslint-enable */\r\n    ];\r\n  } // constructor\r\n\r\n  /**\r\n  * Get vr string code from group + element codes\r\n  * @param {number} group - group of the tag\r\n  * @param {number} element - element of the tag\r\n  * return {string} vr\r\n  */\r\n  getVr(group, element) {\r\n    let vr = '';\r\n    const numTags = this.TAGS.length;\r\n    for (let i = 0; i < numTags; i++) {\r\n      if ((this.TAGS[i][0] === group) && (this.TAGS[i][1] === element)) {\r\n        vr = this.TAGS[i][2];\r\n      }\r\n    } // for (i) all\r\n    if (element === 0) {\r\n      vr = 'UL';\r\n    }\r\n    return vr;\r\n  } // get VR\r\n\r\n  /**\r\n  * Get descripotion string  from group + element codes\r\n  * @param {number} group - group of the tag\r\n  * @param {number} element - element of the tag\r\n  * return {string} description\r\n  */\r\n  getTextDesc(group, element) {\r\n    let tagDesc = '?';\r\n    const numTags = this.TAGS.length;\r\n    for (let i = 0; i < numTags; i++) {\r\n      if ((this.TAGS[i][0] === group) && (this.TAGS[i][1] === element)) {\r\n        tagDesc = this.TAGS[i][3];\r\n      }\r\n    } // for (i) all\r\n    return tagDesc;\r\n  } // get tag text description\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Dicom info\r\n* @module lib/scripts/loaders/dicominfo\r\n*/\r\n\r\n/**\r\n* Class @class DicomInfo for volume some important text data render\r\n*/\r\nclass DicomInfo {\r\n  constructor() {\r\n    this.m_patientName = '';\r\n    this.m_patientDateOfBirth = '';\r\n    this.m_studyDescr = '';\r\n    this.m_studyDate = '';\r\n    this.m_seriesTime = '';\r\n    this.m_seriesDescr = '';\r\n    this.m_bodyPartExamined = '';\r\n    this.m_institutionName = '';\r\n    this.m_operatorsName = '';\r\n    this.m_physicansName = '';\r\n\r\n    this.m_patientId = '';\r\n    this.m_patientGender = '';\r\n    this.m_acquisionTime = '';\r\n    this.m_manufacturerName = '';\r\n    // tags info for each slice. Each entry is DicomSliceInfo\r\n    this.m_sliceInfo = [];\r\n  }\r\n}\r\n\r\nexport default DicomInfo;\r\n","\r\n\r\n// *****************************************************************\r\n// Const \r\n// *****************************************************************\r\n\r\nconst TAG_TRANSFER_SYNTAX = [0x0002, 0x0010];\r\nconst TAG_META_LENGTH = [0x0002, 0x0000];\r\nconst TAG_PIXEL_DATA = [0x7FE0, 0x0010];\r\n\r\n/**\r\n* class DicomTag is used for parse tags inside dicom file structure\r\n*/\r\nclass DicomTag {\r\n  /**\r\n   * @param {number} group - group in pair group:element\r\n   * @param {number} element - element in pair group:element\r\n   * @param {string} vr - special string for tag\r\n   * @param {object} value - tag value: data array\r\n   * @param {number} offsetStart - start of tag\r\n   * @param {number} offsetValue - offset value\r\n   * @param {number} offsetEnd - offset in stream\r\n   * @param {number} littleEndian - is in little endian mode numbers encoding\r\n   */\r\n  constructor(group,\r\n    element,\r\n    vr,\r\n    value,\r\n    offsetStart,\r\n    offsetValue,\r\n    offsetEnd,\r\n    littleEndian) {\r\n    /** @property {number} m_group - group for group:element pair */\r\n    this.m_group = group;\r\n    /** @property {number} m_element - element for group:element pair */\r\n    this.m_element = element;\r\n    /** @property {string} m_vr - special VR text for tag */\r\n    this.m_vr = vr;\r\n    /** @property {object} m_value - array with content */\r\n    this.m_value = value;\r\n    /** @property {number} m_offsetStart - start of tag */\r\n    this.m_offsetStart = offsetStart;\r\n    /** @property {number} m_offsetValue - value of tag */\r\n    this.m_offsetValue = offsetValue;\r\n    /** @property {number} m_offsetEnd - end of tag */\r\n    this.m_offsetEnd = offsetEnd;\r\n    /** @property {number} m_littleEndian - is in big/little endian */\r\n    this.m_littleEndian = littleEndian;\r\n  }\r\n\r\n  /**\r\n  * get value\r\n  * @return {object} data content of this tag\r\n  */\r\n  value() {\r\n    return this.m_value;\r\n  }\r\n\r\n  /**\r\n  * check has transform syntax or not\r\n  * @return {boolean} is transform\r\n  */\r\n  isTransformSyntax() {\r\n    if ((this.m_group === TAG_TRANSFER_SYNTAX[0]) && (this.m_element === TAG_TRANSFER_SYNTAX[1])) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n  * check is this tag meta\r\n  * @return {boolean} true, if this tag is meta tag\r\n  */\r\n  isMetaLength() {\r\n    if ((this.m_group === TAG_META_LENGTH[0]) && (this.m_element === TAG_META_LENGTH[1])) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n  * check has image bits in this tag data\r\n  * @return {boolean} true, if image bits is inside tag data\r\n  */\r\n  isPixelData() {\r\n    if ((this.m_group === TAG_PIXEL_DATA[0]) && (this.m_element === TAG_PIXEL_DATA[1])) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n}\r\nexport default DicomTag;\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n/**\r\n* Get string hash\r\n* @module demo/engine/utils/hash\r\n*/\r\n// absolute imports\r\n/**\r\n* Class Hash to calc string hash\r\n* @class Hash\r\n*/\r\nclass Hash {\r\n\r\n  static getHash(strInp) {\r\n    const ROT = 27;\r\n    const len = strInp.length;\r\n    let hash = len * 53;\r\n    for (let i = 0; i < len; i++) {\r\n      const val = strInp.charCodeAt(i);\r\n      hash = hash * (val ^ 137211941);\r\n      // bit rotate\r\n      hash = (hash << ROT) | (hash >> (32 - ROT));\r\n      // mask\r\n      hash &= 0x3fffffff;\r\n    }\r\n    return hash;\r\n  }\r\n}\r\n\r\nexport default Hash;\r\n","\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport Hash from '../utils/Hash';\r\n\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n* Class DicomSlice Single slice with info, used to detect series\r\n*/\r\n\r\nclass DicomSlice {\r\n  constructor() {\r\n    this.m_image = null;\r\n    this.m_sliceNumber = 0;\r\n    this.m_sliceLocation = 0.0;\r\n    // 10, 10\r\n    this.m_patientName = '';\r\n    // 8, 1030\r\n    this.m_studyDescr = '';\r\n    // 8, 20\r\n    this.m_studyDate = '';\r\n    // 8, 31\r\n    this.m_seriesTime = '';\r\n    // 8, 103E\r\n    this.m_seriesDescr = '';\r\n    // 18, 15\r\n    this.m_bodyPartExamined = '';\r\n    //\r\n    this.m_hash = 0;\r\n    this.m_xDim = 0;\r\n    this.m_yDim = 0;\r\n  }\r\n\r\n  buildHash() {\r\n    const strMix = this.m_patientName + this.m_studyDescr +\r\n    this.m_studyDate + this.m_seriesTime + \r\n    this.m_seriesDescr + this.m_bodyPartExamined;\r\n    this.m_hash = Hash.getHash(strMix);\r\n  } // end build hash\r\n} // end class DicomSlice\r\n\r\nexport default DicomSlice;\r\n","//\r\n//\r\n//\r\n\r\nimport DicomSlice from \"./dicomslice\";\r\n\r\nconst FLOAT_TOO_LARGE_VALUE = 555555555555.5;\r\n\r\n\r\nclass DicomSerie {\r\n  constructor(hash) {\r\n    console.assert(hash !== undefined);\r\n    console.assert(typeof hash === \"number\", \"hash shold be number\");\r\n\r\n    this.m_hash = hash;\r\n    this.m_slices = [];\r\n    this.m_minSlice = +FLOAT_TOO_LARGE_VALUE;\r\n    this.m_maxSlice = -FLOAT_TOO_LARGE_VALUE;\r\n  }\r\n\r\n  addSlice(slice) {\r\n    console.assert(slice !== undefined);\r\n    console.assert(slice instanceof DicomSlice, \"added slice should be DicomSlice object\");\r\n    this.m_slices.push(slice);\r\n    this.m_minSlice = (slice.m_sliceNumber < this.m_minSlice) ? slice.m_sliceNumber : this.m_minSlice;\r\n    this.m_maxSlice = (slice.m_sliceNumber > this.m_maxSlice) ? slice.m_sliceNumber : this.m_maxSlice;\r\n  }\r\n\r\n} // end DicomSerie\r\n\r\nexport default DicomSerie;\r\n","// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport DicomSlice from './dicomslice';\r\nimport DicomSerie from './dicomserie';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n* Class DicomSlicesVolume Collected volume (from slices)\r\n*/\r\nclass DicomSlicesVolume {\r\n  constructor() {\r\n    //\r\n    // series[i]:\r\n    //  m_minSlice\r\n    //  m_maxSlice\r\n    //  m_slices[]\r\n    //\r\n    this.m_series = [];\r\n  }\r\n\r\n  destroy() {\r\n    this.m_series = [];\r\n  }\r\n\r\n  getSeries() {\r\n    return this.m_series;\r\n  }\r\n\r\n  //\r\n  // slice: DicomSlice\r\n  addSlice(slice) {\r\n    console.assert(slice !== undefined);\r\n    console.assert(slice instanceof DicomSlice, \"should be DicomSlice object\");\r\n    console.assert(slice.m_hash !== undefined);\r\n    console.assert(slice.m_hash !== 0);\r\n    let indSerie = this.getSerieIndex(slice);\r\n    if (indSerie < 0) {\r\n      // create new serie\r\n      const serieNew = new DicomSerie(slice.m_hash);\r\n      this.m_series.push(serieNew);\r\n      indSerie = this.m_series.length - 1;\r\n    }\r\n    // add slice to serie\r\n    const ser = this.m_series[indSerie];\r\n    ser.addSlice(slice);\r\n  } // end add slice\r\n\r\n  getSerieIndex(slice) {\r\n    const numSeries = this.m_series.length;\r\n    for (let i = 0; i < numSeries; i++) {\r\n      const serie = this.m_series[i];\r\n      if (serie.m_hash === slice.m_hash) {\r\n        return i;\r\n      }\r\n    } // end for\r\n    return -1;\r\n  } // end get serie index\r\n\r\n} // end class DicomSlicesVolume\r\n\r\nexport default DicomSlicesVolume;\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Dicom slice info\r\n* @module lib/scripts/loaders/dicomsliceinfo\r\n*/\r\n\r\n/**\r\n* Class @class DicomSliceInfo slice information\r\n*/\r\nclass DicomSliceInfo {\r\n  constructor() {\r\n    this.m_sliceName = '';\r\n    this.m_fileName = '';\r\n    // tags info for each slice. Each entry is DicomTagInfo\r\n    this.m_tags = [];\r\n  }\r\n}\r\n\r\nexport default DicomSliceInfo;\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Dicom tag info\r\n* @module lib/scripts/loaders/dicomtaginfo\r\n*/\r\n\r\n/**\r\n* Class @class DicomTagInfo tag descr\r\n*/\r\nclass DicomTagInfo {\r\n  constructor() {\r\n    this.m_tag = '';\r\n    this.m_attrName = '';\r\n    this.m_attrValue = '';\r\n  }\r\n}\r\n\r\nexport default DicomTagInfo;\r\n","\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass FileTools {\r\n  isValidUrl(strUrl) {\r\n    const regA = /^((ftp|http|https):\\/\\/)?(([\\S]+)\\.)?([\\S]+)\\.([A-z]{2,})(:\\d{1,6})?\\/[\\S]+/;\r\n    const regB = /(ftp|http|https):\\/\\/([\\d]+)\\.([\\d]+)\\.([\\d]+)\\.([\\d]+)(:([\\d]+))?\\/([\\S]+)/;\r\n    const isValidA = strUrl.match(regA);\r\n    const isValidB = strUrl.match(regB);\r\n    if ((isValidA === null) && (isValidB === null)) {\r\n      return false;\r\n    }\r\n    return true;\r\n  } // end isValidUrl\r\n\r\n  getFileNameFromUrl(strUrl) {\r\n    let idx = strUrl.lastIndexOf('/');\r\n    if (idx < 0) {\r\n      idx = strUrl.lastIndexOf('\\\\');\r\n    }\r\n    if (idx < 0) {\r\n      console.log('getFileNameFromUrl: wrong URL!');\r\n      return '';\r\n    }\r\n    let strFileName = strUrl.substring(idx + 1);\r\n    const MAX_LEN = 40;\r\n    strFileName = (strFileName.length <= MAX_LEN) ? strFileName : strFileName.substring(0, MAX_LEN);\r\n    return strFileName;\r\n  }\r\n\r\n  getFolderNameFromUrl(strUrl) {\r\n    let idx = strUrl.lastIndexOf('/');\r\n    if (idx < 0) {\r\n      idx = strUrl.lastIndexOf('\\\\');\r\n    }\r\n    if (idx < 0) {\r\n      console.log('getFolderNameFromUrl: wrong URL!');\r\n      return '';\r\n    }\r\n    const strFolder = strUrl.substring(0, idx);\r\n    return strFolder;\r\n  }\r\n\r\n  isUrlExists(strUrl) {\r\n    let request = null;\r\n    if (window.XMLHttpRequest) {\r\n      request = new XMLHttpRequest();\r\n    } else {\r\n      // request = new ActiveXObject(\"Microsoft.XMLHTTP\");\r\n    }\r\n    // request.open('HEAD', strUrl, false);\r\n    const NEED_ASYNC = true;\r\n    request.open('GET', strUrl, NEED_ASYNC);\r\n    request.send();\r\n    const RES_FAIL_404 = 404;\r\n    const isValid = (request.status !== RES_FAIL_404);\r\n    return isValid;\r\n  } // isUrlkExist\r\n\r\n  encodeUrl(strIn) {\r\n    let strOut = '';\r\n    let dotFound = false;\r\n    const len = strIn.length;\r\n    for (let i = 0; i < len; i++) {\r\n      const sym = strIn[i];\r\n      const isDelim = (sym === '/') || (sym === '.') || (sym === '-')  || (sym === '_');\r\n      if (dotFound && (!isDelim)) {\r\n        const c = strIn.charCodeAt(i);\r\n        const symModi = String.fromCharCode(c + 1);\r\n        strOut += symModi;\r\n      } else {\r\n        strOut += sym;\r\n      }\r\n      dotFound = (sym === '.') ? true : dotFound;\r\n    } // for (i)\r\n    return strOut;\r\n  } // encodeUrl\r\n\r\n  decodeUrl(strIn) {\r\n    let strOut = '';\r\n    let dotFound = false;\r\n    const len = strIn.length;\r\n    for (let i = 0; i < len; i++) {\r\n      const sym = strIn[i];\r\n      const isDelim = (sym === '/') || (sym === '.') || (sym === '-')  || (sym === '_');\r\n      if (dotFound && (!isDelim)) {\r\n        const c = strIn.charCodeAt(i);\r\n        const symModi = String.fromCharCode(c - 1);\r\n        strOut += symModi;\r\n      } else {\r\n        strOut += sym;\r\n      }\r\n      dotFound = (sym === '.') ? true : dotFound;\r\n    } // for (i)\r\n    console.log(`${strOut}`);\r\n    return strOut;\r\n  } // encodeUrl\r\n\r\n} // class FileTools\r\nexport default FileTools;  \r\n","/**\r\n * @fileOverview LoaderDicom\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\n// import gdcm from 'gdcm-js';\r\n\r\n// import jpeg from 'jpeg-lossless-decoder-js';\r\n\r\nimport LoadResult from '../LoadResult';\r\n\r\nimport DicomDictionary from './dicomdict';\r\nimport DicomInfo from './dicominfo';\r\nimport DicomTag from './dicomtag';\r\nimport DicomSlice from './dicomslice';\r\nimport DicomSlicesVolume from './dicomslicesvolume';\r\nimport DicomSliceInfo from './dicomsliceinfo';\r\nimport DicomTagInfo from './dicomtaginfo';\r\nimport FileTools from './FileTools';\r\nimport FileLoader from './FileLoader';\r\n\r\n// import Volume from '../Volume';\r\nimport VolumeSet from '../VolumeSet';\r\nimport Volume from '../Volume';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\nconst DEBUG_PRINT_TAGS_INFO = false;\r\nconst DEBUG_PRINT_INDI_SLICE_INFO = false;\r\nconst NEED_SCAN_EMPTY_BORDER = false;\r\nconst NEED_APPLY_GAUSS_SMOOTHING = false;\r\n\r\n/** deep artificially fix volume texture size to even numbers */\r\nconst NEED_EVEN_TEXTURE_SIZE = false;\r\n\r\n/* eslint-disable */\r\nconst MAGIC_DICM = [68, 73, 67, 77];\r\n\r\nconst DICOM_ERROR_OK = 0;\r\nconst DICOM_ERROR_WRONG_HEADER = -1;\r\nconst DICOM_ERROR_TOO_SMALL_FILE = -2;\r\n\r\nconst UNDEFINED_LENGTH = 0xFFFFFFFF;\r\n\r\nconst LARGE_NUMBER = 0x3FFFFFFF;\r\n\r\nconst TAG_IMAGE_INSTANCE_NUMBER = [0x0020, 0x0013];\r\nconst TAG_PIXEL_DATA = [0x7FE0, 0x0010];\r\n\r\nconst TAG_BITS_ALLOCATED = [0x0028, 0x0100];\r\nconst TAG_IMAGE_ROWS = [0x0028, 0x0010];\r\nconst TAG_IMAGE_COLS = [0x0028, 0x0011];\r\nconst TAG_IMAGE_HIGH_BIT = [0x0028, 0x0102];\r\nconst TAG_IMAGE_SMALL_PIX_VAL = [0x0028, 0x0106];\r\nconst TAG_IMAGE_LARGE_PIX_VAL = [0x0028, 0x0107];\r\nconst TAG_PIXEL_PADDING_VALUE = [0x0028, 0x0120];\r\nconst TAG_PIXEL_SPACING = [0x0028, 0x0030];\r\nconst TAG_WINDOW_CENTER = [0x0028, 0x1050];\r\nconst TAG_WINDOW_WIDTH = [0x0028, 0x1051];\r\nconst TAG_RESCALE_INTERCEPT = [0x0028, 0x1052];\r\nconst TAG_RESCALE_SLOPE = [0x0028, 0x1053];\r\nconst TAG_RESCALE_TYPE = [0x0028, 0x1054];\r\nconst TAG_PIXEL_REPRESENTATION = [0x0028, 0x0103];\r\n\r\nconst TAG_IMAGE_POSITION = [0x0020, 0x0032];\r\nconst TAG_SLICE_LOCATION = [0x0020, 0x1041];\r\nconst TAG_SAMPLES_PER_PIXEL = [0x0028, 0x0002];\r\nconst TAG_SERIES_DESCRIPTION = [0x0008, 0x103E];\r\nconst TAG_SERIES_TIME = [0x0008, 0x31];\r\nconst TAG_END_OF_ITEMS = [0xFFFE, 0xE00D];\r\nconst TAG_END_OF_SEQUENCE = [0xFFFE, 0xE0DD];\r\nconst TAG_SERIES_NUMBER = [0x0020, 0x0011];\r\nconst TAG_SLICE_THICKNESS = [0x0018, 0x0050];\r\nconst TAG_BODY_PART_EXAMINED = [0x0018, 0x0015];\r\n\r\nconst TRANSFER_SYNTAX_IMPLICIT_LITTLE = '1.2.840.10008.1.2';\r\nconst TRANSFER_SYNTAX_EXPLICIT_LITTLE = '1.2.840.10008.1.2.1';\r\nconst TRANSFER_SYNTAX_EXPLICIT_BIG = '1.2.840.10008.1.2.2';\r\nconst TRANSFER_SYNTAX_COMPRESSION_JPEG = '1.2.840.10008.1.2.4';\r\nconst TRANSFER_SYNTAX_COMPRESSION_JPEG_LOSSLESS = '1.2.840.10008.1.2.4.57';\r\nconst TRANSFER_SYNTAX_COMPRESSION_JPEG_LOSSLESS_SEL1 = '1.2.840.10008.1.2.4.70';\r\nconst TRANSFER_SYNTAX_COMPRESSION_JPEG_BASELINE_8BIT = '1.2.840.10008.1.2.4.50';\r\nconst TRANSFER_SYNTAX_COMPRESSION_JPEG_BASELINE_12BIT = '\"1.2.840.10008.1.2.4.51';\r\nconst TRANSFER_SYNTAX_COMPRESSION_JPEG_2000_LOSSLESS = '1.2.840.10008.1.2.4.90';\r\nconst TRANSFER_SYNTAX_COMPRESSION_JPEG_2000 = '1.2.840.10008.1.2.4.91';\r\nconst TRANSFER_SYNTAX_COMPRESSION_RLE = '1.2.840.10008.1.2.5';\r\nconst TRANSFER_SYNTAX_COMPRESSION_DEFLATE = '1.2.840.10008.1.2.1.99';\r\n\r\n// Information from dicom tags, displayed in 2d screen\r\nconst TAG_PATIENT_NAME = [0x0010, 0x0010];\r\nconst TAG_PATIENT_ID = [0x0010, 0x0020];\r\nconst TAG_PATIENT_BIRTH_DATE = [0x0010, 0x0030];\r\nconst TAG_PATIENT_GENDER = [0x0010, 0x0040];\r\nconst TAG_STUDY_DATE = [0x0008, 0x0020];\r\nconst TAG_STUDY_DESCR = [0x0008, 0x1030];\r\nconst TAG_ACQUISION_TIME = [0x0008, 0x0032];\r\nconst TAG_INSTITUTION_NAME = [0x0008, 0x0080];\r\nconst TAG_PHYSICANS_NAME = [0x0008, 0x0090];\r\nconst TAG_MANUFACTURER_NAME = [0x0008, 0x0070];\r\nconst TAG_OPERATORS_NAME = [0x0008, 0x1070];\r\n\r\n// const NEED_EVEN_TEXTURE_SIZE = false;\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class LoaderDicom some text later...\r\n */\r\nclass LoaderDicom{\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(numFiles, needScaleDownTexture = false) {\r\n    this.m_xDim = -1;\r\n    this.m_yDim = -1;\r\n    this.m_zDim = numFiles;\r\n    this.m_needScaleDownTexture = needScaleDownTexture;\r\n    /** @property {object} m_fileLoader - low level file loader */\r\n    this.m_folder = null;\r\n    /** @property {boolean} m_isLoadedSuccessfull - Loaded flag: success o not */\r\n    this.m_isLoadedSuccessfull = false;\r\n    /** @property {number} m_dataSize - Volume data size in bytes */\r\n    this.m_dataSize = 0;\r\n    /** @property {array} m_dataArray - byte array for volume data */\r\n    this.m_dataArray = null;\r\n    /** dictionary */\r\n    this.m_dictionary = new DicomDictionary();\r\n    /** index of the image in slices set */\r\n    this.m_imageNumber = -1;\r\n    /** @property {array} m_errors - array  with error after file read, used internally */\r\n    this.m_errors = [];\r\n    /**  @property {string} m_transformSyntax - string with pixel data transform syntax */\r\n    this.m_transformSyntax = \"\";\r\n    /** @property {array} m_loaders - array with objects for individual file loading */\r\n    this.m_loaders = [];\r\n    /** @property {number} m_xDim - volume dimension on x (width) */\r\n    this.m_xDim = -1;\r\n    /** @property {number} m_yDim - volume dimension on y (height) */\r\n    this.m_yDim = -1;\r\n    /** @property {number} m_bitsPerPixel - bits per pixe;. Can be 8, 16, 32 */\r\n    this.m_bitsPerPixel = -1;\r\n    /** @property {number} m_padValue - background pixel value, not used in histogram */\r\n    this.m_padValue = -LARGE_NUMBER;\r\n    this.m_windowCenter = LARGE_NUMBER; // TAG_WINDOW_CENTER\r\n    this.m_windowWidth = LARGE_NUMBER; // TAG_WINDOW_WIDTH\r\n    this.m_rescaleIntercept = 0; // TAG_RESCALE_INTERCEPT, used as v` = v * rescaleSlope + rescaleIntercept\r\n    this.m_rescaleSlope = 1; // TAG_RESCALE_SLOPE\r\n    this.m_rescaleHounsfield = false;\r\n    this.m_pixelRepresentaionSigned = false;\r\n\r\n    /** @property {number} m_littleEndian - little ednian encoding of pixel data */\r\n    this.m_littleEndian = true;\r\n    /** @property {number} m_samplesPerPixel - number of samples per pixel. Can be 1 or 3. Used as average */\r\n    this.m_samplesPerPixel = 1;\r\n    /** @property {number} m_seriesNumber - Index of series to check the same image set in slices */\r\n    this.m_seriesNumber = -1;\r\n    /** @property {string} m_seriesDescr - Description of series */\r\n    this.m_seriesDescr = '';\r\n    /** @property {object} m_boxSize - vertex3f with physic volume dimension */\r\n    this.m_boxSize = {\r\n      x: 1.0,\r\n      y: 1.0,\r\n      z: 1.0,\r\n    };\r\n    /** @property {object} m_boxSize - vertex3f with physic volume dimension */\r\n    this.m_nonEmptyBoxMin = {\r\n      x: 0.0,\r\n      y: 0.0,\r\n      z: 0.0,\r\n    };\r\n    /** @property {object} m_boxSize - vertex3f with physic volume dimension */\r\n    this.m_nonEmptyBoxMax = {\r\n      x: 1.0,\r\n      y: 1.0,\r\n      z: 1.0,\r\n    };\r\n\r\n    /** @property {object} m_slicesVolume - Volume, where slices are collected */\r\n    this.m_slicesVolume = new DicomSlicesVolume();\r\n    /** @property {object} m_newTagEvent - custom event, that is send on new tag reading */\r\n    this.m_newTagEvent = new CustomEvent('newTag', {\r\n      detail: {\r\n        group: null,\r\n        element: null,\r\n        desc: null,\r\n        value: null,\r\n        imageNumber: null,\r\n        fileName: null,\r\n      },\r\n    });\r\n    /** @property {Object} m_info - Patient name, patient gender, ... */\r\n    this.m_dicomInfo = new DicomInfo();\r\n\r\n    // physical dimension\r\n    this.m_pixelSpacing = {\r\n      x: 0.0,\r\n      y: 0.0,\r\n      z: 0.0\r\n    };\r\n    this.m_filesLoadedCounter = 0;\r\n    this.m_numLoadedFiles = numFiles;\r\n\r\n    this.m_imagePosMin = {\r\n      // eslint-disable-next-line\r\n      x: +1.0e12,\r\n      // eslint-disable-next-line\r\n      y: +1.0e12,\r\n      // eslint-disable-next-line\r\n      z: +1.0e12\r\n    };\r\n    this.m_imagePosMax = {\r\n      // eslint-disable-next-line\r\n      x: -1.0e12,\r\n      // eslint-disable-next-line\r\n      y: -1.0e12,\r\n      // eslint-disable-next-line\r\n      z: -1.0e12\r\n    };\r\n\r\n    // eslint-disable-next-line\r\n    this.m_sliceLocMin = +1.0e12;\r\n    // eslint-disable-next-line\r\n    this.m_sliceLocMax = -1.0e12;\r\n\r\n    this.runLoader = this.runLoader.bind(this);\r\n  }\r\n  getBoxSize() {\r\n    return this.m_boxSize;\r\n  }\r\n  getNonEmptyBoxMin() {\r\n    return this.m_nonEmptyBoxMin;\r\n  }\r\n  getNonEmptyBoxMax() {\r\n    return this.m_nonEmptyBoxMax;\r\n  }\r\n\r\n  getDicomInfo() {\r\n    return this.m_dicomInfo;\r\n  }\r\n  /**\r\n   * Create volume from slices set (m_slicesVolume)\r\n   * It can be several set of slices (for multiple series) and hash will\r\n   * select required slices\r\n   * \r\n   * Create volume data array from individual slices, loaded from different files\r\n   * @param {VolumeSet} volSet - destination volume set, will be created\r\n   * @param {number} indexSelected  - desired volume (serie) index\r\n   * @param {number} hashSelected - use only slices with this hash\r\n   * @return {LoadResult} LoadResult.SUCCESS if success\r\n   */\r\n createVolumeFromSlices(volSet, indexSelected, hashSelected) {\r\n  // check arguments\r\n  console.assert(volSet != null, \"Null volume\");\r\n  console.assert(volSet instanceof VolumeSet, \"Should be volume set\");\r\n  console.assert(typeof(indexSelected) === \"number\", \"index should be number\");\r\n  console.assert(typeof(hashSelected) === \"number\", \"index should be number\");\r\n\r\n  let volDst = null;\r\n  if (indexSelected < volSet.getNumVolumes()) {\r\n    volDst = volSet.getVolume(indexSelected);\r\n  } else {\r\n    volDst = new Volume();\r\n    volSet.addVolume(volDst);\r\n    volDst = volSet.getVolume(indexSelected);\r\n    console.assert(volDst !== null);\r\n  }\r\n\r\n  const numSeries = this.m_slicesVolume.m_series.length;\r\n  // get serie with given hash\r\n  let indSerie = -1;\r\n  for (let s = 0; s < numSeries; s++) {\r\n    if (this.m_slicesVolume.m_series[s].m_hash === hashSelected) {\r\n      indSerie = s; break;\r\n    }\r\n  }\r\n  console.assert(indSerie >= 0);\r\n  const serie = this.m_slicesVolume.m_series[indSerie];\r\n  const slice0 = serie.m_slices[0];\r\n  const numSlices = serie.m_slices.length;\r\n  this.m_xDim = slice0.m_xDim;\r\n  this.m_yDim = slice0.m_yDim;\r\n  this.m_zDim = serie.m_slices.length;\r\n  let xyDim = this.m_xDim * this.m_yDim;\r\n  \r\n  const imagePosBox = {\r\n    x: this.m_imagePosMax.x - this.m_imagePosMin.x,\r\n    y: this.m_imagePosMax.y - this.m_imagePosMin.y,\r\n    z: this.m_imagePosMax.z - this.m_imagePosMin.z\r\n  };\r\n  const TOO_MIN = 0.00001;\r\n  let zBox;\r\n  if (Math.abs(this.m_pixelSpacing.z) > TOO_MIN) {\r\n    zBox = this.m_pixelSpacing.z * this.m_zDim;\r\n  } else {\r\n    zBox = imagePosBox.z;\r\n    if (Math.abs(zBox) < TOO_MIN) {\r\n      zBox = imagePosBox.x;\r\n      if (Math.abs(zBox) < TOO_MIN) {\r\n        zBox = imagePosBox.y;\r\n      }\r\n    }\r\n  } // if pixel spacing 0\r\n  if (zBox < TOO_MIN) {\r\n    zBox = 1.0;\r\n  }\r\n  // check empty pixel spacing\r\n  if (this.m_pixelSpacing.x * this.m_pixelSpacing.y < TOO_MIN) {\r\n    this.m_pixelSpacing.x = 1.0;\r\n    this.m_pixelSpacing.y = 1.0;\r\n  }\r\n  this.m_pixelSpacing.z = zBox / this.m_zDim;\r\n  this.m_boxSize.z = this.m_zDim * this.m_pixelSpacing.z;\r\n  this.m_boxSize.x = this.m_xDim * this.m_pixelSpacing.x;\r\n  this.m_boxSize.y = this.m_yDim * this.m_pixelSpacing.y;\r\n  console.log(`createVolumeFromSlices. Volume local phys dim: ${this.m_boxSize.x} * ${this.m_boxSize.y} * ${this.m_boxSize.z}`);\r\n\r\n  let i;\r\n  let dataSize = 0;\r\n  let dataArray = null;\r\n\r\n  // convert big endian in slices\r\n  if (!this.m_littleEndian) {\r\n    for (let ser = 0; ser < numSeries; ser++){\r\n      const serie = this.m_slicesVolume.m_series[ser];\r\n      if (serie.m_hash !== hashSelected) {\r\n        continue;\r\n      }\r\n      for (let sl = 0; sl < numSlices; sl++) {\r\n        const slice = serie.m_slices[sl];\r\n        const sliceData16 = slice.m_image;\r\n        const xDim = slice.m_xDim;\r\n        const yDim = slice.m_yDim;\r\n        xyDim = xDim * yDim;\r\n        for (i = 0; i < xyDim; i++) {\r\n          const val16 = sliceData16[i];\r\n          sliceData16[i] = (val16 >> 8) | ((val16 << 8) & 0xffff);\r\n        } // for (i) all slice pixels\r\n      } // for sl\r\n    } // for ser\r\n  } // if big endian\r\n\r\n  // remove pad values or too much values\r\n  for (let ser = 0; ser < numSeries; ser++) {\r\n    const serie = this.m_slicesVolume.m_series[ser];\r\n    if (serie.m_hash !== hashSelected) {\r\n      continue;\r\n    }\r\n    for (let sl = 0; sl < numSlices; sl++) {\r\n      const slicePad = serie.m_slices[sl];\r\n      const xDim = slicePad.m_xDim;\r\n      const yDim = slicePad.m_yDim;\r\n      xyDim = xDim * yDim;\r\n      for (i = 0; i < xyDim; i++) {\r\n        const val16 = slicePad.m_image[i];\r\n        // if ((val16 === this.m_padValue) || ((val16 & 0x8000) !== 0)) {\r\n        if (val16 === this.m_padValue) {\r\n          val16 = 0;\r\n        }\r\n        slicePad.m_image[i] = val16;\r\n      } // for (i) all slice pixels\r\n    } // for sl\r\n  } // for ser\r\n\r\n  // dont apply rescale formula here, due to unsigned numbder can became signed, but store\r\n  // image in the unsigmed form\r\n\r\n  // get maximum value from slices (but only for given serie : hash)\r\n  let maxVal = -LARGE_NUMBER;\r\n  let minVal = +LARGE_NUMBER;\r\n  for (let ser = 0; ser < numSeries; ser++) {\r\n    const serie = this.m_slicesVolume.m_series[ser];\r\n    if (serie.m_hash !== hashSelected) {\r\n      continue;\r\n    }\r\n    for (let sl = 0; sl < numSlices; sl++) {\r\n      const slice = serie.m_slices[sl];\r\n      const sliceData16 = slice.m_image;\r\n      const xDim = slice.m_xDim;\r\n      const yDim = slice.m_yDim;\r\n      xyDim = xDim * yDim;\r\n      for (i = 0; i < xyDim; i++) {\r\n        const valData = sliceData16[i] * this.m_rescaleSlope + this.m_rescaleIntercept;\r\n        minVal = (valData < minVal) ? valData : minVal;\r\n        maxVal = (valData > maxVal) ? valData : maxVal;\r\n      } // for (i) all slice pixels\r\n    } // for sl\r\n  } // for ser\r\n\r\n  console.log(`Build Volume. min/max value=${minVal}/${maxVal}. Volume dim = ${this.m_xDim}*${this.m_yDim}*${this.m_zDim}`);\r\n  console.log(`Min slice number = ${serie.m_minSlice}`);\r\n  console.log(`Max slice number = ${serie.m_maxSlice}`);\r\n  maxVal = (maxVal - minVal > 0) ? maxVal : (maxVal + 1); \r\n\r\n  const BITS_ACCUR = 11;\r\n  const BITS_IN_BYTE = 8;\r\n  const scale = Math.floor((1 << (BITS_IN_BYTE + BITS_ACCUR)) / (maxVal - minVal));\r\n  const TOO_MIN_SCALE = 4;\r\n  if (scale <= TOO_MIN_SCALE) {\r\n    console.log('Bad scaling: image will be 0');\r\n    return LoadResult.ERROR_SCALING;\r\n  }\r\n\r\n  // get slices for selected serie\r\n  const srcSlices = serie.m_slices;\r\n\r\n  const numSlicesByTags = serie.m_maxSlice - serie.m_minSlice + 1;\r\n  if (numSlicesByTags !== numSlices) {\r\n    console.log(`Sort by location! N slices by tags = ${numSlicesByTags}, but N readed slices = ${numSlices}`);\r\n  }\r\n  // sort slices via slice location OR slice number\r\n  let minSliceNum = srcSlices[0].m_sliceNumber;\r\n  let maxSliceNum = srcSlices[0].m_sliceNumber;\r\n  for (let s = 0; s < numSlices; s++) {\r\n    const num = srcSlices[s].m_sliceNumber;\r\n    minSliceNum = (num < minSliceNum) ? num : minSliceNum;\r\n    maxSliceNum = (num > maxSliceNum) ? num : maxSliceNum;\r\n  }\r\n  const difSlceNum = maxSliceNum - minSliceNum;\r\n  if (difSlceNum > 0) {\r\n    // sort slices by slice number (read from dicom tag)\r\n    srcSlices.sort((a, b) => {\r\n      const zDif = a.m_sliceNumber - b.m_sliceNumber;\r\n      return zDif;\r\n    });\r\n  } else {\r\n    // sort slices by slice location (read from diocom tag)\r\n    srcSlices.sort((a, b) => {\r\n      const zDif = a.m_sliceLocation - b.m_sliceLocation;\r\n      return zDif;\r\n    });\r\n  }\r\n  // assign new slice numbers according accending location\r\n  let ind = 0;\r\n  for (let s = 0; s < numSlices; s++) {\r\n    srcSlices[s].m_sliceNumber = ind;\r\n    ind++;\r\n  }\r\n  this.m_zDim = numSlices;\r\n\r\n  // create out volume data array\r\n  // normal copy volume with transform 16 -> 8 bit\r\n\r\n  dataSize = this.m_xDim * this.m_yDim * this.m_zDim;\r\n  dataArray = new Uint8Array(dataSize);\r\n  if (dataArray === null) {\r\n    console.log('no memory');\r\n    return LoadResult.ERROR_NO_MEMORY;\r\n  }\r\n  for (i = 0; i < dataSize; i++) {\r\n    dataArray[i] = 0;\r\n  }\r\n\r\n  // convert slices data into volume set data (16 bpp -> 8 bpp, etc)\r\n  const MAX_BYTE = 255;\r\n  for (let s = 0; s < numSlices; s++) {\r\n    const sliceSrc = srcSlices[s];\r\n    xyDim = sliceSrc.m_xDim * sliceSrc.m_yDim;\r\n    const dataSrc16 = sliceSrc.m_image;\r\n    // console.log(`Slice[${s}] sliceNumber = ${slice.m_sliceNumber} sliceLocation = ${slice.m_sliceLocation}`);\r\n\r\n    // const z = slice.m_sliceNumber - this.m_slicesVolume.m_minSlice;\r\n    let z = sliceSrc.m_sliceNumber;\r\n    if (z >= serie.m_slices.length) {\r\n      z = sliceSrc.m_sliceNumber - serie.m_minSlice;\r\n      if ((z < 0) || (z >= this.m_zDim)) {\r\n        console.log('Invalid z slice reference');\r\n        return LoadResult.ERROR_INVALID_SLICE_INDEX;\r\n      } // if z invalid\r\n    } // if z more num slices\r\n\r\n    if (dataSrc16 !== null) {\r\n      const offZ = z * xyDim;\r\n\r\n      if ((this.m_windowCenter !== LARGE_NUMBER) && (this.m_windowWidth !== LARGE_NUMBER)) {\r\n        const winMin = this.m_windowCenter - this.m_windowWidth * 0.5;\r\n        for (i = 0; i < xyDim; i++) {\r\n          const valScaled = dataSrc16[i] * this.m_rescaleSlope + this.m_rescaleIntercept;\r\n\r\n          let val = 0;\r\n          if (this.m_rescaleHounsfield) {\r\n            // rescale for hounsfield units\r\n            val = Math.floor((valScaled - winMin) * 255 / this.m_windowWidth);\r\n          } else {\r\n            // usual (default) rescale\r\n            val = Math.floor(127 + (valScaled - this.m_windowCenter) * 128 / (this.m_windowWidth / 2));\r\n          }\r\n          val = (val >= 0) ? val : 0;\r\n          val = (val < 255) ? val : 255;\r\n          dataArray[offZ + i] = val;\r\n        } // for i\r\n      } else {\r\n        // window center, width not specified\r\n        for (i = 0; i < xyDim; i++) {\r\n          const val16 = dataSrc16[i] * this.m_rescaleSlope + this.m_rescaleIntercept;\r\n          let val = ((val16 - minVal) * scale) >> BITS_ACCUR;\r\n          // let val = Math.floor(255 * val16 / maxVal);\r\n          val = (val <= MAX_BYTE) ? val : MAX_BYTE;\r\n          dataArray[offZ + i] = val;\r\n        } // for i\r\n      } // no defined window center, width\r\n\r\n    } // if has slice data\r\n  } // for(s) all slices\r\n\r\n  // destroy for what?\r\n  // this.m_slicesVolume.destroy();\r\n\r\n  // Scale down volume by slices\r\n  const numPixelsInVolume = this.m_xDim * this.m_yDim * this.m_zDim;\r\n  // eslint-disable-next-line\r\n  const MAX_VOLUME_PIXELS = 512 * 512 * 256;\r\n  if (this.m_needScaleDownTexture && (numPixelsInVolume > MAX_VOLUME_PIXELS)) {\r\n    const XY_MAX_DIM = 512;\r\n    const Z_LOW_DIM = 120;\r\n    const xDimDst = (this.m_xDim <= XY_MAX_DIM) ? this.m_xDim : XY_MAX_DIM;\r\n    const yDimDst = (this.m_yDim <= XY_MAX_DIM) ? this.m_yDim : XY_MAX_DIM;\r\n    const zDimDst = Z_LOW_DIM;\r\n    const dataNew = VolumeTools.scaleTextureDown(this, dataArray, xDimDst, yDimDst, zDimDst);\r\n    dataArray = dataNew;\r\n    xyDim = this.m_xDim * this.m_yDim;\r\n    console.log(`Volume scaled down to: ${xDimDst} * ${yDimDst} * ${zDimDst}.`);\r\n  }\r\n\r\n  // Scan for empty voxels on border sides\r\n  if (NEED_SCAN_EMPTY_BORDER) {\r\n    const xDim = this.m_xDim;\r\n    const yDim = this.m_yDim;\r\n    const zDim = this.m_zDim;\r\n\r\n    const minValBarrier = 16;\r\n    let x;\r\n    let y;\r\n    let z;\r\n    let isEmpty;\r\n    isEmpty = true;\r\n    for (x = 0; (x < xDim / TWICE) && (isEmpty); x++) {\r\n      // check is empty plane\r\n      for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n        for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n          const off = (z * xyDim) + (y * xDim) + x;\r\n          if (dataArray[off] > minValBarrier) {\r\n            isEmpty = false;\r\n          }\r\n        } // for (z)\r\n      } // for (y()\r\n    } // for (x)\r\n    const xBorderMin = x;\r\n\r\n    isEmpty = true;\r\n    for (x = xDim - 1; (x > xDim / TWICE) && (isEmpty); x--) {\r\n      // check is empty plane\r\n      for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n        for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n          const off = (z * xyDim) + (y * xDim) + x;\r\n          if (dataArray[off] > minValBarrier) {\r\n            isEmpty = false;\r\n          }\r\n        } // for (z)\r\n      } // for (y()\r\n    } // for (x)\r\n    const xBorderMax = x;\r\n\r\n    isEmpty = true;\r\n    for (y = 0; (y < yDim / TWICE) && (isEmpty); y++) {\r\n      // check is empty plane\r\n      for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n        for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n          const off = (z * xyDim) + (y * xDim) + x;\r\n          if (dataArray[off] > minValBarrier) {\r\n            isEmpty = false;\r\n          }\r\n        } // for (z)\r\n      } // for (y()\r\n    } // for (x)\r\n    const yBorderMin = y;\r\n\r\n    isEmpty = true;\r\n    for (y = yDim - 1; (y > yDim / TWICE) && (isEmpty); y--) {\r\n      // check is empty plane\r\n      for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n        for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n          const off = (z * xyDim) + (y * xDim) + x;\r\n          if (dataArray[off] > minValBarrier) {\r\n            isEmpty = false;\r\n          }\r\n        } // for (z)\r\n      } // for (y()\r\n    } // for (x)\r\n    const yBorderMax = y;\r\n\r\n    isEmpty = true;\r\n    for (z = 0; (z < zDim / TWICE) && (isEmpty); z++) {\r\n      // check is empty plane\r\n      for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n        for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n          const off = (z * xyDim) + (y * xDim) + x;\r\n          if (dataArray[off] > minValBarrier) {\r\n            isEmpty = false;\r\n          }\r\n        } // for (z)\r\n      } // for (y()\r\n    } // for (x)\r\n    const zBorderMin = z;\r\n\r\n    isEmpty = true;\r\n    for (z = zDim - 1; (z > zDim / TWICE) && (isEmpty); z--) {\r\n      // check is empty plane\r\n      for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n        for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n          const off = (z * xyDim) + (y * xDim) + x;\r\n          if (dataArray[off] > minValBarrier) {\r\n            isEmpty = false;\r\n          }\r\n        } // for (z)\r\n      } // for (y()\r\n    } // for (x)\r\n    const zBorderMax = z;\r\n\r\n    // console.log(`Border scan: xBorderMin = ${xBorderMin}, xBorderMax = ${xBorderMax}. xDim = ${xDim}`);\r\n    // console.log(`Border scan: yBorderMin = ${yBorderMin}, yBorderMax = ${yBorderMax}. yDim = ${yDim}`);\r\n    // console.log(`Border scan: zBorderMin = ${zBorderMin}, zBorderMax = ${zBorderMax}. zDim = ${zDim}`);\r\n    this.m_nonEmptyBoxMin.x = xBorderMin / xDim;\r\n    this.m_nonEmptyBoxMin.y = yBorderMin / yDim;\r\n    this.m_nonEmptyBoxMin.z = zBorderMin / zDim;\r\n    this.m_nonEmptyBoxMax.x = xBorderMax / xDim;\r\n    this.m_nonEmptyBoxMax.y = yBorderMax / yDim;\r\n    this.m_nonEmptyBoxMax.z = zBorderMax / zDim;\r\n\r\n    this.m_boxSize.z = (zBorderMax - zBorderMin) * this.m_pixelSpacing.z;\r\n    this.m_boxSize.x = (xBorderMax - xBorderMin) * this.m_pixelSpacing.x;\r\n    this.m_boxSize.y = (yBorderMax - yBorderMin) * this.m_pixelSpacing.y;\r\n\r\n    const neMin = this.m_nonEmptyBoxMin;\r\n    const neMax = this.m_nonEmptyBoxMax;\r\n    console.log(`Border scan min: ${neMin.x}, ${neMin.y}, ${neMin.z}`);\r\n    console.log(`Border scan max: ${neMax.x}, ${neMax.y}, ${neMax.z}`);\r\n  } // if need scan empty borders\r\n\r\n  // Special volume texture size fix (z dim should be even)\r\n  if (NEED_EVEN_TEXTURE_SIZE) {\r\n    const xDim = this.m_xDim;\r\n    const yDim = this.m_yDim;\r\n    const zDim = this.m_zDim;\r\n    if ((zDim & 1) !== 0) {\r\n      const volDataAlignedSize = VolumeTools.makeTextureSizeEven(dataArray, xDim, yDim, zDim);\r\n      // Align all dims to 4*x\r\n      const NUM3 = 3;\r\n      this.m_xDim = (xDim + NUM3) & (~NUM3);\r\n      this.m_yDim = (yDim + NUM3) & (~NUM3);\r\n      this.m_zDim = (zDim + NUM3) & (~NUM3);\r\n      dataArray = volDataAlignedSize;\r\n    }\r\n  }\r\n\r\n  // Apply Gauss smooth filter\r\n  if (NEED_APPLY_GAUSS_SMOOTHING) {\r\n    const volTools = new VolumeTools();\r\n    const GAUSS_RADIUS = 2;\r\n    const GAUSS_SIGMA = 1.4;\r\n    volTools.gaussSmooth(dataArray, this.m_xDim, this.m_yDim, this.m_zDim, GAUSS_RADIUS, GAUSS_SIGMA);\r\n  }\r\n\r\n  // Apply 0 to the edges of volume\r\n  const MIN_NUM_SLICES_FOR_VOL = 4;\r\n  if (this.m_zDim > MIN_NUM_SLICES_FOR_VOL) {\r\n    let x;\r\n    let y;\r\n    let z;\r\n    let yOff;\r\n    let zOff;\r\n    // z planes\r\n    z = 0;\r\n    const zOffMin = z * this.m_xDim * this.m_yDim;\r\n    z = this.m_zDim - 1;\r\n    const zOffMax = z * this.m_xDim * this.m_yDim;\r\n    for (y = 0; y < this.m_yDim; y++) {\r\n      yOff = y * this.m_xDim;\r\n      for (x = 0; x < this.m_xDim; x++) {\r\n        dataArray[zOffMin + yOff + x] = 0;\r\n        dataArray[zOffMax + yOff + x] = 0;\r\n      } // for x\r\n    }  // for y\r\n\r\n    // x planes\r\n    x = 0;\r\n    const xOffMin = x;\r\n    x = this.m_xDim - 1;\r\n    const xOffMax = x;\r\n    for (z = 0; z < this.m_zDim; z++) {\r\n      zOff = z * this.m_xDim * this.m_yDim;\r\n      for (y = 0; y < this.m_yDim; y++) {\r\n        yOff = y * this.m_xDim;\r\n        dataArray[zOff + yOff + xOffMin] = 0;\r\n        dataArray[zOff + yOff + xOffMax] = 0;\r\n      }\r\n    }\r\n    // y planes\r\n    y = 0;\r\n    const yOffMin = y * this.m_xDim;\r\n    y = this.m_yDim - 1;\r\n    const yOffMax = y * this.m_xDim;\r\n    for (z = 0; z < this.m_zDim; z++) {\r\n      zOff = z * this.m_xDim * this.m_yDim;\r\n      for (x = 0; x < this.m_xDim; x++) {\r\n        dataArray[zOff + x + yOffMin] = 0;\r\n        dataArray[zOff + x + yOffMax] = 0;\r\n      } // for x\r\n    } // for z\r\n  } // if zDim more min possible for volume\r\n\r\n  const KTX_GL_RED = 0x1903;\r\n  const KTX_UNSIGNED_BYTE = 0x1401;\r\n  const header = {\r\n    m_pixelWidth: this.m_xDim,\r\n    m_pixelHeight: this.m_yDim,\r\n    m_pixelDepth: this.m_zDim,\r\n    m_glType: KTX_UNSIGNED_BYTE,\r\n    m_glTypeSize: 1,\r\n    m_glFormat: KTX_GL_RED,\r\n    m_glInternalFormat: KTX_GL_RED,\r\n    m_glBaseInternalFormat: KTX_GL_RED,\r\n  };\r\n  const callbackComplete = this.m_callbackComplete;\r\n  if (callbackComplete) {\r\n    callbackComplete(LoadResult.SUCCESS, header, dataSize, dataArray);\r\n  } // if callback ready\r\n  const ONE = 1;\r\n\r\n  volDst.m_xDim = this.m_xDim;\r\n  volDst.m_yDim = this.m_yDim;\r\n  volDst.m_zDim = this.m_zDim;\r\n  volDst.m_dataArray = dataArray;\r\n  volDst.m_dataSize = dataSize;\r\n  volDst.m_bytesPerVoxel = ONE;\r\n  volDst.m_boxSize.x = this.m_boxSize.x;\r\n  volDst.m_boxSize.y = this.m_boxSize.y;\r\n  volDst.m_boxSize.z = this.m_boxSize.z;\r\n\r\n  volDst.m_patientName = this.m_dicomInfo.m_patientName;\r\n  volDst.m_patientBirth = this.m_dicomInfo.m_patientDateOfBirth;\r\n  volDst.m_seriesDescr = this.m_dicomInfo.m_seriesDescr;\r\n\r\n\r\n  volDst.m_studyDescr = this.m_dicomInfo.m_studyDescr;\r\n  volDst.m_studyDate = this.m_dicomInfo.m_studyDate;\r\n  volDst.m_seriesTime = this.m_dicomInfo.m_seriesTime;\r\n  volDst.m_bodyPartExamined = this.m_dicomInfo.m_bodyPartExamined;\r\n  volDst.m_institutionName = this.m_dicomInfo.m_institutionName;\r\n  volDst.m_operatorsName = this.m_dicomInfo.m_operatorsName;\r\n  volDst.m_physicansName = this.m_dicomInfo.m_physicansName;\r\n\r\n  volDst.createIcon();\r\n\r\n\r\n  return LoadResult.SUCCESS;\r\n} // end createVolumeFromSlices\r\n\r\n  static getVrsStringIndex(vr) {\r\n    const VRS = [\r\n      'AE', 'AS', 'AT', 'CS', 'DA', 'DS', 'DT', 'FL',\r\n      'FD', 'IS', 'LO', 'LT', 'OB', 'OD', 'OF', 'OW',\r\n      'PN', 'SH', 'SL', 'SS', 'ST', 'TM', 'UI', 'UL',\r\n      'UN', 'US', 'UT',\r\n    ];\r\n    const numElems = VRS.length;\r\n    for (let i = 0; i < numElems; i++) {\r\n      if (VRS[i] === vr) {\r\n        return i;\r\n      }\r\n    }\r\n    return -1;\r\n  }\r\n  static getDataVrsStringIndex(vr) {\r\n    const DATA_VRS = [\r\n      'OB', 'OW', 'OF', 'SQ', 'UT', 'UN',\r\n    ];\r\n    const numElems = DATA_VRS.length;\r\n    for (let i = 0; i < numElems; i++) {\r\n      if (DATA_VRS[i] === vr) {\r\n        return i;\r\n      }\r\n    }\r\n    return -1;\r\n  }\r\n  /**\r\n  * Convert DataView object into string\r\n  * @param {object} dataView - DataView object (created from ArrayBuffer)\r\n  * @param {number} offset - current offset in buffer, when string started\r\n  * @param {number} lengthBuf - number of bytes to convert to string\r\n  * @return {string} string presentation of DataView\r\n  */\r\n  static getStringAt(dataView, offset, lengthBuf) {\r\n    let str = '';\r\n    for (let i = 0; i < lengthBuf; i++) {\r\n      const ch = dataView.getUint8(offset + i);\r\n      if (ch !== 0) {\r\n        str += String.fromCharCode(ch);\r\n      }\r\n    }\r\n    return str;\r\n  }\r\n  static getUtf8StringAt(dataView, offset, lengthBuf) {\r\n    let str = '';\r\n    let i = 0;\r\n    while (i < lengthBuf) {\r\n      let c = dataView.getUint8(offset + i); i++;\r\n      if (c == 0x5e) {\r\n        c = 32;\r\n      }\r\n      switch (c >> 4) {\r\n        case 0: case 1:\r\n        case 2: case 3:\r\n        case 4: case 5:\r\n        case 6: case 7:\r\n          str += String.fromCharCode(c);\r\n          break;\r\n        case 12: case 13:\r\n          const char2 = dataView.getUint8(offset + i); i++;\r\n          str += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));\r\n          break;\r\n        case 14:\r\n          const ch2 = dataView.getUint8(offset + i); i++;\r\n          const ch3 = dataView.getUint8(offset + i); i++;\r\n          str += String.fromCharCode(((c & 0x0F) << 12) |\r\n                                     ((ch2 & 0x3F) << 6) |\r\n                                     ((ch3 & 0x3F) << 0));\r\n          break;          \r\n      } // switch\r\n \r\n    } // while not end string\r\n    return str;\r\n  }\r\n  static getAttrValueAsString(tag) {\r\n    if (tag.m_value === null) {\r\n      if (tag.m_vr === 'SQ') { // sequence of items\r\n        return '(Sequence Data)';\r\n      }\r\n      return null;\r\n    }\r\n    const SIZE_SHORT = 2;\r\n    const SIZE_DWORD = 4;\r\n    const dvTag = new DataView(tag.m_value);\r\n    let tmp = null;\r\n    let res = null;\r\n    let date = null;\r\n    let readBytes = 0;\r\n    // to do: add AT, OB?, OD?, OF?, OW?, Unknown?\r\n    switch (tag.m_vr) {\r\n      case 'AE': // application entity\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      case 'AS': // age string\r\n        tmp = LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n        // eslint-disable-next-line\r\n        res = Number(tmp.slice(0, 3)).toString();\r\n        switch (tmp[3]) {\r\n          case 'D':\r\n            return `${res} days`;\r\n          case 'W':\r\n            return `${res} weeks`;\r\n          case 'M':\r\n            return `${res} months`;\r\n          case 'Y':\r\n            return `${res} years`;\r\n          default:\r\n            return null;\r\n        }\r\n      case 'CS': // code string\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      case 'DA': // date\r\n        tmp = LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n        // eslint-disable-next-line\r\n        date = new Date(`${tmp.slice(0, 4)}-${tmp.slice(4, 6)}-${tmp.slice(6, 8)}`);\r\n        return date.toLocaleDateString();\r\n      case 'DS': // decimal string\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      case 'DT': // date time\r\n        // to do: parse date-time as YYYYMMDDHHMMSS.FFFFFF&ZZXX\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      case 'FL': // floating point single\r\n        res = dvTag.getFloat32(0, tag.m_littleEndian).toString();\r\n        readBytes = SIZE_DWORD;\r\n        while (readBytes + SIZE_DWORD <= dvTag.byteLength) {\r\n          res = `${res} \\\\ ${dvTag.getFloat32(readBytes, tag.m_littleEndian).toString()}`;\r\n          readBytes += SIZE_DWORD;\r\n        }\r\n        return res;\r\n      case 'FD': // floating point double\r\n        res = dvTag.getFloat64(0, tag.m_littleEndian).toString();\r\n        readBytes = (SIZE_DWORD + SIZE_DWORD);\r\n        while (readBytes + SIZE_DWORD + SIZE_DWORD <= dvTag.byteLength) {\r\n          res = `${res} \\\\ ${dvTag.getFloat64(readBytes, tag.m_littleEndian).toString()}`;\r\n          readBytes += (SIZE_DWORD + SIZE_DWORD);\r\n        }\r\n        return res;\r\n      case 'IS': // integer string\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      case 'LO': // long string\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      case 'LT': // long text\r\n        // to do: check if it works for several paragraphs\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      case 'PN': // person name\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      case 'SH': // short string\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      case 'SL': // signed long\r\n        res = dvTag.getInt32(0, tag.m_littleEndian).toString();\r\n        readBytes = SIZE_DWORD;\r\n        while (readBytes + SIZE_SHORT <= dvTag.byteLength) {\r\n          res = `${res} \\\\ ${dvTag.getInt16(readBytes, tag.m_littleEndian).toString()}`;\r\n          readBytes += SIZE_DWORD;\r\n        }\r\n        return res;\r\n      case 'SS': // signed short\r\n        res = dvTag.getInt16(0, tag.m_littleEndian).toString();\r\n        readBytes = SIZE_SHORT;\r\n        while (readBytes + SIZE_SHORT <= dvTag.byteLength) {\r\n          res = `${res} \\\\ ${dvTag.getInt16(readBytes, tag.m_littleEndian).toString()}`;\r\n          readBytes += SIZE_SHORT;\r\n        }\r\n        return res;\r\n      case 'ST': // short text\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      case 'TM': // time\r\n        tmp = LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n        if (tag.m_value.byteLength >= SIZE_SHORT) {\r\n          // eslint-disable-next-line\r\n          res = `${Number(tmp.slice(0, 2))}h`;\r\n        }\r\n        if (tag.m_value.byteLength >= SIZE_DWORD) {\r\n          // eslint-disable-next-line\r\n          res = `${res} ${Number(tmp.slice(2, 4))}m`;\r\n        }\r\n        if (tag.m_value.byteLength > SIZE_DWORD) {\r\n          // eslint-disable-next-line\r\n          res = `${res} ${parseFloat(tmp.slice(4, tag.m_value.byteLength))}s`;\r\n        }\r\n        return res;\r\n      case 'UI': // unique identifier\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      case 'UL': // unsigned long\r\n        res = dvTag.getUint32(0, tag.m_littleEndian).toString();\r\n        readBytes = SIZE_DWORD;\r\n        while (readBytes + SIZE_DWORD <= dvTag.byteLength) {\r\n          res = `${res} \\\\ ${dvTag.getUint32(readBytes, tag.m_littleEndian).toString()}`;\r\n          readBytes += SIZE_DWORD;\r\n        }\r\n        return res;\r\n      case 'US': // unsigned short\r\n        res = dvTag.getUint16(0, tag.m_littleEndian).toString();\r\n        readBytes = SIZE_SHORT;\r\n        while (readBytes + SIZE_SHORT <= dvTag.byteLength) {\r\n          res = `${res} \\\\ ${dvTag.getUint16(readBytes, tag.m_littleEndian).toString()}`;\r\n          readBytes += SIZE_SHORT;\r\n        }\r\n        return res;\r\n      case 'UT': // unlimited text\r\n        // to do: check if it works for several paragraphs\r\n        return LoaderDicom.getStringAt(dvTag, 0, tag.m_value.byteLength);\r\n      default:\r\n        return null;\r\n    }\r\n  }\r\n  /**\r\n  * Get next tag from stream\r\n  * @param {object} dataView - array\r\n  * @param {number} offset - current offset in buffer\r\n  * @return {object} if success or null, when fail. Fail reasons: invalid tag length read.\r\n  */\r\n getNextTag(dataView, offset) {\r\n  // check end of buffer\r\n  if (offset >= dataView.byteLengh) {\r\n    return null;\r\n  }\r\n  const SIZE_SHORT = 2;\r\n  const SIZE_DWORD = 4;\r\n\r\n  let little = true;\r\n  let group = 0;\r\n  let element = 0;\r\n  let lenData = 0;\r\n  const offsetStart = offset;\r\n  let vr = '';\r\n\r\n  const MAGIC_GROUP = 0x0002;\r\n\r\n  if (this.m_metaFinished) {\r\n    little = this.m_littleEndian;\r\n    group = dataView.getUint16(offset, little);\r\n  } else {\r\n    group = dataView.getUint16(offset, 1);\r\n    if (((this.m_metaFinishedOffset !== -1) && (offset >= this.m_metaFinishedOffset)) || (group !== MAGIC_GROUP)) {\r\n      this.m_metaFinished = 1;\r\n      little = this.m_littleEndian;\r\n      group = dataView.getUint16(offset, little);\r\n    } else {\r\n      little = true;\r\n    }\r\n  }\r\n  if (!this.m_metaFound && (group === MAGIC_GROUP)) {\r\n    this.m_metaFound = true;\r\n  }\r\n  offset += SIZE_SHORT; // skip group number\r\n\r\n  element = dataView.getUint16(offset, little);\r\n  offset += SIZE_SHORT; // skip element number\r\n\r\n  if (this.m_explicit || !this.m_metaFinished) {\r\n    vr = LoaderDicom.getStringAt(dataView, offset, SIZE_SHORT);\r\n    if (!this.m_metaFound && this.m_metaFinished && (LoaderDicom.getVrsStringIndex(vr) === -1)) {\r\n      vr = DicomDictionary.getVr(group, element);\r\n      lenData = dataView.getUint32(offset, little);\r\n      // assert for lenData < 1024 * 1024 * 32\r\n      offset += SIZE_DWORD;\r\n      this.m_explicit = false;\r\n    } else {\r\n      offset += SIZE_SHORT;\r\n      if (LoaderDicom.getDataVrsStringIndex(vr) !== -1) {\r\n        offset += SIZE_SHORT;\r\n        lenData = dataView.getUint32(offset, little);\r\n        // assert for lenData < 1024 * 1024 * 32\r\n        offset += SIZE_DWORD;\r\n      } else {\r\n        lenData = dataView.getUint16(offset, little);\r\n        // assert for lenData < 1024 * 1024 * 32\r\n        offset += SIZE_SHORT;\r\n      }\r\n    }\r\n  } else {\r\n    vr = this.m_dictionary.getVr(group, element);\r\n    lenData = dataView.getUint32(offset, little);\r\n    // assert for lenData < 1024 * 1024 * 32\r\n    if (lenData === UNDEFINED_LENGTH) {\r\n      vr = 'SQ';\r\n    }\r\n    offset += SIZE_DWORD;\r\n  }\r\n  const offsetValue = offset;\r\n  let dataValue = null;\r\n  if (vr === 'SQ') {\r\n    // see nema dicom Table 7.5-3\r\n    // for now just skip sequence items\r\n    if (lenData === UNDEFINED_LENGTH) {\r\n      let sqGroup = 0;\r\n      let sqElement = 0;\r\n      while (!((sqGroup === TAG_END_OF_SEQUENCE[0]) && (sqElement === TAG_END_OF_SEQUENCE[1]))) {\r\n        sqGroup = dataView.getUint16(offset, little);\r\n        offset += SIZE_SHORT;\r\n        sqElement = dataView.getUint16(offset, little);\r\n        offset += SIZE_SHORT;\r\n        const sqLength = dataView.getUint32(offset, little);\r\n        offset += SIZE_DWORD;\r\n        if (sqLength === UNDEFINED_LENGTH) {\r\n          // item delim. tag (fffe, e00d)\r\n          while (!(((sqGroup === TAG_END_OF_ITEMS[0]) && (sqElement === TAG_END_OF_ITEMS[1])) ||\r\n            ((sqGroup === TAG_END_OF_SEQUENCE[0]) && (sqElement === TAG_END_OF_SEQUENCE[1])))) {\r\n            const tagNew = this.getNextTag(dataView, offset);\r\n            offset = tagNew.m_offsetEnd;\r\n            sqGroup = dataView.getUint16(offset, little);\r\n            sqElement = dataView.getUint16(offset + SIZE_SHORT, little);\r\n          }\r\n          offset += (SIZE_DWORD + SIZE_DWORD); // 4 for group and element + 4 for length field\r\n        } else { // if sqLength is ffffffff\r\n          offset += sqLength;\r\n        }\r\n      } // while not end tag sequence\r\n      lenData = 0;\r\n    } // if length equal to ffffffff\r\n  } else if (lenData > 0) {\r\n    if (lenData === UNDEFINED_LENGTH) {\r\n      if ((group === TAG_PIXEL_DATA[0]) && (element === TAG_PIXEL_DATA[1])) {\r\n        lenData = (dataView.byteLength - offset);\r\n      }\r\n    }\r\n    // Get data from buffer, starting from offset\r\n    dataValue = dataView.buffer.slice(offset, offset + lenData);\r\n  }\r\n  const VAL_16 = 16;\r\n  if (DEBUG_PRINT_TAGS_INFO) {\r\n    const strDesc = this.m_dictionary.getTextDesc(group, element);\r\n    const strGr = group.toString(VAL_16);\r\n    const strEl = element.toString(VAL_16);\r\n    console.log(`Tag {${strGr},${strEl}}, VR='${vr}', Length=${lenData}, Desc=${strDesc}`);\r\n  }\r\n  const VAL_MIN_ONE = 0xffffffff;\r\n  if (lenData === VAL_MIN_ONE) {\r\n    return null;\r\n  }\r\n\r\n  offset += lenData;\r\n  const tag = new DicomTag(group, element, vr, dataValue, offsetStart, offsetValue, offset, this.m_littleEndian);\r\n\r\n  if (tag) {\r\n    this.m_newTagEvent.detail.group = group.toString(VAL_16);\r\n    this.m_newTagEvent.detail.element = element.toString(VAL_16);\r\n    this.m_newTagEvent.detail.desc = this.m_dictionary.getTextDesc(group, element);\r\n    this.m_newTagEvent.detail.value = LoaderDicom.getAttrValueAsString(tag);\r\n    if ((group === TAG_IMAGE_INSTANCE_NUMBER[0]) && (element === TAG_IMAGE_INSTANCE_NUMBER[1])) {\r\n      this.m_newTagEvent.detail.imageNumber = parseInt(this.m_newTagEvent.detail.value, 10);\r\n    } else {\r\n      this.m_newTagEvent.detail.imageNumber = -1;\r\n    }\r\n    dispatchEvent(this.m_newTagEvent);\r\n  }\r\n\r\n  if (tag.isTransformSyntax()) {\r\n    const tagDataLen = tag.m_value.byteLength;\r\n    const dvTag = new DataView(tag.m_value);\r\n    const strTagVal = LoaderDicom.getStringAt(dvTag, 0, tagDataLen);\r\n    if (strTagVal === TRANSFER_SYNTAX_IMPLICIT_LITTLE) {\r\n      this.m_explicit = false;\r\n      this.m_littleEndian = true;\r\n    } else if (strTagVal === TRANSFER_SYNTAX_EXPLICIT_BIG) {\r\n      this.m_explicit = true;\r\n      this.m_littleEndian = false;\r\n    } else if (strTagVal === TRANSFER_SYNTAX_COMPRESSION_DEFLATE) {\r\n      this.m_needsDeflate = true;\r\n      this.m_explicit = true;\r\n      this.m_littleEndian = true;\r\n    } else if (strTagVal == TRANSFER_SYNTAX_COMPRESSION_JPEG) {\r\n      this.m_transformSyntax = TRANSFER_SYNTAX_COMPRESSION_JPEG;\r\n    } else if (strTagVal == TRANSFER_SYNTAX_COMPRESSION_JPEG_LOSSLESS_SEL1) {\r\n      this.m_transformSyntax = TRANSFER_SYNTAX_COMPRESSION_JPEG_LOSSLESS_SEL1;\r\n    } else if (strTagVal == TRANSFER_SYNTAX_COMPRESSION_JPEG_LOSSLESS) {\r\n      this.m_transformSyntax = TRANSFER_SYNTAX_COMPRESSION_JPEG_LOSSLESS;\r\n    } else if (strTagVal == TRANSFER_SYNTAX_COMPRESSION_JPEG_BASELINE_8BIT) {\r\n      this.m_transformSyntax = TRANSFER_SYNTAX_COMPRESSION_JPEG_BASELINE_8BIT;\r\n    } else if (strTagVal == TRANSFER_SYNTAX_COMPRESSION_JPEG_BASELINE_12BIT) {\r\n      this.m_transformSyntax = TRANSFER_SYNTAX_COMPRESSION_JPEG_BASELINE_12BIT;\r\n    } else if (strTagVal == TRANSFER_SYNTAX_COMPRESSION_JPEG_2000_LOSSLESS) {\r\n      this.m_transformSyntax = TRANSFER_SYNTAX_COMPRESSION_JPEG_2000_LOSSLESS;\r\n    } else if (strTagVal == TRANSFER_SYNTAX_COMPRESSION_JPEG_2000) {\r\n      this.m_transformSyntax = TRANSFER_SYNTAX_COMPRESSION_JPEG_2000;\r\n    } else if (strTagVal == TRANSFER_SYNTAX_COMPRESSION_RLE) {\r\n      this.m_transformSyntax = TRANSFER_SYNTAX_COMPRESSION_RLE;\r\n\r\n    } else {\r\n      this.m_explicit = true;\r\n      this.m_littleEndian = true;\r\n    }\r\n  } else if (tag.isMetaLength()) {\r\n    this.m_metaFinishedOffset = tag.m_value[0] + offset;\r\n  }\r\n  return tag;\r\n  } // getNextTag\r\n  static numberToHexString(val) {\r\n    const str = val.toString(16);\r\n    const len = str.length;\r\n    const numLeadZeros = 4 - len;\r\n    let strZeros = '';\r\n    for (let i = 0; i < numLeadZeros; i++) {\r\n      strZeros += '0';\r\n    }\r\n    const strRes = '0x' + strZeros + str;\r\n    return strRes;\r\n  }\r\n  readFromGoogleBuffer(i, fileName, ratioLoaded, arrBuf, callbackProgress, callbackComplete)\r\n  {\r\n    const dataView = new DataView(arrBuf);\r\n    let fileSize = dataView.byteLength;\r\n    // fileSize = (fileSize) & (~1);\r\n    // console.log(`readFromGoogleBuffer. fileSize = ${fileSize}`);\r\n    // fileSize = (fileSize <= 512) ? fileSize : 512;\r\n\r\n    // const strHeader = LoaderDicom.getStringAt(dataView, 0, 512);\r\n    // console.log(`readFromGoogleBuffer. header = ${strHeader}`);\r\n\r\n    const OFF_CONTENT_TYPE = 64;\r\n    const LEN_CONTENT_TYPE = 32;\r\n    const strCtx = LoaderDicom.getStringAt(dataView, OFF_CONTENT_TYPE, LEN_CONTENT_TYPE);\r\n    const STR_CTX_MATCH = 'Content-Type: application/dicom;';\r\n    const isEqCtxStr = (strCtx === STR_CTX_MATCH);\r\n    if (isEqCtxStr) {\r\n      const SIZE_GOOGLE_HEADER = 136;\r\n      const arrBufWoHead = arrBuf.slice(SIZE_GOOGLE_HEADER);\r\n      const dataViewWoGoogle = new DataView(arrBufWoHead);\r\n      const okRet = this.readFromBuffer(i, fileName, ratioLoaded, arrBufWoHead, callbackProgress, callbackComplete)\r\n      return okRet;\r\n    } else {\r\n      console.log(`readFromGoogleBuffer. bad content type = ${strCtx}`);\r\n      return LoadResult.BAD_HEADER;\r\n    }\r\n  }\r\n  /**\r\n  * Read from local file buffer\r\n  * @param {number} indexFile - index of slice loaded\r\n  * @param {string} fileName - Loaded file\r\n  * @param {number} ratioLoaded - ratio from 0 to 1.0.\r\n  * @param {object} arrBuf - source byte buffer, ArrayBuffer type\r\n  * @return LoadResult.XXX\r\n  */\r\n  readFromBuffer(indexFile, fileName, ratioLoaded, arrBuf, callbackProgress, callbackComplete) {\r\n    if (typeof indexFile !== 'number') {\r\n      console.log('LoaderDicom.readFromBuffer: bad indexFile argument');\r\n    }\r\n    if (typeof fileName !== 'string') {\r\n      console.log('LoaderDicom.readFromBuffer: bad fileName argument');\r\n    }\r\n    if (typeof arrBuf !== 'object') {\r\n      console.log('LoaderDicom.readFromBuffer: bad arrBuf argument');\r\n    }\r\n    // const bufBytes = new Uint8Array(arrBuf);\r\n    // const isUint8Arr = bufBytes instanceof Uint8Array;\r\n    // if (!isUint8Arr) {\r\n    //   console.log('LoaderDicom. readFromBuffer. Error read buffer');\r\n    //   return false;\r\n    // }\r\n\r\n    // console.log(`LoaderDicom. readFromBuffer. file = ${fileName}, ratio = ${ratioLoaded}`);\r\n\r\n    // add info\r\n    const dicomInfo = this.m_dicomInfo;\r\n    const sliceInfo = new DicomSliceInfo();\r\n    const strSlice = 'Slice ' + indexFile.toString();\r\n    sliceInfo.m_sliceName = strSlice;\r\n    sliceInfo.m_fileName = fileName;\r\n    sliceInfo.m_tags = [];\r\n    dicomInfo.m_sliceInfo.push(sliceInfo);\r\n\r\n    const dataView = new DataView(arrBuf);\r\n    if (dataView === null) {\r\n      console.log('No memory');\r\n      return LoadResult.ERROR_NO_MEMORY;\r\n    }\r\n    const fileSize = dataView.byteLength;\r\n    // check dicom header\r\n    const SIZE_HEAD = 144;\r\n    if (fileSize < SIZE_HEAD) {\r\n      // this.m_errors[indexFile] = DICOM_ERROR_TOO_SMALL_FILE;\r\n      this.m_error = LoadResult.ERROR_TOO_SMALL_DATA_SIZE;\r\n      if (callbackComplete !== undefined) {\r\n        callbackComplete(LoadResult.ERROR_TOO_SMALL_DATA_SIZE);\r\n      }\r\n      return LoadResult.ERROR_TOO_SMALL_DATA_SIZE;\r\n    }\r\n    const OFF_MAGIC = 128;\r\n    const SIZE_DWORD = 4;\r\n    const SIZE_SHORT = 2;\r\n    for (let i = 0; i < SIZE_DWORD; i++) {\r\n      const v = dataView.getUint8(OFF_MAGIC + i);\r\n      if (v !== MAGIC_DICM[i]) {\r\n        this.m_errors[indexFile] = DICOM_ERROR_WRONG_HEADER;\r\n        console.log(`Dicom readFromBuffer. Wrong header in file: ${fileName}`);\r\n        if (callbackComplete !== undefined) {\r\n          callbackComplete(LoadResult.WRONG_HEADER_MAGIC);\r\n        }\r\n        return LoadResult.WRONG_HEADER_MAGIC;\r\n      }\r\n    }\r\n    let offset = OFF_MAGIC;\r\n    offset += SIZE_DWORD;\r\n\r\n    //\r\n    this.m_littleEndian = true;\r\n    this.m_explicit = true;\r\n    this.m_metaFound = false;\r\n    this.m_metaFinished = false;\r\n    this.m_metaFinishedOffset = -1;\r\n    this.m_needsDeflate = false;\r\n\r\n    this.m_imageNumber = -1;\r\n    this.m_xDim = -1;\r\n    this.m_yDim = -1;\r\n    this.m_bitsPerPixel = -1;\r\n    this.m_windowCenter = -1;\r\n    this.m_windowWidth = -1;\r\n    let pixelBitMask = 0;\r\n    let pixelPaddingValue = 0;\r\n    let pixelsTagReaded = false;\r\n    let pixelMinValue = -1;\r\n    let pixelMaxValue = -1;\r\n\r\n    // read tag by tag, until image tag\r\n    let tag;\r\n    for (tag = this.getNextTag(dataView, offset); tag !== null;) {\r\n      if (tag.isPixelData()) {\r\n        pixelsTagReaded = true;\r\n        break;\r\n      }\r\n      offset = tag.m_offsetEnd;\r\n      tag = this.getNextTag(dataView, offset);\r\n      if (tag === null) {\r\n        break;\r\n      }\r\n\r\n      // add to tag info\r\n      const dicomInfo = this.m_dicomInfo;\r\n      const numlices = dicomInfo.m_sliceInfo.length;\r\n      const sliceInfo = dicomInfo.m_sliceInfo[numlices - 1];\r\n      const tagInfo = new DicomTagInfo();\r\n      tagInfo.m_tag = '(' + \r\n        LoaderDicom.numberToHexString(tag.m_group) + ',' + \r\n        LoaderDicom.numberToHexString(tag.m_element) + ')';\r\n      const strTagName = this.m_dictionary.getTextDesc(tag.m_group, tag.m_element);\r\n      tagInfo.m_attrName = (strTagName.length > 1) ? strTagName : '';\r\n\r\n      let strVal = LoaderDicom.getAttrValueAsString(tag);\r\n      strVal = (strVal !== null) ? strVal : '';\r\n\r\n      tagInfo.m_attrValue = strVal;\r\n      sliceInfo.m_tags.push(tagInfo);\r\n\r\n      // console.log(`Add tag info. tag = ${tagInfo.m_tag} atNa = ${tagInfo.m_attrName} atVal = ${tagInfo.m_attrValue} `);\r\n\r\n      // get important info from tag: image number\r\n      if ((tag.m_group === TAG_IMAGE_INSTANCE_NUMBER[0]) && (tag.m_element === TAG_IMAGE_INSTANCE_NUMBER[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const strNum = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        this.m_imageNumber = parseInt(strNum, 10) - 1;\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`Str = ${strNum}, ImageNumber = ${this.m_imageNumber}`);\r\n        }\r\n      }\r\n      // get important tag: image rows\r\n      if ((tag.m_group === TAG_IMAGE_ROWS[0]) && (tag.m_element === TAG_IMAGE_ROWS[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const yDim = (dataLen === SIZE_SHORT) ?\r\n          dv.getUint16(0, this.m_littleEndian) : dv.getUint32(0, this.m_littleEndian);\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`yDim = ${yDim}`);\r\n        }\r\n        if (this.m_yDim < 0) {\r\n          this.m_yDim = yDim;\r\n        } else if (this.m_yDim !== yDim) {\r\n          console.log('Bad image size y');\r\n          if (callbackComplete !== undefined) {\r\n            callbackComplete(LoadResult.WRONG_IMAGE_DIM_Y);\r\n          }\r\n          return LoadResult.WRONG_IMAGE_DIM_Y;\r\n        }\r\n      }\r\n      // get important tag: image cols\r\n      if ((tag.m_group === TAG_IMAGE_COLS[0]) && (tag.m_element === TAG_IMAGE_COLS[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const xDim = (dataLen === SIZE_SHORT) ?\r\n          dv.getUint16(0, this.m_littleEndian) : dv.getUint32(0, this.m_littleEndian);\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`xDim = ${xDim}`);\r\n        }\r\n        if (this.m_xDim < 0) {\r\n          this.m_xDim = xDim;\r\n        } else if (this.m_xDim !== xDim) {\r\n          console.log('Bad image size x');\r\n          if (callbackComplete !== undefined) {\r\n            callbackComplete(LoadResult.WRONG_IMAGE_DIM_X);\r\n          }\r\n          return LoadResult.WRONG_IMAGE_DIM_X;\r\n        }\r\n      }\r\n      // get important tag: bits allocated\r\n      if ((tag.m_group === TAG_BITS_ALLOCATED[0]) && (tag.m_element === TAG_BITS_ALLOCATED[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_bitsPerPixel = (dataLen === SIZE_SHORT) ?\r\n          dv.getUint16(0, this.m_littleEndian) : dv.getUint32(0, this.m_littleEndian);\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`bitsPerPixel = ${this.m_bitsPerPixel}`);\r\n        }\r\n      }\r\n\r\n      // window center\r\n      if ((tag.m_group === TAG_WINDOW_CENTER[0]) && (tag.m_element === TAG_WINDOW_CENTER[1])) {\r\n        if ((tag.m_value != null) && (tag.m_value.byteLength > 0)) {\r\n          const dataLen = tag.m_value.byteLength;\r\n          const dv = new DataView(tag.m_value);\r\n          const strNum = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n          this.m_windowCenter = parseInt(strNum, 10);\r\n          if (DEBUG_PRINT_TAGS_INFO) {\r\n            console.log(`Str = ${strNum}, WindowCenter = ${this.m_windowCenter}`);\r\n          }\r\n        } // if non zero data\r\n      } // window center\r\n      \r\n      // window width\r\n      if ((tag.m_group === TAG_WINDOW_WIDTH[0]) && (tag.m_element === TAG_WINDOW_WIDTH[1])) {\r\n        if ((tag.m_value != null) && (tag.m_value.byteLength > 0)) {\r\n          const dataLen = tag.m_value.byteLength;\r\n          const dv = new DataView(tag.m_value);\r\n          const strNum = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n          this.m_windowWidth = parseInt(strNum, 10);\r\n          if (DEBUG_PRINT_TAGS_INFO) {\r\n            console.log(`Str = ${strNum}, WindowWidth = ${this.m_windowWidth}`);\r\n          }\r\n        } // if non zero data\r\n      } // window width\r\n\r\n      // rescale intercept\r\n      if ((tag.m_group === TAG_RESCALE_INTERCEPT[0]) && (tag.m_element === TAG_RESCALE_INTERCEPT[1])) {\r\n        if ((tag.m_value != null) && (tag.m_value.byteLength > 0)) {\r\n          const dataLen = tag.m_value.byteLength;\r\n          const dv = new DataView(tag.m_value);\r\n          const strNum = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n          this.m_rescaleIntercept = parseInt(strNum, 10);\r\n          if (DEBUG_PRINT_TAGS_INFO) {\r\n            console.log(`Str = ${strNum}, RescaleIntercept = ${this.m_rescaleIntercept}`);\r\n          }\r\n        } // if non zero data\r\n      } // rescale intercept\r\n\r\n      // rescale slope\r\n      if ((tag.m_group === TAG_RESCALE_SLOPE[0]) && (tag.m_element === TAG_RESCALE_SLOPE[1])) {\r\n        if ((tag.m_value != null) && (tag.m_value.byteLength > 0)) {\r\n          const dataLen = tag.m_value.byteLength;\r\n          const dv = new DataView(tag.m_value);\r\n          const strNum = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n          this.m_rescaleSlope = parseInt(strNum, 10);\r\n          if (DEBUG_PRINT_TAGS_INFO) {\r\n            console.log(`Str = ${strNum}, RescaleSlope = ${this.m_rescaleSlope}`);\r\n          }\r\n        } // if non zero data\r\n      } // rescale slope\r\n\r\n      // rescale type\r\n      if ((tag.m_group === TAG_RESCALE_TYPE[0]) && (tag.m_element === TAG_RESCALE_TYPE[1])) {\r\n        if ((tag.m_value != null) && (tag.m_value.byteLength > 0)) {\r\n          const dataLen = tag.m_value.byteLength;\r\n          const dv = new DataView(tag.m_value);\r\n          const strVal = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n          if (strVal === 'HU') {\r\n            this.m_rescaleHounsfield = true;  \r\n          }\r\n          if (DEBUG_PRINT_TAGS_INFO) {\r\n            console.log(`Str = ${strNum}, RescaleType = ${this.m_rescaleHounsfield}`);\r\n          }\r\n        } // if non zero data\r\n      } // rescale type\r\n\r\n      // pixel representation\r\n      if ((tag.m_group === TAG_PIXEL_REPRESENTATION[0]) && (tag.m_element === TAG_PIXEL_REPRESENTATION[1])) {\r\n        if ((tag.m_value != null) && (tag.m_value.byteLength > 0)) {\r\n          const dataLenPixRep = tag.m_value.byteLength;\r\n          const dvPixRep = new DataView(tag.m_value);\r\n          const pixRep = (dataLenPixRep === SIZE_SHORT) ?\r\n            dvPixRep.getUint16(0, this.m_littleEndian) : dvPixRep.getUint32(0, this.m_littleEndian);\r\n          if (pixRep === 1) {\r\n            this.m_pixelRepresentaionSigned = true;\r\n          }\r\n          if (DEBUG_PRINT_TAGS_INFO) {\r\n            console.log(`Str = ${strNum}, Pixel representation is signed = ${this.m_pixelRepresentaionSigned}`);\r\n          }\r\n        } // if non zero data\r\n      } // rescale slope\r\n\r\n      // get series number\r\n      if ((tag.m_group === TAG_SERIES_NUMBER[0]) && (tag.m_element === TAG_SERIES_NUMBER[1])) {\r\n        if ((tag.m_value != null) && (tag.m_value.byteLength > 0)) {\r\n          const dataLen = tag.m_value.byteLength;\r\n          const dv = new DataView(tag.m_value);\r\n          const strNum = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n          this.m_seriesNumber = parseInt(strNum, 10);\r\n          if (DEBUG_PRINT_TAGS_INFO) {\r\n            console.log(`Str = ${strNum}, SeriesNumber = ${this.m_seriesNumber}`);\r\n          }\r\n        } // if non zero data\r\n      } // series number\r\n\r\n      // get important tag: series description\r\n      if ((tag.m_group === TAG_SERIES_DESCRIPTION[0]) && (tag.m_element === TAG_SERIES_DESCRIPTION[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_seriesDescr = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`Series description = ${this.m_seriesDescr}`);\r\n        }\r\n      }\r\n      // get important tag: hight bit\r\n      if ((tag.m_group === TAG_IMAGE_HIGH_BIT[0]) && (tag.m_element === TAG_IMAGE_HIGH_BIT[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const highBit = (dataLen === SIZE_SHORT) ?\r\n          dv.getUint16(0, this.m_littleEndian) : dv.getUint32(0, this.m_littleEndian);\r\n        pixelBitMask = (1 << (highBit + 1)) - 1;\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`highBit = ${highBit}`);\r\n        }\r\n      }\r\n\r\n      // get important tag: min pixel value\r\n      if ((tag.m_group === TAG_IMAGE_SMALL_PIX_VAL[0]) && (tag.m_element === TAG_IMAGE_SMALL_PIX_VAL[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        pixelMinValue = (dataLen === SIZE_SHORT) ?\r\n          dv.getInt16(0, this.m_littleEndian) : dv.getInt32(0, this.m_littleEndian);\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`pixelMinValue = ${pixelMinValue}`);\r\n        }\r\n      }\r\n\r\n      // get important tag: max pixel value\r\n      if ((tag.m_group === TAG_IMAGE_LARGE_PIX_VAL[0]) && (tag.m_element === TAG_IMAGE_LARGE_PIX_VAL[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        pixelMaxValue = (dataLen === SIZE_SHORT) ?\r\n          dv.getInt16(0, this.m_littleEndian) : dv.getInt32(0, this.m_littleEndian);\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`pixelMaxValue = ${pixelMaxValue}`);\r\n        }\r\n      }\r\n\r\n      // get important tag: pixel padding value\r\n      if ((tag.m_group === TAG_PIXEL_PADDING_VALUE[0]) && (tag.m_element === TAG_PIXEL_PADDING_VALUE[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        pixelPaddingValue = (dataLen === SIZE_SHORT) ?\r\n          dv.getUint16(0, this.m_littleEndian) : dv.getUint32(0, this.m_littleEndian);\r\n        this.m_padValue = pixelPaddingValue;\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`pixelPaddingValue = ${pixelPaddingValue}`);\r\n        }\r\n      }\r\n      // get important tag: pixel spacing in 2d (xy)\r\n      if ((tag.m_group === TAG_PIXEL_SPACING[0]) && (tag.m_element === TAG_PIXEL_SPACING[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const strPixelSpacing = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        const strArr = strPixelSpacing.split('\\\\');\r\n        if (strArr.length === SIZE_SHORT) {\r\n          this.m_pixelSpacing.x = parseFloat(strArr[0]);\r\n          this.m_pixelSpacing.y = parseFloat(strArr[1]);\r\n          if (DEBUG_PRINT_TAGS_INFO) {\r\n            console.log(`TAG. pixel spacing xy = ${this.m_pixelSpacing.x} * ${this.m_pixelSpacing.y}`);\r\n          }\r\n        }\r\n      }\r\n      // get important tag: image position (x,y,z)\r\n      if ((tag.m_group === TAG_IMAGE_POSITION[0]) && (tag.m_element === TAG_IMAGE_POSITION[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const strImagePosition = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        const strArr = strImagePosition.split('\\\\');\r\n        const NUM_COMPONENTS_3 = 3;\r\n        if (strArr.length === NUM_COMPONENTS_3) {\r\n          // eslint-disable-next-line\r\n          const xPos = parseFloat(strArr[0]);\r\n          // eslint-disable-next-line\r\n          const yPos = parseFloat(strArr[1]);\r\n          // eslint-disable-next-line\r\n          const zPos = parseFloat(strArr[2]);\r\n          this.m_imagePosMin.x = (xPos < this.m_imagePosMin.x) ? xPos : this.m_imagePosMin.x;\r\n          this.m_imagePosMin.y = (yPos < this.m_imagePosMin.y) ? yPos : this.m_imagePosMin.y;\r\n          this.m_imagePosMin.z = (zPos < this.m_imagePosMin.z) ? zPos : this.m_imagePosMin.z;\r\n          this.m_imagePosMax.x = (xPos > this.m_imagePosMax.x) ? xPos : this.m_imagePosMax.x;\r\n          this.m_imagePosMax.y = (yPos > this.m_imagePosMax.y) ? yPos : this.m_imagePosMax.y;\r\n          this.m_imagePosMax.z = (zPos > this.m_imagePosMax.z) ? zPos : this.m_imagePosMax.z;\r\n          if (DEBUG_PRINT_TAGS_INFO) {\r\n            console.log(`TAG. image position x,y,z = ${xPos}, ${yPos}, ${zPos}`);\r\n          }\r\n        }\r\n      }\r\n\r\n      // slice thickness\r\n      if ((tag.m_group === TAG_SLICE_THICKNESS[0]) && (tag.m_element === TAG_SLICE_THICKNESS[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const strSliceThickness = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        this.m_pixelSpacing.z = parseFloat(strSliceThickness);\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`TAG. slice thickness = ${this.m_pixelSpacing.z}`);\r\n        }\r\n      }\r\n\r\n      // get important tag: slice location (x,y,z)\r\n      if ((tag.m_group === TAG_SLICE_LOCATION[0]) && (tag.m_element === TAG_SLICE_LOCATION[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const strSliceLocation = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        const sliceLoc = parseFloat(strSliceLocation);\r\n        this.m_sliceLocation = sliceLoc;\r\n        this.m_sliceLocMin = (sliceLoc < this.m_sliceLocMin) ? sliceLoc : this.m_sliceLocMin;\r\n        this.m_sliceLocMax = (sliceLoc > this.m_sliceLocMax) ? sliceLoc : this.m_sliceLocMax;\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`TAG. Slice location = ${this.m_sliceLocation}`);\r\n        }\r\n      }\r\n\r\n      // get important tag: samples per pixel\r\n      if ((tag.m_group === TAG_SAMPLES_PER_PIXEL[0]) && (tag.m_element === TAG_SAMPLES_PER_PIXEL[1])) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_samplesPerPixel = (dataLen === SIZE_SHORT) ?\r\n          dv.getUint16(0, this.m_littleEndian) : dv.getUint32(0, this.m_littleEndian);\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`samplesPerPixel = ${this.m_samplesPerPixel}`);\r\n        }\r\n      }\r\n\r\n      // dicom info\r\n      if ((tag.m_group === TAG_SERIES_DESCRIPTION[0]) && (tag.m_element === TAG_SERIES_DESCRIPTION[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const strDescr = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        // console.log(`DicomLoader. Series descr read = ${strDescr}`);\r\n        this.m_dicomInfo.m_seriesDescr = strDescr;\r\n      }\r\n      if ((tag.m_group === TAG_SERIES_TIME[0]) && (tag.m_element === TAG_SERIES_TIME[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const strTimeMerged = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        // eslint-disable-next-line\r\n        const strHour = strTimeMerged.substring(0, 2);\r\n        // eslint-disable-next-line\r\n        const strMinute = strTimeMerged.substring(2, 4);\r\n        // eslint-disable-next-line\r\n        const strSec = strTimeMerged.substring(4, strTimeMerged.length);\r\n        const strTimeBuild = `${strHour}:${strMinute}:${strSec}`;\r\n        // console.log(`Series time read = ${strTimeBuild}`);\r\n        this.m_dicomInfo.m_seriesTime = strTimeBuild;\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`Series time = ${this.m_dicomInfo.m_seriesTime}`);\r\n        }\r\n      }\r\n      if ((tag.m_group === TAG_PATIENT_NAME[0]) && (tag.m_element === TAG_PATIENT_NAME[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_dicomInfo.m_patientName = LoaderDicom.getUtf8StringAt(dv, 0, dataLen);\r\n        this.m_dicomInfo.m_patientName = this.m_dicomInfo.m_patientName.trim();\r\n        //console.log(`m_patientName = ${this.m_dicomInfo.m_patientName}`);\r\n      }\r\n      if ((tag.m_group === TAG_PATIENT_ID[0]) && (tag.m_element === TAG_PATIENT_ID[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_dicomInfo.m_patientId = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        // console.log(`m_patientId = ${this.m_dicomInfo.m_patientId}`);\r\n      }\r\n      if ((tag.m_group === TAG_PATIENT_GENDER[0]) && (tag.m_element === TAG_PATIENT_GENDER[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_dicomInfo.m_patientGender = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        // console.log(`m_patientGender = ${this.m_dicomInfo.m_patientGender}`);\r\n      }\r\n      if ((tag.m_group === TAG_PATIENT_BIRTH_DATE[0]) && (tag.m_element === TAG_PATIENT_BIRTH_DATE[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const strDateMerged = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        // eslint-disable-next-line\r\n        const strY = strDateMerged.substring(0, 4);\r\n        // eslint-disable-next-line\r\n        const strM = strDateMerged.substring(4, 6);\r\n        // eslint-disable-next-line\r\n        const strD = strDateMerged.substring(6);\r\n        this.m_dicomInfo.m_patientDateOfBirth = `${strD}/${strM}/${strY}`;\r\n        // console.log(`m_patientDateOfBirth = ${this.m_dicomInfo.m_patientDateOfBirth}`);\r\n      }\r\n      if ((tag.m_group === TAG_STUDY_DATE[0]) && (tag.m_element === TAG_STUDY_DATE[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const strDateMerged = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        // eslint-disable-next-line\r\n        const strY = strDateMerged.substring(0, 4);\r\n        // eslint-disable-next-line\r\n        const strM = strDateMerged.substring(4, 6);\r\n        // eslint-disable-next-line\r\n        const strD = strDateMerged.substring(6);\r\n        this.m_dicomInfo.m_studyDate = `${strD}/${strM}/${strY}`;\r\n        // console.log(`m_studyDate = ${this.m_dicomInfo.m_studyDate}`);\r\n      }\r\n      if ((tag.m_group === TAG_STUDY_DESCR[0]) && (tag.m_element === TAG_STUDY_DESCR[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        const strDescr = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        this.m_dicomInfo.m_studyDescr = strDescr;\r\n        this.m_dicomInfo.m_studyDescr = this.m_dicomInfo.m_studyDescr.trim();\r\n        // console.log(`m_studyDescr = ${this.m_dicomInfo.m_studyDescr}`);\r\n      }\r\n      if ((tag.m_group === TAG_BODY_PART_EXAMINED[0]) && (tag.m_element === TAG_BODY_PART_EXAMINED[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_dicomInfo.m_bodyPartExamined = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        // console.log(`m_patientName = ${this.m_dicomInfo.m_patientName}`);\r\n      }\r\n\r\n\r\n      if ((tag.m_group === TAG_ACQUISION_TIME[0]) && (tag.m_element === TAG_ACQUISION_TIME[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_dicomInfo.m_acquisionTime = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        // console.log(`m_acquisionTime = ${this.m_dicomInfo.m_acquisionTime}`);\r\n      }\r\n      if ((tag.m_group === TAG_INSTITUTION_NAME[0]) && (tag.m_element === TAG_INSTITUTION_NAME[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_dicomInfo.m_institutionName = LoaderDicom.getUtf8StringAt(dv, 0, dataLen);\r\n        this.m_dicomInfo.m_institutionName = this.m_dicomInfo.m_institutionName.trim();\r\n        // console.log(`m_institutionName = ${this.m_dicomInfo.m_institutionName}`);\r\n      }\r\n\r\n      if ((tag.m_group === TAG_OPERATORS_NAME[0]) && (tag.m_element === TAG_OPERATORS_NAME[1]) &&\r\n      (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_dicomInfo.m_operatorsName = LoaderDicom.getUtf8StringAt(dv, 0, dataLen);\r\n        this.m_dicomInfo.m_operatorsName = this.m_dicomInfo.m_operatorsName.trim();\r\n        // console.log(`m_operatorsName = ${this.m_dicomInfo.m_operatorsName}`);\r\n      }\r\n      if ((tag.m_group === TAG_PHYSICANS_NAME[0]) && (tag.m_element === TAG_PHYSICANS_NAME[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_dicomInfo.m_physicansName = LoaderDicom.getUtf8StringAt(dv, 0, dataLen);\r\n        this.m_dicomInfo.m_physicansName = this.m_dicomInfo.m_physicansName.trim();\r\n        // console.log(`m_physicansName = ${this.m_dicomInfo.m_physicansName}`);\r\n      }\r\n      if ((tag.m_group === TAG_MANUFACTURER_NAME[0]) && (tag.m_element === TAG_MANUFACTURER_NAME[1]) &&\r\n        (tag.m_value !== null)) {\r\n        const dataLen = tag.m_value.byteLength;\r\n        const dv = new DataView(tag.m_value);\r\n        this.m_dicomInfo.m_manufacturerName = LoaderDicom.getStringAt(dv, 0, dataLen);\r\n        this.m_dicomInfo.m_manufacturerName = this.m_dicomInfo.m_manufacturerName.trim();\r\n        // console.log(`m_manufacturerName = ${this.m_dicomInfo.m_manufacturerName}`);\r\n      }\r\n    } // for all tags readed\r\n    if (!pixelsTagReaded) {\r\n      if (callbackComplete !== undefined) {\r\n        callbackComplete(LoadResult.ERROR_PIXELS_TAG_NOT_FOUND);\r\n      }\r\n      return LoadResult.ERROR_PIXELS_TAG_NOT_FOUND;\r\n    }\r\n    // check transform syntax\r\n    if (this.m_transformSyntax.length > 1) {\r\n      // const decoder = new jpeg.lossless.Decoder();\r\n      // const outBuffer = decoder.decompress(tag.m_value);\r\n      if (callbackComplete !== undefined) {\r\n        callbackComplete(LoadResult.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED);\r\n      }\r\n      return LoadResult.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED;\r\n    }\r\n\r\n    // check correct data from tags\r\n    const BITS_IN_BYTE = 8;\r\n    const imageSizeBytes = Math.floor(this.m_xDim * this.m_yDim * (this.m_bitsPerPixel / BITS_IN_BYTE) * this.m_samplesPerPixel);\r\n    if ((imageSizeBytes !== tag.m_value.byteLength) || (pixelBitMask === 0)) {\r\n      console.log(`Wrong image pixels size. Readed ${tag.m_value.byteLength}, but expected ${imageSizeBytes}`);\r\n      if (callbackComplete !== undefined) {\r\n        callbackComplete(LoadResult.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED);\r\n      }\r\n      return LoadResult.WRONG_HEADER_DATA_SIZE;\r\n    }\r\n\r\n    const numPixels = this.m_xDim * this.m_yDim;\r\n    // const volSlice = this.m_slicesVolume.getNewSlice();\r\n    const volSlice = new DicomSlice();\r\n    if (volSlice === null) {\r\n      console.log('No memory');\r\n      return LoadResult.ERROR_NO_MEMORY;\r\n    }\r\n\r\n    if (this.m_pixelRepresentaionSigned) {\r\n      volSlice.m_image = new Int16Array(numPixels);\r\n    } else {\r\n      volSlice.m_image = new Uint16Array(numPixels);\r\n    }\r\n    if (volSlice.m_image === null) {\r\n      console.log('No memory');\r\n      return LoadResult.ERROR_NO_MEMORY;\r\n    }\r\n    volSlice.m_sliceNumber = this.m_imageNumber;\r\n    volSlice.m_sliceLocation = this.m_sliceLocation;\r\n    volSlice.m_patientName = this.m_dicomInfo.m_patientName;\r\n    volSlice.m_studyDescr = this.m_dicomInfo.m_studyDescr;\r\n    volSlice.m_studyDate = this.m_dicomInfo.m_studyDate;\r\n    volSlice.m_seriesTime = this.m_dicomInfo.m_seriesTime;\r\n    volSlice.m_seriesDescr = this.m_dicomInfo.m_seriesDescr;\r\n    volSlice.m_bodyPartExamined = this.m_dicomInfo.m_bodyPartExamined;\r\n    volSlice.m_institutionName = this.m_dicomInfo.m_institutionName;\r\n    volSlice.m_operatorsName = this.m_dicomInfo.m_operatorsName;\r\n    volSlice.m_physicansName = this.m_dicomInfo.m_physicansName;\r\n    volSlice.buildHash();\r\n\r\n    volSlice.m_xDim = this.m_xDim;\r\n    volSlice.m_yDim = this.m_yDim;\r\n\r\n    // console.log(`patName = ${volSlice.m_patientName}`);\r\n    // console.log(`studyDescr = ${volSlice.m_studyDescr}`);\r\n    // console.log(`studyDate = ${volSlice.m_studyDate}`);\r\n    // console.log(`seriesTime = ${volSlice.m_seriesTime}`);\r\n    // console.log(`seriesDescr = ${volSlice.m_seriesDescr}`);\r\n    // console.log(`bodyPartExamined = ${volSlice.m_bodyPartExamined}`);\r\n\r\n    \r\n\r\n    // Fill slice image\r\n    // const imageDst = this.m_slices[this.m_imageNumber];\r\n    const imageDst = volSlice.m_image;\r\n    const imageSrc = new DataView(tag.m_value);\r\n    if (imageSrc === null) {\r\n      console.log('No memory');\r\n      return LoadResult.ERROR_NO_MEMORY;\r\n    }\r\n\r\n    const BITS_8 = 8;\r\n    const BITS_16 = 16;\r\n    const NUM_1 = 1;\r\n    const NUM_3 = 3;\r\n\r\n    let i;\r\n    if (this.m_bitsPerPixel === BITS_8) {\r\n      if (this.m_samplesPerPixel === NUM_1) {\r\n        for (i = 0; i < numPixels; i++) {\r\n          const val = imageSrc.getUint8(i);\r\n          imageDst[i] = val;\r\n        }\r\n          // if 1 sample per pixel\r\n      } else if (this.m_samplesPerPixel === NUM_3) {\r\n        // if 3 samples per pixel\r\n        let j = 0;\r\n        for (i = 0; i < numPixels; i++, j += 3) {\r\n          const b0 = imageSrc.getUint8(j + 0);\r\n          const b1 = imageSrc.getUint8(j + 1);\r\n          const b2 = imageSrc.getUint8(j + 2);\r\n          // assert(b0 < 256);\r\n          // assert(b1 < 256);\r\n          // assert(b2 < 256);\r\n          imageDst[i] = Math.floor((b0 + b1 + b2) / 3);\r\n        }\r\n      }\r\n    } else if (this.m_bitsPerPixel === BITS_16) {\r\n      let i2 = 0;\r\n      for (i = 0; i < numPixels; i++) {\r\n        let val = imageSrc.getUint16(i2, this.m_littleEndian);\r\n        i2 += SIZE_SHORT;\r\n        imageDst[i] = val;\r\n      } // end for i pixels\r\n    } else { // if 16 bpp\r\n      console.log('TODO: need to implement reading non-8 and non-16 bit dicom images');\r\n    }\r\n    this.m_error = DICOM_ERROR_OK;\r\n\r\n    // add volume slice to slices volume (and manage series)\r\n    this.m_slicesVolume.addSlice(volSlice);\r\n\r\n    // console.log(`Dicom read OK. Volume pixels = ${this.m_xDim} * ${this.m_yDim} * ${this.m_zDim}`);\r\n    if (callbackComplete !== undefined) {\r\n      callbackComplete(LoadResult.SUCCESS);\r\n    }\r\n    return LoadResult.SUCCESS;\r\n  } // end readFromBuffer\r\n\r\n  readFromUrl(volSet, strUrl, callbackProgress, callbackComplete) {\r\n    // check arguments\r\n    console.assert(volSet != null, \"Null volume\");\r\n    console.assert(volSet instanceof VolumeSet, \"Should be volume set\");\r\n    console.assert(strUrl != null, \"Null string url\");\r\n    \r\n    // console.log(`typeof(strUrl) - ${typeof(strUrl)}`);\r\n    console.assert(typeof(strUrl) === 'string', \"Should be string in url\");\r\n    \r\n    // replace file name to 'file_list.txt'\r\n    const ft = new FileTools();\r\n    const isValidUrl = ft.isValidUrl(strUrl);\r\n    if (!isValidUrl) {\r\n      console.log(`readFromUrl: not vaild URL = = ${strUrl} `);\r\n      return false;\r\n    }\r\n    this.m_folder = ft.getFolderNameFromUrl(strUrl);\r\n    const urlFileList = this.m_folder + '/file_list.txt';\r\n    console.log(`readFromUrl: load file = ${urlFileList} `);\r\n\r\n    const fileLoader = new FileLoader(urlFileList);\r\n    this.m_callbackComplete = callbackComplete;\r\n    this.m_callbackProgress = callbackProgress;\r\n    this.m_fileListCounter = 0;\r\n    fileLoader.readFile((arrBuf) => {\r\n      this.m_fileListCounter += 1;\r\n      if (this.m_fileListCounter === 1) {\r\n        const okRead = this.readReadyFileList(volSet, arrBuf, callbackProgress, callbackComplete);\r\n        return okRead;\r\n      }\r\n      return true;\r\n    }, (errMsg) => {\r\n      console.log(`Error read file: ${errMsg}`);\r\n      callbackComplete(LoadResult.ERROR_CANT_OPEN_URL, null, 0, null);\r\n      return false;\r\n    }); // get file from server\r\n    return true;\r\n  }\r\n  readReadyFileList(volSet, arrBuf, callbackProgress, callbackComplete) {\r\n    // check arguments\r\n    console.assert(volSet != null, \"Null volume\");\r\n    console.assert(volSet instanceof VolumeSet, \"Should be volume set\");\r\n    console.assert(arrBuf != null, \"Null array\");\r\n    console.assert(arrBuf.constructor.name === \"ArrayBuffer\", \"Should be ArrayBuf in arrBuf\");\r\n\r\n    const uint8Arr = new Uint8Array(arrBuf);\r\n    // const strFileContent = new TextDecoder('utf-8').decode(uint8Arr);\r\n    const strFileContent = String.fromCharCode.apply(null, uint8Arr);\r\n\r\n    const LEN_LOG = 64;\r\n    const strLog = strFileContent.substr(0, LEN_LOG);\r\n    console.log(`Loaded file list. Started with:  ${strLog} ...`);\r\n\r\n    const arrFileNames = strFileContent.split('\\n');\r\n\r\n    let numFiles = arrFileNames.length;\r\n    // check last empty elements\r\n    const MIN_FILE_NAME_SIZE = 4;\r\n    for (let i = numFiles - 1; i >= 0; i--) {\r\n      if (arrFileNames[i].endsWith('\\r')) {\r\n        arrFileNames[i] = arrFileNames[i].substring(0, arrFileNames[i].length - 1);\r\n      }\r\n      if (arrFileNames[i].length < MIN_FILE_NAME_SIZE) {\r\n        arrFileNames.pop();\r\n      }\r\n    }\r\n    numFiles = arrFileNames.length;\r\n\r\n    this.m_zDim = numFiles;\r\n    console.log(`Loaded file list. ${numFiles} files will be loaded. 1st file in list is = ${arrFileNames[0]}`);\r\n    console.log(`Loaded file list. Last file in list is = ${arrFileNames[numFiles - 1]}`);\r\n\r\n    // declare slices array\r\n    for (let i = 0; i < numFiles; i++) {\r\n      // this.m_slices[i] = null;\r\n      this.m_errors[i] = -1;\r\n      this.m_loaders[i] = null;\r\n    }\r\n\r\n    // physical dimension\r\n    this.m_pixelSpacing = {\r\n      x: 0.0,\r\n      y: 0.0,\r\n      z: 0.0,\r\n    };\r\n    this.m_filesLoadedCounter = 0;\r\n    this.m_numFailsLoad = 0;\r\n    this.m_numLoadedFiles = numFiles;\r\n\r\n    this.m_imagePosMin = {\r\n      // eslint-disable-next-line\r\n      x: +1.0e12,\r\n      // eslint-disable-next-line\r\n      y: +1.0e12,\r\n      // eslint-disable-next-line\r\n      z: +1.0e12\r\n    };\r\n    this.m_imagePosMax = {\r\n      // eslint-disable-next-line\r\n      x: -1.0e12,\r\n      // eslint-disable-next-line\r\n      y: -1.0e12,\r\n      // eslint-disable-next-line\r\n      z: -1.0e12\r\n    };\r\n\r\n    // eslint-disable-next-line\r\n    this.m_sliceLocMin = +1.0e12;\r\n    // eslint-disable-next-line\r\n    this.m_sliceLocMax = -1.0e12;\r\n\r\n    for (let i = 0; (i < this.m_numLoadedFiles) && (this.m_numFailsLoad < 1); i++) {\r\n      const urlFile = `${this.m_folder}/${arrFileNames[i]}`;\r\n      // console.log(`Loading (${i})-th url: ${urlFile}`);\r\n      this.m_loaders[i] = new FileLoader(urlFile);\r\n      const loader = this.m_loaders[i];\r\n      const NOT_FROM_GOOGLE = false;\r\n      // let volDst = volSet.getVolume(0);\r\n      //if (volDst === null) {\r\n      //  volDst = new Volume();\r\n      //  volSet.addVolume(volDst);\r\n      // } \r\n      const okLoader = this.runLoader(volSet, arrFileNames[i], loader, i, callbackProgress, callbackComplete, NOT_FROM_GOOGLE);\r\n      if (!okLoader) {\r\n        return false;\r\n      }\r\n    }  // for i all files-slices in folder\r\n    return true;\r\n  } // end readReadyFileList(arrBuf)\r\n  /**\r\n  * Run loader to read dicom file\r\n  * @param {object} volSet - destination volum set\r\n  * @param {string} fileName - File to read\r\n  * @param {object} loader - loader object with file inside\r\n  * @param {number} i - index of file in files array\r\n  * @param {func} callbackProgress - callback for continiuos load reporting\r\n  * @param {func} callbackComplete - callback after load finish\r\n  * @param {bool} fromGoogle - true, if from google store\r\n  *\r\n  */\r\n  runLoader(volSet, fileName, loader, i, callbackProgress, callbackComplete, fromGoogle) {\r\n    this.m_fromGoogle = fromGoogle;\r\n    // console.log(`Loading url: ${fileName}`);\r\n    loader.readFile((fileArrBu) => {\r\n      const ratioLoaded = this.m_filesLoadedCounter / this.m_numLoadedFiles;\r\n      const VAL_MASK = 7;\r\n      if ((callbackProgress !== undefined) && ((this.m_filesLoadedCounter & VAL_MASK) === 0)) {\r\n        callbackProgress(ratioLoaded);\r\n      }\r\n      if ((callbackProgress !== undefined) &&\r\n        (this.m_filesLoadedCounter + 1 === this.m_numLoadedFiles)) {\r\n        callbackProgress(1.0);\r\n      }\r\n      this.m_newTagEvent.detail.fileName = fileName;\r\n\r\n      let status;\r\n      if (this.m_fromGoogle) {\r\n        status = this.readFromGoogleBuffer(i, fileName, ratioLoaded, fileArrBu, callbackProgress, callbackComplete);\r\n      } else {\r\n        status = this.readFromBuffer(i, fileName, ratioLoaded, fileArrBu, callbackProgress, callbackComplete);\r\n      }\r\n\r\n      if ((status !== LoadResult.SUCCESS) && (this.m_numFailsLoad === 0)) {\r\n        this.m_numFailsLoad += 1;\r\n        if (callbackComplete !== null) {\r\n          callbackComplete(status, null, 0, null, fileName);\r\n          return false;\r\n        }\r\n      }\r\n      // update total files counter\r\n      this.m_filesLoadedCounter += 1;\r\n      if (DEBUG_PRINT_INDI_SLICE_INFO) {\r\n        console.log(`Loaded local indi slice: ${fileName}. Total loaded slices: ${this.m_filesLoadedCounter}`);\r\n      }\r\n      // console.log(`!!!!!!!!! m_filesLoadedCounter = ${this.m_filesLoadedCounter} / ${this.m_numLoadedFiles}`);\r\n\r\n      if (this.m_filesLoadedCounter === this.m_numLoadedFiles) {\r\n        // Finalize physic dimension\r\n        if (DEBUG_PRINT_TAGS_INFO) {\r\n          console.log(`slice location (min, max) = ${this.m_sliceLocMin}, ${this.m_sliceLocMax}`);\r\n        }\r\n        const imagePosBox = {\r\n          x: this.m_imagePosMax.x - this.m_imagePosMin.x,\r\n          y: this.m_imagePosMax.y - this.m_imagePosMin.y,\r\n          z: this.m_imagePosMax.z - this.m_imagePosMin.z\r\n        };\r\n        const TOO_MIN = 0.00001;\r\n        let zBox;\r\n        if (Math.abs(this.m_pixelSpacing.z) > TOO_MIN) {\r\n          zBox = this.m_pixelSpacing.z * this.m_zDim;\r\n        } else {\r\n          zBox = imagePosBox.z;\r\n          if (Math.abs(zBox) < TOO_MIN) {\r\n            zBox = imagePosBox.x;\r\n            if (Math.abs(zBox) < TOO_MIN) {\r\n              zBox = imagePosBox.y;\r\n            }\r\n          }\r\n        } // if pixel spacing 0\r\n        if (zBox < TOO_MIN) {\r\n          zBox = 1.0;\r\n        }\r\n\r\n        this.m_pixelSpacing.z = zBox / this.m_zDim;\r\n        this.m_boxSize.z = this.m_zDim * this.m_pixelSpacing.z;\r\n        this.m_boxSize.x = this.m_xDim * this.m_pixelSpacing.x;\r\n        this.m_boxSize.y = this.m_yDim * this.m_pixelSpacing.y;\r\n        console.log(`Volume local phys dim: ${this.m_boxSize.x} * ${this.m_boxSize.y} * ${this.m_boxSize.z}`);\r\n        // TODO: add hash\r\n        let series = this.m_slicesVolume.getSeries();\r\n        if (series.length === 0) {\r\n          this.m_slicesVolume.buildSeriesInfo();\r\n          series = this.m_slicesVolume.getSeries();\r\n        }\r\n        const indexSerie = 0;\r\n        const hash = series[indexSerie].m_hash;\r\n        const errStatus = this.createVolumeFromSlices(volSet, indexSerie,  hash);\r\n        if (callbackComplete !== null) {\r\n          callbackComplete(errStatus);\r\n          return true;\r\n        }\r\n      } // if last file was loaded\r\n      return true;\r\n    }, (errMsg) => {\r\n      console.log(`Error read file: ${errMsg}`);\r\n      return false;\r\n    }); // end of readfile\r\n    return true;\r\n  } // end runLoader\r\n\r\n\r\n\r\n} // end class LoaderDicom\r\n\r\nexport default LoaderDicom;\r\n\r\n ","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n'License'); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n'AS IS' BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n/**\r\n* File load from local disk or URL with promise to complete\r\n* @module demo/engine.loaders/loadpromise\r\n*/\r\n\r\n// ******************************************************************\r\n// class LoadFilePromise\r\n// ******************************************************************\r\n\r\n/** Class LoadFilePromise implements local and remote (via URL) file reading functionality via Promises */\r\nexport default class LoadFilePromise {\r\n  constructor() {\r\n    this.m_file = null;\r\n    this.m_reader = null;\r\n    this.m_request = null;\r\n  }\r\n\r\n  /**\r\n  * Read local file. If success, invoke resolve callback for created promise\r\n  *\r\n  * @param {object} file - file to read\r\n  * @return {object} Promise, working after file will be read\r\n  */\r\n  readLocal(file) {\r\n    return new Promise((resolve) => {\r\n      this.m_file = file;\r\n      this.m_reader = new FileReader();\r\n      this.m_reader.addEventListener('load', (evt) => {\r\n        const arrBuf = evt.target.result;\r\n        if (resolve) {\r\n          resolve(arrBuf);\r\n        }\r\n      });\r\n      this.m_reader.readAsArrayBuffer(this.m_file);\r\n    });\r\n  }\r\n\r\n  /**\r\n  * Read remote file (via promise). If success, invoke resolve callback for created promise\r\n  *\r\n  * @param {string} url - file to read\r\n  * @return {object} Promise, working after file will be read\r\n  */\r\n  readFromUrl(url) {\r\n    return new Promise((resolve, reject) => {\r\n      this.m_url = url;\r\n      this.m_request = null;\r\n      const METHOD = 'GET';\r\n      this.m_request = new XMLHttpRequest();\r\n      if ('withCredentials' in this.m_request) {\r\n        // this.m_request.withCredentials = true;\r\n        const NEED_ASYNC = true;\r\n        this.m_request.open(METHOD, this.m_url, NEED_ASYNC);\r\n        // } else if (typeof XDomainRequest !== 'undefined') {\r\n        // console.log('HttpRequest: XDomainRequest will be used');\r\n        // this.m_request = new XDomainRequest();\r\n        // this.m_request.open(METHOD, this.m_url);\r\n      } else {\r\n        this.m_request = null;\r\n        console.log('This browser cant support CORS requests');\r\n        return;\r\n      }\r\n      this.m_request.responseType = 'arraybuffer';  // \"blob\"\r\n      this.m_request.addEventListener('load', (event) => {\r\n        const arrBuf = event.target.response;\r\n        if (arrBuf === null) {\r\n          console.log('Bad response type. Expect object type in response.');\r\n        } else {\r\n          resolve(arrBuf);\r\n        }\r\n      }, false);\r\n\r\n      this.m_request.addEventListener('error', (event) => {\r\n        const strError = `Error event happend for XMLHttpRequest: loaded = ${event.loaded}, total = ${event.total}`;\r\n        console.log(strError);\r\n        reject(strError);\r\n      }, false);\r\n      this.m_request.send();\r\n    });\r\n  }\r\n}\r\n","/**\r\n * @fileOverview LoaderHdr\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport LoadResult from '../LoadResult';\r\nimport FileTools from './FileTools';\r\nimport LoadFilePromise from './LoadPromise';\r\nimport Volume from '../Volume';\r\nimport VolumeSet from '../VolumeSet';\r\n\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// const NEED_EVEN_TEXTURE_SIZE = false;\r\n\r\nconst HDR_DT_NONE = 0;\r\nconst HDR_DT_UNSIGNED_CHAR = 2;\r\nconst HDR_DT_SIGNED_SHORT = 4;\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class LoaderHdr some text later...\r\n */\r\nclass LoaderHdr {\r\n  static readByteFromBuffer(buf, off) {\r\n    return buf[off];\r\n  }\r\n\r\n  /**\r\n  * Read 32 bit integer from input buffer\r\n  * @param {object} buf - source buffer\r\n  * @param {number} off - offset in buffer\r\n  * @return 32 bit integer number\r\n  */\r\n  static readIntFromBuffer(buf, off) {\r\n    const res = ((buf[off + 0]) |\r\n      // eslint-disable-next-line\r\n      (buf[off + 1] << 8) |\r\n      // eslint-disable-next-line\r\n      (buf[off + 2] << 16) |\r\n      // eslint-disable-next-line\r\n      (buf[off + 3] << 24)\r\n    );\r\n    return res;\r\n  }\r\n\r\n  /**\r\n  * Read 16 bit short integer from input buffer\r\n  * @param {object} buf - source buffer\r\n  * @param {number} off - offset in buffer\r\n  * @return 16 bit short integer number\r\n  */\r\n  static readShortFromBuffer(buf, off) {\r\n    // eslint-disable-next-line\r\n    const res = ((buf[off + 0]) | (buf[off + 1] << 8));\r\n    return res;\r\n  }\r\n\r\n  /**\r\n  * Read 32 bit float from input buffer\r\n  * @param {object} buf - source buffer\r\n  * @param {number} off - offset in buffer\r\n  * @return 32 bit float number\r\n  */\r\n  static readFloatFromBuffer(buf, off) {\r\n    const BYTES_IN_FLOAT = 4;\r\n    const arBuf = new ArrayBuffer(BYTES_IN_FLOAT);\r\n    const dataArray = new DataView(arBuf);\r\n    // eslint-disable-next-line\r\n    dataArray.setUint8(0, buf[off + 0]);\r\n    // eslint-disable-next-line\r\n    dataArray.setUint8(1, buf[off + 1]);\r\n    // eslint-disable-next-line\r\n    dataArray.setUint8(2, buf[off + 2]);\r\n    // eslint-disable-next-line\r\n    dataArray.setUint8(3, buf[off + 3]);\r\n    const IS_LITTLE_ENDIAN = true;\r\n    const res = dataArray.getFloat32(0, IS_LITTLE_ENDIAN);\r\n    return res;\r\n  }\r\n\r\n  /**\r\n  * Convert DataView object into string\r\n  * @param {object} buf - buffer\r\n  * @param {number} off - current offset in buffer, when string started\r\n  * @param {number} lengthBuf - number of bytes to convert to string\r\n  * @return {string} string presentation of DataView\r\n  */\r\n  static getStringAt(buf, off, lengthBuf) {\r\n    let str = '';\r\n    for (let i = 0; i < lengthBuf; i++) {\r\n      const ch = buf[off + i];\r\n      if (ch === 0) {\r\n        break;\r\n      }\r\n      str += String.fromCharCode(ch);\r\n    }\r\n    return str;\r\n  }\r\n\r\n  //\r\n  // read header file\r\n  //\r\n  readFromBufferHeader(volumeDst, arrBuf, callbackProgress, callbackComplete) {\r\n    // check arguments\r\n    console.assert(volumeDst != null, \"Null volume\");\r\n    console.assert(volumeDst instanceof Volume, \"Should be volume\");\r\n    console.assert(arrBuf != null, \"Null array\");\r\n    console.assert(arrBuf.constructor.name === \"ArrayBuffer\", \"Should be ArrayBuf in arrBuf\");\r\n\r\n    const bufBytes = new Uint8Array(arrBuf);\r\n    const bufLen = bufBytes.length;\r\n    const HDR_HEADER_SIZE = 348;\r\n    // console.log(`Header buf size === ${bufLen}`);\r\n    if (bufLen !== HDR_HEADER_SIZE) {\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.WRONG_HEADER_DATA_SIZE, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n\r\n    const SIZE_DWORD = 4;\r\n    const SIZE_SHORT = 2;\r\n    const SIZE_BYTE = 1;\r\n\r\n    let bufOff = 0;\r\n    // read sizeof header\r\n    const sizeofHdr = LoaderHdr.readIntFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    if (sizeofHdr !== HDR_HEADER_SIZE) {\r\n      console.log(`Hdr first int wrong: ${sizeofHdr}, but should be ${HDR_HEADER_SIZE}`);\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.BAD_HEADER, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    const ONE = 1;\r\n    const TWO = 2;\r\n\r\n    // read dataType char[10]\r\n    const DATA_TYPE_LEN = 10;\r\n    const strDataType = LoaderHdr.getStringAt(bufBytes, bufOff, DATA_TYPE_LEN);\r\n    bufOff += DATA_TYPE_LEN;\r\n    volumeDst.m_dataType = HDR_DT_NONE;\r\n    if (strDataType === 'CHAR') {\r\n      volumeDst.m_dataType = HDR_DT_UNSIGNED_CHAR;\r\n      volumeDst.m_bytesPerVoxel = ONE;\r\n    }\r\n    if (strDataType === 'SHORT') {\r\n      volumeDst.m_dataType = HDR_DT_SIGNED_SHORT;\r\n      volumeDst.m_bytesPerVoxel = TWO;\r\n    }\r\n    if (volumeDst.m_dataType === HDR_DT_NONE) {\r\n      console.log(`Hdr wrong data type. Should be CHAR or SHORT, but found: ${strDataType}`);\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.BAD_HEADER, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    console.log(`Hdr read data type = ${strDataType}`);\r\n\r\n    // read dbName char[18]\r\n    const DB_NAME_LEN = 18;\r\n    bufOff += DB_NAME_LEN;\r\n\r\n    // reads extents int\r\n    const iExtents = LoaderHdr.readIntFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    const MAGIC_EXTENTS = 16384;\r\n    if (iExtents !== MAGIC_EXTENTS) {\r\n      console.log(`Hdr wrong extents in header. Should be ${MAGIC_EXTENTS}, but found: ${iExtents}`);\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.BAD_HEADER, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    // read session error\r\n    // const iSessionError = HdrVolume.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n\r\n    // read regular\r\n    const iRegular = LoaderHdr.readByteFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_BYTE;\r\n\r\n    const  MAGIC_REGULAR = 114;\r\n    if (iRegular !== MAGIC_REGULAR) {\r\n      console.log(`Hdr wrong regular in header. Should be ${MAGIC_REGULAR}, but found: ${iRegular}`);\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.BAD_HEADER, null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n\r\n    // read hKeyUn\r\n    // const hKeyUn = HdrVolume.readByteFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_BYTE;\r\n\r\n    // read ushort dim[8]\r\n    // const dim0 = HdrVolume.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    const dim1 = LoaderHdr.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    const dim2 = LoaderHdr.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    const dim3 = LoaderHdr.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n\r\n    volumeDst.m_xDim = dim1;\r\n    volumeDst.m_yDim = dim2;\r\n    volumeDst.m_zDim = dim3;\r\n    console.log(`HDR: volume dim = ${volumeDst.m_xDim} * ${volumeDst.m_yDim} * ${volumeDst.m_zDim} `);\r\n\r\n    // read unused dim [4,5,6,7]\r\n    const NUM_DIM_UNUSED = 4;\r\n    bufOff += SIZE_SHORT * NUM_DIM_UNUSED;\r\n\r\n    // read voxUnits\r\n    const VOX_UNITS_SIZE = 4;\r\n    bufOff += VOX_UNITS_SIZE;\r\n\r\n    // read calUnits char[8]\r\n    const CAL_UNITS_SIZE = 8;\r\n    bufOff += CAL_UNITS_SIZE;\r\n\r\n    // read unused\r\n    // const unusedH = HdrVolume.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n\r\n    // read dataType\r\n    const dataTypeH = LoaderHdr.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    if (volumeDst.m_dataType === HDR_DT_UNSIGNED_CHAR) {\r\n      if (dataTypeH !== HDR_DT_UNSIGNED_CHAR) {\r\n        console.log('Wrong data tye for char typed header');\r\n        return false;\r\n      }\r\n    }\r\n    if (volumeDst.m_dataType === HDR_DT_SIGNED_SHORT) {\r\n      if (dataTypeH !== HDR_DT_SIGNED_SHORT) {\r\n        console.log('Wrong data tye for signed short typed header');\r\n        return false;\r\n      }\r\n    }\r\n\r\n    // read bitPix\r\n    const BITS_IN_CHAR = 8;\r\n    const BITS_IN_WORD = 16;\r\n\r\n    const bitPixH = LoaderHdr.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    if (volumeDst.m_dataType === HDR_DT_UNSIGNED_CHAR) {\r\n      if (bitPixH !== BITS_IN_CHAR) {\r\n        console.log('Wrong bits pix for char typed header');\r\n        return false;\r\n      }\r\n    }\r\n    if (volumeDst.m_dataType === HDR_DT_SIGNED_SHORT) {\r\n      if (bitPixH !== BITS_IN_WORD) {\r\n        console.log('Wrong bits pix for word typed header');\r\n        return false;\r\n      }\r\n    }\r\n\r\n    // read dimUn\r\n    // const dimUn = HdrVolume.readShortFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n\r\n    // read pixDim : voxelDim\r\n    // const pixDim0 = HdrVolume.readFloatFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    const pixDim1 = LoaderHdr.readFloatFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    const pixDim2 = LoaderHdr.readFloatFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    const pixDim3 = LoaderHdr.readFloatFromBuffer(bufBytes, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n\r\n    // read rest of pixDim\r\n    const NUM_REST_PIX_DIM = 4;\r\n    bufOff += SIZE_DWORD * NUM_REST_PIX_DIM;\r\n\r\n    volumeDst.m_boxSize.x = volumeDst.m_xDim * pixDim1;\r\n    volumeDst.m_boxSize.y = volumeDst.m_yDim * pixDim2;\r\n    volumeDst.m_boxSize.z = volumeDst.m_zDim * pixDim3;\r\n    console.log(`HDR: physic size = ${volumeDst.m_boxSize.x} * ${volumeDst.m_boxSize.y} * ${volumeDst.m_boxSize.z} `);\r\n\r\n    return true;\r\n  }\r\n\r\n  //\r\n  // read image file\r\n  //\r\n  readFromBufferImage(volumeDst, arrBuf, callbackProgress, callbackComplete) {\r\n    // check arguments\r\n    console.assert(volumeDst != null, \"Null volume\");\r\n    console.assert(volumeDst instanceof Volume, \"Should be volume\");\r\n    console.assert(arrBuf != null, \"Null array\");\r\n    console.assert(arrBuf.constructor.name === \"ArrayBuffer\", \"Should be ArrayBuf in arrBuf\");\r\n\r\n    const bufBytes = new Uint8Array(arrBuf);\r\n    const bufLen = bufBytes.length;\r\n    const MIN_BUF_SIZE = 8;\r\n    const MAX_BUF_SIZE = (1024 * 1024 * 230);\r\n    if (bufLen < MIN_BUF_SIZE) {\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.ERROR_TOO_SMALL_DATA_SIZE , null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    if (bufLen >= MAX_BUF_SIZE) {\r\n      if (callbackComplete) {\r\n        callbackComplete(LoadResult.ERROR_TOO_LARGE_DATA_SIZE , null, 0, null);\r\n      }\r\n      return false;\r\n    }\r\n    volumeDst.m_imageBufferSize = bufLen;\r\n    volumeDst.m_arrBuf = arrBuf;\r\n    console.log(`readFromBufferImage complete with ${bufLen} bytes in image `);\r\n    return true;\r\n  } // end readFromBufferImage\r\n\r\n  //\r\n  // create volume from 2 components\r\n  //\r\n  createVolumeFromHeaderAndImage(volDst) {\r\n    // check arguments\r\n    console.assert(volDst != null, \"Null volume\");\r\n    console.assert(volDst instanceof Volume, \"Should be volume\");\r\n  \r\n    const NUM_BYTES_CHAR = 1;\r\n    const NUM_BYTES_WORD = 2;\r\n\r\n    let bytesPerPixel = 0;\r\n    if (volDst.m_dataType === HDR_DT_UNSIGNED_CHAR) {\r\n      bytesPerPixel = NUM_BYTES_CHAR;\r\n    }\r\n    if (volDst.m_dataType === HDR_DT_SIGNED_SHORT) {\r\n      bytesPerPixel = NUM_BYTES_WORD;\r\n    }\r\n    const numPixels = volDst.m_xDim * volDst.m_yDim * volDst.m_zDim;\r\n    const estimatedVolSize = numPixels * bytesPerPixel;\r\n    if (estimatedVolSize !== volDst.m_imageBufferSize) {\r\n      console.log(`HDR: wrong IMG data size. Read: ${volDst.m_imageBufferSize}, but expected ${estimatedVolSize} `);\r\n      return false;\r\n    }\r\n    const arrBuf = volDst.m_arrBuf;\r\n    if (volDst.m_dataType === HDR_DT_SIGNED_SHORT) {\r\n      const dataArray16 = new Uint16Array(arrBuf);\r\n      volDst.m_dataArray = new Uint8Array(numPixels);\r\n      // convert 16 bpp -> 8 bpp\r\n      let i;\r\n      let valMax = 0;\r\n      for (i = 0; i < numPixels; i++) {\r\n        valMax = (dataArray16[i] > valMax) ? dataArray16[i] : valMax;\r\n      }\r\n      // console.log(`IMG: maximum input color is ${valMax}`);\r\n      valMax++;\r\n\r\n      // scale down to 256 colors\r\n      const MAX_COLOR_BYTE = 255;\r\n      for (i = 0; i < numPixels; i++) {\r\n        volDst.m_dataArray[i] = Math.floor(MAX_COLOR_BYTE * dataArray16[i] / valMax);\r\n      }\r\n    } else if (volDst.m_dataType === HDR_DT_UNSIGNED_CHAR) {\r\n      // Read color indices info: usually this is 1 bpp data\r\n      const bufBytes = new Uint8Array(arrBuf);\r\n      volDst.m_dataArray = bufBytes;\r\n    }\r\n\r\n    // save to result volume\r\n    const ONE = 1;\r\n    volDst.m_bytesPerVoxel = ONE;\r\n    volDst.m_dataSize = volDst.m_imageBufferSize;\r\n    return true;\r\n  }\r\n\r\n  //\r\n  // create vol from 2 volumes: intensity and hdr\r\n  //\r\n  createRoiVolumeFromHeaderAndImage(volDst, volRoi) {\r\n    // check arguments\r\n    console.assert(volDst != null, \"Null volume\");\r\n    console.assert(volDst instanceof Volume, \"Should be volume\");\r\n    console.assert(volRoi != null, \"Null volume\");\r\n    console.assert(volRoi instanceof Volume, \"Should be volume\");\r\n\r\n    // both volumes are in 1 byte format\r\n    const ONE = 1;\r\n    if (volDst.m_bytesPerVoxel !== ONE) {\r\n      console.log('createRoiVolumeFromHeaderAndImage: bad volDst. m_bytesPerVoxel should be 1');\r\n      return false;\r\n    }\r\n    if (volRoi.m_bytesPerVoxel !== ONE) {\r\n      console.log('createRoiVolumeFromHeaderAndImage: bad volRoi');\r\n      return false;\r\n    }\r\n    // compare size\r\n    if ((volDst.m_xDim !== volRoi.m_xDim) || (volDst.m_yDim !== volRoi.m_yDim) || (volDst.m_zDim !== volRoi.m_zDim)) {\r\n      console.log('createRoiVolumeFromHeaderAndImage: different volumes sizes');\r\n      return false;\r\n    }\r\n    const numPixels = volDst.m_xDim * volDst.m_yDim * volDst.m_zDim;\r\n    const BYTES_IN_RGBA = 4;\r\n    const dataNew = new Uint8Array(numPixels * BYTES_IN_RGBA);\r\n\r\n    const arrBuf = volRoi.m_arrBuf;\r\n    const dataArrayRoi8 = new Uint8Array(arrBuf);\r\n\r\n    const OFF0 = 0; const OFF1 = 1;\r\n    const OFF2 = 2; const OFF3 = 3;\r\n    let j = 0;\r\n    for (let i = 0; i < numPixels; i++, j += BYTES_IN_RGBA) {\r\n      dataNew[j + OFF0] = volDst.m_dataArray[i];\r\n      dataNew[j + OFF1] = 0;\r\n      dataNew[j + OFF2] = 0;\r\n      dataNew[j + OFF3] = dataArrayRoi8[i];\r\n    }\r\n    volDst.m_dataArray = dataNew;\r\n    const FOUR = 4;\r\n    volDst.m_bytesPerVoxel = FOUR;\r\n    console.log('createRoiVolumeFromHeaderAndImage: success');\r\n    return true;\r\n  } //\r\n\r\n  /**\r\n   * Read hdr (h + img) files from URL\r\n   * \r\n   * @param {object} volSet - volume set\r\n   * @param {string} strUrl - url string\r\n   * @param {func} callbackProgress - callback during read progress\r\n   * @param {func} callbackComplete - callback after complete (good or bad)\r\n   * @return true, if success\r\n   */\r\n  readFromUrl(volSet, strUrl, callbackProgress, callbackComplete) {\r\n    console.log(`readFromUrl. going to read from ${strUrl} ...`);\r\n\r\n    const ft = new FileTools();\r\n    const isValidUrl = ft.isValidUrl(strUrl);\r\n    if (!isValidUrl) {\r\n      console.log(`readFromUrl: not vaild URL = = ${strUrl} `);\r\n      return false;\r\n    }\r\n    this.m_folder = ft.getFolderNameFromUrl(strUrl);\r\n    const fileName = ft.getFileNameFromUrl(strUrl);\r\n    // console.log(`readFromUrl: folder =  ${this.m_folder} filename = ${fileName}`);\r\n\r\n    const regExp = /(\\w+)_intn.(h|hdr)/;\r\n    const arrGrp = regExp.exec(fileName);\r\n    if (arrGrp.length !== 3) {\r\n      console.log(`LoaderHdr.readFromUrl: bad URL name = ${strUrl}. Should be in template NNN_intn.h `);\r\n      return false;\r\n    }\r\n    const namePrefix = arrGrp[1];\r\n    //console.log(`readFromUrl: name prefix = ${namePrefix}, grpLen = ${arrGrp.length}`);\r\n\r\n    const fileNameIntensityHeader = this.m_folder + '/' + namePrefix + '_intn.h';\r\n    const fileNameIntensityImage = this.m_folder + '/' + namePrefix + '_intn.img';\r\n    const fileNameMaskHeader = this.m_folder + '/' + namePrefix + '_mask.h';\r\n    const fileNameMaskImage = this.m_folder + '/' + namePrefix + '_mask.img';\r\n\r\n\r\n    const arrUrls = [];\r\n    arrUrls.push(fileNameIntensityHeader);\r\n    arrUrls.push(fileNameIntensityImage);\r\n    arrUrls.push(fileNameMaskHeader);\r\n    arrUrls.push(fileNameMaskImage);\r\n    const ok = this.readFromUrls(arrUrls, volSet, callbackProgress, callbackComplete);\r\n\r\n    return ok;\r\n  } // end of readFromUrl\r\n\r\n  /**\r\n   * \r\n   * @param {object} arrUrls  - array of strings urls\r\n   * @param {*} volSet  - dest volume set\r\n   * @param {*} callbackProgress - callback during read\r\n   * @param {*} callbackComplete - callback after end fo read\r\n   */\r\n  readFromUrls(arrUrls, volSet, callbackProgress, callbackComplete) {\r\n\r\n    // check arguments\r\n    console.assert(volSet != null, \"Null volume set\");\r\n    console.assert(volSet instanceof VolumeSet, \"Should be volume set\");\r\n    \r\n\r\n    const numUrls = arrUrls.length;\r\n    const NUM_URLS_IN_SET = 2;\r\n    const NUM_FILES_VOL_INT_ROI = 4;\r\n    if (numUrls === NUM_URLS_IN_SET) {\r\n      let urlHdr = arrUrls[0];\r\n      let urlImg = arrUrls[1];\r\n      const loaderHdr = new LoadFilePromise();\r\n      const loaderImg = new LoadFilePromise();\r\n      let indPointH = urlHdr.indexOf('.h');\r\n      if (indPointH === -1) {\r\n        indPointH = urlHdr.indexOf('.hdr');\r\n      }\r\n      if (indPointH === -1) {\r\n        const strCopy = urlHdr;\r\n        urlHdr = urlImg;\r\n        urlImg = strCopy;\r\n      }\r\n\r\n      // this.m_volIntensity = new HdrVolume(this.m_needScaleDownTexture);\r\n\r\n      const volDst = volSet.getVolume(0);\r\n      loaderHdr.readFromUrl(urlHdr).then((arrBufHdr) => {\r\n        this.readFromBufferHeader(volDst, arrBufHdr, callbackComplete, callbackProgress);\r\n        console.log(`Load success HDR file: ${urlHdr}`);\r\n        loaderImg.readFromUrl(urlImg).then((arrBufImg) => {\r\n          this.readFromBufferImage(volDst, arrBufImg, callbackComplete, callbackProgress);\r\n          console.log(`Load success IMG file: ${urlImg}`);\r\n\r\n          // complete 2 images\r\n          this.createVolumeFromHeaderAndImage(volDst);\r\n\r\n          // invoke callback for good loading end\r\n          callbackComplete(LoadResult.SUCCESS);\r\n\r\n        });\r\n      }, (error) => {\r\n        console.log('HDR File read error', error);\r\n        callbackComplete(LoadResult.ERROR_CANT_OPEN_URL, null, 0, null);\r\n        return false;\r\n      });\r\n    } else if (numUrls === NUM_FILES_VOL_INT_ROI) {\r\n      // read 4 files\r\n      const urlHdrInt = arrUrls[0];\r\n      const urlImgInt = arrUrls[1];\r\n      const urlHdrRoi = arrUrls[2];\r\n      const urlImgRoi = arrUrls[3];\r\n\r\n      const loaderHdrInt = new LoadFilePromise();\r\n      const loaderImgInt = new LoadFilePromise();\r\n      const loaderHdrRoi = new LoadFilePromise();\r\n      const loaderImgRoi = new LoadFilePromise();\r\n\r\n      // this.m_volIntensity = new HdrVolume(this.m_needScaleDownTexture);\r\n      // this.m_volRoi = new HdrVolume(this.m_needScaleDownTexture);\r\n\r\n      const volRoi = new Volume();\r\n      const volDst = volSet.getVolume(0);\r\n\r\n      loaderHdrInt.readFromUrl(urlHdrInt).then((arrBufHdr) => {\r\n        // this.m_volIntensity.readBufferHead(arrBufHdr, callbackComplete, callbackProgress);\r\n        // this.readBufferHead(arrBufHdr, callbackComplete, callbackProgress);\r\n        this.readFromBufferHeader(volDst, arrBufHdr, callbackComplete, callbackProgress);\r\n\r\n        console.log(`Load success HDR file: ${urlHdrInt}`);\r\n        loaderImgInt.readFromUrl(urlImgInt).then((arrBufImg) => {\r\n          // this.m_volIntensity.readBufferImg(arrBufImg, callbackComplete, callbackProgress);\r\n          // this.readBufferImg(arrBufImg, callbackComplete, callbackProgress);\r\n          this.readFromBufferImage(volDst, arrBufImg, callbackComplete, callbackProgress);\r\n          console.log(`Load success IMG file: ${urlImgInt}`);\r\n\r\n          loaderHdrRoi.readFromUrl(urlHdrRoi).then((arrBufferHdr) => {\r\n            //this.m_volRoi.readBufferHead(arrBufferHdr, callbackComplete, callbackProgress);\r\n            this.readFromBufferHeader(volRoi, arrBufferHdr, callbackComplete, callbackProgress);\r\n\r\n            loaderImgRoi.readFromUrl(urlImgRoi).then((arrBufferImg) => {\r\n\r\n              // this.m_volRoi.readBufferImg(arrBufferImg, callbackComplete, callbackProgress);\r\n              this.readFromBufferImage(volRoi, arrBufferImg, callbackComplete, callbackProgress);\r\n\r\n              // transform intensity data from 16 bpp -> 8 bpp\r\n              this.createVolumeFromHeaderAndImage(volDst);\r\n\r\n              // mix intensity + roi\r\n              this.createRoiVolumeFromHeaderAndImage(volDst, volRoi);\r\n\r\n              // invoke callback for good loading end\r\n              callbackComplete(LoadResult.SUCCESS);\r\n\r\n            }); // loaderImgRoi\r\n          }); // loaderHdrRoi\r\n\r\n        }); // loaderImgInt\r\n      }, (error) => {\r\n        console.log('HDR File read error', error);\r\n        return false;\r\n      }); // loaderHdrInt\r\n\r\n    } else {\r\n      console.log(`Error read hdr files. Should be ${NUM_URLS_IN_SET} files`);\r\n      return false;\r\n    }// if number of files equal to 2\r\n    return true;\r\n  } // end of readFromUrls\r\n} // end class LoaderHdr\r\n\r\nexport default LoaderHdr;\r\n","/**\r\n * @fileOverview VolumeSet\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\n\r\nimport Volume from './Volume';\r\n\r\nimport LoaderKtx from './loaders/LoaderKtx';\r\nimport LoaderNifti from './loaders/LoaderNifti';\r\nimport LoaderDicom from './loaders/LoaderDicom';\r\nimport LoaderHdr from './loaders/LoaderHdr';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n/** \r\n * Class representing a volume set \r\n * Typically set contains only 1 volume, but for some Dicom folders it can be more then 1 \r\n * See Volume class as an element of volume set\r\n */\r\nclass VolumeSet extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    /** nuber of volumes in set */\r\n    this.m_numVolumes = 0;\r\n    /** volumes array. see more details in class Volume */\r\n    this.m_volumes = [];\r\n    /** patient name (etracted from dicom tags or empty for non-dicom files) */\r\n    this.m_patientName = '';\r\n    /** date of patient birth */\r\n    this.m_patientBirth = '';\r\n    /** text description of serie */\r\n    this.m_seriesDescr = '';\r\n    /** text description of study */\r\n    this.m_studyDescr = '';\r\n    /** text with date of study */\r\n    this.m_studyDate = '';\r\n    /** text with time series taken */\r\n    this.m_seriesTime = '';\r\n    /** text with body part */\r\n    this.m_bodyPartExamined = '';\r\n    /** text institution like clinic, university, etc. */\r\n    this.m_institutionName = '';\r\n    /** text with operator name */\r\n    this.m_operatorsName = '';\r\n    /** text with physican name */\r\n    this.m_physicansName = '';\r\n  }\r\n\r\n  /**\r\n   * Add volume to set\r\n   * \r\n   * @param {Volume} vol - added volume\r\n   */\r\n  addVolume(vol) {\r\n    console.assert(vol instanceof Volume, \"VolumeSet.addVolume: arg must be Volume\");\r\n    // this.m_volumes[this.m_numVolumes] = vol;\r\n    this.m_volumes.push(vol);\r\n    this.m_numVolumes++;\r\n  }\r\n\r\n  /**\r\n   * Get number of volumes in st\r\n   * \r\n   * @return {number} Amount of volumes on set\r\n   */\r\n  getNumVolumes() {\r\n    return this.m_numVolumes;\r\n  }\r\n\r\n  /**\r\n   * Get volume by its index\r\n   * @param {number} idx - index of volume in set\r\n   * @return {Volume} volume is set or null\r\n   */\r\n  getVolume(idx) {\r\n    console.assert(Number.isInteger(idx), \"VolumeSet.getVolume: arg must be number\");\r\n    console.assert(idx < this.m_numVolumes, \"index of volume should be in range\");\r\n    console.assert(idx >= 0, \"index of volume should be non negative\");\r\n    if ((idx < 0) || (idx >= this.m_numVolumes)) {\r\n      return null;\r\n    }\r\n    return this.m_volumes[idx];\r\n  }\r\n\r\n  // do nothing. But we need to implement render() to run Volume tests\r\n  render() {\r\n    return <p>></p>;\r\n  }\r\n\r\n  // ********************************************\r\n  // Read metyhods. From Ktx, Dicom, ..\r\n  // ********************************************\r\n  /**\r\n   * Read KTX from local file buffer\r\n   * \r\n   * @param {char array} arrBuf \r\n   * @param {func} callbackProgress \r\n   * @param {func} callbackComplete \r\n   */\r\n  readFromKtx(arrBuf, callbackProgress, callbackComplete) {\r\n    console.assert(arrBuf != null);\r\n    console.assert(arrBuf.constructor.name === \"ArrayBuffer\", \"Should be ArrayBuf in arrBuf\");\r\n    const loader = new LoaderKtx();\r\n    const vol = this.getVolume(0);\r\n    const ret = loader.readFromBuffer(vol, arrBuf, callbackProgress, callbackComplete);\r\n    return ret;\r\n  }\r\n  \r\n  readFromKtxUrl(strUrl, callbackProgress, callbackComplete) {\r\n    const loader = new LoaderKtx();\r\n    const vol = this.getVolume(0);\r\n    loader.readFromUrl(vol, strUrl, callbackProgress, callbackComplete);\r\n  }\r\n\r\n  readFromNiiUrl(strUrl, callbackProgress, callbackComplete) {\r\n    const loader = new LoaderNifti();\r\n    const vol = this.getVolume(0);\r\n    const ret = loader.readFromUrl(vol, strUrl, callbackProgress, callbackComplete);\r\n    return ret;\r\n  }\r\n\r\n  readFromDicomUrl(strUrl, callbackProgress, callbackComplete) {\r\n    const NUM_FILES = 0; // will be filled later\r\n    const loader = new LoaderDicom(NUM_FILES);\r\n    const ret = loader.readFromUrl(this, strUrl, callbackProgress, callbackComplete);\r\n    return ret;\r\n  }\r\n\r\n  readFromHdrUrl(strUrl, callbackProgress, callbackComplete) {\r\n    const loader = new LoaderHdr();\r\n    const ret = loader.readFromUrl(this, strUrl, callbackProgress, callbackComplete);\r\n    return ret;\r\n  }\r\n\r\n  readFromNifti(arrBuf, callbackProgress, callbackComplete) {\r\n    const loader = new LoaderNifti();\r\n    const vol = this.getVolume(0);\r\n    const ret = loader.readFromBuffer(vol, arrBuf, callbackProgress, callbackComplete);\r\n    return ret;\r\n  }\r\n\r\n  readFromDicom(loader, arrBuf, callbackProgress, callbackComplete) {\r\n    const indexFile = 0;\r\n    const fileName = 'file???';\r\n    const ratio = 0.0;\r\n\r\n    const ret = loader.readFromBuffer(indexFile, fileName, ratio, arrBuf, callbackProgress, callbackComplete);\r\n    return ret;\r\n  }\r\n\r\n  readSingleSliceFromDicom(loader, indexFile, fileName, ratioLoaded, arrBuf, callbackProgress, callbackComplete) {\r\n    const ret = loader.readFromBuffer(indexFile, fileName, ratioLoaded, arrBuf, callbackProgress, callbackComplete);\r\n    return ret;\r\n  }\r\n\r\n} // end VolumeSet\r\n\r\nexport default VolumeSet;\r\n","/**\r\n * @fileOverview UiModalDemo\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport { Container, Row, Col, Image, OverlayTrigger, Tooltip } from 'react-bootstrap';\r\nimport { Modal, Button } from 'react-bootstrap';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiModalDemo some text later...\r\n */\r\nclass UiModalDemo extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.onModalShow = this.onModalShow.bind(this);\r\n    this.onModalHide = this.onModalHide.bind(this);\r\n    this.onButton0 = this.onButton0.bind(this);\r\n    this.onButton1 = this.onButton1.bind(this);\r\n    this.onButton2 = this.onButton2.bind(this);\r\n    this.onButton3 = this.onButton3.bind(this);\r\n    this.onButton4 = this.onButton4.bind(this);\r\n    this.onButton5 = this.onButton5.bind(this);\r\n    this.onButton6 = this.onButton6.bind(this);\r\n    this.onButton7 = this.onButton7.bind(this);\r\n    this.onDemo = this.onDemo.bind(this);\r\n    this.state = {\r\n      showModalDemo: false\r\n    };\r\n  }\r\n\r\n  onModalShow() {\r\n    this.setState({ showModalDemo: true });\r\n  }\r\n\r\n  onModalHide() {\r\n    this.setState({ showModalDemo: false });\r\n  }\r\n\r\n  onDemo(index) {\r\n    const onSelectFunc = this.props.onSelectDemo;\r\n    const onHideFunc = this.props.onHide;\r\n    onHideFunc();\r\n    onSelectFunc(index);\r\n  }\r\n\r\n  onButton0() {\r\n    this.onDemo(0);\r\n  }\r\n\r\n  onButton1() {\r\n    this.onDemo(1);\r\n  }\r\n\r\n  onButton2() {\r\n    this.onDemo(2);\r\n  }\r\n\r\n  onButton3() {\r\n    this.onDemo(3);\r\n  }\r\n\r\n  onButton4() {\r\n    this.onDemo(4);\r\n  }\r\n\r\n  onButton5() {\r\n    this.onDemo(5);\r\n  }\r\n\r\n  onButton6() {\r\n    this.onDemo(6);\r\n  }\r\n\r\n  onButton7() {\r\n    this.onDemo(7);\r\n  }\r\n\r\n  render() {\r\n    const stateVis = this.props.stateVis;\r\n    const onHideFunc = this.props.onHide;\r\n\r\n    // icons description\r\n    const iconsSet = [\r\n      {\r\n        tooltip: 'Lungs 20101108 from ktx',\r\n        image: 'images/thumb_lungs.png',\r\n        alt: 'lungs',\r\n        func: this.onButton0,\r\n      },\r\n      {\r\n        tooltip: 'Brain set from ktx',\r\n        image: 'images/thumb_brain.png',\r\n        alt: 'lungs',\r\n        func: this.onButton1,\r\n      },\r\n      {\r\n        tooltip: 'Grandmother (gm3) from nifti',\r\n        image: 'images/thumb_gm3_512_512_165.png',\r\n        alt: 'gm3',\r\n        func: this.onButton2,\r\n      },\r\n      {\r\n        tooltip: 'Woman pelvis from dicom',\r\n        image: 'images/thumb_woman_pelvis.png',\r\n        alt: 'woman_pelvis',\r\n        func: this.onButton3,\r\n      },\r\n      {\r\n        tooltip: 'Lungs 00cba...957e from dicom',\r\n        image: 'images/thumb_ocb.png',\r\n        alt: 'lungs_ocb',\r\n        func: this.onButton4,\r\n      },\r\n      {\r\n        tooltip: 'CT 256^3 from ktx',\r\n        image: 'images/thumb_ct_256.png',\r\n        alt: 'ct_256',\r\n        func: this.onButton5,\r\n      },\r\n      {\r\n        tooltip: 'Lungs 256^3 from ktx',\r\n        image: 'images/thumb_lungs_256.png',\r\n        alt: 'lungs_256',\r\n        func: this.onButton6,\r\n      },\r\n      {\r\n        tooltip: 'Brain with ROI (colored) from Hdr+Img',\r\n        image: 'images/thumb_set.png',\r\n        alt: 'hdr_set_roi',\r\n        func: this.onButton7,\r\n      },\r\n    ];\r\n\r\n    const jsxModalDemo = \r\n      <Modal show={stateVis} onHide={onHideFunc} >\r\n        <Modal.Header closeButton>\r\n          <Modal.Title>\r\n            Load demo data\r\n          </Modal.Title>\r\n        </Modal.Header>\r\n        <Modal.Body>\r\n\r\n          <Container>\r\n            <Row>\r\n              {iconsSet.map( (d, i) => {\r\n                const strId = `id_${i}`;\r\n                const strTooltip = d.tooltip;\r\n                const strImage = d.image;\r\n                const strAlt = d.alt;\r\n                const funcCallback = d.func;\r\n                return <Col xs={6} md={4} key={strId}>\r\n                  <OverlayTrigger\r\n                    placement=\"top\"\r\n                    delay={{ show: 150, hide: 300 }}\r\n                    overlay={\r\n                      <Tooltip id={strId}>\r\n                        {strTooltip}\r\n                      </Tooltip>\r\n                    }\r\n                  >\r\n                    <Button variant=\"light\" onClick={funcCallback} >\r\n                      <Image src={strImage} alt={strAlt} thumbnail />\r\n                    </Button>\r\n                  </OverlayTrigger>\r\n                </Col>\r\n              })}\r\n            </Row>\r\n          </Container>            \r\n\r\n        </Modal.Body>\r\n      </Modal>;\r\n\r\n    return jsxModalDemo;\r\n  } // end render\r\n} // end class\r\n\r\nexport default connect(store => store)(UiModalDemo);\r\n","/**\r\n * @fileOverview UiModalGoogle\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport { Modal, ListGroup, OverlayTrigger, Tooltip } from 'react-bootstrap';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiModalGoogle some text later...\r\n */\r\nclass UiModalGoogle extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.onModalShow = this.onModalShow.bind(this);\r\n    this.onModalHide = this.onModalHide.bind(this);\r\n    this.onClick = this.onClick.bind(this);\r\n\r\n    this.onDemo = this.onDemo.bind(this);\r\n    this.state = {\r\n      showModalDemo: false\r\n    };\r\n  }\r\n\r\n  onModalShow() {\r\n    this.setState({ showModalDemo: true });\r\n  }\r\n\r\n  onModalHide() {\r\n    this.setState({ showModalDemo: false });\r\n  }\r\n\r\n  onDemo(index) {\r\n    const onSelectFunc = this.props.onSelectDemo;\r\n    const onHideFunc = this.props.onHide;\r\n    onHideFunc();\r\n    onSelectFunc(index);\r\n  }\r\n\r\n  logObject(strTitle, obj) {\r\n    let str = '';\r\n    for (let prp in obj) {\r\n      if (str.length > 0) {\r\n        str += '\\n';\r\n      }\r\n      str += prp + ' = ' + obj[prp];\r\n    }\r\n    console.log(`${strTitle}\\n${str}`);\r\n  }\r\n\r\n  static getIndex(arrMenu, strElem) {\r\n    const len = arrMenu.length;\r\n    for (let i = 0; i < len; i++) {\r\n      if (arrMenu[i].text === strElem) {\r\n        return i;\r\n      }\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  onClick(evt) {\r\n    this.m_onHideFunc();\r\n    const strTextMenu = evt.target.innerHTML;\r\n    const ind = UiModalGoogle.getIndex(this.m_arrMenu, strTextMenu);\r\n    if ((ind >= 0) && (this.m_funcDemo !== undefined)) {\r\n      // perform action on cliked demo index\r\n      //console.log(`onClick: element = ${ind}`);\r\n      this.m_funcDemo(ind);\r\n    }\r\n  }\r\n\r\n  render() {\r\n    const arrMenu = this.props.arrMenu;\r\n    this.m_arrMenu = arrMenu;\r\n    const stateVis = this.props.stateVis;\r\n    this.m_onHideFunc = this.props.onHide;\r\n    this.m_funcDemo =  this.props.onSelectDemo;\r\n\r\n    const jsxModalDemo = \r\n      <Modal show={stateVis} onHide={this.m_onHideFunc} >\r\n        <Modal.Header closeButton>\r\n          <Modal.Title>\r\n            Load from Google cloud\r\n          </Modal.Title>\r\n        </Modal.Header>\r\n        <Modal.Body>\r\n\r\n          <ListGroup>\r\n\r\n            {arrMenu.map( (d, i) => {\r\n              const strId = `id_${i}`;\r\n              const strTooltip = d.tooltip;\r\n              return <OverlayTrigger \r\n                key={strId} \r\n                placement=\"top\"\r\n                delay={{ show: 150, hide: 300 }}\r\n                overlay={\r\n                  <Tooltip id={strId}>\r\n                    {strTooltip}\r\n                  </Tooltip>\r\n                }\r\n              >\r\n                <ListGroup.Item key={strId} onClick={this.onClick}  > \r\n                  {d.text}\r\n                </ListGroup.Item>\r\n              </OverlayTrigger>\r\n            })}\r\n\r\n          </ListGroup>\r\n\r\n        </Modal.Body>\r\n      </Modal>;\r\n\r\n    return jsxModalDemo;\r\n  } // end render\r\n} // end class\r\n\r\nexport default connect(store => store)(UiModalGoogle);\r\n","/**\r\n * @fileOverview UiModalWinCW\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\n// special css for NoUiSlioder\r\nimport 'nouislider/distribute/nouislider.css';\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport { Modal, Container, Row, Col, Button, ListGroup } from 'react-bootstrap';\r\n\r\nimport Nouislider from 'react-nouislider';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\nconst LARGE_NUMBER = 0x3FFFFFFF;\r\nconst DEFAULT_WIN_MIN = 650 - 2000 / 2;\r\nconst DEFAULT_WIN_MAX = 650 + 2000 / 2;\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\nclass UiModalWindowCenterWidth extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.m_objCanvas = null;\r\n    this.m_dataMin = LARGE_NUMBER;\r\n    this.m_dataMax = LARGE_NUMBER;\r\n\r\n    this.onButtonCancel = this.onButtonCancel.bind(this);\r\n    this.onButtonApply = this.onButtonApply.bind(this);\r\n\r\n    this.state = {\r\n      showModalWindowCenterWidth: false,\r\n      windowMin: DEFAULT_WIN_MIN,\r\n      windowMax: DEFAULT_WIN_MAX, \r\n    };\r\n  } // end constructor\r\n\r\n  onModalHide() {\r\n    this.setState({ showModalWindowCenterWidth: false });\r\n  }\r\n\r\n  reset() {\r\n    // restore data params to initial for next lloading\r\n    this.m_dataMin = LARGE_NUMBER;\r\n    this.m_dataMax = LARGE_NUMBER;\r\n    this.setState({ windowMin: DEFAULT_WIN_MIN });\r\n    this.setState({ windowMax: DEFAULT_WIN_MAX });\r\n  }\r\n\r\n  //\r\n  onButtonCancel() {\r\n    // console.log('TODO: on Cancel ...');\r\n    this.reset();\r\n\r\n    const onHideFunc = this.props.onHide;\r\n    onHideFunc(false);\r\n  }\r\n\r\n  //\r\n  onButtonApply() {\r\n    // console.log('TODO: on Apply ...');\r\n\r\n    this.reset();\r\n\r\n    const store = this.props;\r\n    const loaderDicom = store.loaderDicom;\r\n    const volSet = store.volumeSet;\r\n\r\n    // set loader features according current modal properties (window min, max)\r\n    loaderDicom.m_windowCenter = (this.state.windowMin + this.state.windowMax) * 0.5;\r\n    loaderDicom.m_windowWidth = (this.state.windowMax - this.state.windowMin);\r\n\r\n    // apply for single slice dicom read\r\n    // select 1st slice and hash\r\n    const series = loaderDicom.m_slicesVolume.getSeries();\r\n    const numSeries = series.length;\r\n    for (let i = 0; i < numSeries; i++) {\r\n      const hashCode = series[i].m_hash;\r\n      loaderDicom.createVolumeFromSlices(volSet, i, hashCode);\r\n    }\r\n\r\n    // hide this modal\r\n    const onHideFunc = this.props.onHide;\r\n    onHideFunc(true);\r\n  }\r\n\r\n  //\r\n  componentDidMount() {\r\n    // use onRef to provide access to this for the parent component\r\n    // ini react hierarchy\r\n    this.props.onRef(this);\r\n    this.renderPreview();\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    this.props.onRef(undefined);\r\n  }\r\n\r\n  componentDidUpdate() {\r\n    this.renderPreview();\r\n  }\r\n\r\n  drawSlice(ctx, wScreen, hScreen, imgData, dataDst, series, loaderDicom) {\r\n    const serie = series[0];\r\n    const slices = serie.m_slices;\r\n    const numSlices = slices.length;\r\n\r\n    // sort slices via slice location OR slice number\r\n    let minSliceNum = slices[0].m_sliceNumber;\r\n    let maxSliceNum = slices[0].m_sliceNumber;\r\n    for (let s = 0; s < numSlices; s++) {\r\n      const num = slices[s].m_sliceNumber;\r\n      minSliceNum = (num < minSliceNum) ? num : minSliceNum;\r\n      maxSliceNum = (num > maxSliceNum) ? num : maxSliceNum;\r\n    }\r\n    const difSlceNum = maxSliceNum - minSliceNum;\r\n    if (difSlceNum > 0) {\r\n      // sort slices by slice number (read from dicom tag)\r\n      slices.sort((a, b) => {\r\n        const zDif = a.m_sliceNumber - b.m_sliceNumber;\r\n        return zDif;\r\n      });\r\n    } else {\r\n      // sort slices by slice location (read from diocom tag)\r\n      slices.sort((a, b) => {\r\n        const zDif = a.m_sliceLocation - b.m_sliceLocation;\r\n        return zDif;\r\n      });\r\n    }\r\n    // assign new slice numbers according accending location\r\n    let ind = 0;\r\n    for (let s = 0; s < numSlices; s++) {\r\n      slices[s].m_sliceNumber = ind;\r\n      ind++;\r\n    }\r\n    loaderDicom.m_zDim = numSlices;\r\n\r\n    const indexCenter = Math.floor(numSlices / 2);\r\n    const slice = slices[indexCenter];\r\n    const sliceData16 = slice.m_image;\r\n    const xDim = slice.m_xDim;\r\n    const yDim = slice.m_yDim;\r\n    let maxVal = -LARGE_NUMBER;\r\n    let minVal = +LARGE_NUMBER;\r\n    const xyDim = xDim * yDim;\r\n    const zOff = 0;\r\n    let i;\r\n    for (i = 0; i < xyDim; i++) {\r\n      let valSrc = sliceData16[i];\r\n      // check big endian\r\n      if (!loaderDicom.m_littleEndian) {\r\n        const valBytesSwap = (valSrc >> 8) | ((valSrc << 8) & 0xffff);\r\n        valSrc = valBytesSwap;\r\n      }\r\n      // check pad value\r\n      valSrc = (valSrc === loaderDicom.m_padValue) ? 0 : valSrc;\r\n      \r\n      const valData = valSrc * loaderDicom.m_rescaleSlope + loaderDicom.m_rescaleIntercept;\r\n      minVal = (valData < minVal) ? valData : minVal;\r\n      maxVal = (valData > maxVal) ? valData : maxVal;\r\n    } // for (i) all slice pixels\r\n    // console.log(`Modal dcm. min/max val = ${minVal} / ${maxVal}`);\r\n    // this.m_dataMin = minVal;\r\n    // this.m_dataMax = maxVal;\r\n\r\n    const wMin = this.state.windowMin;\r\n    const wMax = this.state.windowMax;\r\n    const wc = Math.floor((wMax + wMin) * 0.5);\r\n    const ww = wMax - wMin;\r\n\r\n    const BITS_ACCUR = 11;\r\n    const BITS_IN_BYTE = 8;\r\n    const scale = Math.floor((1 << (BITS_IN_BYTE + BITS_ACCUR)) / (maxVal - minVal));\r\n    const TOO_MIN_SCALE = 4;\r\n    if (scale <= TOO_MIN_SCALE) {\r\n      console.log('Bad scaling: image will be 0');\r\n      return;\r\n    }\r\n    // const MAX_BYTE = 255;\r\n\r\n    // create temp data array: 8 bit image for this slice\r\n    const dataArray = new Uint8Array(xyDim);\r\n    const winMin = wc - ww * 0.5;\r\n    for (i = 0; i < xyDim; i++) {\r\n      let valSrc = sliceData16[i];\r\n      // check big endian\r\n      if (!loaderDicom.m_littleEndian) {\r\n        const valBytesSwap = (valSrc >> 8) | ((valSrc << 8) & 0xffff);\r\n        valSrc = valBytesSwap;\r\n      }\r\n      // check pad value\r\n      valSrc = (valSrc === loaderDicom.m_padValue) ? 0 : valSrc;\r\n      const valScaled = valSrc * loaderDicom.m_rescaleSlope + loaderDicom.m_rescaleIntercept;\r\n\r\n      let val = 0;\r\n      if (loaderDicom.m_rescaleHounsfield) {\r\n        // rescale for hounsfield units\r\n        val = Math.floor((valScaled - winMin) * 255 / ww);\r\n      } else {\r\n        // usual (default) rescale\r\n        val = Math.floor(127 + (valScaled - wc) * 128 / (ww / 2));\r\n      }\r\n      val = (val >= 0) ? val : 0;\r\n      val = (val < 255) ? val : 255;\r\n      dataArray[zOff + i] = val;\r\n    } // for i\r\n\r\n    // draw 8 but image into window\r\n    let j = 0;\r\n    const xStep = xDim / wScreen;\r\n    const yStep = yDim / hScreen;\r\n    let ay = 0.0; \r\n    for (let y = 0; y < hScreen; y++, ay += yStep) {\r\n      const ySrc = Math.floor(ay);\r\n      const yOff = ySrc * xDim;\r\n      let ax = 0.0;\r\n      for (let x = 0; x < wScreen; x++, ax += xStep) {\r\n        const xSrc = Math.floor(ax);\r\n        const val = dataArray[zOff + yOff + xSrc];\r\n        dataDst[j + 0] = val;\r\n        dataDst[j + 1] = val;\r\n        dataDst[j + 2] = val;\r\n        dataDst[j + 3] = 255; // opacity\r\n        j += 4;\r\n      } // for x\r\n    } // for y\r\n    ctx.putImageData(imgData, 0, 0);\r\n  } // end draw slice\r\n\r\n  //\r\n  // render preview window with slice and selected window properties\r\n  //\r\n  renderPreview() {\r\n    const objCanvas = this.m_objCanvas;\r\n    if (objCanvas === null) {\r\n      return;\r\n    }\r\n\r\n    const wScreen = objCanvas.clientWidth;\r\n    const hScreen = objCanvas.clientHeight;\r\n\r\n    const ctx = objCanvas.getContext('2d');\r\n    const store = this.props;\r\n\r\n    // clear screen\r\n    ctx.fillStyle = 'rgb(40, 40, 40)';\r\n    ctx.fillRect(0, 0, wScreen, hScreen);\r\n\r\n    // destination buffer to write\r\n    const imgData = ctx.createImageData(wScreen, hScreen);\r\n    const dataDst = imgData.data;\r\n    let j = 0;\r\n    const TEST_RAINBOW = false;\r\n    if (TEST_RAINBOW) {\r\n      console.log(\"special rainbow test instead of slice render\");\r\n      for (let y = 0; y < hScreen; y++) {\r\n        for (let x = 0; x < wScreen; x++) {\r\n          let b = Math.floor(255.0 * x / wScreen);\r\n          let g = Math.floor(255.0 * y / hScreen);\r\n          let r = 50;\r\n          dataDst[j + 0] = r;\r\n          dataDst[j + 1] = g;\r\n          dataDst[j + 2] = b;\r\n          dataDst[j + 3] = 255;\r\n          j += 4;\r\n        }\r\n      }\r\n      ctx.putImageData(imgData, 0, 0);\r\n      return;\r\n    } // if test rainbow\r\n\r\n    const loaderDicom = store.loaderDicom;\r\n    if (loaderDicom === null) {\r\n      return;\r\n    }\r\n    const series = loaderDicom.m_slicesVolume.m_series;\r\n    if (series.length === 0) {\r\n      return;\r\n    }\r\n    this.drawSlice(ctx, wScreen, hScreen, imgData, dataDst, series, loaderDicom);\r\n  } // end render preview\r\n\r\n  //\r\n  // callbakc on user change window range (min, max)\r\n  //\r\n  onSliderWindowRange()\r\n  {\r\n    const arrVals = this.refs.sliderRange.slider.get();\r\n    const vMin = parseInt(arrVals[0]);\r\n    const vMax = parseInt(arrVals[1]);\r\n    this.setState({ windowMin: vMin });\r\n    this.setState({ windowMax: vMax });\r\n    // console.log(`slider min/max = ${vMin} / ${vMax}`);\r\n  }\r\n\r\n  getDataMinMax(store, loaderDicom) {\r\n    const series = loaderDicom.m_slicesVolume.m_series;\r\n    if (series.length === 0) {\r\n      return;\r\n    }\r\n    const serie = series[0];\r\n    const slices = serie.m_slices;\r\n    const slice = slices[0];\r\n    const sliceData16 = slice.m_image;\r\n    const xDim = slice.m_xDim;\r\n    const yDim = slice.m_yDim;\r\n    let maxVal = -LARGE_NUMBER;\r\n    let minVal = +LARGE_NUMBER;\r\n    const xyDim = xDim * yDim;\r\n    let i;\r\n    for (i = 0; i < xyDim; i++) {\r\n      let valSrc = sliceData16[i];\r\n      // check big endian\r\n      if (!loaderDicom.m_littleEndian) {\r\n        const valBytesSwap = (valSrc >> 8) | ((valSrc << 8) & 0xffff);\r\n        valSrc = valBytesSwap;\r\n      }\r\n      // check pad value\r\n      valSrc = (valSrc === loaderDicom.m_padValue) ? 0 : valSrc;\r\n      \r\n      const valData = valSrc * loaderDicom.m_rescaleSlope + loaderDicom.m_rescaleIntercept;\r\n      minVal = (valData < minVal) ? valData : minVal;\r\n      maxVal = (valData > maxVal) ? valData : maxVal;\r\n    } // for (i) all slice pixels\r\n    // console.log(`Modal dcm. min/max val = ${minVal} / ${maxVal}`);\r\n    this.m_dataMin = minVal;\r\n    this.m_dataMax = maxVal;\r\n    // console.log(`data min max ready`);\r\n  } // end get data min max\r\n\r\n  //\r\n  // Invoked from parent component once\r\n  // to initialize window range (if found in dicom tags)\r\n  // and detect data [min..max] range\r\n  //\r\n  initWindowRange() {\r\n    const store = this.props;\r\n    const loaderDicom = store.loaderDicom;\r\n    if (loaderDicom !== null) {\r\n      let isValid = true;\r\n      isValid = (loaderDicom.m_windowCenter === LARGE_NUMBER) ? false : isValid;\r\n      isValid = (loaderDicom.m_windowWidth === LARGE_NUMBER) ? false : isValid;\r\n      isValid = (loaderDicom.m_windowWidth <= 0) ? false : isValid;\r\n\r\n      if (isValid) {\r\n        // console.log('initWindowRange: use predefined in tags window center, width');\r\n        const wMin = Math.floor(loaderDicom.m_windowCenter - loaderDicom.m_windowWidth / 2);\r\n        const wMax = Math.floor(loaderDicom.m_windowCenter + loaderDicom.m_windowWidth / 2);\r\n        this.setState({ windowMin: wMin });\r\n        this.setState({ windowMax: wMax });\r\n      }\r\n      this.getDataMinMax(store, loaderDicom);\r\n    } // if loader dicom ready\r\n  } // end init\r\n\r\n  // render \r\n  render() {\r\n\r\n    //const stateVis = true;\r\n    const stateVis = this.props.stateVis;\r\n    const onHideFunc = this.props.onHide;\r\n\r\n    const stylePreview = {\r\n      width: '500px',\r\n      height: '400px',\r\n    };\r\n\r\n    const jsxCanvas = <canvas ref={ (mount) => {this.m_objCanvas = mount} } style={stylePreview} width=\"500px\" height=\"400px\" />;\r\n\r\n    const valToolTps = true;\r\n\r\n    let valMin = 0;\r\n    let valMax = 5000;\r\n    let valDelta = valMax - valMin;\r\n    let valStep = 50;\r\n    if (this.m_dataMin !== LARGE_NUMBER) {\r\n      valMin = this.m_dataMin;\r\n      valMax = this.m_dataMax;\r\n      valDelta = valMax - valMin;\r\n      valStep = Math.floor(valDelta / 32);\r\n    }\r\n\r\n    const rangeTwo = {\r\n      'min': Math.floor(valMin - valDelta / 4),\r\n      'max': Math.floor(valMax + valDelta / 4)\r\n    }\r\n    const wMin = Math.floor(this.state.windowMin);\r\n    const wMax = Math.floor(this.state.windowMax);\r\n    const wArr = [wMin, wMax];\r\n\r\n    const jxsModal = \r\n      <Modal show={stateVis} onHide={onHideFunc} size=\"xl\">\r\n        <Modal.Header closeButton>\r\n          <Modal.Title>\r\n            Select window center and width to display Dicom\r\n          </Modal.Title>\r\n        </Modal.Header>\r\n        <Modal.Body>\r\n          <Container>\r\n            <Row>\r\n              <Col xs md lg=\"12\" ref={ (mount) => {this.m_objCol = mount} } >\r\n                <p className=\"text-center\">\r\n                  {jsxCanvas}\r\n                </p>\r\n              </Col>\r\n            </Row>\r\n\r\n            <ListGroup>\r\n              <ListGroup.Item>\r\n                Window range <p> </p>\r\n              </ListGroup.Item>\r\n              <ListGroup.Item>\r\n                <Nouislider onSlide={this.onSliderWindowRange.bind(this)} ref={'sliderRange'}\r\n                  range={rangeTwo}\r\n                  start={wArr}\r\n                  step={valStep}\r\n                  connect={true}\r\n                  tooltips={valToolTps} />\r\n              </ListGroup.Item>\r\n            </ListGroup>\r\n\r\n            <Row>\r\n              <Col xs md lg=\"5\">\r\n              </Col>\r\n              <Col xs md lg=\"2\">\r\n                <Button onClick={this.onButtonApply}>\r\n                  Apply\r\n                </Button>\r\n              </Col>\r\n              <Col xs md lg=\"5\">\r\n              </Col>\r\n            </Row>\r\n          </Container>\r\n\r\n        </Modal.Body>\r\n      </Modal>\r\n    return jxsModal;\r\n  } // end render\r\n} // end class UiWindowCenterWidth\r\n\r\nexport default connect(store => store)(UiModalWindowCenterWidth);\r\n","/**\r\n * @fileOverview LoaderUrlDicom\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport FileTools from './FileTools';\r\nimport LoadResult from '../LoadResult';\r\nimport Volume from '../Volume';\r\nimport FileLoader from './FileLoader';\r\nimport LoaderDicom from './LoaderDicom';\r\n\r\nimport Texture3D from '../Texture3D';\r\nimport StoreActionType from '../../store/ActionTypes';\r\nimport ModeView from '../../store/ModeView';\r\nimport Modes3d from '../../store/Modes3d';\r\n\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// const DEBUG_PRINT_INDI_SLICE_INFO = false;\r\n// const DEBUG_PRINT_TAGS_INFO = false;\r\n\r\nconst NEED_TEXTURE_SIZE_4X = true;\r\n\r\n// ********************************************************\r\n// Classs\r\n// ********************************************************\r\nclass LoaderUrlDicom {\r\n  constructor(store) {\r\n    this.m_store = store;\r\n    this.m_arrFileNames = null;\r\n    this.m_errors = [];\r\n    this.m_loaders = [];\r\n    this.m_loaderDicom = null;\r\n\r\n    this.callbackReadProgress = this.callbackReadProgress.bind(this);\r\n    this.callbackReadComplete = this.callbackReadComplete.bind(this);\r\n    this.m_fileName = '???';\r\n  }\r\n\r\n  /**\r\n   * Progress read callback\r\n   * \r\n   * @param {number ratio01 - ratio in range [0..1]\r\n   */\r\n  callbackReadProgress(ratio01) {\r\n    const ratioPrc = Math.floor(ratio01 * 100);\r\n    const store = this.m_store;\r\n    const uiapp = store.uiApp;\r\n    if (ratioPrc === 0) {\r\n      uiapp.doShowProgressBar('Loading...');\r\n    }\r\n    if (ratioPrc >= 99) {\r\n      // console.log(`callbackReadProgress. hide on = ${ratio01}`);\r\n      uiapp.doHideProgressBar();\r\n    } else {\r\n      uiapp.doSetProgressBarRatio(ratioPrc);\r\n    }\r\n  } // callback progress\r\n\r\n  /**\r\n   * Invoked after read finished (or may be with error)\r\n   * \r\n   * @param {number codeResult - one from LoadResult.XXX\r\n   */\r\n  callbackReadComplete(codeResult) {\r\n    // console.log(`LoaderUrlDicom.callbackReadComplete: code = ${codeResult}`);\r\n    if (codeResult !== LoadResult.SUCCESS) {\r\n      console.log(`onCompleteFromUrlKtx. Bad result: ${codeResult}`);\r\n      const arrErrors = [];\r\n      const strErr = LoadResult.getResultString(codeResult);\r\n      arrErrors.push(strErr);\r\n      this.finalizeFailedLoadedVolume(this.m_volume, this.m_fileName, arrErrors);\r\n      return;\r\n    } else {\r\n      this.finalizeSuccessLoadedVolume(this.m_volume, this.m_fileName);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * End action if loading failed\r\n   * \r\n   * @param {object} vol - destination readed volume\r\n   * @param {string} fileNameIn - file name need to display\r\n   * @param {object} arrErrors - array of string with error messages\r\n   */\r\n  finalizeFailedLoadedVolume(vol, fileNameIn, arrErrors) {\r\n    // invoke notification\r\n    const store = this.m_store;\r\n    store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: false });\r\n    store.dispatch({ type: StoreActionType.SET_VOLUME, volume: null });\r\n    store.dispatch({ type: StoreActionType.SET_ERR_ARRAY, arrErrors: arrErrors });\r\n    store.dispatch({ type: StoreActionType.SET_FILENAME, fileName: fileNameIn });\r\n    const uiapp = store.uiApp;\r\n    uiapp.doHideProgressBar();\r\n  }\r\n\r\n  /**\r\n   * On the end of success loading dicom folder\r\n   * \r\n   * @param {object} vol - destination volume\r\n   * @param {string} fileNameIn - short file name for readed\r\n   */\r\n  finalizeSuccessLoadedVolume(vol, fileNameIn) {\r\n    if (vol.m_dataArray !== null)\r\n    {\r\n      if (NEED_TEXTURE_SIZE_4X) {\r\n        vol.makeDimensions4x();\r\n      }\r\n      // invoke notification\r\n      const store = this.m_store;\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME, volume: vol });\r\n      store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: true });\r\n      store.dispatch({ type: StoreActionType.SET_FILENAME, fileName: fileNameIn });\r\n      store.dispatch({ type: StoreActionType.SET_ERR_ARRAY, arrErrors: [] });\r\n      const tex3d = new Texture3D();\r\n      tex3d.createFromRawVolume(vol);\r\n      store.dispatch({ type: StoreActionType.SET_TEXTURE3D, texture3d: tex3d });\r\n      store.dispatch({ type: StoreActionType.SET_MODE_VIEW, modeView: ModeView.VIEW_2D });\r\n      store.dispatch({ type: StoreActionType.SET_MODE_3D, mode3d: Modes3d.RAYCAST });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @param {object} arrFileNames - array of file names (with URL) \r\n   * @param {bool} fromGoogle - true if use google headers\r\n   * \r\n   */\r\n  loadFromUrlArray(arrFileNames, fromGoogle) {\r\n    if (arrFileNames === undefined) {\r\n      console.log('LoaderUrlDicom: no argument in constr');\r\n    }\r\n    const tp = typeof arrFileNames;\r\n    if (tp !== 'object') {\r\n      console.log(`LoaderUrlDicom: bad argument type: ${tp}, but expected object`);\r\n    }\r\n    this.m_arrFileNames = arrFileNames;\r\n\r\n    const fileTools = new FileTools();\r\n    let i;\r\n    const numFiles = this.m_arrFileNames.length;\r\n\r\n    console.log(`LoaderUrlDicom.loadFromUrlArray: start loading: ${numFiles} files`);\r\n    console.log(`LoaderUrlDicom.loadFromUrlArray: from ${arrFileNames[0]} .. to ${arrFileNames[numFiles - 1]}  `);\r\n\r\n    this.m_loaderDicom = new LoaderDicom(numFiles, false);\r\n\r\n    this.m_volume = new Volume();\r\n    const callbackProgress = this.callbackReadProgress;\r\n    const callbackComplete = this.callbackReadComplete;\r\n    callbackProgress(0.0);\r\n\r\n    this.m_loaderDicom.m_numLoadedFiles = numFiles;\r\n    this.m_loaderDicom.m_filesLoadedCounter = 0;\r\n    this.m_loaderDicom.m_numFailsLoad = 0;\r\n\r\n    // declare loaders array\r\n    for (let i = 0; i < numFiles; i++) {\r\n      this.m_loaderDicom.m_errors[i] = -1;\r\n      this.m_loaderDicom.m_loaders[i] = null;\r\n    }\r\n\r\n    this.m_loaderDicom.m_zDim  = numFiles;\r\n    for (i = 0; i < numFiles; i++) {\r\n      const fileNameUrl = this.m_arrFileNames[i];\r\n      const isValid = fileTools.isValidUrl(fileNameUrl);\r\n      if (!isValid) {\r\n        console.log(`LoaderUrlDicom.loadFromUrlArray: url is not valid = ${fileNameUrl}`);\r\n        return false;\r\n      }\r\n\r\n      if (i === 0) {\r\n        this.m_fileName = fileTools.getFileNameFromUrl(fileNameUrl);\r\n      }\r\n\r\n      // create loader for cur file\r\n      this.m_loaders[i] = new FileLoader(fileNameUrl);\r\n      const loader = this.m_loaders[i];\r\n      const okLoader = this.m_loaderDicom.runLoader(this.m_volume, fileNameUrl,\r\n        loader, i, callbackProgress, callbackComplete, fromGoogle);\r\n      if (!okLoader) {\r\n        return false;\r\n      }\r\n    } // for (i)\r\n    // console.log('LoaderUrlDicom.loadFromUrlArray: func finished success');\r\n    return true;\r\n  } // end of load from url array\r\n\r\n\r\n} // end class LoaderUrlDicom\r\n\r\nexport default LoaderUrlDicom;\r\n","//\r\n//\r\n//\r\n\r\n// **********************************************\r\n// Imports\r\n// **********************************************\r\n\r\n// 31.08.2020. Daikon reader\r\nimport daikon from  'daikon';\r\nimport DicomSliceInfo from './dicomsliceinfo';\r\nimport LoadResult from '../LoadResult';\r\nimport LoaderDicom from './LoaderDicom';\r\nimport DicomTagInfo from './LoaderDicom';\r\n\r\nimport StoreActionType from '../../store/ActionTypes';\r\nimport DicomSlice from './dicomslice';\r\n\r\n// **********************************************\r\n// Const\r\n// **********************************************\r\n\r\n// read dicom via daikon: print every tag readed\r\nconst NEED_DEBUG_PRINT_TAGS = false;\r\n\r\n// future possible development:\r\n// deep debug: develop read dicomdir file\r\nconst READ_DICOMDIR = false;\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass LoaderDcmDaikon {\r\n  constructor(){ \r\n    this.m_loaderDicom = null;\r\n  }\r\n\r\n  //\r\n  // see example read\r\n  // https://github.com/mbarnig/dumpDICOMDIRarchive/blob/master/dumpDICOMDIR.js\r\n  //\r\n  loadDicomfir(fileName, strContent) {\r\n    const dataFile = new DataView(strContent);\r\n    let image = null;\r\n    try {\r\n      image = daikon.Series.parseImage(dataFile);\r\n    } catch (err) {\r\n      console.log(\"error parse dcm file buffer\");\r\n      return LoadResult.BAD_DICOM;\r\n    }\r\n    if ((image === undefined) || (image === null)) {\r\n      return LoadResult.BAD_DICOM;\r\n    }\r\n    const TAG_DIRECTORY_REC = [0x0004, 0x1220];\r\n    let ind;\r\n    // slice location detect (to correct slices order on z)\r\n    ind = daikon.Utils.dec2hex(TAG_DIRECTORY_REC[0]) + daikon.Utils.dec2hex(TAG_DIRECTORY_REC[1]);\r\n    const tagDirRec = image.tags[ind];\r\n    if (tagDirRec !== undefined) {\r\n      const numEntries = tagDirRec.value.length;\r\n      for (let k = 0; k < numEntries; k++) {\r\n        let dirEntry = tagDirRec.value[k];\r\n        if ((dirEntry.element === 57344) && (dirEntry.group === 65534)) {\r\n          const numSub = dirEntry.value.length;\r\n          for (let s = 0; s < numSub; s++) {\r\n            let elemSub = dirEntry.value[s];\r\n            if ((elemSub.element === 5168) && (elemSub.group === 4)) {\r\n              //const str = elemSub.value[0];\r\n              //console.log(`elem sub val = ${str}`);\r\n            }\r\n            if ((elemSub.element === 5376) && (elemSub.group === 4)) {\r\n              const fold = elemSub.value[0];\r\n              const fname = elemSub.value[1];\r\n              console.log(`image nm = ${fold} / ${fname}`);\r\n            }\r\n          } // for s, all sub elemenst \r\n        } // if entry with patient and image information\r\n      } // for k all entries in dir\r\n    } // if dir rec found\r\n    return LoadResult.SUCCESS;\r\n  }\r\n\r\n  // load single slice, using file index\r\n  loadSingleSlice(fileIndex, fileName, strContent) {\r\n    // console.log(\"loadSingleSlice [\" + fileIndex.toString() + \"]\");\r\n    const dataFile = new DataView(strContent);\r\n    let image = null;\r\n    try {\r\n      image = daikon.Series.parseImage(dataFile);\r\n    } catch (err) {\r\n      console.log(\"error parse dcm file buffer\");\r\n      return LoadResult.BAD_DICOM;\r\n    }\r\n    if ((image === undefined) || (image === null)) {\r\n      return LoadResult.BAD_DICOM;\r\n    }\r\n    // console.log(\"dcm parse completed\");\r\n    const yDim = image.getRows();\r\n    const xDim = image.getCols();\r\n    const bits = image.getBitsAllocated();\r\n    if ((bits !== 8) && (bits !== 16)) {\r\n      console.log('Parse Dicom data. Strange bits per pixel = ' + bits.toString());\r\n    }\r\n    // data for hash code evaluate\r\n    const patientName = image.getPatientName();\r\n    const studyDescr = image.getImageDescription();\r\n    const studyDate = image.getStudyDate();\r\n    const seriesTime = image.getStudyTime();\r\n    const seriesDescr = image.getSeriesDescription();\r\n    const bodyPartExamined = 'NonExistInDiakonReader';\r\n    //const hasPixels = image.hasPixelData();\r\n    //const isComp = image.isCompressed();\r\n\r\n\r\n    const dicomInfo = this.m_loaderDicom.m_dicomInfo;\r\n    //const volSlice = this.m_loaderDicom.m_slicesVolume.getNewSlice();\r\n    const volSlice = new DicomSlice();\r\n    volSlice.m_sliceNumber = fileIndex;\r\n    volSlice.m_sliceLocation = -1;\r\n    volSlice.m_patientName = patientName;\r\n    volSlice.m_studyDescr = studyDescr;\r\n    volSlice.m_studyDate = studyDate;\r\n    volSlice.m_seriesTime = seriesTime;\r\n    volSlice.m_seriesDescr  = seriesDescr;\r\n    volSlice.m_bodyPartExamined = bodyPartExamined;\r\n    volSlice.buildHash();\r\n\r\n    this.m_loaderDicom.m_minSlice = 0;\r\n    this.m_loaderDicom.m_maxSlice = 0;\r\n    this.m_loaderDicom.m_pixelSpacing.x = 0.0;\r\n    this.m_loaderDicom.m_pixelSpacing.y = 0.0;\r\n    this.m_loaderDicom.m_pixelSpacing.z = 0.0;\r\n    this.m_loaderDicom.m_xDim = xDim;\r\n    this.m_loaderDicom.m_yDim = yDim;\r\n    if (fileIndex < this.m_loaderDicom.m_slicesVolume.m_minSlice) {\r\n      this.m_loaderDicom.m_slicesVolume.m_minSlice = fileIndex;\r\n    }\r\n    if (fileIndex > this.m_loaderDicom.m_slicesVolume.m_maxSlice) {\r\n      this.m_loaderDicom.m_slicesVolume.m_maxSlice = fileIndex;\r\n    }\r\n    this.m_loaderDicom.m_newTagEvent.detail.fileName = fileName;\r\n\r\n    const sliceInfo = new DicomSliceInfo();\r\n    const strSlice = 'Slice ' + fileIndex.toString();\r\n    sliceInfo.m_sliceName = strSlice;\r\n    sliceInfo.m_fileName = fileName;\r\n    sliceInfo.m_tags = [];\r\n    dicomInfo.m_sliceInfo.push(sliceInfo);\r\n\r\n    const TAG_PADDING_VALUE = [0x0028, 0x0120];\r\n    const knownTags = [\r\n      // image dims\r\n      daikon.Tag.TAG_ROWS, daikon.Tag.TAG_COLS, daikon.Tag.TAG_ACQUISITION_MATRIX, \r\n      daikon.Tag.TAG_NUMBER_OF_FRAMES, daikon.Tag.TAG_NUMBER_TEMPORAL_POSITIONS,\r\n      // voxel dims\r\n      daikon.Tag.TAG_PIXEL_SPACING, daikon.Tag.TAG_SLICE_THICKNESS, daikon.Tag.TAG_SLICE_GAP,\r\n      daikon.Tag.TAG_TR, daikon.Tag.TAG_FRAME_TIME, \r\n      // datatype\r\n      daikon.Tag.TAG_BITS_ALLOCATED, daikon.Tag.TAG_BITS_STORED,\r\n      daikon.Tag.TAG_PIXEL_REPRESENTATION, daikon.Tag.TAG_HIGH_BIT, \r\n      daikon.Tag.TAG_PHOTOMETRIC_INTERPRETATION, daikon.Tag.TAG_SAMPLES_PER_PIXEL,\r\n      daikon.Tag.TAG_PLANAR_CONFIG, daikon.Tag.TAG_PALETTE_RED, daikon.Tag.TAG_PALETTE_GREEN,\r\n      daikon.Tag.TAG_PALETTE_BLUE,\r\n\r\n      // data scale\r\n      daikon.Tag.TAG_DATA_SCALE_SLOPE, daikon.Tag.TAG_DATA_SCALE_INTERCEPT,\r\n      daikon.Tag.TAG_DATA_SCALE_ELSCINT, daikon.Tag.TAG_PIXEL_BANDWIDTH,\r\n\r\n      // range\r\n      daikon.Tag.TAG_IMAGE_MIN, daikon.Tag.TAG_IMAGE_MAX,\r\n      daikon.Tag.TAG_WINDOW_CENTER, daikon.Tag.TAG_WINDOW_WIDTH,\r\n\r\n      // description\r\n      daikon.Tag.TAG_PATIENT_NAME, daikon.Tag.TAG_PATIENT_ID,\r\n      daikon.Tag.TAG_STUDY_DATE, daikon.Tag.TAG_STUDY_TIME,\r\n      daikon.Tag.TAG_STUDY_DES, daikon.Tag.TAG_IMAGE_TYPE,\r\n      daikon.Tag.TAG_IMAGE_COMMENTS, daikon.Tag.TAG_SEQUENCE_NAME,\r\n      daikon.Tag.TAG_MODALITY,\r\n\r\n      daikon.Tag.TAG_FRAME_OF_REF_UID,\r\n      daikon.Tag.TAG_STUDY_UID,\r\n\r\n      // volume id\r\n      daikon.Tag.TAG_SERIES_DESCRIPTION, daikon.Tag.TAG_SERIES_INSTANCE_UID,\r\n      daikon.Tag.TAG_SERIES_NUMBER, daikon.Tag.TAG_ECHO_NUMBER,\r\n      daikon.Tag.TAG_TEMPORAL_POSITION,\r\n\r\n      // slice id\r\n      daikon.Tag.TAG_IMAGE_NUM, daikon.Tag.TAG_SLICE_LOCATION,\r\n\r\n      // orientation\r\n      daikon.Tag.TAG_IMAGE_ORIENTATION, daikon.Tag.TAG_IMAGE_POSITION,\r\n      daikon.Tag.TAG_SLICE_LOCATION_VECTOR,\r\n      // lut shape\r\n      daikon.Tag.TAG_LUT_SHAPE,\r\n      // pixel padding value\r\n      TAG_PADDING_VALUE,\r\n    ];\r\n\r\n    // some default values\r\n    const TAG_PATIENT_BIRTH_DATE = [0x0010, 0x0030];\r\n    const TAG_BODY_PART_EXAMINED = [0x0018, 0x0015];\r\n    const TAG_INSTITUTION_NAME = [0x0008, 0x0080];\r\n    const TAG_OPERATORS_NAME = [0x0008, 0x1070];\r\n    const TAG_PHYSICANS_NAME = [0x0008, 0x0090];\r\n\r\n    dicomInfo.m_patientName = image.getPatientName();\r\n    dicomInfo.m_patientDateOfBirth = daikon.Image.getSingleValueSafely(image.getTag(TAG_PATIENT_BIRTH_DATE[0], \r\n      TAG_PATIENT_BIRTH_DATE[1]), 0);\r\n    dicomInfo.m_seriesDescr = seriesDescr;\r\n\r\n    dicomInfo.m_studyDescr = studyDescr;\r\n    dicomInfo.m_studyDate = studyDate;\r\n    dicomInfo.m_seriesTime = seriesTime;\r\n    dicomInfo.m_bodyPartExamined = daikon.Image.getSingleValueSafely(image.getTag(TAG_BODY_PART_EXAMINED[0], \r\n      TAG_BODY_PART_EXAMINED[1]), 0);\r\n    dicomInfo.m_institutionName = daikon.Image.getSingleValueSafely(image.getTag(TAG_INSTITUTION_NAME[0], \r\n      TAG_INSTITUTION_NAME[1]), 0);\r\n    dicomInfo.m_operatorsName = daikon.Image.getSingleValueSafely(image.getTag(TAG_OPERATORS_NAME[0], \r\n      TAG_OPERATORS_NAME[1]), 0);\r\n    dicomInfo.m_physicansName = daikon.Image.getSingleValueSafely(image.getTag(TAG_PHYSICANS_NAME[0], \r\n      TAG_PHYSICANS_NAME[1]), 0);\r\n\r\n    // save all known tags to info array (can be displayed in app UI)\r\n    const numKnownTags = knownTags.length;\r\n    for (let k = 0; k < numKnownTags; k++) {\r\n      const ind = daikon.Utils.dec2hex(knownTags[k][0]) + daikon.Utils.dec2hex(knownTags[k][1]);\r\n      const tag = image.tags[ind];\r\n      if (tag !== undefined) {\r\n        const val = tag.value;\r\n        const group = tag.group;\r\n        const element = tag.element;\r\n\r\n        // const sliceInfo = dicomInfo.m_sliceInfo[0];\r\n        const tagInfo = new DicomTagInfo();\r\n        tagInfo.m_tag = '(' + \r\n          LoaderDicom.numberToHexString(group) + ',' + \r\n          LoaderDicom.numberToHexString(element) + ')';\r\n        const strTagName = this.m_loaderDicom.m_dictionary.getTextDesc(group, element);\r\n        tagInfo.m_attrName = (strTagName.length > 1) ? strTagName : '';\r\n  \r\n        // let strVal = LoaderDicom.getAttrValueAsString(tag);\r\n        let strVal = '';\r\n        if (val !== null) {\r\n          strVal = val.toString();\r\n        }\r\n  \r\n        tagInfo.m_attrValue = strVal;\r\n        sliceInfo.m_tags.push(tagInfo);\r\n        if (NEED_DEBUG_PRINT_TAGS) {\r\n          console.log('tag readed = ' + group.toString() + ', ' + element.toString() + ', v = ' + strVal);\r\n        }\r\n      } // if non null tag\r\n    } // for k all known tags\r\n\r\n    let ind;\r\n    // slice location detect (to correct slices order on z)\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_SLICE_LOCATION[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_SLICE_LOCATION[1]);\r\n    const tagSLoc = image.tags[ind];\r\n    if (tagSLoc !== undefined) {\r\n      let sliceLoc = tagSLoc.value[0];\r\n      volSlice.m_sliceLocation = sliceLoc;\r\n      this.m_sliceLocMin = (sliceLoc < this.m_sliceLocMin) ? sliceLoc : this.m_sliceLocMin;\r\n      this.m_sliceLocMax = (sliceLoc > this.m_sliceLocMax) ? sliceLoc : this.m_sliceLocMax;\r\n    }\r\n    // slice number\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_IMAGE_NUM[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_IMAGE_NUM[1]);\r\n    const tagSlNum = image.tags[ind];\r\n    if (tagSlNum !== undefined) {\r\n      if (tagSlNum.value !== null) {\r\n        let sliceNumber = tagSlNum.value[0];\r\n        volSlice.m_sliceNumber = sliceNumber;\r\n      }\r\n    }\r\n    // samples per pixel\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_SAMPLES_PER_PIXEL[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_SAMPLES_PER_PIXEL[1]);\r\n    const tagSamPerPix = image.tags[ind];\r\n    if (tagSamPerPix !== undefined) {\r\n      let samPerPixel = tagSamPerPix.value[0];\r\n      this.m_loaderDicom.m_samplesPerPixel = samPerPixel;\r\n    }\r\n\r\n    // read pixel padding value\r\n    ind = daikon.Utils.dec2hex(0x0028) + daikon.Utils.dec2hex(0x0120);\r\n    const tagPPV = image.tags[ind];\r\n    if (tagPPV !== undefined) {\r\n      let valPad = tagPPV.value[0];\r\n      if (valPad < 0) {\r\n        valPad = -(valPad ^ 0xffff) - 1;\r\n      }\r\n      // console.log('val pad = ' + valPad);\r\n      this.m_loaderDicom.m_padValue = valPad;\r\n    }\r\n    // read window center\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_WINDOW_CENTER[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_WINDOW_CENTER[1]);\r\n    const tagWinCen = image.tags[ind];\r\n    if (tagWinCen !== undefined) {\r\n      this.m_loaderDicom.m_windowCenter = tagWinCen.value[0];\r\n    }\r\n    // read window width\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_WINDOW_WIDTH[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_WINDOW_WIDTH[1]);\r\n    const tagWinWid = image.tags[ind];\r\n    if (tagWinWid !== undefined) {\r\n      this.m_loaderDicom.m_windowWidth = tagWinWid.value[0];\r\n    }\r\n    // read rescale intercept\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_DATA_SCALE_INTERCEPT[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_DATA_SCALE_INTERCEPT[1]);\r\n    const tagResInt = image.tags[ind];\r\n    if (tagResInt !== undefined) {\r\n      this.m_loaderDicom.m_rescaleIntercept = tagResInt.value[0];\r\n    }\r\n    // read rescale slope\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_DATA_SCALE_SLOPE[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_DATA_SCALE_SLOPE[1]);\r\n    const tagResSlo = image.tags[ind];\r\n    if (tagResSlo !== undefined) {\r\n      this.m_loaderDicom.m_rescaleSlope = tagResSlo.value[0];\r\n    }\r\n    // read rescale type\r\n    const TAG_RESCALE_TYPE = [0x0028, 0x1054];\r\n    ind = daikon.Utils.dec2hex(TAG_RESCALE_TYPE[0]) + daikon.Utils.dec2hex(TAG_RESCALE_TYPE[1]);\r\n    const tagResTyp = image.tags[ind];\r\n    if (tagResTyp !== undefined) {\r\n      if ((tagResTyp.value !== null) && (tagResTyp.value[0] === 'HU')) {\r\n        this.m_loaderDicom.m_rescaleHounsfield = true;\r\n      }\r\n    }\r\n\r\n    // read pixel representation\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_PIXEL_REPRESENTATION[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_PIXEL_REPRESENTATION[1]);\r\n    const tagPixRep = image.tags[ind];\r\n    if (tagPixRep !== undefined) {\r\n      if (tagPixRep.value[0] === 1) {\r\n        this.m_loaderDicom.m_pixelRepresentaionSigned = true;\r\n      }\r\n    }\r\n\r\n\r\n    // read pixel spacing on xy (physical dimensions)\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_PIXEL_SPACING[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_PIXEL_SPACING[1]);\r\n    const tagPS = image.tags[ind];\r\n    if (tagPS !== undefined) {\r\n      let arrSpa = tagPS.value;\r\n      const VAL_2 = 2;\r\n      if (arrSpa.length === VAL_2) {\r\n        this.m_loaderDicom.m_pixelSpacing.x = parseFloat(arrSpa[0]);\r\n        this.m_loaderDicom.m_pixelSpacing.y = parseFloat(arrSpa[1]);\r\n      }\r\n    }\r\n    // read pixel spacing on z (physical dimensions)\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_SLICE_THICKNESS[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_SLICE_THICKNESS[1]);\r\n    const tagSLT = image.tags[ind];\r\n    if (tagSLT !== undefined) {\r\n      let arrThick = tagSLT.value;\r\n      if (arrThick.length === 1) {\r\n        this.m_loaderDicom.m_pixelSpacing.z = parseFloat(arrThick[0]);\r\n      }\r\n      // console.log('val pad = ' + valPad);\r\n    }\r\n\r\n    // get image position (x,y,z), help to detect volume physical size\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_IMAGE_POSITION[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_IMAGE_POSITION[1]);\r\n    const tagImPos = image.tags[ind];\r\n    if (tagImPos !== undefined) {\r\n      const NUM_COMPONENTS_3 = 3;\r\n      if (tagImPos.value.length === NUM_COMPONENTS_3) {\r\n        // eslint-disable-next-line\r\n        const xPos = tagImPos.value[0];\r\n        // eslint-disable-next-line\r\n        const yPos = tagImPos.value[1];\r\n        // eslint-disable-next-line\r\n        const zPos = tagImPos.value[2];\r\n        this.m_loaderDicom.m_imagePosMin.x = (xPos < this.m_loaderDicom.m_imagePosMin.x) ? xPos : this.m_loaderDicom.m_imagePosMin.x;\r\n        this.m_loaderDicom.m_imagePosMin.y = (yPos < this.m_loaderDicom.m_imagePosMin.y) ? yPos : this.m_loaderDicom.m_imagePosMin.y;\r\n        this.m_loaderDicom.m_imagePosMin.z = (zPos < this.m_loaderDicom.m_imagePosMin.z) ? zPos : this.m_loaderDicom.m_imagePosMin.z;\r\n        this.m_loaderDicom.m_imagePosMax.x = (xPos > this.m_loaderDicom.m_imagePosMax.x) ? xPos : this.m_loaderDicom.m_imagePosMax.x;\r\n        this.m_loaderDicom.m_imagePosMax.y = (yPos > this.m_loaderDicom.m_imagePosMax.y) ? yPos : this.m_loaderDicom.m_imagePosMax.y;\r\n        this.m_loaderDicom.m_imagePosMax.z = (zPos > this.m_loaderDicom.m_imagePosMax.z) ? zPos : this.m_loaderDicom.m_imagePosMax.z;\r\n        if (NEED_DEBUG_PRINT_TAGS) {\r\n          console.log(`TAG. image position x,y,z = ${xPos}, ${yPos}, ${zPos}`);\r\n        } // if print\r\n      } // if 3 components in array\r\n    } // if tag exists\r\n\r\n    // read transfer syntax (detect big endian)\r\n    ind = daikon.Utils.dec2hex(daikon.Tag.TAG_TRANSFER_SYNTAX[0]) + daikon.Utils.dec2hex(daikon.Tag.TAG_TRANSFER_SYNTAX[1]);\r\n    const tagTraSyn = image.tags[ind];\r\n    if (tagTraSyn !== undefined) {\r\n      let arrStrTra = tagTraSyn.value;\r\n      if (arrStrTra[0] === \"1.2.840.10008.1.2.2\") {\r\n        this.m_loaderDicom.m_littleEndian = false;\r\n      }\r\n      // console.log('val pad = ' + valPad);\r\n    }\r\n\r\n    // add volume slice to slices volume (and manage series)\r\n    this.m_loaderDicom.m_slicesVolume.addSlice(volSlice);\r\n\r\n    // check correct read image\r\n    const pixels = image.getRawData();\r\n    const numBytesPixelsRead = pixels.byteLength;\r\n    const VAL_8 = 8;\r\n    const numBytesPixelsExpected = xDim * yDim * Math.floor(bits / VAL_8) * this.m_loaderDicom.m_samplesPerPixel;\r\n    if (numBytesPixelsRead !== numBytesPixelsExpected) {\r\n      console.log('Error read Dicom via Diakon parser');\r\n      return LoadResult.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED;\r\n    }\r\n\r\n    // create pixels storage in volume\r\n    if (this.m_loaderDicom.m_pixelRepresentaionSigned) {\r\n      volSlice.m_image = new Int16Array(xDim * yDim);\r\n    } else {\r\n      volSlice.m_image = new Uint16Array(xDim * yDim);\r\n    }\r\n\r\n    // copy pixels (ArrayBuffer) into volSlice.m_image\r\n    const numPixels = xDim * yDim;\r\n    if (this.m_loaderDicom.m_samplesPerPixel === 1) {\r\n      const pixSrc = new Uint16Array(pixels);\r\n      for (let i = 0; i < numPixels; i++) {\r\n        volSlice.m_image[i] = pixSrc[i];\r\n      } // for i\r\n    } // if 1 sample per pixel\r\n    else if (this.m_loaderDicom.m_samplesPerPixel === 3) {\r\n      const pixSrc = new Uint8Array(pixels);\r\n      let j = 0;\r\n      for (let i = 0; i < numPixels; i++, j += 3) {\r\n        const bVal = pixSrc[j + 0];\r\n        const gVal = pixSrc[j + 1];\r\n        const rVal = pixSrc[j + 2];\r\n        volSlice.m_image[i] = Math.floor( (bVal + gVal + rVal) / 3 );\r\n      } // for i\r\n    } // if samples per pixel is 3\r\n    // store x, y dims\r\n    volSlice.m_xDim = xDim;\r\n    volSlice.m_yDim = yDim;\r\n    return LoadResult.SUCCESS;\r\n  } // end load single slice\r\n\r\n  //\r\n  // read 1 slice during reading multiple dcm files\r\n  //\r\n  readSlice(loader, fileIndex, fileName, strContent) {\r\n    this.m_loaderDicom = loader;\r\n    const ret = this.loadSingleSlice(fileIndex, fileName, strContent);\r\n    return ret;\r\n  }\r\n\r\n  // read 1 slice\r\n  readSingleSlice(store, loader, fileIndex, fileName, strContent) {\r\n    this.m_loaderDicom = loader;\r\n    let ret;\r\n    if (!READ_DICOMDIR) {\r\n      ret = this.loadSingleSlice(fileIndex, fileName, strContent);\r\n    } else {\r\n      ret = this.loadDicomfir(fileName, strContent);\r\n    }\r\n    if (ret !== LoadResult.SUCCESS) {\r\n      return ret;\r\n    }\r\n    \r\n    // save dicomInfo to store\r\n    const dicomInfo = this.m_loaderDicom.m_dicomInfo;\r\n    store.dispatch({ type: StoreActionType.SET_DICOM_INFO, dicomInfo: dicomInfo });\r\n    // save dicom loader to store\r\n    store.dispatch({ type: StoreActionType.SET_LOADER_DICOM, loaderDicom: this.m_loaderDicom });\r\n    return ret;\r\n  }\r\n\r\n}\r\n\r\n\r\nexport default LoaderDcmDaikon;\r\n\r\n","//\r\n//\r\n//\r\n\r\n// **********************************************\r\n// Import\r\n// **********************************************\r\n\r\nimport VolumeSet from '../VolumeSet';\r\nimport LoadResult from '../LoadResult';\r\nimport FileTools from './FileTools';\r\nimport FileLoader from './FileLoader';\r\nimport LoaderDcmDaikon from './LoaderDcmDaikon';\r\nimport LoaderDicom from './LoaderDicom';\r\n// import DicomSlicesVolume from './dicomslicesvolume';\r\n\r\n// **********************************************\r\n// Const\r\n// **********************************************\r\n\r\nconst DEBUG_PRINT_TAGS_INFO = false;\r\n\r\n// **********************************************\r\n// Class\r\n// **********************************************\r\n\r\nclass LoaderDcmUrlDaikon {\r\n  constructor() {\r\n    this.m_loaderDaikon = new LoaderDcmDaikon();\r\n    this.readReadyFileList = this.readReadyFileList.bind(this);\r\n  }\r\n\r\n  readFromUrl(volSet, strUrl, callbackComplete, callbackProgress) {\r\n    // check arguments\r\n    console.assert(volSet != null, \"Null volume\");\r\n    console.assert(volSet instanceof VolumeSet, \"Should be volume set\");\r\n    console.assert(strUrl != null, \"Null string url\");\r\n    console.assert(typeof(strUrl) === 'string', \"Should be string in url\");\r\n\r\n    // replace file name to 'file_list.txt'\r\n    const ft = new FileTools();\r\n    const isValidUrl = ft.isValidUrl(strUrl);\r\n    if (!isValidUrl) {\r\n      console.log(`readFromUrl: not vaild URL = = ${strUrl} `);\r\n      return false;\r\n    }\r\n    this.m_folder = ft.getFolderNameFromUrl(strUrl);\r\n    const urlFileList = this.m_folder + '/file_list.txt';\r\n    console.log(`readFromUrl: load file = ${urlFileList} `);\r\n\r\n    callbackProgress(0.0);\r\n    \r\n    const fileLoader = new FileLoader(urlFileList);\r\n    this.m_fileListCounter = 0;\r\n    fileLoader.readFile((arrBuf) => {\r\n      this.m_fileListCounter += 1;\r\n      if (this.m_fileListCounter === 1) {\r\n        const okRead = this.readReadyFileList(volSet, arrBuf, callbackComplete, callbackProgress);\r\n        return okRead;\r\n      }\r\n      return true;\r\n    }, (errMsg) => {\r\n      console.log(`Error read file: ${errMsg}`);\r\n      // callbackComplete(LoadResult.ERROR_CANT_OPEN_URL, null, 0, null);\r\n      return false;\r\n    }); // get file from server\r\n    return true;\r\n  } // end read from url\r\n\r\n  //\r\n  readReadyFileList(volSet, arrBuf, callbackComplete, callbackProgress) {\r\n    const uint8Arr = new Uint8Array(arrBuf);\r\n    const strFileContent = String.fromCharCode.apply(null, uint8Arr);\r\n\r\n    const LEN_LOG = 64;\r\n    const strLog = strFileContent.substr(0, LEN_LOG);\r\n    console.log(`Loaded file list. Started with:  ${strLog} ...`);\r\n\r\n    const arrFileNames = strFileContent.split('\\n');\r\n\r\n    let numFiles = arrFileNames.length;\r\n    // check last empty elements\r\n    const MIN_FILE_NAME_SIZE = 4;\r\n    for (let i = numFiles - 1; i >= 0; i--) {\r\n      if (arrFileNames[i].endsWith('\\r')) {\r\n        arrFileNames[i] = arrFileNames[i].substring(0, arrFileNames[i].length - 1);\r\n      }\r\n      if (arrFileNames[i].length < MIN_FILE_NAME_SIZE) {\r\n        arrFileNames.pop();\r\n      }\r\n    }\r\n    numFiles = arrFileNames.length;\r\n    this.m_loaders = [];\r\n    this.m_errors = [];\r\n    // declare slices array\r\n    for (let i = 0; i < numFiles; i++) {\r\n      // this.m_slices[i] = null;\r\n      this.m_errors[i] = -1;\r\n      this.m_loaders[i] = null;\r\n    }\r\n    \r\n\r\n    const zDim = numFiles;\r\n    console.log(`Loaded file list. ${numFiles} files will be loaded. 1st file in list is = ${arrFileNames[0]}`);\r\n    console.log(`Loaded file list. Last file in list is = ${arrFileNames[numFiles - 1]}`);\r\n\r\n    this.m_loaderDaikon.m_loaderDicom = new LoaderDicom(numFiles);\r\n\r\n    // physical dimension\r\n    this.m_loaderDaikon.m_loaderDicom.m_pixelSpacing = {\r\n      x: 0.0,\r\n      y: 0.0,\r\n      z: 0.0,\r\n    };\r\n    this.m_boxSize = {\r\n      x: 1.0,\r\n      y: 1.0,\r\n      z: 1.0,\r\n    };\r\n    this.m_filesLoadedCounter = 0;\r\n    this.m_numFailsLoad = 0;\r\n    this.m_numLoadedFiles = numFiles;\r\n\r\n    this.m_loaderDaikon.m_loaderDicom.m_imagePosMin = {\r\n      // eslint-disable-next-line\r\n      x: +1.0e12,\r\n      // eslint-disable-next-line\r\n      y: +1.0e12,\r\n      // eslint-disable-next-line\r\n      z: +1.0e12\r\n    };\r\n    this.m_loaderDaikon.m_loaderDicom.m_imagePosMax = {\r\n      // eslint-disable-next-line\r\n      x: -1.0e12,\r\n      // eslint-disable-next-line\r\n      y: -1.0e12,\r\n      // eslint-disable-next-line\r\n      z: -1.0e12\r\n    };\r\n\r\n    // eslint-disable-next-line\r\n    this.m_loaderDaikon.m_sliceLocMin = +1.0e12;\r\n    // eslint-disable-next-line\r\n    this.m_loaderDaikon.m_sliceLocMax = -1.0e12;\r\n\r\n    for (let i = 0; (i < this.m_numLoadedFiles) && (this.m_numFailsLoad < 1); i++) {\r\n      const urlFile = `${this.m_folder}/${arrFileNames[i]}`;\r\n      // console.log(`trying read file ${urlFile} from web`);\r\n\r\n      this.m_loaders[i] = new FileLoader(urlFile);\r\n      const loader = this.m_loaders[i];\r\n      loader.readFile((fileArrBu) => {\r\n        const ratioLoaded = this.m_filesLoadedCounter / this.m_numLoadedFiles;\r\n        const VAL_MASK = 7;\r\n        if ((callbackProgress !== undefined) && ((this.m_filesLoadedCounter & VAL_MASK) === 0)) {\r\n          //console.log(`LoadDcmUrlDaikon. Progress = ${ratioLoaded}`);\r\n          callbackProgress(ratioLoaded);\r\n        }\r\n        //if ((callbackProgress !== undefined) &&\r\n        //  (this.m_filesLoadedCounter + 1 === this.m_numLoadedFiles)) {\r\n        //  callbackProgress(1.0);\r\n        //}\r\n        const ret = this.m_loaderDaikon.loadSingleSlice(i, urlFile, fileArrBu);\r\n        if (ret !== LoadResult.SUCCESS) {\r\n          return ret;\r\n        }\r\n        // console.log(`LoadDcmUrlDaikon. Loaded/All = ${this.m_filesLoadedCounter} / ${this.m_numLoadedFiles}`);\r\n        this.m_filesLoadedCounter += 1;\r\n        if (this.m_filesLoadedCounter === this.m_numLoadedFiles) {\r\n          // Finalize physic dimension\r\n          if (DEBUG_PRINT_TAGS_INFO) {\r\n            console.log(`slice location (min, max) = ${this.m_sliceLocMin}, ${this.m_sliceLocMax}`);\r\n          }\r\n          const imagePosBox = {\r\n            x: this.m_loaderDaikon.m_loaderDicom.m_imagePosMax.x - this.m_loaderDaikon.m_loaderDicom.m_imagePosMin.x,\r\n            y: this.m_loaderDaikon.m_loaderDicom.y - this.m_loaderDaikon.m_loaderDicom.m_imagePosMin.y,\r\n            z: this.m_loaderDaikon.m_loaderDicom.m_imagePosMax.z - this.m_loaderDaikon.m_loaderDicom.m_imagePosMin.z\r\n          };\r\n          const TOO_MIN = 0.00001;\r\n          let zBox;\r\n          if (Math.abs(this.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.z) > TOO_MIN) {\r\n            zBox = this.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.z * zDim;\r\n          } else {\r\n            zBox = imagePosBox.z;\r\n            if (Math.abs(zBox) < TOO_MIN) {\r\n              zBox = imagePosBox.x;\r\n              if (Math.abs(zBox) < TOO_MIN) {\r\n                zBox = imagePosBox.y;\r\n              }\r\n            }\r\n          } // if pixel spacing 0\r\n          if (zBox < TOO_MIN) {\r\n            zBox = 1.0;\r\n          }\r\n          const xDim = this.m_loaderDaikon.m_loaderDicom.m_xDim;\r\n          const yDim = this.m_loaderDaikon.m_loaderDicom.m_yDim;\r\n  \r\n          this.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.z = zBox / zDim;\r\n          this.m_boxSize.z = zDim * this.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.z;\r\n          this.m_boxSize.x = xDim * this.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.x;\r\n          this.m_boxSize.y = yDim * this.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.y;\r\n          console.log(`LoadDcmUrlDaikon. Volume local phys dim: ${this.m_boxSize.x} * ${this.m_boxSize.y} * ${this.m_boxSize.z}`);\r\n\r\n          // TODO: add hash\r\n          let series = this.m_loaderDaikon.m_loaderDicom.m_slicesVolume.getSeries();\r\n          if (series.length === 0) {\r\n            this.m_loaderDaikon.m_loaderDicom.m_slicesVolume.buildSeriesInfo();\r\n            series = this.m_loaderDaikon.m_loaderDicom.m_slicesVolume.getSeries();\r\n          }\r\n          const indexSerie = 0;\r\n          const hash = series[indexSerie].m_hash;\r\n          const errStatus = this.m_loaderDaikon.m_loaderDicom.createVolumeFromSlices(volSet, indexSerie,  hash);\r\n          if (callbackProgress !== null) {\r\n            callbackProgress(1.0);\r\n          }\r\n\r\n          if (callbackComplete !== null) {\r\n            callbackComplete(errStatus);\r\n            return true;\r\n          }\r\n        } // if last file\r\n      }); // file buffer is ready to parse\r\n  \r\n    } // for i all files\r\n\r\n    return LoadResult.SUCCESS;\r\n  } // end readReadyFileList\r\n\r\n} // end class LoaderDcmUrlDaikon\r\n\r\nexport default LoaderDcmUrlDaikon;\r\n","export default {\r\n  // special demo dialog file locations\r\n  //\r\n\r\n  demoUrls: [\r\n  ],\r\n\r\n  googleCloudDemoActivce: false,\r\n  arrMenuGoogle: [\r\n    {\r\n      text: 'Demo lungs AA',\r\n      tooltip: 'Load some lungs model',\r\n    },\r\n    {\r\n      text: 'Demo head BB',\r\n      tooltip: 'Load some strange head',\r\n    },\r\n    {\r\n      text: 'Demo alien CC',\r\n      tooltip: 'Write here smth please',\r\n    },\r\n  ],\r\n  demoWomanPelvisPrefix : '',\r\n  demoWomanPelvisUrls : [\r\n  ],\r\n  demoLungsPrefix: '',\r\n  demoLungsUrls: [\r\n  ],\r\n\r\n};","/**\r\n * @fileOverview UiOpenMenu\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { NavDropdown, Button, Modal, InputGroup, FormControl, } from 'react-bootstrap';\r\n// import { gzip, ungzip } from 'node-gzip';\r\nimport zlib from 'zlib';\r\nimport createReadStream from 'filereader-stream';\r\n\r\nimport VolumeSet from '../engine/VolumeSet';\r\nimport Volume from '../engine/Volume';\r\nimport Texture3D from '../engine/Texture3D';\r\n\r\nimport UiModalDemo from './UiModalDemo';\r\nimport UiModalGoogle from './UiModalGoogle';\r\nimport UiModalWindowCenterWidth from './UiModalWinCW';\r\n// import UiModalDicomSeries from './UiModalDicomSeries';\r\nimport StoreActionType from '../store/ActionTypes';\r\nimport ModeView from '../store/ModeView';\r\nimport Modes3d from '../store/Modes3d';\r\n\r\n// import { timingSafeEqual } from 'crypto';\r\nimport LoadResult from '../engine/LoadResult';\r\nimport FileTools from '../engine/loaders/FileTools';\r\nimport LoaderDicom from '../engine/loaders/LoaderDicom';\r\nimport LoaderHdr from '../engine/loaders/LoaderHdr';\r\n\r\nimport LoaderUrlDicom from '../engine/loaders/LoaderUrlDicom';\r\nimport LoaderDcmDaikon from '../engine/loaders/LoaderDcmDaikon';\r\nimport LoaderDcmUrlDaikon from '../engine//loaders/LoadDcmUrlDiakon';\r\n\r\nimport config from '../config/config';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n/** Need to have demo menu */\r\nconst NEED_DEMO_MENU = true;\r\n\r\n/** deep artificially fix volume texture size to 4 * N */\r\nconst NEED_TEXTURE_SIZE_4X = true;\r\n\r\n// use daikon parser for Dicom (*dcm) file loading\r\nconst READ_DICOM_VIA_DAIKON = true;\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n\r\n/**\r\n * Class UiOpenMenu some text later...\r\n */\r\nclass UiOpenMenu extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.onButtonLocalFile = this.onButtonLocalFile.bind(this);\r\n    this.handleFileSelected = this.handleFileSelected.bind(this);\r\n    this.onFileContentReadSingleFile = this.onFileContentReadSingleFile.bind(this);\r\n    this.onFileContentReadMultipleDicom = this.onFileContentReadMultipleDicom.bind(this);\r\n    this.onFileContentReadMultipleHdr = this.onFileContentReadMultipleHdr.bind(this);\r\n    this.setErrorString = this.setErrorString.bind(this);\r\n\r\n    this.onModalUrlShow = this.onModalUrlShow.bind(this);\r\n    this.onModalUrlHide = this.onModalUrlHide.bind(this);\r\n    this.onClickLoadUrl = this.onClickLoadUrl.bind(this);\r\n    this.callbackReadCompleteUrlKtxNii = this.callbackReadCompleteUrlKtxNii.bind(this);\r\n\r\n    this.onModalDemoOpenShow = this.onModalDemoOpenShow.bind(this);\r\n    this.onModalDemoOpenHide = this.onModalDemoOpenHide.bind(this);\r\n    this.onDemoSelected = this.onDemoSelected.bind(this);\r\n\r\n    this.onModalWindowCWHide = this.onModalWindowCWHide.bind(this); \r\n\r\n    this.onModalGoogleShow = this.onModalGoogleShow.bind(this);\r\n    this.onModalGoogleHide = this.onModalGoogleHide.bind(this);\r\n    this.onGoogleSelected = this.onGoogleSelected.bind(this);\r\n\r\n    this.onModalDicomSeriesHide = this.onModalDicomSeriesHide.bind(this);\r\n    this.onDicomSerieSelected = this.onDicomSerieSelected.bind(this);\r\n\r\n    this.callbackReadProgress = this.callbackReadProgress.bind(this);\r\n    this.callbackReadComplete = this.callbackReadComplete.bind(this);\r\n    this.callbackReadSingleDicomComplete = this.callbackReadSingleDicomComplete.bind(this);\r\n    this.callbackReadMultipleComplete = this.callbackReadMultipleComplete.bind(this);\r\n    this.callbackCompleteMultipleDicom = this.callbackCompleteMultipleDicom.bind(this);\r\n\r\n    this.m_fileNameOnLoad = '';\r\n    this.m_fileName = '';\r\n    this.m_fileIndex = 0;\r\n    this.m_fileReader = null;\r\n    this.state = {\r\n      strUrl: '',\r\n      showModalUrl: false,\r\n      showModalDemo: false,\r\n      showModalGoogle: false,\r\n      showModalWindowCW: false,\r\n      onLoadCounter: 1,\r\n    };\r\n    this.m_volumeSet = null;\r\n    this.m_volumeRoi = null;\r\n    this.m_updateEnable = true;\r\n    this.roiMode = false;\r\n  }\r\n\r\n  finalizeSuccessLoadedVolume(volSet, fileNameIn) {\r\n    const store = this.props;\r\n\r\n    console.assert(volSet instanceof VolumeSet, \"finalizeSuccessLoadedVolume: should be VolumeSet\");\r\n    console.assert(volSet.getNumVolumes() >= 1, \"finalizeSuccessLoadedVolume: should be more or 1 volume\");\r\n    const indexVol = 0;\r\n\r\n    const vol = volSet.getVolume(indexVol);\r\n    console.assert(vol !== null, \"finalizeSuccessLoadedVolume: should be non zero volume\");\r\n\r\n    if (vol.m_dataArray !== null) {\r\n      console.log(`success loaded volume from ${fileNameIn}`);\r\n      if (NEED_TEXTURE_SIZE_4X) {\r\n        vol.makeDimensions4x();\r\n      }\r\n      // invoke notification\r\n    \r\n      // send update (repaint) if was loaded prev model\r\n      if (store.isLoaded) {\r\n        store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: false });  \r\n      }\r\n\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_SET, volumeSet: volSet });\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_INDEX, volumeIndex: 0 });\r\n      store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: true });\r\n      store.dispatch({ type: StoreActionType.SET_FILENAME, fileName: fileNameIn });\r\n      store.dispatch({ type: StoreActionType.SET_ERR_ARRAY, arrErrors: [] });\r\n      const tex3d = new Texture3D();\r\n      tex3d.createFromRawVolume(vol);\r\n      store.dispatch({ type: StoreActionType.SET_TEXTURE3D, texture3d: tex3d });\r\n      store.dispatch({ type: StoreActionType.SET_MODE_VIEW, modeView: ModeView.VIEW_2D });\r\n      store.dispatch({ type: StoreActionType.SET_MODE_3D, mode3d: Modes3d.RAYCAST });\r\n    }\r\n  }\r\n\r\n  setErrorString(strErr) {\r\n    const store = this.props;\r\n    const arrErrors = [];\r\n    arrErrors.push(strErr);\r\n    store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: false });\r\n    store.dispatch({ type: StoreActionType.SET_ERR_ARRAY, arrErrors: arrErrors });\r\n    store.dispatch({ type: StoreActionType.SET_VOLUME_SET, volume: null });\r\n  }\r\n\r\n  finalizeFailedLoadedVolume(volSet, fileNameIn, arrErrors) {\r\n    console.assert(arrErrors !== undefined);\r\n    // invoke notification\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: false });\r\n    store.dispatch({ type: StoreActionType.SET_VOLUME_SET, volume: null });\r\n    store.dispatch({ type: StoreActionType.SET_ERR_ARRAY, arrErrors: arrErrors });\r\n    store.dispatch({ type: StoreActionType.SET_FILENAME, fileName: fileNameIn });\r\n\r\n    const uiapp = store.uiApp;\r\n    uiapp.doHideProgressBar();\r\n  }\r\n\r\n  callbackReadProgress(ratio01) {\r\n    // console.log(`callbackReadProgress = ${ratio01}`);\r\n    const ratioPrc = Math.floor(ratio01 * 100);\r\n    const store = this.props;\r\n    const uiapp = store.uiApp;\r\n    if (uiapp !== null) {\r\n      if (ratioPrc === 0) {\r\n        uiapp.doShowProgressBar('Loading...');\r\n      }\r\n      if (ratioPrc >= 99) {\r\n        // console.log(`callbackReadProgress. hide on = ${ratio01}`);\r\n        uiapp.doHideProgressBar();\r\n      } else {\r\n        uiapp.doSetProgressBarRatio(ratioPrc);\r\n      }\r\n    }\r\n  } // callback progress\r\n\r\n  callbackReadComplete(errCode) {\r\n    if (errCode === undefined) {\r\n      console.log('callbackReadComplete. should be errCode');\r\n    } else {\r\n      if (errCode !== LoadResult.SUCCESS) {\r\n        const strErr = LoadResult.getResultString(errCode);\r\n        this.setErrorString(strErr);\r\n      }\r\n    }\r\n    const store = this.props;\r\n    const uiapp = store.uiApp;\r\n    // console.log(`callbackReadComplete wiyth err = ${loadErrorCode}`);\r\n    uiapp.doHideProgressBar();\r\n\r\n    if (errCode === LoadResult.SUCCESS) {\r\n      // console.log('callbackReadComplete finished OK');\r\n      this.finalizeSuccessLoadedVolume(this.m_volumeSet, this.m_fileName);\r\n    } else {\r\n      console.log(`callbackReadComplete failed! reading ${this.m_fileName} file`);\r\n      const arrErr = [];\r\n      const strErr = LoadResult.getResultString(errCode);\r\n      arrErr.push(strErr);\r\n      this.finalizeFailedLoadedVolume(this.m_volumeSet, this.m_fileName, arrErr);\r\n    }\r\n  }\r\n\r\n  callbackReadSingleDicomComplete(errCode) {\r\n    if (errCode === LoadResult.SUCCESS) {\r\n      // console.log('TODO: UI select window center /width ...');\r\n\r\n      const store = this.props;\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_SET, volumeSet: this.m_volumeSet });\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_INDEX, volumeIndex: 0 });\r\n      // save dicom loader to store\r\n      store.dispatch({ type: StoreActionType.SET_LOADER_DICOM, loaderDicom: this.m_loader });\r\n\r\n      // setup modal: window min, max\r\n      this.childModalWindowCenterWidth.initWindowRange();\r\n\r\n      // show modal: select window center, width\r\n      this.setState({ showModalWindowCW: true });\r\n      return; // do nothing immediately after: wait for dialog\r\n    }\r\n    this.callbackReadComplete(errCode);\r\n  }\r\n\r\n  callbackReadMultipleComplete(errCode) {\r\n    if (errCode !== LoadResult.SUCCESS) {\r\n      const strErr = LoadResult.getResultString(errCode);\r\n      this.setErrorString(strErr);\r\n    }\r\n  }\r\n\r\n  onFileReadSingleUncompressedFile(strContent, callbackProgress, callbackComplete, callbackCompleteSingleDicom) {\r\n    if (this.m_fileName.endsWith('.ktx') || this.m_fileName.endsWith('.KTX')) {\r\n      // if read ktx\r\n      this.m_volumeSet.readFromKtx(strContent, callbackProgress, callbackComplete);\r\n    } else if (this.m_fileName.endsWith('.nii') || this.m_fileName.endsWith('.NII')) {\r\n      this.m_volumeSet.readFromNifti(strContent, callbackProgress, callbackComplete);\r\n    } else if (this.m_fileName.endsWith('.dcm') || this.m_fileName.endsWith('.DCM')) {\r\n      this.m_loader = new LoaderDicom();\r\n      this.m_loader.m_zDim = 1;\r\n      this.m_loader.m_numFiles = 1;\r\n      this.m_volumeSet.readFromDicom(this.m_loader, strContent, callbackProgress, callbackCompleteSingleDicom);\r\n    } else if (this.m_fileName.endsWith('.hdr') || this.m_fileName.endsWith('.HDR')) {\r\n      // readOk = vol.readFromHdrHeader(strContent, callbackProgress, callbackComplete);\r\n      console.log(`cant read single hdr file: ${this.m_fileName}`);\r\n      // readStatus = LoadResult.BAD_HEADER;\r\n    } else if (this.m_fileName.endsWith('.img') || this.m_fileName.endsWith('.IMG')) {\r\n      // readOk = vol.readFromHdrImage(strContent, callbackProgress, callbackComplete);\r\n      console.log(`cant read single img file: ${this.m_fileName}`);\r\n      // readStatus = LoadResult.BAD_HEADER;\r\n    } else {\r\n      console.log(`onFileContentReadSingleFile: unknown file type: ${this.m_fileName}`);\r\n    }\r\n  }\r\n\r\n  onFileContentReadSingleFile() {\r\n    let strContent = this.m_fileReader.result;\r\n    this.onFileReadSingleBuffer(strContent);\r\n  }\r\n\r\n  //\r\n  // daikon read individual slice from file buffer (one from multiple files)\r\n  // strContent is ArrayBuffer\r\n  readSliceDicomViaDaikon(fileIndex, fileName, ratioLoad, strContent) {\r\n    const loaderDaikon = new LoaderDcmDaikon();\r\n    const ret = loaderDaikon.readSlice(this.m_loader, fileIndex, fileName, strContent);\r\n    return ret;\r\n  } // end read single slice via daikon\r\n\r\n  //\r\n  // based on local file read\r\n  // read from string content in this.m_fileReader.result\r\n  //\r\n  onFileReadSingleBuffer(strContent) {\r\n    // daikon read\r\n    // strContent is ArrayBuffer\r\n    if ( (this.m_fileName.endsWith('.dcm') || this.m_fileName.endsWith('.DCM')) && READ_DICOM_VIA_DAIKON) {\r\n      const loaderDcm = new LoaderDcmDaikon();\r\n      const store = this.props;\r\n      const fileIndex = this.m_fileIndex;\r\n      const fileName = this.m_fileName;\r\n      this.m_loader = new LoaderDicom(1);\r\n      const ret = loaderDcm.readSingleSlice(store, this.m_loader, fileIndex, fileName, strContent);\r\n      this.callbackReadSingleDicomComplete(ret);\r\n      return ret;\r\n    }\r\n\r\n    console.log('UiOpenMenu. onFileReadSingleBuffer ...');\r\n    // console.log(`file content = ${strContent.substring(0, 64)}`);\r\n    // console.log(`onFileContentRead. type = ${typeof strContent}`);\r\n    this.m_volumeSet = new VolumeSet();\r\n    // add empty [0]-th volume in set to read single file\r\n    this.m_volumeSet.addVolume(new Volume())\r\n    const callbackProgress = this.callbackReadProgress;\r\n    const callbackComplete = this.callbackReadComplete;\r\n    const callbackCompleteSingleDicom = this.callbackReadSingleDicomComplete;\r\n\r\n\r\n    if (this.m_fileName.endsWith('.ktx') || this.m_fileName.endsWith('.KTX')) {\r\n      // if read ktx\r\n      this.m_volumeSet.readFromKtx(strContent, callbackProgress, callbackComplete);\r\n    } else if (this.m_fileName.endsWith('.nii') || this.m_fileName.endsWith('.NII')) {\r\n      this.m_volumeSet.readFromNifti(strContent, callbackProgress, callbackComplete);\r\n    } else if (this.m_fileName.endsWith('.dcm') || this.m_fileName.endsWith('.DCM')) {\r\n      this.m_loader = new LoaderDicom();\r\n      this.m_loader.m_zDim = 1;\r\n      this.m_loader.m_numFiles = 1;\r\n      this.m_volumeSet.readFromDicom(this.m_loader, strContent, callbackProgress, callbackCompleteSingleDicom);\r\n      // save dicomInfo to store\r\n      const dicomInfo = this.m_loader.m_dicomInfo;\r\n      const sliceInfo = dicomInfo.m_sliceInfo[0];\r\n      sliceInfo.m_fileName = this.m_fileName;\r\n      sliceInfo.m_sliceName = 'Slice 0';\r\n      const store = this.props;\r\n      store.dispatch({ type: StoreActionType.SET_DICOM_INFO, dicomInfo: dicomInfo });\r\n    } else if (this.m_fileName.endsWith('.hdr') || this.m_fileName.endsWith('.HDR')) {\r\n      // readOk = vol.readFromHdrHeader(strContent, callbackProgress, callbackComplete);\r\n      console.log(`cant read single hdr file: ${this.m_fileName}`);\r\n      // readStatus = LoadResult.BAD_HEADER;\r\n    } else if (this.m_fileName.endsWith('.img') || this.m_fileName.endsWith('.IMG')) {\r\n      // readOk = vol.readFromHdrImage(strContent, callbackProgress, callbackComplete);\r\n      console.log(`cant read single img file: ${this.m_fileName}`);\r\n      // readStatus = LoadResult.BAD_HEADER;\r\n    } else {\r\n      console.log(`onFileContentReadSingleFile: unknown file type: ${this.m_fileName}`);\r\n    }\r\n   \r\n  }\r\n\r\n  //\r\n  // read hdr/img. content is in this.m_fileReader.result\r\n  //\r\n  onFileContentReadMultipleHdr() {\r\n    const VALID_NUM_FILES_2 = 2;\r\n    const VALID_NUM_FILES_4 = 4;\r\n    if ((this.m_numFiles !== VALID_NUM_FILES_2) && (this.m_numFiles !== VALID_NUM_FILES_4)) {\r\n      console.log(`onFileContentReadMultipleHdr: can read ${VALID_NUM_FILES_2} or ${VALID_NUM_FILES_4} files for multiple hdr loader`);  \r\n      return;\r\n    }\r\n\r\n    const isHdr = this.m_fileName.endsWith('hdr') || this.m_fileName.endsWith('HDR');\r\n    console.log(`onFileContentReadMultipleHdr: read file ${this.m_fileName}. Ratio=${this.m_fileIndex} / ${this.m_numFiles}`);\r\n    this.m_fileIndex++;\r\n    const ratioLoad = this.m_fileIndex / this.m_numFiles;\r\n    const strContent = this.m_fileReader.result;\r\n    // const lenContent = strContent.length;\r\n\r\n    if (this.m_fileIndex <= 1) {\r\n      // add single volume to set\r\n      if (this.m_volumeSet.getNumVolumes() === 0) {\r\n        this.m_volumeSet.addVolume(new Volume());\r\n      }\r\n      this.callbackReadProgress(0.0);\r\n    }\r\n\r\n    if ((this.m_numFiles === VALID_NUM_FILES_4) && (this.m_volumeRoi === null)) {\r\n      this.m_volumeRoi = new Volume();\r\n    }\r\n\r\n    const callbackProgress = null;\r\n    const callbackComplete = null;\r\n\r\n    const regExpFileName = /([\\S]+)\\.[\\S]+/;\r\n    const fnameArr = regExpFileName.exec(this.m_fileName);\r\n    const numFN = fnameArr.length;\r\n    let detectedMask  = false;\r\n    let detectedIntensity = false;\r\n    if (numFN === 2) {\r\n      const fname = fnameArr[1];\r\n      if (fname.endsWith('_mask')) {\r\n        detectedMask = true;\r\n      }\r\n      if (fname.endsWith('_intn')) {\r\n        detectedIntensity = true;\r\n      }\r\n    }\r\n    let volDst = this.m_volumeSet.getVolume(0);\r\n    if (this.m_fileIndex > VALID_NUM_FILES_2) {\r\n      volDst = this.m_volumeRoi;\r\n    }\r\n    if (detectedIntensity) {\r\n      volDst = this.m_volumeSet.getVolume(0);\r\n    }\r\n    if (detectedMask) {\r\n      volDst = this.m_volumeRoi;\r\n      this.roiMode = true;\r\n      // console.log('mask vol by name');\r\n      if (this.m_numFiles !== VALID_NUM_FILES_4) {\r\n        console.log('You need to load 4 files, if one of them has _mask in name');\r\n        return;\r\n      }\r\n    }\r\n\r\n    // read header or image from src files\r\n    let readOk = false;\r\n    if (isHdr) {\r\n      readOk = this.m_loader.readFromBufferHeader(volDst, strContent, callbackProgress, callbackComplete);\r\n    } else {\r\n      readOk = this.m_loader.readFromBufferImage(volDst, strContent, callbackProgress, callbackComplete);\r\n    }\r\n\r\n    // create final volume from readed data\r\n    volDst = this.m_volumeSet.getVolume(0);\r\n    if (readOk && (this.m_fileIndex === this.m_numFiles)) {\r\n      let ok = false;\r\n      if (this.m_numFiles === VALID_NUM_FILES_2) {\r\n        ok = this.m_loader.createVolumeFromHeaderAndImage(volDst);\r\n      } else if (this.m_numFiles === VALID_NUM_FILES_4) {\r\n        // intensity data 16 -> 8 bpp\r\n        ok = this.m_loader.createVolumeFromHeaderAndImage(volDst);\r\n        if (ok) {\r\n          // mix 8 bpp intensity and roi pixels\r\n          ok = this.m_loader.createRoiVolumeFromHeaderAndImage(volDst, this.m_volumeRoi);\r\n        }\r\n      }\r\n      this.callbackReadProgress(1.0);\r\n      if (!ok) {\r\n        this.callbackReadComplete(LoadResult.FAIL);\r\n      } else {\r\n        this.callbackReadComplete(LoadResult.SUCCESS);\r\n      }\r\n    }\r\n\r\n    // read again new file\r\n    if (this.m_fileIndex < this.m_numFiles) {\r\n      this.callbackReadProgress(ratioLoad);\r\n      this.m_fileReader.onloadend = this.onFileContentReadMultipleHdr;\r\n      const file = this.m_files[this.m_fileIndex];\r\n      this.m_fileName = file.name;\r\n      this.m_fileReader.readAsArrayBuffer(file);\r\n    }\r\n\r\n  } // on multuple hdr\r\n\r\n  // on complete read multuple dicom\r\n  callbackCompleteMultipleDicom(errCode) {\r\n    if (errCode !== LoadResult.SUCCESS) {\r\n      const strErr = LoadResult.getResultString(errCode);\r\n      this.setErrorString(strErr);\r\n    }\r\n  }\r\n\r\n  //\r\n  // read from string content in this.m_fileReader.result\r\n  //\r\n  onFileContentReadMultipleDicom() {\r\n    // console.log('UiOpenMenu. onFileContentReadMultipleDicom ...');\r\n    const strContent = this.m_fileReader.result;\r\n    this.m_fileIndex++;\r\n    const ratioLoad = this.m_fileIndex / this.m_numFiles;\r\n    // console.log(`onFileContentReadMultipleDicom. r = ${ratioLoad}`);\r\n    const callbackProgress = null;\r\n    // const callbackComplete = this.callbackReadMultipleComplete;\r\n\r\n    if (this.m_fileIndex <= 1) {\r\n      // add new volume to volume set on the first slice\r\n      const vol = new Volume();\r\n      this.m_volumeSet.addVolume(vol);\r\n      // init progress on the first file loading\r\n      this.callbackReadProgress(0.0);\r\n    }\r\n\r\n    // FIX 05/06/2020: read multiple dicom callback complete \r\n    // can be invoked with error code\r\n    const callbackColmpleteVoid = this.callbackCompleteMultipleDicom;\r\n\r\n    let readStatus;\r\n\r\n    if (READ_DICOM_VIA_DAIKON) {\r\n      readStatus = this.readSliceDicomViaDaikon(this.m_fileIndex - 1, this.m_fileName, ratioLoad, strContent);\r\n    } else {\r\n      readStatus = this.m_volumeSet.readSingleSliceFromDicom(this.m_loader, this.m_fileIndex - 1, \r\n        this.m_fileName, ratioLoad, strContent, callbackProgress, callbackColmpleteVoid);\r\n    }\r\n\r\n    if (readStatus !== LoadResult.SUCCESS) {\r\n      console.log('onFileContentReadMultipleDicom. Error read individual file');\r\n    }\r\n    if ( (readStatus === LoadResult.SUCCESS) && (this.m_fileIndex === this.m_numFiles)) {\r\n      // setup global vars\r\n      const store = this.props;\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_INDEX, volumeIndex: 0 });\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_SET, volumeSet: this.m_volumeSet });\r\n\r\n      // save dicom loader to store\r\n      store.dispatch({ type: StoreActionType.SET_LOADER_DICOM, loaderDicom: this.m_loader });\r\n      // stop show loading progress bar\r\n      this.callbackReadProgress(1.0);\r\n      this.callbackReadComplete(LoadResult.SUCCESS);\r\n\r\n      this.childModalWindowCenterWidth.initWindowRange();\r\n\r\n      // show modal: select window center, width\r\n      this.setState({ showModalWindowCW: true });\r\n      return; // do nothing immediately after: wait for dialog\r\n      /*\r\n\r\n      const numSeries = this.m_loader.m_slicesVolume.m_series.length;\r\n      console.log(`num series = ${numSeries}`);\r\n      const series = this.m_loader.m_slicesVolume.getSeries();\r\n      // save loaded series description to store\r\n      if (numSeries === 1) {\r\n        const indexSerie = 0;\r\n        const hash = series[indexSerie].m_hash;\r\n        this.m_loader.createVolumeFromSlices(this.m_volumeSet, indexSerie, hash);\r\n        this.finalizeSuccessLoadedVolume(this.m_volumeSet, this.m_fileName);\r\n        console.log(`onFileContentReadMultipleDicom read all ${this.m_numFiles} files`);\r\n      } else {\r\n        // now we have loaded more then 1 series from dicon files set\r\n        for (let i = 0; i < numSeries; i++) {\r\n          const hashCode = series[i].m_hash;\r\n          this.m_loader.createVolumeFromSlices(this.m_volumeSet, i, hashCode);\r\n        }\r\n        this.finalizeSuccessLoadedVolume(this.m_volumeSet, this.m_fileName);\r\n        console.log(`onFileContentReadMultipleDicom create ${numSeries} volumes for ${this.m_numFiles} files`);\r\n\r\n        // setup dicom series (volumes info) for global store: select volume later\r\n        const store = this.props;\r\n        store.dispatch({ type: StoreActionType.SET_DICOM_SERIES, dicomSeries: series });\r\n      }\r\n      \r\n      this.callbackReadProgress(1.0);\r\n      this.callbackReadComplete(LoadResult.SUCCESS);\r\n      */\r\n    } // end if successfully read all files (multiple dicom read)\r\n    // read again new file\r\n    if (readStatus === LoadResult.SUCCESS) {\r\n      if (this.m_fileIndex < this.m_numFiles) {\r\n        // print console loading progress\r\n        const NUM_PARTS_REPORT = 16;\r\n        const STEP_PROGRESS = Math.floor(this.m_numFiles / NUM_PARTS_REPORT);\r\n        if ((this.m_fileIndex % STEP_PROGRESS) === 0) {\r\n          // console.log(`onFileContentReadMultipleDicom. Loading completed = ${ratioLoad}`);\r\n          this.callbackReadProgress(ratioLoad);\r\n        }\r\n  \r\n        this.m_fileReader.onloadend = this.onFileContentReadMultipleDicom;\r\n        const file = this.m_files[this.m_fileIndex];\r\n        this.m_fileName = file.name;\r\n        this.m_fileReader.readAsArrayBuffer(file);\r\n      } // if still need files\r\n    } else {\r\n      const arrErr = [];\r\n      const strErr = this.props.arrErrors[0];\r\n      arrErr.push(strErr);\r\n      this.finalizeFailedLoadedVolume(this.m_volumeSet, this.m_fileName, arrErr);\r\n    } // if result is not success\r\n  }\r\n\r\n  //\r\n  // Perform open file after it selected in dialog\r\n  handleFileSelected(evt) {\r\n    if (evt.target.files !== undefined) {\r\n      let numFiles = evt.target.files.length;\r\n      console.log(`UiOpenMenu. Trying to open ${numFiles} files`);\r\n      if (numFiles <= 0) {\r\n        return;\r\n      }\r\n      console.log(`UiOpenMenu. handleFileSelected. file[0] = ${evt.target.files[0].name}`);\r\n      this.m_volumeSet = new VolumeSet();\r\n      if (numFiles === 1) {\r\n        const file = evt.target.files[0];\r\n        this.m_fileName = file.name;\r\n\r\n        //  read gzip\r\n        if (this.m_fileName.endsWith('.gz')) {\r\n          // here will be result raw buffer\r\n          this.m_unzippedBuffer = null;\r\n\r\n          // remove last 3 chars form file name string\r\n          this.m_fileName = this.m_fileName.slice(0, -3);\r\n\r\n          const store = this.props;\r\n\r\n          const gunzip = zlib.createGunzip();\r\n          createReadStream(file).pipe(gunzip);\r\n          gunzip.on('data', (data) => {\r\n            // progress\r\n            const uiapp = store.uiApp;\r\n            if (this.m_unzippedBuffer == null) {\r\n              uiapp.doShowProgressBar('Read gzip...');\r\n            } else {\r\n              const readSize = this.m_unzippedBuffer.length;\r\n              const allSize = file.size;\r\n              const KOEF_DEFLATE = 0.28;\r\n              const ratio100 = Math.floor(readSize * 100.0 * KOEF_DEFLATE / allSize);\r\n              uiapp.doSetProgressBarRatio(ratio100);\r\n            }\r\n\r\n            // read the data chunk-by-chunk\r\n            // data is Uint8Array\r\n            const dataSize = data.length;\r\n            if (this.m_unzippedBuffer == null) {\r\n              // create buffer from first ungzipped data chunk\r\n              this.m_unzippedBuffer = new Uint8Array(dataSize);\r\n              this.m_unzippedBuffer.set(data, 0);\r\n            } else {\r\n              // append buffer from 2,3,... ungzipped data chunks\r\n              const dataCollectedSize = this.m_unzippedBuffer.length;\r\n              const arrNew = new Uint8Array(dataCollectedSize + dataSize);\r\n              arrNew.set(this.m_unzippedBuffer, 0);\r\n              arrNew.set(data, dataCollectedSize);\r\n              this.m_unzippedBuffer = arrNew;\r\n            }\r\n          });\r\n          gunzip.on('close', () => {\r\n            console.log('gzip on close');\r\n          });\r\n\r\n          gunzip.on('end', () => {\r\n            // close progress\r\n            const uiapp = store.uiApp;\r\n            uiapp.doHideProgressBar();\r\n\r\n            // now all chunks are read. Need to check raw ungzipped buffer\r\n            const sizeBuffer = this.m_unzippedBuffer.length;\r\n            if (sizeBuffer < 128) {\r\n              console.log('Too small ungzipped data: ' + sizeBuffer.toString() + ' bytes. canat read volume data');\r\n              return;\r\n            }\r\n            // check correct nifti header after extract raw bytes from gzip\r\n            const headTemplate = [0x00, 0x00, 0x01, 0x5c];\r\n            let correctHead0 = true;\r\n            for (let i = 0; i < 4; i++) {\r\n              if (this.m_unzippedBuffer[i] !== headTemplate[i]) {\r\n                correctHead0 = false;\r\n              }\r\n            }\r\n            let correctHead1 = true;\r\n            for (let i = 0; i < 4; i++) {\r\n              if (this.m_unzippedBuffer[i] !== headTemplate[3 - i]) {\r\n                correctHead1 = false;\r\n              }\r\n            }\r\n            if (!correctHead0 && !correctHead1) {\r\n              console.log('Wrong nifi header, cant read gzipped file');\r\n              return;\r\n            }\r\n            console.log('ungzip done with ' + sizeBuffer.toString() + ' bytes. Correct nifti header detected');\r\n            // process raw data buffer\r\n            this.onFileReadSingleBuffer(this.m_unzippedBuffer);\r\n          });\r\n          return;\r\n        } // if gzipped file\r\n\r\n        this.m_fileReader = new FileReader();\r\n        this.m_fileReader.onloadend = this.onFileContentReadSingleFile;\r\n        this.m_fileReader.readAsArrayBuffer(file);\r\n      } else {\r\n        // not single file was open\r\n        this.m_files = Array.from(evt.target.files); // FileList -> Array\r\n        this.m_fileIndex = 0;\r\n        this.m_numFiles = numFiles;\r\n        this.m_fileReader = new FileReader();\r\n        // if multiple files, create Dicom loader\r\n        this.m_loader = null;\r\n        if (evt.target.files[0].name.endsWith(\".dcm\")) {\r\n\r\n          // remove non-dcm files\r\n          let numFilesNew = 0;\r\n          for (let i = numFiles - 1; i >= 0; i--) {\r\n            if (this.m_files[i].name.endsWith(\".dcm\")) {\r\n              numFilesNew ++;\r\n            } else {\r\n              this.m_files.splice(i, 1);\r\n            }\r\n\r\n          }\r\n          numFiles = numFilesNew;\r\n          this.m_numFiles = numFilesNew;\r\n          \r\n          this.m_loader = new LoaderDicom(numFiles);\r\n          const dicomInfo = this.m_loader.m_dicomInfo;\r\n\r\n          // save dicomInfo to store\r\n          const store = this.props;\r\n          store.dispatch({ type: StoreActionType.SET_DICOM_INFO, dicomInfo: dicomInfo });\r\n\r\n          // save dicom loader to store\r\n          store.dispatch({ type: StoreActionType.SET_LOADER_DICOM, loaderDicom: this.m_loader });\r\n\r\n          this.m_fileReader.onloadend = this.onFileContentReadMultipleDicom;\r\n        } else if ((evt.target.files[0].name.endsWith(\".hdr\")) || (evt.target.files[0].name.endsWith(\".img\"))) {\r\n          this.m_loader = new LoaderHdr(numFiles);\r\n          this.m_fileReader.onloadend = this.onFileContentReadMultipleHdr;\r\n        }\r\n        \r\n        //const vol = new Volume();\r\n        //this.m_volume = vol;\r\n        this.m_volumeRoi = null;\r\n\r\n        const file = evt.target.files[0];\r\n        this.m_fileName = file.name;\r\n        this.m_fileReader.readAsArrayBuffer(file);\r\n      } // if num files > 1\r\n    } // if event is mnot empty\r\n  }\r\n\r\n  buildFileSelector() {\r\n    const fileSelector = document.createElement('input');\r\n    fileSelector.setAttribute('type', 'file');\r\n    // fileSelector.setAttribute('accept', '.ktx,.dcm,.nii,.hdr,.h,.img,.gz');\r\n    // fileSelector.setAttribute('multiple', '');\r\n    fileSelector.onchange = this.handleFileSelected;\r\n    return fileSelector;\r\n  }\r\n\r\n  onButtonLocalFile(evt) {\r\n    console.log(\"Losing my mind\");\r\n    // console.log('onButtonLocalFile started');\r\n    evt.preventDefault();\r\n    console.log(evt);\r\n    this.m_fileSelector.click();\r\n  }\r\n\r\n  //\r\n  onModalUrlShow() {\r\n    console.log(`onModalUrlShow`);\r\n    this.setState({ strUrl: '' }); \r\n    this.setState({ showModalUrl: true });\r\n  }\r\n\r\n  onModalUrlHide() {\r\n    console.log(`onModalUrlHide`);\r\n    this.setState({ showModalUrl: false });\r\n  }\r\n\r\n  onChangeUrlString(evt) {\r\n    const str = evt.target.value;\r\n    this.setState({ strUrl: str }); \r\n    // console.log(`onChangeUrlString. str = ${str}`)\r\n  }\r\n\r\n  callbackReadCompleteUrlKtxNii(codeResult) {\r\n    if (codeResult !== LoadResult.SUCCESS) {\r\n      console.log(`onCompleteFromUrlKtx. Bad result: ${codeResult}`);\r\n\r\n      const arrErrors = [];\r\n      const strErr = LoadResult.getResultString(codeResult);\r\n      arrErrors.push(strErr);\r\n      this.finalizeFailedLoadedVolume(this.m_volumeSet, this.m_fileName, arrErrors);\r\n      return;\r\n    } else {\r\n      this.finalizeSuccessLoadedVolume(this.m_volumeSet, this.m_fileName);\r\n      this.callbackReadComplete(LoadResult.SUCCESS, null, 0, null);\r\n    }\r\n  }\r\n\r\n  loadFromUrl(strUrl) {\r\n    const fileTools = new FileTools();\r\n    const isValid = fileTools.isValidUrl(strUrl);\r\n    if (isValid) {\r\n      this.m_url = strUrl;\r\n\r\n      this.m_fileName = fileTools.getFileNameFromUrl(strUrl);\r\n      this.m_volumeSet = new VolumeSet();\r\n      this.m_volumeSet.addVolume(new Volume());\r\n\r\n      if (strUrl.endsWith('.ktx')) {\r\n        const callbackProgress = this.callbackReadProgress;\r\n        const callbackComplete = this.callbackReadCompleteUrlKtxNii;\r\n        this.callbackReadProgress(0.0);\r\n        this.m_volumeSet.readFromKtxUrl(strUrl, callbackProgress, callbackComplete);\r\n        // if KTX\r\n      } else if (strUrl.endsWith('.nii')) {\r\n        const callbackProgress = this.callbackReadProgress;\r\n        const callbackComplete = this.callbackReadCompleteUrlKtxNii;\r\n        this.callbackReadProgress(0.0);\r\n        this.m_volumeSet.readFromNiiUrl(strUrl, callbackProgress, callbackComplete);\r\n        // if NII (Nifti format)\r\n      } else if (strUrl.endsWith('.dcm')) {\r\n        if (READ_DICOM_VIA_DAIKON) {\r\n          const loaderUrlDcm = new LoaderDcmUrlDaikon();\r\n          const ret = loaderUrlDcm.readFromUrl(this.m_volumeSet, strUrl, this.callbackReadCompleteUrlKtxNii, this.callbackReadProgress);\r\n          return ret;\r\n        }\r\n\r\n        const callbackProgress = this.callbackReadProgress;\r\n        const callbackComplete = this.callbackReadCompleteUrlKtxNii;\r\n        this.callbackReadProgress(0.0);\r\n        this.m_volumeSet.readFromDicomUrl(strUrl, callbackProgress, callbackComplete);\r\n        // if Dicom\r\n      } else if (strUrl.endsWith('.h')) {\r\n        const callbackProgress = this.callbackReadProgress;\r\n        const callbackComplete = this.callbackReadCompleteUrlKtxNii;\r\n        this.callbackReadProgress(0.0);\r\n        this.m_volumeSet.readFromHdrUrl(strUrl, callbackProgress, callbackComplete);\r\n        // if Hdr\r\n      } else {\r\n        console.log(`UiOpenMenu. Unknow file type from URL = ${strUrl}`);\r\n      }\r\n\r\n      // if valid url\r\n    } else {\r\n      const strErr = `UiOpenMenu. Bad URL = ${strUrl}`;\r\n      console.log(strErr);\r\n      this.setErrorString(strErr);\r\n    }\r\n  }\r\n\r\n  onClickLoadUrl() {\r\n    this.setState({ showModalUrl: false });\r\n    const strUrl = this.state.strUrl;\r\n    console.log(`onClickLoadUrl with strUrl = ${strUrl}`);\r\n    this.loadFromUrl(strUrl);\r\n  }\r\n\r\n  //\r\n  onModalDemoOpenShow() {\r\n    this.setState({ showModalDemo: true });\r\n  }\r\n\r\n  onModalDemoOpenHide() {\r\n    this.setState({ showModalDemo: false });\r\n  }\r\n\r\n  //\r\n  arrNumToStr(arrNums) {\r\n    const numLet = arrNums.length;\r\n    let str = '';\r\n    for (let i = 0; i < numLet; i++) {\r\n      const n = arrNums[i];\r\n      str = str.concat( String.fromCharCode(n) );\r\n    }\r\n    return str;\r\n  }\r\n\r\n  onModalGoogleShow() {\r\n    this.setState({ showModalGoogle: true });\r\n  }\r\n\r\n  onModalGoogleHide() {\r\n    this.setState({ showModalGoogle: false });\r\n  }\r\n\r\n  onGoogleSelected(index) {\r\n    // perform action on click i-th item in Google cloud menu . Or remove this menu completely\r\n    console.log(`onGoogleSelected(${index}) ... `);\r\n  }\r\n\r\n  onDemoSelected(index) {\r\n    const arr = config.demoUrls;\r\n    if (arr.length >= 8) {\r\n      const fileName = arr[index];\r\n      console.log(`onDemoSelected: load file ${fileName}, config[ ${index} ]`);\r\n      this.loadFromUrl(fileName);\r\n      return;\r\n    }\r\n    let fileName = '';\r\n    if (index === 0) {\r\n      // 20101108.ktx\r\n      // const FN_ENCODED = 'http://www.e-joufs.sv/qsjwbuf/nfe4xfc/ebub/luy/31212219.luy';\r\n      const FN_ENCODED = 'https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/31212219.luy';\r\n      const ft = new FileTools();\r\n      fileName = ft.decodeUrl(FN_ENCODED);\r\n      // console.log(`onDemoSelected. enc = ${fileName}`);\r\n    } else if (index === 1) {\r\n      // set00.ktx\r\n      // const FN_ENCO = 'http://www.e-joufs.sv/qsjwbuf/nfe4xfc/ebub/luy/tfu11.luy';\r\n      const FN_ENCO = 'https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/tfu11.luy';\r\n      const ft = new FileTools();\r\n      fileName = ft.decodeUrl(FN_ENCO);\r\n      // console.log(`onDemoSelected. enc = ${fileName}`);\r\n    } else if (index === 2) {\r\n      // gm3 nii\r\n      // const FN_GM_ENCODED = 'http://www.e-joufs.sv/qsjwbuf/nfe4xfc/ebub/ojguj/hn4_623_623_276.ojj';\r\n      const FN_GM_ENCODED = 'https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/hn4_623_623_276.ojj';\r\n      const ft = new FileTools();\r\n      fileName = ft.decodeUrl(FN_GM_ENCODED);\r\n      // fileName = ft.encodeUrl(FN_GM_DECODED);\r\n      // console.log(`onDemoSelected. enc = ${fileName}`);\r\n    } else if (index === 3) {\r\n      const numUrls = config.demoWomanPelvisUrls.length;\r\n      if (numUrls === 0) {\r\n        // woman pelvis\r\n        // const FN_WOMM_ENCODED = 'http://www.e-joufs.sv/qsjwbuf/nfe4xfc/ebub/ejdpn/xpnbo_qfmwjt/wig.:12.edn';\r\n        const FN_WOMM_ENCODED = 'https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/xpnbo_qfmwjt/wig.:12.edn';\r\n        const ft = new FileTools();\r\n        fileName = ft.decodeUrl(FN_WOMM_ENCODED);\r\n      } else {\r\n        const strPrefix = config.demoWomanPelvisPrefix;\r\n        // console.log(`config. prefix = ${strPrefix}`);\r\n        const arrFileNames = [];\r\n        for (let i = 0; i < numUrls; i++) {\r\n          const strFn = config.demoWomanPelvisUrls[i];\r\n          const url = `${strPrefix}${strFn}`;\r\n          arrFileNames.push(url);\r\n        }\r\n        const store = this.props;\r\n        const loader = new LoaderUrlDicom(store);\r\n        const GOOGLE_HEADER = false;\r\n        loader.loadFromUrlArray(arrFileNames, GOOGLE_HEADER);\r\n        return;\r\n      }\r\n    } else if (index === 4) {\r\n      const numUrls = config.demoLungsUrls.length;\r\n      if (numUrls === 0) {\r\n        // lungs dicom 00cba..957e.dcm\r\n        // const FN_OCB_ENCODED = 'http://www.e-joufs.sv/qsjwbuf/nfe4xfc/ebub/ejdpn/11dcb1:2gb5be73dd4311b768bfc:68f/145784245dcfg6fb26gg:f1d91:1611b.edn';\r\n        const FN_OCB_ENCODED = 'https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/11dcb1:2gb5be73dd4311b768bfc:68f/145784245dcfg6fb26gg:f1d91:1611b.edn';\r\n        const ft = new FileTools();\r\n        fileName = ft.decodeUrl(FN_OCB_ENCODED);\r\n      } else {\r\n        const strPrefix = config.demoLungsPrefix;\r\n        console.log(`config. Lungs prefix = ${strPrefix}`);\r\n        const arrFileNames = [];\r\n        for (let i = 0; i < numUrls; i++) {\r\n          const strFn = config.demoLungsUrls[i];\r\n          const url = `${strPrefix}${strFn}`;\r\n          arrFileNames.push(url);\r\n        }\r\n        const store = this.props;\r\n        const loader = new LoaderUrlDicom(store);\r\n        const GOOGLE_HEADER = false;\r\n        loader.loadFromUrlArray(arrFileNames, GOOGLE_HEADER);\r\n        return;\r\n      }\r\n    } else if (index === 5) {\r\n      // ct_256_256_256.ktx\r\n      // const FN_CT256_ENCODED = 'http://www.e-joufs.sv/qsjwbuf/nfe4xfc/ebub/luy/du_367_367_367.luy';\r\n      const FN_CT256_ENCODED = 'https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/du_367_367_367.luy';\r\n      const ft = new FileTools();\r\n      fileName = ft.decodeUrl(FN_CT256_ENCODED);\r\n      // fileName = ft.encodeUrl(FN_CT256_DECODED);\r\n      // console.log(`onDemoSelected. enc = ${fileName}`);\r\n    } else if (index === 6) {\r\n      // lungs_256_256_256.ktx\r\n      // const FN_LUNGS256_ENCODED = 'http://www.e-joufs.sv/qsjwbuf/nfe4xfc/ebub/luy/mvoht_367_367_367.luy';\r\n      const FN_LUNGS256_ENCODED = 'https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/mvoht_367_367_367.luy';\r\n      const ft = new FileTools();\r\n      fileName = ft.decodeUrl(FN_LUNGS256_ENCODED);\r\n      // fileName = ft.encodeUrl(FN_LUNGS256_DECODED);\r\n      // console.log(`onDemoSelected. enc = ${fileName}`);\r\n    } else if (index === 7) {\r\n      // hdr set (roi)\r\n      // const FN_HDRSET_ENCODED = 'http://www.e-joufs.sv/qsjwbuf/nfe4xfc/ebub/ies/tfu_jouo.i';\r\n      const FN_HDRSET_ENCODED = 'https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/ies/tfu_jouo.i';\r\n      const ft = new FileTools();\r\n      fileName = ft.decodeUrl(FN_HDRSET_ENCODED);\r\n    } else {\r\n      console.log(`onDemoSelected. not implemented for index = ${index}`);\r\n    }\r\n    if (fileName.length > 0) {\r\n      this.loadFromUrl(fileName);\r\n    } // if fileName not empty\r\n  } // end of onDemoSelected\r\n\r\n  //\r\n  shouldComponentUpdate() {\r\n    return true;\r\n  }\r\n\r\n  onModalDicomSeriesHide() {\r\n    const arrEmpty = [];\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_DICOM_SERIES, dicomSeries: arrEmpty });\r\n  }\r\n\r\n  onDicomSerieSelected(indexSelected) {\r\n    const store = this.props;\r\n    const series = store.dicomSeries;\r\n    const serieSelected = series[indexSelected];\r\n    const hash = serieSelected.m_hash;\r\n    this.m_loader.createVolumeFromSlices(this.m_volumeSet, indexSelected, hash);\r\n    this.finalizeSuccessLoadedVolume(this.m_volumeSet, this.m_fileName);\r\n    console.log(`onFileContentReadMultipleDicom read all ${this.m_numFiles} files`);\r\n\r\n    // clear modal\r\n    store.dispatch({ type: StoreActionType.SET_DICOM_SERIES, dicomSeries: [] });\r\n  }\r\n\r\n  //\r\n  onModalWindowCWHide(needShow) {\r\n    this.setState({ showModalWindowCW: false });\r\n    if (needShow) {\r\n      this.finalizeSuccessLoadedVolume(this.m_volumeSet, this.m_fileName);\r\n      // setup dicom series (volumes info) for global store: select volume later\r\n      const store = this.props;\r\n      let series = null;\r\n      if (this.m_loader !== undefined) {\r\n        series = this.m_loader.m_slicesVolume.getSeries();\r\n        store.dispatch({ type: StoreActionType.SET_DICOM_SERIES, dicomSeries: series });\r\n      }\r\n      // update graphics 2d window\r\n      const gra = store.graphics2d;\r\n      if (gra !== null) {\r\n        gra.forceUpdate();\r\n      }\r\n    }\r\n  }\r\n\r\n  //\r\n  // invoked after render\r\n  //\r\n  componentDidMount() {\r\n    this.m_fileSelector = this.buildFileSelector();\r\n    const fileNameOnLoad = this.m_fileNameOnLoad;\r\n    // console.log(`UiOpenMenu. componentDidMount. fnonl = ${fileNameOnLoad}`);\r\n    if ((fileNameOnLoad.length > 0) && (this.state.onLoadCounter > 0)) {\r\n      this.setState({ onLoadCounter: 0 });\r\n      const TIMEOUT_MS = 50;\r\n      setTimeout( this.loadFromUrl(fileNameOnLoad), TIMEOUT_MS );\r\n    }\r\n  }\r\n\r\n  // render\r\n  render() {\r\n    const isGoogle = config.googleCloudDemoActivce;\r\n\r\n    const fileNameOnLoad = this.props.fileNameOnLoad;\r\n    this.m_fileNameOnLoad = fileNameOnLoad;\r\n    // console.log(`UiOpenMenu. render. fnol = ${this.m_fileNameOnLoad}`);\r\n    let jsxOnLoad = '';\r\n    if (fileNameOnLoad.length > 2) {\r\n      jsxOnLoad = <p></p>;\r\n      return jsxOnLoad;\r\n    }\r\n\r\n    const jsGoo = (isGoogle) ? \r\n      <NavDropdown.Item onClick={this.onModalGoogleShow} >\r\n        <i className=\"fas fa-brain\"></i>\r\n        Google cloud models\r\n      </NavDropdown.Item> : \r\n      <p></p>;\r\n\r\n    const jsDemo = (NEED_DEMO_MENU) ?\r\n      <NavDropdown.Item href=\"#actionOpenDemo\" onClick={this.onModalDemoOpenShow} >\r\n        <i className=\"fas fa-brain\"></i>\r\n        Demo models Open\r\n      </NavDropdown.Item> :\r\n      <p></p>;\r\n\r\n    const jsVidiver = (isGoogle || NEED_DEMO_MENU) ?\r\n      <NavDropdown.Divider /> :\r\n      <p></p>;\r\n\r\n    // const store = this.props;\r\n    // const isVisibleDicomSeries = (store.dicomSeries.length !== 0);\r\n\r\n    const jsxOpenMenu =\r\n      <NavDropdown id=\"basic-nav-dropdown\" title={\r\n        <div style={{ display: 'inline-block' }}> \r\n          <i className=\"fas fa-folder-open\"></i>\r\n          Open333\r\n        </div>\r\n      } >\r\n        <NavDropdown.Item href=\"#actionOpenComputer\" onClick={evt => this.onButtonLocalFile(evt)}>\r\n          <i className=\"fas fa-desktop\"></i>\r\n          Computer\r\n        </NavDropdown.Item>\r\n        <NavDropdown.Item href=\"#actionOpenUrl\" onClick={this.onModalUrlShow} >\r\n          <i className=\"fas fa-globe-americas\"></i>\r\n          Url\r\n        </NavDropdown.Item>\r\n\r\n        {jsVidiver}\r\n\r\n        {jsGoo}\r\n\r\n        {jsDemo}\r\n\r\n        <Modal show={this.state.showModalUrl} onHide={this.onModalUrlHide} >\r\n          <Modal.Title>\r\n            Load data from external source\r\n          </Modal.Title>\r\n\r\n          <Modal.Header closeButton>\r\n            <Modal.Body>\r\n\r\n              <InputGroup className=\"mb-3\">\r\n                <InputGroup.Prepend>\r\n                  <InputGroup.Text id=\"inputGroup-sizing-default\">\r\n                    Input URL to open\r\n                  </InputGroup.Text>\r\n                </InputGroup.Prepend>\r\n                <FormControl\r\n                  placeholder=\"Enter URL here\"\r\n                  aria-label=\"Default\"\r\n                  aria-describedby=\"inputGroup-sizing-default\"\r\n                  onChange={this.onChangeUrlString.bind(this)} />\r\n                <InputGroup.Append>\r\n                  <Button variant=\"outline-secondary\" onClick={this.onClickLoadUrl}>\r\n                    Load\r\n                  </Button>\r\n                </InputGroup.Append>\r\n              </InputGroup>\r\n\r\n            </Modal.Body>\r\n          </Modal.Header>\r\n        </Modal>\r\n\r\n        <UiModalDemo stateVis={this.state.showModalDemo}\r\n          onHide={this.onModalDemoOpenHide} onSelectDemo={this.onDemoSelected}  />\r\n        <UiModalGoogle stateVis={this.state.showModalGoogle}\r\n          onHide={this.onModalGoogleHide} onSelectDemo={this.onGoogleSelected}  \r\n          arrMenu={config.arrMenuGoogle}/>\r\n        <UiModalWindowCenterWidth stateVis={this.state.showModalWindowCW} volSet={this.m_volumeSet}\r\n          onHide={this.onModalWindowCWHide} onRef={ ref => (this.childModalWindowCenterWidth = ref)} />\r\n\r\n      </NavDropdown>\r\n\r\n    // return (jsxOnLoad.length > 1) ? jsxOnLoad : jsxOpenMenu;\r\n    return jsxOpenMenu;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiOpenMenu);\r\n","/**\r\n * @fileOverview UiViewMode\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { ButtonToolbar, Button, ButtonGroup } from 'react-bootstrap';\r\nimport { OverlayTrigger, Tooltip } from 'react-bootstrap';\r\n\r\nimport ModeView from '../store/ModeView';\r\nimport StoreActionType from '../store/ActionTypes';\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n\r\n\r\n/**\r\n * Class UiViewMode some text later...\r\n */\r\nclass UiViewMode extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    // main view configuration\r\n    // setup true, where you want to see mode renderer\r\n    //\r\n    this.m_needModeMpr = true;\r\n    this.m_needMode2d = true;\r\n    this.m_needMode3dLight = true;\r\n    this.m_needMode3d = true;\r\n\r\n    this.onModeMpr = this.onModeMpr.bind(this);\r\n    this.onMode2d = this.onMode2d.bind(this);\r\n    this.onMode3dLight = this.onMode3dLight.bind(this);\r\n    this.onMode3d = this.onMode3d.bind(this);\r\n    this.onTool3d = this.onTool3d.bind(this);\r\n    this.onView3d = this.onView3d.bind(this);\r\n  }\r\n\r\n  onMode(indexMode) {\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_MODE_VIEW, modeView: indexMode });\r\n  }\r\n\r\n  onTool_View(isOn) {\r\n    const store = this.props;\r\n    store.dispatch({ type: StoreActionType.SET_IS_TOOL3D, isTool3D: isOn });\r\n    store.dispatch({ type: StoreActionType.SET_SLIDER_Contrast3D, sliderContrast3D: 0 });    \r\n  }\r\n\r\n  onModeMpr() {\r\n    this.onMode(ModeView.VIEW_MPR);\r\n  }\r\n\r\n  onMode2d() {\r\n    this.onMode(ModeView.VIEW_2D);\r\n  }\r\n\r\n  onMode3dLight() {\r\n    this.onMode(ModeView.VIEW_3D_LIGHT);\r\n  }\r\n\r\n  onMode3d() {\r\n    this.onMode(ModeView.VIEW_3D);\r\n  }\r\n\r\n  onTool3d() {\r\n    this.onTool_View(true);\r\n  }\r\n\r\n  onView3d() {\r\n    this.onTool_View(false);\r\n  }\r\n\r\n  logObject(strTitle, obj) {\r\n    let str = '';\r\n    for (let prp in obj) {\r\n      if (str.length > 0) {\r\n        str += '\\n';\r\n      }\r\n      str += prp + ' = ' + obj[prp];\r\n    }\r\n    console.log(`${strTitle}\\n${str}`);\r\n  }\r\n\r\n  render() {\r\n    const store = this.props;\r\n    // this.logObject('UiViewMode this props: ', store);\r\n    let viewMode = store.modeView;\r\n    let isTool3D = store.isTool3D;\r\n    if ((viewMode === ModeView.VIEW_MPR) && (!this.m_needModeMpr)) {\r\n      viewMode = ModeView.VIEW_2D;\r\n    }\r\n    if ((viewMode === ModeView.VIEW_3D_LIGHT) && (!this.m_needMode3dLight)) {\r\n      viewMode = ModeView.VIEW_2D;\r\n    }\r\n    if ((viewMode === ModeView.VIEW_3D) && (!this.m_needMode3d)) {\r\n      viewMode = ModeView.VIEW_2D;\r\n    }\r\n    if ((viewMode === ModeView.VIEW_2D) && (!this.m_needMode2d)) {\r\n      viewMode = ModeView.VIEW_3D;\r\n    }\r\n\r\n    // const strMpr = (viewMode === ModeView.VIEW_MPR) ? 'primary' : 'secondary';\r\n    const str2d = (viewMode === ModeView.VIEW_2D) ? 'primary' : 'secondary';\r\n    const str3dLight = (viewMode === ModeView.VIEW_3D_LIGHT) ? 'primary' : 'secondary';\r\n    const str3d = (viewMode === ModeView.VIEW_3D) ? 'primary' : 'secondary';\r\n\r\n    const strTool3Don = (viewMode === ModeView.VIEW_3D_LIGHT && isTool3D === true) ? 'primary' : 'secondary';\r\n    const strTool3Doff = (viewMode === ModeView.VIEW_3D_LIGHT && isTool3D === false) ? 'primary' : 'secondary';\r\n\r\n    const jsx3d =\r\n    <OverlayTrigger key=\"3d\" placement=\"bottom\" overlay={\r\n      <Tooltip>\r\n        Show volume in 3d mode with old rendering\r\n      </Tooltip>\r\n    }>\r\n      <Button variant={str3d} onClick={this.onMode3d} >\r\n        3D\r\n      </Button>\r\n    </OverlayTrigger>\r\n      \r\n    const jsxViewTool =\r\n    <ButtonGroup className=\"mr-2\" aria-label=\"Top group\">\r\n      <OverlayTrigger key=\"view\" placement=\"bottom\" overlay={\r\n        <Tooltip>\r\n          Show volume in 3d mode with fast rendering\r\n        </Tooltip>\r\n      }>\r\n        <Button variant={strTool3Doff} onClick={this.onView3d} >\r\n          View\r\n        </Button>\r\n      </OverlayTrigger>\r\n      <OverlayTrigger key=\"tool\" placement=\"bottom\" overlay={\r\n        <Tooltip>\r\n          Show volume in 2d mode per slice on selected orientation\r\n        </Tooltip>\r\n      }>\r\n        <Button variant={strTool3Don} onClick={this.onTool3d} >\r\n          Tool\r\n        </Button>\r\n      </OverlayTrigger>\r\n    </ButtonGroup>\r\n\r\n    const FOUR = 4;\r\n    let needShow3d = false;\r\n\r\n    const volSet = store.volumeSet;\r\n    if (volSet.getNumVolumes() > 0) {\r\n      const volIndex = store.volumeIndex;\r\n      const vol = volSet.getVolume(volIndex);\r\n      if (vol !== null) {\r\n        if (vol.m_bytesPerVoxel !== FOUR) {\r\n          needShow3d = true;\r\n        }\r\n      }\r\n    } // if more 0 volumes\r\n    const test = true;\r\n    const jsxOut = \r\n      <ButtonToolbar ria-label=\"Toolbar with button groups\">\r\n        <ButtonGroup className=\"mr-2\" aria-label=\"Top group\">\r\n \r\n          <OverlayTrigger key=\"2d\" placement=\"bottom\" overlay={\r\n            <Tooltip>\r\n              Show volume in 2d mode per slice on selected orientation\r\n            </Tooltip>\r\n          }>\r\n\r\n            <Button variant={str2d} onClick={this.onMode2d} >\r\n              2D\r\n            </Button>\r\n          </OverlayTrigger>  \r\n\r\n          <OverlayTrigger key=\"3dLight\" placement=\"bottom\" overlay={\r\n            <Tooltip>\r\n              Show volume in 3d mode with fast rendering\r\n            </Tooltip>\r\n          }>\r\n\r\n            <Button variant={str3dLight} onClick={this.onMode3dLight} >\r\n              3D\r\n              <span className=\"fa fa-bolt\"></span>\r\n            </Button>\r\n\r\n          </OverlayTrigger>  \r\n          {(needShow3d) ? jsx3d : ''}\r\n        </ButtonGroup>\r\n        {(viewMode === ModeView.VIEW_3D_LIGHT && test) ? jsxViewTool : ''}\r\n      </ButtonToolbar>\r\n\r\n    return jsxOut;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiViewMode);\r\n","/**\r\n * @fileOverview UiSkelAni\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiSkelAni some text later...\r\n */\r\nclass UiSkelAni extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.animate = this.animate.bind(this);\r\n\r\n    this.m_mount = null;\r\n    this.m_frameId = null;\r\n\r\n  }\r\n\r\n  animate() {\r\n    this.renderWithCtx();\r\n    this.m_frameId = window.requestAnimationFrame(this.animate);\r\n  }\r\n\r\n  start() {\r\n    if (this.m_frameId === null) {\r\n      this.m_frameId = requestAnimationFrame(this.animate);\r\n    }\r\n  }\r\n\r\n  stop() {\r\n    cancelAnimationFrame(this.m_frameId);\r\n    this.m_frameId = null;\r\n  }\r\n\r\n  componentDidMount() {\r\n    // console.log('UiSkelAni. start animations');\r\n    this.start();\r\n  }\r\n\r\n  componentWillUnmount() {\r\n    // console.log('UiSkelAni. stop animations');\r\n    this.stop();\r\n  }\r\n\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    const strStyle = {\r\n      border: '0px solid black'\r\n    };\r\n    const jsxAni = <canvas className=\"img-responsive\" style={strStyle} ref={ (mount) => {this.m_mount = mount} } min-width=\"240px\" width=\"240px\" height=\"200px\" />\r\n    return jsxAni;\r\n  } // end render\r\n\r\n  /**\r\n   * Draw center part of lungs pixtre\r\n   * \r\n   * @param {object} ctx \r\n   * @param {number} w - screen width\r\n   * @param {number} h - screen heigth\r\n   * @param {number} timeCur - current time\r\n   */\r\n  drawCentral(ctx, w, h, timeCur) {\r\n    ctx.strokeStyle = 'rgb(190, 190, 190)';\r\n    ctx.lineWidth = 4;\r\n    const w2 = Math.floor(w * 0.5);\r\n\r\n    const W_REF = 240.0;\r\n    const H_REF = 200.0;\r\n\r\n    const Y_SPINE_LINE_TOP = 88.0;\r\n    const Y_SPINE_MARK_TOP = 131.0;\r\n    const Y_SPINE_BOT = 195.0;\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(w2, Math.floor(h * Y_SPINE_BOT / H_REF));\r\n    ctx.lineTo(w2, Math.floor(h * Y_SPINE_LINE_TOP / H_REF));\r\n    ctx.stroke();\r\n\r\n    const MARK_WIDTH = w * 20.0 / W_REF;\r\n    const NUM_SPINE_MARKS = 5;\r\n    for (let i = 0; i <= NUM_SPINE_MARKS; i++) {\r\n      const tHeight = i / NUM_SPINE_MARKS;\r\n      const y = Math.floor(Y_SPINE_MARK_TOP + (Y_SPINE_BOT - Y_SPINE_MARK_TOP) * tHeight);\r\n\r\n      const TIME_MULT = 0.0008;\r\n      const PHASE_MULT = 3.1415926 * 0.4;\r\n      const timeArg = timeCur * TIME_MULT + (tHeight * PHASE_MULT);\r\n      const wCur = Math.floor(MARK_WIDTH * 0.2 + 0.8 * MARK_WIDTH * Math.cos(timeArg));\r\n\r\n      ctx.beginPath();\r\n      ctx.moveTo(w2 - wCur * 0.5, y);\r\n      ctx.lineTo(w2 + wCur * 0.5, y);\r\n      ctx.stroke();\r\n    } // for u all marks on vert spine\r\n\r\n    // draw top \"heart\" shape\r\n\r\n    const shp = [\r\n      112, 89,\r\n      112, 81,\r\n      112, 62,\r\n      112, 49,\r\n      113, 36,\r\n      104, 31,\r\n      94, 32,\r\n      94, 20,\r\n      96, 8,\r\n      108, 8,\r\n      112, 11,\r\n      120, 12,\r\n      128, 11,\r\n      132, 8,\r\n      146, 8,\r\n      146, 20,\r\n      146, 32,\r\n      136, 31,\r\n      127, 36,\r\n      128, 49,\r\n      128, 62,\r\n      128, 81,\r\n      128, 89,\r\n      119, 88\r\n    ];\r\n    const numPointsInShape = Math.floor(shp.length / 2);\r\n    const numCurves2nd = Math.floor(numPointsInShape / 2);\r\n\r\n    ctx.fillStyle = 'rgb(255, 210, 210)';\r\n    ctx.beginPath();\r\n    ctx.moveTo(w2, Math.floor(h * Y_SPINE_LINE_TOP / H_REF));\r\n    let j = 0;\r\n    for (let s = 0; s < numCurves2nd; s++, j += 4) {\r\n      const x1 = Math.floor(w * shp[j + 0] / W_REF);\r\n      const y1 = Math.floor(h * shp[j + 1] / H_REF);\r\n      const x2 = Math.floor(w * shp[j + 2] / W_REF);\r\n      const y2 = Math.floor(h * shp[j + 3] / H_REF);\r\n      ctx.quadraticCurveTo(x1, y1, x2, y2);\r\n    }\r\n    ctx.stroke();\r\n    ctx.fill();\r\n  } // draw central\r\n\r\n  /**\r\n   * Transform pic coords to screen coords with current object center (xHeart, yHeart) ,\r\n   * scale and mirror feature\r\n   * \r\n   * @param {*} xHeart \r\n   * @param {*} yHeart \r\n   * @param {*} scale \r\n   * @param {*} isMirroredX \r\n   * @param {*} x \r\n   * @param {*} y \r\n   * @param {*} vec \r\n   */\r\n  static vecTransform(xHeart, yHeart, scale, isMirroredX, x, y, vec) {\r\n    const X_HEART = 178.0;\r\n    const Y_HEART = 112.0;\r\n    const xRelCenter = (isMirroredX) ? (X_HEART - x) : (x - X_HEART);\r\n    const yRelCenter = (y - Y_HEART);\r\n    vec.x = xHeart + (xRelCenter * scale);\r\n    vec.y = yHeart + (yRelCenter * scale);\r\n  }\r\n\r\n  /**\r\n   * Draw small leave near line segment of blood vessel\r\n   * \r\n   * @param {object} ctx \r\n   * @param {number} x0 - first point, x coordinate\r\n   * @param {number} y0 - first point, y coordinate\r\n   * @param {number} x1 - second point, x coordinate\r\n   * @param {number} y1 - second point, y coordinate\r\n   * @param {number} index - index of point in set\r\n   */\r\n  static drawLeave(ctx, x0, y0, x1, y1, index) {\r\n    const dx = x1 - x0;\r\n    const dy = y1 - y0;\r\n    const ang = ((index & 1) === 0) ? (25.0 * 3.14 / 180.0) : -(25.0 * 3.14 / 180.0);\r\n    const vx = dx * Math.cos(ang) - dy * Math.sin(ang);\r\n    const vy = dx * Math.sin(ang) + dy * Math.cos(ang);\r\n    const xc = Math.floor((x0 + x1) * 0.5);\r\n    const yc = Math.floor((y0 + y1) * 0.5);\r\n\r\n    const MULT = 0.8;\r\n\r\n    ctx.beginPath();\r\n    ctx.moveTo(xc, yc);\r\n    ctx.lineTo(Math.floor(xc + vx * MULT), Math.floor(yc + vy * MULT));\r\n    ctx.stroke();\r\n  }\r\n\r\n  /**\r\n   * Render single heart\r\n   * \r\n   * @param {object} ctx - context to render 2d\r\n   * @param {number} w - screen width\r\n   * @param {number} h - screen height\r\n   * @param {number} xHeart - center x of heart\r\n   * @param {number} yHeart - xenter y of heart\r\n   * @param {boolean} isMirroredX - is right (non mirrored)\r\n   * @param {number} scale - value in [0.5 .. 1.0]\r\n   * @param {number} animParam - value in [0..1]\r\n   */\r\n  drawHeart(ctx, w, h, xHeart, yHeart, isMirroredX, scale, animParam) {\r\n    const W_REF = 240.0;\r\n    const H_REF = 200.0;\r\n    const hp = [\r\n      186, 195,\r\n      179, 195,\r\n      171, 188,\r\n      149, 166,\r\n      132, 126,\r\n      123, 111,\r\n      131, 100,\r\n      145, 78,\r\n      145, 60,\r\n      150, 47,\r\n      159, 50,\r\n      184, 56,\r\n      203, 49,\r\n      213, 41,\r\n      217, 51,\r\n      226, 77,\r\n      218, 104,\r\n      208, 134,\r\n      208, 158,\r\n      207, 167,\r\n      203, 175,\r\n      196, 195,\r\n      186, 195,\r\n    ];\r\n    const numLines = Math.floor((hp.length - 1) / 2);\r\n    const vec0 = { x: 0.0, y: 0.0 };\r\n    const vec1 = { x: 0.0, y: 0.0 };\r\n\r\n    UiSkelAni.vecTransform(xHeart, yHeart, scale, isMirroredX, hp[0], hp[1], vec0);\r\n    UiSkelAni.vecTransform(xHeart, yHeart, scale, isMirroredX, hp[13 * 2 + 0], hp[13 * 2 + 1], vec1);\r\n    const gx0 = Math.floor(w * vec0.x / W_REF);\r\n    const gy0 = Math.floor(h * vec0.y / H_REF);\r\n    const gx1 = Math.floor(w * vec1.x / W_REF);\r\n    const gy1 = Math.floor(h * vec1.y / H_REF);\r\n\r\n    const grad = ctx.createLinearGradient(gx0, gy0, gx1, gy1);\r\n    grad.addColorStop(0.0, 'rgb(86, 0, 0)');\r\n    grad.addColorStop(1.0, 'rgb(255, 170, 170)');\r\n    ctx.fillStyle = grad;\r\n\r\n    ctx.beginPath();\r\n    UiSkelAni.vecTransform(xHeart, yHeart, scale, isMirroredX, hp[0], hp[1], vec0);\r\n    const x0 = Math.floor(w * vec0.x / W_REF);\r\n    const y0 = Math.floor(h * vec0.y / H_REF);\r\n\r\n    ctx.moveTo(x0, y0);\r\n    let j = 2;\r\n    for (let i = 0; i < numLines; i++, j += 4) {\r\n      UiSkelAni.vecTransform(xHeart, yHeart, scale, isMirroredX, hp[j + 0], hp[j + 1], vec0);\r\n      UiSkelAni.vecTransform(xHeart, yHeart, scale, isMirroredX, hp[j + 2], hp[j + 3], vec1);\r\n\r\n      const x0 = Math.floor(w * vec0.x / W_REF);\r\n      const y0 = Math.floor(h * vec0.y / H_REF);\r\n      const x1 = Math.floor(w * vec1.x / W_REF);\r\n      const y1 = Math.floor(h * vec1.y / H_REF);\r\n      ctx.quadraticCurveTo(x0, y0, x1, y1);\r\n    } // for (i) all points\r\n    ctx.stroke();\r\n    ctx.fill();\r\n\r\n    // draw blood vessels\r\n    const vessel0 = [\r\n      151, 75,\r\n      154, 68,\r\n      155, 61,\r\n      151, 55\r\n    ];\r\n    const vessel1 = [\r\n      145, 89,\r\n      156, 86, \r\n      165, 82,\r\n      172, 77,\r\n      177, 69,\r\n      177, 61\r\n    ];\r\n    const vessel2 = [\r\n      143, 100,\r\n      157, 101,\r\n      168, 98,\r\n      179, 94,\r\n      186, 87,\r\n      192, 80,\r\n      197, 76,\r\n      205, 75\r\n    ];\r\n    const vessel3 = [\r\n      146, 109,\r\n      160, 107,\r\n      172, 107,\r\n      183, 112,\r\n      192, 119,\r\n      199, 125,\r\n      200, 130,\r\n      198, 137,\r\n      195, 142,\r\n      189, 144\r\n    ];\r\n    const vessel4 = [\r\n      145, 123,\r\n      160, 124,\r\n      171, 128,\r\n      178, 138,\r\n      183, 151,\r\n      184, 160,\r\n      181, 168\r\n    ];\r\n    const vessel5 = [\r\n      149, 142,\r\n      161, 146,\r\n      167, 153,\r\n      171, 158,\r\n      171, 164\r\n    ];\r\n    const vessels = [\r\n      vessel0, vessel1, vessel2, vessel3, vessel4, vessel5\r\n    ];\r\n    const strAlpha = animParam.toFixed(2);\r\n    const strColor = 'rgba(180, 180, 180, ' + strAlpha + ')';\r\n    // console.log(`strColor = ${strColor}`);\r\n    ctx.strokeStyle = strColor;\r\n    ctx.lineWidth = 1;\r\n\r\n    const numVessels = vessels.length;\r\n    for (let v = 0; v < numVessels; v++) {\r\n      const ves = vessels[v];\r\n      const numPoints = ves.length;\r\n      ctx.beginPath();\r\n\r\n      let j = 0;\r\n      for (let i = 0; i < numPoints; i++, j += 2) {\r\n        UiSkelAni.vecTransform(xHeart, yHeart, scale, isMirroredX, ves[j + 0], ves[j + 1], vec0);\r\n        const x0 = Math.floor(w * vec0.x / W_REF);\r\n        const y0 = Math.floor(h * vec0.y / H_REF);\r\n        if (i === 0) {\r\n          ctx.moveTo(x0, y0);\r\n        } else {\r\n          ctx.lineTo(x0, y0);\r\n        } // if not first\r\n      } // for (i) all points\r\n      ctx.stroke();\r\n\r\n      let xp = -1;\r\n      let yp = -1;\r\n      j = 0;\r\n      for (let i = 0; i < numPoints; i++, j += 2) {\r\n        UiSkelAni.vecTransform(xHeart, yHeart, scale, isMirroredX, ves[j + 0], ves[j + 1], vec0);\r\n        const x0 = Math.floor(w * vec0.x / W_REF);\r\n        const y0 = Math.floor(h * vec0.y / H_REF);\r\n        if (i === 0) {\r\n        } else {\r\n          UiSkelAni.drawLeave(ctx, xp, yp, x0, y0, i);\r\n        } // if not first\r\n        xp = x0; yp = y0;\r\n      } // for (i) all points\r\n\r\n\r\n    } // for (v) all vessels\r\n\r\n  } // draw heart\r\n\r\n  /**\r\n   * Render scene on canvas\r\n   */\r\n  renderWithCtx() {\r\n    const objCanvas = this.m_mount;\r\n    if (objCanvas === null) {\r\n      return;\r\n    }\r\n    const ctx = objCanvas.getContext('2d');\r\n    const w = objCanvas.clientWidth;\r\n    const h = objCanvas.clientHeight;\r\n    if (w * h === 0) {\r\n      return;\r\n    }\r\n    // console.log(`UiSkelAni. renderCtx. screen = ${w} * ${h}`);\r\n    // clerar all screen\r\n    ctx.fillStyle = 'rgb(250, 250, 250)';\r\n    ctx.fillRect(0,0, w, h);\r\n\r\n    const timeCur = Date.now();\r\n    this.drawCentral(ctx, w, h, timeCur);\r\n\r\n    const MULT_SCALE = 0.001;\r\n    const PHASE_SCALE = 3.14 * 0.5;\r\n    const lAnim = Math.abs( Math.cos(timeCur * MULT_SCALE)  );\r\n    const lScale = 0.6 + 0.4 * lAnim;\r\n    const rAnim = Math.abs( Math.cos((timeCur * MULT_SCALE) + PHASE_SCALE) );\r\n    const rScale = 0.6 + 0.4 * rAnim;\r\n    // console.log(`UiSkelAni. lScale = ${lScale}, rScale = ${rScale}`);\r\n    \r\n    const X_HEART_R = 178.0;\r\n    const Y_HEART_R = 112.0;\r\n    const NOT_MIRR = false;\r\n    this.drawHeart(ctx, w, h, X_HEART_R, Y_HEART_R, NOT_MIRR, rScale, rAnim);\r\n\r\n    const X_HEART_L = 120.0 - 58.0;\r\n    const Y_HEART_L = 112.0;\r\n    const IS_MIRR = true;\r\n    this.drawHeart(ctx, w, h, X_HEART_L, Y_HEART_L, IS_MIRR, lScale, lAnim);\r\n\r\n  } // end of render\r\n\r\n} // end class\r\n\r\nexport default connect(store => store)(UiSkelAni);\r\n","/**\r\n * @fileOverview UiAbout\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { Button } from 'react-bootstrap';\r\nimport { OverlayTrigger, Tooltip } from 'react-bootstrap';\r\nimport { Nav, Modal } from 'react-bootstrap'\r\n\r\nimport packageJson from '../../../package.json';\r\nimport UiSkelAni from './UiSkelAni';\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiAbout dialog\r\n */\r\nexport default class UiAbout extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n    this.state = {\r\n      modalShow: false\r\n    };\r\n    this.onShow = this.onShow.bind(this);\r\n    this.onHide = this.onHide.bind(this);\r\n  }\r\n\r\n  onShow() {\r\n    this.setState({ modalShow: true });\r\n  }\r\n\r\n  onHide() {\r\n    this.setState({ modalShow: false });\r\n  }\r\n\r\n  render() {\r\n\r\n    const strVer = packageJson.version;\r\n    const strName = packageJson.name;\r\n    const strDescription = packageJson.description;\r\n    const strAuthor = packageJson.author;\r\n    const strYear = packageJson.year;\r\n\r\n    const strButtonOnly = \r\n    <Button onClick={this.onShow} variant=\"secondary\">\r\n      <i className=\"fa fa-question-circle\"></i>\r\n      About \r\n    </Button>;\r\n    const strButtonWithTrigger = \r\n    <OverlayTrigger \r\n      key=\"about\"\r\n      placement=\"bottom\"\r\n      overlay = {\r\n        <Tooltip>\r\n          See detailed information about this app\r\n        </Tooltip>\r\n      }\r\n    >\r\n      <Button onClick={this.onShow} variant=\"secondary\">\r\n        <i className=\"fa fa-question-circle\"></i>\r\n        About \r\n      </Button>\r\n    </OverlayTrigger>;\r\n\r\n    const strBtnDynamic = (this.state.modalShow) ? strButtonOnly : strButtonWithTrigger;\r\n\r\n\r\n    const strAbout = \r\n    <Nav.Item>\r\n\r\n      {strBtnDynamic}\r\n\r\n      <Modal show={this.state.modalShow} onHide={this.onHide} >\r\n        <Modal.Title>\r\n          {strName}\r\n        </Modal.Title>\r\n        <Modal.Header>\r\n          <Modal.Body className=\"text-center\">\r\n            <UiSkelAni />\r\n            <p>\r\n              {strDescription}\r\n            </p>\r\n            <p>\r\n              <b>Version: </b> {strVer}\r\n            </p>\r\n            <p>\r\n              <b>Copyright: </b> {strYear} {strAuthor}\r\n            </p>\r\n\r\n          </Modal.Body>\r\n        </Modal.Header>\r\n\r\n        <Modal.Footer>\r\n          <Button onClick={this.onHide} variant=\"secondary\">\r\n            Close\r\n          </Button>\r\n        </Modal.Footer>\r\n\r\n      </Modal>\r\n    </Nav.Item>\r\n    return strAbout;\r\n\r\n  }\r\n}\r\n\r\n","/**\r\n * @fileOverview SaverNifti\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n/**\r\n/**\r\n* Nifti file saver\r\n* @module src/demo/savers/SaverNifti\r\n*/\r\n\r\nconst IS_LITTLE_ENDIAN = true;\r\n\r\n// ******************************************************************\r\n// Class\r\n// ******************************************************************\r\n\r\nclass SaverNifti {\r\n  static writeIntToBuffer(val, buf, off) {\r\n    const dataArray = new DataView(buf, off);\r\n    dataArray.setInt32(0, val, IS_LITTLE_ENDIAN);\r\n  }\r\n\r\n  static writeShortToBuffer(val, buf, off) {\r\n    const dataArray = new DataView(buf, off);\r\n    dataArray.setInt16(0, val, IS_LITTLE_ENDIAN);\r\n  }\r\n\r\n  static writeFloatToBuffer(val, buf, off) {\r\n    const dataArray = new DataView(buf, off);\r\n    dataArray.setFloat32(0, val, IS_LITTLE_ENDIAN);\r\n  }\r\n\r\n  static fpsToDimInfo(freq, phase, slice) {\r\n    const res = (freq & 0x3) | \r\n      ((phase & 0x3) << 2) |\r\n      ((slice & 0x3) << 4);\r\n    return res;\r\n  }\r\n\r\n  /**\r\n  * Write nifti file data to buffer array\r\n  * @param {object} volumeData - array of intensities (uint8)\r\n  * @param {object} volumeSize - pixel and physical size\r\n  * @return {Object} ArrayBuffer with file content\r\n  */\r\n  static writeBuffer(volumeData, volumeSize) {\r\n\r\n    // check input data\r\n    const xDim = volumeSize.x;\r\n    const yDim = volumeSize.y;\r\n    const zDim = volumeSize.z;\r\n    if ((xDim <= 0) || (yDim <= 0) || (zDim <= 0)) {\r\n      console.log(`SaverNifti. volume pixels dim is bad: ${xDim} * ${yDim} * ${zDim} `);\r\n    }\r\n    const xGrid = volumeSize.pixdim1;\r\n    const yGrid = volumeSize.pixdim2;\r\n    const zGrid = volumeSize.pixdim3;\r\n    const TOO_MUCH = 5.0;\r\n    const TOO_MIN = 0.00001;\r\n    if ((xGrid > TOO_MUCH) || (yGrid > TOO_MUCH) || (zGrid > TOO_MUCH)) {\r\n      console.log(`SaverNifti. volume grid size is too much: ${xGrid} * ${yGrid} * ${zGrid} `);\r\n    }\r\n    if ((xGrid < TOO_MIN) || (yGrid < TOO_MIN) || (zGrid < TOO_MIN)) {\r\n      console.log(`SaverNifti. volume grid size is too min: ${xGrid} * ${yGrid} * ${zGrid} `);\r\n    }\r\n    if (volumeData.length !== xDim * yDim * zDim) {\r\n      console.log(`SaverNifti. bad input volume size = ${volumeData.length}, expected = ${xDim}*${yDim}*${zDim}`);\r\n    }\r\n    const TOO_BIG_VAL = 1000000;\r\n    const TOO_SMALL_VAL = -1000000;\r\n    let valMin = TOO_BIG_VAL;\r\n    let valMax = TOO_SMALL_VAL;\r\n    const numPixels = xDim * yDim * zDim;\r\n    for (let i = 0; i < numPixels; i++) {\r\n      valMin = (volumeData[i] < valMin) ? volumeData[i] : valMin;\r\n      valMax = (volumeData[i] > valMax) ? volumeData[i] : valMax;\r\n    }\r\n    const TOO_MIN_RANGE = 60;\r\n    if (valMax - valMin < TOO_MIN_RANGE) {\r\n      console.log(`SaverNifti. bad input volume data range: [${valMin} .. ${valMax}]`);\r\n    }\r\n\r\n    const NIFTI_HEADER_SIZE = 348;\r\n    const BYTES_PER_ELEMENT = 2;\r\n    const arrBuf = new ArrayBuffer(NIFTI_HEADER_SIZE + volumeData.length * BYTES_PER_ELEMENT);\r\n    const bufBytes = new Uint8Array(arrBuf);\r\n\r\n    const SIZE_DWORD = 4;\r\n    const SIZE_SHORT = 2;\r\n\r\n    let bufOff = 0;\r\n    SaverNifti.writeIntToBuffer(NIFTI_HEADER_SIZE, arrBuf, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    // data type\r\n    // eslint-disable-next-line\r\n    bufOff += 10;\r\n    // db name\r\n    // eslint-disable-next-line\r\n    bufOff += 18;\r\n    // extents\r\n    bufOff += SIZE_DWORD;\r\n    // session error\r\n    bufOff += SIZE_SHORT;\r\n    // regular\r\n    bufOff += 1;\r\n    // dim info\r\n    const D_FREQ = 1;\r\n    const D_PHASE = 2;\r\n    const D_SLICE = 3;\r\n    const dimInfo = SaverNifti.fpsToDimInfo(D_FREQ, D_PHASE, D_SLICE);\r\n    bufBytes[bufOff] = dimInfo;\r\n    bufOff += 1;\r\n\r\n    // write number of dimensions\r\n    const NUM_DIMS = 3;\r\n    SaverNifti.writeShortToBuffer(NUM_DIMS, arrBuf, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    // dave dims\r\n    SaverNifti.writeShortToBuffer(volumeSize.x, arrBuf, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    SaverNifti.writeShortToBuffer(volumeSize.y, arrBuf, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    SaverNifti.writeShortToBuffer(volumeSize.z, arrBuf, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n\r\n    // eslint-disable-next-line\r\n    bufOff += 8;\r\n\r\n    // intent_p1\r\n    bufOff += SIZE_DWORD;\r\n    // intent_p2\r\n    bufOff += SIZE_DWORD;\r\n    // intent_p3\r\n    bufOff += SIZE_DWORD;\r\n    // intent_code\r\n    bufOff += SIZE_SHORT;\r\n    // datatype\r\n    const DATA_TYPE_UINT16 = 512;\r\n    SaverNifti.writeShortToBuffer(DATA_TYPE_UINT16, arrBuf, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    // bitpix\r\n    const BIT_PIXELS = 16;\r\n    SaverNifti.writeShortToBuffer(BIT_PIXELS, arrBuf, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    // slice start\r\n    bufOff += SIZE_SHORT;\r\n\r\n    // grid spacing (pixdim)\r\n    bufOff += SIZE_DWORD;\r\n    SaverNifti.writeFloatToBuffer(volumeSize.pixdim1, arrBuf, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    SaverNifti.writeFloatToBuffer(volumeSize.pixdim2, arrBuf, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    SaverNifti.writeFloatToBuffer(volumeSize.pixdim3, arrBuf, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    // eslint-disable-next-line\r\n    bufOff += SIZE_DWORD * 4;\r\n\r\n    // voxoffset\r\n    const VOX_OFFSET = 352.0;\r\n    SaverNifti.writeFloatToBuffer(VOX_OFFSET, arrBuf, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n\r\n    // sclSlope\r\n    const SLOPE = 1.0;\r\n    SaverNifti.writeFloatToBuffer(SLOPE, arrBuf, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    // sclInter\r\n    const INTER = 0.0;\r\n    SaverNifti.writeFloatToBuffer(INTER, arrBuf, bufOff);\r\n    bufOff += SIZE_DWORD;\r\n    // sliceEnd\r\n    bufOff += SIZE_SHORT;\r\n    // sliceCode\r\n    const SLICE_CODE = 1;\r\n    bufBytes[bufOff] = SLICE_CODE;\r\n    bufOff++;\r\n    // m_xyztUnits\r\n    const XYZ_UNITS = 10;\r\n    bufBytes[bufOff] = XYZ_UNITS;\r\n    bufOff++;\r\n    // m_calMax, m_calMin, m_sliceDuration, m_toffset\r\n    bufOff += SIZE_DWORD * 4;\r\n    // m_glmax, m_glmin\r\n    bufOff += SIZE_DWORD * 2;\r\n    // m_descrip[80]\r\n    bufOff += 80;\r\n    // m_auxFile[24]\r\n    bufOff += 24;\r\n\r\n    // m_qformCode\r\n    const FORM_CODE = 1;\r\n    SaverNifti.writeShortToBuffer(FORM_CODE, arrBuf, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n    // m_sformCode\r\n    SaverNifti.writeShortToBuffer(FORM_CODE, arrBuf, bufOff);\r\n    bufOff += SIZE_SHORT;\r\n\r\n    // 4 last bytes are magic\r\n    bufOff = NIFTI_HEADER_SIZE - SIZE_DWORD;\r\n    // 'n' == 110, '+' == 43, '1' == 49\r\n    const MAG_0 = 110;\r\n    const MAG_1 = 43;\r\n    const MAG_2 = 49;\r\n    bufBytes[bufOff + 0] = MAG_0;\r\n    // eslint-disable-next-line\r\n    bufBytes[bufOff + 1] = MAG_1;\r\n    // eslint-disable-next-line\r\n    bufBytes[bufOff + 2] = MAG_2;\r\n    bufOff += SIZE_DWORD; // last magic bytes in header\r\n\r\n    const volDataUInt16 = new Uint16Array(volumeData);\r\n    const bufBytes16 = new Uint16Array(arrBuf, bufOff);\r\n    bufBytes16.set(volDataUInt16);\r\n\r\n    return arrBuf;\r\n  }\r\n} // end of class\r\n\r\nexport default SaverNifti;\r\n","/**\r\n * @fileOverview UiModalSaveNifti\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport { Modal, Table, Button, Form, Row, Col } from 'react-bootstrap';\r\n\r\nimport SaverNifti from '../engine/savers/SaverNifti';\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\nclass UiModalSaveNifti extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.onModalShow = this.onModalShow.bind(this);\r\n    this.onModalHide = this.onModalHide.bind(this);\r\n    this.onButtonSave = this.onButtonSave.bind(this);\r\n    this.onTexChange = this.onTexChange.bind(this);\r\n    this.handleFormSubmit = this.handleFormSubmit.bind(this);\r\n    this.onSaveNifti = this.onSaveNifti.bind(this);\r\n\r\n    this.m_hideFunc = null;\r\n\r\n    this.state = {\r\n      showModalSaveNifti: false,\r\n      text: 'dump'\r\n    };\r\n  } // end constr\r\n\r\n  onButtonSave() {\r\n    // console.log('on button save');\r\n    this.m_hideFunc();\r\n    this.onSaveNifti();\r\n  }\r\n\r\n  onModalShow() {\r\n    this.setState({ showModalSaveNifti: true });\r\n  }\r\n\r\n  onModalHide() {\r\n    this.setState({ showModalSaveNifti: false });\r\n  }\r\n\r\n  handleFormSubmit(evt) {\r\n    evt.preventDefault();\r\n    this.m_hideFunc();\r\n    this.onSaveNifti();\r\n  }\r\n\r\n  onTexChange(evt) {\r\n    const strText = evt.target.value;\r\n    // console.log(`onTexChange. text = ${strText}`);\r\n    this.setState({ text: strText });\r\n  }\r\n\r\n  // invoked on save nifti file format\r\n  onSaveNifti() {\r\n    const store = this.props;\r\n\r\n    const volSet = store.volumeSet;\r\n    const volIndex = store.volumeIndex;\r\n    const vol = volSet.getVolume(volIndex);\r\n\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    const xBox = vol.m_boxSize.x;\r\n    const yBox = vol.m_boxSize.y;\r\n    const zBox = vol.m_boxSize.z;\r\n    const volSize = {\r\n      x: xDim,\r\n      y: yDim,\r\n      z: zDim,\r\n      pixdim1: xBox / xDim,\r\n      pixdim2: yBox / yDim,\r\n      pixdim3: zBox / zDim,\r\n    };\r\n    let volData = vol.m_dataArray;\r\n    const vR = store.volumeRenderer; \r\n    if ( vR !== null ) {\r\n      volData = vR.volumeUpdater.bufferR;\r\n    };\r\n\r\n    const niiArr = SaverNifti.writeBuffer(volData, volSize);\r\n    const textToSaveAsBlob = new Blob([niiArr], { type: 'application/octet-stream' });\r\n    const textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);\r\n    let fileName = this.state.text;\r\n    const goodSuffix = fileName.endsWith('.nii');\r\n    if (!goodSuffix) {\r\n      fileName = fileName.concat('.nii');\r\n    }\r\n    // console.log(`Save to file ${fileName}`);\r\n\r\n    const downloadLink = document.createElement('a');\r\n    downloadLink.download = fileName;\r\n    downloadLink.innerHTML = 'Download File';\r\n    downloadLink.href = textToSaveAsURL;\r\n    downloadLink.onclick = event => document.body.removeChild(event.target);\r\n    downloadLink.style.display = 'none';\r\n    document.body.appendChild(downloadLink);\r\n\r\n    downloadLink.click();\r\n  } // end on save nifti\r\n\r\n  render() {\r\n    const stateVis = this.props.stateVis;\r\n    const onHideFunc = this.props.onHide;\r\n    this.m_hideFunc = onHideFunc;\r\n    const jsxModalSaveNifti =\r\n    <Modal show={stateVis} onHide={onHideFunc} >\r\n\r\n      <Modal.Body>\r\n\r\n        <Modal.Title>\r\n          Save as Nifti\r\n        </Modal.Title>\r\n\r\n        <Form onSubmit={evt => this.handleFormSubmit(evt)}>\r\n          <Table>\r\n            <thead>\r\n              <tr>\r\n\r\n                <th>\r\n                  <Form.Control required type=\"text\" placeholder=\"Enter file name here\"\r\n                    defaultValue={this.state.text} onChange={this.onTexChange} />\r\n                </th>\r\n\r\n                <th>\r\n                  <Form.Label className=\"text-left\">\r\n                    .nii\r\n                  </Form.Label>\r\n                </th>\r\n\r\n\r\n              </tr>\r\n            </thead>\r\n            \r\n          </Table>\r\n\r\n        </Form>\r\n        <Row>\r\n          <Col lg xl=\"2\">\r\n            <Button onClick={this.onButtonSave} >\r\n              Save\r\n            </Button>\r\n          </Col>\r\n\r\n          <Col lg xl=\"2\">\r\n            <Button onClick={onHideFunc} >\r\n              Cancel\r\n            </Button>\r\n          </Col>\r\n\r\n          <Col lg xl=\"8\">\r\n          </Col>\r\n\r\n        </Row>\r\n\r\n      </Modal.Body>\r\n\r\n    </Modal>\r\n    return jsxModalSaveNifti;\r\n  } // end render\r\n\r\n} // end class\r\n\r\nexport default connect(store => store)(UiModalSaveNifti);\r\n","/**\r\n * @fileOverview UiSaveMenu\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { NavDropdown } from 'react-bootstrap';\r\n\r\nimport UiModalSaveNifti from './UiModalSaveNifti';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiSaveMenu some text later...\r\n */\r\nclass UiSaveMenu extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.onModalSaveNiftiShow = this.onModalSaveNiftiShow.bind(this);\r\n    this.onModalSaveNiftiHide = this.onModalSaveNiftiHide.bind(this);\r\n\r\n    this.state = {\r\n      showModalSaveNifti: false,\r\n    };\r\n  }\r\n\r\n  // invoked after render\r\n  componentDidMount() {\r\n  }\r\n\r\n  onModalSaveNiftiShow() {\r\n    this.setState({ showModalSaveNifti: true });\r\n  }\r\n\r\n  onModalSaveNiftiHide() {\r\n    this.setState({ showModalSaveNifti: false });\r\n    // console.log('onModalSaveNiftiHide...');\r\n  }\r\n\r\n  //\r\n  // render\r\n  //\r\n  render() {\r\n    const store = this.props;\r\n    const isLoaded = store.isLoaded;\r\n    const strDisabled = (isLoaded) ? false : true;\r\n   \r\n    const jsxSaveMenu =\r\n      <NavDropdown id=\"save-nav-dropdown\" \r\n        disabled={strDisabled}\r\n        title={\r\n          <div style={{ display: 'inline-block' }}> \r\n            <i className=\"fas fa-save\"></i>\r\n            Save\r\n          </div>\r\n        } >\r\n        <NavDropdown.Item onClick={evt => this.onModalSaveNiftiShow(evt)}  >\r\n          <i className=\"fas fa-globe\"></i>\r\n          Save to Nifti\r\n        </NavDropdown.Item>\r\n        <UiModalSaveNifti stateVis={this.state.showModalSaveNifti} onHide={this.onModalSaveNiftiHide} />\r\n      </NavDropdown>;\r\n\r\n\r\n    return jsxSaveMenu;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiSaveMenu);\r\n\r\n\r\n","/**\r\n * @fileOverview UiModalDicomTags\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport { Modal, Table, Form } from 'react-bootstrap';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiModalDicomTags some text later...\r\n */\r\nclass UiModalDicomTags extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.onModalHide = this.onModalHide.bind(this);\r\n\r\n    this.state = {\r\n      showModalDemo: false,\r\n      currentSlice: 0,\r\n    };\r\n  }\r\n\r\n  onModalHide() {\r\n    this.setState({ showModalDemo: false });\r\n  }\r\n\r\n  onSelectSlice(evt) {\r\n    // const nam = evt.target.name;\r\n    const val = evt.target.value;\r\n    // console.log(`onSelectSlice. name = ${nam} val = ${val}`);\r\n    const arr = val.split(' ');\r\n    const ind = parseInt(arr[1]);\r\n    console.log(`onSelectSlice. index = ${ind}`);\r\n    this.setState({ currentSlice: ind });\r\n  }\r\n\r\n  render() {\r\n    const stateVis = this.props.stateVis;\r\n    const onHideFunc = this.props.onHide;\r\n\r\n    const store = this.props;\r\n    const dicomInfo = store.dicomInfo;\r\n    let slicesInfo = [];\r\n    let tagsList = [];\r\n    \r\n    if (dicomInfo !== null) {\r\n      slicesInfo = dicomInfo.m_sliceInfo;\r\n      if (slicesInfo.length > 0) {\r\n        tagsList = slicesInfo[this.state.currentSlice].m_tags;\r\n      }\r\n      /*\r\n      const numSlices = slicesInfo.length;\r\n      console.log(`UiModalDicomTags.render. num slices = ${numSlices}`);\r\n      for (let i = 0; i < numSlices; i++) {\r\n        const sliceInfo = slicesInfo[i];\r\n        console.log(`UiModalDicomTags.render. slice = ${sliceInfo.m_sliceName} file = ${sliceInfo.m_fileName}`);\r\n        const tagsInfo = sliceInfo.m_tags;\r\n        const numTags = tagsInfo.length;\r\n        for (let j = 0; j < numTags; j++) {\r\n          const tagInfo = tagsInfo[j];\r\n          console.log(`UiModalDicomTags.render. tag = ${tagInfo.m_tag} name = ${tagInfo.m_attrName} value = ${tagInfo.m_attrValue}`);\r\n        }\r\n      }\r\n      */\r\n    }\r\n    \r\n\r\n    const jsxModalDemo = \r\n      <Modal show={stateVis} onHide={onHideFunc} size=\"xl\" >\r\n        <Modal.Header closeButton>\r\n          <Modal.Title>\r\n            Dicom information\r\n          </Modal.Title>\r\n        </Modal.Header>\r\n\r\n        <Modal.Body>\r\n\r\n          <Form>\r\n            <Form.Group controlId=\"modalDicomTags.slice\">\r\n              <Form.Label>\r\n                Choose slice\r\n              </Form.Label>\r\n\r\n              <Form.Control as=\"select\" onChange={this.onSelectSlice.bind(this)}>\r\n                {slicesInfo.map( (d, i) => {\r\n                  const sn = d.m_sliceName;\r\n                  const fn = d.m_fileName;\r\n                  const str = sn + ' (' + fn + ')';\r\n                  return <option key={i} value={str}> {str} </option>;\r\n                })}\r\n              </Form.Control>\r\n\r\n            </Form.Group>\r\n\r\n          </Form>\r\n\r\n          <Table striped bordered responsive>\r\n            <thead>\r\n\r\n              <tr>\r\n                <th>\r\n                  Tag\r\n                </th>\r\n                <th>\r\n                  Attribute Name\r\n                </th>\r\n                <th>\r\n                  Attribute Value\r\n                </th>\r\n              </tr>\r\n\r\n            </thead>\r\n            <tbody>\r\n              {tagsList.map( (d, i) => {\r\n                const strTag = d.m_tag;\r\n                const strNam = d.m_attrName;\r\n                const strVal = (d.m_attrValue.length > 0) ? d.m_attrValue : '_';\r\n                // return <tr key={i}><td>{strTag}</td><td>{i}</td><td>{i}</td></tr>;\r\n                return <tr key={i}><td>{strTag}</td><td>{strNam}</td><td>{strVal}</td></tr>;\r\n              })}\r\n            </tbody>\r\n\r\n          </Table>              \r\n\r\n        </Modal.Body>\r\n      </Modal>\r\n    return jsxModalDemo;\r\n  } // end render\r\n} // end class\r\n\r\nexport default connect(store => store)(UiModalDicomTags);\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n/**\r\n* Screen shot take from app\r\n* @module demo/engine/utils/screenshot\r\n*/\r\n// absolute imports\r\n/**\r\n* Class Screenshot to take screen copy\r\n* @class Screenshot\r\n*/\r\nclass Screenshot {\r\n  /**\r\n  * Convert string into byte array\r\n  */\r\n  static bytesFromBase64(str) {\r\n    const binary = window.atob(str);\r\n    const bytes = new Uint8Array(binary.length);\r\n    for (let i = 0; i < bytes.length; ++i) {\r\n      bytes[i] = binary[i].charCodeAt(0);\r\n    }\r\n    return bytes.buffer;\r\n  }\r\n\r\n  /**\r\n  * Encode byte buffer into base64\r\n  */\r\n  static bytesToBase64(buffer) {\r\n    const bytes = new Uint8Array(buffer);\r\n    let binary = '';\r\n    for (let i = 0; i < bytes.byteLength; i++) {\r\n      binary += String.fromCharCode(bytes[i]);\r\n    }\r\n    return window.btoa(binary);\r\n  }\r\n\r\n  /**\r\n  * Convert data URI to blob (for further save)\r\n  */\r\n  static dataUriToBlob(uri) {\r\n    const parts = uri.split(/[:;,]/);\r\n    const partsCount = parts.length;\r\n    const MAX_PARTS = 3;\r\n    const PART_OFFSET = 2;\r\n    if (partsCount >= MAX_PARTS && parts[partsCount - PART_OFFSET] === 'base64') {\r\n      return new Blob([Screenshot.bytesFromBase64(parts[partsCount - 1])]);\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n  * Open new browser window and display screenshot in it\r\n  */\r\n  static showScreenshotInNewWindow(imageUri) {\r\n    // show image on screen\r\n    // console.log(`imageUri = ${imageUri}`);\r\n    const win = window.open('about:blank', 'Screenshot', 'width=800,height=600');\r\n    win.document.write(`<body style=\"margin:0\"><img src=\"${imageUri}\" alt=\"from canvas\" /></body>`);\r\n  }\r\n\r\n  /**\r\n  * Save screenshot in file\r\n  */\r\n  static saveScreenShotToFile(imageUri, fileName) {\r\n    // save image to file\r\n    const blob = Screenshot.dataUriToBlob(imageUri);\r\n    // window.saveAs(blob, fileName);\r\n    if (typeof window !== 'undefined' && window.navigator && window.navigator.msSaveBlob) {\r\n      window.navigator.msSaveBlob(blob, fileName);\r\n    } else if (typeof document !== 'undefined') {\r\n      const lnk = document.createElement('a');\r\n      lnk.download = fileName;\r\n      lnk.innerHTML = 'download';\r\n      lnk.href = window.URL.createObjectURL(blob);\r\n      document.body.appendChild(lnk);\r\n      lnk.click();\r\n      document.body.removeChild(lnk);\r\n    }\r\n  }\r\n\r\n  /**\r\n  * Format value as a text with 2 digits. '2' -> '02', '34' -> '34'\r\n  */\r\n  static formatTwoDigits(val) {\r\n    const TEN = 10;\r\n    if (val >= TEN) {\r\n      return val;\r\n    }\r\n    return `0${val}`;\r\n  }\r\n\r\n  /**\r\n  * Get current date + time in format YYMMDD-HHMMSS\r\n  */\r\n  static getFormattedDateString() {\r\n    const date = new Date();\r\n    const yy = date.getUTCFullYear();\r\n    const mn = Screenshot.formatTwoDigits(1 + date.getUTCMonth());\r\n    const dd = Screenshot.formatTwoDigits(date.getUTCDate());\r\n    const hh = Screenshot.formatTwoDigits(date.getHours());\r\n    const mi = Screenshot.formatTwoDigits(date.getMinutes());\r\n    const ss = Screenshot.formatTwoDigits(date.getSeconds());\r\n    const strDate = `${yy}${mn}${dd}-${hh}${mi}${ss}`;\r\n    return strDate;\r\n  }\r\n\r\n  /**\r\n  * Get screenshot\r\n  */\r\n  static makeScreenshot(engineRender, shotW, shotH) {\r\n    const imageUri = engineRender.screenshot(shotW, shotH);\r\n    // const imageUri = engineRender3d.screenshot();\r\n\r\n    // show screen shot\r\n    // Screenshot.showScreenshotInNewWindow(imageUri);\r\n    // TODO: create save as dialog instead of automatic save screen shot to file\r\n\r\n    if (imageUri !== null) {\r\n      // save screen shot\r\n      const strFmtDate = Screenshot.getFormattedDateString();\r\n      const fileName = `screenshot-${strFmtDate}.png`;\r\n      Screenshot.saveScreenShotToFile(imageUri, fileName);\r\n    }\r\n  }\r\n}\r\n\r\nexport default Screenshot;\r\n","/**\r\n * @fileOverview UiReportMenu\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { NavDropdown } from 'react-bootstrap';\r\n\r\nimport UiModalDicomTags from './UiModalDicomTags';\r\nimport Screenshot from '../engine/utils/Screenshot';\r\nimport ModeView from '../store/ModeView';\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiReportMenu some text later...\r\n */\r\nclass UiReportMenu extends React.Component {\r\n  // constructor\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.onModalDicomTagsShow = this.onModalDicomTagsShow.bind(this);\r\n    this.onModalDicomTagsHide = this.onModalDicomTagsHide.bind(this);\r\n    this.onModalScreenshot = this.onModalScreenshot.bind(this);\r\n\r\n    this.state = {\r\n      showModalDicomTags: false,\r\n    };\r\n  }\r\n\r\n  onModalDicomTagsShow() {\r\n    this.setState({ showModalDicomTags: true });\r\n  }\r\n\r\n  onModalDicomTagsHide() {\r\n    this.setState({ showModalDicomTags: false });\r\n  }\r\n\r\n  onModalScreenshot() {\r\n    const SHOT_W = 800;\r\n    const SHOT_H = 600;\r\n\r\n    const store = this.props;\r\n    const modeView = store.modeView;\r\n    if (modeView === ModeView.VIEW_2D) {\r\n      const gra2d = store.graphics2d;\r\n      Screenshot.makeScreenshot(gra2d, SHOT_W, SHOT_H);\r\n    } else if ((modeView === ModeView.VIEW_3D) || (modeView === ModeView.VIEW_3D_LIGHT)) {\r\n      const volRender = store.volumeRenderer;\r\n      Screenshot.makeScreenshot(volRender, SHOT_W, SHOT_H);\r\n    } else {\r\n      console.log('onModalScreenshot. not implemented yet');\r\n    }\r\n  }\r\n\r\n  // invoked after render\r\n  componentDidMount() {\r\n  }\r\n\r\n  render() {\r\n    const store = this.props;\r\n    const isLoaded = store.isLoaded;\r\n\r\n    const strDisabled = (isLoaded) ? false : true;\r\n    const jsxReportMenu = \r\n      <NavDropdown id=\"save-nav-dropdown\" \r\n        disabled={strDisabled}\r\n        title={\r\n          <div style={{ display: 'inline-block' }}> \r\n            <i className=\"fas fa-book\"></i>\r\n            Report\r\n          </div>\r\n        } >\r\n        <NavDropdown.Item onClick={this.onModalDicomTagsShow} >\r\n          <i className=\"fas fa-clipboard-list\"></i>\r\n          Show tags\r\n        </NavDropdown.Item>\r\n\r\n        <NavDropdown.Item onClick={this.onModalScreenshot} >\r\n          <i className=\"fas fa-camera\"></i>\r\n          Screenshot\r\n        </NavDropdown.Item>\r\n\r\n        <UiModalDicomTags stateVis={this.state.showModalDicomTags}\r\n          onHide={this.onModalDicomTagsHide} />\r\n\r\n      </NavDropdown>;    \r\n\r\n    return jsxReportMenu;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiReportMenu);\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Flood fill\r\n* @module lib/scripts/lungsfill/floodfill\r\n*/\r\n\r\n// absolute imports\r\n// import * as THREE from 'three';\r\n\r\n// relative imports\r\n\r\n// ****************************************************************************\r\n// Const\r\n// ****************************************************************************\r\n\r\n// ****************************************************************************\r\n// Class\r\n// ****************************************************************************\r\n\r\n/**\r\n* Class FloodFill perform 3d flood fill\r\n* @class FloodFill\r\n*/\r\nexport default class FloodFill {\r\n  /**\r\n  * Init all internal data\r\n  * @constructs FloodFill\r\n  */\r\n  constructor() {\r\n    this.m_xDim = 0;\r\n    this.m_yDim = 0;\r\n    this.m_zDim = 0;\r\n    this.m_stack3d = null;\r\n    this.m_maxStack3d = 0;\r\n    this.m_indexStack3d = 0;\r\n    this.m_numFilled3d = 0;\r\n  }\r\n\r\n  static isVisible(pixels, offset, threshold) {\r\n    const VIS = 255;\r\n    return (pixels[offset] <= threshold) ? 0 : VIS;\r\n  }\r\n\r\n  floodFill3dThreshold(xDim, yDim,  zDim, pixelsDst, vSeed, threshold) {\r\n    const xyDim = xDim * yDim;\r\n    const stack = [];\r\n    const VIS = 255;\r\n    this.m_numFilled3d = 0;\r\n\r\n    const isVisSeed = FloodFill.isVisible(pixelsDst, vSeed.x + vSeed.y * xDim + vSeed.z * xDim * yDim, threshold);\r\n    if (isVisSeed !== 0) {\r\n      console.log(`Bad seed point: ${vSeed.x}, ${vSeed.y}, ${vSeed.z}`);\r\n    }\r\n    // Decrement highest pixels to reserve special mask value (255)\r\n    // if it was 255, becomes 254\r\n    stack.push({ 'x':vSeed.x, 'y':vSeed.y, 'z':vSeed.z });\r\n    while (stack.length !== 0) {\r\n      const vTaken = stack.pop();\r\n      let x;\r\n\r\n      const y = vTaken.y;\r\n      const z = vTaken.z;\r\n\r\n      const yOff = y * xDim;\r\n      const zOff = z * xyDim;\r\n\r\n      // get leftmost\r\n      let xL = 0;\r\n      for (x = vTaken.x; (x >= 0) && !FloodFill.isVisible(pixelsDst, x + yOff + zOff, threshold); x--) {\r\n        xL = x + 1;\r\n      }\r\n      xL = x + 1;\r\n      // get rightmost\r\n      let xR = 0;\r\n      for (x = vTaken.x; (x < xDim) && !FloodFill.isVisible(pixelsDst, x + yOff + zOff, threshold); x++) {\r\n        xR = x - 1;\r\n      }\r\n      xR = x - 1;\r\n\r\n      let setYLess = VIS;\r\n      let setYMore = VIS;\r\n      let setZLess = VIS;\r\n      let setZMore = VIS;\r\n      for (x = xL; x <= xR; x++) {\r\n        // set dest point visible\r\n        pixelsDst[x + yOff + zOff] = VIS;\r\n        this.m_numFilled3d++;\r\n\r\n        // check line y less\r\n        if ((y > 0) && (FloodFill.isVisible(pixelsDst, x + yOff + zOff - xDim, threshold) !== setYLess)) {\r\n          setYLess = VIS - setYLess;\r\n          if (setYLess === 0) {\r\n            stack.push({ 'x': x, 'y': (y - 1), 'z': z });\r\n          } // if need to push\r\n        } // if (y less pint has another vis state\r\n\r\n        // check line above\r\n        if ((y < yDim - 1) && (FloodFill.isVisible(pixelsDst, x + yOff + zOff + xDim, threshold) !== setYMore)) {\r\n          setYMore = VIS - setYMore;\r\n          if (setYMore === 0) {\r\n            stack.push({ 'x': x, 'y': (y + 1), 'z': z });\r\n          } // if need to push\r\n        } // if (y more point has another vis state\r\n\r\n        // check line z less\r\n        //if ((z > 0) && (FloodFill.isVisible(pixelsDst, x + yOff + zOff - xyDim, threshold) !== setZLess)) {\r\n        if ((z > 3) && (FloodFill.isVisible(pixelsDst, x + yOff + zOff - xyDim, threshold) !== setZLess)) {\r\n          setZLess = VIS - setZLess;\r\n          if (setZLess === 0) {\r\n            stack.push({ 'x': x, 'y': y, 'z': z - 1 });\r\n          } // if need to push\r\n        } // if (z less pint has another vis state\r\n\r\n        // check line z more\r\n        //if ((z < zDim - 1) && (FloodFill.isVisible(pixelsDst, x + yOff + zOff + xyDim, threshold) !== setZMore)) {\r\n        if ((z < zDim - 1 - 3) && (FloodFill.isVisible(pixelsDst, x + yOff + zOff + xyDim, threshold) !== setZMore)) {\r\n          setZMore = VIS - setZMore;\r\n          if (setZMore === 0) {\r\n            stack.push({ 'x': x, 'y': y, 'z': z + 1 });\r\n          } // if need to push\r\n        } // if (z more)\r\n      } // for (x) scanned hor line\r\n    } // while stack is not empty\r\n    return 1;\r\n  } // end of floodFill3dThreshold\r\n\r\n} // end FloodFill\r\n","/**\r\n* Lungs fill tool\r\n* @module lib/scripts/actvolume/lungsfill/seedPoints\r\n*/\r\nconst TOO_MIN_VAL = 40;\r\n/**\r\n* Class seedPoints perform find seed points for lungs selection (segmentation)\r\n* @class seedPoints\r\n*/\r\nexport default class SeedPoints {\r\n  /**\r\n  * Init all internal data\r\n  * @constructs SeedPoints\r\n  */\r\n  constructor(volume, xDim, yDim, zDim) {\r\n    this.m_xDim = xDim;\r\n    this.m_yDim = yDim;\r\n    this.m_zDim = zDim;\r\n    this.m_volTexSrc = volume;\r\n  }\r\n\r\n  findSeedPointOnCentralSlice(vSeed) {\r\n    const TWO = 2;\r\n    const zCenter = Math.floor(this.m_zDim / TWO);\r\n    const yCenter = Math.floor(this.m_yDim / TWO);\r\n    let yMin = -1, yMax = -1;\r\n    const zOff = zCenter * this.m_xDim * this.m_yDim;\r\n    let yOff = -1;\r\n\r\n    // detect min, max y\r\n    let x, y;\r\n    const NUM_170 = 170.0;\r\n    const NUM_512 = 512.0;\r\n    const MIN_LINE_RATIO = NUM_170 / NUM_512;\r\n\r\n    for (y = 0; y < yCenter; y++) {\r\n      yOff = y * this.m_xDim;\r\n      let numWhitePixels = 0;\r\n      for (x = 0; x < this.m_xDim; x++) {\r\n        numWhitePixels += (this.m_volTexSrc[x + yOff + zOff] > TOO_MIN_VAL) ? 1 : 0;\r\n      }\r\n      // how much percents of non-black pixels can be in line\r\n      const isBlackLine = (numWhitePixels / this.m_xDim < MIN_LINE_RATIO) ? 1 : 0;\r\n      if (!isBlackLine) {\r\n        break;\r\n      }\r\n      yMin = y;\r\n    }\r\n\r\n    for (y = this.m_yDim - 1; y > yCenter; y--) {\r\n      yOff = y * this.m_xDim;\r\n      let numWhitePixels = 0;\r\n      for (x = 0; x < this.m_xDim; x++) {\r\n        numWhitePixels += (this.m_volTexSrc[x + yOff + zOff] > TOO_MIN_VAL) ? 1 : 0;\r\n      }\r\n      // how much percetns non-black pixels can be in line\r\n      const isBlackLine = (numWhitePixels / this.m_xDim < MIN_LINE_RATIO) ? 1 : 0;\r\n      if (!isBlackLine) {\r\n        break;\r\n      }\r\n      yMax = y;\r\n    }\r\n    // console.log(`yMin = ${yMin}, yMax = ${yMax}`);\r\n    // shift range [yMin .. yMax] to mire narrow search area\r\n    const NUM_45 = 45.0;\r\n    const NUM_60 = 60.0;\r\n    const NUM_339 = 339.0;\r\n    const ADD_RATIO_MIN = NUM_45 / NUM_339;\r\n    const ADD_RATIO_MAX = NUM_60 / NUM_339;\r\n\r\n    const yMinNew = Math.floor(yMin + (yMax - yMin) * ADD_RATIO_MIN);\r\n    const yMaxNew = Math.floor(yMax - (yMax - yMin) * ADD_RATIO_MAX);\r\n    yMin = yMinNew;\r\n    yMax = yMaxNew;\r\n    const NUM_COLORS = 8;\r\n    const histogram = new Float32Array(NUM_COLORS);\r\n    let goodHistogramDetected = false;\r\n    for (y = yMin; (y <= yMax) && !goodHistogramDetected; y++) {\r\n      // clear histogram\r\n      for (x = 0; x < NUM_COLORS; x++) {\r\n        histogram[x] = 0;\r\n      }\r\n      // collect histogram\r\n      yOff = y * this.m_xDim;\r\n\r\n      const SHIFT_5 = 5;\r\n      for (x = 0; x < this.m_xDim; x++) {\r\n        // get value in [0..7]\r\n        const val = this.m_volTexSrc[x + yOff + zOff] >> SHIFT_5;\r\n        histogram[val] += 1.0;\r\n      }\r\n      // get color probability\r\n      for (x = 0; x < NUM_COLORS; x++) {\r\n        histogram[x] /= this.m_xDim;\r\n      }\r\n      // black color should be largely presented\r\n      // but we should have enough whites\r\n      const BARRIER = 0.7;\r\n      if (histogram[0] < BARRIER) {\r\n        goodHistogramDetected = true;\r\n        break;\r\n      }\r\n    } // for (y) all possible hor lines\r\n    // console.log(`found y = ${y}`);\r\n    // search seed point in line: zCenter, y\r\n    let valThreshold = 0;\r\n    // search first white point on line\r\n    const xCenter = Math.floor(this.m_xDim / TWO);\r\n    for (x = 0; x < xCenter; x++) {\r\n      valThreshold = this.m_volTexSrc[x + yOff + zOff];\r\n      if (valThreshold > TOO_MIN_VAL) {\r\n        break;\r\n      }\r\n    }\r\n    // search first black point\r\n    const ADD_RANGE = 8;\r\n    x += ADD_RANGE;\r\n    for (; x < xCenter; x++) {\r\n      valThreshold = this.m_volTexSrc[x + yOff + zOff];\r\n      if (valThreshold < TOO_MIN_VAL) {\r\n        break;\r\n      }\r\n    }\r\n    if (x === xCenter) {\r\n      return 1;\r\n    }\r\n\r\n    // check that next 8 pixels are black\r\n    for (let dx = 0; dx < ADD_RANGE; dx++) {\r\n      valThreshold = this.m_volTexSrc[x + yOff + zOff];\r\n      if (valThreshold > TOO_MIN_VAL) {\r\n        break;\r\n      }\r\n      x++;\r\n    }\r\n    if (valThreshold > TOO_MIN_VAL) {\r\n      return 1;\r\n    }\r\n    vSeed.x = x;\r\n    vSeed.y = y;\r\n    vSeed.z = zCenter;\r\n    return 0;\r\n  } //findSeedPointOnCentralSlice\r\n\r\n  findSeedPointOnFirstSlice(vSeed) {\r\n    const pixelsSrc = this.m_volTexSrc;\r\n    const VAL_BLACK_BARRIER = 50;\r\n    let holeFound = false;\r\n\r\n    const NUM_7 = 7;\r\n    const NUM_512 = 512;\r\n    const sizeBlackAreaMin = Math.floor(this.m_xDim * NUM_7 / NUM_512);\r\n\r\n    // for each point scan in 4 directions to find white barrier\r\n\r\n    const MIN_RAT = 0.2;\r\n    const MAX_RAT = 0.8;\r\n    const yMin = Math.floor(this.m_yDim * MIN_RAT);\r\n    const yMax = Math.floor(this.m_yDim * MAX_RAT);\r\n    const xMin = Math.floor(this.m_xDim * MIN_RAT);\r\n    const xMax = Math.floor(this.m_xDim * MAX_RAT);\r\n\r\n    let cx, cy;\r\n    const offZ = 2 * this.m_xDim * this.m_yDim;\r\n    for (cy = yMin; (cy < yMax) && !holeFound; cy++) {\r\n      const cyOff = cy * this.m_xDim;\r\n      for (cx = xMin; (cx < xMax) && !holeFound; cx++) {\r\n        const val = pixelsSrc[cx + cyOff + offZ];\r\n        if (val >= VAL_BLACK_BARRIER) {\r\n          continue;\r\n        }\r\n        // we have black current pixel\r\n        let numWhiteBarriers = 0;\r\n\r\n        let x, y, len;\r\n        for (len = 0, y = cy - 1; y >= 0; y--, len++) {\r\n          const off = cx + y * this.m_xDim + offZ;\r\n          if (pixelsSrc[off] > VAL_BLACK_BARRIER) {\r\n            if (len > sizeBlackAreaMin) {\r\n              numWhiteBarriers++;\r\n              break;\r\n            }\r\n          }\r\n        } // for (y)\r\n        for (len = 0, y = cy + 1; y < this.m_yDim; y++, len++) {\r\n          const off = cx + y * this.m_xDim + offZ;\r\n          if (pixelsSrc[off] > VAL_BLACK_BARRIER) {\r\n            if (len > sizeBlackAreaMin) {\r\n              numWhiteBarriers++;\r\n            }\r\n            break;\r\n          }\r\n        } // for (y)\r\n        for (len = 0, x = cx - 1; x >= 0; x--, len++) {\r\n          const off = x + cy * this.m_xDim + offZ;\r\n          if (pixelsSrc[off] > VAL_BLACK_BARRIER) {\r\n            if (len > sizeBlackAreaMin) {\r\n              numWhiteBarriers++;\r\n            }\r\n            break;\r\n          }\r\n        } // for (x)\r\n        for (len = 0, x = cx + 1; x < this.m_xDim; x++, len++) {\r\n          const off = x + cy * this.m_xDim + offZ;\r\n          if (pixelsSrc[off] > VAL_BLACK_BARRIER) {\r\n            if (len > sizeBlackAreaMin) {\r\n              numWhiteBarriers++;\r\n            }\r\n            break;\r\n          }\r\n        } // for (x)\r\n        const MIN_BLACK_BARRIER = 17;\r\n        const FOUR = 4;\r\n        const TWO = 2;\r\n        if (numWhiteBarriers === FOUR) {\r\n          holeFound = true;\r\n          vSeed.x = cx;\r\n          vSeed.y = cy;\r\n          let sum = 0;\r\n          let minv = 255;\r\n          let col = 0;\r\n          for (let zz = 0; zz < TWO; zz++) {\r\n            const zzOff = (zz + TWO) * this.m_xDim * this.m_yDim;\r\n            for (let yy = -TWO; yy <= TWO; yy++) {\r\n              const yyOff = (yy + cy) * this.m_xDim;\r\n              for (let xx = -2; xx <= TWO; xx++) {\r\n                let val = pixelsSrc[xx + cx + yyOff + zzOff];\r\n                if (val < MIN_BLACK_BARRIER) {\r\n                  sum = sum + val;\r\n                  col++;\r\n                  if (val < minv) {\r\n                    minv = val;\r\n                    vSeed.x = xx + cx;\r\n                    vSeed.y = yy + cy;\r\n                  }\r\n                }\r\n              } //for xx\r\n            } //for yy\r\n          } //for zz\r\n          vSeed.z = Math.floor(sum / col);\r\n          break;\r\n        } // if 4 barriers\r\n      } // for (cx)\r\n    }  // for (cy)\r\n    if (!holeFound) {\r\n      return 1;\r\n    } else {\r\n      return 0;\r\n    }\r\n  } //findSeedPointOnFirstSlice\r\n}\r\n","/**\r\n* Lungs fill tool\r\n* @module lib/scripts/lungsfill/lft\r\n*/\r\n// relative imports\r\nimport FloodFillTool from './floodfill';\r\nimport SeedPoints from './seedPoints';\r\n\r\nconst TOO_MIN_VAL = 40;\r\n\r\n/**\r\n* Class LungsFillTool perform lungs selection (segmentation)\r\n* @class LungsFillTool\r\n*/\r\nexport default class LungsFillTool {\r\n  /**\r\n  * Init all internal data\r\n  * @constructs LungsFillTool\r\n  */\r\n  //constructor(xDim, yDim, zDim, volTexSrc, volTexMask, srcData) {\r\n  constructor(volume) {\r\n    this.VESSEL = true;\r\n    this.m_xDim = volume.m_xDim;\r\n    this.m_yDim = volume.m_yDim;\r\n    this.m_zDim = volume.m_zDim;\r\n    this.xBorderMin = 0;\r\n    this.yBorderMin = 0;\r\n    this.xBorderMax = 0;\r\n    this.yBorderMax = 0;\r\n    this.m_volTexSrc = volume.m_dataArray;\r\n    this.m_volTexMask = new Uint8Array(this.m_xDim * this.m_yDim * this.m_zDim);\r\n    this.m_volTexMask1 = new Uint8Array(this.m_xDim * this.m_yDim * this.m_zDim);\r\n    this.m_volTexMask2 = new Uint8Array(this.m_xDim * this.m_yDim * this.m_zDim);\r\n    this.m_ratioUpdate = 0;\r\n  }\r\n\r\n  detectNonEmptyBox(pixelsSrc, xDim, yDim, zDim) {\r\n    const MIN_VAL_BARRIER = 8;\r\n    const TWICE = 2;\r\n    const xyDim = xDim * yDim;\r\n    const xDimHalf = Math.floor(xDim / TWICE);\r\n    const yDimHalf = Math.floor(yDim / TWICE);\r\n    let x, y, z;\r\n    let isEmpty;\r\n    const numBytesPerPixel = 1;\r\n    if (numBytesPerPixel === 1) {\r\n      isEmpty = true;\r\n      for (x = 0; (x < xDimHalf) && isEmpty; x++) {\r\n        // check is empty plane\r\n        for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      this.xBorderMin = x - 1;\r\n      isEmpty = true;\r\n      for (x = xDim - 1; (x > xDimHalf) && (isEmpty); x--) {\r\n        // check is empty plane\r\n        for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      this.xBorderMax = x + 1;\r\n      isEmpty = true;\r\n      for (y = 0; (y < yDimHalf) && (isEmpty); y++) {\r\n        // check is empty plane\r\n        for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      this.yBorderMin = y - 1;\r\n      isEmpty = true;\r\n      for (y = yDim - 1; (y > yDimHalf) && (isEmpty); y--) {\r\n        // check is empty plane\r\n        for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      this.yBorderMax = y + 1;\r\n    }\r\n  }\r\n\r\n  delatation() {\r\n    let x, y, z;\r\n    let x1, y1, z1;\r\n    let zOff = 0;\r\n    let yOff = 0;\r\n    let count = 0;\r\n    let val = 0;\r\n    const VIS = 255;\r\n    const TWO = 2;\r\n    for (z = 0; z < this.m_zDim; z++) {\r\n      for (y = this.yBorderMin; y < this.yBorderMax; y++) {\r\n        for (x = this.xBorderMin; x < this.xBorderMax; x++) {\r\n          count = 0;\r\n          for (z1 = -1; z1 < TWO; z1++) {\r\n            zOff = (z + z1) * this.m_xDim * this.m_yDim;\r\n            for (y1 = -1; y1 < TWO; y1++) {\r\n              yOff = (y + y1) * this.m_xDim;\r\n              for (x1 = -1; x1 < TWO; x1++) {\r\n                if (this.m_volTexMask[x + x1 + yOff + zOff] === VIS) {\r\n                  count++;\r\n                }\r\n              }\r\n            }\r\n          }\r\n          val = 0;\r\n          if (count > 0) {\r\n            val = VIS;\r\n          }\r\n          this.m_volTexMask1[x + y * this.m_xDim + z * this.m_xDim * this.m_yDim] = val;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  erosion() {\r\n    let x, y, z;\r\n    let x1, y1, z1;\r\n    let zOff = 0;\r\n    let yOff = 0;\r\n    let off = 0;\r\n    let count = 0;\r\n    const TWO = 2;\r\n    for (z = 0; z < this.m_zDim; z++) {\r\n      for (y = this.yBorderMin; y < this.yBorderMax; y++) {\r\n        for (x = this.xBorderMin; x < this.xBorderMax; x++) {\r\n          off = x + y * this.m_xDim + z * this.m_xDim * this.m_yDim;\r\n          this.m_volTexMask2[off] = this.m_volTexMask1[off];\r\n          if (this.m_volTexMask1[off] !== this.m_volTexMask[off]) {\r\n            count = 0;\r\n            for (z1 = -1; z1 < TWO; z1++) {\r\n              zOff = (z + z1) * this.m_xDim * this.m_yDim;\r\n              for (y1 = -1; y1 < TWO; y1++) {\r\n                yOff = (y + y1) * this.m_xDim;\r\n                for (x1 = -1; x1 < TWO; x1++) {\r\n                  if (this.m_volTexMask1[x + x1 + yOff + zOff] === 0) {\r\n                    count++;\r\n                  }\r\n                }\r\n              }\r\n            }\r\n            if (count > 0) {\r\n              this.m_volTexMask2[off] = 0;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  run() {\r\n    const xyzDim = this.m_xDim * this.m_yDim * this.m_zDim;\r\n    const VIS = 255;\r\n    if (this.m_ratioUpdate === 0) {\r\n      this.vSeed = { x: 0, y: 0, z: 0 };\r\n      let resFind = 0;\r\n      this.seedPoints = new SeedPoints(this.m_volTexSrc, this.m_xDim, this.m_yDim, this.m_zDim);\r\n      resFind = this.seedPoints.findSeedPointOnCentralSlice(this.vSeed);\r\n      if (resFind) {\r\n        console.log('Lungs Central fill run: seed point not found');\r\n        return resFind;\r\n      }\r\n      // copy dst volume before fill\r\n      for (let i = 0; i < xyzDim; i++) {\r\n        this.m_volTexMask[i] = this.m_volTexSrc[i];\r\n      }\r\n      this.m_ratioUpdate = 20;\r\n      return false;\r\n    }\r\n    if (this.m_ratioUpdate === 20) {\r\n      const valThreshold = TOO_MIN_VAL;\r\n      this.fillTool = new FloodFillTool();\r\n      this.fillTool.floodFill3dThreshold(this.m_xDim, this.m_yDim, this.m_zDim, this.m_volTexMask, this.vSeed, valThreshold);\r\n      this.m_ratioUpdate = 50;\r\n      return false;\r\n    }\r\n    //now this.m_volTexMask = 255, if lung, else = this.m_volTexSrc[i];  \r\n    // copy only filled with 255 pixels back and scale them to [0.255]\r\n    if (this.m_ratioUpdate === 50) {\r\n      let x;\r\n      const VIS = 255;\r\n      const SCALE = VIS / TOO_MIN_VAL;\r\n      if (!this.VESSEL) {\r\n        // not detect blood vessels\r\n        for (x = 0; x < xyzDim; x++) {\r\n          let val = 0;\r\n          if (this.m_volTexMask[x] === VIS) {\r\n            val = Math.floor(this.m_volTexSrc[x] * SCALE);\r\n          }\r\n          this.m_volTexSrc[x] = val;\r\n        }\r\n      } else {\r\n        // additional detect blood vessels\r\n        for (x = 0; x < xyzDim; x++) {\r\n          let val = 0;\r\n          if (this.m_volTexMask[x] === VIS) {\r\n            val = VIS;\r\n          }\r\n          this.m_volTexMask[x] = val;\r\n        }\r\n      }\r\n      this.m_ratioUpdate = 80;\r\n      return false;\r\n    }\r\n    if (this.m_ratioUpdate === 80) {\r\n      let x;\r\n      // additional detect blood vessels\r\n      for (x = 0; x < xyzDim; x++) {\r\n        let val = 0;\r\n        if (this.m_volTexMask[x] === VIS) {\r\n          val = VIS;\r\n        }\r\n        this.m_volTexMask[x] = val;\r\n      }\r\n      //now this.m_volTexMask = 255, if lung, else = 0;  \r\n      this.detectNonEmptyBox(this.m_volTexMask, this.m_xDim, this.m_yDim, this.m_zDim);\r\n      // extend this.m_volTexMask to this.m_volTexMask1\r\n      this.delatation();\r\n      // erosion this.m_volTexMask1 to this.m_volTexMask2\r\n      this.erosion();\r\n      // save this.m_volTexSrc[i] in this.m_volTexMask1[i]\r\n      for (let i = 0; i < xyzDim; i++) {\r\n        this.m_volTexMask1[i] = this.m_volTexSrc[i];\r\n      }\r\n      // airway to this.m_volTexMask1  \r\n      const resFind = this.seedPoints.findSeedPointOnFirstSlice(this.vSeed);\r\n      if (resFind) {\r\n        console.log('Airway fill run: seed point not found');\r\n        return resFind;\r\n      }\r\n      this.minv = this.vSeed.z;\r\n      this.vSeed.z = 2;\r\n      console.log(`Airway fill run: seed point: ${this.vSeed.x} ${this.vSeed.y} ${this.minv}`);\r\n      this.m_ratioUpdate = 90;\r\n      return false;\r\n    }\r\n    if (this.m_ratioUpdate === 90) {\r\n      this.fillTool.floodFill3dThreshold(this.m_xDim, this.m_yDim, this.m_zDim, this.m_volTexMask1, this.vSeed, this.minv);\r\n      const HALF = 128.0;\r\n      for (let x = 0; x < xyzDim; x++) {\r\n        let val = 0.5 * this.m_volTexMask[x];//0;\r\n        if (this.m_volTexMask2[x] - this.m_volTexMask[x] === VIS) {\r\n          val = HALF + this.m_volTexSrc[x];//0.5 + this.m_srcData;VIS; this.m_volTexSrc[x];this.m_srcData\r\n        }\r\n        if (this.m_volTexMask1[x] === VIS) {\r\n          val = VIS;\r\n        }\r\n        this.m_volTexSrc[x] = val;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n}\r\n// errors\r\nLungsFillTool.RESULT_NA = 0;\r\nLungsFillTool.RESULT_COMPLETED = 1;\r\nLungsFillTool.RESULT_BAD_HIST = 2;\r\nLungsFillTool.RESULT_SEED_X_NOT_FOUND = 3;\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Geometry for render\r\n* @module lib/scripts/actvolume/georender\r\n*/\r\n\r\n// absolute imports\r\nimport * as THREE from 'three';\r\n\r\n// const\r\n\r\n// const GEO_ERROR_NA = 0;\r\nconst GEO_ERROR_OK = 1;\r\n// const GEO_ERROR_CANT_OPEN_FILE = -1;\r\n// const GEO_ERROR_NO_MEMORY = -2;\r\n// const GEO_ERROR_NOT_PLY_FILE = -3;\r\n// const GEO_ERROR_NOT_ASCII = -4;\r\n// const GEO_ERROR_BAD_FORMAT = -5;\r\n// const GEO_ERROR_BAD_NUM_VERTICES = -6;\r\n// const GEO_ERROR_BAD_FACE_START = -7;\r\n// const GEO_ERROR_BAD_FACE_VERT_INDEX = -8;\r\n\r\n/**\r\n* Class GeoRender for render geometry\r\n* @class GeoRender\r\n*/\r\nexport default class GeoRender {\r\n  constructor() {\r\n    this.m_numVertices = 0;\r\n    this.m_vertices = null;\r\n    this.m_normals = null;\r\n    this.m_numTriangles = 0;\r\n    this.m_numTrianglesAllocated = 0;\r\n    this.m_indices = null;\r\n    this.m_matColor = null;\r\n    this.m_isWireframe = 0;\r\n    this.m_boxSize = null;\r\n    this.m_boxCenter = null;\r\n  }\r\n\r\n  createFromTetrahedronGenerator(gen) {\r\n    const numVertices = gen.getNumVertices();\r\n    const numTriangles = gen.getNumTriangles();\r\n    this.m_numVertices = numVertices;\r\n    this.m_numTriangles = numTriangles;\r\n    const INDICES_IN_TRI = 3;\r\n    const COORDS_IN_VERTEX = 4;\r\n    const NUM_0 = 0;\r\n    const NUM_1 = 1;\r\n    const NUM_2 = 2;\r\n    const NUM_3 = 3;\r\n    this.m_vertices = new Float32Array(numVertices * COORDS_IN_VERTEX);\r\n    this.m_indices = new Uint32Array(numTriangles * INDICES_IN_TRI);\r\n    // copy vertices from generator\r\n    for (let i = 0, j = 0; i < numVertices; i++, j += COORDS_IN_VERTEX) {\r\n      const vert = gen.getVertex(i);\r\n      this.m_vertices[j + NUM_0] = vert.x;\r\n      this.m_vertices[j + NUM_1] = vert.y;\r\n      this.m_vertices[j + NUM_2] = vert.z;\r\n      this.m_vertices[j + NUM_3] = 1.0;\r\n    } // for (i) all vertices\r\n    // copy triangles from generator\r\n    for (let i = 0, j = 0; i < numTriangles; i++, j += INDICES_IN_TRI) {\r\n      const triIndices = gen.getTriangle(i);\r\n      this.m_indices[j + NUM_0] = triIndices[NUM_0];\r\n      this.m_indices[j + NUM_1] = triIndices[NUM_1];\r\n      this.m_indices[j + NUM_2] = triIndices[NUM_2];\r\n    } // for (i) all triangles\r\n    return GEO_ERROR_OK;\r\n  } // create tetra\r\n\r\n  fromBufferGeometry(geoBuffered) {\r\n    const geo = new THREE.Geometry();\r\n    geo.fromBufferGeometry(geoBuffered);\r\n    geo.mergeVertices();\r\n\r\n    const numVertices = geo.vertices.length;\r\n    const numTriangles = geo.faces.length;\r\n    this.m_numVertices = numVertices;\r\n    this.m_numTriangles = numTriangles;\r\n    // console.log(`GeoRender. fromBufferGeometry. numVertices = ${numVertices}, numTriangles = ${numTriangles}`);\r\n    const INDICES_IN_TRI = 3;\r\n    const COORDS_IN_VERTEX = 4;\r\n    const NUM_0 = 0;\r\n    const NUM_1 = 1;\r\n    const NUM_2 = 2;\r\n    const NUM_3 = 3;\r\n    this.m_vertices = new Float32Array(numVertices * COORDS_IN_VERTEX);\r\n    this.m_indices = new Uint32Array(numTriangles * INDICES_IN_TRI);\r\n    // copy vertices from generator\r\n    for (let i = 0, j = 0; i < numVertices; i++, j += COORDS_IN_VERTEX) {\r\n      const vert = geo.vertices[i];\r\n      this.m_vertices[j + NUM_0] = vert.x;\r\n      this.m_vertices[j + NUM_1] = vert.y;\r\n      this.m_vertices[j + NUM_2] = vert.z;\r\n      this.m_vertices[j + NUM_3] = 1.0;\r\n    } // for (i) all vertices\r\n    // copy triangles from generator\r\n    for (let i = 0, j = 0; i < numTriangles; i++, j += INDICES_IN_TRI) {\r\n      const face = geo.faces[i];\r\n      this.m_indices[j + NUM_0] = face.a;\r\n      this.m_indices[j + NUM_1] = face.b;\r\n      this.m_indices[j + NUM_2] = face.c;\r\n    } // for (i) all triangles\r\n    return GEO_ERROR_OK;\r\n  }\r\n\r\n  createFromEllipse(vCenter, vRadius, numSegmentsHor, numSegmentsVert) {\r\n    const INDICES_IN_TRI = 3;\r\n    const COORDS_IN_VERTEX = 4;\r\n    const OFF_0 = 0;\r\n    const OFF_1 = 1;\r\n    const OFF_2 = 2;\r\n    const OFF_3 = 3;\r\n    const M_PI = 3.1415926535;\r\n    const numQuads = numSegmentsHor * numSegmentsVert;\r\n    const TRIS_IN_QUAD = 2;\r\n    this.m_numTriangles = numQuads * TRIS_IN_QUAD;\r\n    this.m_numVertices = numSegmentsHor * (numSegmentsVert + 1);\r\n    this.m_vertices = new Float32Array(this.m_numVertices * COORDS_IN_VERTEX);\r\n    this.m_indices = new Uint32Array(this.m_numTriangles * INDICES_IN_TRI);\r\n    // Fill vertices\r\n    let i, j;\r\n    let ind = 0;\r\n    const LIT_BIT_LESS_ONE = 0.97;\r\n    const ANGLE_QUATER = M_PI * 0.5 * LIT_BIT_LESS_ONE;\r\n    for (j = 0; j <= numSegmentsVert; j++) {\r\n      const tv = j / numSegmentsVert;\r\n      const angleVert = -(ANGLE_QUATER) + tv * (ANGLE_QUATER * OFF_2);\r\n      for (i = 0; i < numSegmentsHor; i++) {\r\n        const th = i / numSegmentsHor;\r\n        const angleHor = th * M_PI * OFF_2;\r\n\r\n        const vy = vRadius.y * Math.sin(angleVert);\r\n        const horProj = Math.cos(angleVert);\r\n        const vx = vRadius.x * horProj * Math.cos(angleHor);\r\n        const vz = vRadius.z * horProj * Math.sin(angleHor);\r\n        this.m_vertices[ind + OFF_0] = vCenter.x + vx;\r\n        this.m_vertices[ind + OFF_1] = vCenter.y + vy;\r\n        this.m_vertices[ind + OFF_2] = vCenter.z + vz;\r\n        this.m_vertices[ind + OFF_3] = 0.0;\r\n        ind += COORDS_IN_VERTEX;\r\n      }\r\n    }\r\n    // Fill indices\r\n    ind = 0;\r\n    for (j = 0; j < numSegmentsVert; j++) {\r\n      const indRowStart = j * numSegmentsHor;\r\n      for (i = 0; i < numSegmentsHor; i++) {\r\n        let iNext = i + 1;\r\n        if (iNext >= numSegmentsHor) {\r\n          iNext = 0;\r\n        }\r\n        this.m_indices[ind + OFF_0] = indRowStart + iNext + numSegmentsHor;\r\n        this.m_indices[ind + OFF_1] = indRowStart + iNext;\r\n        this.m_indices[ind + OFF_2] = indRowStart + i;\r\n        ind += INDICES_IN_TRI;\r\n\r\n        this.m_indices[ind + OFF_0] = indRowStart + i;\r\n        this.m_indices[ind + OFF_1] = indRowStart + i + numSegmentsHor;\r\n        this.m_indices[ind + OFF_2] = indRowStart + iNext + numSegmentsHor;\r\n        ind += INDICES_IN_TRI;\r\n      } // for (i)\r\n    } // for (i)\r\n  } // createFromEllipse\r\n\r\n  getNumVertices() {\r\n    return this.m_numVertices;\r\n  }\r\n\r\n  getVertices() {\r\n    return this.m_vertices;\r\n  }\r\n\r\n  getNormals() {\r\n    return this.m_normals;\r\n  }\r\n\r\n  getNumTriangles() {\r\n    return this.m_numTriangles;\r\n  }\r\n\r\n  getIndices() {\r\n    return this.m_indices;\r\n  }\r\n\r\n  /**\r\n  * Save render geometry into given file (OBJ type)\r\n  */\r\n  saveGeoToObjFile(fileName) {\r\n    let strOut = '# Render geometry save\\n';\r\n    const numVertices = this.m_numVertices;\r\n    const strNumVertices = numVertices.toString();\r\n    const numTriangles = this.m_numTriangles;\r\n    const strNumTriangles = numTriangles.toString();\r\n\r\n    const INDICES_IN_TRI = 3;\r\n    const COORDS_IN_VERTEX = 4;\r\n    const NUM_0 = 0;\r\n    const NUM_1 = 1;\r\n    const NUM_2 = 2;\r\n\r\n    // Write vertices\r\n    for (let i = 0, i4 = 0; i < numVertices; i++, i4 += COORDS_IN_VERTEX) {\r\n      const x = this.m_vertices[i4 + NUM_0];\r\n      const y = this.m_vertices[i4 + NUM_1];\r\n      const z = this.m_vertices[i4 + NUM_2];\r\n      const strX = x.toString();\r\n      const strY = y.toString();\r\n      const strZ = z.toString();\r\n      strOut = strOut.concat('v  ');\r\n      strOut = strOut.concat(strX);\r\n      strOut = strOut.concat(' ');\r\n      strOut = strOut.concat(strY);\r\n      strOut = strOut.concat(' ');\r\n      strOut = strOut.concat(strZ);\r\n      strOut = strOut.concat('\\n');\r\n    }\r\n    // write num verts\r\n    const strNumVerts = `# ${strNumVertices} vertices\\n`;\r\n    strOut = strOut.concat(strNumVerts);\r\n    strOut = strOut.concat('g TetraObj\\n');\r\n\r\n    // Write triangles\r\n    for (let i = 0, i3 = 0; i < numTriangles; i++, i3 += INDICES_IN_TRI) {\r\n      const i0 = 1 + this.m_indices[i3 + NUM_0];\r\n      const i1 = 1 + this.m_indices[i3 + NUM_1];\r\n      const i2 = 1 + this.m_indices[i3 + NUM_2];\r\n      const strIndices = `f ${i0} ${i1} ${i2}\\n`;\r\n      strOut = strOut.concat(strIndices);\r\n    }\r\n    // write num tri\r\n    const strNumTri = `# ${strNumTriangles} triangles\\n`;\r\n    strOut = strOut.concat(strNumTri);\r\n\r\n    const encoder = new TextEncoder();\r\n    const arr = encoder.encode(strOut);\r\n\r\n    const blob = new Blob([arr], { type: 'application/octet-stream' });\r\n    // saveAs(blob, TEST_FILE_NAME);\r\n    const url = URL.createObjectURL(blob);\r\n    const linkGen = document.createElement('a');\r\n    linkGen.setAttribute('href', url);\r\n    linkGen.setAttribute('download', fileName);\r\n    const eventGen = document.createEvent('MouseEvents');\r\n    eventGen.initMouseEvent('click', true, true, window, 1, 0, 0, 0, 0, false, false, false, false, 0, null);\r\n    linkGen.dispatchEvent(eventGen);\r\n  } // saveGeoToObjFile\r\n\r\n  /**\r\n  * Calculate vertices normals, based on triangle normals\r\n  */\r\n  createNormalsForGeometry() {\r\n    this.m_normals = new Array(this.m_numVertices);\r\n    for (let i = 0; i < this.m_numVertices; i++) {\r\n      this.m_normals[i] = new THREE.Vector3();\r\n    }\r\n    const triNormals = new Array(this.m_numTriangles);\r\n    for (let i = 0; i < this.m_numTriangles; i++) {\r\n      triNormals[i] = new THREE.Vector3();\r\n    }\r\n\r\n    const IND_A = 0;\r\n    const IND_B = 1;\r\n    const IND_C = 2;\r\n\r\n    const OFF_X = 0;\r\n    const OFF_Y = 1;\r\n    const OFF_Z = 2;\r\n\r\n    const VERTICES_IN_TRIANGLE = 3;\r\n    const COORDS_IN_VERTEX = 4;\r\n\r\n    let t, i3;\r\n    for (t = 0, i3 = 0; t < this.m_numTriangles; t++, i3 += VERTICES_IN_TRIANGLE) {\r\n      const ia = this.m_indices[i3 + IND_A] * COORDS_IN_VERTEX;\r\n      const ib = this.m_indices[i3 + IND_B] * COORDS_IN_VERTEX;\r\n      const ic = this.m_indices[i3 + IND_C] * COORDS_IN_VERTEX;\r\n      const va = new THREE.Vector3();\r\n      const vb = new THREE.Vector3();\r\n      const vc = new THREE.Vector3();\r\n      va.x = this.m_vertices[ia + OFF_X];\r\n      va.y = this.m_vertices[ia + OFF_Y];\r\n      va.z = this.m_vertices[ia + OFF_Z];\r\n      vb.x = this.m_vertices[ib + OFF_X];\r\n      vb.y = this.m_vertices[ib + OFF_Y];\r\n      vb.z = this.m_vertices[ib + OFF_Z];\r\n      vc.x = this.m_vertices[ic + OFF_X];\r\n      vc.y = this.m_vertices[ic + OFF_Y];\r\n      vc.z = this.m_vertices[ic + OFF_Z];\r\n      const vab = new THREE.Vector3();\r\n      const vbc = new THREE.Vector3();\r\n      vab.subVectors(vb, va);\r\n      vbc.subVectors(vc, vb);\r\n      const vTriNormal = new THREE.Vector3();\r\n      vTriNormal.crossVectors(vab, vbc);\r\n      const TOO_SMALL = 1.0e-8;\r\n      if (vTriNormal.lengthSq() < TOO_SMALL) {\r\n        const ERR_BAD_NORMAL = -10;\r\n        return ERR_BAD_NORMAL;\r\n      }\r\n      triNormals[t].set(vTriNormal.x, vTriNormal.y, vTriNormal.z);\r\n    } // for (t) all triangles\r\n    // init vert normals with 0 vector\r\n    for (let i = 0; i < this.m_numVertices; i++) {\r\n      this.m_normals[i].set(0.0, 0.0, 0.0);\r\n    }\r\n    // get additions\r\n    for (t = 0, i3 = 0; t < this.m_numTriangles; t++, i3 += VERTICES_IN_TRIANGLE) {\r\n      const ia = this.m_indices[i3 + IND_A];\r\n      const ib = this.m_indices[i3 + IND_B];\r\n      const ic = this.m_indices[i3 + IND_C];\r\n      const vTriNormal = triNormals[t];\r\n      this.m_normals[ia].add(vTriNormal);\r\n      this.m_normals[ib].add(vTriNormal);\r\n      this.m_normals[ic].add(vTriNormal);\r\n    } // for (t) all triangles\r\n    // normalize vertices normals\r\n    for (let i = 0; i < this.m_numVertices; i++) {\r\n      const len2 = this.m_normals[i].lengthSq();\r\n      const TOO_SMALL = 1.0e-8;\r\n      if (len2 < TOO_SMALL) {\r\n        const ERR_BAD_VERT_NORMAL = -20;\r\n        return ERR_BAD_VERT_NORMAL;\r\n      }\r\n      this.m_normals[i].normalize();\r\n    } // for (i) all vertices\r\n\r\n    return 1;\r\n  } // createNormalsFormGeometry\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Laplasian smoother\r\n* @module lib/scripts/actvolume/alpsmooth\r\n* @note refernces to articles:\r\n* G.Taubin, \"A Signal Processing Approach To Fair Surface Design\"\r\n* Y.Ohtake, A.Belyaev, I.Bogaevski, \"Polyhedral Surface Smoothing with Simultaneous Mesh Regularization\"\r\n* A.Belyaev, Y.Ohtake, \"A Comparison of Mesh Smoothing Methods\"\r\n*\r\n* Future enchancement\r\n* Advanced mesh smoothing, better then Laplasian smoothing\r\n* H.Yagou, Y.Ohtake, A.Belyaev, \"Mesh Smoothing via Mean and Median Filtering Applied to Face Normals\"\r\n*\r\n*/\r\n\r\n// absolute imports\r\nimport * as THREE from 'three';\r\n\r\n// relative imports\r\n\r\n// consts\r\nconst LAPSMOOTH_NUM_NEIBS = 16;\r\nconst INVALID_INDEX = -1;\r\n\r\n\r\n/**\r\n* Class LaplasianSmoother perform simple laplasian smoothing\r\n* @class LaplasianSmoother\r\n*/\r\nexport default class LaplasianSmoother {\r\n  /**\r\n  * Init all internal data\r\n  * @constructs ActiveVolume\r\n  */\r\n  constructor() {\r\n    this.m_vertNeib = null;\r\n  }\r\n\r\n  performSmoothStep(numVertices, vertSrc4, numTriangles, triIndices, vertDst) {\r\n    // allocate memory for each vertex neighbours\r\n    if (this.m_vertNeib === null) {\r\n      this.m_vertNeib = new Int32Array(numVertices * LAPSMOOTH_NUM_NEIBS);\r\n      this.getVerticesNeighbours(numVertices, vertSrc4, numTriangles, triIndices);\r\n    }\r\n    let i, i4, iNeib;\r\n\r\n    const NUM_COMPS_VERT = 4;\r\n    const OFF_0 = 0;\r\n    const OFF_1 = 1;\r\n    const OFF_2 = 2;\r\n    // find vertices center\r\n    const vCenter = new THREE.Vector3(0.0, 0.0, 0.0);\r\n    for (i = 0, i4 = 0; i < numVertices; i++, i4 += NUM_COMPS_VERT) {\r\n      const v = new THREE.Vector3(vertSrc4[i4 + OFF_0], vertSrc4[i4 + OFF_1], vertSrc4[i4 + OFF_2]);\r\n      vCenter.add(v);\r\n    }\r\n    const scaleCenter = 1.0 / numVertices;\r\n    vCenter.multiplyScalar(scaleCenter);\r\n\r\n    let distAve = 0.0;\r\n    // update vertices in triangle mesh\r\n    for (i = 0, i4 = 0, iNeib = 0; i < numVertices; i++, i4 += NUM_COMPS_VERT, iNeib += LAPSMOOTH_NUM_NEIBS) {\r\n      // get ave pos from neibs\r\n      const vAve = new THREE.Vector3(0.0, 0.0, 0.0);\r\n      let numNeibs = 0;\r\n      for (let k = 0; k < LAPSMOOTH_NUM_NEIBS; k++) {\r\n        const indNeib = this.m_vertNeib[iNeib + k];\r\n        if (indNeib === INVALID_INDEX) {\r\n          break;\r\n        }\r\n        const vertOffset = indNeib * NUM_COMPS_VERT;\r\n        vAve.x += vertSrc4[vertOffset + OFF_0];\r\n        vAve.y += vertSrc4[vertOffset + OFF_1];\r\n        vAve.z += vertSrc4[vertOffset + OFF_2];\r\n        numNeibs++;\r\n      }   // for (k) all possible neighbours\r\n\r\n      // check is this isolated vertex: no one triangle share thios vertex\r\n      if (numNeibs === 0) {\r\n        continue;\r\n      }\r\n\r\n      const scl = 1.0 / numNeibs;\r\n      vAve.multiplyScalar(scl);\r\n      const vCur = new THREE.Vector3(vertSrc4[i4 + OFF_0], vertSrc4[i4 + OFF_1], vertSrc4[i4 + OFF_2]);\r\n\r\n      const vNew = new THREE.Vector3();\r\n      const  RATIO_CUR = 0.3;\r\n\r\n      vNew.x = vCur.x * (1.0 - RATIO_CUR) + vAve.x * (RATIO_CUR);\r\n      vNew.y = vCur.y * (1.0 - RATIO_CUR) + vAve.y * (RATIO_CUR);\r\n      vNew.z = vCur.z * (1.0 - RATIO_CUR) + vAve.z * (RATIO_CUR);\r\n\r\n      const dist = vNew.distanceTo(vCur);\r\n      distAve += dist;\r\n\r\n      vertDst[i4 + OFF_0] = vNew.x;\r\n      vertDst[i4 + OFF_1] = vNew.y;\r\n      vertDst[i4 + OFF_2] = vNew.z;\r\n\r\n    }     // for (i)\r\n    distAve /= numVertices;\r\n\r\n    // enlarge model\r\n    for (i = 0, i4 = 0; i < numVertices; i++, i4 += NUM_COMPS_VERT) {\r\n      const v = new THREE.Vector3(vertDst[i4 + OFF_0], vertDst[i4 + OFF_1], vertDst[i4 + OFF_2]);\r\n      const vDir = new THREE.Vector3();\r\n      vDir.subVectors(v, vCenter);\r\n      vDir.normalize();\r\n      vDir.multiplyScalar(distAve);\r\n      v.add(vDir);\r\n\r\n      vertDst[i4 + OFF_0] = v.x;\r\n      vertDst[i4 + OFF_1] = v.y;\r\n      vertDst[i4 + OFF_2] = v.z;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n  getVerticesNeighbours(numVertices, vertSrc4, numTriangles, triIndices) {\r\n    const NUM_ELLEMS = LAPSMOOTH_NUM_NEIBS * numVertices;\r\n    let i, j;\r\n    for (i = 0; i < NUM_ELLEMS; i++) {\r\n      this.m_vertNeib[i] = INVALID_INDEX;\r\n    }\r\n    const NUM_INDICES_TRI = 3;\r\n    const OFF_0 = 0;\r\n    const OFF_1 = 1;\r\n    const OFF_2 = 2;\r\n    for (i = 0, j = 0; i < numTriangles; i++, j += NUM_INDICES_TRI) {\r\n      const indA = triIndices[j + OFF_0];\r\n      const indB = triIndices[j + OFF_1];\r\n      const indC = triIndices[j + OFF_2];\r\n      this.addNeib(indA, indB);\r\n      this.addNeib(indA, indC);\r\n      this.addNeib(indB, indA);\r\n      this.addNeib(indB, indC);\r\n      this.addNeib(indC, indA);\r\n      this.addNeib(indC, indB);\r\n    }\r\n  } // of getVerticesNeighbours\r\n\r\n  addNeib(indFrom, indTo) {\r\n    const idx = indFrom * LAPSMOOTH_NUM_NEIBS;\r\n    let i;\r\n    let found = false;\r\n    for (i = 0; (i < LAPSMOOTH_NUM_NEIBS) && !found; i++) {\r\n      if (this.m_vertNeib[idx + i] === INVALID_INDEX) {\r\n        break;\r\n      }\r\n      if (this.m_vertNeib[idx + i] === indTo) {\r\n        found = true;\r\n      }\r\n    }\r\n    if (found) {\r\n      return;\r\n    }\r\n\r\n    // add new link\r\n    for (i = 0; (i < LAPSMOOTH_NUM_NEIBS); i++) {\r\n      if (this.m_vertNeib[idx + i] === INVALID_INDEX) {\r\n        break;\r\n      }\r\n    }\r\n    if (i >= LAPSMOOTH_NUM_NEIBS) {\r\n      console.log('asserion failed for i < LAPSMOOTH_NUM_NEIBS');\r\n    }\r\n    this.m_vertNeib[idx + i] = indTo;\r\n  } // addNeib\r\n}\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Flood fill 3d volume\r\n* @module lib/scripts/actvolume/floodfill\r\n*/\r\n\r\n// absolute imports\r\nimport * as THREE from 'three';\r\n\r\n/**\r\n* Class FloodFillTool used to fill areas in 3d\r\n* @class FloodFillTool\r\n*/\r\nexport default class FloodFillTool {\r\n  constructoir() {\r\n    this.m_stack3d = [];\r\n    this.m_maxStack3d = 0;\r\n    this.m_indexStack3d = 0;\r\n    this.m_numFilled3d = 0;\r\n  }\r\n\r\n  createStack3d(numPixelsAll) {\r\n    const MAGIC_STCAK_ESTIMATE = 0.3;\r\n    this.m_maxStack3d = Math.floor(numPixelsAll * MAGIC_STCAK_ESTIMATE);\r\n    this.m_stack3d = [];\r\n    for (let i = 0; i < this.m_maxStack3d; i++) {\r\n      this.m_stack3d.push(new THREE.Vector3());\r\n    }\r\n    this.m_indexStack3d = 0;\r\n    this.m_numFilled3d = 0;\r\n    return 1;\r\n  }\r\n\r\n  destroyStack3d() {\r\n    this.m_stack3d = null;\r\n  }\r\n\r\n  stack3dPush(v) {\r\n    if (this.m_indexStack3d >= this.m_maxStack3d) {\r\n      return 0;\r\n    }\r\n    this.m_stack3d[this.m_indexStack3d].x = v.x;\r\n    this.m_stack3d[this.m_indexStack3d].y = v.y;\r\n    this.m_stack3d[this.m_indexStack3d].z = v.z;\r\n    this.m_indexStack3d++;\r\n    return 1;\r\n  }\r\n\r\n  stack3dPop() {\r\n    if (this.m_indexStack3d <= 0) {\r\n      return null;\r\n    }\r\n    this.m_indexStack3d--;\r\n    const v = new THREE.Vector3();\r\n    v.x = this.m_stack3d[this.m_indexStack3d].x;\r\n    v.y = this.m_stack3d[this.m_indexStack3d].y;\r\n    v.z = this.m_stack3d[this.m_indexStack3d].z;\r\n    return v;\r\n  }\r\n\r\n  stack3dEIsEmpty() {\r\n    return (this.m_indexStack3d <= 0);\r\n  }\r\n\r\n  detectSeedPoint3d(xDim, yDim, zDim, pixels, vaSeedPoints, maxSeedPoints) {\r\n    const TWO = 2;\r\n    const yDimHalf = Math.floor(yDim / TWO);\r\n    const zDimHalf = Math.floor(zDim / TWO);\r\n    const numItersY = (yDimHalf - 1) * TWO;\r\n    const numItersZ = (zDimHalf - 1) * TWO;\r\n    let numSeedPointsDetected = 0;\r\n    for (let zIter = 0; zIter < numItersZ; zIter++) {\r\n      let zStep = Math.floor(zIter / TWO);\r\n      if ((zIter & 1) !== 0) {\r\n        zStep = -zStep;\r\n      }\r\n      const z = zDimHalf + zStep;\r\n      const zOff = z * xDim * yDim;\r\n\r\n      for (let yIter = 0; yIter < numItersY; yIter++) {\r\n        let yStep = Math.floor(yIter / TWO);\r\n        if ((yIter & 1) !== 0) {\r\n          yStep = -yStep;\r\n        }\r\n        const y = yDimHalf + yStep;\r\n        const yOff = y * xDim;\r\n\r\n        let xL = -1;\r\n        let xR = -1;\r\n        let x;\r\n        for (x = 0; x < xDim - 1; x++) {\r\n          const isStartInside = (pixels[x + yOff + zOff] > 0)  && (pixels[x + 1 + yOff + zOff] === 0);\r\n          const isEndInside   = (pixels[x + yOff + zOff] === 0) && (pixels[x + 1 + yOff + zOff] > 0);\r\n          if (isStartInside) {\r\n            xL = x;\r\n          }\r\n          if (isEndInside && (xL >= 0)) {\r\n            xR = x + 1;\r\n            const xSegmentLen = xR - xL + 1;\r\n            if (xSegmentLen > 1) {\r\n              vaSeedPoints[numSeedPointsDetected].x = Math.floor((xL + xR) / TWO);\r\n              vaSeedPoints[numSeedPointsDetected].y = y;\r\n              vaSeedPoints[numSeedPointsDetected].z = z;\r\n              numSeedPointsDetected++;\r\n              if (numSeedPointsDetected >= maxSeedPoints) {\r\n                return numSeedPointsDetected;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      } // for (yIter)\r\n    } // for (zIter)\r\n    return numSeedPointsDetected;\r\n  }\r\n\r\n  floodFill3d(xDim, yDim, zDim, pixels, vSeed) {\r\n    const xyDim = xDim * yDim;\r\n    const okCreate = this.createStack3d(xDim * yDim * zDim);\r\n    if (okCreate !== 1) {\r\n      return okCreate;\r\n    }\r\n\r\n    const VIS = 255;\r\n    this.m_numFilled3d = 0;\r\n\r\n    this.stack3dPush(vSeed);\r\n    while (!this.stack3dEIsEmpty()) {\r\n      let x;\r\n\r\n      const vTaken = this.stack3dPop();\r\n      const y = vTaken.y;\r\n      const z = vTaken.z;\r\n\r\n      const yOff = y * xDim;\r\n      const zOff = z * xyDim;\r\n\r\n      // get leftmost\r\n      for (x = vTaken.x; (x >= 0) && (pixels[x + yOff + zOff] === 0);) {\r\n        x--;\r\n      }\r\n      const xL = x + 1;\r\n      // get rightmost\r\n      for (x = vTaken.x; (x < xDim) && (pixels[x + yOff + zOff] === 0);) {\r\n        x++;\r\n      }\r\n      const xR = x - 1;\r\n\r\n      let setYLess = VIS;\r\n      let setYMore = VIS;\r\n      let setZLess = VIS;\r\n      let setZMore = VIS;\r\n      for (x = xL; x <= xR; x++) {\r\n        // set point visible\r\n        pixels[x + yOff + zOff] = VIS;\r\n        this.m_numFilled3d++;\r\n\r\n        // check line y less\r\n        if ((y > 0) && (pixels[x + yOff - xDim + zOff] !== setYLess)) {\r\n          setYLess = VIS - setYLess;\r\n          if (setYLess === 0) {\r\n            // V3d vPu(x, y - 1, z);\r\n            const vPu = new THREE.Vector3(x, y - 1, z);\r\n            const okPush = this.stack3dPush(vPu);\r\n            if (okPush !== 1) {\r\n              return okPush;\r\n            }\r\n          } // if need to push\r\n        } // if (y less pint has another vis state\r\n\r\n        // check line above\r\n        if ((y < yDim - 1) && (pixels[x + yOff + xDim + zOff] !== setYMore)) {\r\n          setYMore = VIS - setYMore;\r\n          if (setYMore === 0) {\r\n            // V3d vPu(x, y + 1, z);\r\n            const vPu = new THREE.Vector3(x, y + 1, z);\r\n            const okPush = this.stack3dPush(vPu);\r\n            if (okPush !== 1) {\r\n              return okPush;\r\n            }\r\n          } // if need to push\r\n        } // if (y more point has another vis state\r\n\r\n        // check line z less\r\n        if ((z > 0) && (pixels[x + yOff + zOff - xyDim] !== setZLess)) {\r\n          setZLess = VIS - setZLess;\r\n          if (setZLess === 0) {\r\n            // V3d vPu(x, y, z - 1);\r\n            const vPu = new THREE.Vector3(x, y, z - 1);\r\n            const okPush = this.stack3dPush(vPu);\r\n            if (okPush !== 1) {\r\n              return okPush;\r\n            }\r\n          } // if need to push\r\n        } // if (z less pint has another vis state\r\n\r\n        // check line z more\r\n        if ((z < zDim - 1) && (pixels[x + yOff + zOff + xyDim] !== setZMore)) {\r\n          setZMore = VIS - setZMore;\r\n          if (setZMore === 0) {\r\n            // V3d vPu(x, y, z + 1);\r\n            const vPu = new THREE.Vector3(x, y, z + 1);\r\n            const okPush = this.stack3dPush(vPu);\r\n            if (okPush !== 1) {\r\n              return okPush;\r\n            }\r\n          } // if need to push\r\n        } // if (z more)\r\n      } // for (x) scanned hor line\r\n    } // while stack is not empty\r\n    this.destroyStack3d();\r\n    return 1;\r\n  }\r\n\r\n} // class\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* 3d volume generate from 3d polygon mesh\r\n* @module lib/scripts/actvolume/volgen\r\n*/\r\n\r\n// absolute imports\r\nimport * as THREE from 'three';\r\n\r\n// relative imports\r\nimport FloodFillTool from './floodfill';\r\n\r\n/**\r\n* Class VolumeGenerator create 3d volumes from polygonal triangle mesh\r\n* @class VolumeGenerator\r\n*/\r\nexport default class VolumeGenerator {\r\n\r\n  /**\r\n  * verts - array of THREE.Vector3\r\n  */\r\n  static renderTriangle(xDim, yDim, zDim, pixels, verts) {\r\n    const xyDim = xDim * yDim;\r\n\r\n    // outer loop:\r\n    // [0] -> [1]\r\n    // [0] -> [2]\r\n    const v01 = new THREE.Vector3();\r\n    const v02 = new THREE.Vector3();\r\n    const v12 = new THREE.Vector3();\r\n    v01.x = verts[1].x - verts[0].x;\r\n    v01.y = verts[1].y - verts[0].y;\r\n    v01.z = verts[1].z - verts[0].z;\r\n    v02.x = verts[2].x - verts[0].x;\r\n    v02.y = verts[2].y - verts[0].y;\r\n    v02.z = verts[2].z - verts[0].z;\r\n\r\n    v12.x = verts[2].x - verts[1].x;\r\n    v12.y = verts[2].y - verts[1].y;\r\n    v12.z = verts[2].z - verts[1].z;\r\n\r\n    const dist01 = Math.sqrt(v01.x * v01.x + v01.y * v01.y + v01.z * v01.z);\r\n    const dist02 = Math.sqrt(v02.x * v02.x + v02.y * v02.y + v02.z * v02.z);\r\n    const dist12 = Math.sqrt(v12.x * v12.x + v12.y * v12.y + v12.z * v12.z);\r\n\r\n    let distMax = (dist01 > dist02) ? dist01 : dist02;\r\n    distMax = (dist12 > distMax) ? dist12 : distMax;\r\n    const ITERS_ESTIMATE = 1.2;\r\n    const numIters = Math.floor(distMax * ITERS_ESTIMATE);\r\n\r\n    const vLScale = new THREE.Vector3();\r\n    const vRScale = new THREE.Vector3();\r\n\r\n    vLScale.x = v01.x / numIters;\r\n    vLScale.y = v01.y / numIters;\r\n    vLScale.z = v01.z / numIters;\r\n\r\n    vRScale.x = v02.x / numIters;\r\n    vRScale.y = v02.y / numIters;\r\n    vRScale.z = v02.z / numIters;\r\n\r\n    const vL = new THREE.Vector3(verts[0].x, verts[0].y, verts[0].z);\r\n    const vR = new THREE.Vector3(verts[0].x, verts[0].y, verts[0].z);\r\n    const vLR = new THREE.Vector3();\r\n    const vScale = new THREE.Vector3();\r\n    const v = new THREE.Vector3();\r\n\r\n    for (let iterSide = 0; iterSide <= numIters; iterSide++) {\r\n      vLR.x = vR.x - vL.x;\r\n      vLR.y = vR.y - vL.y;\r\n      vLR.z = vR.z - vL.z;\r\n\r\n      vScale.x = vLR.x / numIters;\r\n      vScale.y = vLR.y / numIters;\r\n      vScale.z = vLR.z / numIters;\r\n\r\n      v.x = vL.x;\r\n      v.y = vL.y;\r\n      v.z = vL.z;\r\n\r\n      const VIS = 255;\r\n      // interpolate between vL <-> vR\r\n      for (let i = 0; i <= numIters; i++) {\r\n        let x = Math.floor(v.x);\r\n        let y = Math.floor(v.y);\r\n        let z = Math.floor(v.z);\r\n\r\n        if ((x >= 0) && (y >= 0) && (z >= 0) && (x < xDim) && (y < yDim) && (z < zDim)) {\r\n          const off = x + (y * xDim) + (z * xyDim);\r\n          pixels[off] = VIS;\r\n        }\r\n\r\n        // try to fill neighb\r\n        x = Math.floor(v.x) + 1;\r\n        y = Math.floor(v.y) + 0;\r\n        z = Math.floor(v.z) + 0;\r\n        if ((x >= 0) && (y >= 0) && (z >= 0) && (x < xDim) && (y < yDim) && (z < zDim)) {\r\n          const off = x + (y * xDim) + (z * xyDim);\r\n          pixels[off] = VIS;\r\n        }\r\n\r\n        x = Math.floor(v.x) + 0;\r\n        y = Math.floor(v.y) + 1;\r\n        z = Math.floor(v.z) + 0;\r\n        if ((x >= 0) && (y >= 0) && (z >= 0) && (x < xDim) && (y < yDim) && (z < zDim)) {\r\n          const off = x + (y * xDim) + (z * xyDim);\r\n          pixels[off] = VIS;\r\n        }\r\n\r\n        x = Math.floor(v.x) + 0;\r\n        y = Math.floor(v.y) + 0;\r\n        z = Math.floor(v.z) + 1;\r\n        if ((x >= 0) && (y >= 0) && (z >= 0) && (x < xDim) && (y < yDim) && (z < zDim)) {\r\n          const off = x + (y * xDim) + (z * xyDim);\r\n          pixels[off] = VIS;\r\n        }\r\n\r\n        x = Math.floor(v.x) - 1;\r\n        y = Math.floor(v.y) + 0;\r\n        z = Math.floor(v.z) + 0;\r\n        if ((x >= 0) && (y >= 0) && (z >= 0) && (x < xDim) && (y < yDim) && (z < zDim)) {\r\n          const off = x + (y * xDim) + (z * xyDim);\r\n          pixels[off] = VIS;\r\n        }\r\n\r\n        x = Math.floor(v.x) + 0;\r\n        y = Math.floor(v.y) - 1;\r\n        z = Math.floor(v.z) + 0;\r\n        if ((x >= 0) && (y >= 0) && (z >= 0) && (x < xDim) && (y < yDim) && (z < zDim)) {\r\n          const off = x + (y * xDim) + (z * xyDim);\r\n          pixels[off] = VIS;\r\n        }\r\n        x = Math.floor(v.x) + 0;\r\n        y = Math.floor(v.y) + 0;\r\n        z = Math.floor(v.z) - 1;\r\n        if ((x >= 0) && (y >= 0) && (z >= 0) && (x < xDim) && (y < yDim) && (z < zDim)) {\r\n          const off = x + (y * xDim) + (z * xyDim);\r\n          pixels[off] = VIS;\r\n        }\r\n        // next v\r\n        v.x += vScale.x;\r\n        v.y += vScale.y;\r\n        v.z += vScale.z;\r\n      }\r\n      // next L, R\r\n      vL.x += vLScale.x;\r\n      vL.y += vLScale.y;\r\n      vL.z += vLScale.z;\r\n\r\n      vR.x += vRScale.x;\r\n      vR.y += vRScale.y;\r\n      vR.z += vRScale.z;\r\n    }\r\n  }\r\n\r\n  /**\r\n  *\r\n  * return true, if success\r\n  */\r\n  static generateFromFaces(xDim, yDim, zDim, pixelsDst, geo, withFillInside) {\r\n    const numTriangles = geo.getNumTriangles();\r\n    const indices = geo.getIndices(); // Uint32 array\r\n    const vertices = geo.getVertices(); // floar array\r\n    let i, i3;\r\n    const NUM_VERT_TRI = 3;\r\n    const NUM_COMP_VERTEX = 4;\r\n\r\n    const OFF_0 = 0;\r\n    const OFF_1 = 1;\r\n    const OFF_2 = 2;\r\n\r\n    console.log('VolumeGeberator. render triangles');\r\n\r\n    // clear dst buffer\r\n    const numPixels = xDim * yDim * zDim;\r\n    for (i = 0; i < numPixels; i++) {\r\n      pixelsDst[i] = 0;\r\n    }\r\n\r\n    const vs = [];\r\n    vs.push(new THREE.Vector3());\r\n    vs.push(new THREE.Vector3());\r\n    vs.push(new THREE.Vector3());\r\n    for (i = 0, i3 = 0; i < numTriangles; i++, i3 += NUM_VERT_TRI) {\r\n      const ia = indices[i3 + OFF_0];\r\n      const ib = indices[i3 + OFF_1];\r\n      const ic = indices[i3 + OFF_2];\r\n      vs[OFF_0].x = vertices[(ia * NUM_COMP_VERTEX) + OFF_0];\r\n      vs[OFF_0].y = vertices[(ia * NUM_COMP_VERTEX) + OFF_1];\r\n      vs[OFF_0].z = vertices[(ia * NUM_COMP_VERTEX) + OFF_2];\r\n\r\n      vs[OFF_1].x = vertices[(ib * NUM_COMP_VERTEX) + OFF_0];\r\n      vs[OFF_1].y = vertices[(ib * NUM_COMP_VERTEX) + OFF_1];\r\n      vs[OFF_1].z = vertices[(ib * NUM_COMP_VERTEX) + OFF_2];\r\n\r\n      vs[OFF_2].x = vertices[(ic * NUM_COMP_VERTEX) + OFF_0];\r\n      vs[OFF_2].y = vertices[(ic * NUM_COMP_VERTEX) + OFF_1];\r\n      vs[OFF_2].z = vertices[(ic * NUM_COMP_VERTEX) + OFF_2];\r\n\r\n      VolumeGenerator.renderTriangle(xDim, yDim, zDim, pixelsDst, vs);\r\n    } // for (i) all triangles\r\n    console.log('VolumeGeberator. fill internal');\r\n    if (withFillInside) {\r\n      const fillTool = new FloodFillTool();\r\n      const xyzDim = xDim * yDim * zDim;\r\n      const pixelsFill = new Uint8Array(xyzDim);\r\n\r\n      const MAX_SEED_POINTS = 16;\r\n      const vaSeeds = [];\r\n      for (i = 0; i < MAX_SEED_POINTS; i++) {\r\n        vaSeeds.push(new THREE.Vector3());\r\n      }\r\n      const numSeedPoints = fillTool.detectSeedPoint3d(xDim, yDim, zDim, pixelsDst, vaSeeds, MAX_SEED_POINTS);\r\n      console.log(`VolGen. Detected ${numSeedPoints} seed points`);\r\n      let foundGoodFill = false;\r\n      for (let s = 0; s < numSeedPoints; s++) {\r\n        // fill using seed point\r\n        const vSeed = vaSeeds[s];\r\n        // memcpy(pixelsFill, pixels, xyzDim);\r\n        for (i = 0; i < xyzDim; i++) {\r\n          pixelsFill[i] = pixelsDst[i];\r\n        }\r\n\r\n        console.log(`VolGen. Try to flood fill from ${vSeed.x}, ${vSeed.y}, ${vSeed.z} `);\r\n        console.log(`VolGen. inside volume ${xDim}, ${yDim}, ${zDim} `);\r\n\r\n        const okFill = fillTool.floodFill3d(xDim, yDim, zDim, pixelsFill, vSeed);\r\n        console.log(`VolGen. Result fill = ${okFill}. numDraws = ${fillTool.m_numFilled3d}`);\r\n        const VIS = 255;\r\n        const OFF_CORNER = 1 + (1 * xDim) + (1 * xDim * yDim);\r\n        if ((okFill === 1) && (pixelsFill[OFF_CORNER] !== VIS)) {\r\n          foundGoodFill = true;\r\n          break;\r\n        }\r\n      } // for (s) all seed points\r\n      // copy back\r\n      if (foundGoodFill) {\r\n        // memcpy(pixels, pixelsFill, xyzDim);\r\n        for (i = 0; i < xyzDim; i++) {\r\n          pixelsDst[i] = pixelsFill[i];\r\n        }\r\n      }\r\n      if (!foundGoodFill) {\r\n        return false;\r\n      }\r\n    } // if need fill\r\n    return true;\r\n  }\r\n}\r\n\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Math volume processing tools\r\n* @module lib/scripts/loaders/voltools\r\n*/\r\n\r\n// ****************************************************************************\r\n// Imports\r\n// ****************************************************************************\r\n\r\n// ****************************************************************************\r\n// Consts\r\n// ****************************************************************************\r\n\r\n/** @constant {number} maximum smoothing neighbourhood size */\r\n// eslint-disable-next-line\r\nconst GAUSS_SMOOTH_MAX_SIDE = (11 * 2 + 1);\r\n\r\n/** @constant {number} maximum side for input volume */\r\nconst MAX_VOLUME_SIDE_INPUT = 4096;\r\n\r\n// ****************************************************************************\r\n// Classes\r\n// ****************************************************************************\r\n\r\n/** Class VolumeTools for some volume math operations */\r\nexport default class VolumeTools {\r\n\r\n  /**\r\n  * Constructor create array for Gaussian weight koefficients\r\n  */\r\n  constructor() {\r\n    this.m_gaussWeights = new Float32Array(GAUSS_SMOOTH_MAX_SIDE * GAUSS_SMOOTH_MAX_SIDE * GAUSS_SMOOTH_MAX_SIDE);\r\n  }\r\n\r\n  /**\r\n  * Smooth volume (3d matrix) with given parameters\r\n  * @param {object} volBuffer - source volume\r\n  * @param {number} xDim - source volume x dimension\r\n  * @param {number} yDim - source volume y dimension\r\n  * @param {number} zDim - source volume z dimension\r\n  * @param {number} gaussRadius - radius for smoothing\r\n  * @param {number} gaussSigma - sigma koefficient for smoothing\r\n  * @return {number} 1, if everything fine\r\n  */\r\n  gaussSmooth(volBuffer,\r\n    xDim,\r\n    yDim,\r\n    zDim,\r\n    gaussRadius,\r\n    gaussSigma) {\r\n    // eslint-disable-next-line\r\n    const side = Math.floor(gaussRadius * 2 + 1);\r\n    // check valid arguments\r\n    const ERR_SIDE = -1;\r\n    const ERR_BAD_SIGMA = -2;\r\n    const ERR_DIM_NEGATIVE = -3;\r\n    const ERR_DIM_LARGE = -4;\r\n    const ERR_VOL_BUF_NULL = -5;\r\n    const ERR_WRONG_BUF_SIZE = -6;\r\n    if (side > GAUSS_SMOOTH_MAX_SIDE) {\r\n      return ERR_SIDE;\r\n    }\r\n    const SIGMA_MIN = 0.0;\r\n    const SIGMA_MAX = 8.0;\r\n    if ((gaussSigma < SIGMA_MIN) || (gaussSigma > SIGMA_MAX)) {\r\n      return ERR_BAD_SIGMA;\r\n    }\r\n    if ((xDim <= 0) || (yDim <= 0) || (zDim <= 0)) {\r\n      return ERR_DIM_NEGATIVE;\r\n    }\r\n    if ((xDim > MAX_VOLUME_SIDE_INPUT) || (yDim > MAX_VOLUME_SIDE_INPUT) || (zDim > MAX_VOLUME_SIDE_INPUT)) {\r\n      return ERR_DIM_LARGE;\r\n    }\r\n    // check valid buffer size\r\n    if (volBuffer === null) {\r\n      return ERR_VOL_BUF_NULL;\r\n    }\r\n    const bufSize = volBuffer.length;\r\n    if (bufSize < xDim * yDim * zDim) {\r\n      return ERR_WRONG_BUF_SIZE;\r\n    }\r\n\r\n    const side2 = side * side;\r\n    const side3 = side2 * side;\r\n    // eslint-disable-next-line\r\n    const koefSpatial = 1.0 / (2.0 * gaussSigma * gaussSigma);\r\n\r\n    // console.log(`Start Gauss smoothing`);\r\n\r\n    const xyzDim = xDim * yDim * zDim;\r\n    const volDst = new Uint8Array(xyzDim);\r\n    // if (volDst === null) {\r\n    //   return -10;\r\n    // }\r\n\r\n    // Fill gauss convolution matrix\r\n    let weightSum = 0.0;\r\n    let off = 0;\r\n    for (let z = 0; z < side; z++) {\r\n      const dz = z - gaussRadius;\r\n      for (let y = 0; y < side; y++) {\r\n        const dy = y - gaussRadius;\r\n        for (let x = 0; x < side; x++) {\r\n          const dx = x - gaussRadius;\r\n          const dist2 = dx * dx + dy * dy + dz * dz;\r\n          const w = 1.0 / Math.exp((dist2) * koefSpatial);\r\n          this.m_gaussWeights[off] = w;\r\n          weightSum += this.m_gaussWeights[off];\r\n          off += 1;\r\n        }  // for (x)\r\n      }  // for (y)\r\n    }  // for (z)\r\n\r\n    // Normalize gauss matrix\r\n    const scale = 1.0 / weightSum;\r\n    for (let x = 0; x < side3; x++) {\r\n      this.m_gaussWeights[x] *= scale;\r\n    }\r\n\r\n    const xyDim = xDim * yDim;\r\n    // process whole image using gauss matrix\r\n    for (let z = 0; z < zDim; z++) {\r\n      for (let y = 0; y < yDim; y++) {\r\n        for (let x = 0; x < xDim; x++) {\r\n          let sum = 0.0;\r\n          let offConv = 0;\r\n          for (let dz = -gaussRadius; dz <= +gaussRadius; dz++) {\r\n            let zz = z + dz;\r\n            zz = (zz < 0) ? 0 : zz;\r\n            zz = (zz >= zDim) ? (zDim - 1) : zz;\r\n            for (let dy = -gaussRadius; dy <= +gaussRadius; dy++) {\r\n              let yy = y + dy;\r\n              yy = (yy < 0) ? 0 : yy;\r\n              yy = (yy >= yDim) ? (yDim - 1) : yy;\r\n              for (let dx = -gaussRadius; dx <= +gaussRadius; dx++) {\r\n                let xx = x + dx;\r\n                xx = (xx < 0) ? 0 : xx;\r\n                xx = (xx >= xDim) ? (xDim - 1) : xx;\r\n                const w = this.m_gaussWeights[offConv];\r\n                offConv += 1;\r\n                const offImage = zz * xyDim + yy * xDim + xx;\r\n                const val = volBuffer[offImage];\r\n                sum += val * w;\r\n              }   // for (dx)\r\n            }     // for (dy)\r\n          }       // for (dz)\r\n          let iSum = Math.floor(sum);\r\n          const MAX_BYTE = 255;\r\n          iSum = (iSum <= MAX_BYTE) ? iSum : MAX_BYTE;\r\n          const offImage = z * xyDim + y * xDim + x;\r\n          volDst[offImage] = iSum;\r\n        }         // for (x)\r\n      }           // for (y)\r\n    }             // for (z)\r\n\r\n    // copy filtered volume back to source\r\n    // volBuffer.set(volDst, 0);\r\n    for (let i = 0; i < xyzDim; i++) {\r\n      volBuffer[i] = volDst[i];\r\n    }\r\n    // console.log(`End Gauss smoothing`);\r\n    return 1;\r\n  }\r\n\r\n  /**\r\n  * Smooth 1d histogram function\r\n  * @param {object} histSrc - source histogram\r\n  * @param {object} histDst - destination histogram\r\n  * @param {number} numEntries - number of entries in histogram\r\n  * @param {number} gaussSigma - sigma koefficient for smoothing\r\n  * @return {number} 1, if everything fine\r\n  */\r\n  static buildSmoothedHistogram(histSrc, histDst, numEntries, gaussSigma) {\r\n    // check args\r\n    const ERR_NO_SRC = -1;\r\n    const ERR_NO_DST = -2;\r\n    const ERR_SRC_DST_DIF_LEN = -3;\r\n    const ERR_SRC_LEN_NOT_MATCH = -4;\r\n    const ERR_SIGMA_RANGE = -5;\r\n    if (histSrc === null) {\r\n      return ERR_NO_SRC;\r\n    }\r\n    if (histDst === null) {\r\n      return ERR_NO_DST;\r\n    }\r\n    if (histSrc.length !== histDst.length) {\r\n      return ERR_SRC_DST_DIF_LEN;\r\n    }\r\n    if (histSrc.length !== numEntries) {\r\n      return ERR_SRC_LEN_NOT_MATCH;\r\n    }\r\n    const SIGMA_MIN = 0.0;\r\n    const SIGMA_MAX = 64.0;\r\n    if ((gaussSigma < SIGMA_MIN) || (gaussSigma > SIGMA_MAX)) {\r\n      return ERR_SIGMA_RANGE;\r\n    }\r\n\r\n    const SIZE_DIV = 60;\r\n    let windowSize = Math.floor(numEntries / SIZE_DIV);\r\n    // avoid too large neighbourhood window size\r\n    const SIZE_LARGE = 32;\r\n    if (windowSize > SIZE_LARGE) {\r\n      windowSize = SIZE_LARGE;\r\n    }\r\n\r\n    for (let i = 0; i < numEntries; i++) {\r\n      let sum = 0.0;\r\n      let sumKoef = 0.0;\r\n      for (let j = -windowSize; j <= +windowSize; j++) {\r\n        // t in [-1..+1]\r\n        let t = j / windowSize;\r\n        // t in [0..1]\r\n        t = (t >= 0.0) ? t : -t;\r\n        let idx = i + j;\r\n        idx = (idx >= 0) ? idx : 0;\r\n        idx = (idx < numEntries) ? idx : (numEntries - 1);\r\n        const val = histSrc[idx];\r\n        const koef = Math.exp(-t * gaussSigma);\r\n        sum += val * koef;\r\n        sumKoef += koef;\r\n      } // for j around neighbourhood\r\n      // divide by window range\r\n      // sum /= (2 * windowSize + 1);\r\n      // normalize average\r\n      sum /= sumKoef;\r\n      histDst[i] = Math.floor(sum);\r\n    } // for i all entries\r\n    return 1;\r\n  } // buildSmoothedHistogram\r\n\r\n  /**\r\n  * Scale down xy plane twice\r\n  * @param {object} loader - Loader object\r\n  * @param {array} dataArray - sorce volume\r\n  * @return {array} modified (scalewd down) volume\r\n  */\r\n  static scaleDownXYtwice(loader, dataArray) {\r\n    const VAL_2 = 2;\r\n    const VAL_4 = 4;\r\n    const xDim = Math.floor(loader.m_xDim / VAL_2);\r\n    const yDim = Math.floor(loader.m_yDim / VAL_2);\r\n    const zDim = loader.m_zDim;\r\n    // console.log(`Performimg scale down to ${xDim} * ${yDim} ...`);\r\n    const xyDimSrc = loader.m_xDim * loader.m_yDim;\r\n    const xyDimDst = xDim * yDim;\r\n    const dataSizeNew = xDim * yDim * zDim;\r\n    const dataNew = new Uint8Array(dataSizeNew);\r\n    for (let z = 0; z < loader.m_zDim; z++) {\r\n      const offSrcZ = z * xyDimSrc;\r\n      const offDstZ = z * xyDimDst;\r\n      for (let y = 0; y < yDim; y++) {\r\n        const ySrc = y + y;\r\n        const offSrcY = ySrc * loader.m_xDim;\r\n        const offDstY = y * xDim;\r\n        for (let x = 0; x < xDim; x++) {\r\n          const xSrc = x + x;\r\n          const offSrc = offSrcZ + offSrcY + xSrc;\r\n          const aveSrc = (dataArray[offSrc + 0] + dataArray[offSrc + 1] +\r\n            dataArray[offSrc + loader.m_xDim] + dataArray[offSrc + loader.m_xDim + 1]) / VAL_4;\r\n          dataNew[offDstZ + offDstY + x] = aveSrc;\r\n        } // for x\r\n      } // for y\r\n    } // for z all slices\r\n    // assign new array\r\n    loader.m_xDim = xDim;\r\n    loader.m_yDim = yDim;\r\n    if (loader.m_pixelSpacing !== undefined) {\r\n      // number of pixels is twice smaller (on x,y) now:\r\n      // we need to increase size of voxel in physic space to keep correct\r\n      // proportions for the whole volume visualization\r\n      loader.m_pixelSpacing.x *= 2.0;\r\n      loader.m_pixelSpacing.y *= 2.0;\r\n    }\r\n    return dataNew;\r\n  }\r\n\r\n  /**\r\n  * Scale down\r\n  * @param {object} loader - Loader object\r\n  * @param {array} pixelSrc - source volume pixels\r\n  * @param {number} xDimDst - destination volume size on x\r\n  * @param {number} yDimDst - destination volume size on y\r\n  * @param {number} zDimDst - destination volume size on z\r\n  * @return {array} modified (scaled) volume\r\n  */\r\n  static scaleTextureDown(loader, pixelsSrc, xDimDst, yDimDst, zDimDst) {\r\n    const ACC_BITS = 10;\r\n    const ACC_HALF = 1 << (ACC_BITS - 1);\r\n    const xyzDimDst = xDimDst * yDimDst * zDimDst;\r\n    const pixelsDst = new Uint8Array(xyzDimDst);\r\n\r\n    const xDimSrc = loader.m_xDim;\r\n    const yDimSrc = loader.m_yDim;\r\n    const zDimSrc = loader.m_zDim;\r\n\r\n    const isCorrectDim = (xDimSrc > xDimDst) || (yDimSrc > yDimDst) || (zDimSrc > zDimDst);\r\n    if (!isCorrectDim) {\r\n      return null;\r\n    }\r\n    const xyDimSrc = xDimSrc * yDimSrc;\r\n\r\n    const xStep = Math.floor((xDimSrc << ACC_BITS) / xDimDst);\r\n    const yStep = Math.floor((yDimSrc << ACC_BITS) / yDimDst);\r\n    const zStep = Math.floor((zDimSrc << ACC_BITS) / zDimDst);\r\n    let indDst = 0;\r\n    let zSrcAccL = ACC_HALF;\r\n    let zSrcAccH = zSrcAccL + zStep;\r\n    for (let zDst = 0; zDst < zDimDst; zDst++, zSrcAccL += zStep, zSrcAccH += zStep) {\r\n      const zSrcL = zSrcAccL >> ACC_BITS;\r\n      const zSrcH = zSrcAccH >> ACC_BITS;\r\n\r\n      let ySrcAccL = ACC_HALF;\r\n      let ySrcAccH = ySrcAccL + yStep;\r\n      for (let yDst = 0; yDst < yDimDst; yDst++, ySrcAccL += yStep, ySrcAccH += yStep) {\r\n        const ySrcL = ySrcAccL >> ACC_BITS;\r\n        const ySrcH = ySrcAccH >> ACC_BITS;\r\n\r\n        let xSrcAccL = ACC_HALF;\r\n        let xSrcAccH = xSrcAccL + xStep;\r\n        for (let xDst = 0; xDst < xDimDst; xDst++, xSrcAccL += xStep, xSrcAccH += xStep) {\r\n          const xSrcL = xSrcAccL >> ACC_BITS;\r\n          const xSrcH = xSrcAccH >> ACC_BITS;\r\n\r\n          // Accumulate sum\r\n          let sum = 0;\r\n          let numPixels = 0;\r\n          for (let z = zSrcL, zOff = zSrcL * xyDimSrc; z < zSrcH; z++, zOff += xyDimSrc) {\r\n            for (let y = ySrcL, yOff = ySrcL * xDimSrc; y < ySrcH; y++, yOff += xDimSrc) {\r\n              for (let x = xSrcL; x < xSrcH; x++) {\r\n                const offSrc = x + yOff + zOff;\r\n                sum += pixelsSrc[offSrc];\r\n                numPixels++;\r\n              } // for (x)\r\n            }  // for (y)\r\n          }  // for (z)\r\n          sum = Math.floor(sum / numPixels);\r\n          pixelsDst[indDst++] = sum;\r\n        } // for (xDst)\r\n      }  // for (yDst)\r\n    }  // for (zDst)\r\n    loader.m_xDim = xDimDst;\r\n    loader.m_yDim = yDimDst;\r\n    loader.m_zDim = zDimDst;\r\n    return pixelsDst;\r\n  }  // end of scaleTextureDown\r\n\r\n  /**\r\n  * Scale down\r\n  * @param {array} pixelSrc - source volume pixels\r\n  * @param {number} xDimSrc - destination volume size on x\r\n  * @param {number} yDimSrc - destination volume size on y\r\n  * @param {number} zDimSrc - destination volume size on z\r\n  */\r\n  static scaleDown(pixelsSrc, xDimSrc, yDimSrc, zDimSrc, pixelsDst, xScale, yScale, zScale) {\r\n    const xDimDst = Math.floor(xDimSrc / xScale);\r\n    const yDimDst = Math.floor(yDimSrc / yScale);\r\n    const zDimDst = Math.floor(zDimSrc / zScale);\r\n    let offDst = 0;\r\n    for (let z = 0; z < zDimDst; z++) {\r\n      const zSrcMin = (z + 0) * zScale;\r\n      const zSrcMax = (z + 1) * zScale;\r\n      for (let y = 0; y < yDimDst; y++) {\r\n        const ySrcMin = (y + 0) * yScale;\r\n        const ySrcMax = (y + 1) * yScale;\r\n        for (let x = 0; x < xDimDst; x++) {\r\n          const xSrcMin = (x + 0) * xScale;\r\n          const xSrcMax = (x + 1) * xScale;\r\n\r\n          // get ave value\r\n          let valAve = 0;\r\n          let numPixelsAve = 0;\r\n\r\n          for (let zz = zSrcMin; zz < zSrcMax; zz++) {\r\n            const zOff = zz * xDimSrc * yDimSrc;\r\n            for (let yy = ySrcMin; yy < ySrcMax; yy++) {\r\n              const yOff = yy * xDimSrc;\r\n              for (let xx = xSrcMin; xx < xSrcMax; xx++) {\r\n                const offSrc = xx + yOff + zOff;\r\n                const val = pixelsSrc[offSrc];\r\n                valAve += val;\r\n                numPixelsAve++;\r\n              }   // for (xx)\r\n            }     // for (yy)\r\n          }       // for (zz)\r\n          valAve /= numPixelsAve;\r\n          pixelsDst[offDst++] = Math.floor(valAve);\r\n        } // for (x)\r\n      } // for (y)\r\n    } // for (z)\r\n  }\r\n\r\n  /**\r\n  * Contrast enhance by unsharpen mask\r\n  *\r\n  * Wiki ref: https://en.wikipedia.org/wiki/Unsharp_masking\r\n  *\r\n  * main formula: sharpened =\r\n  *                           original + (original - blurred) * multiplier, if (original - blurred > EPS)\r\n  *                           original, otherwise\r\n  *\r\n  * @param {array} pixelsSrc - source volume pixels\r\n  * @param {number} xDim - volume size on x\r\n  * @param {number} yDim - volume size on y\r\n  * @param {number} zDim - volume size on z\r\n  * @param {array} pixelsDst - destination pixels\r\n  * @param {number} radSmooth - radius of smoothing for unsharp mask\r\n  * @param {number} sigmaSmooth - smoothing sigma for unsharp mask\r\n  * @param {number} multiplier - multiplier for formula above\r\n  * @return {number} 1, if OK\r\n  */\r\n  static contrastEnchanceUnsharpMask(pixelsSrc,\r\n    xDim,\r\n    yDim,\r\n    zDim,\r\n    pixelsDst,\r\n    radSmooth,\r\n    sigmaSmooth,\r\n    multiplier,\r\n    needConsoleLog = false) {\r\n    // check input arguments\r\n    if ((typeof xDim !== 'number') || (typeof yDim !== 'number') || (typeof zDim !== 'number')) {\r\n      return VolumeTools.VOLTOOLS_ERROR_BAD_NUMBER;\r\n    }\r\n    if (typeof pixelsSrc !== 'object') {\r\n      return VolumeTools.VOLTOOLS_ERROR_BAD_ARRAY;\r\n    }\r\n    if (typeof pixelsDst !== 'object') {\r\n      return VolumeTools.VOLTOOLS_ERROR_BAD_ARRAY;\r\n    }\r\n    if (multiplier < 1.0) {\r\n      return VolumeTools.VOLTOOLS_ERROR_BAD_MULTIPLIER;\r\n    }\r\n    const MAX_POSSIBLE_MULTIPLIER = 256.0;\r\n    if (multiplier >= MAX_POSSIBLE_MULTIPLIER) {\r\n      return VolumeTools.VOLTOOLS_ERROR_BAD_MULTIPLIER;\r\n    }\r\n    if ((xDim <= 1) || (yDim <= 1) || (zDim <= 1)) {\r\n      return VolumeTools.VOLTOOLS_ERROR_BAD_DIMENSION;\r\n    }\r\n    const MAX_POSSIBLE_DIM = 4096;\r\n    if ((xDim >= MAX_POSSIBLE_DIM) || (yDim >= MAX_POSSIBLE_DIM) || (zDim >= MAX_POSSIBLE_DIM)) {\r\n      return VolumeTools.VOLTOOLS_ERROR_BAD_DIMENSION;\r\n    }\r\n    const TWO = 2;\r\n    const side = TWO * radSmooth + 1;\r\n    const side3 = side * side * side;\r\n    const xyDim = xDim * yDim;\r\n\r\n    // allocate gauss convolution 3d matrix\r\n    const gaussWeights = new Float32Array(side3);\r\n\r\n    // flll gauss convolution matrix\r\n    const koefSpatial = 1.0 / (TWO * sigmaSmooth * sigmaSmooth);\r\n    let weightSum = 0.0;\r\n    let off = 0;\r\n    for (let z = 0; z < side; z++) {\r\n      const dz = z - radSmooth;\r\n      for (let y = 0; y < side; y++) {\r\n        const dy = y - radSmooth;\r\n        for (let x = 0; x < side; x++) {\r\n          const dx = x - radSmooth;\r\n          const dist2 = 1.0 * dx * dx + dy * dy + dz * dz;\r\n          const w = 1.0 / Math.exp((dist2) * koefSpatial);\r\n          gaussWeights[off] = w;\r\n          weightSum += gaussWeights[off];\r\n          off++;\r\n        }   // for (x)\r\n      }     // for (y)\r\n    }       // for (z)\r\n    // Normalize gauss matrix\r\n    const scale = 1.0 / weightSum;\r\n    for (let x = 0; x < side3; x++) {\r\n      gaussWeights[x] *= scale;\r\n    }\r\n    // Process image\r\n    for (let zc = 0; zc < zDim; zc++) {\r\n      for (let yc = 0; yc < yDim; yc++) {\r\n        for (let xc = 0; xc < xDim; xc++) {\r\n          let valSmoothed = 0.0;\r\n          let offConv = 0;\r\n          for (let dz = -radSmooth; dz <= +radSmooth; dz++) {\r\n            let z = zc + dz;\r\n            z = (z < 0) ? 0 : (z >= zDim) ? (zDim - 1) : z;\r\n            const zOff = z * xyDim;\r\n            for (let dy = -radSmooth; dy <= +radSmooth; dy++) {\r\n              let y = yc + dy;\r\n              y = (y < 0) ? 0 : (y >= yDim) ? (yDim - 1) : y;\r\n              const yOff = y * xDim;\r\n              for (let dx = -radSmooth; dx <= +radSmooth; dx++) {\r\n                let x = xc + dx;\r\n                x = (x < 0) ? 0 : (x >= xDim) ? (xDim - 1) : x;\r\n\r\n                const w = gaussWeights[offConv];\r\n                offConv++;\r\n                const offImage = x + yOff + zOff;\r\n                const val = pixelsSrc[offImage];\r\n                valSmoothed += w * val;\r\n\r\n              } // for (dx)\r\n            } // for (dy)\r\n          } // for (dz)\r\n\r\n          // now valSmoothed is smoothed pixel intensity at (xc, yc)\r\n          off = xc + yc * xDim + zc * xyDim;\r\n          let val = pixelsSrc[off];\r\n          const valDif = val - valSmoothed;\r\n          const MIN_DIF_UNSHARP_VAL = 2.0;\r\n          const valAdd = ((valDif > MIN_DIF_UNSHARP_VAL) || (valDif < -MIN_DIF_UNSHARP_VAL)) ?\r\n            (valDif * multiplier) : 0.0;\r\n          let  valSharpened = val + valAdd;\r\n          valSharpened = (valSharpened < 0.0) ? 0.0 : valSharpened;\r\n          val = Math.floor(valSharpened);\r\n          const MAX_COLOR = 255;\r\n          val = (val > MAX_COLOR) ? MAX_COLOR : val;\r\n          pixelsDst[off] = val;\r\n          if (needConsoleLog) {\r\n            const MASK_MANY = 16383;\r\n            if ((off & MASK_MANY) === 0) {\r\n              const HUNDR = 100.0;\r\n              const ratioPrc = off * HUNDR / (xDim * yDim * zDim);\r\n              console.log(`contrastEnchanceUnsharpMask: ${ratioPrc} %`);\r\n            }\r\n          } // if ned console\r\n        } // for (xc)\r\n      }  // for (yc)\r\n    }  // for (zc)\r\n\r\n    return VolumeTools.VOLTOOLS_ERROR_OK;\r\n  }\r\n\r\n  /**\r\n  * Make texture size (z dimension) even number.\r\n  * Odd numbers are lead to render artifacts during 3d texture packing into 2d texture.\r\n  * @param {array} pixelsSrc - source volume pixels\r\n  * @param {number} xDim - volume size on x\r\n  * @param {number} yDim - volume size on y\r\n  * @param {number} zDim - volume size on z\r\n  */\r\n  static makeTextureSizeEven(pixelsSrc, xDim, yDim, zDim) {\r\n    const BYTES_IN_DWORD = 4;\r\n    const NUM3 = 3;\r\n    if (((xDim % BYTES_IN_DWORD) === 0) && ((yDim % BYTES_IN_DWORD) === 0) && ((zDim % BYTES_IN_DWORD) === 0)) {\r\n      return pixelsSrc;\r\n    }\r\n    const xDimNew = (xDim + NUM3) & (~NUM3);\r\n    const yDimNew = (yDim + NUM3) & (~NUM3);\r\n    const zDimNew = (zDim + NUM3) & (~NUM3);\r\n\r\n    const numPixelsNew = xDimNew * yDimNew * zDimNew;\r\n    const pixelsDst = new Uint8Array(numPixelsNew);\r\n\r\n    let i;\r\n    for (i = 0; i < numPixelsNew; i++) {\r\n      pixelsDst[i] = 0;\r\n    }\r\n\r\n    for (let z = 0; z < zDim; z++) {\r\n      const zOffSrc = z * xDim * yDim;\r\n      const zOffDst = z * xDimNew * yDimNew;\r\n      for (let y = 0; y < yDim; y++) {\r\n        const yOffSrc = y * xDim;\r\n        const yOffDst = y * xDimNew;\r\n        for (let x = 0; x < xDim; x++) {\r\n          const offSrc = x + yOffSrc + zOffSrc;\r\n          const val = pixelsSrc[offSrc];\r\n          const offDst = x + yOffDst + zOffDst;\r\n          pixelsDst[offDst] = val;\r\n        }\r\n      }\r\n    }\r\n\r\n    console.log(`modified texture size is: ${xDimNew} * ${yDimNew} * ${zDimNew}`);\r\n    return pixelsDst;\r\n  } // makeTextureSizeEven\r\n\r\n  /**\r\n  * Extract 2d texture from normal 3d array\r\n  * @param {number} xDim - volume dimension x\r\n  * @param {number} yDim - volume dimension x\r\n  * @param {number} zDim - volume dimension x\r\n  * @param {array} pixelsSrc - volume array of ARGB pixels (xDim * yDim * zDim)\r\n  * @param {number} sliceType - plane index. 0: x, 1: y, 2: z\r\n  * @param {number} sliceINdex - number of required slice\r\n  * @param {array} pixelsDst - result 2d image in ARGB format\r\n  */\r\n  static extract2dSliceFrom3dTexture(xDim, yDim, zDim, pixelsSrc, sliceType, sliceIndex, pixelsDst) {\r\n    const BYTES_IN_DWORD = 4;\r\n    const numPixVol = xDim * yDim * zDim;\r\n    if (numPixVol * BYTES_IN_DWORD !== pixelsSrc.length) {\r\n      console.log(`!!! wrong volume texture size: ${numPixVol}`);\r\n    }\r\n    const X_SLICE = 0;\r\n    const Y_SLICE = 1;\r\n    const Z_SLICE = 2;\r\n    const OFF_0 = 0;\r\n    const OFF_1 = 1;\r\n    const OFF_2 = 2;\r\n    const OFF_3 = 3;\r\n    const VAL255 = 255;\r\n    if (sliceType === X_SLICE) {\r\n      const x = sliceIndex;\r\n      console.log(`x slice is: ${x} from ${xDim}*${yDim}*${zDim} volume`);\r\n      const w = yDim;\r\n      const h = zDim;\r\n      let cx, cy;\r\n      let j = 0;\r\n      for (cy = 0; cy < h; cy++) {\r\n        const zOff = cy * xDim * yDim;\r\n        for (cx = 0; cx < w; cx++) {\r\n          const yOff = cx * xDim;\r\n          const off = zOff + yOff + x;\r\n          const off4 = off * BYTES_IN_DWORD;\r\n          pixelsDst[j + OFF_0] = pixelsSrc[off4 + OFF_0];\r\n          pixelsDst[j + OFF_1] = pixelsSrc[off4 + OFF_1];\r\n          pixelsDst[j + OFF_2] = pixelsSrc[off4 + OFF_2];\r\n          pixelsDst[j + OFF_3] = VAL255;\r\n          j += BYTES_IN_DWORD;\r\n        } // for (x)\r\n      } // for (y)\r\n    } // if x slice\r\n\r\n    if (sliceType === Y_SLICE) {\r\n      const y = sliceIndex;\r\n      const yOff = y * xDim;\r\n      console.log(`y slice is: ${y} from ${xDim}*${yDim}*${zDim} volume`);\r\n      const w = xDim;\r\n      const h = zDim;\r\n      let cx, cy;\r\n      let j = 0;\r\n      for (cy = 0; cy < h; cy++) {\r\n        const zOff = cy * xDim * yDim;\r\n        for (cx = 0; cx < w; cx++) {\r\n          const xOff = cx;\r\n          const off = zOff + yOff + xOff;\r\n          const off4 = off * BYTES_IN_DWORD;\r\n          pixelsDst[j + OFF_0] = pixelsSrc[off4 + OFF_0];\r\n          pixelsDst[j + OFF_1] = pixelsSrc[off4 + OFF_1];\r\n          pixelsDst[j + OFF_2] = pixelsSrc[off4 + OFF_2];\r\n          pixelsDst[j + OFF_3] = VAL255;\r\n          j += BYTES_IN_DWORD;\r\n        } // for (x)\r\n      } // for (y)\r\n    } // if x slice\r\n\r\n    if (sliceType === Z_SLICE) {\r\n      const z = sliceIndex;\r\n      console.log(`z slice is: ${z} from ${xDim}*${yDim}*${zDim} volume`);\r\n      const zOff = z * xDim * yDim;\r\n      const w = xDim;\r\n      const h = yDim;\r\n      let x, y;\r\n      let j = 0;\r\n      for (y = 0; y < h; y++) {\r\n        const yOff = y * xDim;\r\n        for (x = 0; x < w; x++) {\r\n          const off = zOff + yOff + x;\r\n          const off4 = off * BYTES_IN_DWORD;\r\n          pixelsDst[j + OFF_0] = pixelsSrc[off4 + OFF_0];\r\n          pixelsDst[j + OFF_1] = pixelsSrc[off4 + OFF_1];\r\n          pixelsDst[j + OFF_2] = pixelsSrc[off4 + OFF_2];\r\n          pixelsDst[j + OFF_3] = VAL255;\r\n          j += BYTES_IN_DWORD;\r\n        } // for (x)\r\n      } // for (y)\r\n    } // if z slice\r\n  } // end of extract2dSliceFrom3dTexture\r\n\r\n  /**\r\n  * Get 2d coordinate in tiled texture from original 3d coordinate\r\n  * @param {number} xDim - volume dimension x\r\n  * @param {number} yDim - volume dimension x\r\n  * @param {number} zDim - volume dimension x\r\n  * @param {number} tilesHor - number of tiles\r\n  * @param {number} fx - texture coordinate in 3d\r\n  * @param {number} fy - texture coordinate in 3d\r\n  * @param {number} fz - texture coordinate in 3d\r\n  * @param {object} vec2coord - output 2d coordinates\r\n  */\r\n  static get2dCoordFromTiled3dCoord(xDim, yDim, zDim, tilesHor, fx, fy, fz, vec2coord) {\r\n    const tileScale = 1.0 / tilesHor;\r\n    let x = fx * tileScale;\r\n    let y = fy * tileScale;\r\n    const zSliceIndex = Math.floor(fz * zDim);\r\n    // add tile x corner\r\n    x += (zSliceIndex % tilesHor) * tileScale;\r\n    // add tile y corner\r\n    y += Math.floor(zSliceIndex / tilesHor) * tileScale;\r\n    // add some 0.5 value\r\n    const xSize = xDim * tilesHor;\r\n    const ySize = yDim * tilesHor;\r\n    const HALF = 0.5;\r\n    x += HALF / xSize;\r\n    y += HALF / ySize;\r\n    // assign to destination 2d coords\r\n    vec2coord.x = x;\r\n    vec2coord.y = y;\r\n  }\r\n\r\n  /**\r\n  * Extract 2d texture from normal 3d array\r\n  * @param {number} xDim - volume dimension x\r\n  * @param {number} yDim - volume dimension x\r\n  * @param {number} zDim - volume dimension x\r\n  * @param {array} pixelsSrc - tiled 2d matrix of ARGB pixels, made from source 3d texture\r\n  * @param {number} sliceType - plane index. 0: x, 1: y, 2: z\r\n  * @param {number} sliceIndex - number of required slice\r\n  * @param {array} pixelsDst - result 2d image in ARGB format\r\n  * @param {number} isRoi - is palette should be applied to data or not\r\n  */\r\n  static extract2dSliceFromTiled3dTexture(xDim, yDim, zDim, pixelsSrc, sliceType, sliceIndex, pixelsDst, isRoi) {\r\n    const BYTES_IN_DWORD = 4;\r\n    //const zDimSqrt = Math.ceil(Math.sqrt(zDim));\r\n    const TWO = 2;\r\n    const ONE = 1;\r\n    const zDimSqrt = TWO ** (ONE + Math.floor(Math.log(Math.sqrt(zDim)) / Math.log(TWO)));\r\n    const lenSrc = pixelsSrc.length;\r\n    const xSize = xDim * zDimSqrt;\r\n    const ySize = yDim * zDimSqrt;\r\n    if (lenSrc !== xSize * ySize * BYTES_IN_DWORD) {\r\n      console.log(`Wrong 2d tiled vol size. Size = ${lenSrc}`);\r\n    }\r\n    const X_SLICE = 0;\r\n    const Y_SLICE = 1;\r\n    const Z_SLICE = 2;\r\n    const OFF_0 = 0;\r\n    const OFF_1 = 1;\r\n    const OFF_2 = 2;\r\n    const OFF_3 = 3;\r\n    const VAL255 = 255;\r\n    if (sliceType === X_SLICE) {\r\n      const fx = sliceIndex / xDim;\r\n      console.log(`extract2dSlice... fx = ${fx}`);\r\n      let cx, cy;\r\n      const w = yDim;\r\n      const h = zDim;\r\n      let j = 0;\r\n      for (cy = 0; cy < h; cy++) {\r\n        const fz = cy / h;\r\n        for (cx = 0; cx < w; cx++) {\r\n          const fy = cx / w;\r\n          const vec2coord = {\r\n            x: 0.0,\r\n            y: 0.0\r\n          };\r\n          VolumeTools.get2dCoordFromTiled3dCoord(xDim, yDim, zDim, zDimSqrt, fx, fy, fz, vec2coord);\r\n          const ux = Math.floor(vec2coord.x * xSize);\r\n          const uy = Math.floor(vec2coord.y * ySize);\r\n          const off = ux + uy * xSize;\r\n          const off4 = off * BYTES_IN_DWORD;\r\n          if (isRoi) {\r\n            pixelsDst[j + OFF_0] = pixelsSrc[off4 + OFF_0];\r\n            pixelsDst[j + OFF_1] = pixelsSrc[off4 + OFF_1];\r\n            pixelsDst[j + OFF_2] = pixelsSrc[off4 + OFF_2];\r\n            pixelsDst[j + OFF_3] = VAL255;\r\n          } else {\r\n            pixelsDst[j + OFF_0] = pixelsSrc[off4 + OFF_3];\r\n            pixelsDst[j + OFF_1] = pixelsSrc[off4 + OFF_3];\r\n            pixelsDst[j + OFF_2] = pixelsSrc[off4 + OFF_3];\r\n            pixelsDst[j + OFF_3] = VAL255;\r\n          }\r\n          j += BYTES_IN_DWORD;\r\n        }\r\n      }\r\n    } // if x slice\r\n    if (sliceType === Y_SLICE) {\r\n      const fy = sliceIndex / yDim;\r\n      console.log(`extract2dSlice... fy = ${fy}`);\r\n      let cx, cy;\r\n      const w = xDim;\r\n      const h = zDim;\r\n      let j = 0;\r\n      for (cy = 0; cy < h; cy++) {\r\n        const fz = cy / h;\r\n        for (cx = 0; cx < w; cx++) {\r\n          const fx = cx / w;\r\n          const vec2coord = {\r\n            x: 0.0,\r\n            y: 0.0\r\n          };\r\n          VolumeTools.get2dCoordFromTiled3dCoord(xDim, yDim, zDim, zDimSqrt, fx, fy, fz, vec2coord);\r\n          const ux = Math.floor(vec2coord.x * xSize);\r\n          const uy = Math.floor(vec2coord.y * ySize);\r\n          const off = ux + uy * xSize;\r\n          const off4 = off * BYTES_IN_DWORD;\r\n          if (isRoi) {\r\n            pixelsDst[j + OFF_0] = pixelsSrc[off4 + OFF_0];\r\n            pixelsDst[j + OFF_1] = pixelsSrc[off4 + OFF_1];\r\n            pixelsDst[j + OFF_2] = pixelsSrc[off4 + OFF_2];\r\n            pixelsDst[j + OFF_3] = VAL255;\r\n          } else {\r\n            pixelsDst[j + OFF_0] = pixelsSrc[off4 + OFF_3];\r\n            pixelsDst[j + OFF_1] = pixelsSrc[off4 + OFF_3];\r\n            pixelsDst[j + OFF_2] = pixelsSrc[off4 + OFF_3];\r\n            pixelsDst[j + OFF_3] = VAL255;\r\n          }\r\n          j += BYTES_IN_DWORD;\r\n        }\r\n      }\r\n    } // if y slice\r\n    if (sliceType === Z_SLICE) {\r\n      const fz = sliceIndex / zDim;\r\n      console.log(`extract2dSlice... fz = ${fz}. dim = ${xDim}*${yDim}*${zDim}. zDimSqrt = ${zDimSqrt}`);\r\n      let cx, cy;\r\n      const w = xDim;\r\n      const h = yDim;\r\n      let j = 0;\r\n      for (cy = 0; cy < h; cy++) {\r\n        const fy = cy / h;\r\n        for (cx = 0; cx < w; cx++) {\r\n          const fx = cx / w;\r\n          const vec2coord = {\r\n            x: 0.0,\r\n            y: 0.0\r\n          };\r\n          VolumeTools.get2dCoordFromTiled3dCoord(xDim, yDim, zDim, zDimSqrt, fx, fy, fz, vec2coord);\r\n          const ux = Math.floor(vec2coord.x * xSize);\r\n          const uy = Math.floor(vec2coord.y * ySize);\r\n          const off = ux + uy * xSize;\r\n          const off4 = off * BYTES_IN_DWORD;\r\n          if (isRoi) {\r\n            pixelsDst[j + OFF_0] = pixelsSrc[off4 + OFF_0];\r\n            pixelsDst[j + OFF_1] = pixelsSrc[off4 + OFF_1];\r\n            pixelsDst[j + OFF_2] = pixelsSrc[off4 + OFF_2];\r\n            pixelsDst[j + OFF_3] = VAL255;\r\n          } else {\r\n            pixelsDst[j + OFF_0] = pixelsSrc[off4 + OFF_3];\r\n            pixelsDst[j + OFF_1] = pixelsSrc[off4 + OFF_3];\r\n            pixelsDst[j + OFF_2] = pixelsSrc[off4 + OFF_3];\r\n            pixelsDst[j + OFF_3] = VAL255;\r\n          }\r\n          j += BYTES_IN_DWORD;\r\n        }\r\n      }\r\n    } // if z slice\r\n  }\r\n\r\n  /**\r\n  * Test int value: is this 2^N\r\n  * @param {number} val - tested value\r\n  * @return  {boolean} Is power of 2 or not\r\n  */\r\n  static isPowerOfTwo(val) {\r\n    const MAX_PWR = 31;\r\n    for (let i = 1; i < MAX_PWR; i++) {\r\n      const vpwr = 1 << i;\r\n      if (val === vpwr) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n  * Get closest power of 2: greater or equal then imput argument\r\n  * @param {number} val - tested value\r\n  * @return  {number} Closest (greater or equal) power of two\r\n  */\r\n  static getGreatOrEqualPowerOfTwo(val) {\r\n    const MAX_PWR = 31;\r\n    for (let i = 1; i < MAX_PWR; i++) {\r\n      const vpwr = 1 << i;\r\n      if (val === vpwr) {\r\n        return val;\r\n      }\r\n      const vpwrNext = 1 << (i + 1);\r\n      if ((val > vpwr) && (val < vpwrNext)) {\r\n        return vpwrNext;\r\n      }\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  /**\r\n  * Get closest power of 2: less or equal then imput argument\r\n  * @param {number} val - tested value\r\n  * @return  {number} Closest (less or equal) power of two\r\n  */\r\n  static getLessOrEqualPowerOfTwo(val) {\r\n    const MAX_PWR = 31;\r\n    for (let i = MAX_PWR; i > 0; i--) {\r\n      const vpwr = 1 << i;\r\n      if (val === vpwr) {\r\n        return val;\r\n      }\r\n      const vpwrLess = 1 << (i - 1);\r\n      if ((val > vpwrLess) && (val < vpwr)) {\r\n        return vpwrLess;\r\n      }\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  /**\r\n  * Make texture size equal to power of 2 for x, y dimensions\r\n  * @param {array} pixelsSrc - source volume pixels\r\n  * @param {number} xDimSrc - volume size on x\r\n  * @param {number} yDimSrc - volume size on y\r\n  * @param {number} zDimSrc - volume size on z\r\n  * @param {number} xDimDst - new x dimension\r\n  * @param {number} yDimDst - new y dimension\r\n  * @return {array} new array\r\n  */\r\n  static makeTextureSizePowerOfTwoUp(pixelsSrc, xDimSrc, yDimSrc, zDimSrc, xDimDst, yDimDst) {\r\n    const zDimDst = zDimSrc;\r\n    const HALF = 2;\r\n    if (xDimDst < xDimSrc) {\r\n      console.log(`Error: ${xDimDst} < ${xDimSrc}`);\r\n    }\r\n    if (yDimDst < yDimSrc) {\r\n      console.log(`Error: ${yDimDst} < ${yDimSrc}`);\r\n    }\r\n    const xShift =  Math.floor((xDimDst - xDimSrc) / HALF);\r\n    const yShift =  Math.floor((yDimDst - yDimSrc) / HALF);\r\n    const numPixelsSrc = xDimSrc * yDimSrc * zDimSrc;\r\n    const numBytesPerPixel = Math.floor(pixelsSrc.length / numPixelsSrc);\r\n    const FOUR = 4;\r\n    if ((numBytesPerPixel !== 1) && (numBytesPerPixel !== FOUR)) {\r\n      console.log(`Error source volume bpp:  = ${xDimSrc} * ${yDimSrc} * ${zDimSrc}, bpp = ${numBytesPerPixel}`);\r\n    }\r\n    const numPixelsDst = xDimDst * yDimDst * zDimDst * numBytesPerPixel;\r\n    const pixelsDst = new Uint8Array(numPixelsDst);\r\n    let i;\r\n    for (i = 0; i < numPixelsDst; i++) {\r\n      pixelsDst[i] = 0;\r\n    }\r\n    let offSrc = 0;\r\n    if (numBytesPerPixel === 1) {\r\n      for (let z = 0; z < zDimSrc; z++) {\r\n        const zOffDst = z * xDimDst * yDimDst;\r\n        for (let y = 0; y < yDimSrc; y++) {\r\n          const yOffDst = (y + yShift) * xDimDst;\r\n          let offDst = xShift + yOffDst + zOffDst;\r\n          for (let x = 0; x < xDimSrc; x++, offDst++) {\r\n            const val = pixelsSrc[offSrc];\r\n            pixelsDst[offDst] = val;\r\n            offSrc++;\r\n          } // for (x) source\r\n        } // for (y) source\r\n      } // for (z) source\r\n    } else if (numBytesPerPixel === FOUR) {\r\n      for (let z = 0; z < zDimSrc; z++) {\r\n        const zOffDst = z * xDimDst * yDimDst;\r\n        for (let y = 0; y < yDimSrc; y++) {\r\n          const yOffDst = (y + yShift) * xDimDst;\r\n          let offDst = xShift + yOffDst + zOffDst;\r\n          for (let x = 0; x < xDimSrc; x++, offDst++) {\r\n            let offSrc4 = offSrc + offSrc + offSrc + offSrc;\r\n            let offDst4 = offDst + offDst + offDst + offDst;\r\n            let val;\r\n\r\n            val = pixelsSrc[offSrc4];\r\n            pixelsDst[offDst4] = val;\r\n            offSrc4++;\r\n            offDst4++;\r\n\r\n            val = pixelsSrc[offSrc4];\r\n            pixelsDst[offDst4] = val;\r\n            offSrc4++;\r\n            offDst4++;\r\n\r\n            val = pixelsSrc[offSrc4];\r\n            pixelsDst[offDst4] = val;\r\n            offSrc4++;\r\n            offDst4++;\r\n\r\n            val = pixelsSrc[offSrc4];\r\n            pixelsDst[offDst4] = val;\r\n\r\n            offSrc++;\r\n          } // for (x) source\r\n        } // for (y) source\r\n      } // for (z) source\r\n    }\r\n    return pixelsDst;\r\n  } // end of makeTextureSizePowerOfTwoUp\r\n\r\n  /**\r\n   *\r\n  * Make texture size equal to power of 2 for x, y dimensions\r\n  * @param {array} pixelsSrc - source volume pixels\r\n  * @param {number} xDimSrc - volume size on x\r\n  * @param {number} yDimSrc - volume size on y\r\n  * @param {number} zDimSrc - volume size on z\r\n  * @param {number} xDimDst - new x dimension\r\n  * @param {number} yDimDst - new y dimension\r\n  * @return {array} new array\r\n  */\r\n  static makeTextureSizePowerOfTwoDown(pixelsSrc, xDimSrc, yDimSrc, zDimSrc, xDimDst, yDimDst) {\r\n    const zDimDst = zDimSrc;\r\n    if (xDimDst >= xDimSrc) {\r\n      console.log(`Error: ${xDimDst} >= ${xDimSrc}`);\r\n    }\r\n    if (yDimDst >= yDimSrc) {\r\n      console.log(`Error: ${yDimDst} >= ${yDimSrc}`);\r\n    }\r\n    const xScale = xDimSrc / xDimDst;\r\n    const yScale = yDimSrc / yDimDst;\r\n    const numPixelsSrc = xDimSrc * yDimSrc * zDimSrc;\r\n    const numBytesPerPixel = Math.floor(pixelsSrc.length / numPixelsSrc);\r\n    const FOUR = 4;\r\n    if ((numBytesPerPixel !== 1) && (numBytesPerPixel !== FOUR)) {\r\n      console.log(`Error source volume bpp:  = ${xDimSrc} * ${yDimSrc} * ${zDimSrc}, bpp = ${numBytesPerPixel}`);\r\n    }\r\n    const numPixelsDst = xDimDst * yDimDst * zDimDst * numBytesPerPixel;\r\n    const pixelsDst = new Uint8Array(numPixelsDst);\r\n    let i;\r\n    for (i = 0; i < numPixelsDst; i++) {\r\n      pixelsDst[i] = 0;\r\n    }\r\n    let offDst = 0;\r\n    if (numBytesPerPixel === 1) {\r\n      for (let z = 0; z < zDimDst; z++) {\r\n        const zOffSrc = z * xDimSrc * yDimSrc;\r\n        for (let y = 0; y < yDimDst; y++) {\r\n\r\n          const ySrcMin = Math.floor((y + 0) * yScale);\r\n          const ySrcMax = Math.floor((y + 1) * yScale);\r\n\r\n          for (let x = 0; x < xDimDst; x++) {\r\n\r\n            const xSrcMin = Math.floor((x + 0) * xScale);\r\n            const xSrcMax = Math.floor((x + 1) * xScale);\r\n\r\n            let val = 0; let numPix = 0;\r\n            for (let ySrc = ySrcMin; ySrc < ySrcMax; ySrc++) {\r\n              for (let xSrc = xSrcMin; xSrc < xSrcMax; xSrc++) {\r\n                const offSrc = zOffSrc + (ySrc * xDimSrc) + xSrc;\r\n                val += pixelsSrc[offSrc];\r\n                numPix++;\r\n              }   // for xSrc\r\n            }     // for ySrc\r\n            val /= numPix;\r\n            pixelsDst[offDst] = val;\r\n            offDst++;\r\n          } // for (x) source\r\n        } // for (y) source\r\n      } // for (z) source\r\n    } else if (numBytesPerPixel === FOUR) {\r\n      for (let z = 0; z < zDimDst; z++) {\r\n        const zOffSrc = z * xDimSrc * yDimSrc;\r\n        for (let y = 0; y < yDimDst; y++) {\r\n\r\n          const ySrcMin = Math.floor((y + 0) * yScale);\r\n          const ySrcMax = Math.floor((y + 1) * yScale);\r\n\r\n          for (let x = 0; x < xDimDst; x++, offDst++) {\r\n\r\n            const xSrcMin = Math.floor((x + 0) * xScale);\r\n            const xSrcMax = Math.floor((x + 1) * xScale);\r\n\r\n            let valA = 0; let valR = 0;\r\n            let valG = 0; let valB = 0;\r\n            let numPix = 0;\r\n\r\n            for (let ySrc = ySrcMin; ySrc < ySrcMax; ySrc++) {\r\n              for (let xSrc = xSrcMin; xSrc < xSrcMax; xSrc++) {\r\n                let offSrc = (zOffSrc + (ySrc * xDimSrc) + xSrc) * FOUR;\r\n                valB += pixelsSrc[offSrc]; offSrc++;\r\n                valG += pixelsSrc[offSrc]; offSrc++;\r\n                valR += pixelsSrc[offSrc]; offSrc++;\r\n                valA += pixelsSrc[offSrc];\r\n                numPix++;\r\n              }   // for xSrc\r\n            }     // for ySrc\r\n            valB /= numPix;\r\n            valG /= numPix;\r\n            valR /= numPix;\r\n            valA /= numPix;\r\n            pixelsDst[offDst] = valB;\r\n            offDst++;\r\n            pixelsDst[offDst] = valG;\r\n            offDst++;\r\n            pixelsDst[offDst] = valR;\r\n            offDst++;\r\n            pixelsDst[offDst] = valA;\r\n            offDst++;\r\n\r\n          } // for (x) source\r\n        } // for (y) source\r\n      } // for (z) source\r\n    }\r\n    return pixelsDst;\r\n\r\n    /*\r\n    let offDst = 0;\r\n    for (let z = 0; z < zDimDst; z++) {\r\n      const zSrcMin = (z + 0) * zScale;\r\n      const zSrcMax = (z + 1) * zScale;\r\n      for (let y = 0; y < yDimDst; y++) {\r\n        const ySrcMin = (y + 0) * yScale;\r\n        const ySrcMax = (y + 1) * yScale;\r\n        for (let x = 0; x < xDimDst; x++) {\r\n          const xSrcMin = (x + 0) * xScale;\r\n          const xSrcMax = (x + 1) * xScale;\r\n\r\n          // get ave value\r\n          let valAve = 0;\r\n          let numPixelsAve = 0;\r\n\r\n          for (let zz = zSrcMin; zz < zSrcMax; zz++) {\r\n            const zOff = zz * xDimSrc * yDimSrc;\r\n            for (let yy = ySrcMin; yy < ySrcMax; yy++) {\r\n              const yOff = yy * xDimSrc;\r\n              for (let xx = xSrcMin; xx < xSrcMax; xx++) {\r\n                const offSrc = xx + yOff + zOff;\r\n                const val = pixelsSrc[offSrc];\r\n                valAve += val;\r\n                numPixelsAve++;\r\n              }   // for (xx)\r\n            }     // for (yy)\r\n          }       // for (zz)\r\n          valAve /= numPixelsAve;\r\n          pixelsDst[offDst++] = Math.floor(valAve);\r\n        } // for (x)\r\n      } // for (y)\r\n    } // for (z)\r\n    */\r\n  }\r\n\r\n  /**\r\n  * Scan volume for non-empty box (with non-zero voxels)\r\n  * fill resul in [0..1] range. Use 8 as \"black\" color barrier\r\n  * @param {array} pixelsSrc - source volume pixels\r\n  * @param {number} xDim - volume size on x\r\n  * @param {number} yDim - volume size on y\r\n  * @param {number} zDim - volume size on z\r\n  * @param {number} boxMin - Object (x,y,z) with minumim non-empty box coords\r\n  * @param {number} boxMax - Object (x,y,z) with maximum non-empty box coords\r\n  */\r\n  static detectNonEmptyBox(pixelsSrc, xDim, yDim, zDim, boxMin, boxMax) {\r\n    const MIN_VAL_BARRIER = 8;\r\n    const TWICE = 2;\r\n    const FOUR = 4;\r\n    const xyDim = xDim * yDim;\r\n    const xDimHalf = Math.floor(xDim / TWICE);\r\n    const yDimHalf = Math.floor(yDim / TWICE);\r\n    const zDimHalf = Math.floor(zDim / TWICE);\r\n    let x, y, z;\r\n    let isEmpty;\r\n\r\n    let xBorderMin = 0;\r\n    let yBorderMin = 0;\r\n    let zBorderMin = 0;\r\n    let xBorderMax = 0;\r\n    let yBorderMax = 0;\r\n    let zBorderMax = 0;\r\n\r\n    const numBytesPerPixel = Math.floor(pixelsSrc.length / (xDim * yDim * zDim));\r\n    if (numBytesPerPixel === 1) {\r\n      isEmpty = true;\r\n      for (x = 0; (x < xDimHalf) && isEmpty; x++) {\r\n        // check is empty plane\r\n        for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      xBorderMin = x;\r\n\r\n      isEmpty = true;\r\n      for (x = xDim - 1; (x > xDimHalf) && (isEmpty); x--) {\r\n        // check is empty plane\r\n        for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      xBorderMax = x;\r\n\r\n      isEmpty = true;\r\n      for (y = 0; (y < yDimHalf) && (isEmpty); y++) {\r\n        // check is empty plane\r\n        for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      yBorderMin = y;\r\n\r\n      isEmpty = true;\r\n      for (y = yDim - 1; (y > yDimHalf) && (isEmpty); y--) {\r\n        // check is empty plane\r\n        for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      yBorderMax = y;\r\n\r\n      isEmpty = true;\r\n      for (z = 0; (z < zDimHalf) && (isEmpty); z++) {\r\n        // check is empty plane\r\n        for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n          for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      zBorderMin = z;\r\n\r\n      isEmpty = true;\r\n      for (z = zDim - 1; (z > zDimHalf) && (isEmpty); z--) {\r\n        // check is empty plane\r\n        for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n          for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      zBorderMax = z;\r\n    } else if (numBytesPerPixel === FOUR) {\r\n      // 4 bpp image scan\r\n      const OFF_3 = 3;\r\n      isEmpty = true;\r\n      for (x = 0; (x < xDimHalf) && isEmpty; x++) {\r\n        // check is empty plane\r\n        for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off * FOUR + OFF_3] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      xBorderMin = x;\r\n\r\n      isEmpty = true;\r\n      for (x = xDim - 1; (x > xDimHalf) && (isEmpty); x--) {\r\n        // check is empty plane\r\n        for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off * FOUR + OFF_3] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      xBorderMax = x;\r\n\r\n      isEmpty = true;\r\n      for (y = 0; (y < yDimHalf) && (isEmpty); y++) {\r\n        // check is empty plane\r\n        for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off * FOUR + OFF_3] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      yBorderMin = y;\r\n\r\n      isEmpty = true;\r\n      for (y = yDim - 1; (y > yDimHalf) && (isEmpty); y--) {\r\n        // check is empty plane\r\n        for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n          for (z = 0; (z < zDim) && (isEmpty); z++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off * FOUR + OFF_3] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      yBorderMax = y;\r\n\r\n      isEmpty = true;\r\n      for (z = 0; (z < zDimHalf) && (isEmpty); z++) {\r\n        // check is empty plane\r\n        for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n          for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off * FOUR + OFF_3] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      zBorderMin = z;\r\n\r\n      isEmpty = true;\r\n      for (z = zDim - 1; (z > zDimHalf) && (isEmpty); z--) {\r\n        // check is empty plane\r\n        for (x = 0; (x < xDim) && (isEmpty); x++) {\r\n          for (y = 0; (y < yDim) && (isEmpty); y++) {\r\n            const off = (z * xyDim) + (y * xDim) + x;\r\n            if (pixelsSrc[off * FOUR + OFF_3] > MIN_VAL_BARRIER) {\r\n              isEmpty = false;\r\n            }\r\n          } // for (z)\r\n        } // for (y()\r\n      } // for (x)\r\n      zBorderMax = z;\r\n    }\r\n    boxMin.x = xBorderMin / xDim;\r\n    boxMin.y = yBorderMin / yDim;\r\n    boxMin.z = zBorderMin / zDim;\r\n    boxMax.x = xBorderMax / xDim;\r\n    boxMax.y = yBorderMax / yDim;\r\n    boxMax.z = zBorderMax / zDim;\r\n  }\r\n\r\n} // class VolumeTools\r\n\r\nVolumeTools.VOLTOOLS_ERROR_OK = 1;\r\nVolumeTools.VOLTOOLS_ERROR_BAD_MULTIPLIER = -1;\r\nVolumeTools.VOLTOOLS_ERROR_BAD_DIMENSION = -2;\r\nVolumeTools.VOLTOOLS_ERROR_BAD_ARRAY = -3;\r\nVolumeTools.VOLTOOLS_ERROR_BAD_NUMBER = -4;\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Active volume algorithm implementation\r\n* @module lib/scripts/actvolume/actvol\r\n*/\r\n\r\n// absolute imports\r\nimport * as THREE from 'three';\r\n\r\n// relative imports\r\nimport TetrahedronGenerator from './tetra';\r\nimport GeoRender from './georender';\r\nimport LaplasianSmoother from './lapsmooth';\r\n// import VolumeClipper from './volclip';\r\nimport VolumeGenerator from './volgen';\r\n// import KtxLoader from '../loaders/ktxloader';\r\nimport VolumeTools from '../loaders/voltools';\r\n\r\n// ****************************************************************************\r\n// Const\r\n// ****************************************************************************\r\n\r\n// Minimum volume size (for volume scale down: increase performance)\r\nconst X_MAX_DIM = 256;\r\nconst Y_MAX_DIM = 256;\r\nconst Z_MAX_DIM = 256;\r\n\r\nconst AV_NUM_COLORS = 256;\r\n\r\nconst AV_STATE_NA = -1;\r\nconst AV_STATE_NOT_STARTED = 0;\r\nconst AV_STATE_PREPARE_GAUSS = 1;\r\nconst AV_STATE_PREPARE_UNIFORMITY = 2;\r\nconst AV_STATE_UPDATE_GEO = 3;\r\nconst AV_STATE_FINISHED = 4;\r\n\r\nconst AV_METHOD_NORMALS = 1;\r\nconst AV_METHOD_UNIFORMITY = 2;\r\nconst AV_METHOD_COLOR_KOEFS = 4;\r\nconst AV_METHOD_ALL = 0xffff;\r\n\r\n// ****************************************************************************\r\n// Class\r\n// ****************************************************************************\r\n\r\n/**\r\n* Class ActiveVolume perform skull detection and removal\r\n* @class ActiveVolume\r\n*/\r\nexport default class ActiveVolume {\r\n  /**\r\n  * Init all internal data\r\n  * @constructs ActiveVolume\r\n  */\r\n  constructor() {\r\n    this.m_state = AV_STATE_NA;\r\n    this.m_pixelsSrc = null;\r\n    this.m_xDim = 0;\r\n    this.m_yDim = 0;\r\n    this.m_zDim = 0;\r\n    this.m_xWorldBox = 0;\r\n    this.m_yWorldBox = 0;\r\n    this.m_zWorldBox = 0;\r\n    this.m_imageGauss = null;\r\n    this.m_imageUniformity = null;\r\n    this.m_verticesNew = null;\r\n    this.m_lapSmoother = null;\r\n    this.m_imageSrc = null;\r\n    this.m_imageGrad = null;\r\n    this.m_gaussStage = -1;\r\n    this.m_uniformityStage = -1;\r\n    this.m_geoStage = -1;\r\n    this.m_histogram = new Int32Array(AV_NUM_COLORS);\r\n    this.m_colorProbability = new Float32Array(AV_NUM_COLORS);\r\n    this.m_colorKoefs = new Float32Array(AV_NUM_COLORS);\r\n    for (let i = 0; i < AV_NUM_COLORS; i++) {\r\n      this.m_histogram[i] = 0;\r\n      this.m_colorProbability[i] = 0.0;\r\n      this.m_colorKoefs[i] = 0.0;\r\n    }\r\n    this.m_sphereCenter = null;\r\n    this.m_sphereRadius = null;\r\n    this.m_indexMinColor = -1;\r\n    // debug counter to save geo\r\n    this.m_updateCounter = 0;\r\n    // for display 3d geo\r\n    this.m_geoRender = null;\r\n    this.m_wasAllocated = false;\r\n    this.m_xScale = 1;\r\n    this.m_yScale = 1;\r\n    this.m_zScale = 1;\r\n  }\r\n\r\n  /**\r\n  *\r\n  * Set initial sphere center\r\n  */\r\n  setSphereCenter(xCenter, yCenter, zCenter) {\r\n    this.m_sphereCenter = new THREE.Vector3();\r\n    this.m_sphereCenter.set(xCenter, yCenter, zCenter);\r\n    // console.log(`ActiveVolume. set sphere center = ${xCenter}, ${yCenter}, ${zCenter}`);\r\n  }\r\n\r\n  /**\r\n  *\r\n  * Set initial sphere radius\r\n  */\r\n  setSphereRadius(xRadius, yRadius, zRadius) {\r\n    this.m_sphereRadius = new THREE.Vector3();\r\n    this.m_sphereRadius.set(xRadius, yRadius, zRadius);\r\n    // console.log(`ActiveVolume. set sphere radius = ${xRadius}, ${yRadius}, ${zRadius}`);\r\n  }\r\n\r\n  /**\r\n  *\r\n  * Get sphere center\r\n  */\r\n  getSphereCenter() {\r\n    return this.m_sphereCenter;\r\n  }\r\n\r\n  /**\r\n  *\r\n  * Get sphere radius\r\n  */\r\n  getSphereRadius() {\r\n    return this.m_sphereRadius;\r\n  }\r\n\r\n  /**\r\n  *\r\n  * Set physical volume dimensions\r\n  * @param {number} xWorldBox world box size on x\r\n  * @param {number} yWorldBox world box size on y\r\n  * @param {number} zWorldBox world box size on z\r\n  */\r\n  setupPhysDims(xWorldBox, yWorldBox, zWorldBox) {\r\n    this.m_xWorldBox = xWorldBox;\r\n    this.m_yWorldBox = yWorldBox;\r\n    this.m_zWorldBox = zWorldBox;\r\n    // console.log(`setupPhysDims: ${xWorldBox} * ${yWorldBox} * ${zWorldBox}`);\r\n  }\r\n\r\n  copyScaleUp(pixelsDst, xDimDst, yDimDst, zDimDst) {\r\n    console.log('perform scale up generated mask ...');\r\n    if (this.m_xScale === 1) {\r\n      console.log('ActiveVolume. copyScaleUp. should be scaled');\r\n      return;\r\n    }\r\n    const xScale = this.m_xDim / xDimDst;\r\n    const yScale = this.m_yDim / yDimDst;\r\n    const zScale = this.m_zDim / zDimDst;\r\n    let offDst = 0;\r\n    for (let z = 0; z < zDimDst; z++) {\r\n      const zSrc = Math.floor(z * zScale);\r\n      const zSrcOff = zSrc * this.m_xDim * this.m_yDim;\r\n      for (let y = 0; y < yDimDst; y++) {\r\n        const ySrc = Math.floor(y * yScale);\r\n        const ySrcOff = ySrc * this.m_xDim;\r\n        for (let x = 0; x < xDimDst; x++) {\r\n          const xSrc = Math.floor(x * xScale);\r\n          const offSrc = xSrc + ySrcOff + zSrcOff;\r\n          const val = this.m_pixelsSrc[offSrc];\r\n          pixelsDst[offDst] = val;\r\n          offDst++;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  save() {\r\n    const numPixels = this.m_xDim * this.m_yDim * this.m_zDim;\r\n    let volTexDst = new Uint8Array(numPixels);\r\n    // create clipped volume\r\n\r\n    let i;\r\n    // const resClip = VolumeClipper.clipVolumeByNonConvexGeo(this.m_pixelsSrc, this.m_xDim, this.m_yDim, this.m_zDim,\r\n    //   volTexDst, this.m_geoRender, ActiveVolume.REMOVE_SKULL);\r\n    for (i = 0; i < numPixels; i++) {\r\n      volTexDst[i] = 0;\r\n    }\r\n    const WITH_FILL = true;\r\n    const resBoolFill = VolumeGenerator.generateFromFaces(this.m_xDim, this.m_yDim, this.m_zDim,\r\n      volTexDst, this.m_geoRender, WITH_FILL);\r\n\r\n    if (resBoolFill) {\r\n      console.log('perform clip of source volume by generated mask ...');\r\n      const DECREASE_NON_VIS = 6;\r\n      for (i = 0; i < numPixels; i++) {\r\n        if (volTexDst[i] === 0) {\r\n          this.m_pixelsSrc[i] = Math.floor(this.m_pixelsSrc[i] / DECREASE_NON_VIS);\r\n          // this.m_pixelsSrc[i] = volTexDst[i];\r\n        }\r\n      }\r\n    } else {\r\n      console.log(`generateFromFaces returned ${resBoolFill} !`);\r\n    }\r\n    volTexDst = null;\r\n  }\r\n\r\n  /**\r\n  *\r\n  * Create internal structures: render sphere\r\n  */\r\n  createGeoSphere() {\r\n    if (this.m_xDim === 0) {\r\n      const ERR_NO_VOLUME = -1;\r\n      return ERR_NO_VOLUME;\r\n    }\r\n    if (this.m_sphereRadius === null) {\r\n      const ERR_NO_SPHERE = -2;\r\n      return ERR_NO_SPHERE;\r\n    }\r\n\r\n    const genTetra = new TetrahedronGenerator();\r\n    const vRadius = new THREE.Vector3(0.5, 0.5, 0.5);\r\n    const NUM_SUBDIVIDES = 3;\r\n    const okCreateTetra = genTetra.create(vRadius, NUM_SUBDIVIDES);\r\n    if (okCreateTetra < 1) {\r\n      return okCreateTetra;\r\n    }\r\n    const geoRender = new GeoRender();\r\n    const errGeo = geoRender.createFromTetrahedronGenerator(genTetra);\r\n    const GEO_OK = 1;\r\n    if (errGeo !== GEO_OK) {\r\n      const ERR_CREATE_GEO = -3;\r\n      return ERR_CREATE_GEO;\r\n    }\r\n\r\n    // scale geo render vertices to fit initial sphere\r\n    const numVertices = geoRender.getNumVertices();\r\n    const vertices = geoRender.getVertices();\r\n    const COORDS_IN_VERTEX = 4;\r\n    const NUM_0 = 0;\r\n    const NUM_1 = 1;\r\n    const NUM_2 = 2;\r\n    const HALF = 0.5;\r\n    const xScale = (this.m_sphereRadius.x / this.m_xScale) / HALF;\r\n    const yScale = (this.m_sphereRadius.y / this.m_yScale) / HALF;\r\n    const zScale = (this.m_sphereRadius.z / this.m_zScale) / HALF;\r\n\r\n    for (let i = 0, i4 = 0; i < numVertices; i++, i4 += COORDS_IN_VERTEX) {\r\n      vertices[i4 + NUM_0] = (this.m_sphereCenter.x / this.m_xScale) + vertices[i4 + NUM_0] * xScale;\r\n      vertices[i4 + NUM_1] = (this.m_sphereCenter.y / this.m_yScale) + vertices[i4 + NUM_1] * yScale;\r\n      vertices[i4 + NUM_2] = (this.m_sphereCenter.z / this.m_zScale) + vertices[i4 + NUM_2] * zScale;\r\n    } // for (i) all vertices\r\n    // save render geo to obj file\r\n    const NEED_SAVE_INITIAL_GEO = false;\r\n    if (NEED_SAVE_INITIAL_GEO) {\r\n      const TEST_SAVE_INIT_GEO_FILE_NAME = 'geo_init.obj';\r\n      geoRender.saveGeoToObjFile(TEST_SAVE_INIT_GEO_FILE_NAME);\r\n    }\r\n\r\n    // Test save bounding sphere\r\n    const NEED_SAVE_BOUND_SPHERE = false;\r\n    if (NEED_SAVE_BOUND_SPHERE) {\r\n      const vMin = new THREE.Vector3();\r\n      const vMax = new THREE.Vector3();\r\n      ActiveVolume.getBoundingBox(this.m_xDim, this.m_yDim, this.m_zDim, this.m_pixelsSrc, vMin, vMax);\r\n      const geoSphere = new GeoRender();\r\n      const vCenter = new THREE.Vector3();\r\n      const vRad = new THREE.Vector3();\r\n      vCenter.x = (vMin.x + vMax.x) * 0.5;\r\n      vCenter.y = (vMin.y + vMax.y) * 0.5;\r\n      vCenter.z = (vMin.z + vMax.z) * 0.5;\r\n      vRad.x = (vMax.x - vMin.x) * 0.5;\r\n      vRad.y = (vMax.y - vMin.y) * 0.5;\r\n      vRad.z = (vMax.z - vMin.z) * 0.5;\r\n\r\n      const NUM_SEGM_HOR = 16;\r\n      const NUM_SEGM_VER = 8;\r\n      geoSphere.createFromEllipse(vCenter, vRad, NUM_SEGM_HOR, NUM_SEGM_VER);\r\n      const TEST_SAVE_BSPHERE_GEO_FILE_NAME = 'geo_bsph.obj';\r\n      geoSphere.saveGeoToObjFile(TEST_SAVE_BSPHERE_GEO_FILE_NAME);\r\n    }\r\n    this.m_geoRender = geoRender;\r\n    return 1;\r\n  }\r\n\r\n  /**\r\n  *\r\n  * Create THREE js geometry (can be rendered in 3d scene)\r\n  * from current sphere\r\n  */\r\n  createThreeJsGeoFromSphere() {\r\n    const geoSrc = this.m_geoRender;\r\n    if (geoSrc === null) {\r\n      console.log('createThreeJsGeoFromSphere. logic error: call createGeoSphere() first');\r\n      return null;\r\n    }\r\n    const xScale = 1.0 / this.m_xDim;\r\n    const yScale = 1.0 / this.m_yDim;\r\n    const zScale = 1.0 / this.m_zDim;\r\n    const verticesSrc = geoSrc.getVertices();\r\n    const geoDst = new THREE.Geometry();\r\n    const COORDS_IN_VERTEX = 4;\r\n    const OFF_X = 0;\r\n    const OFF_Y = 1;\r\n    const OFF_Z = 2;\r\n    const HALF = 0.5;\r\n    // push vertices\r\n    for (let i = 0, i4 = 0; i < geoSrc.m_numVertices; i++, i4 += COORDS_IN_VERTEX) {\r\n      const x = verticesSrc[i4 + OFF_X] * xScale - HALF;\r\n      const y = verticesSrc[i4 + OFF_Y] * yScale - HALF;\r\n      const z = verticesSrc[i4 + OFF_Z] * zScale - HALF;\r\n      const vNew = new THREE.Vector3(x, y, z);\r\n      geoDst.vertices.push(vNew);\r\n    }\r\n    // push faces\r\n    const INDICES_IN_TRI = 3;\r\n    const OFF_0 = 0;\r\n    const OFF_1 = 1;\r\n    const OFF_2 = 2;\r\n    for (let i = 0, i3 = 0; i < geoSrc.m_numTriangles; i++, i3 += INDICES_IN_TRI) {\r\n      const i0 = geoSrc.m_indices[i3 + OFF_0];\r\n      const i1 = geoSrc.m_indices[i3 + OFF_1];\r\n      const i2 = geoSrc.m_indices[i3 + OFF_2];\r\n      const faceNew = new THREE.Face3(i0, i1, i2);\r\n      geoDst.faces.push(faceNew);\r\n    }\r\n    // calc bound box\r\n    geoDst.computeBoundingSphere();\r\n    return geoDst;\r\n  }\r\n\r\n  /**\r\n   *  Clip volume by geometry sphere\r\n   *\r\n   */\r\n  clipVolumeBySphere(xDim, yDim, zDim,\r\n    volTexSrc, volTexDst,\r\n    geoSphere, box) {\r\n    // check args\r\n    if (volTexDst === null) {\r\n      console.log('`clipVolumeBySphere. volTexDst == null');\r\n      return;\r\n    }\r\n    let sideMax = (box.x > box.y) ? box.x : box.y;\r\n    sideMax = (box.z > sideMax) ? box.z : sideMax;\r\n    const vBoxVirtX = box.x / sideMax;\r\n    const vBoxVirtY = box.y / sideMax;\r\n    const vBoxVirtZ = box.z / sideMax;\r\n\r\n    // create usual geometry from buffered geometry\r\n    const geoRender = new GeoRender();\r\n    geoRender.fromBufferGeometry(geoSphere);\r\n\r\n    // scale vertices from [-0.5 .. +0.5] to [0 .. xDim], [0 .. yDim], [0 .. zDim]\r\n    const numVerts = geoRender.getNumVertices();\r\n    const vertices = geoRender.getVertices(); // float array\r\n    // console.log(`scale vertices. numVerts = ${numVerts}`);\r\n\r\n    const HALF = 0.5;\r\n    const NUM_4 = 4;\r\n    const OFF_0 = 0;\r\n    const OFF_1 = 1;\r\n    const OFF_2 = 2;\r\n    let ind = 0;\r\n    for (let i = 0; i < numVerts; i++, ind += NUM_4) {\r\n      const x = -vertices[ind + OFF_0] / vBoxVirtX;\r\n      const y = vertices[ind + OFF_1] / vBoxVirtY;\r\n      const z = vertices[ind + OFF_2] / vBoxVirtZ;\r\n      const xVol = Math.floor((x + HALF) * xDim);\r\n      const yVol = Math.floor((y + HALF) * yDim);\r\n      const zVol = Math.floor((z + HALF) * zDim);\r\n      vertices[ind + OFF_0] = xVol;\r\n      vertices[ind + OFF_1] = yVol;\r\n      vertices[ind + OFF_2] = zVol;\r\n    } // for (i) all vertices\r\n    const xyzDim = xDim * yDim * zDim;\r\n    // create mask array\r\n    const volMask = new Uint8Array(xyzDim);\r\n    for (let i = 0; i < xyzDim; i++) {\r\n      volMask[i] = 0;\r\n    }\r\n\r\n    // Create mask from geometry\r\n    const WITH_FILL = 1;\r\n    const resFill = VolumeGenerator.generateFromFaces(xDim, yDim, zDim,\r\n      volMask,\r\n      geoRender,\r\n      WITH_FILL);\r\n    if (resFill < 0) {\r\n      console.log(`ActVol. generateFromFaces returned ${resFill} !`);\r\n    }\r\n    // apply  volMask to volSrc\r\n    for (let i = 0; i < xyzDim; i++) {\r\n      volTexDst[i] = (volMask[i] !== 0) ? volTexSrc[i] : 0;\r\n    }\r\n  } // clipVolumeBySphere\r\n\r\n  /**\r\n   *  Automatic sphere evolve\r\n   *\r\n   */\r\n  sphereEvolve(xDim, yDim, zDim,\r\n    volTexSrc, volTexDst,\r\n    geoSphere, valBarrier01,\r\n    modeEvolve, sphereCenter, box) {\r\n    let sideMax = (box.x > box.y) ? box.x : box.y;\r\n    sideMax = (box.z > sideMax) ? box.z : sideMax;\r\n    const vBoxVirtX = box.x / sideMax;\r\n    const vBoxVirtY = box.y / sideMax;\r\n    const vBoxVirtZ = box.z / sideMax;\r\n    const TEX_MIN_SIDE = 8;\r\n    if ((xDim < TEX_MIN_SIDE) || (yDim < TEX_MIN_SIDE) || (zDim < TEX_MIN_SIDE)) {\r\n      console.log(`sphereEvolve: too small vol dim = ${xDim} * ${yDim} * ${zDim}`);\r\n      return false;\r\n    }\r\n    const TEX_MAX_SIDE = 4095;\r\n    if ((xDim > TEX_MAX_SIDE) || (yDim > TEX_MAX_SIDE) || (zDim > TEX_MAX_SIDE)) {\r\n      console.log(`sphereEvolve: too large vol dim = ${xDim} * ${yDim} * ${zDim}`);\r\n      return false;\r\n    }\r\n    if (typeof volTexSrc !== 'object') {\r\n      console.log(`sphereEvolve: bad source vol type = ${typeof volTexSrc}`);\r\n      return false;\r\n    }\r\n    const xyzDim = xDim * yDim * zDim;\r\n    if (volTexSrc.length !== xyzDim) {\r\n      console.log(`sphereEvolve: bad src vol size = ${volTexSrc.length}, but expect = ${xyzDim}`);\r\n      return false;\r\n    }\r\n    if (volTexDst !== null) {\r\n      if (typeof volTexDst !== 'object') {\r\n        console.log(`sphereEvolve: bad dest vol type = ${typeof volTexDst}`);\r\n        return false;\r\n      }\r\n      if (volTexDst.length !== xyzDim) {\r\n        console.log(`sphereEvolve: bad dst vol size = ${volTexDst.length}, but expect = ${xyzDim}`);\r\n        return false;\r\n      }\r\n    }\r\n    if (typeof geoSphere !== 'object') {\r\n      console.log(`sphereEvolve: bad sphere type = ${typeof geoSphere}`);\r\n      return false;\r\n    }\r\n    if (!('getAttribute' in geoSphere)) {\r\n      console.log('geoSphere has no getAttribute method');\r\n      return false;\r\n    }\r\n    const attrVertices = geoSphere.getAttribute('position');\r\n    // const attrWireVertices = geoSphere.getAttribute('position');\r\n\r\n    if (typeof attrVertices === 'undefined') {\r\n      console.log('geoSphere has no position attr');\r\n      return false;\r\n    }\r\n    const numVertices = attrVertices.count;\r\n    const MIN_NUM_VERTS = 16;\r\n    const MAX_NUM_VERTS = 4095;\r\n    if ((numVertices < MIN_NUM_VERTS) | (numVertices > MAX_NUM_VERTS)) {\r\n      console.log(`sphereEvolve: bad num vertices in pshere geo = ${numVertices}`);\r\n      return false;\r\n    }\r\n    console.log(`sphereEvolve: num vertices in sphere geo = ${numVertices}`);\r\n    const numCompsVert = attrVertices.itemSize;\r\n    const NUM_COMPS_IN_VERTEX = 3;\r\n    if (numCompsVert !== NUM_COMPS_IN_VERTEX) {\r\n      console.log(`sphereEvolve: bad vertices num components = ${numCompsVert} `);\r\n    }\r\n\r\n    const attrNormals = geoSphere.getAttribute('normal');\r\n    if (typeof attrNormals === 'undefined') {\r\n      console.log('geoSphere has no normal attr');\r\n      return false;\r\n    }\r\n    const numNormals = attrNormals.count;\r\n    if (numNormals !== numVertices) {\r\n      console.log(`sphereEvolve: num vertices ${numVertices} != num normals ${numNormals}`);\r\n      return false;\r\n    }\r\n    const numCompsNorm = attrNormals.itemSize;\r\n    const NUM_COMPS_IN_NORMAT = 3;\r\n    if (numCompsNorm !== NUM_COMPS_IN_NORMAT) {\r\n      console.log(`sphereEvolve: bad normals num components =  ${numCompsNorm} `);\r\n    }\r\n    // center of vol\r\n    const HALF = 0.5;\r\n    const xc = Math.floor(xDim * HALF);\r\n    const yc = Math.floor(yDim * HALF);\r\n    const zc = Math.floor(zDim * HALF);\r\n    let MAX_DIM = (xDim > yDim) ? xDim : yDim;\r\n    MAX_DIM = (zDim > MAX_DIM) ? zDim : MAX_DIM;\r\n    const xyDim = xDim * yDim;\r\n    // start position for scanning\r\n    const START_SCAN_RATIO = 0.0;//0.2;\r\n    const NUM_2 = 3.0;\r\n    const DIAG_ONE_TRI = Math.sqrt(NUM_2);\r\n    const J_START = Math.floor(0.5 * MAX_DIM * START_SCAN_RATIO);\r\n    const J_END = Math.floor(0.5 * MAX_DIM * DIAG_ONE_TRI);\r\n    if ((valBarrier01 < 0.0) || (valBarrier01 > 1.0)) {\r\n      console.log(`sphereEvolve. Invalid barrier value: ${valBarrier01}. Should be in [0..1]`);\r\n    }\r\n    // when stop scanning: border value\r\n    const NUM_COLORS = 255;\r\n    const VAL_MIN_BORDER =  valBarrier01 * NUM_COLORS;\r\n    console.log(`Autodetect brain shape with barrier range ${VAL_MIN_BORDER}`);\r\n    // for all vertices: move along normal direction\r\n    for (let i = 0; i < numVertices; i++) {\r\n    //for (let i = 10; i < 11; i++) {\r\n      const vSrc = new THREE.Vector3(attrVertices.getX(i),\r\n        attrVertices.getY(i),\r\n        attrVertices.getZ(i));\r\n      const vn = new THREE.Vector3(attrNormals.getX(i) - sphereCenter.x,\r\n        attrNormals.getY(i) - sphereCenter.y,\r\n        attrNormals.getZ(i) - sphereCenter.z);\r\n      vn.normalize();\r\n      // scan from out of sphere\r\n      if (modeEvolve === ActiveVolume.SPHERE_EVOLVE_FROM_OUTSIDE) {\r\n        let j;\r\n        let x, y, z;\r\n\r\n        let xLocMin = -1;\r\n        let yLocMin = -1;\r\n        let zLocMin = -1;\r\n\r\n        let valPrev = -1;\r\n        // search for non-zero skull\r\n        let hasFoundMinBorder = false;\r\n        for (j = J_END; (j >= J_START) && !hasFoundMinBorder; j--) {\r\n          x = xc + Math.floor(vn.x * j);\r\n          y = yc + Math.floor(vn.y * j);\r\n          z = zc + Math.floor(vn.z * j);\r\n          // skip if outside of volume\r\n          if ((x < 0) || (y < 0) || (z < 0) || (x >= xDim) || (y >= yDim) || (z >= zDim)) {\r\n            continue;\r\n          }\r\n          const off = x + (y * xDim) + (z * xyDim);\r\n          const val = volTexSrc[off];\r\n          if ((valPrev > 0) && (val < valPrev) && (val < VAL_MIN_BORDER)) {\r\n            hasFoundMinBorder = true;\r\n          }\r\n          if ((xLocMin < 0) && (val < valPrev)) {\r\n            xLocMin = x; yLocMin = y;\r\n            zLocMin = z;\r\n          }\r\n\r\n          valPrev = val;\r\n        }\r\n        if (!hasFoundMinBorder) {\r\n          // console.log(`sphereEvolve. Min border (${VAL_MIN_BORDER}) not found for ${i} / ${numVertices} point`);\r\n          // continue;\r\n          x = xLocMin; y = yLocMin;\r\n          z = zLocMin;\r\n        }\r\n        // place result point in [-0.5 .. +0.5]\r\n        const xv = (x / xDim) - HALF;\r\n        const yv = (y / yDim) - HALF;\r\n        const zv = (z / zDim) - HALF;\r\n        attrVertices.setXYZ(i, xv, yv, zv);\r\n        // attrWireVertices.setXYZ(i, xv, yv, zv);\r\n      }\r\n      if (modeEvolve === ActiveVolume.SPHERE_EVOLVE_FROM_INSIDE) {\r\n\r\n\r\n        // scan vol from center\r\n        let j;\r\n        let x, y, z, off;\r\n        // let hasFoundLowPixel = false;\r\n        // let hasFoundVolExit = false;\r\n        const ONE = 0;\r\n        const TWO = 2;\r\n        const SKAL = 0.5;\r\n        for (j = ONE; j < TWO * J_END; j++) {\r\n          x = vSrc.x + SKAL * vn.x * j / sideMax;\r\n          y = vSrc.y + SKAL * vn.y * j / sideMax;\r\n          z = vSrc.z + SKAL * vn.z * j / sideMax;\r\n          if ((x < -SKAL) || (y < -SKAL) || (z < -SKAL) || (x >= SKAL) || (y >= SKAL) || (z >= SKAL)) {\r\n            console.log(`MysphereEvolve. Stop at exit [${i}] = ${x}, ${y}, ${z}, `);\r\n            // hasFoundVolExit = true;\r\n            break;\r\n          }\r\n          const xV_ = (-x / vBoxVirtX + HALF) * xDim;\r\n          const yV_ = (y / vBoxVirtY + HALF) * yDim;\r\n          const zV_ = (z / vBoxVirtZ + HALF) * zDim;\r\n          const xV = Math.floor(xV_);\r\n          const yV = Math.floor(yV_);\r\n          const zV = Math.floor(zV_);\r\n          const dx = xV_ - xV;\r\n          const dy = yV_ - yV;\r\n          const dz = zV_ - zV;\r\n          off = xV + (yV * xDim) + (zV * xyDim);\r\n          let vx1 = (1.0 - dx) * volTexSrc[off] + dx * volTexSrc[off + 1];\r\n          off = xV + ((yV + 1) * xDim) + (zV * xyDim);\r\n          let vx2 = (1.0 - dx) * volTexSrc[off] + dx * volTexSrc[off + 1];\r\n          const v1 = (1.0 - dy) * vx1 + dy * vx2;\r\n          off = xV + (yV * xDim) + ((zV + 1) * xyDim);\r\n          vx1 = (1.0 - dx) * volTexSrc[off] + dx * volTexSrc[off + 1];\r\n          off = xV + ((yV + 1) * xDim) + ((zV + 1) * xyDim);\r\n          vx2 = (1.0 - dx) * volTexSrc[off] + dx * volTexSrc[off + 1];\r\n          const v2 = (1.0 - dy) * vx1 + dy * vx2;\r\n          const val = (1.0 - dz) * v1 + dz * v2;\r\n          if (val < VAL_MIN_BORDER) {\r\n            // hasFoundLowPixel = true;\r\n            break;\r\n          }\r\n        } // for (j) all normals extension\r\n        attrVertices.setXYZ(i, x, y, z);\r\n      } // if evolve from inside\r\n\r\n    } // for (i) all vertices\r\n    geoSphere.getAttribute('position').needsUpdate = true;\r\n\r\n    if (volTexDst !== null) {\r\n      // create usual geometry from buffered geometry\r\n      const geoRender = new GeoRender();\r\n      geoRender.fromBufferGeometry(geoSphere);\r\n\r\n      // scale vertices from [-0.5 .. +0.5] to [0 .. xDim], [0 .. yDim], [0 .. zDim]\r\n      const numVerts = geoRender.getNumVertices();\r\n      const vertices = geoRender.getVertices(); // float array\r\n      // console.log(`scale vertices. numVerts = ${numVerts}`);\r\n\r\n      const NUM_4 = 4;\r\n      const OFF_0 = 0;\r\n      const OFF_1 = 1;\r\n      const OFF_2 = 2;\r\n      let ind = 0;\r\n      for (let i = 0; i < numVerts; i++, ind += NUM_4) {\r\n        const x = vertices[ind + OFF_0];\r\n        const y = vertices[ind + OFF_1];\r\n        const z = vertices[ind + OFF_2];\r\n        const xVol = Math.floor((x + HALF) * xDim);\r\n        const yVol = Math.floor((y + HALF) * yDim);\r\n        const zVol = Math.floor((z + HALF) * zDim);\r\n        vertices[ind + OFF_0] = xVol;\r\n        vertices[ind + OFF_1] = yVol;\r\n        vertices[ind + OFF_2] = zVol;\r\n      } // for (i) all vertices\r\n\r\n      // create mask array\r\n      const volMask = new Uint8Array(xyzDim);\r\n      for (let i = 0; i < xyzDim; i++) {\r\n        volMask[i] = 0;\r\n      }\r\n\r\n      // Create mask from geometry\r\n      const WITH_FILL = 1;\r\n      const resFill = VolumeGenerator.generateFromFaces(xDim, yDim, zDim,\r\n        volMask,\r\n        geoRender,\r\n        WITH_FILL);\r\n      if (resFill < 0) {\r\n        console.log(`ActVol. generateFromFaces returned ${resFill} !`);\r\n      }\r\n      // apply  volMask to volSrc\r\n      for (let i = 0; i < xyzDim; i++) {\r\n        volTexDst[i] = (volMask[i] !== 0) ? volTexSrc[i] : 0;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @param {*} xDim \r\n   * @param {*} yDim \r\n   * @param {*} zDim \r\n   * @param {*} volTexSrc \r\n   * @param {*} volTexDst \r\n   * @param {*} createType \r\n   * @param {*} needLog \r\n   */\r\n  skullRemoveStart(xDim, yDim, zDim, volTexSrc, volTexDst, createType, needLog) {\r\n    const TOO_MUCH_SIZE = 8192;\r\n    if ((createType !== ActiveVolume.REMOVE_SKULL) && (createType !== ActiveVolume.CREATE_MASK)) {\r\n      console.log('skullRemoveStart: wrong argument createType');\r\n    }\r\n    if ((xDim >= TOO_MUCH_SIZE) || (yDim >= TOO_MUCH_SIZE) || (zDim >= TOO_MUCH_SIZE)) {\r\n      console.log(`Too bad volume dimension: ${xDim} * ${yDim} * ${zDim}`);\r\n      return -1;\r\n    }\r\n    if ((xDim <= 1) || (yDim <= 1) || (zDim <= 1)) {\r\n      console.log(`Too bad volume dimension: ${xDim} * ${yDim} * ${zDim}`);\r\n      return -1;\r\n    }\r\n    const volSizeSrc = volTexSrc.length;\r\n    const numPixSrc = xDim * yDim * zDim;\r\n    if (volSizeSrc !== numPixSrc) {\r\n      console.log(`skullRemoveStart: bad vol size = ${volSizeSrc}, expected ${numPixSrc}`);\r\n      return -1;\r\n    }\r\n    const okCreate = this.create(xDim, yDim, zDim, volTexSrc);\r\n    if (okCreate !== 1) {\r\n      return okCreate;\r\n    }\r\n    const genTetra = new TetrahedronGenerator();\r\n    const vRadius = new THREE.Vector3(0.5, 0.5, 0.5);\r\n    const NUM_SUBDIVIDES = 3;\r\n    const okCreateTetra = genTetra.create(vRadius, NUM_SUBDIVIDES);\r\n    if (okCreateTetra < 1) {\r\n      return okCreateTetra;\r\n    }\r\n    const geoRender = new GeoRender();\r\n    const errGeo = geoRender.createFromTetrahedronGenerator(genTetra);\r\n    const GEO_OK = 1;\r\n    if (errGeo !== GEO_OK) {\r\n      const ERR_CREATE_GEO = -3;\r\n      return ERR_CREATE_GEO;\r\n    }\r\n\r\n    // get half from volume dimension\r\n    const xDim2 = Math.floor((this.m_xDim - 1) * 0.5);\r\n    const yDim2 = Math.floor((this.m_yDim - 1) * 0.5);\r\n    const zDim2 = Math.floor((this.m_zDim - 1) * 0.5);\r\n\r\n    // scale geo render vertices\r\n    const numVertices = geoRender.getNumVertices();\r\n    const vertices = geoRender.getVertices();\r\n    const COORDS_IN_VERTEX = 4;\r\n    const NUM_0 = 0;\r\n    const NUM_1 = 1;\r\n    const NUM_2 = 2;\r\n    for (let i = 0, i4 = 0; i < numVertices; i++, i4 += COORDS_IN_VERTEX) {\r\n      vertices[i4 + NUM_0] = xDim2 + xDim2 * vertices[i4 + NUM_0];\r\n      vertices[i4 + NUM_1] = yDim2 + yDim2 * vertices[i4 + NUM_1];\r\n      vertices[i4 + NUM_2] = zDim2 + zDim2 * vertices[i4 + NUM_2];\r\n    } // for (i) all vertices\r\n\r\n    // save render geo to obj file\r\n    const NEED_SAVE_INITIAL_GEO = false;\r\n    if (NEED_SAVE_INITIAL_GEO) {\r\n      const TEST_SAVE_INIT_GEO_FILE_NAME = 'geo_init.obj';\r\n      geoRender.saveGeoToObjFile(TEST_SAVE_INIT_GEO_FILE_NAME);\r\n    }\r\n\r\n    // Test save bounding sphere\r\n    const NEED_SAVE_BOUND_SPHERE = false;\r\n    if (NEED_SAVE_BOUND_SPHERE) {\r\n      const vMin = new THREE.Vector3();\r\n      const vMax = new THREE.Vector3();\r\n      ActiveVolume.getBoundingBox(this.m_xDim, this.m_yDim, this.m_zDim, this.m_pixelsSrc, vMin, vMax);\r\n      const geoSphere = new GeoRender();\r\n      const vCenter = new THREE.Vector3();\r\n      const vRad = new THREE.Vector3();\r\n      vCenter.x = (vMin.x + vMax.x) * 0.5;\r\n      vCenter.y = (vMin.y + vMax.y) * 0.5;\r\n      vCenter.z = (vMin.z + vMax.z) * 0.5;\r\n      vRad.x = (vMax.x - vMin.x) * 0.5;\r\n      vRad.y = (vMax.y - vMin.y) * 0.5;\r\n      vRad.z = (vMax.z - vMin.z) * 0.5;\r\n\r\n      const NUM_SEGM_HOR = 16;\r\n      const NUM_SEGM_VER = 8;\r\n      geoSphere.createFromEllipse(vCenter, vRad, NUM_SEGM_HOR, NUM_SEGM_VER);\r\n      const TEST_SAVE_BSPHERE_GEO_FILE_NAME = 'geo_bsph.obj';\r\n      geoSphere.saveGeoToObjFile(TEST_SAVE_BSPHERE_GEO_FILE_NAME);\r\n    }\r\n    let numPredSteps = this.getPredictedStepsForActiveVolumeUpdate();\r\n    const SOME_ADD_STEPS = 12;\r\n    numPredSteps += SOME_ADD_STEPS;\r\n\r\n    const strTypeArr = ['REMOVE_SKULL', 'CREATE_MASK'];\r\n    const strType = strTypeArr[createType];\r\n    console.log(`skullRemoveStart. Will be ${numPredSteps} updates approximately. In ${strType} mode `);\r\n\r\n    this.m_updateCounter = 0;\r\n    this.m_isFinished = false;\r\n    this.m_numPredSteps = numPredSteps;\r\n    this.m_createType = createType;\r\n    this.m_volTexSrc = volTexSrc;\r\n    this.m_volTexDst = volTexDst;\r\n    this.m_needLog = needLog;\r\n\r\n    return geoRender;\r\n  }\r\n\r\n  skullRemoveUpdate(geoRender) {\r\n    // for (this.m_updateCounter = 0; (this.m_updateCounter < numPredSteps) && !isFinished; this.m_updateCounter++) {\r\n    //   console.log(`skullRemove(${this.m_updateCounter})`);\r\n    //   this.updateGeo(geoRender, AV_METHOD_ALL);\r\n    //   isFinished = (this.m_state === AV_STATE_FINISHED);\r\n    // }\r\n    const isLoopComplete = (this.m_updateCounter >= this.m_numPredSteps) || this.m_isFinished;\r\n    if (isLoopComplete) {\r\n      return true;\r\n    }\r\n    this.updateGeo(geoRender, AV_METHOD_ALL);\r\n    this.m_isFinished = (this.m_state === AV_STATE_FINISHED);\r\n    this.m_updateCounter++;\r\n    return false;\r\n  }\r\n\r\n  skullRemoveStop(geoRender) {\r\n    // save geo render after all modification iterations\r\n    const NEED_SAVE_FINAL_GEO_RENDER = false;\r\n    if (NEED_SAVE_FINAL_GEO_RENDER) {\r\n      this.finalizeUpdatesGeo(geoRender, NEED_SAVE_FINAL_GEO_RENDER);\r\n    }\r\n    const NUM_2 = 2;\r\n\r\n    // Save smoothed image into file\r\n    const NEED_SAVE_NONCLIPPED_SLICE_BMP = false;\r\n    if (NEED_SAVE_NONCLIPPED_SLICE_BMP) {\r\n      const TEST_SAVE_VOL_FILE_NAME = 'test_nonclipped_slice.bmp';\r\n      const zSlice = Math.floor(this.m_zDim / NUM_2);\r\n      ActiveVolume.saveVolumeSliceToFile(this.m_pixelsSrc,\r\n        this.m_xDim, this.m_yDim, this.m_zDim, zSlice, TEST_SAVE_VOL_FILE_NAME);\r\n    }\r\n\r\n    // create clipped volume\r\n    // const resClip = VolumeClipper.clipVolumeByNonConvexGeo(this.m_pixelsSrc, this.m_xDim, this.m_yDim, this.m_zDim,\r\n    //   volTexDst, geoRender, createType);\r\n    // if (resClip < 0) {\r\n    //   console.log(`clipVolumeByNonConvexGeo returned ${resClip} !`);\r\n    // }\r\n\r\n    // let i;\r\n    // const numPixels = this.m_xDim * this.m_yDim * this.m_zDim;\r\n    // for (i = 0; i < numPixels; i++) {\r\n    //   volTexDst[i] = this.m_pixelsSrc[i];\r\n    // }\r\n\r\n    if (this.m_createType === ActiveVolume.REMOVE_SKULL) {\r\n      const numPixels = this.m_xDim * this.m_yDim * this.m_zDim;\r\n      const volMask = new Uint8Array(numPixels);\r\n\r\n      // create volume mask. 255: visible part, 0 - invisible\r\n      const WITH_FILL = 1;\r\n      const resFill = VolumeGenerator.generateFromFaces(this.m_xDim, this.m_yDim, this.m_zDim,\r\n        volMask,\r\n        geoRender,\r\n        WITH_FILL);\r\n      if (resFill < 0) {\r\n        console.log(`generateFromFaces returned ${resFill} !`);\r\n      }\r\n      // apply  volMask to volSrc\r\n      for (let i = 0; i < numPixels; i++) {\r\n        this.m_volTexDst[i] = (volMask[i] !== 0) ? this.m_volTexSrc[i] : 0;\r\n      }\r\n    } else if (this.m_createType === ActiveVolume.CREATE_MASK) {\r\n      // create volume mask. 255: visible part, 0 - invisible\r\n      const WITH_FILL = 1;\r\n      const resFill = VolumeGenerator.generateFromFaces(this.m_xDim, this.m_yDim, this.m_zDim,\r\n        this.m_volTexDst,\r\n        geoRender,\r\n        WITH_FILL);\r\n      if (resFill < 0) {\r\n        console.log(`generateFromFaces returned ${resFill} !`);\r\n      }\r\n    }\r\n\r\n    // save result for deep debug\r\n    const NEED_SAVE_CLIPPED_SLICE_BMP = false;\r\n    if (this.m_needLog && NEED_SAVE_CLIPPED_SLICE_BMP) {\r\n      const TEST_SLICE_SAVE_FILE_NAME = 'test_clipped_slice.bmp';\r\n      const zSlice = Math.floor(this.m_zDim / NUM_2);\r\n      ActiveVolume.saveVolumeSliceToFile(this.m_volTexDst,\r\n        this.m_xDim, this.m_yDim, this.m_zDim, zSlice, TEST_SLICE_SAVE_FILE_NAME);\r\n    }\r\n\r\n    /*\r\n    // Save clipped volume into KTX file\r\n    const NEED_SAVE_CLIPPED_VOLUME_KTX = false;\r\n    if (NEED_SAVE_CLIPPED_VOLUME_KTX) {\r\n      const ktxVol = new KtxLoader();\r\n      const xSize = this.m_xDim;\r\n      const ySize = this.m_yDim;\r\n      const zSize = this.m_zDim;\r\n      ktxVol.createFromMemory(this.m_xDim, this.m_yDim, this.m_zDim, volTexDst, xSize, ySize, zSize);\r\n      const TEST_CLIPPED_VOL_KTX_NAME = 'test_clipped.ktx';\r\n      ktxVol.writeFile(TEST_CLIPPED_VOL_KTX_NAME);\r\n    }\r\n    */\r\n    return +1;\r\n  }\r\n\r\n  /**\r\n  * Remove skull\r\n  * @param {number} xDim volume dimension on x\r\n  * @param {number} yDim volume dimension on y\r\n  * @param {number} zDim volume dimension on z\r\n  * @param {array}  volTexSrc source volume\r\n  * @param {array}  volTexDst destination volume\r\n  * @param {number} createType Kind of\r\n  * @param {boolean} needLog Need intensive log\r\n  * @param {object} progressCallback callback function for progress\r\n  * @return {number} 1, if success. <0 if failed\r\n  */\r\n  skullRemove(xDim, yDim, zDim, volTexSrc, volTexDst, createType, needLog) {\r\n    const TOO_MUCH_SIZE = 8192;\r\n    if ((createType !== ActiveVolume.REMOVE_SKULL) && (createType !== ActiveVolume.CREATE_MASK)) {\r\n      console.log('skullRemove: wrong argument createType');\r\n    }\r\n    if ((xDim >= TOO_MUCH_SIZE) || (yDim >= TOO_MUCH_SIZE) || (zDim >= TOO_MUCH_SIZE)) {\r\n      console.log(`Too bad volume dimension: ${xDim} * ${yDim} * ${zDim}`);\r\n      return -1;\r\n    }\r\n    if ((xDim <= 1) || (yDim <= 1) || (zDim <= 1)) {\r\n      console.log(`Too bad volume dimension: ${xDim} * ${yDim} * ${zDim}`);\r\n      return -1;\r\n    }\r\n    const volSizeSrc = volTexSrc.length;\r\n    const numPixSrc = xDim * yDim * zDim;\r\n    if (volSizeSrc !== numPixSrc) {\r\n      console.log(`skullRemove: bad vol size = ${volSizeSrc}, expected ${numPixSrc}`);\r\n      return -1;\r\n    }\r\n    const okCreate = this.create(xDim, yDim, zDim, volTexSrc);\r\n    if (okCreate !== 1) {\r\n      return okCreate;\r\n    }\r\n    const genTetra = new TetrahedronGenerator();\r\n    const vRadius = new THREE.Vector3(0.5, 0.5, 0.5);\r\n    const NUM_SUBDIVIDES = 3;\r\n    const okCreateTetra = genTetra.create(vRadius, NUM_SUBDIVIDES);\r\n    if (okCreateTetra < 1) {\r\n      return okCreateTetra;\r\n    }\r\n    const geoRender = new GeoRender();\r\n    const errGeo = geoRender.createFromTetrahedronGenerator(genTetra);\r\n    const GEO_OK = 1;\r\n    if (errGeo !== GEO_OK) {\r\n      const ERR_CREATE_GEO = -3;\r\n      return ERR_CREATE_GEO;\r\n    }\r\n\r\n    // get half from volume dimension\r\n    const xDim2 = Math.floor((this.m_xDim - 1) * 0.5);\r\n    const yDim2 = Math.floor((this.m_yDim - 1) * 0.5);\r\n    const zDim2 = Math.floor((this.m_zDim - 1) * 0.5);\r\n\r\n    // scale geo render vertices\r\n    const numVertices = geoRender.getNumVertices();\r\n    const vertices = geoRender.getVertices();\r\n    const COORDS_IN_VERTEX = 4;\r\n    const NUM_0 = 0;\r\n    const NUM_1 = 1;\r\n    const NUM_2 = 2;\r\n    for (let i = 0, i4 = 0; i < numVertices; i++, i4 += COORDS_IN_VERTEX) {\r\n      vertices[i4 + NUM_0] = xDim2 + xDim2 * vertices[i4 + NUM_0];\r\n      vertices[i4 + NUM_1] = yDim2 + yDim2 * vertices[i4 + NUM_1];\r\n      vertices[i4 + NUM_2] = zDim2 + zDim2 * vertices[i4 + NUM_2];\r\n    } // for (i) all vertices\r\n\r\n    // save render geo to obj file\r\n    const NEED_SAVE_INITIAL_GEO = false;\r\n    if (NEED_SAVE_INITIAL_GEO) {\r\n      const TEST_SAVE_INIT_GEO_FILE_NAME = 'geo_init.obj';\r\n      geoRender.saveGeoToObjFile(TEST_SAVE_INIT_GEO_FILE_NAME);\r\n    }\r\n\r\n    // Test save bounding sphere\r\n    const NEED_SAVE_BOUND_SPHERE = false;\r\n    if (NEED_SAVE_BOUND_SPHERE) {\r\n      const vMin = new THREE.Vector3();\r\n      const vMax = new THREE.Vector3();\r\n      ActiveVolume.getBoundingBox(this.m_xDim, this.m_yDim, this.m_zDim, this.m_pixelsSrc, vMin, vMax);\r\n      const geoSphere = new GeoRender();\r\n      const vCenter = new THREE.Vector3();\r\n      const vRad = new THREE.Vector3();\r\n      vCenter.x = (vMin.x + vMax.x) * 0.5;\r\n      vCenter.y = (vMin.y + vMax.y) * 0.5;\r\n      vCenter.z = (vMin.z + vMax.z) * 0.5;\r\n      vRad.x = (vMax.x - vMin.x) * 0.5;\r\n      vRad.y = (vMax.y - vMin.y) * 0.5;\r\n      vRad.z = (vMax.z - vMin.z) * 0.5;\r\n\r\n      const NUM_SEGM_HOR = 16;\r\n      const NUM_SEGM_VER = 8;\r\n      geoSphere.createFromEllipse(vCenter, vRad, NUM_SEGM_HOR, NUM_SEGM_VER);\r\n      const TEST_SAVE_BSPHERE_GEO_FILE_NAME = 'geo_bsph.obj';\r\n      geoSphere.saveGeoToObjFile(TEST_SAVE_BSPHERE_GEO_FILE_NAME);\r\n    }\r\n\r\n    // perform itertaions: update geo\r\n    let numPredSteps = this.getPredictedStepsForActiveVolumeUpdate();\r\n    const SOME_ADD_STEPS = 12;\r\n    numPredSteps += SOME_ADD_STEPS;\r\n\r\n    const strTypeArr = ['REMOVE_SKULL', 'CREATE_MASK'];\r\n    const strType = strTypeArr[createType];\r\n    console.log(`skullRemove. Will be ${numPredSteps} updates approximately. In ${strType} mode `);\r\n\r\n    let isFinished = false;\r\n    if (numPredSteps > 0) {\r\n      for (this.m_updateCounter = 0; (this.m_updateCounter < numPredSteps) && !isFinished; this.m_updateCounter++) {\r\n        //if (needLogPrintf) {\r\n        //  printf(\".\");\r\n        // }\r\n        console.log(`skullRemove(${this.m_updateCounter})`);\r\n        this.updateGeo(geoRender, AV_METHOD_ALL);\r\n        isFinished = (this.m_state === AV_STATE_FINISHED);\r\n      }\r\n    }\r\n\r\n    // save geo render after all modification iterations\r\n    const NEED_SAVE_FINAL_GEO_RENDER = false;\r\n    if (NEED_SAVE_FINAL_GEO_RENDER) {\r\n      this.finalizeUpdatesGeo(geoRender, NEED_SAVE_FINAL_GEO_RENDER);\r\n    }\r\n\r\n    // Save smoothed image into file\r\n    const NEED_SAVE_NONCLIPPED_SLICE_BMP = false;\r\n    if (NEED_SAVE_NONCLIPPED_SLICE_BMP) {\r\n      const TEST_SAVE_VOL_FILE_NAME = 'test_nonclipped_slice.bmp';\r\n      const zSlice = Math.floor(this.m_zDim / NUM_2);\r\n      ActiveVolume.saveVolumeSliceToFile(this.m_pixelsSrc,\r\n        this.m_xDim, this.m_yDim, this.m_zDim, zSlice, TEST_SAVE_VOL_FILE_NAME);\r\n    }\r\n\r\n    // create clipped volume\r\n    // const resClip = VolumeClipper.clipVolumeByNonConvexGeo(this.m_pixelsSrc, this.m_xDim, this.m_yDim, this.m_zDim,\r\n    //   volTexDst, geoRender, createType);\r\n    // if (resClip < 0) {\r\n    //   console.log(`clipVolumeByNonConvexGeo returned ${resClip} !`);\r\n    // }\r\n\r\n    // let i;\r\n    // const numPixels = this.m_xDim * this.m_yDim * this.m_zDim;\r\n    // for (i = 0; i < numPixels; i++) {\r\n    //   volTexDst[i] = this.m_pixelsSrc[i];\r\n    // }\r\n\r\n    if (createType === ActiveVolume.REMOVE_SKULL) {\r\n      const numPixels = this.m_xDim * this.m_yDim * this.m_zDim;\r\n      const volMask = new Uint8Array(numPixels);\r\n\r\n      // create volume mask. 255: visible part, 0 - invisible\r\n      const WITH_FILL = 1;\r\n      const resFill = VolumeGenerator.generateFromFaces(this.m_xDim, this.m_yDim, this.m_zDim,\r\n        volMask,\r\n        geoRender,\r\n        WITH_FILL);\r\n      if (resFill < 0) {\r\n        console.log(`generateFromFaces returned ${resFill} !`);\r\n      }\r\n      // apply  volMask to volSrc\r\n      for (let i = 0; i < numPixels; i++) {\r\n        volTexDst[i] = (volMask[i] !== 0) ? volTexSrc[i] : 0;\r\n      }\r\n    } else if (createType === ActiveVolume.CREATE_MASK) {\r\n      // create volume mask. 255: visible part, 0 - invisible\r\n      const WITH_FILL = 1;\r\n      const resFill = VolumeGenerator.generateFromFaces(this.m_xDim, this.m_yDim, this.m_zDim,\r\n        volTexDst,\r\n        geoRender,\r\n        WITH_FILL);\r\n      if (resFill < 0) {\r\n        console.log(`generateFromFaces returned ${resFill} !`);\r\n      }\r\n    }\r\n\r\n    // save result for deep debug\r\n    const NEED_SAVE_CLIPPED_SLICE_BMP = false;\r\n    if (needLog && NEED_SAVE_CLIPPED_SLICE_BMP) {\r\n      const TEST_SLICE_SAVE_FILE_NAME = 'test_clipped_slice.bmp';\r\n      const zSlice = Math.floor(this.m_zDim / NUM_2);\r\n      ActiveVolume.saveVolumeSliceToFile(volTexDst,\r\n        this.m_xDim, this.m_yDim, this.m_zDim, zSlice, TEST_SLICE_SAVE_FILE_NAME);\r\n    }\r\n\r\n    /*\r\n    // Save clipped volume into KTX file\r\n    const NEED_SAVE_CLIPPED_VOLUME_KTX = false;\r\n    if (NEED_SAVE_CLIPPED_VOLUME_KTX) {\r\n      const ktxVol = new KtxLoader();\r\n      const xSize = this.m_xDim;\r\n      const ySize = this.m_yDim;\r\n      const zSize = this.m_zDim;\r\n      ktxVol.createFromMemory(this.m_xDim, this.m_yDim, this.m_zDim, volTexDst, xSize, ySize, zSize);\r\n      const TEST_CLIPPED_VOL_KTX_NAME = 'test_clipped.ktx';\r\n      ktxVol.writeFile(TEST_CLIPPED_VOL_KTX_NAME);\r\n    }\r\n    */\r\n    return +1;\r\n  } // skullRemove\r\n\r\n  static getBoundingBox(xDim, yDim, zDim, volTexSrc, vMin, vMax) {\r\n    const MIN_VIS_COLOR = 50;\r\n    let x, y, z;\r\n    vMax.set(0.0, 0.0, 0.0);\r\n    vMin.set(xDim, yDim, zDim);\r\n    let ind = 0;\r\n    for (z = 0; z < zDim; z++) {\r\n      for (y = 0; y < yDim; y++) {\r\n        for (x = 0; x < xDim; x++) {\r\n          const val = volTexSrc[ind];\r\n          ind++;\r\n          if (val < MIN_VIS_COLOR) {\r\n            continue;\r\n          }\r\n          // update bbox\r\n          vMin.x = (x < vMin.x) ? x : vMin.x;\r\n          vMin.y = (y < vMin.y) ? y : vMin.y;\r\n          vMin.z = (z < vMin.z) ? z : vMin.z;\r\n          vMax.x = (x > vMax.x) ? x : vMax.x;\r\n          vMax.y = (y > vMax.y) ? y : vMax.y;\r\n          vMax.z = (z > vMax.z) ? z : vMax.z;\r\n        } // for (x)\r\n      } // for (y)\r\n    } // for (z)\r\n  }\r\n\r\n  /**\r\n  * Save volume slice to BMP file. Only for deep debug\r\n  * @param {array} pixelsSrc array of source voxels in volume\r\n  * @param {number} xDim Volume dimension on x\r\n  * @param {number} yDim Volume dimension on y\r\n  * @param {number} zDim Volume dimension on z\r\n  * @param {number} zSlice index of slice in volume\r\n  * @param {string } fileName save file name\r\n  */\r\n  static saveVolumeSliceToFile(pixelsSrc, xDim, yDim, zDim, zSlice, fileName) {\r\n    const SIZE_HEADER = 14;\r\n    const SIZE_INFO = 40;\r\n    const COMPS_IN_COLOR = 3;\r\n    const numPixels = xDim * yDim;\r\n    let pixStride = COMPS_IN_COLOR  * xDim;\r\n    pixStride = (pixStride + COMPS_IN_COLOR) & (~COMPS_IN_COLOR);\r\n    const totalBufSize = SIZE_HEADER + SIZE_INFO + (numPixels * COMPS_IN_COLOR);\r\n    const buf = new Uint8Array(totalBufSize);\r\n    for (let j = 0; j < totalBufSize; j++) {\r\n      buf[j] = 0;\r\n    }\r\n    const BYTE_MASK = 255;\r\n    const BITS_IN_BYTE = 8;\r\n    // write header\r\n    const BYTES_IN_DWORD = 4;\r\n\r\n    let i = 0;\r\n    // bfType[16]\r\n    buf[i++] = 0x42;\r\n    buf[i++] = 0x4D;\r\n    // bfSize[32]\r\n    let bfSize = SIZE_HEADER + SIZE_INFO + pixStride * yDim;\r\n    buf[i++] = bfSize & BYTE_MASK; bfSize >>= BITS_IN_BYTE;\r\n    buf[i++] = bfSize & BYTE_MASK; bfSize >>= BITS_IN_BYTE;\r\n    buf[i++] = bfSize & BYTE_MASK; bfSize >>= BITS_IN_BYTE;\r\n    buf[i++] = bfSize & BYTE_MASK;\r\n    // bfReserved1 + bfReserved2\r\n    i += BYTES_IN_DWORD;\r\n    // bfOffBits[32]\r\n    let bfOffBits = SIZE_HEADER + SIZE_INFO;\r\n    buf[i++] = bfOffBits & BYTE_MASK; bfOffBits >>= BITS_IN_BYTE;\r\n    buf[i++] = bfOffBits & BYTE_MASK; bfOffBits >>= BITS_IN_BYTE;\r\n    buf[i++] = bfOffBits & BYTE_MASK; bfOffBits >>= BITS_IN_BYTE;\r\n    buf[i++] = bfOffBits & BYTE_MASK;\r\n\r\n    // write info\r\n\r\n    // biSize[32]\r\n    let biSize = SIZE_INFO;\r\n    buf[i++] = biSize & BYTE_MASK; biSize >>= BITS_IN_BYTE;\r\n    buf[i++] = biSize & BYTE_MASK; biSize >>= BITS_IN_BYTE;\r\n    buf[i++] = biSize & BYTE_MASK; biSize >>= BITS_IN_BYTE;\r\n    buf[i++] = biSize & BYTE_MASK;\r\n    // biWidth[32]\r\n    let biWidth = xDim;\r\n    buf[i++] = biWidth & BYTE_MASK; biWidth >>= BITS_IN_BYTE;\r\n    buf[i++] = biWidth & BYTE_MASK; biWidth >>= BITS_IN_BYTE;\r\n    buf[i++] = biWidth & BYTE_MASK; biWidth >>= BITS_IN_BYTE;\r\n    buf[i++] = biWidth & BYTE_MASK;\r\n    // biHeight[32]\r\n    let biHeight = yDim;\r\n    buf[i++] = biHeight & BYTE_MASK; biHeight >>= BITS_IN_BYTE;\r\n    buf[i++] = biHeight & BYTE_MASK; biHeight >>= BITS_IN_BYTE;\r\n    buf[i++] = biHeight & BYTE_MASK; biHeight >>= BITS_IN_BYTE;\r\n    buf[i++] = biHeight & BYTE_MASK;\r\n    // biPlanes[16]\r\n    buf[i++] = 1;\r\n    buf[i++] = 0;\r\n    // biBitCount[16]\r\n    buf[i++] = 24;\r\n    buf[i++] = 0;\r\n    // biCompression[32]\r\n    i += BYTES_IN_DWORD;\r\n    // biSizeImage[32]\r\n    let biSizeImage = pixStride * yDim;\r\n    buf[i++] = biSizeImage & BYTE_MASK; biSizeImage >>= BITS_IN_BYTE;\r\n    buf[i++] = biSizeImage & BYTE_MASK; biSizeImage >>= BITS_IN_BYTE;\r\n    buf[i++] = biSizeImage & BYTE_MASK; biSizeImage >>= BITS_IN_BYTE;\r\n    buf[i++] = biSizeImage & BYTE_MASK;\r\n    // biXPelsPerMeter[32]\r\n    i += BYTES_IN_DWORD;\r\n    // biYPelsPerMeter[32]\r\n    i += BYTES_IN_DWORD;\r\n    // biClrUsed[32]\r\n    i += BYTES_IN_DWORD;\r\n    // biClrImportant[32]\r\n    i += BYTES_IN_DWORD;\r\n\r\n    let j;\r\n    // get max volume\r\n    const offSlice = zSlice * xDim * yDim;\r\n    let valMax = 0;\r\n    for (j = 0; j < numPixels; j++) {\r\n      const valGrey = pixelsSrc[offSlice + j];\r\n      valMax = (valGrey > valMax) ? valGrey : valMax;\r\n    } // for (j)\r\n    console.log(`saveVolumeSlice. valMax = ${valMax}`);\r\n\r\n    // write pixels\r\n    const MAX_COLOR = 255;\r\n    for (j = 0; j < numPixels; j++) {\r\n      const valGrey = Math.floor(pixelsSrc[offSlice + j] * MAX_COLOR / valMax);\r\n      // write rgb components\r\n      buf[i++] = valGrey;\r\n      buf[i++] = valGrey;\r\n      buf[i++] = valGrey;\r\n    } // for (j)\r\n\r\n    // write buffer to file\r\n    const blob = new Blob([buf], { type: 'application/octet-stream' });\r\n    const url = URL.createObjectURL(blob);\r\n    const linkGen = document.createElement('a');\r\n    linkGen.setAttribute('href', url);\r\n    linkGen.setAttribute('download', fileName);\r\n    const eventGen = document.createEvent('MouseEvents');\r\n    eventGen.initMouseEvent('click', true, true, window, 1, 0, 0, 0, 0, false, false, false, false, 0, null);\r\n    linkGen.dispatchEvent(eventGen);\r\n  }\r\n\r\n  getPredictedStepsForActiveVolumeUpdate() {\r\n    const TWO = 2;\r\n    const hx = this.m_xDim;\r\n    const hy = this.m_yDim;\r\n    const hz = this.m_zDim;\r\n    const xyMax = (hx > hy) ? hx : hy;\r\n    const xyzMax = (xyMax > hz) ? xyMax : hz;\r\n    const SCAN_RAD = 4;\r\n    const stepsByRad = (xyzMax - SCAN_RAD);\r\n    const SOME_ADD_STEPS = 4;\r\n    const stepsAll = stepsByRad + (TWO * ActiveVolume.ACT_VOL_NUM_SMOOTH_STAGES) + SOME_ADD_STEPS;\r\n    return stepsAll;\r\n  }\r\n\r\n  /**\r\n  * Create members for iterations later\r\n  * @return {number} 1, if success. <0 if failed\r\n  */\r\n  create(xDim, yDim, zDim, volTexSrc) {\r\n    if ((xDim > X_MAX_DIM) || (yDim > Y_MAX_DIM) || (zDim > Z_MAX_DIM)) {\r\n      // scale down twice or 4\r\n      this.m_xScale = Math.floor(xDim / X_MAX_DIM);\r\n      this.m_yScale = Math.floor(yDim / Y_MAX_DIM);\r\n      this.m_zScale = Math.floor(zDim / Z_MAX_DIM);\r\n      let maxScale = (this.m_xScale > this.m_yScale) ? this.m_xScale : this.m_yScale;\r\n      maxScale = (this.m_zScale > maxScale) ? this.m_zScale : maxScale;\r\n      const TWO = 2;\r\n      if (maxScale <= 1) {\r\n        this.m_xScale = this.m_yScale = this.m_zScale = TWO;\r\n      }\r\n      this.m_xScale = (this.m_xScale >= 1) ? this.m_xScale : 1;\r\n      this.m_yScale = (this.m_yScale >= 1) ? this.m_yScale : 1;\r\n      this.m_zScale = (this.m_zScale >= 1) ? this.m_zScale : 1;\r\n\r\n      const xScaled = Math.floor(xDim / this.m_xScale);\r\n      const yScaled = Math.floor(yDim / this.m_yScale);\r\n      const zScaled = Math.floor(zDim / this.m_zScale);\r\n      const numPixelsScaled = xScaled * yScaled * zScaled;\r\n      const pixelsScaled = new Uint8Array(numPixelsScaled);\r\n      VolumeTools.scaleDown(volTexSrc, xDim, yDim, zDim, pixelsScaled, this.m_xScale, this.m_yScale, this.m_zScale);\r\n      this.m_pixelsSrc = pixelsScaled;\r\n      this.m_wasAllocated = true;\r\n      this.m_xDim = xScaled;\r\n      this.m_yDim = yScaled;\r\n      this.m_zDim = zScaled;\r\n      console.log(`ActiveVolume. Scaled down to ${xScaled} * ${yScaled} * ${zScaled}`);\r\n    } else {\r\n      this.m_xDim = xDim;\r\n      this.m_yDim = yDim;\r\n      this.m_zDim = zDim;\r\n      this.m_pixelsSrc = volTexSrc;\r\n      this.m_wasAllocated = false;\r\n    }\r\n\r\n    this.m_state = AV_STATE_NOT_STARTED;\r\n    const numPixels = this.m_xDim * this.m_yDim * this.m_zDim;\r\n    this.m_imageGauss = new Float32Array(numPixels);\r\n    this.m_imageUniformity = new Float32Array(numPixels);\r\n    this.m_verticesNew = null;\r\n    // add checks\r\n    if (this.m_pixelsSrc.length !== numPixels) {\r\n      // console.log(`ActiveVolume.create: Bad vol.expect data len=${numPixels},actual len=${volTexSrc.length}`);\r\n      return 0;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n  /**\r\n  * Make special unifoirmity image for whole volume\r\n  */\r\n  makeUniformityImage(pixelsSrc, xDim, yDim, zDim,\r\n    zStart, zEnd,\r\n    pixelsGrad,\r\n    pixelsDst,\r\n    koefAlpha) {\r\n    // radius neighbours\r\n    const TWICE = 2;\r\n    const RAD_UNI = 1;\r\n    const DIA_UNI = (1 + TWICE * RAD_UNI);\r\n\r\n    const SCALE_ALL_ELEMS = 1.0 / (DIA_UNI * DIA_UNI * DIA_UNI);\r\n    // let maxLen = 0.0;\r\n    let cx, cy, cz;\r\n\r\n    const zs = (zStart > RAD_UNI) ? zStart : RAD_UNI;\r\n    const ze = (zEnd < zDim - RAD_UNI) ? zEnd : (zDim - RAD_UNI);\r\n\r\n    for (cz = zs; cz < ze; cz++) {\r\n      const czOff = cz * xDim * yDim;\r\n      for (cy = RAD_UNI; cy < yDim - RAD_UNI; cy++) {\r\n        const cyOff = cy * xDim;\r\n        for (cx = RAD_UNI; cx < xDim - RAD_UNI; cx++) {\r\n          let sumDx = 0.0;\r\n          let sumDy = 0.0;\r\n          let sumDz = 0.0;\r\n          let dx, dy, dz;\r\n\r\n          for (dz = -RAD_UNI; dz <= +RAD_UNI; dz++) {\r\n            const z = cz + dz;\r\n            const zOff = z * xDim * yDim;\r\n            for (dy = -RAD_UNI; dy <= +RAD_UNI; dy++) {\r\n              const y = cy + dy;\r\n              const yOff = y * xDim;\r\n              for (dx = -RAD_UNI; dx <= +RAD_UNI; dx++) {\r\n                const x = cx + dx;\r\n                const offSrc = x + yOff + zOff;\r\n                // if ((offSrc < 0) || (offSrc >= numPixelsVol)) {\r\n                //   console.log('!!! Out of array');\r\n                // }\r\n                const val = pixelsSrc[offSrc];\r\n                sumDx += val * dx;\r\n                sumDy += val * dy;\r\n                sumDz += val * dz;\r\n              }     // for (dx)\r\n            }       // for (dy)\r\n          }         // for (dz)\r\n\r\n          sumDx *= SCALE_ALL_ELEMS;\r\n          sumDy *= SCALE_ALL_ELEMS;\r\n          sumDz *= SCALE_ALL_ELEMS;\r\n\r\n          // maxLen = (gradLen > maxLen) ? gradLen : maxLen;\r\n\r\n          const gradLen = Math.sqrt(sumDx * sumDx + sumDy * sumDy + sumDz * sumDz);\r\n          pixelsGrad[cx + cyOff + czOff] = gradLen;\r\n          pixelsDst[cx + cyOff + czOff] = Math.exp(-koefAlpha * gradLen);\r\n\r\n        }         // for (cx)\r\n      }           // for (cy)\r\n    }             // for (cz)\r\n    // console.log(`makeUniformityImage done for z = ${zs} to ${ze}`);\r\n  }\r\n\r\n  /**\r\n  * Start image smoothimg by Gauss convolution\r\n  */\r\n  startImageSmooth() {\r\n    const numPixels = this.m_xDim * this.m_yDim * this.m_zDim;\r\n    let i;\r\n    for (i = 0; i < numPixels; i++) {\r\n      this.m_imageGauss[i] = 0.0;\r\n      this.m_imageUniformity[i] = 0.0;\r\n    }\r\n    this.m_imageSrc = new Float32Array(numPixels);\r\n    this.m_imageGrad = new Float32Array(numPixels);\r\n    for (i = 0; i < numPixels; i++) {\r\n      this.m_imageGrad[i] = 0.0;\r\n      const val = this.m_pixelsSrc[i];\r\n      this.m_imageSrc[i] = val;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n  /**\r\n  * Stop volume smothing by Gauss\r\n  */\r\n  stopImageSmooth() {\r\n    this.m_imageGrad = null;\r\n    this.m_imageSrc = null;\r\n  }\r\n\r\n  applyPartGaussSmooth(zStart, zEnd, rad, sigma) {\r\n    const TWICE = 2;\r\n    const dia = 1 + TWICE * rad;\r\n    // fill gauss matrix\r\n    const THREE_DIMS = 3.0;\r\n    const koef = 1.0 / (THREE_DIMS * sigma * sigma);\r\n    let dx, dy, dz;\r\n    let j = 0;\r\n    if (zStart === 0) {\r\n      const GAUSS_MAX_RAD = 9;\r\n      const GAUSS_MAX_DIA = (1 + TWICE * GAUSS_MAX_RAD);\r\n      this.m_gaussMatrix = new Float32Array(GAUSS_MAX_DIA * GAUSS_MAX_DIA * GAUSS_MAX_DIA);\r\n      let wSum = 0.0;\r\n      for (dz = -rad; dz <= +rad; dz++) {\r\n        const fz = dz / rad;\r\n        for (dy = -rad; dy <= +rad; dy++) {\r\n          const fy = dy / rad;\r\n          for (dx = -rad; dx <= +rad; dx++) {\r\n            const fx = dx / rad;\r\n            const dist2 = fx * fx + fy * fy + fz * fz;\r\n            const weight = Math.exp(-1.0 * dist2 * koef);\r\n            this.m_gaussMatrix[j++] = weight;\r\n            wSum += weight;\r\n          }\r\n        }\r\n      }     // for (dz)\r\n      // normalize weights\r\n      const numGaussElems = dia * dia * dia;\r\n      const gScale = 1.0 / wSum;\r\n      for (j = 0; j < numGaussElems; j++) {\r\n        this.m_gaussMatrix[j] *= gScale;\r\n      }\r\n      const numPixels = this.m_xDim * this.m_yDim * this.m_zDim;\r\n      for (j = 0; j < numPixels; j++) {\r\n        this.m_imageGauss[j] = this.m_imageSrc[j];\r\n      }\r\n    }\r\n    // apply gauss matrix to source image\r\n    const zs = (zStart > rad) ? zStart : rad;\r\n    const ze = (zEnd < this.m_zDim - rad) ? zEnd : (this.m_zDim - rad);\r\n    let cx, cy, cz;\r\n    for (cz = zs; cz < ze; cz++) {\r\n      const czOff = cz * this.m_xDim * this.m_yDim;\r\n      for (cy = rad; cy < this.m_yDim - rad; cy++) {\r\n        const cyOff = cy * this.m_xDim;\r\n        for (cx = rad; cx < this.m_xDim - rad; cx++) {\r\n          let sum = 0.0;\r\n          j = 0;\r\n          for (dz = -rad; dz <= +rad; dz++) {\r\n            const z = cz + dz;\r\n            const zOff = z * this.m_xDim * this.m_yDim;\r\n            for (dy = -rad; dy <= +rad; dy++) {\r\n              const y = cy + dy;\r\n              const yOff = y * this.m_xDim;\r\n              for (dx = -rad; dx <= +rad; dx++) {\r\n                const x = cx + dx;\r\n                const weight = this.m_gaussMatrix[j++];\r\n                const val = this.m_imageSrc[x + yOff + zOff];\r\n                sum += val * weight;\r\n              }   // for (dx)\r\n            }     // for (dy)\r\n          }       // for (dz)\r\n          this.m_imageGauss[cx + cyOff + czOff] = sum;\r\n          // this.m_imageGauss[cx + cyOff + czOff] = 0.0;\r\n        }     // for (cx)\r\n      }       // for (cy)\r\n    }         // for (cz)\r\n  }\r\n\r\n  /**\r\n  * Smooth step\r\n  */\r\n  static smoothStep(minRange, maxRange, arg) {\r\n    let t = (arg - minRange) / (maxRange - minRange);\r\n    t = (t > 0.0) ? t : 0.0;\r\n    t = (t < 1.0) ? t : 1.0;\r\n    const NUM_2 = 2.0;\r\n    const NUM_3 = 3.0;\r\n    const res = t * t * (NUM_3 - NUM_2 * t);\r\n    return res;\r\n  }\r\n\r\n  /**\r\n  * Smooth 1d float array\r\n  */\r\n  static smoothArray(values, numValues, gaussRad, gaussSigma) {\r\n    const dst = new Float32Array(AV_NUM_COLORS);\r\n    const mult = 1.0 / (gaussSigma * gaussSigma);\r\n    for (let ci = 0; ci < numValues; ci++) {\r\n      let sum = 0.0;\r\n      let sumWeight = 0.0;\r\n      for (let di = -gaussRad; di <= +gaussRad; di++) {\r\n        let i = ci + di;\r\n        i = (i >= 0) ? i : 0;\r\n        i = (i < numValues) ? i : (numValues - 1);\r\n        const t = di / gaussRad;\r\n        const weight = 1.0 / Math.exp(t * t * mult);\r\n        sumWeight += weight;\r\n        sum += values[i] * weight;\r\n      }\r\n      const valSmoothed = sum / sumWeight;\r\n      dst[ci] = valSmoothed;\r\n    }\r\n    // copy back\r\n    for (let i = 0; i < numValues; i++) {\r\n      values[i] = dst[i];\r\n    }\r\n  }\r\n\r\n  /**\r\n  * Get histogram from gaussian smoothed image\r\n  * and detect \"dark\" color range\r\n  */\r\n  getHistogram() {\r\n    const MAX_COLOR = 255;\r\n\r\n    let i;\r\n    // clear histogram\r\n    for (i = 0; i < AV_NUM_COLORS; i++) {\r\n      this.m_histogram[i] = 0;\r\n    }\r\n\r\n    const TWO = 2;\r\n    // scan central image part\r\n    const SCAN_RANGE = 4;\r\n    const zMin = Math.floor(this.m_zDim / TWO - SCAN_RANGE);\r\n    const zMax = Math.floor(this.m_zDim / TWO + SCAN_RANGE);\r\n    const yMin = Math.floor(this.m_yDim / TWO - SCAN_RANGE);\r\n    const yMax = Math.floor(this.m_yDim / TWO + SCAN_RANGE);\r\n\r\n    let x, y, z;\r\n    let numPixels = 0;\r\n    for (z = zMin; z < zMax; z++) {\r\n      const zOff = z * this.m_xDim * this.m_yDim;\r\n      for (y = yMin; y < yMax; y++) {\r\n        const yOff = y * this.m_xDim;\r\n        for (x = 0; x < this.m_xDim; x++) {\r\n          const off = x + yOff + zOff;\r\n          let val = this.m_imageGauss[off];\r\n          val = (val < MAX_COLOR) ? val : MAX_COLOR;\r\n          this.m_histogram[Math.floor(val)]++;\r\n          numPixels++;\r\n        } // for (x)\r\n      } // for (y)\r\n    } // for (z)\r\n    // get probabilities of each color in histogram\r\n    for (i = 0; i < AV_NUM_COLORS; i++) {\r\n      const h = this.m_histogram[i];\r\n      this.m_colorProbability[i] = h / numPixels;\r\n    }\r\n\r\n    // smooth prob\r\n    const GAUSS_RAD = 5;\r\n    const GAUSS_SIGMA = 1.6;\r\n    ActiveVolume.smoothArray(this.m_colorProbability, AV_NUM_COLORS, GAUSS_RAD, GAUSS_SIGMA);\r\n\r\n    //\r\n    // Histogram looks like this\r\n    // Brain\r\n    //\r\n    // +----------------------->\r\n    //   ***           ********\r\n    //   *  **  ****   *\r\n    //  *     * *  *  *\r\n    //  *      *    * *\r\n    //  *            *\r\n    //  *\r\n    // *\r\n    // *\r\n    // *\r\n\r\n    // Lungs\r\n    // +----------------------->\r\n    //      *****   **********\r\n    //     *    *  *\r\n    //    *      * *\r\n    // ** *       *\r\n    //  * *\r\n    //  * *\r\n    //  * *\r\n    //   *\r\n    //\r\n\r\n    // Find las local maximum: this is most frequent bright (white) color intensity\r\n    let j;\r\n    let indBrightColor = -1;\r\n    const DIST_DETECT_LOC_MAX = 9;\r\n    for (i = AV_NUM_COLORS - DIST_DETECT_LOC_MAX; i > DIST_DETECT_LOC_MAX; i--) {\r\n      let isLocMax = 1;\r\n      let isLarger = 0;\r\n      for (j = i - DIST_DETECT_LOC_MAX; j <= i + DIST_DETECT_LOC_MAX; j++) {\r\n        if (this.m_colorProbability[i] > this.m_colorProbability[j]) {\r\n          isLarger = 1;\r\n        }\r\n        if (this.m_colorProbability[i] < this.m_colorProbability[j]) {\r\n          isLocMax = 0;\r\n          break;\r\n        }\r\n      } // for (j) around i\r\n      if (isLocMax && isLarger) {\r\n        indBrightColor = i;\r\n        break;\r\n      }\r\n    }\r\n    if (indBrightColor === -1) {\r\n      console.log('Bright color cant be detected !');\r\n    }\r\n    // console.log(`indBrightColor = ${indBrightColor}`);\r\n\r\n    // Find first local maximum\r\n    let indDarkColor = -1;\r\n    for (i = 0; i < indBrightColor; i++) {\r\n      let isLocMax = true;\r\n      let isLarger = false;\r\n      const indScanMin = (i - DIST_DETECT_LOC_MAX >= 0) ? (i - DIST_DETECT_LOC_MAX) : 0;\r\n      const indScanMax = (i + DIST_DETECT_LOC_MAX <= MAX_COLOR) ? (i + DIST_DETECT_LOC_MAX) : MAX_COLOR;\r\n      for (j = indScanMin; j <= indScanMax; j++) {\r\n        if (this.m_colorProbability[i] > this.m_colorProbability[j]) {\r\n          isLarger = true;\r\n        }\r\n        if (this.m_colorProbability[i] < this.m_colorProbability[j]) {\r\n          isLocMax = false;\r\n          break;\r\n        }\r\n      } // for (j) around i\r\n      if (isLocMax && isLarger) {\r\n        indDarkColor = i;\r\n        break;\r\n      }\r\n    } // for (i) ind dark color\r\n    if (indDarkColor === -1) {\r\n      console.log('indDarkColor should not be -1');\r\n    }\r\n    if (indDarkColor >=  indBrightColor) {\r\n      console.log('indDarkColor should not less then indBrightColor');\r\n    }\r\n    // console.log(`indDarkColor = ${indDarkColor}`);\r\n\r\n    // Half of bright color is barrier to detect \"black\" / \"white\" change\r\n    const indBrightHalf = Math.floor(indBrightColor / TWO);\r\n\r\n    // clear histogram\r\n    for (i = 0; i < AV_NUM_COLORS; i++) {\r\n      this.m_histogram[i] = 0;\r\n    }\r\n\r\n    // Get histogram of part image\r\n    numPixels = 0;\r\n    for (z = zMin; z < zMax; z++) {\r\n      const zOff = z * this.m_xDim * this.m_yDim;\r\n      for (y = yMin; y < yMax; y++) {\r\n        const yOff = y * this.m_xDim;\r\n        let isExitFromBrightZoneDetected = false;\r\n        let numPixelsDarkZone = 0;\r\n        for (x = 0; x < this.m_xDim - 1; x++) {\r\n          const off = x + yOff + zOff;\r\n          const valCur = Math.floor(this.m_imageGauss[off + 0]);\r\n          const valNex = Math.floor(this.m_imageGauss[off + 1]);\r\n          const isCurGreat = (valCur > indBrightHalf) ? 1 : 0;\r\n          const isNexLess = (valNex <= indBrightHalf) ? 1 : 0;\r\n          if ((isCurGreat & isNexLess) !== 0) {\r\n            isExitFromBrightZoneDetected = true;\r\n            continue;\r\n          }\r\n          if (isExitFromBrightZoneDetected) {\r\n            const TOO_MUCH_BRIGHT_ZONE = 40;\r\n            if (numPixelsDarkZone > TOO_MUCH_BRIGHT_ZONE) {\r\n              break;\r\n            }\r\n            if (isCurGreat) {\r\n              break;\r\n            }\r\n            numPixelsDarkZone++;\r\n            const valOrig = Math.floor(this.m_pixelsSrc[off + 0]);\r\n            this.m_histogram[valOrig]++;\r\n            numPixels++;\r\n          } // if was exit from bright zone\r\n        } // for (x)\r\n      } // for (y)\r\n    } // for (z)\r\n\r\n    // get probabilities of each color in histogram\r\n    for (i = 0; i < AV_NUM_COLORS; i++) {\r\n      const  h = this.m_histogram[i];\r\n      this.m_colorProbability[i] = h / numPixels;\r\n    }\r\n\r\n    // smooth prob\r\n    const GAUSS_RAD_FOR_LOC = 8;\r\n    const GAUSS_SIGMA_FOR_LOC = 2.4;\r\n    ActiveVolume.smoothArray(this.m_colorProbability, AV_NUM_COLORS, GAUSS_RAD_FOR_LOC, GAUSS_SIGMA_FOR_LOC);\r\n\r\n    // Find first local maximum\r\n    indDarkColor = -1;\r\n    for (i = 0; i < indBrightColor; i++) {\r\n      let isLocMax = true;\r\n      let isLarger = false;\r\n      const indScanMin = (i - DIST_DETECT_LOC_MAX >= 0) ? (i - DIST_DETECT_LOC_MAX) : 0;\r\n      const indScanMax = (i + DIST_DETECT_LOC_MAX <= MAX_COLOR) ? (i + DIST_DETECT_LOC_MAX) : MAX_COLOR;\r\n      for (j = indScanMin; j <= indScanMax; j++) {\r\n        if (this.m_colorProbability[i] > this.m_colorProbability[j]) {\r\n          isLarger = true;\r\n        }\r\n        if (this.m_colorProbability[i] < this.m_colorProbability[j]) {\r\n          isLocMax = false;\r\n          break;\r\n        }\r\n      } // for (j) around i\r\n      if (isLocMax && isLarger) {\r\n        indDarkColor = i;\r\n        break;\r\n      }\r\n    } // for (i) bright color\r\n    // console.log(`indDarkColor = ${indDarkColor}`);\r\n\r\n    // Find next local min\r\n    let indDarkColorMax = -1;\r\n    for (i = indDarkColor + 1; i < indBrightColor; i++) {\r\n      let isLocMin = true;\r\n      let isLess = false;\r\n      const indScanMin = (i - DIST_DETECT_LOC_MAX >= 0) ? (i - DIST_DETECT_LOC_MAX) : 0;\r\n      const indScanMax = (i + DIST_DETECT_LOC_MAX <= MAX_COLOR) ? (i + DIST_DETECT_LOC_MAX) : MAX_COLOR;\r\n      for (j = indScanMin; j <= indScanMax; j++) {\r\n        if (this.m_colorProbability[i] < this.m_colorProbability[j]) {\r\n          isLess = 1;\r\n        }\r\n        if (this.m_colorProbability[i] > this.m_colorProbability[j]) {\r\n          isLocMin = false;\r\n          break;\r\n        }\r\n      } // for (j) around i\r\n      if (isLocMin && isLess) {\r\n        indDarkColorMax = i;\r\n        break;\r\n      }\r\n    }\r\n    if (indDarkColorMax <= indDarkColor) {\r\n      console.log('indDarkColorMax should be more indDarkColor!');\r\n    }\r\n\r\n    if (indDarkColorMax >= indBrightColor) {\r\n      console.log('indDarkColorMax should be less indBrightColor!');\r\n    }\r\n    console.log(`ActiveVolume. Dark colors range is [${indDarkColor}, ${indDarkColorMax}]`);\r\n\r\n    // Make smooth step function for range [indDarkColor .. indDarkColorMax]\r\n    for (i = 0; i < AV_NUM_COLORS; i++) {\r\n      this.m_colorProbability[i] = ActiveVolume.smoothStep(indDarkColor, indDarkColorMax, i);\r\n    }\r\n    // Debug here\r\n    indDarkColorMax++;\r\n    return 1;\r\n  }\r\n\r\n  resetStateForGeoUpdates() {\r\n    this.m_geoStage = 0;\r\n    this.m_state = AV_STATE_UPDATE_GEO;\r\n    this.m_geoRender.createNormalsForGeometry();\r\n  }\r\n\r\n  resetStateToStartUpdates() {\r\n    this.m_geoStage = 0;\r\n    this.m_gaussStage = 0;\r\n    this.m_state = AV_STATE_NOT_STARTED;\r\n  }\r\n\r\n  /**\r\n  * Update render geo\r\n  * @param {object} geo RederGeo to modify\r\n  * @param {number} method Method\r\n  * @return {number} 1, if success. < 0, if failed\r\n  */\r\n  updateGeo(geo, method) {\r\n    if (geo === 'undefined') {\r\n      console.log('ActiveVolume. updateGeo: geo undefined');\r\n      const FAIL_UNDEF = -1;\r\n      return FAIL_UNDEF;\r\n    }\r\n    if (geo === null) {\r\n      console.log('ActiveVolume. updateGeo: geo null');\r\n      const FAIL_NULL = -2;\r\n      return FAIL_NULL;\r\n    }\r\n\r\n    if (this.m_state === AV_STATE_FINISHED) {\r\n      return 1;\r\n    }\r\n    if (this.m_state === AV_STATE_NOT_STARTED) {\r\n      // first update\r\n      const okCreateNormals = geo.createNormalsForGeometry();\r\n      if (okCreateNormals !== 1) {\r\n        console.log('geo.createNormalsForGeometry returned fail');\r\n        return okCreateNormals;\r\n      }\r\n\r\n      this.startImageSmooth();\r\n      this.m_gaussStage = 0;\r\n      this.m_state = AV_STATE_PREPARE_GAUSS;\r\n    }\r\n    if (this.m_state === AV_STATE_PREPARE_GAUSS) {\r\n      const GAUSS_RAD = 2;\r\n      const GAUSS_SIGMA = 1.8;\r\n      const zStart  = Math.floor(this.m_zDim * (this.m_gaussStage + 0) / ActiveVolume.ACT_VOL_NUM_SMOOTH_STAGES);\r\n      const zEnd    = Math.floor(this.m_zDim * (this.m_gaussStage + 1) / ActiveVolume.ACT_VOL_NUM_SMOOTH_STAGES);\r\n      this.applyPartGaussSmooth(zStart, zEnd, GAUSS_RAD, GAUSS_SIGMA);\r\n\r\n      this.m_gaussStage++;\r\n      if (this.m_gaussStage >= ActiveVolume.ACT_VOL_NUM_SMOOTH_STAGES) {\r\n        this.m_state = AV_STATE_PREPARE_UNIFORMITY;\r\n        this.m_uniformityStage = 0;\r\n        console.log('UpdateGeo. AV_STATE_PREPARE_UNIFORMITY.');\r\n        return 1;\r\n      }\r\n    }\r\n    if (this.m_state === AV_STATE_PREPARE_UNIFORMITY) {\r\n      const zStart = Math.floor(this.m_zDim * (this.m_uniformityStage + 0) / ActiveVolume.ACT_VOL_NUM_SMOOTH_STAGES);\r\n      const zEnd   = Math.floor(this.m_zDim * (this.m_uniformityStage + 1) / ActiveVolume.ACT_VOL_NUM_SMOOTH_STAGES);\r\n      const KOEF_UNIFORMITY = 0.07;\r\n      this.makeUniformityImage(this.m_imageGauss, this.m_xDim, this.m_yDim, this.m_zDim,\r\n        zStart, zEnd, this.m_imageGrad, this.m_imageUniformity, KOEF_UNIFORMITY);\r\n      this.m_uniformityStage++;\r\n      if (this.m_uniformityStage >= ActiveVolume.ACT_VOL_NUM_SMOOTH_STAGES) {\r\n        // DEBUG save\r\n        const DEBUG_SAVE_UNI = false;\r\n        if (DEBUG_SAVE_UNI) {\r\n          const TEST_SAVE_UNI_FILE_NAME = 'uni.bmp';\r\n          const TWO = 2;\r\n          const zSlice = this.m_zDim / TWO;\r\n          ActiveVolume.saveVolumeSliceToFile(this.m_imageUniformity,\r\n            this.m_xDim, this.m_yDim, this.m_zDim, zSlice, TEST_SAVE_UNI_FILE_NAME);\r\n        }\r\n\r\n        // finally get image histogram\r\n        // console.log('UpdateGeo. getHistogram...');\r\n        this.getHistogram();\r\n        this.stopImageSmooth();\r\n        this.m_geoStage = 0;\r\n        this.m_state = AV_STATE_UPDATE_GEO;\r\n        // console.log('UpdateGeo. AV_STATE_UPDATE_GEO.');\r\n        return 1;\r\n      }\r\n    }\r\n\r\n    if (this.m_state === AV_STATE_UPDATE_GEO) {\r\n      if (this.m_verticesNew === null) {\r\n        const numVertices = geo.getNumVertices();\r\n        const COORDS_IN_VERTREX = 4;\r\n        this.m_verticesNew = new Float32Array(numVertices * COORDS_IN_VERTREX);\r\n      }\r\n\r\n      const updateNormals       = (method & AV_METHOD_NORMALS) !== 0;\r\n      const updateUniformity    = (method & AV_METHOD_UNIFORMITY) !== 0;\r\n      const updateColorKoefs    = (method & AV_METHOD_COLOR_KOEFS) !== 0;\r\n\r\n      const  SPEED_NORMALS     = 1.1;\r\n      if (updateNormals && !updateUniformity) {\r\n        this.updateGeoByVertexNormals(geo, SPEED_NORMALS);\r\n      }\r\n      if (updateNormals && updateUniformity && !updateColorKoefs) {\r\n        this.updateGeoByVertexNormalsAndUniformity(geo, SPEED_NORMALS);\r\n      }\r\n      if (updateNormals && updateUniformity && updateColorKoefs) {\r\n        const isFinished = this.updateGeoNormalsUniformityColors(geo, SPEED_NORMALS);\r\n        if (isFinished) {\r\n          console.log(`updateGeoNormalsUniformityColors is FINISHED. m_geoStage = ${this.m_geoStage}`);\r\n          this.m_state = AV_STATE_FINISHED;\r\n        }\r\n      }\r\n      this.m_geoStage++;\r\n    } // if state is update geo\r\n    return 1;\r\n  }\r\n\r\n  getAveUniformityForGeoVertices(geo) {\r\n    let i, i4;\r\n    const numVertices = geo.getNumVertices();\r\n    const vertices = geo.getVertices();\r\n    const xyDim = this.m_xDim * this.m_yDim;\r\n    let uniAve = 0.0;\r\n    const NUM_COMPS_VERTEX = 4;\r\n    const OFF_0 = 0;\r\n    const OFF_1 = 1;\r\n    const OFF_2 = 2;\r\n    for (i = 0, i4 = 0; i < numVertices; i++, i4 += NUM_COMPS_VERTEX) {\r\n      // pixel coordinate in the volume\r\n      const x = Math.floor(vertices[i4 + OFF_0]);\r\n      const y = Math.floor(vertices[i4 + OFF_1]);\r\n      const z = Math.floor(vertices[i4 + OFF_2]);\r\n\r\n      const off = x + (y * this.m_xDim) + (z * xyDim);\r\n      const uni = this.m_imageUniformity[off];\r\n      uniAve += uni;\r\n    }\r\n    uniAve /= numVertices;\r\n    return uniAve;\r\n  }\r\n\r\n  finalizeUpdatesGeo(geo, inDebugMode) {\r\n    if (inDebugMode) {\r\n      console.log(`geoUpdates are finished in ${this.m_updateCounter} steps`);\r\n      const FILE_NAME_GEO = 'geo_final.obj';\r\n      geo.saveGeoToObjFile(FILE_NAME_GEO);\r\n    }\r\n  }\r\n\r\n  /**\r\n  * Update geometry with normals, uniformity map and colors distribution\r\n  * @param {object} geo RederGeo to modify\r\n  * @param {number} normalSpeed speed for increase geo size\r\n  */\r\n  updateGeoNormalsUniformityColors(geo, normalSpeed) {\r\n    const numVertices = geo.getNumVertices();\r\n    // float array\r\n    const vertices = geo.getVertices();\r\n    // THREE.Vector3 array\r\n    const normals = geo.getNormals();\r\n    const numTriangles = geo.getNumTriangles();\r\n    const indices = geo.getIndices();\r\n\r\n    // perform laplasian smoother\r\n    // ...\r\n    if (this.m_lapSmoother === null) {\r\n      this.m_lapSmoother = new LaplasianSmoother();\r\n    }\r\n\r\n    this.m_lapSmoother.performSmoothStep(numVertices, vertices, numTriangles, indices, this.m_verticesNew);\r\n\r\n    const DEEP_DEBUG = false;\r\n\r\n    // use smoothed vertices to update geo\r\n    const NUM_COMPS_VERTEX = 4;\r\n    const OFF_0 = 0;\r\n    const OFF_1 = 1;\r\n    const OFF_2 = 2;\r\n    let i, i4;\r\n\r\n    // when sphere touch edges, this definately means iterations end\r\n    let sphereTouchEdge = false;\r\n    // if too much matched, than stop iterations\r\n    // let numMatchedToColor = 0;\r\n\r\n    for (i = 0, i4 = 0; i < numVertices; i++, i4 += NUM_COMPS_VERTEX) {\r\n      let vx = vertices[i4 + OFF_0];\r\n      let vy = vertices[i4 + OFF_1];\r\n      let vz = vertices[i4 + OFF_2];\r\n      const vn = normals[i];\r\n\r\n      // pixel coordinate in the volume\r\n      let x = Math.floor(vx);\r\n      let y = Math.floor(vy);\r\n      let z = Math.floor(vz);\r\n\r\n      if (DEEP_DEBUG && (i === 0)) {\r\n        console.log(`v = ${vx}, ${vy}, ${vz}. int xyz = ${x},${y},${z}`);\r\n        console.log(`vn = ${vn.x}, ${vn.y}, ${vn.z}`);\r\n      }\r\n\r\n      if (x >= this.m_xDim) {\r\n        sphereTouchEdge = true;\r\n        x = this.m_xDim - 1;\r\n      }\r\n      if (y >= this.m_yDim) {\r\n        sphereTouchEdge = true;\r\n        y = this.m_yDim - 1;\r\n      }\r\n      if (z >= this.m_zDim) {\r\n        sphereTouchEdge = true;\r\n        z = this.m_zDim - 1;\r\n      }\r\n      if (x < 0) {\r\n        sphereTouchEdge = true;\r\n        x = 0;\r\n      }\r\n      if (y < 0) {\r\n        sphereTouchEdge = true;\r\n        y = 0;\r\n      }\r\n      if (z < 0) {\r\n        sphereTouchEdge = true;\r\n        z = 0;\r\n      }\r\n\r\n      const xyDim = this.m_xDim * this.m_yDim;\r\n      const off = x + (y * this.m_xDim) + (z * xyDim);\r\n      const uni = this.m_imageUniformity[off];\r\n      const valGaussCur = this.m_imageGauss[off];\r\n\r\n      if (DEEP_DEBUG && (i === 0)) {\r\n        console.log(`uni = ${uni}, valGaussCur = ${valGaussCur}`);\r\n      }\r\n\r\n      let compSum = uni;\r\n      // predict next position\r\n      const NEXT_STEP = 2.5;\r\n      let nx = Math.floor(vx + vn.x * NEXT_STEP);\r\n      let ny = Math.floor(vy + vn.y * NEXT_STEP);\r\n      let nz = Math.floor(vz + vn.z * NEXT_STEP);\r\n\r\n      if (DEEP_DEBUG && (i === 0)) {\r\n        console.log(`nx = ${nx}, ny = ${ny}, nz = ${nz}`);\r\n      }\r\n      if ((nx < 0) || (ny < 0) || (nz < 0) ||\r\n        (nx >= this.m_xDim) || (ny >= this.m_yDim) || (nz >= this.m_zDim)) {\r\n        sphereTouchEdge = true;\r\n      }\r\n      nx = (nx >= 0) ? nx : 0;\r\n      ny = (ny >= 0) ? ny : 0;\r\n      nz = (nz >= 0) ? nz : 0;\r\n      nx = (nx < this.m_xDim) ? nx : (this.m_xDim - 1);\r\n      ny = (ny < this.m_yDim) ? ny : (this.m_yDim - 1);\r\n      nz = (nz < this.m_zDim) ? nz : (this.m_zDim - 1);\r\n\r\n      const nextOff = nx + (ny * this.m_xDim) + (nz * xyDim);\r\n      const valGaussNext = this.m_imageGauss[nextOff];\r\n      const KOEF_GAUSS_DEC_MULT = 0.3;\r\n      if (valGaussNext > valGaussCur) {\r\n        compSum *= KOEF_GAUSS_DEC_MULT;\r\n      }\r\n\r\n      if (DEEP_DEBUG && (i === 0)) {\r\n        console.log(`valGaussNext = ${valGaussNext}`);\r\n      }\r\n\r\n      // use colors\r\n      const koef = this.m_colorProbability[Math.floor(valGaussCur)];\r\n      compSum *= koef;\r\n      const COLOR_MATCH = 0.9;\r\n      const isColorMatch = (koef <= COLOR_MATCH);\r\n      // numMatchedToColor += (isColorMatch) ? 1 : 0;\r\n\r\n      if (DEEP_DEBUG && (i === 0)) {\r\n        console.log(`koef = ${koef}, isColorMatch = ${isColorMatch}`);\r\n      }\r\n\r\n      const vAddSmooth = new THREE.Vector3();\r\n      vAddSmooth.x = this.m_verticesNew[i4 + OFF_0] - vx;\r\n      vAddSmooth.y = this.m_verticesNew[i4 + OFF_1] - vy;\r\n      vAddSmooth.z = this.m_verticesNew[i4 + OFF_2] - vz;\r\n      vAddSmooth.normalize();\r\n      vAddSmooth.multiplyScalar(normalSpeed);\r\n\r\n      const vAddGeo = new THREE.Vector3();\r\n      vAddGeo.x = vn.x * compSum * normalSpeed;\r\n      vAddGeo.y = vn.y * compSum * normalSpeed;\r\n      vAddGeo.z = vn.z * compSum * normalSpeed;\r\n\r\n      if (DEEP_DEBUG && (i === 0)) {\r\n        console.log(`vAddSmooth = ${vAddSmooth.x}, ${vAddSmooth.y}, ${vAddSmooth.z}`);\r\n        console.log(`vAddGeo = ${vAddGeo.x}, ${vAddGeo.y}, ${vAddGeo.z}`);\r\n      }\r\n\r\n      const KOEF_ADD_SMOOTH = 0.3;\r\n      const KOEF_ADD_GEO = (1.0 - KOEF_ADD_SMOOTH);\r\n\r\n      if (isColorMatch) {\r\n        // do nothing\r\n      } else {\r\n        const vNew = new THREE.Vector3();\r\n        vNew.x = vx + vAddGeo.x * KOEF_ADD_GEO + vAddSmooth.x * KOEF_ADD_SMOOTH;\r\n        vNew.y = vy + vAddGeo.y * KOEF_ADD_GEO + vAddSmooth.y * KOEF_ADD_SMOOTH;\r\n        vNew.z = vz + vAddGeo.z * KOEF_ADD_GEO + vAddSmooth.z * KOEF_ADD_SMOOTH;\r\n\r\n        vx = vNew.x; vy = vNew.y;\r\n        vz = vNew.z;\r\n      }\r\n\r\n      this.m_verticesNew[i4 + OFF_0] = vx;\r\n      this.m_verticesNew[i4 + OFF_1] = vy;\r\n      this.m_verticesNew[i4 + OFF_2] = vz;\r\n    } // for i\r\n\r\n    // debug\r\n    // if (numMatchedToColor > 0) {\r\n    //   console.log(`numMatchedToColor = ${numMatchedToColor}. geoStage = ${this.m_geoStage}`);\r\n    // }\r\n\r\n    // copy back\r\n    let errAve = 0.0;\r\n    for (i = 0, i4 = 0; i < numVertices; i++, i4 += NUM_COMPS_VERTEX) {\r\n      // estimate error of modification\r\n      const dx = this.m_verticesNew[i4 + OFF_0] - vertices[i4 + OFF_0];\r\n      const dy = this.m_verticesNew[i4 + OFF_1] - vertices[i4 + OFF_1];\r\n      const dz = this.m_verticesNew[i4 + OFF_2] - vertices[i4 + OFF_2];\r\n      const err = dx * dx + dy * dy + dz * dz;\r\n      errAve += err;\r\n\r\n      vertices[i4 + OFF_0] = this.m_verticesNew[i4 + OFF_0];\r\n      vertices[i4 + OFF_1] = this.m_verticesNew[i4 + OFF_1];\r\n      vertices[i4 + OFF_2] = this.m_verticesNew[i4 + OFF_2];\r\n    }\r\n    errAve /= numVertices;\r\n    errAve = Math.sqrt(errAve);\r\n    const DIF_VERTICES_LIMIT = 0.12;\r\n    if (errAve < DIF_VERTICES_LIMIT) {\r\n      this.finalizeUpdatesGeo(geo, DEEP_DEBUG);\r\n      return true;\r\n    }\r\n    const aveUni = this.getAveUniformityForGeoVertices(geo);\r\n    const MIN_POSSIBLE_UNIFORMITY = 0.60;\r\n    if (aveUni < MIN_POSSIBLE_UNIFORMITY) {\r\n      this.finalizeUpdatesGeo(geo, DEEP_DEBUG);\r\n      return true;\r\n    }\r\n    if (sphereTouchEdge) {\r\n      this.finalizeUpdatesGeo(geo, DEEP_DEBUG);\r\n      return true;\r\n    }\r\n\r\n    const DEEP_ERR_DEBUG = false;\r\n    if (DEEP_ERR_DEBUG) {\r\n      const VERTICES_UNIFORMITY = 1024;\r\n      console.log(`Iters errAve = ${errAve} < ${DIF_VERTICES_LIMIT}. aveUni = ${aveUni} < ${VERTICES_UNIFORMITY}`);\r\n    }\r\n    return false;\r\n  } // updateGeoNormalsUniformityColors\r\n\r\n} // class ActiveVolume\r\n\r\n/** Output flags */\r\nActiveVolume.REMOVE_SKULL = 0;\r\nActiveVolume.CREATE_MASK = 1;\r\n\r\n/** Sphere evolve direction */\r\nActiveVolume.SPHERE_EVOLVE_FROM_INSIDE = 0;\r\nActiveVolume.SPHERE_EVOLVE_FROM_OUTSIDE = 1;\r\n\r\n/** num iteration stages */\r\nActiveVolume.ACT_VOL_NUM_SMOOTH_STAGES = 64;\r\n\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Soble edge detector\r\n* @module demo/engine/imgproc/Sobel\r\n*/\r\n\r\n//\r\n// Sobel edge detectio\r\n//\r\n\r\nconst MAX_SQRT = (5400 * 5400)\r\n\r\nexport default class SobelEdgeDetector {\r\n  constructor() {\r\n    this.m_vol = null;\r\n    this.m_z = -1;\r\n    this.m_iter = -1;\r\n    this.m_pixelsDst = null;\r\n    this.m_sqrtTable = null;\r\n  }\r\n\r\n  getPixelsDst() {\r\n    return this.m_pixelsDst;\r\n  }\r\n\r\n  start(vol) {\r\n    console.assert(vol != null);\r\n    console.assert(vol.m_dataArray !== null);\r\n    this.m_vol = vol;\r\n    this.m_z = 0;\r\n    this.m_iter = 0;\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    this.m_pixelsDst = new Float32Array(xDim * yDim * zDim);\r\n    // create sqrt table\r\n    this.m_sqrtTable = new Float32Array(MAX_SQRT);\r\n    for (let i = 0; i < MAX_SQRT; i++) {\r\n      this.m_sqrtTable[i] = Math.sqrt(i);\r\n    }\r\n  }\r\n\r\n  normalizeDstImage() {\r\n    let valMax = 0.0;\r\n    const xyzDim = this.m_vol.m_xDim * this.m_vol.m_yDim * this.m_vol.m_zDim;\r\n    for (let i = 0; i < xyzDim; i++) {\r\n      const val = this.m_pixelsDst[i];\r\n      valMax = (val > valMax) ? val : valMax;\r\n    } // for i\r\n    valMax += 0.9;\r\n    const scl = 255.0 / valMax;\r\n    for (let i = 0; i < xyzDim; i++) {\r\n      this.m_pixelsDst[i] = Math.floor(this.m_pixelsDst[i] * scl);\r\n    } // for i\r\n  }\r\n\r\n  stop() {\r\n    this.m_pixelsDst = null;\r\n    this.m_sqrtTable = null;\r\n  }\r\n\r\n  // return ratio in [0..1]\r\n  getRatio() {\r\n    const zDim = this.m_vol.m_zDim;\r\n    const ratio01 = this.m_z / zDim;\r\n    return ratio01;\r\n  }\r\n\r\n  isFinished() {\r\n    console.assert(this.m_z >= 0);\r\n    const zDim = this.m_vol.m_zDim;\r\n    if (this.m_z >= zDim) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  // invoked several times externally, until entire image processed\r\n  update() {\r\n    console.assert(this.m_z >= 0);\r\n    console.assert(this.m_pixelsDst !== null);\r\n    const pixelsSrc = this.m_vol.m_dataArray;\r\n\r\n    const xDim = this.m_vol.m_xDim;\r\n    const yDim = this.m_vol.m_yDim;\r\n    const zDim = this.m_vol.m_zDim;\r\n    const xyDim = xDim * yDim;\r\n\r\n    const STEP = 24;\r\n    const zNext = Math.floor((this.m_iter + 1) * zDim / STEP);\r\n    // console.log('Sobel update z from ' + this.m_z.toString() + ' until ' + zNext.toString());\r\n\r\n    // let maxSqrt = 0;\r\n\r\n    // update all z slices from this.m_z to zNext\r\n    let off = this.m_z * xyDim;\r\n    for (let z = this.m_z; z < zNext; z++) {\r\n      for (let y = 0; y < yDim; y++) {\r\n        for (let x = 0; x < xDim; x++) {\r\n          let sumDx = 0.0, sumDy = 0.0, sumDz = 0.0;\r\n          for (let dz = -1; dz <= +1; dz++) {\r\n            let zz = z + dz;\r\n            zz = (zz >= 0) ? zz : 0;\r\n            zz = (zz < zDim) ? zz : (zDim - 1);\r\n            const zzOff = zz * xyDim;\r\n            for (let dy = -1; dy <= +1; dy++) {\r\n              let yy = y + dy;\r\n              yy = (yy >= 0) ? yy : 0;\r\n              yy = (yy < yDim) ? yy : (yDim - 1);\r\n              const yyOff = yy * xDim;\r\n              for (let dx = -1; dx <= +1; dx++) {\r\n                let xx = x + dx;\r\n                xx = (xx >= 0) ? xx : 0;\r\n                xx = (xx < xDim) ? xx : (xDim - 1);\r\n  \r\n                const val = pixelsSrc[xx + yyOff + zzOff];\r\n  \r\n                let kx = 1;\r\n                if (dy === 0)\r\n                  kx *= 2;\r\n                if (dz === 0)\r\n                  kx *= 2;\r\n                sumDx += dx * val * kx;\r\n  \r\n                let ky = 1;\r\n                if (dx === 0)\r\n                  ky *= 2;\r\n                if (dz === 0)\r\n                  ky *= 2;\r\n                sumDy += dy * val * ky;\r\n  \r\n                let kz = 1;\r\n                if (dx === 0)\r\n                  kz *= 2;\r\n                if (dy === 0)\r\n                  kz *= 2;\r\n                sumDz += dz * val * kz;\r\n  \r\n              } // for dx\r\n            } // for dy\r\n          } // for dz\r\n\r\n          // tricky fast convert float to int (for positive values only)\r\n          const dotProd = (sumDx * sumDx + sumDy * sumDy + sumDz * sumDz) | 0;\r\n          console.assert(dotProd < MAX_SQRT);\r\n\r\n          this.m_pixelsDst[off] = this.m_sqrtTable[dotProd];\r\n          off++;\r\n  \r\n        } // for x\r\n      } // for y\r\n    } // for z all slices\r\n\r\n    // console.log('max sqrt = ' + maxSqrt.toString());\r\n\r\n    // update iteration parameters\r\n    this.m_iter += 1;\r\n    this.m_z = zNext;\r\n  }\r\n}\r\n","//\r\n// Bilateral filter for 3d iamge using render and shader \r\n// \r\n\r\nimport * as THREE from 'three';\r\nimport GlSelector from '../GlSelector';\r\n\r\n// Shaders\r\n\r\nconst s_shaderVertex = `\r\nvarying vec2 texCoord;\r\nvoid main() {\r\n  texCoord = position.xy + vec2(0.5, 0.5);\r\n  gl_Position = vec4(position * 2.0, 1.0);\r\n}\r\n`;\r\n\r\nconst s_shaderFragment = `\r\nvarying vec2 texCoord;\r\nprecision highp sampler3D;\r\nuniform sampler3D texVolume;\r\nuniform vec3 texelSize;\r\nuniform float volumeSizeZ;\r\nuniform float distSigma;\r\nuniform float valSigma;\r\nuniform float kernelSize;\r\nuniform float xDim;\r\nuniform float yDim;\r\nuniform float curZ;\r\n\r\nfloat filterBlur(vec3 base)\r\n{\r\n  float koefDist = 1.0 / (3.0 * distSigma * distSigma);\r\n  float koefVal = 1.0 / (valSigma * valSigma);\r\n  float valCenter = texture(texVolume, base + vec3(0.5, 0.5, 0.5)).r;\r\n  float sumWeights = 0.0;\r\n  float acc = 0.0;\r\n\r\n  float range = kernelSize;\r\n  float rangePlusHalf = range + 0.5;\r\n\r\n  for (float i = -range; i < rangePlusHalf; i += 1.0) {\r\n    float tz = i / range;\r\n    for (float j = -range; j < rangePlusHalf; j += 1.0) {\r\n      float ty = j / range;\r\n      for (float k = -range; k < rangePlusHalf; k += 1.0)\r\n      {\r\n        float tx = k / range;\r\n        vec3 texc = base + vec3(texelSize.x * i, texelSize.y * j, texelSize.z * k);\r\n        texc = texc + vec3(0.5, 0.5, 0.5);\r\n        texc = clamp(texc, vec3(0.0, 0.0, 0.0), vec3(1.0 - texelSize.x, 1.0 - texelSize.y, 1.0 - texelSize.z));\r\n        float curVal = texture(texVolume, texc).r;\r\n        float deltaVal = (curVal - valCenter) / 256.0;\r\n        float weightDist = exp( -(tx * tx + ty * ty + tz * tz) * koefDist);\r\n        float weightVal = exp( -(deltaVal * deltaVal) * koefVal );\r\n        float weight = weightDist * weightVal;\r\n        // float weight = weightDist;\r\n        acc += curVal * weight;\r\n        sumWeights += weight;\r\n      } // for x\r\n    } // for j\r\n  } // for i\r\n\r\n  // get weighted result intencity\r\n  acc = acc / sumWeights;\r\n  return acc;\r\n  //return valCenter;\r\n}\r\n\r\nvoid main() {\r\n  vec3 base;\r\n  base.xy = texCoord;\r\n  base.z = curZ;\r\n  base = base - vec3(0.5, 0.5, 0.5);\r\n  float val = filterBlur(base);\r\n  gl_FragColor = vec4(val, val, val, 1);\r\n}\r\n\r\n`;\r\n\r\nexport default class BilateralHW {\r\n  constructor() {\r\n    this.m_strShaderVertex = s_shaderVertex;\r\n    this.m_strShaderFragment = s_shaderFragment;\r\n    this.m_bufferTextureCPU = null;\r\n    this.m_iter = 0;\r\n    this.m_z = 0;\r\n    const VOL_SIZE_Z = 256.0;\r\n    const DIST_SIGMA = 0.8;\r\n    const VAL_SIGMA = 1.6;\r\n    this.m_uniforms = {\r\n      texVolume: { type: 't', value: null },\r\n      texelSize: { type: 'v3', value: null },\r\n      volumeSizeZ: { type: 'f', value: VOL_SIZE_Z },\r\n      xDim: { type: 'f', value: VOL_SIZE_Z },\r\n      yDim: { type: 'f', value: VOL_SIZE_Z },\r\n      distSigma:   { type: 'f', value: DIST_SIGMA },\r\n      valSigma:   { type: 'f', value: VAL_SIGMA },\r\n      curZ: { type: 'f', value: 0.0 },\r\n      kernelSize: { type: 'f', value: 0.0 },\r\n    };\r\n    this.m_defines = {\r\n      useWebGL2: 1,\r\n    };\r\n  } // end constructor\r\n\r\n  getImageDst() {\r\n    return this.m_bufferTextureCPU;\r\n  }\r\n\r\n  // check is iters finished\r\n  isFinished() {\r\n    if (this.m_z >= this.m_zDim) {\r\n      return true;\r\n    }    \r\n    return false;\r\n  }\r\n\r\n  update() {\r\n    const zDim = this.m_zDim;\r\n    const STEP = (zDim > 16 ) ? 24 : 2;\r\n    const zNext = Math.floor((this.m_iter + 1) * zDim / STEP);\r\n\r\n    const VAL_4 = 4;\r\n\r\n    let valMax = 0;\r\n    for (let z = this.m_z; z < zNext; z++) {\r\n      this.m_material.uniforms.curZ.value = z / this.m_zDim;\r\n      this.m_material.uniforms.curZ.needsUpdate = true;\r\n\r\n      this.rendererBlur.render(this.sceneBlur, this.cameraOrtho, this.bufferTexture);\r\n      this.gl.readPixels(0, 0, this.m_xDim, this.m_yDim, this.gl.RGBA, this.gl.UNSIGNED_BYTE, this.m_frameBuf);\r\n      const zOffs = z * this.m_xDim * this.m_yDim;\r\n      for (let y = 0; y < this.m_yDim; y++) {\r\n        const yOff = y * this.m_xDim;\r\n        for (let x = 0; x < this.m_xDim; x++) {\r\n          const val = this.m_frameBuf[VAL_4 * (x + yOff)];\r\n          this.m_bufferTextureCPU[x + yOff + zOffs] = val;\r\n          valMax = (val > valMax) ? val : valMax;\r\n        } // for x\r\n      } // for y\r\n    } // for z\r\n    // console.log('val max = ' + valMax.toString());\r\n    // update iteration parameters\r\n    this.m_iter += 1;\r\n    this.m_z = zNext;\r\n  }\r\n\r\n  // before iterative renders\r\n  setVolumeTextureWebGL2(distSigma, valSigma) {\r\n    this.m_material.uniforms.distSigma.value = distSigma;\r\n    this.m_material.uniforms.distSigma.needsUpdate = true;\r\n    this.m_material.uniforms.valSigma.value = valSigma;\r\n    this.m_material.uniforms.valSigma.needsUpdate = true;\r\n\r\n    this.m_z = 0;\r\n    this.m_iter = 0;\r\n    const VAL_4 = 4;\r\n    this.m_frameBuf = new Uint8Array(VAL_4 * this.m_xDim * this.m_yDim);\r\n    this.gl = this.rendererBlur.getContext();\r\n  }\r\n\r\n  // create camera , context\r\n  initRenderer(distSigma, valSigma) {\r\n    this.sceneBlur = new THREE.Scene();\r\n    // eslint-disable-next-line\r\n    this.cameraOrtho = new THREE.OrthographicCamera(\r\n      -this.m_xDim / 2, +this.m_xDim / 2, \r\n      +this.m_yDim / 2, -this.m_yDim / 2, \r\n      0.1, 100);\r\n    const glSelector = new GlSelector();\r\n    this.context = glSelector.createWebGLContext();\r\n    this.canvas3d = glSelector.getCanvas();\r\n    this.rendererBlur = new THREE.WebGLRenderer({\r\n      canvas: this.canvas3d,\r\n      context: this.context\r\n    });\r\n\r\n    const geometryBlur = new THREE.PlaneGeometry(1.0, 1.0);\r\n    this.rendererBlur.setSize(this.m_xDim, this.m_yDim);\r\n    const mesh = new THREE.Mesh(geometryBlur, this.m_material);\r\n\r\n    this.m_uniforms.volumeSizeZ.value = this.m_zDim;\r\n    this.m_uniforms.xDim.value = this.m_xDim;\r\n    this.m_uniforms.yDim.value = this.m_yDim;\r\n    this.m_defines.useWebGL2 = 1;\r\n    this.sceneBlur.add(mesh);\r\n\r\n    this.m_material.needsUpdate = true;\r\n\r\n    // render with blur and copy pixels back to this.bufferRgba\r\n    this.setVolumeTextureWebGL2(distSigma, valSigma);\r\n  }\r\n\r\n  // create renderer\r\n  // koefDist in 0.5 .. 3.0\r\n  // koefVal in 0.1 .. 4.0\r\n  // \r\n  //                | koefDist = 0.5  | koefDist = 3.0\r\n  // ---------------+-----------------+----------------\r\n  // koefVal = 0.1  | orig            | Nice without noise \r\n  // koefVal = 4.0  | orig            | Blurred\r\n  //\r\n  //\r\n  create(volume, texelSize, kernelSize, koefDist, koefVal = 0.1) {\r\n\r\n    const distSigma = (1.0 / kernelSize) * koefDist;\r\n    const valSigma = (1.0 / 256.0) * koefVal;\r\n    console.log('BilateralHW params: kernel=' + kernelSize.toString() +  ' dist sigma=' + distSigma.toString() + ' val sigma=' + valSigma.toString() );\r\n    const xDim = volume.m_xDim;\r\n    const yDim = volume.m_yDim;\r\n    const zDim = volume.m_zDim;\r\n    this.m_xDim = xDim;\r\n    this.m_yDim = yDim;\r\n    this.m_zDim = zDim;\r\n    // create volume textures\r\n    const arrPixels = volume.m_dataArray;\r\n    // bufferTextureCPU: here will be render result\r\n    this.m_bufferTextureCPU = new Uint8Array(this.m_xDim * this.m_yDim * this.m_zDim);\r\n    this.bufferR = new Uint8Array(this.m_xDim * this.m_yDim * this.m_zDim);\r\n    const xyzDim = xDim * yDim * zDim;\r\n    for (let i = 0; i < xyzDim; i++) {\r\n      this.m_bufferTextureCPU[i] = arrPixels[i];\r\n      this.bufferR[i] = arrPixels[i];\r\n    }\r\n    this.bufferTexture = new THREE.WebGLRenderTarget(this.m_xDim, this.m_yDim, {\r\n      minFilter: THREE.LinearFilter,\r\n      magFilter: THREE.LinearFilter,\r\n      format: THREE.RGBAFormat,\r\n      type: THREE.UnsignedByteType,\r\n      depthBuffer: false,\r\n    });\r\n    // Source texture, used in rendering: assigned as a texture in shader\r\n    this.origVolumeTex = new THREE.DataTexture3D(this.bufferR, this.m_xDim, this.m_yDim, this.m_zDim);\r\n    this.origVolumeTex.format = THREE.RedFormat;\r\n    this.origVolumeTex.type = THREE.UnsignedByteType;\r\n    this.origVolumeTex.wrapR = THREE.ClampToEdgeWrapping;\r\n    this.origVolumeTex.wrapS = THREE.ClampToEdgeWrapping;\r\n    this.origVolumeTex.wrapT = THREE.ClampToEdgeWrapping;\r\n    this.origVolumeTex.magFilter = THREE.NearestFilter;//THREE.LinearFilter;\r\n    this.origVolumeTex.minFilter = THREE.NearestFilter;//THREE.LinearFilter;\r\n    this.origVolumeTex.needsUpdate = true;\r\n  \r\n    // compile shaders\r\n    this.m_material = new THREE.ShaderMaterial({\r\n      uniforms: this.m_uniforms,\r\n      defines: this.m_defines,\r\n      vertexShader: this.m_strShaderVertex,\r\n      fragmentShader: this.m_strShaderFragment\r\n    });\r\n\r\n    this.m_uniforms.texVolume.value = this.origVolumeTex;\r\n    this.m_uniforms.texelSize.value = texelSize;\r\n    this.m_uniforms.kernelSize.value = kernelSize;\r\n\r\n    if (this.m_zDim >= 1) {\r\n      this.initRenderer(distSigma, valSigma);\r\n    }\r\n    return this.m_bufferTextureCPU;\r\n  } // end create\r\n\r\n} // end class\r\n","/*\r\nLicensed to the Apache Software Foundation (ASF) under one\r\nor more contributor license agreements.  See the NOTICE file\r\ndistributed with this work for additional information\r\nregarding copyright ownership.  The ASF licenses this file\r\nto you under the Apache License, Version 2.0 (the\r\n\"License\"); you may not use this file except in compliance\r\nwith the License.  You may obtain a copy of the License at\r\n\r\n  http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing,\r\nsoftware distributed under the License is distributed on an\r\n\"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\r\nKIND, either express or implied.  See the License for the\r\nspecific language governing permissions and limitations\r\nunder the License.\r\n*/\r\n\r\n/**\r\n* Gauss filtering\r\n* @module demo/engine/imgproc/Gauss\r\n*/\r\n\r\nimport * as THREE from 'three';\r\n\r\nimport Volume from '../Volume';\r\nimport BilateralHW from './BilateralHW';\r\n\r\n//\r\n// Gauss edge detectio\r\n//\r\nclass GaussSmoother {\r\n  constructor(needHw = false) {\r\n    this.m_needHw = needHw;\r\n    this.m_vol = null;\r\n    this.m_z = -1;\r\n    this.m_iter = -1;\r\n    this.m_pixelsDst = null;\r\n    this.m_kernel = null;\r\n    this.m_bilateralHw = null;\r\n  }\r\n\r\n  getPixelsDst() {\r\n    if (this.m_needHw) {\r\n      const arr = this.m_bilateralHw.getImageDst();\r\n      return arr;\r\n    }\r\n    return this.m_pixelsDst;\r\n  }\r\n\r\n  createKernel(kernelSize, sigma) {\r\n    const side      = kernelSize * 2 + 1;\r\n    const xyzKernel = side * side * side;\r\n    const arr = new Float32Array(xyzKernel);\r\n  \r\n    const mult = 1.0 / (2.0 * sigma * sigma);\r\n  \r\n    let off = 0;\r\n    let sum = 0.0;\r\n    for (let dz = -kernelSize; dz <= +kernelSize; dz++)\r\n    {\r\n      const tz = dz / kernelSize;\r\n      for (let dy = -kernelSize; dy <= +kernelSize; dy++)\r\n      {\r\n        const ty = dy / kernelSize;\r\n        for (let dx = -kernelSize; dx <= +kernelSize; dx++)\r\n        {\r\n          const tx = dx / kernelSize;\r\n          const w = Math.exp(-(tx * tx + ty * ty + tz * tz) * mult);\r\n          arr[off++] = w;\r\n          sum += w;\r\n        } // for dx\r\n      } // for dy\r\n    } // for dz\r\n  \r\n    // normalize arr\r\n    const scl = 1.0 / sum;\r\n    for (let i = 0; i < xyzKernel; i++)\r\n      arr[i] *= scl;\r\n    this.m_kernel = arr;\r\n  }\r\n\r\n  start(vol, kernelSize, koefDist, koefVal = 0.1) {\r\n    const sigmaDist = (1.0 / kernelSize) * koefDist;\r\n    this.createKernel(kernelSize, sigmaDist);\r\n    this.m_kernelSize = kernelSize;\r\n    console.assert(vol != null);\r\n    console.assert(vol.m_dataArray !== null);\r\n    this.m_vol = vol;\r\n    this.m_z = 0;\r\n    this.m_iter = 0;\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    this.m_pixelsDst = new Float32Array(xDim * yDim * zDim);\r\n\r\n    // start perform hardware gauss filtering\r\n    if (this.m_needHw) {\r\n      this.m_bilateralHw = new BilateralHW();\r\n      const vTexelSize = new THREE.Vector3(1.0 / xDim, 1.0 / yDim, 1.0 / zDim);\r\n      this.m_bilateralHw.create(vol, vTexelSize, kernelSize, koefDist, koefVal);\r\n    } // if HW gauss\r\n\r\n  }\r\n\r\n  normalizeDstImage() {\r\n    if (this.m_needHw) {\r\n      return;\r\n    }\r\n\r\n    let valMax = 0.0;\r\n    const xyzDim = this.m_vol.m_xDim * this.m_vol.m_yDim * this.m_vol.m_zDim;\r\n    for (let i = 0; i < xyzDim; i++) {\r\n      const val = this.m_pixelsDst[i];\r\n      valMax = (val > valMax) ? val : valMax;\r\n    } // for i\r\n    valMax += 0.9;\r\n    const scl = 255.0 / valMax;\r\n    for (let i = 0; i < xyzDim; i++) {\r\n      this.m_pixelsDst[i] = Math.floor(this.m_pixelsDst[i] * scl);\r\n    } // for i\r\n  }\r\n\r\n  stop() {\r\n    this.m_pixelsDst = null;\r\n    this.m_kernel = null;\r\n  }\r\n\r\n  // return ratio in [0..1]\r\n  getRatio() {\r\n    const zDim = this.m_vol.m_zDim;\r\n    let ratio01 = 0.0; \r\n    if (this.m_needHw) {\r\n      ratio01 = this.m_bilateralHw.m_z / zDim;\r\n    } else {\r\n      ratio01 = this.m_z / zDim;\r\n    }\r\n    return ratio01;\r\n  }\r\n\r\n  isFinished() {\r\n    console.assert(this.m_z >= 0);\r\n    const zDim = this.m_vol.m_zDim;\r\n    if (this.m_needHw) {\r\n      if (this.m_bilateralHw.m_z >= zDim) {\r\n        return true;\r\n      } \r\n    } else {\r\n      if (this.m_z >= zDim) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  // invoked several times externally, until entire image processed\r\n  update() {\r\n    if (this.m_needHw) {\r\n      this.m_bilateralHw.update();\r\n      return;\r\n    }\r\n    // perform slow software gauss update with portion of slices\r\n    console.assert(this.m_z >= 0);\r\n    console.assert(this.m_pixelsDst !== null);\r\n    const pixelsSrc = this.m_vol.m_dataArray;\r\n\r\n    const xDim = this.m_vol.m_xDim;\r\n    const yDim = this.m_vol.m_yDim;\r\n    const zDim = this.m_vol.m_zDim;\r\n    const xyDim = xDim * yDim;\r\n\r\n    const STEP = (zDim > 16 ) ? 24 : 2;\r\n    const zNext = Math.floor((this.m_iter + 1) * zDim / STEP);\r\n    // console.log('Gauss update z from ' + this.m_z.toString() + ' until ' + zNext.toString());\r\n\r\n    const arrKernel = this.m_kernel;\r\n    const kernelSize = this.m_kernelSize;\r\n\r\n    // update all z slices from this.m_z to zNext\r\n    let off = this.m_z * xyDim;\r\n    for (let z = this.m_z; z < zNext; z++) {\r\n      for (let y = 0; y < yDim; y++) {\r\n        for (let x = 0; x < xDim; x++) {\r\n          // process pixel (x,y,z)\r\n          let sum = 0.0;\r\n          let offKer = 0;\r\n          for (let dz = -kernelSize; dz <= +kernelSize; dz++) {\r\n            let zz = z + dz;\r\n            zz = (zz >= 0) ? zz : 0;\r\n            zz = (zz < zDim) ? zz : (zDim - 1);\r\n            const zzOff = zz * xyDim;\r\n            for (let dy = -kernelSize; dy <= +kernelSize; dy++) {\r\n              let yy = y + dy;\r\n              yy = (yy >= 0) ? yy : 0;\r\n              yy = (yy < yDim) ? yy : (yDim - 1);\r\n              const yyOff = yy * xDim;\r\n              for (let dx = -kernelSize; dx <= +kernelSize; dx++) {\r\n                let xx = x + dx;\r\n                xx = (xx >= 0) ? xx : 0;\r\n                xx = (xx < xDim) ? xx : (xDim - 1);\r\n  \r\n                sum += arrKernel[offKer] * pixelsSrc[xx + yyOff + zzOff];\r\n                offKer++;\r\n  \r\n              } // for dx\r\n            } // for dy\r\n          } // for dz\r\n          this.m_pixelsDst[off] = sum;\r\n          off++;\r\n  \r\n        } // for x\r\n      } // for y\r\n    } // for z all slices\r\n\r\n    // console.log('max sqrt = ' + maxSqrt.toString());\r\n\r\n    // update iteration parameters\r\n    this.m_iter += 1;\r\n    this.m_z = zNext;\r\n  }\r\n\r\n  testSimple() {\r\n    // create simple small volume\r\n    const SZ = 16;\r\n    const HALF_SZ = SZ / 2;\r\n    const volume = new Volume();\r\n    volume.createEmptyBytesVolume(SZ, SZ, SZ);\r\n    let offDst = 0;\r\n    const pixelsSrc = volume.m_dataArray;\r\n    for (let z = 0; z < SZ; z++) {\r\n      for (let y = 0; y < SZ; y++) {\r\n        for (let x = 0; x < SZ; x++) {\r\n          pixelsSrc[offDst++] = (z < HALF_SZ) ? 0 : 255;\r\n        }\r\n      }\r\n    }\r\n    // apply gauss\r\n    const kernelSize = 2;\r\n    const sigma = kernelSize / 6.0;\r\n    this.start(volume, kernelSize, sigma);\r\n    while (!this.isFinished()) {\r\n      this.update();\r\n    }\r\n    // gauss.normalizeDstImage();\r\n    const pixelsDst = this.getPixelsDst();\r\n    // check some pixels\r\n    const xOff = HALF_SZ;\r\n    const yOff = HALF_SZ * SZ;\r\n    const xyDim = SZ * SZ;\r\n    let valPrev = -1;\r\n    for (let z = 0; z < SZ; z++) {\r\n      const srcVal = pixelsSrc[xOff + yOff + z * xyDim];\r\n      const val = pixelsDst[xOff + yOff + z * xyDim];\r\n      console.log('src val / gauss val = ' + srcVal.toString() + ' / ' + val.toString());\r\n      const isGood = (val >= valPrev) ? true : false;\r\n      if (!isGood) {\r\n        console.log('gauss test failed');\r\n      }\r\n      valPrev = val;\r\n    } // for z\r\n    this.stop();\r\n    console.log('gauss test completed on a small volume');\r\n\r\n  } // end test simple\r\n\r\n} // end class\r\n\r\nexport default GaussSmoother;\r\n","/**\r\n * @fileOverview UiModalBilateral\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport { Modal, Button, Form, Row, Col, Table } from 'react-bootstrap';\r\nimport Nouislider from 'react-nouislider';\r\n\r\nimport GaussSmoother from '../engine/imgproc/Gauss';\r\n\r\nimport StoreActionType from '../store/ActionTypes';\r\nimport Texture3D from '../engine/Texture3D';\r\nimport ModeView from '../store/ModeView';\r\nimport Modes3d from '../store/Modes3d';\r\n\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\nclass UiModalBilateral extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.onModalShow = this.onModalShow.bind(this);\r\n    this.onModalHide = this.onModalHide.bind(this);\r\n    this.onButtonStart = this.onButtonStart.bind(this);\r\n    this.onChangeSliderKoefDist = this.onChangeSliderKoefDist.bind(this);\r\n    this.onChangeSliderKoefVal = this.onChangeSliderKoefVal.bind(this);\r\n\r\n    this.onBilateralCallback = this.onBilateralCallback.bind(this);\r\n\r\n    this.m_hideFunc = null;\r\n    this.m_gauss = null;\r\n\r\n    this.state = {\r\n      showModalGauss: false,\r\n      text: 'dump'\r\n    };\r\n\r\n    this.m_kernelSize = 10;\r\n    this.m_koefDist = 3.0;\r\n    this.m_koefVal = 0.1;\r\n  } // end constr\r\n\r\n  //\r\n  //\r\n  //\r\n  onButtonStart() {\r\n    console.log('on button start Bilateral with kernel = ' + this.m_kernelSize.toString());\r\n    this.m_hideFunc();\r\n\r\n    const store = this.props;\r\n\r\n    const volSet = store.volumeSet;\r\n    const volIndex = store.volumeIndex;\r\n    const vol = volSet.getVolume(volIndex);\r\n\r\n    if ((vol === undefined) || (vol === null)) {\r\n      console.log('onButtonSobel: no volume!');\r\n      return;\r\n    }\r\n    this.m_vol = vol;\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    if (xDim * yDim * zDim < 1) {\r\n      console.log(`onButtonBilateral: bad volume! dims = ${xDim}*${yDim}*${zDim}`);\r\n      return;\r\n    }\r\n    // let volTextureSrc = vol.m_dataArray;\r\n    const ONE = 1;\r\n    if (vol.m_bytesPerVoxel !== ONE) {\r\n      console.log('onButtonBilateral: supported only 1bpp volumes');\r\n      return;\r\n    }\r\n\r\n    console.log('onButtonBilateral: start 3d bilateral filtration...');\r\n    //const xyzDim = xDim * yDim * zDim;\r\n    //const volTextureDst = new Uint8Array(xyzDim);\r\n\r\n    const NEED_HW = true;\r\n    const gauss = new GaussSmoother(NEED_HW);\r\n\r\n    // test\r\n    // gauss.testSimple();\r\n\r\n    const kernelSize = this.m_kernelSize;\r\n    gauss.start(vol, kernelSize, this.m_koefDist, this.m_koefVal);\r\n    this.m_gauss = gauss;\r\n\r\n    const uiApp = store.uiApp;\r\n    uiApp.doShowProgressBar('Apply bilateral filter...');\r\n    uiApp.doSetProgressBarRatio(0.0);\r\n\r\n    const UPDATE_DELAY_MSEC = 150;\r\n    this.m_timerId = setTimeout(this.onBilateralCallback, UPDATE_DELAY_MSEC);\r\n  }\r\n\r\n  //\r\n  // callback for periodicallt invoke sobel 3d volume filtering\r\n  //\r\n  onBilateralCallback() {\r\n    this.m_gauss.update();\r\n\r\n    const store = this.props;\r\n\r\n    let ratioUpdate = this.m_gauss.getRatio();\r\n    ratioUpdate = (ratioUpdate < 1.0) ? ratioUpdate : 1.0;\r\n    ratioUpdate *= 100;\r\n    ratioUpdate = Math.floor(ratioUpdate);\r\n    // console.log('ratio = ' + ratioUpdate.toString() );\r\n\r\n    const uiApp = store.uiApp;\r\n    uiApp.doSetProgressBarRatio(ratioUpdate);\r\n\r\n    const isFinished = this.m_gauss.isFinished();\r\n\r\n    if (isFinished) {\r\n      console.log('onBilateralCallback: iters finished!');\r\n      uiApp.doHideProgressBar();\r\n\r\n      clearInterval(this.m_timerId);\r\n      this.m_timerId = 0;\r\n\r\n      const volSet = store.volumeSet;\r\n      const volIndex = store.volumeIndex;\r\n      const vol = volSet.getVolume(volIndex);\r\n\r\n      const xDim = vol.m_xDim;\r\n      const yDim = vol.m_yDim;\r\n      const zDim = vol.m_zDim;\r\n      const xyzDim = xDim * yDim * zDim;\r\n      const pixelsDst = this.m_gauss.getPixelsDst()\r\n      for (let i = 0; i < xyzDim; i++) {\r\n        vol.m_dataArray[i] = Math.floor(pixelsDst[i]);\r\n      } // for i\r\n      this.m_gauss.stop();\r\n\r\n      // rebuild 3d data\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_SET, volumeSet: volSet });\r\n      store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: true });\r\n      const tex3d = new Texture3D();\r\n      tex3d.createFromRawVolume(vol);\r\n      store.dispatch({ type: StoreActionType.SET_TEXTURE3D, texture3d: tex3d });\r\n      store.dispatch({ type: StoreActionType.SET_MODE_VIEW, modeView: ModeView.VIEW_2D });\r\n      store.dispatch({ type: StoreActionType.SET_MODE_3D, mode3d: Modes3d.RAYCAST });\r\n    } // if finished\r\n    // update render\r\n    store.graphics2d.forceUpdate();\r\n    // next update timer\r\n    if (!isFinished) {\r\n      const UPDATE_DELAY_MSEC = 150;\r\n      this.m_timerId = setTimeout(this.onBilateralCallback, UPDATE_DELAY_MSEC);\r\n    }\r\n  } // end onBilateralCallback\r\n\r\n  //\r\n  onModalShow() {\r\n    this.setState({ showModalGauss: true });\r\n  }\r\n\r\n  onModalHide() {\r\n    this.setState({ showModalGauss: false });\r\n  }\r\n\r\n  handleFormSubmit(evt) {\r\n    evt.preventDefault();\r\n    this.m_hideFunc();\r\n    // this.onSaveNifti();\r\n  }\r\n\r\n  onChangeSliderKoefDist() {\r\n    if (this.refs === undefined) {\r\n      return;\r\n    }\r\n    this.m_updateEnable = false;\r\n    let val = 0.0;\r\n    const aval = this.refs.slider1.slider.get();\r\n    if (typeof (aval) === 'string') {\r\n      val = Number.parseFloat(aval);\r\n      this.m_koefDist = val;\r\n    }\r\n  }\r\n\r\n  onChangeSliderKoefVal() {\r\n    if (this.refs === undefined) {\r\n      return;\r\n    }\r\n    this.m_updateEnable = false;\r\n    let val = 0.0;\r\n    const aval = this.refs.slider2.slider.get();\r\n    if (typeof (aval) === 'string') {\r\n      val = Number.parseFloat(aval);\r\n      this.m_koefVal = val;\r\n    }\r\n  }\r\n\r\n  //\r\n  render() {\r\n    const stateVis = this.props.stateVis;\r\n    const onHideFunc = this.props.onHide;\r\n    this.m_hideFunc = onHideFunc;\r\n\r\n    const strSlider1 = 'slider1';\r\n    const strSlider2 = 'slider2';\r\n    const defaultDist = 3;\r\n    const defaultVal = 0.1;\r\n    const wArrDist = [defaultDist];\r\n    const wArrVal = [defaultVal];\r\n\r\n    const valToolTps = true;\r\n\r\n    const jsxModalGauss =\r\n    <Modal show={stateVis} onHide={onHideFunc} >\r\n\r\n      <Modal.Title>\r\n        Bilateral filtration\r\n      </Modal.Title>\r\n\r\n      <Modal.Body>\r\n\r\n        <Table>\r\n          <tbody>\r\n\r\n            <tr>\r\n              <td style={{ paddingBottom: '32px' }}>\r\n                Select koefficient distance (kd)\r\n              </td>\r\n            </tr>\r\n\r\n            <tr>\r\n              <td>\r\n\r\n                <Row>\r\n                  <Col>\r\n                    <Form onSubmit={evt => this.handleFormSubmit(evt)}>\r\n                      <Nouislider onSlide={this.onChangeSliderKoefDist.bind(this)} ref={strSlider1}\r\n                        range={{ min: 0.5, max: 3.0 }}\r\n                        start={wArrDist} step={0.2} tooltips={valToolTps} />\r\n                    </Form>\r\n                  </Col>\r\n                </Row>\r\n\r\n              </td>\r\n            </tr>\r\n\r\n            <tr>\r\n              <td style={{ paddingBottom: '32px' }}>\r\n                Select koefficient value (kv)\r\n              </td>\r\n            </tr>\r\n\r\n            <tr>\r\n              <td>\r\n\r\n                <Row>\r\n                  <Col>\r\n                    <Form onSubmit={evt => this.handleFormSubmit(evt)}>\r\n                      <Nouislider onSlide={this.onChangeSliderKoefVal.bind(this)} ref={strSlider2}\r\n                        range={{ min: 0.1, max: 4.0 }}\r\n                        start={wArrVal} step={0.2} tooltips={valToolTps} />\r\n                    </Form>\r\n                  </Col>\r\n                </Row>\r\n\r\n              </td>\r\n            </tr>\r\n\r\n            <tr>\r\n              <td>\r\n                <b>Hints to setup values:</b> <br />\r\n                kd = 0.5, kv = 0.1 => original image <br />\r\n                kd = 3.0, kv = 0.1 => denoise image <br />\r\n                kd = 3.0, kv = 4.0 => image blur\r\n              </td>\r\n            </tr>\r\n\r\n            <tr>\r\n              <td>\r\n                <Row>\r\n                  <Col lg xl=\"2\">\r\n                    <Button onClick={this.onButtonStart} >\r\n                      Start\r\n                    </Button>\r\n                  </Col>\r\n\r\n                  <Col lg xl=\"10\">\r\n                  </Col>\r\n\r\n                </Row>\r\n              </td>\r\n            </tr>\r\n          </tbody>\r\n        </Table>\r\n\r\n      </Modal.Body>\r\n\r\n    </Modal>\r\n    return jsxModalGauss;\r\n  } // end render\r\n\r\n} // end class\r\n\r\nexport default connect(store => store)(UiModalBilateral);\r\n\r\n\r\n","/**\r\n * @fileOverview UiFilterMenu\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\nimport { NavDropdown } from 'react-bootstrap';\r\nimport LungsFillTool from '../engine/actvolume/lungsfill/lft';\r\n\r\nimport ActiveVolume from '../engine/actvolume/actvol';\r\nimport StoreActionType from '../store/ActionTypes';\r\nimport Texture3D from '../engine/Texture3D';\r\nimport ModeView from '../store/ModeView';\r\nimport Modes3d from '../store/Modes3d';\r\n\r\nimport SobelEdgeDetector from '../engine/imgproc/Sobel';\r\nimport UiModalBilateral from './UiModalBilateral';\r\n\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiFilterMenu some text later...\r\n */\r\nclass UiFilterMenu extends React.Component {\r\n  // invoked after render\r\n  constructor(props) {\r\n    super(props);\r\n    this.onButtonLungsSeg = this.onButtonLungsSeg.bind(this);\r\n    this.onLungsFillerCallback = this.onLungsFillerCallback.bind(this);\r\n    this.onButtonDetectBrain = this.onButtonDetectBrain.bind(this);\r\n    this.onSkullRemoveCallback = this.onSkullRemoveCallback.bind(this);\r\n    this.onButtonSobel = this.onButtonSobel.bind(this);\r\n    this.onSobelCallback = this.onSobelCallback.bind(this);\r\n    this.onButtonBilateral = this.onButtonBilateral.bind(this);\r\n\r\n    this.showModalBilateral = this.showModalBilateral.bind(this);\r\n    this.hideModalBilateral = this.hideModalBilateral.bind(this);\r\n    this.state = {\r\n      showModalBilateral: false,\r\n    };\r\n\r\n\r\n    //this.callbackProgressFun = this.callbackProgressFun.bind(this);\r\n  }\r\n\r\n  /*\r\n  callbackProgressFun(ratio01) {\r\n    // console.log(`callbackReadProgress = ${ratio01}`);\r\n    const store = this.props;\r\n    const uiapp = store.uiApp;\r\n    const ratioPrc = Math.floor(ratio01 * 100);\r\n    if (ratioPrc === 0) {\r\n      uiapp.doShowProgressBar('reading...');\r\n    }\r\n    if (ratioPrc >= 99) {\r\n      // console.log(`callbackReadProgress. hide on = ${ratio01}`);\r\n      uiapp.doHideProgressBar();\r\n    } else {\r\n      uiapp.doSetProgressBarRatio(ratioPrc);\r\n    }\r\n  } // callback progress\r\n  */\r\n  onButtonLungsSeg() {\r\n    //evt.preventDefault();\r\n    const store = this.props;\r\n    const volSet = store.volumeSet;\r\n    const volIndex = store.volumeIndex;\r\n    const vol = volSet.getVolume(volIndex);\r\n\r\n    if ((vol === undefined) || (vol === null)) {\r\n      console.log('onButtonDetectBrain: no volume!');\r\n      return;\r\n    }\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    if (xDim * yDim * zDim < 1) {\r\n      console.log(`onButtonDetectBrain: bad volume! dims = ${xDim}*${yDim}*${zDim}`);\r\n      return;\r\n    }\r\n    const ONE = 1;\r\n    if (vol.m_bytesPerVoxel !== ONE) {\r\n      console.log('onButtonDetectBrain: supported only 1bpp volumes');\r\n      return;\r\n    }\r\n\r\n    this.lungsFiller = new LungsFillTool(vol);\r\n    //const callbackProgress = this.callbackProgressFun;\r\n    //lungsFiller.run(callbackProgress);\r\n    const uiApp = store.uiApp;\r\n    uiApp.doShowProgressBar('lungsFiller...');\r\n    uiApp.doSetProgressBarRatio(0.0);\r\n    const SK_REM_DELAY_MSEC = 200;\r\n    this.m_timerId = setTimeout(this.onLungsFillerCallback, SK_REM_DELAY_MSEC);\r\n    //store.volumeRenderer.volumeUpdater.createUpdatableVolumeTex(store.volume, false, null);\r\n  }\r\n\r\n  onLungsFillerCallback() {\r\n    const store = this.props;\r\n    const ratioUpdate = this.lungsFiller.m_ratioUpdate;\r\n    console.log(`onLungsFillerCallback: iter counter = ${ratioUpdate}`);\r\n    const uiApp = store.uiApp;\r\n    uiApp.doSetProgressBarRatio(ratioUpdate);\r\n\r\n    const isFinished = this.lungsFiller.run();\r\n \r\n    if (isFinished) {\r\n      console.log('`onSkullRemoveCallback: iters finished!');\r\n      uiApp.doHideProgressBar();\r\n      clearInterval(this.m_timerId);\r\n      this.m_timerId = 0;\r\n      // store.graphics2d.renderScene();\r\n    }\r\n    // update render\r\n    store.graphics2d.forceUpdate();\r\n    // next update timer\r\n    if (!isFinished) {\r\n      const SK_REM_DELAY_MSEC = 200;\r\n      this.m_timerId = setTimeout(this.onLungsFillerCallback, SK_REM_DELAY_MSEC);\r\n    }\r\n  }\r\n\r\n  // on sobel\r\n  onButtonSobel() {\r\n    // get globals\r\n    const store = this.props;\r\n\r\n    const volSet = store.volumeSet;\r\n    const volIndex = store.volumeIndex;\r\n    const vol = volSet.getVolume(volIndex);\r\n\r\n    if ((vol === undefined) || (vol === null)) {\r\n      console.log('onButtonSobel: no volume!');\r\n      return;\r\n    }\r\n    this.m_vol = vol;\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    if (xDim * yDim * zDim < 1) {\r\n      console.log(`onButtonSobel: bad volume! dims = ${xDim}*${yDim}*${zDim}`);\r\n      return;\r\n    }\r\n    // let volTextureSrc = vol.m_dataArray;\r\n    const ONE = 1;\r\n    if (vol.m_bytesPerVoxel !== ONE) {\r\n      console.log('onButtonSobel: supported only 1bpp volumes');\r\n      return;\r\n    }\r\n\r\n    console.log('onButtonSobel: start sobel...');\r\n    //const xyzDim = xDim * yDim * zDim;\r\n    //const volTextureDst = new Uint8Array(xyzDim);\r\n\r\n    const sobel = new SobelEdgeDetector();\r\n    sobel.start(vol);\r\n    this.m_sobel = sobel;\r\n\r\n    const uiApp = store.uiApp;\r\n    uiApp.doShowProgressBar('Apply sobel edge detector...');\r\n    uiApp.doSetProgressBarRatio(0.0);\r\n\r\n    const SOBEL_UPDATE_DELAY_MSEC = 150;\r\n    this.m_timerId = setTimeout(this.onSobelCallback, SOBEL_UPDATE_DELAY_MSEC);\r\n\r\n  } // end onButtonSobel\r\n\r\n  // callback for periodicallt invoke sobel 3d volume filtering\r\n  onSobelCallback() {\r\n    this.m_sobel.update();\r\n\r\n    const store = this.props;\r\n\r\n    let ratioUpdate = this.m_sobel.getRatio();\r\n    ratioUpdate = (ratioUpdate < 1.0) ? ratioUpdate : 1.0;\r\n    ratioUpdate *= 100;\r\n    ratioUpdate = Math.floor(ratioUpdate);\r\n    // console.log('ratio = ' + ratioUpdate.toString() );\r\n\r\n    const uiApp = store.uiApp;\r\n    uiApp.doSetProgressBarRatio(ratioUpdate);\r\n\r\n    const isFinished = this.m_sobel.isFinished();\r\n\r\n    if (isFinished) {\r\n      console.log('`onSobelCallback: iters finished!');\r\n      uiApp.doHideProgressBar();\r\n\r\n      clearInterval(this.m_timerId);\r\n      this.m_timerId = 0;\r\n\r\n      const volSet = store.volumeSet;\r\n      const volIndex = store.volumeIndex;\r\n      const vol = volSet.getVolume(volIndex);\r\n\r\n      // normalize dst\r\n      this.m_sobel.normalizeDstImage();\r\n\r\n      // copy result pixels into source\r\n      const xDim = vol.m_xDim;\r\n      const yDim = vol.m_yDim;\r\n      const zDim = vol.m_zDim;\r\n      const xyzDim = xDim * yDim * zDim;\r\n      const pixelsDst = this.m_sobel.getPixelsDst()\r\n      for (let i = 0; i < xyzDim; i++) {\r\n        vol.m_dataArray[i] = Math.floor(pixelsDst[i]);\r\n      } // for i\r\n      this.m_sobel.stop();\r\n\r\n      // rebuild 3d data\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_SET, volumeSet: volSet });\r\n      store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: true });\r\n      const tex3d = new Texture3D();\r\n      tex3d.createFromRawVolume(vol);\r\n      store.dispatch({ type: StoreActionType.SET_TEXTURE3D, texture3d: tex3d });\r\n      store.dispatch({ type: StoreActionType.SET_MODE_VIEW, modeView: ModeView.VIEW_2D });\r\n      store.dispatch({ type: StoreActionType.SET_MODE_3D, mode3d: Modes3d.RAYCAST });\r\n    } // if finished\r\n    // update render\r\n    store.graphics2d.forceUpdate();\r\n    // next update timer\r\n    if (!isFinished) {\r\n      const SOBEL_UPDATE_DELAY_MSEC = 150;\r\n      this.m_timerId = setTimeout(this.onSobelCallback, SOBEL_UPDATE_DELAY_MSEC);\r\n    }\r\n  } // end onSobelCallback\r\n\r\n  //\r\n  // on Bilateral\r\n  //\r\n  onButtonBilateral() {\r\n    this.showModalBilateral();\r\n  }\r\n\r\n  //\r\n  // detect brain segmentation\r\n  //\r\n  onButtonDetectBrain() {\r\n    // get globals\r\n    const store = this.props;\r\n\r\n    const volSet = store.volumeSet;\r\n    const volIndex = store.volumeIndex;\r\n    const vol = volSet.getVolume(volIndex);\r\n\r\n    if ((vol === undefined) || (vol === null)) {\r\n      console.log('onButtonDetectBrain: no volume!');\r\n      return;\r\n    }\r\n    const xDim = vol.m_xDim;\r\n    const yDim = vol.m_yDim;\r\n    const zDim = vol.m_zDim;\r\n    if (xDim * yDim * zDim < 1) {\r\n      console.log(`onButtonDetectBrain: bad volume! dims = ${xDim}*${yDim}*${zDim}`);\r\n      return;\r\n    }\r\n    let volTextureSrc = vol.m_dataArray;\r\n    const ONE = 1;\r\n    if (vol.m_bytesPerVoxel !== ONE) {\r\n      console.log('onButtonDetectBrain: supported only 1bpp volumes');\r\n      return;\r\n    }\r\n\r\n    // non-proportional scale for too non-squared volumes\r\n    // TODO:...\r\n    /*\r\n    const TWICE = 2;\r\n    if (zDim < xDim / TWICE) {\r\n      const xNew = xDim >> 1;\r\n      const yNew = yDim >> 1;\r\n      const zNew = zDim << 1;\r\n      const volTexNew = Graphics2d.rescale(xDim, yDim, zDim, volTextureSrc, xNew, yNew, zNew);\r\n      volTextureSrc = volTexNew;\r\n      xDim = xNew; yDim = yNew;\r\n      zDim = zNew;\r\n      this.m_engine2d.m_volumeHeader.m_pixelWidth = xDim;\r\n      this.m_engine2d.m_volumeHeader.m_pixelHeight = yDim;\r\n      this.m_engine2d.m_volumeHeader.m_pixelDepth = zDim;\r\n    }\r\n    */\r\n    const xyzDim = xDim * yDim * zDim;\r\n    const volTextureDst = new Uint8Array(xyzDim);\r\n    const NEED_LOG = true;\r\n    const CREATE_TYPE = ActiveVolume.REMOVE_SKULL;\r\n    const actVolume = new ActiveVolume();\r\n    this.m_actVolume = actVolume;\r\n\r\n    const uiApp = store.uiApp;\r\n    uiApp.doShowProgressBar('Remove skull...');\r\n    uiApp.doSetProgressBarRatio(0.0);\r\n\r\n    this.m_geoRender = actVolume.skullRemoveStart(xDim, yDim, zDim,\r\n      volTextureSrc, volTextureDst, CREATE_TYPE, NEED_LOG);\r\n    const SK_REM_DELAY_MSEC = 10;\r\n    this.m_timerId = setTimeout(this.onSkullRemoveCallback, SK_REM_DELAY_MSEC);\r\n\r\n    // let isRoiVolume = false;\r\n    if (CREATE_TYPE === ActiveVolume.CREATE_MASK) {\r\n      /*\r\n      // now create argb texture with intensity and roi\r\n      isRoiVolume = true;\r\n      const newDataArray = this.combineWithRoiTexture(xDim, yDim, zDim, volTextureSrc, volTextureDst);\r\n\r\n      // start create data for render\r\n      this.m_engine2d.m_volumeData = newDataArray;\r\n\r\n      // create header for ARGB data (4 bytes per voxel, not 1 byte)\r\n      const KTX_GL_RGBA = 0x1908;\r\n      const KTX_UNSIGNED_BYTE = 0x1401;\r\n      const header = {\r\n        m_pixelWidth: xDim,\r\n        m_pixelHeight: yDim,\r\n        m_pixelDepth: zDim,\r\n        m_glType: KTX_UNSIGNED_BYTE,\r\n        m_glTypeSize: 1,\r\n        m_glFormat: KTX_GL_RGBA,\r\n        m_glInternalFormat: KTX_GL_RGBA,\r\n        m_glBaseInternalFormat: KTX_GL_RGBA,\r\n      };\r\n      this.m_engine2d.m_volumeHeader = header;\r\n      */\r\n    } else if (CREATE_TYPE === ActiveVolume.REMOVE_SKULL) {\r\n      // vol.m_dataArray = volTextureDst;\r\n    }\r\n\r\n    /*\r\n    store.dispatch({ type: StoreActionType.SET_VOLUME, volume: vol });\r\n    store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: true });\r\n    const tex3d = new Texture3D();\r\n    tex3d.createFromRawVolume(vol);\r\n    store.dispatch({ type: StoreActionType.SET_TEXTURE3D, texture3d: tex3d });\r\n    store.dispatch({ type: StoreActionType.SET_MODE_VIEW, modeView: ModeView.VIEW_2D });\r\n    store.dispatch({ type: StoreActionType.SET_MODE_3D, mode3d: Modes3d.RAYCAST });\r\n\r\n    // update render\r\n    store.graphics2d.forceUpdate();\r\n    */\r\n  }\r\n\r\n  onSkullRemoveCallback() {\r\n    const store = this.props;\r\n    const iterCounter = this.m_actVolume.m_updateCounter;\r\n    // console.log(`onSkullRemoveCallback: iter counter = ${iterCounter}`);\r\n\r\n    const maxCounter = this.m_actVolume.m_numPredSteps;\r\n    let ratioUpdate = iterCounter / maxCounter;\r\n    ratioUpdate = (ratioUpdate < 1.0) ? ratioUpdate : 1.0;\r\n    ratioUpdate *= 100;\r\n\r\n    const uiApp = store.uiApp;\r\n    uiApp.doSetProgressBarRatio(ratioUpdate);\r\n\r\n    const isFinished = this.m_actVolume.skullRemoveUpdate(this.m_geoRender);\r\n \r\n    if (isFinished) {\r\n      console.log('`onSkullRemoveCallback: iters finished!');\r\n\r\n      uiApp.doHideProgressBar();\r\n\r\n      clearInterval(this.m_timerId);\r\n      this.m_timerId = 0;\r\n      this.m_actVolume.skullRemoveStop(this.m_geoRender);\r\n\r\n      // perform finalize skull remove\r\n      const volSet = store.volumeSet;\r\n      const volIndex = store.volumeIndex;\r\n      const vol = volSet.getVolume(volIndex);\r\n\r\n      const volTextureDst = this.m_actVolume.m_volTexDst;\r\n      vol.m_dataArray = volTextureDst;\r\n\r\n      store.dispatch({ type: StoreActionType.SET_VOLUME_SET, volumeSet: volSet });\r\n      store.dispatch({ type: StoreActionType.SET_IS_LOADED, isLoaded: true });\r\n      const tex3d = new Texture3D();\r\n      tex3d.createFromRawVolume(vol);\r\n      store.dispatch({ type: StoreActionType.SET_TEXTURE3D, texture3d: tex3d });\r\n      store.dispatch({ type: StoreActionType.SET_MODE_VIEW, modeView: ModeView.VIEW_2D });\r\n      store.dispatch({ type: StoreActionType.SET_MODE_3D, mode3d: Modes3d.RAYCAST });\r\n    }\r\n    // update render\r\n    store.graphics2d.forceUpdate();\r\n    // next update timer\r\n    if (!isFinished) {\r\n      const SK_REM_DELAY_MSEC = 10;\r\n      this.m_timerId = setTimeout(this.onSkullRemoveCallback, SK_REM_DELAY_MSEC);\r\n    }\r\n  }\r\n\r\n  componentDidMount() {\r\n  }\r\n\r\n  showModalBilateral() {\r\n    this.setState({ showModalBilateral: true });\r\n  }\r\n\r\n  hideModalBilateral() {\r\n    this.setState({ showModalBilateral: false });\r\n    // console.log('onModalSaveNiftiHide...');\r\n  }\r\n\r\n  //\r\n  render() {\r\n    const store = this.props;\r\n    const isLoaded = store.isLoaded;\r\n\r\n    const strDisabled = (isLoaded) ? false : true;\r\n    const jsxFilterMenu =\r\n      <NavDropdown id=\"save-nav-dropdown\" \r\n        disabled={strDisabled}\r\n        title={\r\n          <div style={{ display: 'inline-block' }}> \r\n            <i className=\"fas fa-broom\"></i>\r\n            Filter\r\n          </div>\r\n        } >\r\n        <NavDropdown.Item href=\"#actionLungsSeg\" onClick={evt => this.onButtonLungsSeg(evt)}>\r\n          <i className=\"fas fa-cloud\"></i>\r\n          Lungs segmentation\r\n        </NavDropdown.Item>\r\n        <NavDropdown.Item href=\"#actionDataectBrain\" onClick={evt => this.onButtonDetectBrain(evt)}>\r\n          <i className=\"fas fa-brain\"></i>\r\n          Auto detect brain\r\n        </NavDropdown.Item>\r\n        <NavDropdown.Item href=\"#actionSobel\" onClick={evt => this.onButtonSobel(evt)}>\r\n          Sobel filter\r\n        </NavDropdown.Item>\r\n        <NavDropdown.Item href=\"#actionBilateral\" onClick={evt => this.onButtonBilateral(evt)}>\r\n          Bilateral (denoise or smooth)\r\n        </NavDropdown.Item>\r\n        <UiModalBilateral stateVis={this.state.showModalBilateral} onHide={this.hideModalBilateral} />\r\n      </NavDropdown>;\r\n\r\n    return jsxFilterMenu;\r\n  }\r\n}\r\n \r\nexport default connect(store => store)(UiFilterMenu);\r\n\r\n","/**\r\n * @fileOverview UiModalText\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport { Modal, Button, Form, Row, Col } from 'react-bootstrap';\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\nclass UiModalText extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.onButtonOk = this.onButtonOk.bind(this);\r\n    this.onTexChange = this.onTexChange.bind(this);\r\n    this.handleFormSubmit = this.handleFormSubmit.bind(this);\r\n    // this.onSaveNifti = this.onSaveNifti.bind(this);\r\n\r\n    this.m_showFunc = null;\r\n    this.m_hideFunc = null;\r\n\r\n    this.state = {\r\n      text: ''\r\n    };\r\n  } // end constr\r\n\r\n  onTextEntered() {\r\n    const store = this.props;\r\n    const gra = store.graphics2d;\r\n    const toolText = gra.m_toolText;\r\n    toolText.setText(this.state.text);\r\n    this.setState({ text: '' });\r\n  }\r\n\r\n  /**\r\n   * When user press OK button\r\n   */\r\n  onButtonOk() {\r\n    // console.log('on button ok');\r\n    this.m_hideFunc();\r\n    this.onTextEntered();\r\n  }\r\n\r\n  handleFormSubmit(evt) {\r\n    evt.preventDefault();\r\n    this.m_hideFunc();\r\n    this.onTextEntered();\r\n  }\r\n\r\n  onTexChange(evt) {\r\n    const strText = evt.target.value;\r\n    // console.log(`onTexChange. text = ${strText}`);\r\n    this.setState({ text: strText });\r\n  }\r\n\r\n  render() {\r\n    const stateVis = this.props.stateVis;\r\n    const onHideFunc = this.props.onHide;\r\n    const onShowFunc = this.props.onShow;\r\n    this.m_hideFunc = onHideFunc;\r\n    this.m_showFunc = onShowFunc;\r\n    // console.log(`UiModalText. setup funcs: ${this.m_showFunc}, ${this.m_hideFunc}`);\r\n\r\n    const jsxModalText =\r\n    <Modal show={stateVis} onHide={onHideFunc} >\r\n\r\n      <Modal.Body>\r\n\r\n        <Modal.Title>\r\n          Input text\r\n        </Modal.Title>\r\n\r\n        <Form onSubmit={evt => this.handleFormSubmit(evt)} >\r\n          <Form.Control required type=\"text\" placeholder=\"\"\r\n            defaultValue={this.state.text} onChange={this.onTexChange} autoFocus={true}  />\r\n        </Form>\r\n        <Row>\r\n          <Col lg xl=\"2\">\r\n            <Button onClick={onHideFunc} >\r\n              Cancel\r\n            </Button>\r\n          </Col>\r\n\r\n          <Col lg xl=\"2\">\r\n            <Button onClick={this.onButtonOk} >\r\n              Ok\r\n            </Button>\r\n          </Col>\r\n\r\n          <Col lg xl=\"8\">\r\n          </Col>\r\n\r\n        </Row>\r\n\r\n      </Modal.Body>\r\n\r\n    </Modal>\r\n    return jsxModalText;\r\n  } // end render\r\n\r\n} // end class\r\n\r\nexport default connect(store => store)(UiModalText);\r\n","/**\r\n * @fileOverview UiModalAlert\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport { Modal, Button, Row, Col } from 'react-bootstrap';\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\nclass UiModalAlert extends React.Component {\r\n  /**\r\n   * @param {object} props - props from up level object\r\n   */\r\n  constructor(props) {\r\n    super(props);\r\n    this.onButtonOk = this.onButtonOk.bind(this);\r\n\r\n    this.m_showFunc = null;\r\n    this.m_hideFunc = null;\r\n\r\n    this.state = {\r\n      title: '',\r\n      text: '',\r\n    };\r\n  } // end constr\r\n\r\n  /**\r\n   * When user press OK button\r\n   */\r\n  onButtonOk() {\r\n    // console.log('on button OK');\r\n    this.m_hideFunc();\r\n  }\r\n\r\n  render() {\r\n    const stateVis = this.props.stateVis;\r\n    const onHideFunc = this.props.onHide;\r\n    const onShowFunc = this.props.onShow;\r\n    this.m_hideFunc = onHideFunc;\r\n    this.m_showFunc = onShowFunc;\r\n    // console.log(`UiModalAlert. setup funcs: ${this.m_showFunc}, ${this.m_hideFunc}`);\r\n\r\n    const strTitle = this.props.title;\r\n    const strText = this.props.text;\r\n\r\n    const jsxModalAlert =\r\n    <Modal show={stateVis} onHide={onHideFunc} >\r\n\r\n      <Modal.Header closeButton>\r\n        <Modal.Title>\r\n          {strTitle}\r\n        </Modal.Title>\r\n      </Modal.Header>\r\n\r\n      <Modal.Body>\r\n        <p>\r\n          {strText}\r\n        </p>\r\n\r\n\r\n        <Row>\r\n          <Col lg xl=\"2\">\r\n            <Button onClick={this.onButtonOk} >\r\n              Ok\r\n            </Button>\r\n          </Col>\r\n\r\n          <Col lg xl=\"10\">\r\n          </Col>\r\n        </Row>\r\n\r\n      </Modal.Body>\r\n\r\n    </Modal>\r\n    return jsxModalAlert;\r\n  } // end render\r\n\r\n} // end class\r\n\r\nexport default connect(store => store)(UiModalAlert);\r\n","/**\r\n * @fileOverview UiErrConsole\r\n * @author Epam\r\n * @version 1.0.0\r\n */\r\n\r\n\r\n// ********************************************************\r\n// Imports\r\n// ********************************************************\r\n\r\nimport React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport { Container, ListGroup } from 'react-bootstrap';\r\n\r\n\r\n\r\n// ********************************************************\r\n// Const\r\n// ********************************************************\r\n\r\n\r\n// ********************************************************\r\n// Class\r\n// ********************************************************\r\n\r\n/**\r\n * Class UiErrConsole some text later...\r\n */\r\nclass UiErrConsole extends React.Component {\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    const store = this.props;\r\n    const arrErr = store.arrErrors;\r\n    const jsx = <Container>\r\n      Errors during read\r\n      <ListGroup>\r\n        {arrErr.map((d, i) => {\r\n          const strErr = d;\r\n          const strKey = `key_${i}`;\r\n          return <ListGroup.Item key={strKey} > {strErr} </ListGroup.Item>;\r\n        })}\r\n      </ListGroup>\r\n    </Container>;\r\n    return jsx;\r\n  }\r\n}\r\nexport default connect(store => store)(UiErrConsole);\r\n","\r\n/**\r\n* Detect browser type (Chrome, Firefox, ...) and detect is this mobile device\r\n* @module src/demo/engine/utils/BrowserDetector\r\n*/\r\n\r\n// absolute imports\r\n// import swal from 'sweetalert';\r\n\r\nimport { createCanvas } from 'canvas';\r\n\r\n\r\n/**\r\n* Class BrowserDetector preform initial loading browser type detection\r\n* @class BrowserDetector\r\n*/\r\nclass BrowserDetector {\r\n  /**\r\n  * Start simple detection\r\n  * @constructs BrowserDetector\r\n  */\r\n  constructor() {\r\n    this.m_strUserAgent = '';\r\n    this.m_strVendor = '';\r\n    this.m_isOpera = false;\r\n    this.m_isFirefox = false;\r\n    this.m_isSafari = false;\r\n    this.m_isIE = false;\r\n    this.m_isChrome = false;\r\n    this.m_isMobileBrowser = false;\r\n  }\r\n\r\n  /**\r\n   * Check support WebGL 2.0\r\n   * \r\n   * * @return {boolean} true, if WebGL 2.0 supported\r\n   */\r\n  checkWebGlSupported() {\r\n    // let canvas = document.createElement('canvas');\r\n    let canvas = createCanvas(640, 480);\r\n    let gl = null;\r\n    try { \r\n      gl = canvas.getContext(\"webgl2\"); \r\n    } catch (x) { \r\n      gl = null; \r\n    }\r\n    const glFound = (gl !== null);\r\n    // console.log(`checkWebGlSupported. GL 2.0 = ${glFound}`);\r\n    canvas = undefined;\r\n    return glFound;\r\n  }\r\n\r\n  /**\r\n  * Check is this browser valid\r\n  * @return {boolean} true, if valid for 3d vizualization\r\n  */\r\n  checkValidBrowser() {\r\n    /** @property {string} m_strUserAgent - User agent */\r\n    this.m_strUserAgent = navigator.userAgent.toLowerCase();\r\n    /** @property {string} m_strVendor - Browser vendor, typically 'Google' */\r\n    this.m_strVendor = navigator.vendor;\r\n    /** @property {boolean} m_isOpera - Is this opera browser */\r\n    this.m_isOpera = /opr\\/|opios/i.test(this.m_strUserAgent);\r\n    /** @property {boolean} m_isFirefox - Is this firefox browser */\r\n    this.m_isFirefox = (typeof InstallTrigger !== 'undefined');\r\n    /** @property {boolean} m_isSafari - Is this safari browser */\r\n    // this.m_isSafari = /safari|applewebkit/i.test(this.m_strUserAgent);\r\n    this.m_isSafari = (this.m_strUserAgent.search('safari') >= 0) && (this.m_strUserAgent.search('chrome') < 0);\r\n    /** @property {boolean} m_isIE - IE ver 6-11 */\r\n    this.m_isIE = false || !!document.documentMode;\r\n    /** @property {boolean} m_isChrome - Chrome browser */\r\n    this.m_isChrome = /chrome/i.test(navigator.userAgent);\r\n    this.m_isEdge = (navigator.appVersion.indexOf('Edge') > -1);\r\n    if (this.m_isEdge) {\r\n      this.m_isChrome = false;\r\n    }\r\n    // console.log(`Is Edge browser = ${this.m_isEdge}`);\r\n    // console.log(`Is Chrome browser = ${this.m_isChrome}`);\r\n    // console.log(`Is Firefox browser = ${this.m_isFirefox}`);\r\n    // console.log(`Is Safari browser = ${this.m_isSafari}`);\r\n    // console.log(`Is Opera browser = ${this.m_isOpera}`);\r\n\r\n    const strTitle1 = 'Med3web is designed for Chrome/Firefox/Safari browsers.';\r\n    const strTitle2 = 'The application can be slow or unstable in this web browser.';\r\n    const strTitleFinal = `${strTitle1} ${strTitle2}`;\r\n    const isValidBrowserType = this.m_isChrome || this.m_isFirefox || this.m_isSafari || this.m_isOpera;\r\n    if (!isValidBrowserType) {\r\n      const strMsg = 'App is specially designed for Chrome/Firefox/Opera/Safari browsers';\r\n      console.log(`BrowserDetector. ${strTitleFinal}. ${strMsg}`);\r\n      /*\r\n      swal({\r\n        title: strTitleFinal,\r\n        text: strMsg,\r\n        icon: 'warning',\r\n        button: 'continue',\r\n      });\r\n      */\r\n    }\r\n    // Mobile or not\r\n    const mobileArr = ['iphone', 'ipad', 'android', 'blackberry',\r\n      'nokia', 'opera mini', 'windows mobile', 'windows phone', 'iemobile'];\r\n    this.m_isMobileBrowser = false;\r\n    for (let i = 0; i < mobileArr.length; i++) {\r\n      if (this.m_strUserAgent.indexOf(mobileArr[i].toLowerCase()) > 0) {\r\n        // console.log(`Detected mobile browser in string ${this.m_strUserAgent}`);\r\n        this.m_isMobileBrowser = true;\r\n      }\r\n    } // for\r\n    // detect mobiu browser by window size\r\n    const MIN_W = 800;\r\n    const MIN_H = 600;\r\n    if ((window.innerWidth <= MIN_W) || (window.innerHeight <= MIN_H) ) {\r\n      this.m_isMobileBrowser = true;\r\n    }\r\n    if (this.m_isMobileBrowser) {\r\n      // console.log('Mobile browser detected! App can be slow');\r\n      console.log(`MobileBrowserDetector. ${strTitleFinal}. App can be slow due to detected mobile browser`);\r\n      /*\r\n      swal({\r\n        title: strTitleFinal,\r\n        text: 'App can be slow due to detected mobile browser',\r\n        icon: 'warning',\r\n        button: 'continue',\r\n      });\r\n      */\r\n    }\r\n    if (!this.m_isMobileBrowser) {\r\n      return isValidBrowserType;\r\n    }\r\n    return true;\r\n  } // check\r\n} // class BrowserDetector\r\n\r\nexport default BrowserDetector;\r\n","import React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport { Nav, Navbar, Container, ProgressBar, Row, Col } from 'react-bootstrap';\r\nimport StoreActionType from '../store/ActionTypes';\r\n\r\nimport UiMain from './UiMain';\r\nimport UiOpenMenu from './UiOpenMenu';\r\nimport UiViewMode from './UiViewMode';\r\nimport UiAbout from './UiAbout';\r\nimport UiSaveMenu from './UiSaveMenu';\r\nimport UiReportMenu from './UiReportMenu';\r\nimport UiFilterMenu from './UiFilterMenu';\r\nimport UiModalText from './UiModalText';\r\nimport UiModalAlert from './UiModalAlert';\r\nimport UiErrConsole from './UiErrConsole';\r\nimport ModeView from '../store/ModeView';\r\n//\r\nimport BrowserDetector from '../engine/utils/BrowserDetector';\r\n\r\nclass UiApp extends React.Component {\r\n  constructor(props) {\r\n    super(props);\r\n\r\n    this.onShowModalText = this.onShowModalText.bind(this);\r\n    this.onHideModalText = this.onHideModalText.bind(this);\r\n\r\n    this.onShowModalAlert = this.onShowModalAlert.bind(this);\r\n    this.onHideModalAlert = this.onHideModalAlert.bind(this);\r\n\r\n    this.doShowProgressBar = this.doShowProgressBar.bind(this);\r\n    this.doHideProgressBar = this.doHideProgressBar.bind(this);\r\n    this.doSetProgressBarRatio = this.doSetProgressBarRatio.bind(this);\r\n\r\n    this.m_modalText = null;\r\n    this.m_store = null;\r\n    this.m_fileNameOnLoad = '';\r\n\r\n    this.state = {\r\n      showModalText: false,\r\n      showProgressBar: false,\r\n      progressBarRatio: 55,\r\n      showModalAlert: false,\r\n      strAlertTitle: '???',\r\n      strAlertText: '???',\r\n      strProgressMessage: 'Loading...',\r\n    };\r\n  }\r\n\r\n  UNSAFE_componentWillMount() {\r\n    let fileNameOnLoad = '';\r\n    const strSearch = window.location.search;\r\n    if (strSearch.length > 0) {\r\n      const strReg = /\\\\?url=(\\S+)/;\r\n      const arr = strSearch.match(strReg);\r\n      if (arr === null) {\r\n        console.log('arguments should be in form: ?url=www.xxx.yy/zz/ww');\r\n        return;\r\n      }\r\n      fileNameOnLoad = arr[1];\r\n      const regA = /^((ftp|http|https):\\/\\/)?(([\\S]+)\\.)?([\\S]+)\\.([A-z]{2,})(:\\d{1,6})?\\/[\\S]+/;\r\n      const regB = /(ftp|http|https):\\/\\/([\\d]+)\\.([\\d]+)\\.([\\d]+)\\.([\\d]+)(:([\\d]+))?\\/([\\S]+)/;\r\n      const isValidA = fileNameOnLoad.match(regA);\r\n      const isValidB = fileNameOnLoad.match(regB);\r\n      if ((isValidA === null) && (isValidB === null)) {\r\n        console.log(`Not valid URL = ${fileNameOnLoad}`);\r\n        return;\r\n      }\r\n      this.m_fileNameOnLoad = fileNameOnLoad;\r\n    }\r\n  }\r\n\r\n  componentDidMount() {\r\n    const store = this.m_store;\r\n    if (store === null) {\r\n      console.log('UiApp. componentDidMount. store is NULL');\r\n    }\r\n    store.dispatch({ type: StoreActionType.SET_UI_APP, uiApp: this });\r\n\r\n    // browser detector\r\n    const browserDetector = new BrowserDetector();\r\n    this.isWebGl20supported = browserDetector.checkWebGlSupported();\r\n    if (!this.isWebGl20supported) {\r\n      this.setState({ strAlertTitle: 'Browser compatibility problem detected' });\r\n      this.setState({ strAlertText: 'This browser not supported WebGL 2.0. Application functinality is decreased and app can be unstable' });\r\n      this.onShowModalAlert();\r\n    } else {\r\n      const isValidBro = browserDetector.checkValidBrowser();\r\n      if (!isValidBro) {\r\n        this.setState({ strAlertTitle: 'Browser compatibility problem detected' });\r\n        this.setState({ strAlertText: 'App is specially designed for Chrome/Firefox/Opera/Safari browsers' });\r\n        this.onShowModalAlert();\r\n      }\r\n    }\r\n  }\r\n\r\n  onShowModalText() {\r\n    this.setState({ showModalText: true });\r\n  }\r\n\r\n  onHideModalText() {\r\n    this.setState({ showModalText: false });\r\n  }\r\n\r\n  onShowModalAlert() {\r\n    this.setState({ showModalAlert: true });\r\n  }\r\n\r\n  onHideModalAlert() {\r\n    this.setState({ showModalAlert: false });\r\n  }\r\n\r\n  doShowProgressBar(strProgressMsg) {\r\n    if ((strProgressMsg === undefined) || (strProgressMsg === null)) {\r\n      console.log('doShowProgressBar: need argument - strProgressMsg');\r\n      return;\r\n    }\r\n    this.setState({ strProgressMessage: strProgressMsg });\r\n    this.setState({ showProgressBar: true });\r\n  }\r\n\r\n  doHideProgressBar() {\r\n    // console.log('doHideProgressBar');\r\n    this.setState({ showProgressBar: false });\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @param {number} ratio - in [0..99] range\r\n   */\r\n  doSetProgressBarRatio(ratio) {\r\n    // console.log(`doSetProgressBarRatio: ${ratio}`);\r\n\r\n    // show progress bar if it was hidden but need to show some non-0, non-100 progress\r\n    if ((ratio >= 0) && (ratio <= 99)) {\r\n      if (this.state.showProgressBar === false) {\r\n        this.setState({ showProgressBar: true });\r\n      }\r\n    }\r\n    this.setState({ progressBarRatio: ratio });\r\n  }\r\n\r\n  /**\r\n   * Main component render func callback\r\n   */\r\n  render() {\r\n    const store = this.props;\r\n    this.m_store = store;\r\n    const isLoaded = store.isLoaded;\r\n    const fileName = store.fileName;\r\n    const arrErrorsLoadedd = store.arrErrors;\r\n\r\n    const strMessageOnMenu = (isLoaded) ? 'File: ' + fileName : 'Press Open button to load scene';\r\n\r\n    const strProgressMsg = this.state.strProgressMessage;\r\n\r\n    const objPrgBarVis = \r\n      <Row>\r\n        <Col xs xl sm md lg=\"12\" style={{ width: '100%' } }>\r\n          {strProgressMsg}\r\n          <ProgressBar animated variant=\"success\"\r\n            now={this.state.progressBarRatio} label={`${this.state.progressBarRatio}%`}  />\r\n        </Col>\r\n      </Row>\r\n    const objProgressBar = (this.state.showProgressBar) ? objPrgBarVis : <p></p>;\r\n\r\n    const jsxNavBarReact = \r\n      <Container fluid=\"true\" style={{ height:'100%', minHeight:'100%' }}  >\r\n        <Navbar bg=\"light\" variant=\"light\" expand=\"lg\" >\r\n          <Navbar.Brand>\r\n            <UiAbout />\r\n          </Navbar.Brand>\r\n          <Navbar.Toggle aria-controls=\"basic-navbar-nav\" />\r\n          <Navbar.Collapse id=\"basic-navbar-nav\">\r\n            <Nav className=\"mr-auto\">\r\n\r\n              <Navbar.Text className=\"d-none d-sm-block\">\r\n                {strMessageOnMenu}\r\n              </Navbar.Text>\r\n\r\n              <UiOpenMenu fileNameOnLoad={this.m_fileNameOnLoad} />\r\n\r\n              <UiSaveMenu />\r\n              <UiReportMenu />\r\n              {(store.modeView === ModeView.VIEW_2D) ? <UiFilterMenu /> : <p></p>}\r\n              {(isLoaded && this.isWebGl20supported) ? <UiViewMode /> : <p></p>}\r\n            </Nav>\r\n          </Navbar.Collapse>\r\n\r\n        </Navbar>\r\n        {objProgressBar}\r\n        {(isLoaded) ? <UiMain /> : <p></p>}\r\n        {(arrErrorsLoadedd.length > 0) ? <UiErrConsole /> : <p></p>}\r\n        <UiModalText stateVis={this.state.showModalText}\r\n          onHide={this.onHideModalText} onShow={this.onShowModalText} />\r\n        <UiModalAlert stateVis={this.state.showModalAlert}\r\n          onHide={this.onHideModalAlert} onShow={this.onShowModalAlert} \r\n          title={this.state.strAlertTitle} text={this.state.strAlertText} />\r\n      </Container>;\r\n\r\n    return jsxNavBarReact;\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(UiApp);\r\n","import React from 'react';\r\nimport { connect } from 'react-redux';\r\n\r\nimport UiApp from './ui/UiApp';\r\n\r\nimport './App.css';\r\n\r\nclass App extends React.Component {\r\n  render() {\r\n    return <UiApp />\r\n  }\r\n}\r\n\r\nexport default connect(store => store)(App);\r\n","import 'bootstrap/dist/css/bootstrap.min.css';\r\nimport React from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport './index.css';\r\nimport * as serviceWorker from './serviceWorker';\r\nimport { Provider } from 'react-redux'\r\n\r\nimport { createStore } from 'redux';\r\nimport rootReducer from './demo/store/Store';\r\nimport App from './demo/App';\r\n\r\nconst rootElement = document.getElementById('root');\r\n\r\nconst store = createStore(rootReducer);\r\n\r\nReactDOM.render(<Provider store={store}>\r\n  <App />\r\n</Provider>,\r\nrootElement);\r\n\r\nserviceWorker.unregister();\r\n"],"sourceRoot":""}