(this.webpackJsonpmed3web=this.webpackJsonpmed3web||[]).push([[0],{143:function(e,t,i){},153:function(e,t){},154:function(e,t){},155:function(e,t){},156:function(e,t){},157:function(e,t){},158:function(e,t){},161:function(e,t){},163:function(e,t){},187:function(e,t,i){},188:function(e,t,i){"use strict";i.r(t);i(138);var a=i(0),o=i.n(a),r=i(24),n=i.n(r);i(143),Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));var s=i(14),l=i(70),m={SET_IS_LOADED:0,SET_FILENAME:1,SET_VOLUME_SET:2,SET_VOLUME_INDEX:3,SET_TEXTURE3D:4,SET_MODE_VIEW:5,SET_MODE_2D:6,SET_SLIDER_2D:7,SET_MODE_3D:8,SET_SLIDER_3DR:9,SET_SLIDER_3DG:10,SET_SLIDER_3DB:11,SET_SLIDER_Opacity:12,SET_SLIDER_Isosurface:13,SET_SLIDER_Brightness:14,SET_SLIDER_Cut:15,SET_SLIDER_Quality:16,SET_SLIDER_ErRadius:17,SET_SLIDER_ErDepth:18,SET_VOLUME_Renderer:19,SET_2D_TOOLS_INDEX:20,SET_2D_ZOOM:21,SET_2D_X_POS:22,SET_2D_Y_POS:23,SET_GRAPHICS_2D:24,SET_UI_APP:25,SET_DICOM_INFO:26,SET_IS_TOOL3D:27,SET_SLIDER_Contrast3D:28,SET_ERR_ARRAY:29,SET_MODE_3Droi:30,SET_DICOM_SERIES:31,SET_LOADER_DICOM:32},h={VIEW_NA:-1,VIEW_MPR:0,VIEW_2D:1,VIEW_3D_LIGHT:2,VIEW_3D:3,VIEW_COUNT:4},u={NA:-1,SAGGITAL:0,CORONAL:1,TRANSVERSE:2},c={NA:-1,ISO:0,RAYCAST:1,RAYFAST:2,EREASER:3},d={NA:-1,ISO:0,RAYCAST:1},_={isLoaded:!1,fileName:"brain.ktx",volumeSet:null,volumeIndex:0,texture3d:null,modeView:h.VIEW_2D,mode2d:u.TRANSVERSE,slider2d:.5,slider3d_r:.09,slider3d_g:.3,slider3d_b:.46,mode3d:c.RAYCAST,mode3droi:d.RAYCAST,sliderOpacity:.53,sliderIsosurface:.46,sliderBrightness:.56,sliderCut:1,sliderQuality:.35,sliderErRadius:50,sliderErDepth:50,volumeRenderer:null,indexTools2d:0,render2dZoom:1,render2dxPos:0,render2dyPos:0,graphics2d:null,uiApp:null,dicomInfo:null,isTool3D:!1,sliderContrast3D:0,arrErrors:[],dicomSeries:[],loaderDicom:null},f=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case m.SET_IS_LOADED:return Object.assign({},e,{isLoaded:t.isLoaded});case m.SET_FILENAME:return Object.assign({},e,{fileName:t.fileName});case m.SET_VOLUME_SET:return Object.assign({},e,{volumeSet:t.volumeSet});case m.SET_VOLUME_INDEX:return Object.assign({},e,{volumeIndex:t.volumeIndex});case m.SET_TEXTURE3D:return Object.assign({},e,{texture3d:t.texture3d});case m.SET_MODE_VIEW:return Object.assign({},e,{modeView:t.modeView});case m.SET_MODE_2D:return Object.assign({},e,{mode2d:t.mode2d});case m.SET_SLIDER_2D:return Object.assign({},e,{slider2d:t.slider2d});case m.SET_MODE_3D:return Object.assign({},e,{mode3d:t.mode3d});case m.SET_MODE_3Droi:return Object.assign({},e,{mode3droi:t.mode3droi});case m.SET_SLIDER_3DR:return Object.assign({},e,{slider3d_r:t.slider3d_r});case m.SET_SLIDER_3DG:return Object.assign({},e,{slider3d_g:t.slider3d_g});case m.SET_SLIDER_3DB:return Object.assign({},e,{slider3d_b:t.slider3d_b});case m.SET_SLIDER_Opacity:return Object.assign({},e,{sliderOpacity:t.sliderOpacity});case m.SET_SLIDER_Isosurface:return Object.assign({},e,{sliderIsosurface:t.sliderIsosurface});case m.SET_SLIDER_ErRadius:return Object.assign({},e,{sliderErRadius:t.sliderErRadius});case m.SET_SLIDER_ErDepth:return Object.assign({},e,{sliderErDepth:t.sliderErDepth});case m.SET_VOLUME_Renderer:return Object.assign({},e,{volumeRenderer:t.volumeRenderer});case m.SET_SLIDER_Brightness:return Object.assign({},e,{sliderBrightness:t.sliderBrightness});case m.SET_SLIDER_Cut:return Object.assign({},e,{sliderCut:t.sliderCut});case m.SET_SLIDER_Quality:return Object.assign({},e,{sliderQuality:t.sliderQuality});case m.SET_2D_TOOLS_INDEX:return Object.assign({},e,{indexTools2d:t.indexTools2d});case m.SET_2D_ZOOM:return Object.assign({},e,{render2dZoom:t.render2dZoom});case m.SET_2D_X_POS:return Object.assign({},e,{render2dxPos:t.render2dxPos});case m.SET_2D_Y_POS:return Object.assign({},e,{render2dyPos:t.render2dyPos});case m.SET_GRAPHICS_2D:return Object.assign({},e,{graphics2d:t.graphics2d});case m.SET_UI_APP:return Object.assign({},e,{uiApp:t.uiApp});case m.SET_DICOM_INFO:return Object.assign({},e,{dicomInfo:t.dicomInfo});case m.SET_IS_TOOL3D:return Object.assign({},e,{isTool3D:t.isTool3D});case m.SET_SLIDER_Contrast3D:return Object.assign({},e,{sliderContrast3D:t.sliderContrast3D});case m.SET_ERR_ARRAY:return Object.assign({},e,{arrErrors:t.arrErrors});case m.SET_DICOM_SERIES:return Object.assign({},e,{dicomSeries:t.dicomSeries});case m.SET_LOADER_DICOM:return Object.assign({},e,{loaderDicom:t.loaderDicom});default:return e}},v=i(3),p=i(4),g=i(13),S=i(12),y=i(6),x=i(197),b=i(133),D=i(209),T=i(196),E=i(206),M=i(201),w=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(){return Object(v.a)(this,i),t.apply(this,arguments)}return Object(p.a)(i,[{key:"render",value:function(){return o.a.createElement("p",null,"MPR is not implemented yet")}}]),i}(o.a.Component),R=Object(s.b)((function(e){return e}))(w),k=(i(41),i(208)),O=i(193),A=i(131),C=i(207),I=i(194),F=i(18),P=i.n(F),U=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onModeSaggital=a.onModeSaggital.bind(Object(y.a)(a)),a.onModeCoronal=a.onModeCoronal.bind(Object(y.a)(a)),a.onModeTransverse=a.onModeTransverse.bind(Object(y.a)(a)),a.onMode=a.onMode.bind(Object(y.a)(a)),a.m_updateEnable=!0,a}return Object(p.a)(i,[{key:"onMode",value:function(e){var t=this.props,i=t.graphics2d;this.m_updateEnable=!0,t.dispatch({type:m.SET_MODE_2D,mode2d:e}),i.m_mode2d=e,i.clear(),t.dispatch({type:m.SET_2D_ZOOM,render2dZoom:1}),t.dispatch({type:m.SET_2D_X_POS,render2dxPos:0}),t.dispatch({type:m.SET_2D_Y_POS,render2dyPos:0}),i.forceUpdate(),i.forceRender()}},{key:"onModeSaggital",value:function(){this.onMode(u.SAGGITAL)}},{key:"onModeCoronal",value:function(){this.onMode(u.CORONAL)}},{key:"onModeTransverse",value:function(){this.onMode(u.TRANSVERSE)}},{key:"onChangeSliderSlice",value:function(){if(void 0!==this.refs){this.m_updateEnable=!1;var e=0,t=this.refs.slider1.slider.get();if("string"===typeof t){e=Number.parseFloat(t);var i=this.props,a=i.mode2d,o=i.volumeSet,r=i.volumeIndex,n=o.getVolume(r),s=0,l=0,h=0;null!==n&&(s=n.m_xDim,l=n.m_yDim,h=n.m_zDim);var c=0;a===u.SAGGITAL?c=s:a===u.CORONAL?c=l:a===u.TRANSVERSE&&(c=h);var d=e/c;i.dispatch({type:m.SET_SLIDER_2D,slider2d:d});var _=i.graphics2d;_.clear(),_.forceUpdate(),_.forceRender()}}}},{key:"shouldComponentUpdate",value:function(){return this.m_updateEnable}},{key:"render",value:function(){var e=this.props,t=e.slider2d,i=e.mode2d,a=i===u.SAGGITAL?"primary":"secondary",r=i===u.CORONAL?"primary":"secondary",n=i===u.TRANSVERSE?"primary":"secondary",s=0,l=0,m=0,h=e.volumeSet;if(h.getNumVolumes()>0){var c=e.volumeIndex,d=h.getVolume(c);null!==d&&(s=d.m_xDim,l=d.m_yDim,m=d.m_zDim)}var _=0;i===u.SAGGITAL?_=s-1:i===u.CORONAL?_=l-1:i===u.TRANSVERSE&&(_=m-1);var f={min:0,max:_},v=[Math.floor(t*_)],p={to:function(e){return Math.floor(e).toString()},from:function(e){return parseInt(e)}},g=_>0?o.a.createElement("ul",{className:"list-group list-group-flush"},o.a.createElement("li",{className:"list-group-item"},o.a.createElement("p",null," Select "),o.a.createElement(P.a,{onSlide:this.onChangeSliderSlice.bind(this),ref:"slider1",range:f,start:v,step:1,format:p,tooltips:!0}))):o.a.createElement("p",null),S=_>0?o.a.createElement(k.a.Body,null,o.a.createElement(O.a,{className:"mr-2","aria-label":"Ctrl2d group"},o.a.createElement(C.a,{key:"zx",placement:"bottom",overlay:o.a.createElement(I.a,null,"Show slices along x axis")},o.a.createElement(A.a,{variant:a,onClick:this.onModeSaggital},"Saggital")),o.a.createElement(C.a,{key:"zy",placement:"bottom",overlay:o.a.createElement(I.a,null,"Show slices along y axis")},o.a.createElement(A.a,{variant:r,onClick:this.onModeCoronal},"Coronal")),o.a.createElement(C.a,{key:"za",placement:"bottom",overlay:o.a.createElement(I.a,null,"Show slices along z axis")},o.a.createElement(A.a,{variant:n,onClick:this.onModeTransverse},"Transverse")))):o.a.createElement("p",null);return o.a.createElement(k.a,null,o.a.createElement(k.a.Header,null,"Plane (slice) view"),S,g)}}]),i}(o.a.Component),X=Object(s.b)((function(e){return e}))(U),z=function(){function e(t){Object(v.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_strMessage="",this.m_xMessage=0,this.m_yMessage=0,this.m_timeStart=0,this.onTimerEnd=this.onTimerEnd.bind(this)}return Object(p.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"screenToTexture",value:function(e,t,i){var a={x:0,y:0,z:0},o=i.mode2d,r=i.slider2d,n=i.volumeSet,s=i.volumeIndex,l=n.getVolume(s),m=l.m_xDim,h=l.m_yDim,c=l.m_zDim,d=i.render2dZoom,_=i.render2dxPos,f=i.render2dyPos;return o===u.TRANSVERSE&&(a.x=Math.floor((_+e*d)*m),a.y=Math.floor((f+t*d)*h),a.z=Math.floor(r*c)),o===u.SAGGITAL&&(a.x=Math.floor(r*m),a.y=Math.floor((_+e*d)*h),a.z=Math.floor((f+t*d)*c)),o===u.CORONAL&&(a.x=Math.floor((_+e*d)*m),a.y=Math.floor(r*h),a.z=Math.floor((f+t*d)*c)),a}},{key:"onMouseDown",value:function(e,t,i){if(0!==this.m_wScreen&&0!==this.m_hScreen){var a=e/this.m_wScreen,o=t/this.m_hScreen;if(!(a>1||o>1)){var r=this.screenToTexture(a,o,i),n=i.volumeSet.getVolume(i.volumeIndex),s=n.m_xDim,l=n.m_yDim,m=n.m_bytesPerVoxel,h=r.x+r.y*s+r.z*s*l,u=0;1===m?u=n.m_dataArray[h]:4===m&&(h*=4,u=n.m_dataArray[h]),this.m_xMessage=e,this.m_yMessage=t,this.m_strMessage="x,y,z = "+r.x.toString()+", "+r.y.toString()+", "+r.z.toString()+". val = "+u.toString(),this.m_timeStart=Date.now(),setTimeout(this.onTimerEnd,1500)}}else console.log("ToolPick. onMouseDown. Bad screen size")}},{key:"onTimerEnd",value:function(){this.m_objGraphics2d.forceUpdate()}},{key:"render",value:function(e){if(0!==this.m_timeStart){if(Date.now()-this.m_timeStart<1200){e.fillStyle="white";e.font=16..toString()+"px Arial";var t=e.measureText(this.m_strMessage);this.m_xMessage+t.width<this.m_wScreen?e.textAlign="left":e.textAlign="right",this.m_yMessage+16<this.m_hScreen?e.textBaseline="top":e.textBaseline="bottom",e.fillText(this.m_strMessage,this.m_xMessage,this.m_yMessage)}}}}]),e}(),L=function(){function e(t){Object(v.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.setScreenDim=this.setScreenDim.bind(this),this.onMouseWheel=this.onMouseWheel.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.state={mouseDown:!1,xMouse:0,yMouse:0}}return Object(p.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"onMouseDown",value:function(e,t){this.state.mouseDown=!0,this.state.xMouse=e,this.state.yMouse=t}},{key:"onMouseUp",value:function(){this.state.mouseDown=!1}},{key:"onMouseMove",value:function(e,t,i){if(this.state.mouseDown){var a=t-this.state.xMouse,o=i-this.state.yMouse;this.state.xMouse=t,this.state.yMouse=i;var r=e.render2dZoom,n=a/this.m_wScreen*r,s=o/this.m_hScreen*r,l=e.render2dxPos-n,h=e.render2dyPos-s;if(l>=0&&l+r<=1&&h>=0&&h+r<=1)e.dispatch({type:m.SET_2D_X_POS,render2dxPos:l}),e.dispatch({type:m.SET_2D_Y_POS,render2dyPos:h}),e.graphics2d.forceUpdate()}}},{key:"onMouseWheel",value:function(e,t){var i=.04*-Math.max(-1,Math.min(1,t.deltaY||-t.detail)),a=e.render2dZoom,o=a+i;if(o>1&&(o-=i),o<=0&&(o+=i),o!==a){var r=e.render2dxPos-.5*i,n=e.render2dyPos-.5*i;e.dispatch({type:m.SET_2D_ZOOM,render2dZoom:o}),e.dispatch({type:m.SET_2D_X_POS,render2dxPos:r}),e.dispatch({type:m.SET_2D_Y_POS,render2dyPos:n}),e.graphics2d.forceUpdate()}}}]),e}(),N=function(){function e(t){Object(v.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_pointStart=null,this.m_lines=[],this.m_mouseDown=!1,this.m_objEdit=null,this.m_xPixelSize=0,this.m_yPixelSize=0}return Object(p.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"getEditPoint",value:function(t,i){for(var a=this.m_lines.length,o=0;o<a;o++){var r=this.m_lines[o],n=e.textureToScreen(r.vs.x,r.vs.y,this.m_wScreen,this.m_hScreen,i),s=e.textureToScreen(r.ve.x,r.ve.y,this.m_wScreen,this.m_hScreen,i);if(this.getDistMm(t,n)<=4)return this.m_objEdit=r,r.vs;if(this.getDistMm(t,s)<=4)return this.m_objEdit=r,r.ve}return null}},{key:"moveEditPoint",value:function(e,t){e.x=t.x,e.y=t.y,this.m_objEdit.distMm=this.getDistMm(this.m_objEdit.vs,this.m_objEdit.ve)}},{key:"deleteObject",value:function(){if(null!=this.m_objEdit){var e=this.m_lines.indexOf(this.m_objEdit);e>=0&&this.m_lines.splice(e,1)}}},{key:"getDistMm",value:function(e,t){var i=e.x-t.x,a=e.y-t.y;return Math.sqrt(i*i*this.m_xPixelSize*this.m_xPixelSize+a*a*this.m_yPixelSize*this.m_yPixelSize)}},{key:"onMouseDown",value:function(t,i,a){var o=e.screenToTexture(t,i,this.m_wScreen,this.m_hScreen,a),r={vs:{x:o.x,y:o.y},ve:{x:o.x,y:o.y},distMm:0};this.m_lines.push(r),this.m_mouseDown=!0}},{key:"onMouseMove",value:function(t,i,a){if(this.m_mouseDown){var o=e.screenToTexture(t,i,this.m_wScreen,this.m_hScreen,a),r={x:o.x,y:o.y},n=this.m_lines.length;if(n>0){var s=this.m_lines[n-1];s.ve=r,s.distMm=this.getDistMm(s.vs,s.ve);s.distMm>1e-5&&this.m_objGraphics2d.forceUpdate()}}}},{key:"onMouseUp",value:function(){this.m_mouseDown=!1;var e=this.m_lines.length;if(e>0){var t=this.m_lines[e-1];t.distMm=this.getDistMm(t.vs,t.ve);t.distMm<=1e-5&&(this.m_lines.pop(),console.log("ToolDistance: pop last line"))}}},{key:"clear",value:function(){this.m_lines=[]}},{key:"render",value:function(t,i){var a=this.m_lines.length;t.lineWidth=2,t.strokeStyle="yellow",t.fillStyle="white";t.font=16..toString()+"px Arial",t.textAlign="center",t.textBaseline="center";for(var o=0;o<a;o++){var r=this.m_lines[o],n=r.distMm,s=r.vs,l=r.ve,m=e.textureToScreen(s.x,s.y,this.m_wScreen,this.m_hScreen,i),h=e.textureToScreen(l.x,l.y,this.m_wScreen,this.m_hScreen,i);t.beginPath(),t.moveTo(m.x,m.y),t.lineTo(h.x,h.y),t.stroke();var u=Math.floor(.5*(m.x+h.x)),c=Math.floor(.5*(m.y+h.y)),d=n.toFixed(3)+" mm";t.fillText(d,u,c)}}}],[{key:"screenToTexture",value:function(e,t,i,a,o){var r=e/i,n=t/a,s=o.mode2d,l=o.volumeSet,m=o.volumeIndex,h=l.getVolume(m),c=h.m_xDim,d=h.m_yDim,_=h.m_zDim,f=o.render2dZoom,v=o.render2dxPos,p=o.render2dyPos,g={x:0,y:0};return s===u.TRANSVERSE&&(g.x=Math.floor((v+r*f)*c),g.y=Math.floor((p+n*f)*d)),s===u.SAGGITAL&&(g.x=Math.floor((v+r*f)*d),g.y=Math.floor((p+n*f)*_)),s===u.CORONAL&&(g.x=Math.floor((v+r*f)*c),g.y=Math.floor((p+n*f)*_)),g}},{key:"textureToScreen",value:function(e,t,i,a,o){var r={x:0,y:0},n=o.mode2d,s=o.volumeSet.getVolume(o.volumeIndex),l=s.m_xDim,m=s.m_yDim,h=s.m_zDim,c=o.render2dZoom,d=o.render2dxPos,_=o.render2dyPos;return n===u.TRANSVERSE&&(r.x=(e/l-d)/c,r.y=(t/m-_)/c),n===u.SAGGITAL&&(r.x=(e/m-d)/c,r.y=(t/h-_)/c),n===u.CORONAL&&(r.x=(e/l-d)/c,r.y=(t/h-_)/c),r.x*=i,r.y*=a,r}}]),e}(),V=function(){function e(t){Object(v.a)(this,e),this.m_objGraphics2d=t}return Object(p.a)(e,[{key:"clear",value:function(){this.m_objGraphics2d.clear()}}]),e}(),B=function(){function e(t){Object(v.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0;this.m_points=[{x:0,y:0},{x:0,y:0},{x:0,y:0}],this.m_numClicks=0,this.m_angles=[],this.m_objEdit=null,this.m_xPixelSize=0,this.m_yPixelSize=0,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this)}return Object(p.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"getEditPoint",value:function(e,t){for(var i=this.m_angles.length,a=0;a<i;a++){var o=this.m_angles[a],r=N.textureToScreen(o.points[0].x,o.points[0].y,this.m_wScreen,this.m_hScreen,t),n=N.textureToScreen(o.points[1].x,o.points[1].y,this.m_wScreen,this.m_hScreen,t),s=N.textureToScreen(o.points[2].x,o.points[2].y,this.m_wScreen,this.m_hScreen,t);if(this.getDistMm(e,r)<=4)return this.m_objEdit=o,o.points[0];if(this.getDistMm(e,n)<=4)return this.m_objEdit=o,o.points[1];if(this.getDistMm(e,s)<=4)return this.m_objEdit=o,o.points[2]}return null}},{key:"moveEditPoint",value:function(e,t){e.x=t.x,e.y=t.y,this.getAngleForObj(this.m_objEdit)}},{key:"deleteObject",value:function(){if(null!=this.m_objEdit){var e=this.m_angles.indexOf(this.m_objEdit);e>=0&&this.m_angles.splice(e,1)}}},{key:"getDistMm",value:function(e,t){var i=e.x-t.x,a=e.y-t.y;return Math.sqrt(i*i*this.m_xPixelSize*this.m_xPixelSize+a*a*this.m_yPixelSize*this.m_yPixelSize)}},{key:"getAngleForObj",value:function(e){for(var t=0;t<3;t++)this.m_points[t].x=e.points[t].x,this.m_points[t].y=e.points[t].y;var i=this.getAngle();e.angle=i}},{key:"getAngle",value:function(){var e=this.m_points[1].x-this.m_points[0].x,t=this.m_points[1].y-this.m_points[0].y,i=this.m_points[2].x-this.m_points[0].x,a=this.m_points[2].y-this.m_points[0].y,o=(e*i+t*a)/(Math.sqrt(e*e+t*t)*Math.sqrt(i*i+a*a));return o>1?0:o<-1?180:180*Math.acos(o)/3.1415926535}},{key:"onMouseDown",value:function(e,t,i){var a=N.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i);if(0===this.m_numClicks){for(var o=0;o<3;o++)this.m_points[o].x=a.x,this.m_points[o].y=a.y;this.m_numClicks++}else if(1===this.m_numClicks)this.m_numClicks++;else{console.log("3rd click: finalize angle");var r={points:[{x:this.m_points[0].x,y:this.m_points[0].y},{x:this.m_points[1].x,y:this.m_points[1].y},{x:this.m_points[2].x,y:this.m_points[2].y}],angle:this.getAngle()};this.m_angles.push(r),this.m_numClicks=0}}},{key:"onMouseMove",value:function(e,t,i){if(0!==this.m_numClicks){for(var a=N.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i),o=this.m_numClicks;o<3;o++)this.m_points[o].x=a.x,this.m_points[o].y=a.y;this.m_objGraphics2d.forceUpdate()}}},{key:"onMouseUp",value:function(){}},{key:"clear",value:function(){this.m_angles=[],this.m_numClicks=0}},{key:"render",value:function(e,t){e.lineWidth=2,e.strokeStyle="yellow",e.fillStyle="white";if(e.font=16..toString()+"px Arial",e.textAlign="center",e.textBaseline="top",this.m_numClicks>0){for(var i=1;i<3;i++){var a=this.m_points[0],o=this.m_points[i],r=N.textureToScreen(a.x,a.y,this.m_wScreen,this.m_hScreen,t),n=N.textureToScreen(o.x,o.y,this.m_wScreen,this.m_hScreen,t),s=r.x-n.x,l=r.y-n.y;s*s+l*l>=4&&(e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(n.x,n.y),e.stroke())}var m=0;this.m_numClicks>=2&&(m=this.getAngle());var h=m.toFixed(3)+"\xb0",u=this.m_points[0],c=N.textureToScreen(u.x,u.y,this.m_wScreen,this.m_hScreen,t),d=c.x,_=c.y+8;e.fillText(h,d,_)}for(var f=this.m_angles.length,v=0;v<f;v++){for(var p=this.m_angles[v],g=1;g<3;g++){var S=p.points[0],y=p.points[g],x=N.textureToScreen(S.x,S.y,this.m_wScreen,this.m_hScreen,t),b=N.textureToScreen(y.x,y.y,this.m_wScreen,this.m_hScreen,t);e.beginPath(),e.moveTo(x.x,x.y),e.lineTo(b.x,b.y),e.stroke()}var D=p.angle.toFixed(3)+"\xb0",T=p.points[0],E=N.textureToScreen(T.x,T.y,this.m_wScreen,this.m_hScreen,t),M=E.x,w=E.y+8;e.fillText(D,M,w)}}}]),e}(),j=function(){function e(t){Object(v.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_areas=[],this.m_inCreateMode=!1,this.m_objSelfIntersect=null,this.m_xPixelSize=0,this.m_yPixelSize=0,this.m_objEdit=null,this.store=null,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this)}return Object(p.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"clear",value:function(){this.m_areas=[],this.m_inCreateMode=!1,this.m_objSelfIntersect=null}},{key:"getEditPoint",value:function(e,t){this.store=t;for(var i=this.m_areas.length,a=0;a<i;a++)for(var o=this.m_areas[a],r=0;r<o.m_points.length;r++){var n=N.textureToScreen(o.m_points[r].x,o.m_points[r].y,this.m_wScreen,this.m_hScreen,t);if(this.getDistMm(e,n)<=4)return this.m_objEdit=o,o.m_points[r]}return null}},{key:"moveEditPoint",value:function(t,i){var a=t.x,o=t.y;t.x=i.x,t.y=i.y,e.hasSelfIntersection(this.m_objEdit.m_points)&&(t.x=a,t.y=o);var r=this.store;this.m_objEdit.m_area=this.getPolyArea(this.m_objEdit.m_points,r)}},{key:"deleteObject",value:function(){if(null!=this.m_objEdit){var e=this.m_areas.indexOf(this.m_objEdit);e>=0&&this.m_areas.splice(e,1)}}},{key:"getDistMm",value:function(e,t){var i=e.x-t.x,a=e.y-t.y;return Math.sqrt(i*i*this.m_xPixelSize*this.m_xPixelSize+a*a*this.m_yPixelSize*this.m_yPixelSize)}},{key:"addPointToPolygon",value:function(e,t){var i=t.length;if(0===i)return t.push(e),!1;var a=this.m_objSelfIntersect;if(null!==a){var o=[];o.push(a.m_vIntersection);for(var r=a.m_lineIndex+1;r<i-1;r++){var n={x:t[r].x,y:t[r].y};o.push(n)}t.length=o.length;for(var s=0;s<o.length;s++)t[s].x=o[s].x,t[s].y=o[s].y;return this.m_objSelfIntersect=null,!0}return t.push(e),!1}},{key:"getPolyArea",value:function(e,t){var i=t.volumeSet,a=t.volumeIndex,o=i.getVolume(a),r=o.m_boxSize.x,n=o.m_boxSize.y,s=o.m_boxSize.z,l=t.mode2d,m=o.m_xDim,h=o.m_yDim,c=o.m_zDim,d=0,_=0;l===u.TRANSVERSE?(d=r/m,_=n/h):l===u.SAGGITAL?(d=n/m,_=s/c):(d=r/m,_=s/c);for(var f=0,v=e.length,p=v-1,g=0;g<v;g++){var S=e[g],y=e[p],x=(y.x+S.x)*(y.y-S.y)*d*_;f+=x=x>0?x:-x,p=g}return.5*f}},{key:"onMouseDown",value:function(e,t,i){var a=N.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i);if(this.m_inCreateMode){var o={x:a.x,y:a.y},r=this.m_areas.length,n=this.m_areas[r-1];this.addPointToPolygon(o,n.m_points)&&(n.m_isClosed=!0,n.m_area=this.getPolyArea(n.m_points,i),console.log("ToolArea. area = ".concat(n.m_area)),this.m_inCreateMode=!1)}else{this.m_inCreateMode=!0;var s={x:a.x,y:a.y},l={x:a.x,y:a.y},m={m_isClosed:!1,m_points:[],m_area:0};m.m_points.push(s),m.m_points.push(l),this.m_areas.push(m)}}},{key:"onMouseMove",value:function(t,i,a){if(this.m_inCreateMode){var o=N.screenToTexture(t,i,this.m_wScreen,this.m_hScreen,a),r=this.m_areas.length,n=this.m_areas[r-1],s=n.m_points.length;n.m_points[s-1].x=o.x,n.m_points[s-1].y=o.y;var l=e.getSelfIntersectPoint(n.m_points);this.m_objSelfIntersect=l,this.m_objGraphics2d.forceUpdate()}}},{key:"onMouseUp",value:function(){}},{key:"render",value:function(e,t){e.lineWidth=2,e.strokeStyle="yellow",e.fillStyle="white";if(e.font=16..toString()+"px Arial",e.textAlign="center",e.textBaseline="bottom",null!==this.m_objSelfIntersect){var i=this.m_objSelfIntersect.m_vIntersection,a=N.textureToScreen(i.x,i.y,this.m_wScreen,this.m_hScreen,t);e.strokeStyle="red",e.beginPath();e.arc(a.x,a.y,5,0,6.283185307),e.stroke()}e.strokeStyle="yellow";for(var o=this.m_areas.length,r=0;r<o;r++){var n=this.m_areas[r],s=n.m_isClosed,l=s?n.m_points.length+1:n.m_points.length,m=0,h=0;e.beginPath();for(var u=0;u<l;u++){var c=u<n.m_points.length?u:0,d=n.m_points[c],_=N.textureToScreen(d.x,d.y,this.m_wScreen,this.m_hScreen,t);0===u?e.moveTo(_.x,_.y):e.lineTo(_.x,_.y),m+=_.x,h+=_.y}if(e.stroke(),l>0&&(m/=l,h/=l),s){var f=n.m_area.toFixed(2)+" mm^2";e.fillText(f,m,h)}}}}],[{key:"getLineIntersection",value:function(e,t,i,a){var o={x:a.x-i.x,y:a.y-i.y},r=-o.y,n=o.x,s={x:t.x-e.x,y:t.y-e.y},l=i.x-e.x,m=i.y-e.y,h=l*r+m*n,u=s.x*r+s.y*n,c=1e-6;if(Math.abs(u)<c)return null;var d=h/u;if(d<0||d>1)return null;var _=-l,f=-m,v=-s.y,p=s.x,g=o.x*v+o.y*p;if(Math.abs(g)<c)return null;var S=(_*v+f*p)/g;return S<0||S>1?null:{x:e.x+s.x*d,y:e.y+s.y*d}}},{key:"hasSelfIntersection",value:function(t){var i,a;for(i=0;i<t.length;i++){var o=i+1<t.length?i+1:0,r=t[i],n=t[o];for(a=0;a<t.length;a++){var s=a+1<t.length?a+1:0;if(i!==a&&i!==s&&o!==a&&o!==s){var l=t[a],m=t[s];if(null!==e.getLineIntersection(r,n,l,m))return!0}}}return!1}},{key:"getSelfIntersectPoint",value:function(t){var i=t.length;if(i<=3)return null;for(var a=t[i-2],o=t[i-1],r=i-3,n=0;n<r;n++){var s=t[n+0],l=t[n+1],m=e.getLineIntersection(a,o,s,l);if(null!==m)return{m_vIntersection:m,m_lineIndex:n}}var h=o.x-t[0].x,u=o.y-t[0].y;return h*h+u*u<=6.25?{m_vIntersection:{x:o.x,y:o.y},m_lineIndex:0}:null}}]),e}(),G=function(){function e(t){Object(v.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_rects=[],this.m_inCreateMode=!1,this.m_xPixelSize=0,this.m_yPixelSize=0,this.m_store=null,this.m_objEdit=null,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this)}return Object(p.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"clear",value:function(){this.m_rects=[],this.m_inCreateMode=!1}},{key:"getDistMm",value:function(e,t){var i=e.x-t.x,a=e.y-t.y;return Math.sqrt(i*i*this.m_xPixelSize*this.m_xPixelSize+a*a*this.m_yPixelSize*this.m_yPixelSize)}},{key:"getEditPoint",value:function(e,t){for(var i=this.m_rects.length,a=0;a<i;a++){var o=this.m_rects[a],r=N.textureToScreen(o.vMin.x,o.vMin.y,this.m_wScreen,this.m_hScreen,t),n=N.textureToScreen(o.vMax.x,o.vMax.y,this.m_wScreen,this.m_hScreen,t);if(this.getDistMm(e,r)<=4)return this.m_objEdit=o,o.vMin;if(this.getDistMm(e,n)<=4)return this.m_objEdit=o,o.vMax}return null}},{key:"moveEditPoint",value:function(e,t){e.x=t.x,e.y=t.y,this.getRectArea(this.m_objEdit,this.m_store)}},{key:"deleteObject",value:function(){if(null!=this.m_objEdit){var e=this.m_rects.indexOf(this.m_objEdit);e>=0&&this.m_rects.splice(e,1)}}},{key:"getRectArea",value:function(e,t){var i=t.volumeSet,a=t.volumeIndex,o=i.getVolume(a),r=o.m_boxSize.x,n=o.m_boxSize.y,s=o.m_boxSize.z,l=t.mode2d,m=o.m_xDim,h=o.m_yDim,c=o.m_zDim,d=0,_=0;l===u.TRANSVERSE?(d=r/m,_=n/h):l===u.SAGGITAL?(d=n/m,_=s/c):(d=r/m,_=s/c);var f=Math.abs(e.vMax.x-e.vMin.x),v=Math.abs(e.vMax.y-e.vMin.y);e.area=d*_*f*v}},{key:"onMouseDown",value:function(e,t,i){this.m_store=i;var a=N.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i);if(this.m_inCreateMode)this.m_inCreateMode=!1;else{this.m_inCreateMode=!0;var o={vMin:{x:a.x,y:a.y},vMax:{x:a.x,y:a.y},area:0};this.m_rects.push(o)}}},{key:"onMouseMove",value:function(e,t,i){if(this.m_inCreateMode){var a=N.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i),o=this.m_rects.length,r=this.m_rects[o-1];r.vMax.x=a.x,r.vMax.y=a.y,this.getRectArea(r,i),this.m_objGraphics2d.forceUpdate()}}},{key:"onMouseUp",value:function(){}},{key:"render",value:function(e,t){e.lineWidth=2,e.strokeStyle="yellow",e.fillStyle="white";e.font=16..toString()+"px Arial",e.textAlign="center",e.textBaseline="bottom";for(var i=this.m_rects.length,a=0;a<i;a++){var o=this.m_rects[a],r=o.vMin,n=o.vMax,s=N.textureToScreen(r.x,r.y,this.m_wScreen,this.m_hScreen,t),l=N.textureToScreen(n.x,n.y,this.m_wScreen,this.m_hScreen,t);e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(l.x,s.y),e.lineTo(l.x,l.y),e.lineTo(s.x,l.y),e.lineTo(s.x,s.y),e.stroke();var m=Math.floor(.5*(s.x+l.x)),h=Math.floor(.5*(s.y+l.y)),u=o.area.toFixed(2)+" mm^2";e.fillText(u,m,h)}}}]),e}(),W=function(){function e(t){Object(v.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_texts=[],this.m_pointPressed=null,this.m_objEdit=null,this.m_xPixelSize=0,this.m_yPixelSize=0,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this),this.setText=this.setText.bind(this)}return Object(p.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"getEditPoint",value:function(e,t){for(var i=this.m_texts.length,a=0;a<i;a++){var o=this.m_texts[a],r=N.textureToScreen(o.point.x,o.point.y,this.m_wScreen,this.m_hScreen,t);if(this.getDistMm(e,r)<=4)return this.m_objEdit=o,o.point}return null}},{key:"moveEditPoint",value:function(e,t){e.x=t.x,e.y=t.y}},{key:"deleteObject",value:function(){if(null!=this.m_objEdit){var e=this.m_texts.indexOf(this.m_objEdit);e>=0&&this.m_texts.splice(e,1)}}},{key:"getDistMm",value:function(e,t){var i=e.x-t.x,a=e.y-t.y;return Math.sqrt(i*i*this.m_xPixelSize*this.m_xPixelSize+a*a*this.m_yPixelSize*this.m_yPixelSize)}},{key:"setText",value:function(e){this.m_text=e,console.log("set text = ".concat(e));var t={point:{x:this.m_pointPressed.x,y:this.m_pointPressed.y},text:e};this.m_texts.push(t),this.m_objGraphics2d.forceUpdate()}},{key:"clear",value:function(){this.m_texts=[]}},{key:"onMouseDown",value:function(e,t,i){var a=N.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i);this.m_pointPressed=a,i.uiApp.onShowModalText()}},{key:"onMouseMove",value:function(){}},{key:"onMouseUp",value:function(){}},{key:"render",value:function(e,t){e.lineWidth=2,e.strokeStyle="yellow",e.fillStyle="white";e.font=16..toString()+"px Arial",e.textAlign="center",e.textBaseline="bottom";for(var i=this.m_texts.length,a=0;a<i;a++){var o=this.m_texts[a],r=o.point,n=N.textureToScreen(r.x,r.y,this.m_wScreen,this.m_hScreen,t),s=o.text;e.fillText(s,n.x,n.y)}}}]),e}(),H=function(){function e(t){Object(v.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_xPixelSize=0,this.m_yPixelSize=0,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this),this.m_mousePressed=!1,this.m_pointTracked=null,this.m_toolTracked=null}return Object(p.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"clear",value:function(){this.m_mousePressed=!1,this.m_pointTracked=null,this.m_toolTracked=null}},{key:"onMouseDown",value:function(){this.m_mousePressed=!0}},{key:"onMouseMove",value:function(e,t,i){if(this.m_mousePressed){if(null!==this.m_pointTracked){var a=N.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i);this.m_toolTracked.moveEditPoint(this.m_pointTracked,a),this.m_objGraphics2d.forceUpdate()}}else{var o={x:e,y:t},r=[this.m_objGraphics2d.m_toolDistance,this.m_objGraphics2d.m_toolAngle,this.m_objGraphics2d.m_toolArea,this.m_objGraphics2d.m_toolRect,this.m_objGraphics2d.m_toolText],n=null!==this.m_pointTracked;this.m_pointTracked=null;for(var s=r.length,l=0;l<s;l++){var m=r[l],h=m.getEditPoint(o,i);if(null!==h){this.m_pointTracked=h,this.m_toolTracked=m;break}}var u=null!==this.m_pointTracked;(u||n&&!u)&&this.m_objGraphics2d.forceUpdate()}}},{key:"onMouseUp",value:function(){this.m_mousePressed=!1}},{key:"render",value:function(e,t){if(null!==this.m_pointTracked){var i=N.textureToScreen(this.m_pointTracked.x,this.m_pointTracked.y,this.m_wScreen,this.m_hScreen,t);e.fillStyle="rgb(120, 250, 120)",e.beginPath(),e.arc(i.x,i.y,4,0,6.2831924,!1),e.fill()}}}]),e}(),q=function(){function e(t){Object(v.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_xPixelSize=0,this.m_yPixelSize=0,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this),this.m_mousePressed=!1,this.m_pointTracked=null,this.m_toolTracked=null}return Object(p.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"clear",value:function(){this.m_mousePressed=!1,this.m_pointTracked=null,this.m_toolTracked=null}},{key:"onMouseDown",value:function(){this.m_mousePressed=!0,null!==this.m_pointTracked&&(this.m_toolTracked.deleteObject(this.m_pointTracked),this.m_pointTracked=null,this.m_objGraphics2d.forceUpdate())}},{key:"onMouseMove",value:function(e,t,i){if(!this.m_mousePressed){var a={x:e,y:t},o=[this.m_objGraphics2d.m_toolDistance,this.m_objGraphics2d.m_toolAngle,this.m_objGraphics2d.m_toolArea,this.m_objGraphics2d.m_toolRect,this.m_objGraphics2d.m_toolText],r=null!==this.m_pointTracked;this.m_pointTracked=null;for(var n=o.length,s=0;s<n;s++){var l=o[s],m=l.getEditPoint(a,i);if(null!==m){this.m_pointTracked=m,this.m_toolTracked=l;break}}var h=null!==this.m_pointTracked;(h||r&&!h)&&this.m_objGraphics2d.forceUpdate()}}},{key:"onMouseUp",value:function(){this.m_mousePressed=!1}},{key:"render",value:function(e,t){if(null!==this.m_pointTracked){var i=N.textureToScreen(this.m_pointTracked.x,this.m_pointTracked.y,this.m_wScreen,this.m_hScreen,t);e.fillStyle="rgb(250, 120, 120)",e.beginPath(),e.arc(i.x,i.y,4,0,6.2831924,!1),e.fill()}}}]),e}(),Y={INTENSITY:0,DISTANCE:1,ANGLE:2,AREA:3,RECT:4,TEXT:5,EDIT:6,DELETE:7,CLEAR:8,ZOOM:9,DEFAULT:10,FILTER:11,NONE:12},Z=i(61),K=i.n(Z),Q=i(98),J=i(62),$=240,ee=160,te=function(){function e(t){Object(v.a)(this,e),this.stage=0,this.objGraphics2d=t,this.model=null,this.tensorIndices=null,this.imgData=null,this.pixels=null,this.srcImageData=null,this.wSrc=-1,this.hSrc=-1,this.onLoadModel=this.onLoadModel.bind(this),this.startApplyImage=this.startApplyImage.bind(this),this.m_needApplySegmentation=!1}return Object(p.a)(e,[{key:"printTensor",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:192;console.log("tensor shape = "+e.shape);for(var i=e.dataSync(),a="",o=0;o<t;o++)a+=i[o].toString()+", ";console.log("tensor raw data = "+a)}},{key:"printTensorIndices",value:function(e){var t=e.shape[1],i=e.shape[0],a=e.dataSync();console.log("Tensor indices");for(var o=0,r=0;r<i;r++){for(var n="",s=0;s<t;s++){n+=a[o++].toString()}console.log(n)}}},{key:"scaleUp",value:function(e,t,i,a,o,r){for(var n=t/o,s=i/r,l=0,m=0,h=0;h<r;h++,l+=s)for(var u=Math.floor(l),c=(u+(l-u<.5?0:1))*t,d=0,_=0;_<o;_++,d+=n){var f=Math.floor(d),v=f+(d-f<.5?0:1);a[m++]=e[v+c]}}},{key:"onLoadModel",value:function(){var e=Object(Q.a)(K.a.mark((function e(){var t;return K.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.stage=1,this.pixels=null,console.log("Loading tfjs model..."),e.next=5,J.b("http://lugachai.ru/med3web/tfjs/model.json",{strict:!1});case 5:t=e.sent,this.model=t,this.stage=2,console.log("Model is loaded shape = "+t.output.shape),this.startApplyImage();case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"startApplyImage",value:function(){var e=Object(Q.a)(K.a.mark((function e(){var t,i,a,o,r,n,s,l,m,h,u,c,d,_,f,v,p,g,S,y,x,b,D,T,E,M,w;return K.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(this.stage=3,console.log("Start apply segm to image ..."),t=J.a.fromPixels(this.srcImageData).toFloat(),320,480,i=t.resizeBilinear([320,480]),a=J.c([123,116,103]),o=i.sub(a),r=o.reshape([1,320,480,3]),n=this.model.predict(r),s=n.as2D(38400,96),l=s.reshape([ee,$,96]),m=l.dataSync(),this.tensorIndices=new J.d([ee,$],"int32"),h=this.tensorIndices.dataSync(),u=0,c=0,d=0;d<ee;d++)for(_=0;_<$;_++){for(f=-1,v=-.1,p=0;p<96;p++)m[u+p]>v&&(v=m[u+p],f=p);h[c]=f,u+=96,c+=1}for(g=new Uint8ClampedArray(this.wSrc*this.hSrc),this.scaleUp(h,$,ee,g,this.wSrc,this.hSrc),S=new Uint8ClampedArray(1024),y=0,x=0,S[x++]=0,S[x++]=0,S[x++]=255,S[x++]=255,y++,S[x++]=0,S[x++]=255,S[x++]=0,S[x++]=255,y++,S[x++]=255,S[x++]=0,S[x++]=0,S[x++]=255,y++,S[x++]=255,S[x++]=0,S[x++]=255,S[x++]=255,y++,S[x++]=64,S[x++]=200,S[x++]=255,S[x++]=255,y++;y<256;y++,x+=4)S[x+0]=Math.floor(255*Math.random()),S[x+1]=Math.floor(255*Math.random()),S[x+2]=Math.floor(255*Math.random()),S[x+3]=255;for(this.pixels=new Uint8ClampedArray(this.wSrc*this.hSrc*4),b=this.pixels,D=this.wSrc,T=this.hSrc,y=0,x=0,E=0;E<T;E++)for(M=0;M<D;M++)w=g[y],b[x+0]=S[4*w+0],b[x+1]=S[4*w+1],b[x+2]=S[4*w+2],b[x+3]=255,y++,x+=4;this.stage=4,console.log("Segm complete now "),this.objGraphics2d.forceRender();case 59:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getStageString",value:function(){return["Wait. Model is not loaded","Wait. Model is loading ...","Model is ready","Image is processed ...","Segmentation is ready"][this.stage]}},{key:"setImageData",value:function(e){this.srcImageData=e}},{key:"render",value:function(e,t,i,a){this.srcImageData=a,this.wSrc=t,this.hSrc=i,console.log("Segm2d render. VGG model "+(null===this.model?"not loaded":"loaded"));var o=this.getStageString();if(console.log("Segm2d render. stage = "+o),4!==this.stage||null===this.pixels){e.fillStyle="rgb(64, 64, 64)",e.fillRect(0,0,t,i),e.strokeStyle="#FF0000",e.beginPath(),e.moveTo(0,0),e.lineTo(t-1,i-1),e.stroke(),e.beginPath(),e.moveTo(t-1,0),e.lineTo(0,i-1),e.stroke();var r=this.getStageString();e.font="24px serif",e.fillStyle="rgb(64, 255, 64)",e.fillText(r,t/2,i/2)}else{this.imgData=e.createImageData(t,i);for(var n=this.imgData.data,s=t*i*4,l=0;l<s;l++)n[l]=this.pixels[l];e.putImageData(this.imgData,0,0)}}}]),e}(),ie=function(){function e(){Object(v.a)(this,e),this.m_palette=[{name:"amygdala",roiColor:"0.247059 0.584314 0.270588 1",roiId:139,position:"right",isBrain:!0},{name:"amygdala",roiColor:"0.309804 0.929412 0.054902 1",roiId:118,position:"left",isBrain:!0},{name:"angular gyrus",roiColor:"0.686275 0.231373 0.152941 1",roiId:19,position:"right",isBrain:!0},{name:"angular gyrus",roiColor:"0.811765 0.486275 0.117647 1",roiId:159,position:"left",isBrain:!0},{name:"anterior limb of internal capsule",roiColor:"0.309804 0.203922 0.462745 1",roiId:128,position:"right",isBrain:!0},{name:"anterior limb of internal capsule",roiColor:"0.435294 0.733333 0.027451 1",roiId:43,position:"left",isBrain:!0},{roiColor:"0.937255 0.94902 0.513725 1",roiId:20,name:"brain stem",isBrain:!0},{name:"caudate nucleus",roiColor:"0.74902 0.278431 0.141176 1",roiId:53,position:"right",isBrain:!0},{name:"caudate nucleus",roiColor:"0.184314 0.0745098 0.356863 1",roiId:39,position:"left",isBrain:!0},{name:"cerebellum",roiColor:"0.811765 0.458824 0.952941 1",roiId:76,position:"right",isBrain:!0},{name:"cerebellum",roiColor:"0.247059 0.113725 0.843137 1",roiId:67,position:"left",isBrain:!0},{name:"cingulate region",roiColor:"0.623529 0.45098 0.666667 1",roiId:7,position:"right",isBrain:!0},{name:"cingulate region",roiColor:"0.937255 0.631373 0.505882 1",roiId:27,position:"left",isBrain:!0},{roiColor:"0.937255 0.301961 0.470588 1",roiId:133,name:"corpus callosum",isBrain:!0},{name:"cuneus",roiColor:"0.435294 0.513725 0.768627 1",roiId:175,position:"right",isBrain:!0},{name:"cuneus",roiColor:"0.937255 0.729412 0.192157 1",roiId:54,position:"left",isBrain:!0},{name:"fornix",roiColor:"0.937255 0.415686 0.847059 1",roiId:254,position:"right",isBrain:!0},{name:"fornix",roiColor:"0.811765 0.67451 0.980392 1",roiId:29,position:"left",isBrain:!0},{roiColor:"0.247059 0.466667 0.105882 1",roiId:233,name:"fourth ventricle",isBrain:!0},{name:"frontal lobe WM",roiColor:"0.560784 0.290196 0.215686 1",roiId:17,position:"right",isBrain:!0},{name:"frontal lobe WM",roiColor:"0.498039 0.662745 0.101961 1",roiId:30,position:"left",isBrain:!0},{name:"globus palladus",roiColor:"0.0588235 0.843137 0.168627 1",roiId:11,position:"right",isBrain:!0},{name:"globus palladus",roiColor:"0.247059 0.74902 0.447059 1",roiId:12,position:"left",isBrain:!0},{name:"hippocampal formation",roiColor:"0.498039 0.709804 0.619608 1",roiId:36,position:"right",isBrain:!0},{name:"hippocampal formation",roiColor:"0.121569 0.4 0.972549 1",roiId:101,position:"left",isBrain:!0},{name:"inferior frontal gyrus",roiColor:"0.247059 0.85098 0.0666667 1",roiId:75,position:"right",isBrain:!0},{name:"inferior frontal gyrus",roiColor:"0.937255 0.662745 0.329412 1",roiId:15,position:"left",isBrain:!0},{name:"inferior occipital gyrus",roiColor:"0.0588235 0.643137 0.643137 1",roiId:97,position:"right",isBrain:!0},{name:"inferior occipital gyrus",roiColor:"0.247059 0.411765 0.568627 1",roiId:37,position:"left",isBrain:!0},{name:"inferior temporal gyrus",roiColor:"0.247059 0.00392157 0.796078 1",roiId:140,position:"right",isBrain:!0},{name:"inferior temporal gyrus",roiColor:"0.87451 0.819608 0.541176 1",roiId:164,position:"left",isBrain:!0},{name:"insula",roiColor:"0.623529 0.886275 0.356863 1",roiId:4,position:"right",isBrain:!0},{name:"insula",roiColor:"0.560784 0.698039 0.12549 1",roiId:108,position:"left",isBrain:!0},{name:"lateral front-orbital gyrus",roiColor:"0.435294 0.501961 0.203922 1",roiId:6,position:"right",isBrain:!0},{name:"lateral front-orbital gyrus",roiColor:"1 0.8 0.00784314 1",roiId:90,position:"left",isBrain:!0},{name:"lateral occipitotemporal gyrus",roiColor:"0.0588235 0.027451 0.470588 1",roiId:99,position:"right",isBrain:!0},{name:"lateral occipitotemporal gyrus",roiColor:"0.937255 0.101961 0.913725 1",roiId:196,position:"left",isBrain:!0},{name:"lateral ventricle",roiColor:"0.435294 0.176471 0.568627 1",roiId:8,position:"right",isBrain:!0},{name:"lateral ventricle",roiColor:"0.74902 0.764706 0.247059 1",roiId:3,position:"left",isBrain:!0},{name:"lingual gyrus",roiColor:"0.435294 0.458824 0.47451 1",roiId:112,position:"right",isBrain:!0},{name:"lingual gyrus",roiColor:"0.811765 0.0941176 0.301961 1",roiId:69,position:"left",isBrain:!0},{name:"medial front-orbital gyrus",roiColor:"0.87451 0.364706 0.384314 1",roiId:1,position:"right",isBrain:!0},{name:"medial front-orbital gyrus",roiColor:"0.811765 0.160784 0.247059 1",roiId:85,position:"left",isBrain:!0},{name:"medial frontal gyrus",roiColor:"0.435294 0.615686 0.0705882 1",roiId:114,position:"right",isBrain:!0},{name:"medial frontal gyrus",roiColor:"0.184314 0.372549 0.423529 1",roiId:9,position:"left",isBrain:!0},{name:"medial occipitotemporal gyrus",roiColor:"0.247059 0.368627 0.211765 1",roiId:165,position:"right",isBrain:!0},{name:"medial occipitotemporal gyrus",roiColor:"1 0.843137 0.254902 1",roiId:119,position:"left",isBrain:!0},{name:"middle frontal gyrus",roiColor:"0.623529 0.905882 0.113725 1",roiId:2,position:"right",isBrain:!0},{name:"middle frontal gyrus",roiColor:"0.686275 0.0901961 0.811765 1",roiId:50,position:"left",isBrain:!0},{name:"middle occipital gyrus",roiColor:"0.686275 0.933333 0.698039 1",roiId:63,position:"right",isBrain:!0},{name:"middle occipital gyrus",roiColor:"0.435294 0.0588235 0.964706 1",roiId:154,position:"left",isBrain:!0},{name:"middle temporal gyrus",roiColor:"0.937255 0.498039 0.67451 1",roiId:130,position:"right",isBrain:!0},{name:"middle temporal gyrus",roiColor:"0.498039 0.768627 0.439216 1",roiId:64,position:"left",isBrain:!0},{name:"nucleus accumbens",roiColor:"1 0.807843 0.529412 1",roiId:25,position:"right",isBrain:!0},{name:"nucleus accumbens",roiColor:"0.0588235 0.65098 0.0509804 1",roiId:72,position:"left",isBrain:!0},{name:"occipital lobe WM",roiColor:"0.0588235 0.368627 0.552941 1",roiId:45,position:"right",isBrain:!0},{name:"occipital lobe WM",roiColor:"0.0588235 0.639216 0.839216 1",roiId:73,position:"left",isBrain:!0},{name:"occipital pole",roiColor:"0.74902 0.494118 0.419608 1",roiId:132,position:"right",isBrain:!0},{name:"occipital pole",roiColor:"0.247059 0.807843 0.74902 1",roiId:251,position:"left",isBrain:!0},{name:"parahippocampal gyrus",roiColor:"0.121569 0.847059 0.00392157 1",roiId:125,position:"right",isBrain:!0},{name:"parahippocampal gyrus",roiColor:"0.247059 0.0705882 0.321569 1",roiId:18,position:"left",isBrain:!0},{name:"parietal lobe WM",roiColor:"1 0.4 0.223529 1",roiId:105,position:"right",isBrain:!0},{name:"parietal lobe WM",roiColor:"0.309804 0.678431 0.639216 1",roiId:57,position:"left",isBrain:!0},{name:"postcentral gyrus",roiColor:"0.560784 0.478431 0.2 1",roiId:110,position:"right",isBrain:!0},{name:"postcentral gyrus",roiColor:"0.498039 0.576471 0.027451 1",roiId:74,position:"left",isBrain:!0},{name:"posterior limb of internal capsule inc. cerebral peduncle",roiColor:"1 0.917647 0.576471 1",roiId:35,position:"right",isBrain:!0},{name:"posterior limb of internal capsule inc. cerebral peduncle",roiColor:"0.435294 0.490196 0.0784314 1",roiId:34,position:"left",isBrain:!0},{name:"precentral gyrus",roiColor:"0.184314 0.709804 0.615686 1",roiId:5,position:"right",isBrain:!0},{name:"precentral gyrus",roiColor:"0.87451 0.560784 1 1",roiId:80,position:"left",isBrain:!0},{name:"precuneus",roiColor:"1 0.654902 0.223529 1",roiId:32,position:"right",isBrain:!0},{name:"precuneus",roiColor:"1 0 0.211765 1",roiId:56,position:"left",isBrain:!0},{name:"putamen",roiColor:"1 0.831373 0.227451 1",roiId:16,position:"right",isBrain:!0},{name:"putamen",roiColor:"0.372549 0.678431 0.32549 1",roiId:14,position:"left",isBrain:!0},{name:"subthalamic nucleus",roiColor:"0.184314 0.545098 0.619608 1",roiId:23,position:"right",isBrain:!0},{name:"subthalamic nucleus",roiColor:"0.309804 0.686275 0.243137 1",roiId:33,position:"left",isBrain:!0},{name:"superior frontal gyrus",roiColor:"0.87451 0.380392 0.768627 1",roiId:10,position:"right",isBrain:!0},{name:"superior frontal gyrus",roiColor:"1 0.113725 0.396078 1",roiId:70,position:"left",isBrain:!0},{name:"superior occipital gyrus",roiColor:"0.372549 0.0431373 0.537255 1",roiId:38,position:"right",isBrain:!0},{name:"superior occipital gyrus",roiColor:"0.623529 0.301961 0.2 1",roiId:98,position:"left",isBrain:!0},{name:"superior parietal lobule",roiColor:"0.247059 0.843137 0.407843 1",roiId:88,position:"right",isBrain:!0},{name:"superior parietal lobule",roiColor:"0.87451 0.533333 0.254902 1",roiId:52,position:"left",isBrain:!0},{name:"superior temporal gyrus",roiColor:"0.498039 0.721569 0.996078 1",roiId:145,position:"right",isBrain:!0},{name:"superior temporal gyrus",roiColor:"1 0.67451 0.45098 1",roiId:61,position:"left",isBrain:!0},{name:"supramarginal gyrus",roiColor:"0.87451 0.45098 0.270588 1",roiId:60,position:"right",isBrain:!0},{name:"supramarginal gyrus",roiColor:"0.623529 0.0235294 0.654902 1",roiId:41,position:"left",isBrain:!0},{name:"temporal lobe WM",roiColor:"0.498039 0.603922 0.768627 1",roiId:59,position:"right",isBrain:!0},{name:"temporal lobe WM",roiColor:"0.87451 0.411765 0.368627 1",roiId:83,position:"left",isBrain:!0},{name:"thalamus",roiColor:"0.0588235 0.796078 0.866667 1",roiId:203,position:"right",isBrain:!0},{name:"thalamus",roiColor:"0.74902 0.984314 0.341176 1",roiId:102,position:"left",isBrain:!0},{roiColor:"0.811765 0.258824 0.823529 1",roiId:232,name:"third ventricle",isBrain:!0},{name:"uncus",roiColor:"0.121569 0.352941 0.196078 1",roiId:26,position:"right",isBrain:!0},{name:"uncus",roiColor:"0.623529 0.117647 0.14902 1",roiId:62,position:"left",isBrain:!0},{name:"xxx_brain_internal",roiColor:"0.8 0.8 0.1 1",roiId:150,position:"left",isBrain:!0},{name:"xxx_brain_core",roiColor:"0.2 0.8 0.2 1",roiId:250,position:"left",isBrain:!0}],this.createBytePalette256()}return Object(p.a)(e,[{key:"createBytePalette256",value:function(){var e;for(this.m_palette256=new Uint8Array(1024),e=0;e<1024;e++)this.m_palette256[e]=0;var t=this.m_palette.length;for(e=0;e<t;e++){var i=this.m_palette[e].roiId,a=this.m_palette[e].roiColor.split(" "),o=Math.floor(255*parseFloat(a[0])),r=Math.floor(255*parseFloat(a[1])),n=Math.floor(255*parseFloat(a[2])),s=4*parseInt(i,10);this.m_palette256[s+0]=o,this.m_palette256[s+1]=r,this.m_palette256[s+2]=n,this.m_palette256[s+3]=255}}},{key:"getPalette",value:function(){return this.m_palette}},{key:"getPalette256",value:function(){return this.m_palette256}}]),e}(),ae=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onMouseDown=a.onMouseDown.bind(Object(y.a)(a)),a.onMouseUp=a.onMouseUp.bind(Object(y.a)(a)),a.onMouseMove=a.onMouseMove.bind(Object(y.a)(a)),a.onMouseWheel=a.onMouseWheel.bind(Object(y.a)(a)),a.m_sliceRatio=.5,a.m_mode2d=u.TRANSVERSE,a.m_zoom=1,a.m_xPos=0,a.m_yPos=0,a.m_isMounted=!1,a.state={wRender:0,hRender:0,stateMouseDown:!1,xMouse:-1,yMouse:-1},a.segm2d=new te(Object(y.a)(a)),a.m_isSegmented=!1,a.m_toolPick=new z(Object(y.a)(a)),a.m_toolDistance=new N(Object(y.a)(a)),a.m_toolZoom=new L(Object(y.a)(a)),a.m_toolClear=new V(Object(y.a)(a)),a.m_toolAngle=new B(Object(y.a)(a)),a.m_toolArea=new j(Object(y.a)(a)),a.m_toolRect=new G(Object(y.a)(a)),a.m_toolText=new W(Object(y.a)(a)),a.m_toolEdit=new H(Object(y.a)(a)),a.m_toolDelete=new q(Object(y.a)(a)),a.m_roiPalette=new ie,e.dispatch({type:m.SET_GRAPHICS_2D,graphics2d:Object(y.a)(a)}),a}return Object(p.a)(i,[{key:"componentDidMount",value:function(){this.m_isMounted=!0,this.prepareImageForRender(),this.renderReadyImage();var e=this.m_mount.clientWidth,t=this.m_mount.clientHeight;0===this.state.wRender&&(this.setState({wRender:e}),this.setState({hRender:t}))}},{key:"componentWillUnmount",value:function(){this.m_isMounted=!1}},{key:"componentDidUpdate",value:function(){this.m_isMounted&&this.renderReadyImage()}},{key:"screenshot",value:function(e,t){return console.log("get screenshot from 2d canvas: ".concat(e,"*").concat(t)),this.m_mount.toDataURL()}},{key:"renderTextInfo",value:function(e,t,i){var a,o=4,r=16;e.font=r.toString()+"px Arial",e.textAlign="left",e.textBaseline="top",e.fillStyle="grey",a="volume dim = "+i.m_xDim.toString()+" * "+i.m_yDim.toString()+" * "+i.m_zDim.toString(),e.fillText(a,4,o),o+=r;var n=Math.floor(i.m_boxSize.x),s=Math.floor(i.m_boxSize.y),l=Math.floor(i.m_boxSize.z);a="vol phys size = "+n.toString()+" * "+s.toString()+" * "+l.toString(),e.fillText(a,4,o),o+=r;var m=t.m_patientName;m.length>1&&(a="patient name = "+m,e.fillText(a,4,o),o+=r);var h=t.m_patientBirth;h.length>1&&(a="patient birth = "+h,e.fillText(a,4,o),o+=r);var u=t.m_seriesDescr;u.length>1&&(a="series descr = "+u,e.fillText(a,4,o),o+=r);var c=t.m_institutionName;c.length>1&&(a="institution name = "+c,e.fillText(a,4,o),o+=r);var d=t.m_operatorsName;d.length>1&&(a="operators name = "+d,e.fillText(a,4,o),o+=r);var _=t.m_physicansName;_.length>1&&(a="physicans name = "+_,e.fillText(a,4,o),o+=r)}},{key:"prepareImageForRender",value:function(e){var t=this.m_mount;if(null!==t){var i=t.getContext("2d"),a=t.clientWidth,o=t.clientHeight;if(a*o!==0){var r=this.props;i.fillStyle="rgb(64, 64, 64)",i.fillRect(0,0,a,o);var n=r.volumeSet,s=void 0!==e?e:r.volumeIndex,l=n.getVolume(s),m=this.m_mode2d,h=r.slider2d;if(null!==l){if(null===l.m_dataArray)return void console.log("Graphics2d. Volume has no data array");var c=l.m_xDim,d=l.m_yDim,_=l.m_zDim,f=c*d,v=l.m_dataArray;v.length!==c*d*_*l.m_bytesPerVoxel&&console.log("Bad src data len = ".concat(v.length,", but expect ").concat(c,"*").concat(d,"*").concat(_));var p=null,g=null,S=this.m_roiPalette.getPalette256(),y=l.m_boxSize;y.x*y.y*y.z<1e-5&&console.log("Bad physical dimensions for rendered volume = ".concat(y.x,"*").concat(y.y,"*").concat(y.z," "));var x=0,b=0,D=r.render2dxPos,T=r.render2dyPos,E=r.render2dZoom;if(m===u.TRANSVERSE){var M=y.x/y.y;x=a,(b=Math.floor(a/M))>o&&(b=o,(x=Math.floor(o*M))>a&&console.log("logic error! wScreen * hScreen = ".concat(x," * ").concat(b))),b=b>0?b:1,this.m_toolPick.setScreenDim(x,b),this.m_toolZoom.setScreenDim(x,b),this.m_toolDistance.setScreenDim(x,b),this.m_toolAngle.setScreenDim(x,b),this.m_toolArea.setScreenDim(x,b),this.m_toolRect.setScreenDim(x,b),this.m_toolText.setScreenDim(x,b),this.m_toolEdit.setScreenDim(x,b),this.m_toolDelete.setScreenDim(x,b);var w=l.m_boxSize.x/c,R=l.m_boxSize.y/d;this.m_toolDistance.setPixelSize(w,R),this.m_toolAngle.setPixelSize(w,R),this.m_toolArea.setPixelSize(w,R),this.m_toolRect.setPixelSize(w,R),this.m_toolText.setPixelSize(w,R),this.m_toolEdit.setPixelSize(w,R),this.m_toolDelete.setPixelSize(w,R),(g=(p=i.createImageData(x,b)).data).length!==x*b*4&&console.log("Bad dst data len = ".concat(g.length,", but expect ").concat(x,"*").concat(b,"*4"));var k=Math.floor(_*h),O=(k=k<_?k:_-1)*f,A=E*c/x,C=E*d/b,I=0,F=T*d;if(1===l.m_bytesPerVoxel)for(var P=0;P<b;P++,F+=C)for(var U=Math.floor(F)*c,X=D*c,z=0;z<x;z++,X+=A){var L=v[O+U+Math.floor(X)];g[I+0]=L,g[I+1]=L,g[I+2]=L,g[I+3]=255,I+=4}else if(4===l.m_bytesPerVoxel)for(var N=0;N<b;N++,F+=C)for(var V=Math.floor(F)*c,B=D*c,j=0;j<x;j++,B+=A){var G=4*v[4*(O+V+Math.floor(B))+3],W=S[G+0],H=S[G+1],q=S[G+2];g[I+0]=q,g[I+1]=H,g[I+2]=W,g[I+3]=255,I+=4}}else if(m===u.SAGGITAL){var Y=y.y/y.z;x=a,(b=Math.floor(a/Y))>o&&(b=o,(x=Math.floor(o*Y))>a&&console.log("logic error! wScreen * hScreen = ".concat(x," * ").concat(b))),b=b>0?b:1,this.m_toolPick.setScreenDim(x,b),this.m_toolZoom.setScreenDim(x,b),this.m_toolDistance.setScreenDim(x,b),this.m_toolAngle.setScreenDim(x,b),this.m_toolArea.setScreenDim(x,b),this.m_toolRect.setScreenDim(x,b),this.m_toolText.setScreenDim(x,b),this.m_toolEdit.setScreenDim(x,b),this.m_toolDelete.setScreenDim(x,b);var Z=l.m_boxSize.y/d,K=l.m_boxSize.z/_;this.m_toolDistance.setPixelSize(Z,K),this.m_toolAngle.setPixelSize(Z,K),this.m_toolArea.setPixelSize(Z,K),this.m_toolRect.setPixelSize(Z,K),this.m_toolText.setPixelSize(Z,K),this.m_toolEdit.setPixelSize(Z,K),this.m_toolDelete.setPixelSize(Z,K),(g=(p=i.createImageData(x,b)).data).length!==x*b*4&&console.log("Bad dst data len = ".concat(g.length,", but expect ").concat(x,"*").concat(b,"*4"));var Q=Math.floor(c*h);Q=Q<c?Q:c-1;var J=E*d/x,$=E*_/b,ee=0,te=T*_;if(1===l.m_bytesPerVoxel)for(var ie=0;ie<b;ie++,te+=$)for(var ae=Math.floor(te)*c*d,oe=D*d,re=0;re<x;re++,oe+=J){var ne=v[ae+Math.floor(oe)*c+Q];g[ee+0]=ne,g[ee+1]=ne,g[ee+2]=ne,g[ee+3]=255,ee+=4}else if(4===l.m_bytesPerVoxel)for(var se=0;se<b;se++,te+=$)for(var le=Math.floor(te)*c*d,me=D*d,he=0;he<x;he++,me+=J){var ue=4*v[4*(le+Math.floor(me)*c+Q)+3],ce=S[ue+0],de=S[ue+1],_e=S[ue+2];g[ee+0]=_e,g[ee+1]=de,g[ee+2]=ce,g[ee+3]=255,ee+=4}}else if(m===u.CORONAL){var fe=y.x/y.z;x=a,(b=Math.floor(a/fe))>o&&(b=o,(x=Math.floor(o*fe))>a&&console.log("logic error! wScreen * hScreen = ".concat(x," * ").concat(b))),b=b>0?b:1,this.m_toolPick.setScreenDim(x,b),this.m_toolZoom.setScreenDim(x,b),this.m_toolDistance.setScreenDim(x,b),this.m_toolAngle.setScreenDim(x,b),this.m_toolArea.setScreenDim(x,b),this.m_toolRect.setScreenDim(x,b),this.m_toolText.setScreenDim(x,b),this.m_toolEdit.setScreenDim(x,b),this.m_toolDelete.setScreenDim(x,b);var ve=l.m_boxSize.x/c,pe=l.m_boxSize.z/_;this.m_toolDistance.setPixelSize(ve,pe),this.m_toolAngle.setPixelSize(ve,pe),this.m_toolArea.setPixelSize(ve,pe),this.m_toolRect.setPixelSize(ve,pe),this.m_toolText.setPixelSize(ve,pe),this.m_toolEdit.setPixelSize(ve,pe),this.m_toolDelete.setPixelSize(ve,pe),(g=(p=i.createImageData(x,b)).data).length!==x*b*4&&console.log("Bad dst data len = ".concat(g.length,", but expect ").concat(x,"*").concat(b,"*4"));var ge=Math.floor(d*h),Se=(ge=ge<d?ge:d-1)*c,ye=E*c/x,xe=E*_/b,be=0,De=T*_;if(1===l.m_bytesPerVoxel)for(var Te=0;Te<b;Te++,De+=xe)for(var Ee=Math.floor(De)*c*d,Me=D*c,we=0;we<x;we++,Me+=ye){var Re=v[Ee+Se+Math.floor(Me)];g[be+0]=Re,g[be+1]=Re,g[be+2]=Re,g[be+3]=255,be+=4}else if(4===l.m_bytesPerVoxel)for(var ke=0;ke<b;ke++,De+=xe)for(var Oe=Math.floor(De)*c*d,Ae=D*c,Ce=0;Ce<x;Ce++,Ae+=ye){var Ie=4*v[4*(Oe+Se+Math.floor(Ae))+3],Fe=S[Ie+0],Pe=S[Ie+1],Ue=S[Ie+2];g[be+0]=Ue,g[be+1]=Pe,g[be+2]=Fe,g[be+3]=255,be+=4}}this.imgData=p,this.segm2d.setImageData(p)}}}}},{key:"renderReadyImage",value:function(){if(this.m_isMounted){var e=this.m_mount;if(null!==e){var t=e.getContext("2d"),i=this.props,a=i.volumeSet;if(0!==a.getNumVolumes()){var o=i.volumeIndex,r=a.getVolume(o);if(null!==r){if(this.m_isSegmented){var n=this.m_toolPick.m_wScreen,s=this.m_toolPick.m_hScreen;this.segm2d.render(t,n,s,this.imgData)}else t.putImageData(this.imgData,0,0);this.renderTextInfo(t,a,r),this.m_toolPick.render(t),this.m_toolDistance.render(t,i),this.m_toolAngle.render(t,i),this.m_toolArea.render(t,i),this.m_toolRect.render(t,i),this.m_toolText.render(t,i),this.m_toolEdit.render(t,i),this.m_toolDelete.render(t,i)}}}}}},{key:"onMouseWheel",value:function(e){var t=this.props;t.indexTools2d===Y.ZOOM&&this.m_toolZoom.onMouseWheel(t,e)}},{key:"onMouseUp",value:function(e){var t=this.props.indexTools2d;if(t===Y.ZOOM&&this.m_toolZoom.onMouseUp(),t===Y.DISTANCE){var i=this.props,a=this.m_mount.getBoundingClientRect(),o=e.clientX-a.left,r=e.clientY-a.top;this.m_toolDistance.onMouseUp(o,r,i)}if(t===Y.ANGLE){var n=this.props,s=this.m_mount.getBoundingClientRect(),l=e.clientX-s.left,m=e.clientY-s.top;this.m_toolAngle.onMouseUp(l,m,n)}if(t===Y.AREA){var h=this.props,u=this.m_mount.getBoundingClientRect(),c=e.clientX-u.left,d=e.clientY-u.top;this.m_toolArea.onMouseUp(c,d,h)}if(t===Y.RECT){var _=this.props,f=this.m_mount.getBoundingClientRect(),v=e.clientX-f.left,p=e.clientY-f.top;this.m_toolRect.onMouseUp(v,p,_)}if(t===Y.EDIT){var g=this.props,S=this.m_mount.getBoundingClientRect(),y=e.clientX-S.left,x=e.clientY-S.top;this.m_toolEdit.onMouseUp(y,x,g)}if(t===Y.DELETE){var b=this.props,D=this.m_mount.getBoundingClientRect(),T=e.clientX-D.left,E=e.clientY-D.top;this.m_toolDelete.onMouseUp(T,E,b)}}},{key:"onMouseMove",value:function(e){var t=this.props,i=t.indexTools2d,a=this.m_mount.getBoundingClientRect(),o=e.clientX-a.left,r=e.clientY-a.top;i===Y.ZOOM&&this.m_toolZoom.onMouseMove(t,o,r),i===Y.DISTANCE&&this.m_toolDistance.onMouseMove(o,r,t),i===Y.ANGLE&&this.m_toolAngle.onMouseMove(o,r,t),i===Y.AREA&&this.m_toolArea.onMouseMove(o,r,t),i===Y.RECT&&this.m_toolRect.onMouseMove(o,r,t),i===Y.EDIT&&this.m_toolEdit.onMouseMove(o,r,t),i===Y.DELETE&&this.m_toolDelete.onMouseMove(o,r,t)}},{key:"onMouseDown",value:function(e){var t=this.m_mount.getBoundingClientRect(),i=e.clientX-t.left,a=e.clientY-t.top,o=this.props;switch(o.indexTools2d){case Y.INTENSITY:this.m_toolPick.onMouseDown(i,a,o);break;case Y.DISTANCE:this.m_toolDistance.onMouseDown(i,a,o);break;case Y.ZOOM:this.m_toolZoom.onMouseDown(i,a);break;case Y.ANGLE:this.m_toolAngle.onMouseDown(i,a,o);break;case Y.AREA:this.m_toolArea.onMouseDown(i,a,o);break;case Y.RECT:this.m_toolRect.onMouseDown(i,a,o);break;case Y.TEXT:this.m_toolText.onMouseDown(i,a,o);break;case Y.EDIT:this.m_toolEdit.onMouseDown(i,a,o);break;case Y.DELETE:this.m_toolDelete.onMouseDown(i,a,o)}this.forceUpdate()}},{key:"clear",value:function(){this.m_toolDistance.clear(),this.m_toolAngle.clear(),this.m_toolArea.clear(),this.m_toolRect.clear(),this.m_toolText.clear(),this.m_toolEdit.clear(),this.m_toolDelete.clear()}},{key:"forceUpdate",value:function(e){this.prepareImageForRender(e),this.m_isSegmented?null!==this.segm2d.model&&this.segm2d.startApplyImage():this.forceRender()}},{key:"forceRender",value:function(){this.m_isMounted&&this.setState({state:this.state})}},{key:"render",value:function(){var e=this;this.m_sliceRatio=this.props.sliderValue,this.m_mode2d=this.props.mode2d;var t=o.a.createElement("canvas",{ref:function(t){e.m_mount=t},style:{width:"100%",height:"100%"}}),i=o.a.createElement("canvas",{ref:function(t){e.m_mount=t},width:this.state.wRender,height:this.state.hRender,onMouseDown:this.onMouseDown,onMouseUp:this.onMouseUp,onMouseMove:this.onMouseMove,onWheel:this.onMouseWheel});return this.state.wRender>0?i:t}}]),i}(o.a.Component),oe=Object(s.b)((function(e){return e}))(ae),re=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onClickButtonTools=a.onClickButtonTools.bind(Object(y.a)(a)),a.state={data:[{img:"images/icon_tools2d_intensity.png",txt:"intensity",ke:Y.INTENSITY,msgTp:"Get voxel intensity"},{img:"images/icon_tools2d_distance.png",txt:"distance",ke:Y.DISTANCE,msgTp:"Measure distance between voxels"},{img:"images/icon_tools2d_angle.png",txt:"angle",ke:Y.ANGLE,msgTp:"Measure angle between lines"},{img:"images/icon_tools2d_area.png",txt:"area",ke:Y.AREA,msgTp:"Calculate arbitrary area"},{img:"images/icon_tools2d_rect.png",txt:"rect",ke:Y.RECT,msgTp:"Calculate rectangular area"},{img:"images/icon_tools2d_text.png",txt:"text",ke:Y.TEXT,msgTp:"Add annotation text"},{img:"images/icon_tools2d_edit.png",txt:"edit",ke:Y.EDIT,msgTp:"Move annotation text"},{img:"images/icon_tools2d_delete.png",txt:"delete",ke:Y.DELETE,msgTp:"Delete annotation object"},{img:"images/icon_tools2d_clear.png",txt:"clear",ke:Y.CLEAR,msgTp:"Clear all objects"},{img:"images/icon_tools2d_zoom.png",txt:"zoom",ke:Y.ZOOM,msgTp:"Zoom in/out"},{img:"images/icon_tools2d_default.png",txt:"default",ke:Y.DEFAULT,msgTp:"Zoom to default"},{img:"images/icon_tools2d_empty.png",txt:"none",ke:Y.NONE,msgTp:"Empty"}]},a}return Object(p.a)(i,[{key:"onClickButtonTools",value:function(e){var t=e.target,i=this.state.data.findIndex((function(e){return e.txt===t.alt}));if(i>=0){var a=this.props;if(a.dispatch({type:m.SET_2D_TOOLS_INDEX,indexTools2d:i}),i===Y.DEFAULT){a.dispatch({type:m.SET_2D_ZOOM,render2dZoom:1}),a.dispatch({type:m.SET_2D_X_POS,render2dxPos:0}),a.dispatch({type:m.SET_2D_Y_POS,render2dyPos:0});var o=a.graphics2d;o.forceUpdate(),o.forceRender()}if(i===Y.CLEAR){var r=a.graphics2d;null!==r&&r.clear()}}}},{key:"render",value:function(){var e=this,t=this.props.indexTools2d;return o.a.createElement("div",{className:"card"},o.a.createElement("div",{className:"card-header"},"Tools"),o.a.createElement("div",{className:"card-body"},o.a.createElement("div",{className:"btn-group row"},this.state.data.map((function(i){var a=t===i.ke?"col-2 btn btn-outline-secondary":"col-2 btn",r=o.a.createElement("button",{type:"button",className:a,key:i.ke,id:i.ke,onClick:e.onClickButtonTools},o.a.createElement("img",{className:"img-thumbnail",src:i.img,alt:i.txt})),n=i.msgTp;return o.a.createElement(C.a,{key:i.txt,placement:"bottom",overlay:o.a.createElement(I.a,null,n)},r)})))))}}]),i}(o.a.Component),ne=Object(s.b)((function(e){return e}))(re),se=i(204),le=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onChangeSegm2d=a.onChangeSegm2d.bind(Object(y.a)(a)),a.state={isSegmented:!1},a}return Object(p.a)(i,[{key:"onChangeSegm2d",value:function(){this.setState({isSegmented:!this.state.isSegmented});var e=this.props.graphics2d;if(null!==e){e.m_isSegmented=!this.state.isSegmented,e.forceUpdate(),e.forceRender();var t=e.segm2d;null===t||this.state.isSegmented||null==t.model&&t.onLoadModel()}}},{key:"render",value:function(){return o.a.createElement(k.a,null,o.a.createElement(k.a.Header,null,"Segmentation 2d (brain only)"),o.a.createElement(k.a.Body,null,o.a.createElement(C.a,{key:"about",placement:"bottom",overlay:o.a.createElement(I.a,null,"You can use automatic 2d image segmentation only for brain-like data")},o.a.createElement(se.a,null,o.a.createElement(se.a.Check,{inline:!0,type:"checkbox",label:"Segmentation 2d",id:"idseg2d",onChange:this.onChangeSegm2d}))),o.a.createElement(k.a.Text,null,"Switch checker above on and see segmentation result on right")))}}]),i}(o.a.Component),me=Object(s.b)((function(e){return e}))(le),he=i(195),ue=i(134),ce=i(2),de=function(){function e(){Object(v.a)(this,e),this.m_texture=-1}return Object(p.a)(e,[{key:"createFromRawVolume",value:function(e){this.m_texture=new ce.k(e.m_dataArray,e.m_xDim,e.m_yDim,e.m_zDim)}}]),e}(),_e=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).m_xDim=0,a.m_yDim=0,a.m_zDim=0,a.m_bytesPerVoxel=0,a.m_dataArray=null,a.m_dataSize=0,a.m_boxSize={x:0,y:0,z:0},a.m_xIcon=0,a.m_yIcon=0,a.m_dataIcon=null,a}return Object(p.a)(i,[{key:"createEmptyBytesVolume",value:function(e,t,i){this.m_xDim=e,this.m_yDim=t,this.m_zDim=i;var a=e*t*i;this.m_bytesPerVoxel=1,this.m_dataArray=new Uint8Array(a),this.m_dataSize=a,this.m_boxSize={x:e,y:t,z:i};for(var o=0;o<a;o++)this.m_dataArray[o]=0}},{key:"createIcon",value:function(){console.assert(this.m_xDim>0),console.assert(this.m_yDim>0),console.assert(this.m_zDim>0),console.assert(null!==this.m_dataArray);var e=this.m_xDim>this.m_yDim?this.m_xDim:this.m_yDim,t=e/64,i=Math.floor(this.m_zDim/2)*this.m_xDim*this.m_yDim;this.m_xIcon=64,this.m_yIcon=this.m_xIcon;var a=this.m_xIcon*this.m_yIcon;this.m_dataIcon=new Uint8Array(a);for(var o=0;o<a;o++)this.m_dataIcon[o]=0;for(var r=Math.floor(64*this.m_xDim/e),n=Math.floor(64*this.m_yDim/e),s=Math.floor(this.m_xIcon/2-r/2),l=Math.floor(this.m_yIcon/2-n/2),m=0;m<n;m++)for(var h=Math.floor(m*t),u=0;u<r;u++){var c=Math.floor(u*t),d=this.m_dataArray[c+h*this.m_xDim+i],_=u+s,f=m+l;this.m_dataIcon[_+f*this.m_xIcon]=d}}},{key:"makeDimensions4x",value:function(){if(!(this.m_zDim<4)){var e=this.m_xDim+3&-4,t=this.m_yDim+3&-4,i=this.m_zDim+3&-4;if(this.m_xDim!==e||this.m_yDim!==t||this.m_zDim!==i){console.log("Volume. makeDimensions4x. Convert into ".concat(e,"*").concat(t,"*").concat(i));var a,o=e*t*i,r=this.m_bytesPerVoxel,n=o*r,s=new Uint8Array(o*r);for(a=0;a<n;a++)s[a]=0;console.log("Volume info: xyzDim = ".concat(this.m_xDim,"*").concat(this.m_yDim,"*").concat(this.m_zDim)),console.log("Volume info: bpp = ".concat(this.m_bytesPerVoxel)),console.log("Volume info: dataSize = ".concat(this.m_dataSize));var l=this.m_xDim*this.m_yDim;if(1===this.m_bytesPerVoxel)for(var m=0;m<this.m_zDim;m++)for(var h=m*l,u=m*e*t,c=0;c<this.m_yDim;c++)for(var d=c*this.m_xDim,_=c*e,f=0;f<this.m_xDim;f++){var v=f+d+h,p=this.m_dataArray[v];s[f+_+u]=p}else if(4===this.m_bytesPerVoxel)for(var g=0;g<this.m_zDim;g++)for(var S=g*l,y=g*e*t,x=0;x<this.m_yDim;x++)for(var b=x*this.m_xDim,D=x*e,T=0;T<this.m_xDim;T++){var E=4*(T+b+S),M=this.m_dataArray[E+0],w=this.m_dataArray[E+1],R=this.m_dataArray[E+2],k=this.m_dataArray[E+3],O=4*(T+D+y);s[O+0]=M,s[O+1]=w,s[O+2]=R,s[O+3]=k}this.m_xDim=e,this.m_yDim=t,this.m_zDim=i,this.m_dataArray=s,this.m_dataSize=o}}}},{key:"render",value:function(){return o.a.createElement("p",null,">")}}]),i}(o.a.Component),fe=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).m_volIndex=-1,a}return Object(p.a)(i,[{key:"componentDidMount",value:function(){var e=this.props.volumeSet.getVolume(this.m_volIndex),t=this.m_mount;if(null!==t){var i=t.getContext("2d"),a=t.clientWidth,o=t.clientHeight;if(a*o!==0){if(i.fillStyle="rgb(64, 64, 64)",i.fillRect(0,0,a,o),e.m_xIcon<=0)return i.beginPath(),i.moveTo(0,0),i.lineTo(a-1,o-1),i.stroke(),i.beginPath(),i.moveTo(a-1,0),i.lineTo(0,o-1),void i.stroke();for(var r=i.createImageData(a,o),n=r.data,s=a*o,l=0,m=0;m<s;m++){var h=e.m_dataIcon[m];n[l+0]=h,n[l+1]=h,n[l+2]=h,n[l+3]=255,l+=4}i.putImageData(r,0,0)}}}},{key:"render",value:function(){var e=this;return this.m_volIndex=this.props.index,o.a.createElement("canvas",{ref:function(t){e.m_mount=t},width:64,height:64})}}]),i}(o.a.Component),ve=Object(s.b)((function(e){return e}))(fe),pe=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onClickRow=a.onClickRow.bind(Object(y.a)(a)),a}return Object(p.a)(i,[{key:"setVolumeIndex",value:function(e){var t=this.props,i=t.volumeSet,a=i.getVolume(e);if(console.assert(null!==a,"setVolumeIndex: vol should be non zero volume"),null!==a.m_dataArray){a.makeDimensions4x(),t.isLoaded&&t.dispatch({type:m.SET_IS_LOADED,isLoaded:!1}),t.dispatch({type:m.SET_VOLUME_SET,volumeSet:i}),t.dispatch({type:m.SET_VOLUME_INDEX,volumeIndex:e});var o=new de;o.createFromRawVolume(a),t.dispatch({type:m.SET_TEXTURE3D,texture3d:o}),t.dispatch({type:m.SET_IS_LOADED,isLoaded:!0});var r=t.graphics2d;r.clear(),r.forceUpdate(e),r.forceRender()}}},{key:"onClickRow",value:function(e){console.assert("number"==typeof e);var t=this.props;e!==t.volumeIndex&&(t.dispatch({type:m.SET_VOLUME_INDEX,volumeIndex:e}),this.setVolumeIndex(e))}},{key:"render",value:function(){var e=this,t=this.props,i=t.volumeSet.m_volumes,a=t.volumeIndex,r=t.dicomInfo.m_patientName,n=t.dicomInfo.m_studyDescr,s="Volume select. [".concat(r,"]: ").concat(n);return o.a.createElement(k.a,null,o.a.createElement(k.a.Header,null,s),o.a.createElement(k.a.Body,null,o.a.createElement(he.a,null,i.map((function(t,i){var r=t.m_zDim,n=t.m_seriesDescr,s="vol ".concat(n," [").concat(r,"] slices");return i===a?o.a.createElement(ue.a,{key:i,onClick:function(){e.onClickRow(i)},active:!0},s," ",o.a.createElement(ve,{index:i})," "):o.a.createElement(ue.a,{key:i,onClick:function(){e.onClickRow(i)}},s," ",o.a.createElement(ve,{index:i})," ")})))))}}]),i}(o.a.Component),ge=Object(s.b)((function(e){return e}))(pe),Se=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(){return Object(v.a)(this,i),t.apply(this,arguments)}return Object(p.a)(i,[{key:"transferFuncCallback",value:function(e){var t=e.m_indexMoved,i=e.m_handleX[t],a=e.m_handleY[t];console.log("moved point[".concat(t,"] = ").concat(i,", ").concat(a,"  "))}},{key:"render",value:function(){var e={minHeight:800..toString()+"px"},t=this.props.volumeSet.m_volumes.length>1?o.a.createElement(ge,null):o.a.createElement("br",null);return o.a.createElement(T.a,{fluid:"true",style:{height:"100%",minHeight:"100%"}},o.a.createElement(x.a,null,o.a.createElement(b.a,{xs:!0,md:!0,lg:"4",style:{height:"100%",position:"relative"}},o.a.createElement(X,null),o.a.createElement(ne,null),o.a.createElement(me,null),t),o.a.createElement(b.a,{xs:!0,md:!0,lg:"8",style:e},o.a.createElement(oe,null))))}}]),i}(o.a.Component),ye=Object(s.b)((function(e){return e}))(Se),xe=function(){function e(){Object(v.a)(this,e),this.m_mouseDown=!1,this.m_indexMoved=-1,this.m_numHandles=10,this.m_handleColors=[{r:0,g:0,b:0},{r:255,g:128,b:64},{r:255,g:0,b:0},{r:128,g:64,b:64},{r:128,g:0,b:0},{r:64,g:64,b:64},{r:128,g:128,b:128},{r:192,g:192,b:192},{r:255,g:255,b:255},{r:255,g:255,b:255}],this.m_handleX=[0,22,40,55,61,115,118,125,160,255],this.m_handleY=[0,0,.3,.12,0,0,.4,.8,.95,1],this.m_proj=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],this.m_handleColors.length!==this.m_numHandles&&console.log("Wrong array this.m_handleColors: ".concat(this.m_handleColors.length," !== ").concat(this.m_numHandles))}return Object(p.a)(e,[{key:"render",value:function(e,t,i,a,o){this.m_xMin=t,this.m_yMin=i,this.m_wScreen=a,this.m_hScreen=o;var r,n,s=Math.floor(a/50);this.m_radCircle=s,e.lineWidth=1,e.strokeStyle="#000000",r=-1,n=-1;for(var l=0;l<this.m_numHandles;l++){var m=this.m_handleX[l],h=this.m_handleY[l],u=t+Math.floor(a*m/255),c=i+Math.floor(o-1-o*h/1);this.m_proj[l].x=u,this.m_proj[l].y=c,l>0&&(e.beginPath(),e.moveTo(r,n),e.lineTo(u,c),e.stroke()),r=u,n=c}for(var d=0;d<this.m_numHandles;d++){var _=this.m_handleX[d],f=this.m_handleY[d],v=t+Math.floor(a*_/255),p=i+Math.floor(o-1-o*f/1),g=this.m_handleColors[d].r.toString(16),S=this.m_handleColors[d].g.toString(16),y=this.m_handleColors[d].b.toString(16);g=1===g.length?"0"+g:g,S=1===S.length?"0"+S:S,y=1===y.length?"0"+y:y;var x="#".concat(g).concat(S).concat(y);e.fillStyle=x,e.beginPath(),e.ellipse(v,p,s,s,0,0,2*Math.PI),e.fill(),e.stroke()}}},{key:"onMouseDown",value:function(e,t){for(var i=0;i<this.m_numHandles;i++){var a=e-this.m_proj[i].x,o=t-this.m_proj[i].y;a*a+o*o<=this.m_radCircle*this.m_radCircle&&(console.log("Picked point ".concat(i)),this.m_mouseDown=!0,this.m_indexMoved=i)}return!1}},{key:"onMouseUp",value:function(){return this.m_mouseDown=!1,!1}},{key:"onMouseMove",value:function(e,t){if(this.m_mouseDown){var i,a;i=0===this.m_indexMoved||this.m_indexMoved===this.m_numHandles-1?this.m_proj[this.m_indexMoved].x:(i=(i=e)<this.m_proj[this.m_indexMoved-1].x?this.m_proj[this.m_indexMoved-1].x:i)>this.m_proj[this.m_indexMoved+1].x?this.m_proj[this.m_indexMoved+1].x:i,(a=t)<this.m_yMin&&(a=this.m_yMin),a>this.m_yMin+this.m_hScreen&&(a=this.m_yMin+this.m_hScreen),this.m_proj[this.m_indexMoved].x=i,this.m_proj[this.m_indexMoved].y=a;var o=255*(i-this.m_xMin)/this.m_wScreen,r=1*(this.m_yMin+this.m_hScreen-1-a)/this.m_hScreen;return this.m_handleX[this.m_indexMoved]=o,this.m_handleY[this.m_indexMoved]=r,!0}return!1}}]),e}(),be=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).m_histogram=[],a.m_numColors=0,a.m_transfFunc=new xe,a.m_transfFuncCallback=void 0,a.m_transfFuncUpdateCallback=void 0,a.setSize=a.setSize.bind(Object(y.a)(a)),a.onMouseDown=a.onMouseDown.bind(Object(y.a)(a)),a.onMouseUp=a.onMouseUp.bind(Object(y.a)(a)),a.onMouseMove=a.onMouseMove.bind(Object(y.a)(a)),a.state={width:0,height:220},a}return Object(p.a)(i,[{key:"componentDidMount",value:function(){this.updateCanvas(),window.addEventListener("resize",this.handleResize,!1),this.setSize()}},{key:"componentDidUpdate",value:function(){this.updateCanvas(),window.removeEventListener("resize",this.handleResize,!1)}},{key:"handleResize",value:function(){this.setSize()}},{key:"setSize",value:function(){var e=this.m_canvasOwner;if(null!==e){var t=e.clientWidth-2,i=e.clientHeight-2;this.setState({width:t}),this.setState({height:i})}}},{key:"getVolumeHistogram",value:function(e){var t,i=e.m_xDim,a=e.m_yDim,o=e.m_zDim,r=e.m_dataArray,n=i*a*o;for(this.m_numColors=256,this.m_histogram=new Array(this.m_numColors),t=0;t<this.m_numColors;t++)this.m_histogram[t]=0;for(t=0;t<n;t++){var s=r[t];this.m_histogram[s]++}var l=0;for(t=0;t<this.m_numColors;t++)l=this.m_histogram[t]>l?this.m_histogram[t]:l;var m=1/(l+=.001);for(t=0;t<this.m_numColors;t++)this.m_histogram[t]*=m;this.smoothHistogram(),this.getMaxPeak()}},{key:"assignArray",value:function(e,t){this.m_numColors=e,this.m_histogram=t}},{key:"getLastMaxIndex",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=4,a=!1;for(e=this.m_numColors-i;e>i;e--)if(this.m_histogram[e]>t&&this.m_histogram[e]>this.m_histogram[e-2]&&this.m_histogram[e]>this.m_histogram[e+2]){a=!0;break}return a?e:(console.log("getLastMaxIndex. Not found!"),-1)}},{key:"getMaxPeak",value:function(){var e;this.m_peakIndex=-1;var t=this.m_histogram,i=0;for(e=this.m_numColors-4;e>12;e--)if(t[e]>t[e-1]&&t[e]>t[e+1]&&t[e]>t[e-2]&&t[e]>t[e+2]){var a=t[e];a>i&&(i=a,this.m_peakIndex=e)}}},{key:"smoothHistogram",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1.2,t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=60,a=Math.floor(this.m_numColors/i),o=32;a>o&&(a=o);var r,n=1/(2*e*e),s=new Array(this.m_numColors),l=0;for(r=0;r<this.m_numColors;r++){for(var m=0,h=0,u=-a;u<=a;u++){var c=r+u,d=u/a,_=Math.exp(-d*d*n);c>=0&&c<this.m_numColors&&(m+=this.m_histogram[c]*_,h+=_)}l=(m/=h)>l?m:l,s[r]=m}if(t)for(r=0;r<this.m_numColors;r++)this.m_histogram[r]=s[r]/l;else for(r=0;r<this.m_numColors;r++)this.m_histogram[r]=s[r]}},{key:"onMouseDown",value:function(e){if(void 0!==this.m_transfFuncCallback&&void 0!==this.m_transfFuncUpdateCallback){var t=this.refs.canvasHistogram.getBoundingClientRect(),i=e.clientX-t.left,a=e.clientY-t.top;this.m_transfFunc.onMouseDown(i,a)&&this.forceRender()}}},{key:"onMouseUp",value:function(e){if(void 0!==this.m_transfFuncCallback&&void 0!==this.m_transfFuncUpdateCallback){var t=this.refs.canvasHistogram.getBoundingClientRect(),i=e.clientX-t.left,a=e.clientY-t.top;this.m_transfFunc.onMouseUp(i,a)&&this.forceRender()}}},{key:"onMouseMove",value:function(e){if(void 0!==this.m_transfFuncCallback&&void 0!==this.m_transfFuncUpdateCallback){var t=this.refs.canvasHistogram.getBoundingClientRect(),i=e.clientX-t.left,a=e.clientY-t.top;this.m_transfFunc.onMouseMove(i,a)&&this.forceRender()}}},{key:"updateCanvas",value:function(){if(void 0!==this.refs.canvasHistogram){var e=this.refs.canvasHistogram.getContext("2d"),t=this.refs.canvasHistogram.clientWidth,i=this.refs.canvasHistogram.clientHeight;e.fillStyle="rgb(220, 220, 220)",e.fillRect(0,0,t,i);var a=this.props.volume;null!==a&&this.getVolumeHistogram(a);var o=Math.floor(.01*t),r=Math.floor(.99*t),n=Math.floor(.05*i),s=Math.floor(.95*i),l=r-o,m=s-n;e.lineWidth=1,e.strokeStyle="#0a0a0a",e.moveTo(o,s),e.lineTo(o,n),e.stroke(),e.moveTo(o,s),e.lineTo(r,s),e.stroke(),e.font="10px Arial",e.fillStyle="rgb(120, 20, 20)",e.textBaseline="top",e.textAlign="center";var h,u=1;this.m_peakIndex>0&&(u=(u=2*this.m_histogram[this.m_peakIndex])>1?1:u);var c,d,_;for(h=0;h<=4;h++){var f=o+Math.floor(l*h/4);e.moveTo(f,s),e.lineTo(f,s+6),e.stroke();var v=Math.floor(0+this.m_numColors*h/4);e.textAlign=0===h?"left":4===h?"right":"center",e.fillText(v.toString(),f,s+4)}for(e.lineWidth=2,e.strokeStyle="#080808",e.fillStyle="#707070",e.beginPath(),e.moveTo(o,s),c=0;c<this.m_numColors;c++){d=o+Math.floor(l*c/this.m_numColors);var p=this.m_histogram[c]/u;p=p>=1?1:p,_=s-Math.floor(m*p),e.lineTo(d,_)}if(_=s,e.lineTo(d,_),e.closePath(),e.fill(),this.m_peakIndex>0){e.lineWidth=1,e.strokeStyle="#eeeeee";var g=o+Math.floor(l*this.m_peakIndex/this.m_numColors),S=this.m_histogram[this.m_peakIndex]/u;S=S>=1?1:S;var y=s-Math.floor(m*S);e.beginPath(),e.setLineDash([5,15]),e.moveTo(g,y),y=s,e.lineTo(g,y),e.stroke(),e.setLineDash([])}void 0!==this.m_transfFuncCallback&&void 0!==this.m_transfFuncUpdateCallback&&this.m_transfFunc.render(e,o,n,l,m)}}},{key:"forceRender",value:function(){this.setState({state:this.state}),void 0!==this.m_transfFuncCallback&&this.m_transfFuncCallback(this.m_transfFunc)}},{key:"render",value:function(){var e=this,t=this.props.volume;if(void 0===t)return o.a.createElement("p",null,"UiHistogram.props volume is not defined !!!");if(null===t)return o.a.createElement("p",null);this.m_transfFuncCallback=this.props.transfFunc,this.m_transfFuncUpdateCallback=this.props.transfFuncUpdate;var i=this.state.width,a=this.state.height;return o.a.createElement("div",{ref:function(t){e.m_canvasOwner=t}},o.a.createElement("canvas",{ref:"canvasHistogram",width:i,height:a,onMouseDown:this.onMouseDown,onMouseUp:this.onMouseUp,onMouseMove:this.onMouseMove}))}}]),i}(o.a.Component),De=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).m_updateEnable=!0,a.onAO=a.onAO.bind(Object(y.a)(a)),a.offAO=a.offAO.bind(Object(y.a)(a)),a.onStartEr=a.onStartEr.bind(Object(y.a)(a)),a.onStopEr=a.onStopEr.bind(Object(y.a)(a)),a.onUndo=a.onUndo.bind(Object(y.a)(a)),a.onSave=a.onSave.bind(Object(y.a)(a)),a}return Object(p.a)(i,[{key:"onAO",value:function(){var e=this.props,t=e.sliderIsosurface;e.volumeRenderer.setAmbientTextureMode(t)}},{key:"offAO",value:function(){this.props.volumeRenderer.offAmbientTextureMode()}},{key:"onStartEr",value:function(){this.props.volumeRenderer.setEraserStart(!0)}},{key:"onStopEr",value:function(){this.props.volumeRenderer.setEraserStart(!1)}},{key:"onUndo",value:function(){this.props.volumeRenderer.undoEraser()}},{key:"onSave",value:function(){this.props.volumeRenderer.volumeUpdater.updateVolumeTextureWithMask(),console.log("onSave")}},{key:"onChangeSliderTF",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderTF.slider.get(),t=this.props;t.dispatch({type:m.SET_SLIDER_3DR,slider3d_r:Number.parseFloat(e[0])}),t.dispatch({type:m.SET_SLIDER_3DG,slider3d_g:Number.parseFloat(e[1])}),t.dispatch({type:m.SET_SLIDER_3DB,slider3d_b:Number.parseFloat(e[2])})}},{key:"shouldComponentUpdate",value:function(e){var t=this.m_updateEnable;return this.props.mode3d!==e.mode3d&&(t=!0),t}},{key:"onChangeSliderOpacity",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderOpacity.slider.get();this.props.dispatch({type:m.SET_SLIDER_Opacity,sliderOpacity:Number.parseFloat(e)})}},{key:"onChangeSliderIsosurface",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderIsosurface.slider.get();this.props.dispatch({type:m.SET_SLIDER_Isosurface,sliderIsosurface:Number.parseFloat(e)})}},{key:"onChangeSliderErRadius",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderErRadius.slider.get();this.props.dispatch({type:m.SET_SLIDER_ErRadius,sliderErRadius:Number.parseFloat(e)})}},{key:"onChangeSliderErDepth",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderErDepth.slider.get();this.props.dispatch({type:m.SET_SLIDER_ErDepth,sliderErDepth:Number.parseFloat(e)})}},{key:"transferFuncCallback",value:function(e){var t=e.m_indexMoved,i=e.m_handleX[t],a=e.m_handleY[t];console.log("moved point[".concat(t,"] = ").concat(i,", ").concat(a,"  "))}},{key:"render",value:function(){var e=this.props,t=e.mode3d,i=[e.slider3d_r,e.slider3d_g,e.slider3d_b],a=[e.sliderOpacity],r=[e.sliderIsosurface],n=[e.sliderErRadius],s=[e.sliderErDepth],l=null,m=e.volumeSet;if(m.getNumVolumes()>0){var h=e.volumeIndex;l=m.getVolume(h)}var u=this.transferFuncCallback,c=o.a.createElement(he.a,null,o.a.createElement(he.a.Item,null,o.a.createElement(be,{volume:l,transfFunc:u})),o.a.createElement(he.a.Item,null,o.a.createElement("p",null," Set "),o.a.createElement(P.a,{onSlide:this.onChangeSliderTF.bind(this),ref:"sliderTF",range:{min:0,max:1},start:i,connect:[!1,!0,!1,!0],step:.02,tooltips:!0})),o.a.createElement(he.a.Item,null,o.a.createElement("p",null," Opacity "),o.a.createElement(P.a,{onSlide:this.onChangeSliderOpacity.bind(this),ref:"sliderOpacity",range:{min:0,max:1},start:a,connect:[!0,!1],step:.02,tooltips:!0}))),d=o.a.createElement("ul",{className:"list-group"},o.a.createElement("li",{className:"list-group-item"},o.a.createElement(be,{volume:l,transfFunc:u})),o.a.createElement("li",{className:"list-group-item"},o.a.createElement("p",null," Isosurface "),o.a.createElement(P.a,{onSlide:this.onChangeSliderIsosurface.bind(this),ref:"sliderIsosurface",range:{min:0,max:1},start:r,connect:[!0,!1],step:.02,tooltips:!0})),o.a.createElement("li",{className:"list-group-item"},"Ambient Oclusion ->",o.a.createElement("button",{type:"button",className:"btn btn-outline-dark",onClick:this.onAO},"On"),o.a.createElement("button",{type:"button",className:"btn btn-outline-dark",onClick:this.offAO},"Off"),o.a.createElement("button",{type:"button",className:"btn btn-outline-dark",onClick:this.onAO},"Reset"))),_=o.a.createElement("div",{className:"card"},o.a.createElement("div",{className:"card-header"},"Press Control + Mouse Down [+ Mouse Move] for erease"),o.a.createElement("ul",{className:"list-group list-group-flush"},o.a.createElement("li",{className:"list-group-item"},o.a.createElement("p",null," Radius "),o.a.createElement(P.a,{onSlide:this.onChangeSliderErRadius.bind(this),ref:"sliderErRadius",range:{min:1,max:100},start:n,connect:[!0,!1],step:.02,tooltips:!0})),o.a.createElement("li",{className:"list-group-item"},o.a.createElement("p",null," Depth "),o.a.createElement(P.a,{onSlide:this.onChangeSliderErDepth.bind(this),ref:"sliderErDepth",range:{min:1,max:100},start:s,connect:[!0,!1],step:.02,tooltips:!0})),o.a.createElement("li",{className:"list-group-item"},o.a.createElement("p",null," Isosurface "),o.a.createElement(P.a,{onSlide:this.onChangeSliderIsosurface.bind(this),ref:"sliderIsosurface",range:{min:0,max:1},start:r,connect:[!0,!1],step:.02,tooltips:!0})),o.a.createElement("li",{className:"list-group-item"},o.a.createElement("button",{type:"button",className:"btn btn-outline-dark",onClick:this.onUndo},"Undo"),o.a.createElement("button",{type:"button",className:"btn btn-outline-dark",onClick:this.onSave},"Save"))));return console.log("UiTF . mode = ".concat(t)),[d,c,null,_][t]}}]),i}(o.a.Component),Te=Object(s.b)((function(e){return e}))(De),Ee=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).m_updateEnable=!0,a}return Object(p.a)(i,[{key:"shouldComponentUpdate",value:function(e){var t=this.m_updateEnable;return this.props.mode3d!==e.mode3d&&(t=!0),t}},{key:"onChangeSliderTF",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderTF.slider.get(),t=this.props;t.dispatch({type:m.SET_SLIDER_3DR,slider3d_r:Number.parseFloat(e[0])}),t.dispatch({type:m.SET_SLIDER_3DG,slider3d_g:Number.parseFloat(e[1])})}},{key:"onChangeSliderOpacity",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderOpacity.slider.get();this.props.dispatch({type:m.SET_SLIDER_Opacity,sliderOpacity:Number.parseFloat(e)})}},{key:"onChangeSliderIsosurface",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderIsosurface.slider.get();this.props.dispatch({type:m.SET_SLIDER_Isosurface,sliderIsosurface:Number.parseFloat(e)})}},{key:"render",value:function(){var e=this.props,t=e.mode3d;t>1&&(t=1);var i=[e.slider3d_r,e.slider3d_g],a=[e.sliderOpacity],r=[e.sliderIsosurface],n=o.a.createElement("ul",{className:"list-group"},o.a.createElement("li",{className:"list-group-item"},o.a.createElement(P.a,{onSlide:this.onChangeSliderTF.bind(this),ref:"sliderTF",range:{min:0,max:1},start:i,connect:[!1,!0,!1],step:.02,tooltips:!0})),o.a.createElement("li",{className:"list-group-item"},o.a.createElement("p",null," Opacity "),o.a.createElement(P.a,{onSlide:this.onChangeSliderOpacity.bind(this),ref:"sliderOpacity",range:{min:0,max:1},start:a,connect:[!1,!0],step:.02,tooltips:!0})));return[o.a.createElement("ul",{className:"list-group"},o.a.createElement("li",{className:"list-group-item"},o.a.createElement("p",null," Isosurface "),o.a.createElement(P.a,{onSlide:this.onChangeSliderIsosurface.bind(this),ref:"sliderIsosurface",range:{min:0,max:1},start:r,connect:[!1,!0],step:.02,tooltips:!0}))),n][1]}}]),i}(o.a.Component),Me=Object(s.b)((function(e){return e}))(Ee),we=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;Object(v.a)(this,i),(a=t.call(this,e)).m_setRoiFunc=void 0,a.onChangeSelectAll=a.onChangeSelectAll.bind(Object(y.a)(a)),a.onChangeRoiIndi=a.onChangeRoiIndi.bind(Object(y.a)(a)),a.m_roiPalette=new ie;var o=a.m_roiPalette.getPalette(),r=o.length;94!==r&&console.log("numPalElems = ".concat(r,", but expected = ").concat(94," "));var n=o.map((function(e){var t=e.name,i=e.roiColor,a=e.roiId,o=e.position,r=i.split(" "),n=Math.floor(255*r[0]),s=Math.floor(255*r[1]),l=Math.floor(255*r[2]);return{name:t,color:i,strColor:"#"+n.toString(16)+s.toString(16)+l.toString(16),id:a,position:o,selected:!1}}));return a.state={allSelected:!1,checkboxes:n},a}return Object(p.a)(i,[{key:"onChangeRoiIndi",value:function(e){var t=e.target,i=t.checked,a=Number.parseInt(t.id),o=this.state.checkboxes.findIndex((function(e){return e.id===a})),r=this.state.checkboxes;o>=0&&(r[o].selected=i,this.setState({checkboxes:r}),void 0!==this.m_setRoiFunc&&this.m_setRoiFunc(r))}},{key:"onChangeSelectAll",value:function(e){for(var t=e.target.checked,i=this.state.checkboxes,a=i.length,o=0;o<a;o++)i[o].selected=t;this.setState({checkboxes:i}),this.setState({allSelected:t}),void 0!==this.m_setRoiFunc&&this.m_setRoiFunc(i)}},{key:"render",value:function(){var e=this;this.m_setRoiFunc=this.props.setRoiFunc;var t=this.state.allSelected?"Select none":"Select all";return o.a.createElement(k.a,{style:{height:"350px",overflowY:"auto"}},o.a.createElement(k.a.Body,null,o.a.createElement(k.a.Title,null,"ROI Selector"),o.a.createElement(se.a.Group,{controlId:"ROI selector"},o.a.createElement(se.a.Check,{type:"checkbox",key:"selall",label:t,onChange:this.onChangeSelectAll}),this.state.checkboxes.map((function(t){var i=t.strColor;return o.a.createElement(x.a,{key:t.id,id:t.id},o.a.createElement(b.a,{xs:!0,lg:"11"},o.a.createElement(se.a.Check,{type:"checkbox",label:t.name,key:t.id,id:t.id,checked:t.selected,onChange:e.onChangeRoiIndi})),o.a.createElement(b.a,{xs:!0,lg:"1"},o.a.createElement("i",{className:"fa fa-square",style:{color:i}},"  ")))})))))}}]),i}(o.a.Component),Re=Object(s.b)((function(e){return e}))(we),ke=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onModeA=a.onModeA.bind(Object(y.a)(a)),a.onModeB=a.onModeB.bind(Object(y.a)(a)),a.onModeC=a.onModeC.bind(Object(y.a)(a)),a.onModeD=a.onModeD.bind(Object(y.a)(a)),a.onMode=a.onMode.bind(Object(y.a)(a)),a.onModeroi=a.onModeroi.bind(Object(y.a)(a)),a.m_updateEnable=!0,a}return Object(p.a)(i,[{key:"onMode",value:function(e){this.m_updateEnable=!0,this.props.dispatch({type:m.SET_MODE_3D,mode3d:e}),this.props.volumeRenderer.offAmbientTextureMode()}},{key:"onModeA",value:function(){this.onMode(c.ISO),this.props.volumeRenderer.setEraserMode(!1)}},{key:"onModeB",value:function(){this.onMode(c.RAYCAST),this.props.volumeRenderer.setEraserMode(!1)}},{key:"onModeC",value:function(){this.onMode(c.RAYFAST),this.props.volumeRenderer.setEraserMode(!1)}},{key:"onModeD",value:function(){this.onMode(c.EREASER),this.props.volumeRenderer.setEraserMode(!0)}},{key:"onModeroi",value:function(e){this.m_updateEnable=!0,this.props.dispatch({type:m.SET_MODE_3Droi,mode3droi:e})}},{key:"onModeAroi",value:function(){this.onModeroi(d.ISO)}},{key:"onModeBroi",value:function(){this.onModeroi(d.RAYCAST)}},{key:"shouldComponentUpdate",value:function(){return this.m_updateEnable}},{key:"setRoi",value:function(e){for(var t=e.length,i=this.props,a=new Uint8Array(256),o=0;o<256;o++)a[o]=!1;for(var r=0;r<t;r++){var n=e[r].id,s=e[r].name,l=e[r].selected;a[n]=l,console.log("setRoi: [".concat(r,"]: name=").concat(s," id= ").concat(n," isSel=").concat(l," "))}i.volumeRenderer.updateSelectedRoiMap(a)}},{key:"render",value:function(){var e=this.props,t=e.mode3d,i=t===c.ISO?"primary":"secondary",a=t===c.RAYCAST?"primary":"secondary",r=t===c.RAYFAST?"primary":"secondary",n=t===c.ERASER?"primary":"secondary",s=o.a.createElement("div",null,o.a.createElement(k.a,null,o.a.createElement(k.a.Title,null,"3d mode selection"),o.a.createElement(k.a.Body,null,o.a.createElement(O.a,null,o.a.createElement(C.a,{key:"iso",placement:"bottom",overlay:o.a.createElement(I.a,null,"Show just barrier value surface, 1st ray intersection")},o.a.createElement(A.a,{variant:i,onClick:this.onModeA},"Iso")),o.a.createElement(C.a,{key:"vre",placement:"bottom",overlay:o.a.createElement(I.a,null,"Show complete 3d volumetric rendering")},o.a.createElement(A.a,{variant:a,onClick:this.onModeB},"Vol")),o.a.createElement(C.a,{key:"maxproj",placement:"bottom",overlay:o.a.createElement(I.a,null,"Show maximum projection rendering")},o.a.createElement(A.a,{variant:r,onClick:this.onModeC},"MaxPrj")),o.a.createElement(C.a,{key:"volera",placement:"bottom",overlay:o.a.createElement(I.a,null,"Special volume eraser tool")},o.a.createElement(A.a,{variant:n,onClick:this.onModeD},"Eraser"))))),o.a.createElement(Te,null)),l=o.a.createElement(he.a,{as:"ul",variant:"flush"},o.a.createElement(he.a.Item,{as:"li"},o.a.createElement(Re,{setRoiFunc:this.setRoi})),o.a.createElement(Me,null)),m=0,h=e.volumeSet;if(h.getNumVolumes()>0){var u=e.volumeIndex;4===h.getVolume(u).m_bytesPerVoxel&&(m=1)}return[s,l][m]}}]),i}(o.a.Component),Oe=Object(s.b)((function(e){return e}))(ke),Ae=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).transferFuncCallback=a.transferFuncCallback.bind(Object(y.a)(a)),a.m_updateEnable=!0,a}return Object(p.a)(i,[{key:"onChangeSliderOpacity",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderOpacity.slider.get();this.props.dispatch({type:m.SET_SLIDER_Opacity,sliderOpacity:Number.parseFloat(e)})}},{key:"shouldComponentUpdate",value:function(){return this.m_updateEnable}},{key:"transferFuncCallback",value:function(e){var t=e.m_indexMoved,i=e.m_handleX[t],a=e.m_handleY[t];console.log("moved point[".concat(t,"] = ").concat(i,", ").concat(a,"  ")),this.props.volumeRenderer.updateTransferFuncTexture(e.m_handleX,e.m_handleY)}},{key:"render",value:function(){var e=this.props,t=[e.sliderOpacity],i=e.volumeSet,a=e.volumeIndex,r=i.getVolume(a),n=this.transferFuncCallback,s=null===e.volumeRenderer?null:e.volumeRenderer;return o.a.createElement("ul",{className:"list-group"},o.a.createElement("li",{className:"list-group-item"},o.a.createElement(be,{volume:r,transfFunc:n,transfFuncUpdate:s})),o.a.createElement("li",{className:"list-group-item"},o.a.createElement("p",null," Opacity "),o.a.createElement(P.a,{onSlide:this.onChangeSliderOpacity.bind(this),ref:"sliderOpacity",range:{min:0,max:1},start:t,connect:[!0,!1],step:.02,tooltips:!0})))}}]),i}(o.a.Component),Ce=Object(s.b)((function(e){return e}))(Ae),Ie=function(){function e(){Object(v.a)(this,e),this.m_useWebGL2=void 0}return Object(p.a)(e,[{key:"createWebGLContext",value:function(){this.canvas=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");var e=this.canvas.getContext("webgl2");return this.m_useWebGL2=1,null==e?(console.log("WebGL 2 not supported, moving to webgl 1"),e=this.canvas.getContext("webgl"),this.m_useWebGL2=0):console.log("WebGL 2 context created"),e}},{key:"getCanvas",value:function(){return this.canvas}},{key:"useWebGL2",value:function(){return this.m_useWebGL2}}]),e}(),Fe=function(){function e(t,i,a,o,r){Object(v.a)(this,e),this.m_callback=r,this.m_mesh=o,this.m_wireMesh=null,this.m_camera=i,this.m_target=new ce.R(0,0,0),this.m_scene=a,this.m_button=e.EVENT_BUTTON_NA,this.domElem=t,this.m_pressedLeft=!1,this.m_pressedRight=!1,this.m_prevMouse={x:-1,y:-1},this.m_prevTime=-1,this.m_deltaTime=0,this.m_spherical=new ce.L,this.m_sphericalDelta=new ce.L,this.m_spherical.set(0,0,0),this.m_sphericalDelta.set(0,0,0),this.m_autoRotate=!1,this.m_minDistance=.3,this.m_maxDistance=2.5,this.m_minAzimuthAngle=-1/0,this.m_maxAzimuthAngle=1/0,this.m_minPolarAngle=0,this.m_maxPolarAngle=2*Math.PI,this.m_enableDamping=!1,this.m_dampingFactor=.25,this.isEraserMode=!1}return Object(p.a)(e,[{key:"setEraserMode",value:function(e){this.isEraserMode=e}},{key:"setMesh",value:function(e){this.m_mesh=e}},{key:"setWireMesh",value:function(e){this.m_wireMesh=e}},{key:"setScene",value:function(e){this.m_scene=e}},{key:"getX",value:function(e){return e-this.domElem.offsetLeft}},{key:"getY",value:function(e){return e-this.domElem.offsetTop}},{key:"updateTime",value:function(e,t){if(0!==e||0!==t){var i=(new Date).getTime();if(this.m_prevTime=this.m_prevTime>0?this.m_prevTime:i,this.m_deltaTime=i-this.m_prevTime,this.m_prevTime=i,this.m_mesh){var a=new ce.x,o=new ce.x,r=new ce.x,n=new ce.R;n.copy(this.m_target).sub(this.m_camera.position).normalize(),o.makeRotationAxis(this.m_camera.up,.008*e),a.makeRotationAxis(n.cross(this.m_camera.up),.008*t),r.identity(),r.multiply(o).multiply(a).multiply(this.m_mesh.matrix),this.m_mesh.rotation.setFromRotationMatrix(r),this.m_wireMesh&&(r.identity(),r.multiply(o).multiply(a).multiply(this.m_wireMesh.matrix),this.m_wireMesh.rotation.setFromRotationMatrix(r)),this.m_callback()}}}},{key:"onMouseDown",value:function(e,t,i){this.m_pressedLeft=!0,this.m_prevMouse={x:e,y:t},this.m_spherical.set(0,0,0),this.m_sphericalDelta.set(0,0,0),this.m_prevTime=(new Date).getTime(),this.ctrlKey=i}},{key:"onMouseUp",value:function(){this.m_pressedLeft=!1,this.m_prevMouse.x=-1,this.m_prevMouse.y=-1}},{key:"onMouseMove",value:function(e,t){this.m_prevMouse.x<0&&(this.m_prevMouse.x=e,this.m_prevMouse.y=t);var i=e-this.m_prevMouse.x,a=t-this.m_prevMouse.y;this.m_prevMouse.x=e,this.m_prevMouse.y=t,this.m_pressedLeft&&this.updateTime(i,a)}},{key:"onZoom",value:function(e){var t=.2*e,i=this.m_camera.position.length(),a=this.m_camera.position.sub(this.m_target);a.normalize(),i+=t,i=Math.max(i,.3),i=Math.min(i,2.5),a.multiplyScalar(i),this.m_camera.position.set(a.x,a.y,a.z),this.m_camera.lookAt(this.m_target),this.m_camera.updateMatrixWorld()}}]),e}();Fe.EVENT_BUTTON_NA=-1,Fe.EVENT_BUTTON_LEFT=0,Fe.EVENT_BUTTON_CENTER=1,Fe.EVENT_BUTTON_RIGHT=2;var Pe=i.p+"static/media/backface.3dc9d515.vert",Ue=i.p+"static/media/backface.84a75448.frag",Xe=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment=""}return Object(p.a)(e,[{key:"create",value:function(e){var t=this,i=new ce.o(ce.l);i.setResponseType("text");var a=new ce.o(ce.l);a.setResponseType("text"),i.load(Pe,(function(i){t.m_strShaderVertex=i,a.load(Ue,(function(i){t.m_strShaderFragment=i;var a=new ce.K({vertexShader:t.m_strShaderVertex,fragmentShader:t.m_strShaderFragment,side:ce.c,depthTest:!0,depthFunc:ce.s,blending:ce.A});e&&e(a)}))}))}}]),e}(),ze=i.p+"static/media/frontface.6197e7b1.vert",Le=i.p+"static/media/frontface.7ecf0644.frag",Ne=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={texBF:{type:"t",value:null},PlaneX:{type:"v4",value:new ce.S(-1,0,0,.5)},PlaneY:{type:"v4",value:new ce.S(0,-1,0,.5)},PlaneZ:{type:"v4",value:new ce.S(0,0,-1,.5)}}}return Object(p.a)(e,[{key:"create",value:function(e,t){var i=this;this.m_uniforms.texBF.value=e;var a=new ce.o(ce.l);a.setResponseType("text");var o=new ce.o(ce.l);o.setResponseType("text"),a.load(ze,(function(e){i.m_strShaderVertex=e,o.load(Le,(function(e){i.m_strShaderFragment=e;var a=new ce.K({uniforms:i.m_uniforms,vertexShader:i.m_strShaderVertex,fragmentShader:i.m_strShaderFragment,side:ce.q,depthTest:!0,depthFunc:ce.t,blending:ce.A});t&&t(a)}),(function(e){console.log("Shader load failed! because of error "+e.target.status+", "+e.target.statusText)}))}))}}]),e}(),Ve=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_defines={backCullMode:1},this.m_uniforms={texBF:{type:"t",value:null},texFF:{type:"t",value:null}}}return Object(p.a)(e,[{key:"create",value:function(e,t){return this.m_uniforms.texBF.value=e,this.m_uniforms.texFF.value=t,this.m_strShaderVertex="\n      varying vec3 pos;\n      attribute vec3 uvw;\n      varying vec4 screenpos;\n      void main() {\n        pos = uvw;\n        screenpos = (projectionMatrix  * modelViewMatrix * vec4(position, 1.0));\n        gl_Position =  screenpos;\n      }\n    ",this.m_strShaderFragment="\n      precision highp float;\n      precision highp int;\n      uniform sampler2D texFF;\n      uniform sampler2D texBF;\n\n      varying vec3 pos;\n      varying vec4 screenpos;\n      void main() {\n      vec2 tc = screenpos.xy / screenpos.w * 0.5 + 0.5;\n      vec3 back  = texture2D(texBF, tc, 0.0).xyz;\n      vec3 front = texture2D(texFF, tc, 0.0).xyz;\n      float cullvalue = length(pos - back) - length(front - back);\n\n\n      #if backCullMode == 1\n        if (cullvalue < -0.001)\n          discard;\n      #endif\n      #if backCullMode == 0\n        if (cullvalue > 0.001)\n          discard;\n      #endif\n\n        gl_FragColor = vec4(0.5, 0.0, 1.0, 1.0);\n        //gl_FragColor = vec4(cullvalue, cullvalue, cullvalue, 1.0);\n        //gl_FragColor = vec4(front, 1.0);\n      }\n    ",new ce.K({uniforms:this.m_uniforms,defines:this.m_defines,vertexShader:this.m_strShaderVertex,fragmentShader:this.m_strShaderFragment,side:ce.q,wireframe:!0,depthTest:!1,polygonOffset:!1,polygonOffsetFactor:-4,polygonOffsetUnits:-4})}}]),e}(),Be=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={texBuffer:{type:"t",value:null}}}return Object(p.a)(e,[{key:"create",value:function(e){return this.m_uniforms.texBuffer.value=e,this.m_strShaderVertex="\n      varying vec4 screenpos;\n      void main() {\n        screenpos = (projectionMatrix  * modelViewMatrix * vec4(position, 1.0));\n        gl_Position =  screenpos;\n      }\n    ",this.m_strShaderFragment="\n      precision highp float;\n      precision highp int;\n      uniform sampler2D texBuffer;\n\n      varying vec4 screenpos;\n      void main() {\n        vec2 tc = screenpos.xy / screenpos.w * 0.5 + 0.5;\n        gl_FragColor = texture2D(texBuffer, tc, 0.0);\n      }\n    ",new ce.K({uniforms:this.m_uniforms,vertexShader:this.m_strShaderVertex,fragmentShader:this.m_strShaderFragment,side:ce.q,depthTest:!0,depthFunc:ce.t,blending:ce.A})}}]),e}(),je=i.p+"static/media/clipplane.7ba65be0.vert",Ge=i.p+"static/media/clipplane.d594e568.frag",We=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={MVP:{type:"m4"},texBF:{type:"t"}}}return Object(p.a)(e,[{key:"create",value:function(e,t){var i=this;this.m_uniforms.texBF.value=e;var a=new ce.o(ce.l);a.setResponseType("text");var o=new ce.o(ce.l);o.setResponseType("text"),a.load(je,(function(e){i.m_strShaderVertex=e,o.load(Ge,(function(e){i.m_strShaderFragment=e;var a=new ce.K({uniforms:i.m_uniforms,vertexShader:i.m_strShaderVertex,fragmentShader:i.m_strShaderFragment,side:ce.m,depthTest:!1,depthWrite:!1});t&&t(a)}))}))}}]),e}(),He=i.p+"static/media/rendertotexture.b51229d9.vert",qe=i.p+"static/media/rendertotexture.f0ef0a21.frag",Ye=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={texTF:{type:"t",value:null},texVolume:{type:"t",value:null},texRoiId:{type:"t",value:null},texRoiColor:{type:"t",value:null},RoiVolumeTex:{type:"t",value:null},texVolumeMask:{type:"t",value:null},texVolumeAO:{type:"t",value:null},lightDir:{type:"v3",value:new ce.R(0,0,0)},texBF:{type:"t",value:null},texFF:{type:"t",value:null},t_function1min:{type:"v4",value:new ce.S(0,0,0,0)},t_function1max:{type:"v4",value:new ce.S(0,0,0,0)},t_function2min:{type:"v4",value:new ce.S(0,0,0,0)},t_function2max:{type:"v4",value:new ce.S(0,0,0,0)},stepSize:{type:"v4",value:new ce.S(0,0,0,0)},texSize:{type:"f",value:0},isoThreshold:{type:"f",value:0},brightness3D:{type:"f",value:0},contrast3D:{type:"f",value:0},colorMap1D:{type:"t",value:null},heatMap1D:{type:"t",value:null},opacityBarrier:{type:"f",value:0},tileCountX:{type:"f",value:0},volumeSizeZ:{type:"f",value:0},xDim:{type:"f",value:0},yDim:{type:"f",value:0},zDim:{type:"f",value:0},ssaoOffsets:{type:"v3v"}},this.m_defines={isoRenderFlag:0,MaskFlag:0,useAmbientTex:0,useWebGL2:1}}return Object(p.a)(e,[{key:"create",value:function(e,t,i,a,o,r,n,s){var l=this;this.m_uniforms.texTF.value=e,this.m_uniforms.texVolume.value=t,this.m_uniforms.texVolumeMask.value=i,this.m_uniforms.texVolumeAO.value=a,this.m_uniforms.texBF.value=o,this.m_uniforms.texFF.value=r,this.m_uniforms.ssaoOffsets.value=n;var m=new ce.o(ce.l);m.setResponseType("text");var h=new ce.o(ce.l);h.setResponseType("text"),m.load(He,(function(e){l.m_strShaderVertex=e,h.load(qe,(function(e){l.m_strShaderFragment=e;var t=new ce.K({uniforms:l.m_uniforms,defines:l.m_defines,vertexShader:l.m_strShaderVertex,fragmentShader:l.m_strShaderFragment,side:ce.c,depthTest:!0,depthFunc:ce.s,blending:ce.A});s&&s(t)}))}))}}]),e}(),Ze=i.p+"static/media/interpolation.ae2f2bf4.vert",Ke=i.p+"static/media/interpolation.b65fb94f.frag",Qe=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={isoSurfTexel:{type:"v2",value:null},texIsoSurface:{type:"t",value:null}},this.m_defines={isoRenderFlag:0}}return Object(p.a)(e,[{key:"create",value:function(e,t){var i=this;this.m_uniforms.texIsoSurface.value=e;var a=new ce.o(ce.l);a.setResponseType("text");var o=new ce.o(ce.l);o.setResponseType("text"),a.load(Ze,(function(e){i.m_strShaderVertex=e,o.load(Ke,(function(e){i.m_strShaderFragment=e;var a=new ce.K({uniforms:i.m_uniforms,defines:i.m_defines,vertexShader:i.m_strShaderVertex,fragmentShader:i.m_strShaderFragment,side:ce.c});t&&t(a)}))}))}}]),e}(),Je=i.p+"static/media/volumerender.0fdf551f.vert",$e=i.p+"static/media/volumerender.fb827430.frag",et=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={isoSurfTexel:{type:"v2",value:null},lightDir:{type:"v3",value:new ce.R(0,0,0)},texTF:{type:"t",value:null},texVolume:{value:null},texRoiId:{type:"t",value:null},texRoiColor:{type:"t",value:null},RoiVolumeTex:{type:"t",value:null},texVolumeMask:{type:"t",value:null},texVolumeAO:{type:"t",value:null},texBF:{type:"t",value:null},texFF:{type:"t",value:null},texIsoSurface:{type:"t",value:null},colorMap1D:{type:"t",value:null},heatMap1D:{type:"t",value:null},t_function1min:{type:"v4",value:new ce.S(0,0,0,0)},t_function1max:{type:"v4",value:new ce.S(0,0,0,0)},t_function2min:{type:"v4",value:new ce.S(0,0,0,0)},t_function2max:{type:"v4",value:new ce.S(0,0,0,0)},stepSize:{type:"v4",value:new ce.S(0,0,0,0)},texSize:{type:"f",value:0},isoThreshold:{type:"f",value:0},brightness3D:{type:"f",value:0},contrast3D:{type:"f",value:0},tileCountX:{type:"f",value:0},volumeSizeZ:{type:"f",value:0},opacityBarrier:{type:"f",value:0},xDim:{type:"f",value:0},yDim:{type:"f",value:0},zDim:{type:"f",value:0},ssaoOffsets:{type:"v3v"}},this.m_defines={isoRenderFlag:0,MaskFlag:0,useAmbientTex:0,useWebGL2:1}}return Object(p.a)(e,[{key:"create",value:function(e,t,i,a,o,r,n,s,l){var m=this;this.m_uniforms.texTF.value=e,this.m_uniforms.texVolume.value=t,this.m_uniforms.texVolumeMask.value=i,this.m_uniforms.texVolumeAO.value=a,this.m_uniforms.texBF.value=o,this.m_uniforms.texFF.value=r,this.m_uniforms.texIsoSurface.value=n,this.m_uniforms.ssaoOffsets.value=s;var h=new ce.o(ce.l);h.setResponseType("text");var u=new ce.o(ce.l);u.setResponseType("text"),h.load(Je,(function(e){m.m_strShaderVertex=e,u.load($e,(function(e){m.m_strShaderFragment=e;var t=new ce.K({uniforms:m.m_uniforms,defines:m.m_defines,vertexShader:m.m_strShaderVertex,fragmentShader:m.m_strShaderFragment,side:ce.c,depthTest:!0,depthFunc:ce.s,blending:ce.A});l&&l(t)}))}))}}]),e}(),tt=i.p+"static/media/blur.a62df0a0.vert",it=i.p+"static/media/blur.d95db93c.frag",at=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="";this.m_uniforms={texVolume:{type:"t",value:null},texVolumeRoi:{type:"t",value:null},texRoiColor:{type:"t",value:null},texSegInUse:{type:"t",value:null},texelSize:{type:"v3",value:null},tileCountX:{type:"f",value:16},volumeSizeZ:{type:"f",value:256},xDim:{type:"f",value:256},yDim:{type:"f",value:256},blurSigma:{type:"f",value:.8},contrast:{type:"f",value:1},brightness:{type:"f",value:0},curZ:{type:"f",value:0},save_flag:{type:"b",value:!0}},this.m_defines={renderRoiMap:0,useWebGL2:1}}return Object(p.a)(e,[{key:"create",value:function(e,t,i,a,o,r){var n=this;this.m_uniforms.texVolume.value=e,this.m_uniforms.texVolume.value=e,this.m_uniforms.texVolumeRoi.value=t,this.m_uniforms.texRoiColor.value=a,this.m_uniforms.texSegInUse.value=o,this.m_uniforms.texelSize.value=i;var s=new ce.o(ce.l);s.setResponseType("text");var l=new ce.o(ce.l);l.setResponseType("text"),s.load(tt,(function(e){n.m_strShaderVertex=e,l.load(it,(function(e){n.m_strShaderFragment=e;var t=new ce.K({uniforms:n.m_uniforms,defines:n.m_defines,vertexShader:n.m_strShaderVertex,fragmentShader:n.m_strShaderFragment});r&&r(t)}))}))}}]),e}(),ot=i.p+"static/media/createAO.a62df0a0.vert",rt=i.p+"static/media/createAO.bae764f9.frag",nt=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="";var t=1/256,i=256;this.m_uniforms={texVolume:{type:"t",value:null},vectorsTex:{type:"t",value:null},texelSize:{type:"v3",value:new ce.R(t,t,t)},tileCountX:{type:"f",value:16},volumeSizeZ:{type:"f",value:i},xDim:{type:"f",value:i},yDim:{type:"f",value:i},curZ:{type:"f",value:i},isoThreshold:{type:"f",value:i},vectorsSize:{type:"i",value:null}},this.m_defines={useWebGL2:1}}return Object(p.a)(e,[{key:"create",value:function(e,t,i,a,o,r){var n=this;this.m_uniforms.texVolume.value=e,this.m_uniforms.vectorsTex.value=i,this.m_uniforms.texelSize.value=t,this.m_uniforms.vectorsSize.value=a,this.m_uniforms.isoThreshold.value=o;var s=new ce.o(ce.l);s.setResponseType("text");var l=new ce.o(ce.l);l.setResponseType("text"),s.load(ot,(function(e){n.m_strShaderVertex=e,l.load(rt,(function(e){n.m_strShaderFragment=e;var t=new ce.K({uniforms:n.m_uniforms,defines:n.m_defines,vertexShader:n.m_strShaderVertex,fragmentShader:n.m_strShaderFragment});r&&r(t)}))}))}}]),e}(),st=function e(){Object(v.a)(this,e),this.m_point=new ce.R,this.m_next=null},lt=function(){function e(t){Object(v.a)(this,e),this.create(t)}return Object(p.a)(e,[{key:"create",value:function(e){this.m_numPoints=0,this.m_numAllocatedPoints=e,this.m_points=new Array(e),this.m_voxels=new Array(4096);for(var t=0;t<e;t++)this.m_points[t]=new st,this.m_points[t].m_point.set(0,0,0),this.m_points[t].m_next=null}},{key:"getNumPoints",value:function(){return this.m_numPoints}},{key:"findPointSlow",value:function(e,t,i){for(var a=0;a<this.m_numPoints;a++){var o=e-this.m_points[a].m_point.x,r=t-this.m_points[a].m_point.y,n=i-this.m_points[a].m_point.z;if(o*o+r*r+n*n<1e-8)return a}return-1}},{key:"addPoint",value:function(e,t,i){var a=this.findPointSlow(e,t,i);if(a>=0)return a;if(this.m_numPoints>=this.m_numAllocatedPoints)return-1;var o=this.m_numPoints;return this.m_points[o]=new st,this.m_points[o].m_point.set(e,t,i),this.m_points[o].m_next=null,this.m_numPoints++,o}}]),e}(),mt=function e(t,i,a){Object(v.a)(this,e);this.m_indices=new Int32Array(3),this.m_indices[0]=t,this.m_indices[1]=i,this.m_indices[2]=a},ht=function(){function e(t){Object(v.a)(this,e),this.create(t)}return Object(p.a)(e,[{key:"create",value:function(e){this.m_numTriangles=0,this.m_numAllocatedTriangles=e,this.m_triangles=new Array(e);for(var t=0;t<e;t++)this.m_triangles[t]=new mt(-1,-1,-1)}},{key:"getNumTriangles",value:function(){return this.m_numTriangles}},{key:"addTriangle",value:function(e,t,i){return this.m_numTriangles>=this.m_numAllocatedTriangles?-1:(this.m_triangles[this.m_numTriangles].m_indices[0]=e,this.m_triangles[this.m_numTriangles].m_indices[1]=t,this.m_triangles[this.m_numTriangles].m_indices[2]=i,this.m_numTriangles++,1)}}]),e}(),ut=function e(){Object(v.a)(this,e),this.va=new ce.R,this.vb=new ce.R,this.vc=new ce.R},ct=function(){function e(){Object(v.a)(this,e),this.m_numAllocated=0,this.m_numStacked=0,this.m_stack=null}return Object(p.a)(e,[{key:"create",value:function(e){for(var t=20,i=0;i<e;i++)t*=4;this.m_numAllocated=t,this.m_stack=new Array(this.m_numAllocated);for(var a=0;a<this.m_numAllocated;a++)this.m_stack[a]=new ut;this.m_numStacked=0}},{key:"getStackDepth",value:function(){return this.m_numStacked}},{key:"isEmpty",value:function(){return 0===this.m_numStacked}},{key:"push",value:function(e,t,i){return this.m_numStacked>=this.m_numAllocated?-1:(this.m_stack[this.m_numStacked].va=e,this.m_stack[this.m_numStacked].vb=t,this.m_stack[this.m_numStacked].vc=i,this.m_numStacked++,1)}},{key:"pop",value:function(){return this.m_numStacked<=0?null:(this.m_numStacked--,this.m_stack[this.m_numStacked])}}]),e}(),dt=function(){function e(){Object(v.a)(this,e),this.m_pointSet=null,this.m_triangleSet=null}return Object(p.a)(e,[{key:"create",value:function(e,t){var i=.5257311121,a=.8506508083,o=[-i,0,+a,+i,0,+a,-i,0,-a,+i,0,-a,0,+a,+i,0,+a,-i,0,-a,+i,0,-a,-i,+a,+i,0,-a,+i,0,+a,-i,0,-a,-i,0],r=[0,4,1,0,9,4,9,5,4,4,5,8,4,8,1,8,10,1,8,3,10,5,3,8,5,2,3,2,7,3,7,10,3,7,6,10,7,11,6,11,0,6,0,1,6,6,1,10,9,0,11,9,11,2,9,2,5,7,2,11];this.m_pointSet=new lt(12);for(var n=0,s=0;s<12;s++,n+=3){var l=o[n+0],m=o[n+1],h=o[n+2];this.m_pointSet.addPoint(l,m,h)}this.m_triangleSet=new ht(20),n=0;for(var u=0;u<20;u++,n+=3){var c=r[n+0],d=r[n+1],_=r[n+2];this.m_triangleSet.addTriangle(c,_,d)}this.subDivideMesh(t);for(var f=this.m_pointSet.getNumPoints(),v=0;v<f;v++)this.m_pointSet.m_points[v].m_point.x*=e.x,this.m_pointSet.m_points[v].m_point.y*=e.y,this.m_pointSet.m_points[v].m_point.z*=e.z;return 1}},{key:"getNumTriangles",value:function(){return this.m_triangleSet.m_numTriangles}},{key:"getNumVertices",value:function(){return this.m_pointSet.m_numPoints}},{key:"getVertex",value:function(e){return this.m_pointSet.m_points[e].m_point}},{key:"getTriangle",value:function(e){return this.m_triangleSet.m_triangles[e].m_indices}},{key:"saveGeoToPlyFile",value:function(e){var t="ply\nformat ascii 1.0\ncomment tetrahedron mesh\n",i=this.m_pointSet.m_numPoints,a=i.toString();t=(t=(t=(t=(t=t.concat("element vertex ")).concat(a)).concat("\n")).concat("property float x\nproperty float y\nproperty float z\n")).concat("element face ");var o=this.m_triangleSet.m_numTriangles,r=o.toString();t=(t=(t=(t=t.concat(r)).concat("\n")).concat("property list uchar int vertex_indices\n")).concat("end_header\n");for(var n=0;n<i;n++){var s=this.m_pointSet.m_points[n].m_point,l=s.x.toString(),m=s.y.toString(),h=s.z.toString();t=(t=(t=(t=(t=(t=t.concat(l)).concat(" ")).concat(m)).concat(" ")).concat(h)).concat(" 1.0\n")}for(var u=0;u<o;u++){var c=this.m_triangleSet.m_triangles[u].m_indices,d="3 ".concat(c[0]," ").concat(c[1]," ").concat(c[2],"\n");t=t.concat(d)}var _=(new TextEncoder).encode(t),f=new Blob([_],{type:"application/octet-stream"}),v=URL.createObjectURL(f),p=document.createElement("a");p.setAttribute("href",v),p.setAttribute("download",e);var g=document.createEvent("MouseEvents");g.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),p.dispatchEvent(g)}},{key:"saveGeoToObjFile",value:function(e){for(var t="# Tetrahedron test geo\n",i=this.m_pointSet.m_numPoints,a=i.toString(),o=this.m_triangleSet.m_numTriangles,r=o.toString(),n=0;n<i;n++){var s=this.m_pointSet.m_points[n].m_point,l=s.x.toString(),m=s.y.toString(),h=s.z.toString();t=(t=(t=(t=(t=(t=(t=t.concat("v  ")).concat(l)).concat(" ")).concat(m)).concat(" ")).concat(h)).concat("\n")}var u="# ".concat(a," vertices\n");t=(t=t.concat(u)).concat("g TetraObj\n");for(var c=0;c<o;c++){var d=this.m_triangleSet.m_triangles[c].m_indices,_=1+d[0],f=1+d[1],v=1+d[2],p="f ".concat(_," ").concat(f," ").concat(v,"\n");t=t.concat(p)}var g="# ".concat(r," triangles\n");t=t.concat(g);var S=(new TextEncoder).encode(t),y=new Blob([S],{type:"application/octet-stream"}),x=URL.createObjectURL(y),b=document.createElement("a");b.setAttribute("href",x),b.setAttribute("download",e);var D=document.createEvent("MouseEvents");D.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),b.dispatchEvent(D)}},{key:"subDivideMesh",value:function(e){if(0===e)return 1;var t=new ct;t.create(e);var i=new ct;i.create(e);for(var a=this.m_triangleSet.getNumTriangles(),o=0;o<a;o++){var r=this.m_triangleSet.m_triangles[o].m_indices,n=r[0],s=r[1],l=r[2],m=this.m_pointSet.m_points[n].m_point,h=this.m_pointSet.m_points[s].m_point,u=this.m_pointSet.m_points[l].m_point,c=t.push(m,h,u);if(c<1)return c}for(var d=t,_=i,f=0;f<e;f++){for(var v=d.getStackDepth(),p=0;p<v;p++){var g=d.pop();if(null===g)return-1;var S=g.va,y=g.vb,x=g.vc,b=new ce.R,D=new ce.R,T=new ce.R;b.addVectors(S,y),b.normalize(),D.addVectors(y,x),D.normalize(),T.addVectors(x,S),T.normalize(),_.push(S,b,T),_.push(y,D,b),_.push(x,T,D),_.push(b,D,T)}var E=d;d=_,_=E}var M=d.getStackDepth(),w=Math.floor(3*M*.6);for(this.m_triangleSet.create(M),this.m_pointSet.create(w);!d.isEmpty();){var R=d.pop(),k=R.va,O=R.vb,A=R.vc,C=this.m_pointSet.addPoint(k.x,k.y,k.z),I=this.m_pointSet.addPoint(O.x,O.y,O.z),F=this.m_pointSet.addPoint(A.x,A.y,A.z),P=this.m_triangleSet.addTriangle(C,I,F);if(1!==P)return P}var U=this.m_pointSet.getNumPoints(),X=this.m_triangleSet.getNumTriangles();return U>w||X>M?-10:1}}]),e}(),_t=function(){function e(t){Object(v.a)(this,e),this.rendererBlur=t.renderer,this.sceneBlur=t.scene,this.cameraOrtho=t.camera,this.xDim=t.xDim,this.yDim=t.yDim,this.zDim=t.zDim,this.texVolumeAO=null,this.vectorsTex=null}return Object(p.a)(e,[{key:"_setAOVectorTex",value:function(){var e=255,t=new dt,i=new ce.R(.5,.5,.5);if(!(t.create(i,2)<1)){this.numAOVectors=t.getNumVertices(),this.vectors=new Uint8Array(4*this.numAOVectors);for(var a=0;a<this.numAOVectors;a++){var o=t.getVertex(a);this.vectors[4*a+0]=(o.x+.5)*e,this.vectors[4*a+1]=(o.y+.5)*e,this.vectors[4*a+2]=(o.z+.5)*e,this.vectors[4*a+3]=e}this.vectorsTex=new ce.j(this.vectors,this.numAOVectors,1,ce.H),this.vectorsTex.wrapS=ce.g,this.vectorsTex.wrapT=ce.g,this.vectorsTex.magFilter=ce.z,this.vectorsTex.minFilter=ce.z,this.vectorsTex.needsUpdate=!0}}},{key:"set",value:function(e,t){var i=this;null===this.vectorsTex&&this._setAOVectorTex(),this.xDimAO=this.xDim,this.yDimAO=this.yDim,this.zDimAO=this.zDim,this.bufferTextureAO=new ce.T(this.xDimAO,this.yDimAO,{minFilter:ce.u,magFilter:ce.u,format:ce.H,type:ce.P,depthBuffer:!1}),this.ambientVolumeTexCPU=new Uint8Array(this.xDimAO*this.yDimAO*this.zDimAO),0===this.isWebGL2?this.texVolumeAO=new ce.j(this.ambientVolumeTexCPU,this.xTex,this.yTex,ce.b):(this.texVolumeAO=new ce.k(this.ambientVolumeTexCPU,this.xDimAO,this.yDimAO,this.zDimAO),this.texVolumeAO.format=ce.I),this.texVolumeAO.wrapS=ce.g,this.texVolumeAO.wrapT=ce.g,this.texVolumeAO.wrapR=ce.g,this.texVolumeAO.magFilter=ce.u,this.texVolumeAO.minFilter=ce.u,this.texVolumeAO.needsUpdate=!0;var a=new ce.R(1/this.xDim,1/this.yDim,1/this.zDim);(new nt).create(e,a,this.vectorsTex,this.numAOVectors,t,(function(e){i.materialAO=e,e.uniforms.tileCountX.value=i.zTexDivSqrt,e.uniforms.volumeSizeZ.value=i.zDim,i.setAmbientTextureWebGL2(),i.texVolumeAO.needsUpdate=!0}))}},{key:"setAmbientTextureWebGL2",value:function(){var e=new Uint8Array(4*this.xDimAO*this.yDimAO),t=this.rendererBlur.getContext();console.log("AO WebGL2");for(var i=0;i<this.zDimAO;++i){this.materialAO.uniforms.curZ.value=i/(this.zDimAO-1),this.materialAO.uniforms.curZ.needsUpdate=!0,this.sceneBlur.overrideMaterial=this.materialAO,this.rendererBlur.render(this.sceneBlur,this.cameraOrtho,this.bufferTextureAO),this.sceneBlur.overrideMaterial=null,t.readPixels(0,0,this.xDimAO,this.yDimAO,t.RGBA,t.UNSIGNED_BYTE,e);for(var a=i*this.xDimAO*this.yDimAO,o=0;o<this.yDimAO;o++)for(var r=0;r<this.xDimAO;r++)this.ambientVolumeTexCPU[r+o*this.xDimAO+a]=e[4*(r+o*this.xDimAO)]}console.log("AO WebGL2 End")}},{key:"get",value:function(){return this.texVolumeAO}}]),e}(),ft=function(){function e(){Object(v.a)(this,e),this.selectedROIs=null,this.transferFuncRgba=null,this.transferFuncTexture=null,this.texRoiColor=null,this.texRoiId=null,this.numRois=256,this.m_handleColors=[{r:0,g:0,b:0},{r:255,g:128,b:64},{r:255,g:0,b:0},{r:128,g:64,b:64},{r:128,g:0,b:0},{r:64,g:64,b:64},{r:128,g:128,b:128},{r:192,g:192,b:192},{r:255,g:255,b:255},{r:255,g:255,b:255}]}return Object(p.a)(e,[{key:"init",value:function(e,t){this.selectedROIs=new Uint8Array(4*this.numRois),this.numTfPixels=256,this.transferFuncRgba=new Uint8Array(4*this.numTfPixels),this.texRoiColor=null,e&&(this.texRoiId=this.createSelectedRoiMap(),this.texRoiColor=this.createRoiColorMap(t))}},{key:"createTransferFuncTexture",value:function(){for(var e=null,t=0,i=255,a=22.95,o=76.5,r=.43*i,n=135.15,s=0;s<this.numTfPixels;s++)s>a&&s<51&&(t=(s-a)/28.05),s>51&&s<o&&(t=(o-s)/25.5),s>r&&s<n&&(t=(s-r)/(n-r)),s>n&&(t=1),this.transferFuncRgba[4*s+0]=i,this.transferFuncRgba[4*s+1]=0,this.transferFuncRgba[4*s+1+1]=0,this.transferFuncRgba[4*s+1+1+1]=i*t/12,s>r&&(this.transferFuncRgba[4*s+0]=255,this.transferFuncRgba[4*s+1]=210,this.transferFuncRgba[4*s+1+1]=180,this.transferFuncRgba[4*s+1+1+1]=i*t/3);return(e=new ce.j(this.transferFuncRgba,this.numTfPixels,1,ce.H)).wrapS=ce.g,e.wrapT=ce.g,e.magFilter=ce.z,e.minFilter=ce.z,e.needsUpdate=!0,this.transferFuncTexture=e,e}},{key:"setTransferFuncColors",value:function(e){this.transferFuncCtrlPtsRgb=[];for(var t=0;t<e.length;t++)this.transferFuncCtrlPtsRgb.push(new ce.R(e[t].r,e[t].g,e[t].b))}},{key:"updateTransferFuncTexture",value:function(e,t){if(null===this.transferFuncRgba)return null;for(var i=0;i<e.length-1;i++)for(var a=Math.floor(e[i]),o=Math.floor(e[i+1]),r=a;r<o;r++){var n=(r-a)/(o-a),s=(1-n)*this.m_handleColors[i].r+n*this.m_handleColors[i+1].r,l=(1-n)*this.m_handleColors[i].g+n*this.m_handleColors[i+1].g,m=(1-n)*this.m_handleColors[i].b+n*this.m_handleColors[i+1].b;this.transferFuncRgba[4*r+0]=s,this.transferFuncRgba[4*r+1]=l,this.transferFuncRgba[4*r+2]=m;var h=t[i]>0?t[i]:0,u=t[i+1]>0?t[i+1]:0;this.transferFuncRgba[4*r+3]=255*(u*n+(1-n)*h)}return this.transferFuncTexture.needsUpdate=!0,this.transferFuncRgba}},{key:"createRoiColorMap",value:function(e){var t=null;if(null!==e)t=new ce.j(e,256,1,ce.H);else{for(var i=new Uint8Array(4*this.numRois),a=0;a<this.numRois;a++)i[4*a+0]=255,i[4*a+1]=0,i[4*a+2]=0,i[4*a+3]=255;t=new ce.j(i,this.numRois,1,ce.H)}return t.wrapS=ce.g,t.wrapT=ce.g,t.magFilter=ce.z,t.minFilter=ce.z,t.needsUpdate=!0,t}},{key:"createSelectedRoiMap",value:function(){for(var e=0;e<this.numRois;e++)this.selectedROIs[4*e]=e<50||e>240?0:255,this.selectedROIs[4*e+1]=0,this.selectedROIs[4*e+2]=0,this.selectedROIs[4*e+3]=0;var t=new ce.j(this.selectedROIs,256,1,ce.H);return t.wrapS=ce.g,t.wrapT=ce.g,t.magFilter=ce.z,t.minFilter=ce.z,t.needsUpdate=!0,t}},{key:"updateSelectedRoiMap",value:function(e){for(var t=0;t<this.numRois;t++)e[t]?this.selectedROIs[4*t]=255:this.selectedROIs[4*t]=0;this.texRoiId.needsUpdate=!0}},{key:"updateSelectedRoi",value:function(e,t){this.selectedROIs[4*e]=t?255:0,console.log("initMatBlure: ".concat(this.initMatBlure)),this.texRoiId.needsUpdate=!0}}]),e}(),vt=function(){function e(){Object(v.a)(this,e),this.bufferBF=null,this.bufferFF=null,this.bufferRenderToTexture=null,this.isoThreshold=0,this.volTextureMask=null,this.geometry=null,this.lastSize=[],this.lastDepth=[],this.lastRotationVector=[],this.lastTarget=[],this.lastMode=[],this.lastBackDistance=[],this.resetflag=!1,this.bufferTextureCPU=null}return Object(p.a)(e,[{key:"createUpdatableVolumeMask",value:function(e,t){this.xDim=e.xDim,this.yDim=e.yDim,this.zDim=e.zDim,this.bufferBF=e.bufBF,this.bufferFF=e.bufFF,this.bufferRenderToTexture=e.bufTex,this.bufferMask=new Uint8Array(this.xDim*this.yDim*this.zDim),this.bufferTextureCPU=t;for(var i=0;i<this.zDim;i++)for(var a=0;a<this.yDim;a++)for(var o=0;o<this.xDim;o++)this.bufferMask[o+a*this.xDim+i*this.xDim*this.yDim]=255;return this.updatableTextureMask&&this.updatableTextureMask.dispose(),this.updatableTextureMask=new ce.k(this.bufferMask,this.xDim,this.yDim,this.zDim),this.updatableTextureMask.format=ce.I,this.updatableTextureMask.type=ce.P,this.updatableTextureMask.wrapS=ce.g,this.updatableTextureMask.wrapT=ce.g,this.updatableTextureMask.magFilter=ce.u,this.updatableTextureMask.minFilter=ce.u,this.updatableTextureMask.needsUpdate=!0,this.updatableTextureMask}},{key:"eraseStart",value:function(e,t,i,a,o){this.isoThreshold=a;var r=Math.round(e),n=Math.round(t);this.eraserMouseDown=!0;var s=4*(n*i+r),l=4*(Math.floor(n/3)*Math.floor(i/3)+Math.floor(r/3)),m=this.bufferRenderToTexture[l+3];if(2!==m){var h=this.bufferBF[s+0]-this.bufferFF[s+0],u=this.bufferBF[s+1]-this.bufferFF[s+1],c=this.bufferBF[s+2]-this.bufferFF[s+2],d=new ce.R(h,u,c),_=Math.sqrt(h*h+u*u+c*c);h=h/_*m+.5+this.bufferFF[s+0],u=u/_*m+.5+this.bufferFF[s+1],c=c/_*m+.5+this.bufferFF[s+2],this.erasePixels(h,u,c,d,o,m),this.updatableTextureMask.needsUpdate=!0}}},{key:"onMouseUp",value:function(){this.orbitControl.onMouseUp(),this.lockEraserBuffersUpdating=!1,this.eraserMouseDown=!1,this.renderState=this.RENDER_STATE.ONCE}},{key:"setEraserRadius",value:function(e){this.radius=e}},{key:"setEraserDepth",value:function(e){this.depth=e}},{key:"erasePixels",value:function(e,t,i,a,o,r){for(var n=Math.floor(e*this.xDim),s=Math.floor(t*this.yDim),l=Math.floor(i*this.zDim),m=new ce.R,h=new ce.R,u=1.4*1.4,c=0,d=0,_=0,f=0,v=0,p=-Math.min(2,l);p<=Math.min(2,this.zDim-1-l);p++)for(var g=-Math.min(2,s);g<=Math.min(2,this.yDim-1-s);g++)for(var S=-Math.min(2,n);S<=Math.min(2,this.xDim-1-n);S++){var y=l+p;v=n+S+(s+g)*this.xDim+y*this.xDim*this.yDim;var x=1-Math.exp(-(S*S+g*g+p*p)/(2*u));f+=x;var b=this.bufferTextureCPU[v];c+=b*x*(-S/u),d+=b*x*(-g/u),_+=b*x*(-p/u)}h.set(c/f,d/f,_/f),m.copy(h),m.normalize();var D=this.xDim/this.zDim,T=new ce.i(this.radius,this.radius,this.depth,180,this.depth),E=new ce.y(T,null),M=new ce.R(0,0,1);E.quaternion.setFromUnitVectors(M,m.clone().normalize().multiplyScalar(-1)),E.position.copy(new ce.R(n,s,l)),!0===o&&(this.prevDistance=r,this.resetflag=!1);if(!1===this.resetflag)if(Math.abs(this.prevDistance-r)<.05){this.prevDistance=r,this.point=new ce.R(0,0,0),this.queue=[],this.queue.push(this.point);-5;for(var w=!1;this.queue.length>0;){this.point=this.queue.pop();var R=this.point.clone();if(R.z*=D,R.applyAxisAngle(new ce.R(1,0,0),-E.rotation.x),R.applyAxisAngle(new ce.R(0,1,0),-E.rotation.y),R.applyAxisAngle(new ce.R(0,0,1),E.rotation.z),!(Math.sqrt(R.x*R.x+R.y*R.y)>this.radius||Math.abs(R.z)>this.depth||R.z<-5))for(var k=this.point.x-1;k<=this.point.x+1;k++)for(var O=this.point.y-1;O<=this.point.y+1;O++)for(var A=this.point.z-1;A<=this.point.z+1;A++){var C=n+Math.round(k),I=s+Math.round(O),F=l+Math.round(A);if(v=C+I*this.xDim+F*this.xDim*this.yDim,0!==this.bufferMask[v]){var P=255*this.isoThreshold-.01*255;this.bufferTextureCPU[v]>=P&&(w=!0,this.bufferMask[v]=0,this.queue.push(new ce.R(k,O,A)))}}}!0===w&&(this.lastSize.push(this.radius),this.lastDepth.push(this.depth),this.lastRotationVector.push(new ce.R(-E.rotation.x,-E.rotation.y,E.rotation.z)),this.lastTarget.push(new ce.R(n,s,l)),this.lastBackDistance.push(-Math.round(Math.abs(Math.tan(a.normalize().angleTo(h.normalize())))*this.radius))),this.updatableTextureMask.needsUpdate=!0}else this.resetflag=!1}},{key:"undoLastErasing",value:function(){if(0!==this.lastSize.length){var e=this.lastTarget.pop(),t=this.lastRotationVector.pop(),i=Math.round(this.lastSize.pop()),a=this.lastDepth.pop(),o=this.lastBackDistance.pop(),r=this.xDim/this.zDim;for(this.point=new ce.R(0,0,0),this.queue=[],this.queue.push(this.point);this.queue.length>0;){this.point=this.queue.pop();var n=this.point.clone();if(n.z*=r,n.applyAxisAngle(new ce.R(1,0,0),t.x),n.applyAxisAngle(new ce.R(0,1,0),t.y),n.applyAxisAngle(new ce.R(0,0,1),t.z),!(Math.sqrt(n.x*n.x+n.y*n.y)>i||n.z>a||n.z<o))for(var s=0,l=this.point.x-1;l<=this.point.x+1;l++)for(var m=this.point.y-1;m<=this.point.y+1;m++)for(var h=this.point.z-1;h<=this.point.z+1;h++){var u=e.x+Math.round(l),c=e.y+Math.round(m),d=e.z+Math.round(h);s=u+c*this.xDim+d*this.xDim*this.xDim,0===this.bufferMask[s]&&(this.bufferMask[s]=255,this.queue.push(new ce.R(l,m,h)))}}this.updatableTextureMask.needsUpdate=!0}}}]),e}(),pt=function(){function e(){Object(v.a)(this,e),this.transferFunc=null,this.xDim=0,this.yDim=0,this.zDim=0,this.bufferTextureCPU=null,this.eraser=null}return Object(p.a)(e,[{key:"initRenderer",value:function(e,t){var i=this;this.sceneBlur=new ce.J;this.numRois=256,this.cameraOrtho=new ce.D(this.xDim/-2,this.xDim/2,this.yDim/2,this.yDim/-2,.1,100);var a=new Ie;this.context=a.createWebGLContext(),this.canvas3d=a.getCanvas(),this.rendererBlur=new ce.U({canvas:this.canvas3d,context:this.context}),this.ambientTexture=new _t({xDim:this.xDim,yDim:this.yDim,zDim:this.zDim,renderer:this.rendererBlur,scene:this.sceneBlur,camera:this.cameraOrtho}),console.log("rendererBlur done");var o=new ce.G(1,1);this.rendererBlur.setSize(this.xDim,this.yDim),this.transferFunc=new ft,this.transferFunc.init(e,t);var r=new ce.R(1/this.xDim,1/this.yDim,1/this.zDim);(new at).create(this.origVolumeTex,this.RoiVolumeTex,r,this.transferFunc.texRoiColor,this.transferFunc.texRoiId,(function(t){var a=new ce.y(o,t);t.uniforms.volumeSizeZ.value=i.zDim,t.uniforms.xDim.value=i.xDim,t.uniforms.yDim.value=i.yDim,t.defines.useWebGL2=i.isWebGL2,i.material=t,i.sceneBlur.add(a),!1===e?i.switchToBlurRender():i.switchToRoiMapRender(),console.log("isRoiVolume: ".concat(e)),i.setVolumeTexture(.8)})),this.vectorsTex=null}},{key:"createTransferFuncTexture",value:function(){return null!==this.transferFunc?this.transferFunc.createTransferFuncTexture():null}},{key:"setTransferFuncColors",value:function(e){this.transferFunc.setTransferFuncColors(e)}},{key:"updateTransferFuncTexture",value:function(e,t){return this.transferFunc.updateTransferFuncTexture(e,t)}},{key:"switchToRoiMapRender",value:function(){this.material.defines.renderRoiMap=1,this.material.needsUpdate=!0}},{key:"switchToBlurRender",value:function(){this.material.defines.renderRoiMap=0,this.material.needsUpdate=!0}},{key:"setVolumeTexture",value:function(e){this.material&&"undefined"!==typeof this.material?(console.log("blur material NOT null"),this.setVolumeTextureWebGL2(e),this.updatableTexture.needsUpdate=!0):console.log("blur material null")}},{key:"updateVolumeTextureWithMask",value:function(){null===this.eraser.bufferMask&&console.log("volTextureMask null");for(var e=0;e<this.zDim;e++)for(var t=e*this.xDim*this.yDim,i=0;i<this.yDim;i++)for(var a=i*this.xDim,o=0;o<this.xDim;o++){var r=o+a+t,n=this.arrPixels[r],s=r;this.zDim>5&&(0===e||e===this.zDim-1||0===this.eraser.bufferMask[r])&&(n=0),this.bufferR[s]=n}this.origVolumeTex.needsUpdate=!0,this.setVolumeTexture(1)}},{key:"setVolumeTextureWebGL2",value:function(e){this.material.uniforms.blurSigma.value=e,this.material.uniforms.blurSigma.needsUpdate=!0;for(var t=new Uint8Array(4*this.xDim*this.yDim),i=this.rendererBlur.getContext(),a=1;a<this.zDim-1;++a){this.material.uniforms.curZ.value=a/this.zDim,this.material.uniforms.curZ.needsUpdate=!0,this.rendererBlur.render(this.sceneBlur,this.cameraOrtho,this.bufferTexture),i.readPixels(0,0,this.xDim,this.yDim,i.RGBA,i.UNSIGNED_BYTE,t);for(var o=a*this.xDim*this.yDim,r=0;r<this.yDim;r++)for(var n=0;n<this.xDim;n++)if(this.isRoiVolume){var s=4*(n+r*this.xDim),l=s+4*o;this.bufferTextureCPU[l]=t[s],this.bufferTextureCPU[l+1]=t[s+1],this.bufferTextureCPU[l+2]=t[s+2],this.bufferTextureCPU[l+3]=t[s+3]}else this.bufferTextureCPU[n+r*this.xDim+o]=t[4*(n+r*this.xDim)]}}},{key:"set3DTextureFrom1Byte",value:function(){this.bufferTextureCPU=new Uint8Array(this.xDim*this.yDim*this.zDim),this.bufferR=new Uint8Array(this.xDim*this.yDim*this.zDim);for(var e=0;e<this.zDim;e++)for(var t=e*this.xDim*this.yDim,i=0;i<this.yDim;i++)for(var a=i*this.xDim,o=0;o<this.xDim;o++){var r=o+a+t,n=this.arrPixels[r+0],s=r;this.zDim>5&&(0===e||e===this.zDim-1)&&(n=0),this.bufferR[s+0]=n,this.bufferTextureCPU[s+0]=n}console.log("setBufferRgbaFrom1Bytes for 3d texture")}},{key:"set3DTextureFrom4Bytes",value:function(){this.isRoiVolume&&(this.bufferRoi=new Uint8Array(this.xDim*this.yDim*this.zDim),this.bufferTextureCPU=new Uint8Array(4*this.xDim*this.yDim*this.zDim),console.log("ROI")),this.bufferR=new Uint8Array(this.xDim*this.yDim*this.zDim);for(var e=0;e<this.zDim;e++)for(var t=e*this.xDim*this.yDim,i=0;i<this.yDim;i++)for(var a=i*this.xDim,o=0;o<this.xDim;o++){var r=o,n=4*(r+a+t),s=this.arrPixels[n+0],l=this.arrPixels[n+3],m=r+a+t;o<2||o>this.xDim-4||i<2||i>this.yDim-4||e<2||e>this.zDim-4?this.bufferR[m+0]=0:this.bufferR[m+0]=s,this.bufferTextureCPU[4*m+0]=s,this.bufferTextureCPU[4*m+1]=s,this.bufferTextureCPU[4*m+2]=s,this.bufferTextureCPU[4*m+3]=s,this.bufferRoi[m+0]=l}console.log("setBufferRgbaFrom4Bytes for 3D texture")}},{key:"createRoiColorMap",value:function(e){return this.transferFunc.createRoiColorMap(e)}},{key:"createSelectedRoiMap",value:function(){return this.createSelectedRoiMap()}},{key:"updateSelectedRoiMap",value:function(e){this.transferFunc.updateSelectedRoiMap(e),this.setVolumeTexture(1)}},{key:"updateSelectedRoi",value:function(e,t){this.transferFunc.updateSelectedRoi(e,t),this.setVolumeTexture(1)}},{key:"createUpdatableVolumeTex",value:function(e,t,i){this.isWebGL2=1,this.arrPixels=e.m_dataArray;var a=e.m_xDim,o=e.m_yDim,r=e.m_zDim;this.xDim=a,this.yDim=o,this.zDim=r,this.isRoiVolume=t,this.RoiVolumeTex=null,t?(this.set3DTextureFrom4Bytes(),this.RoiVolumeTex=new ce.k(this.bufferRoi,this.xDim,this.yDim,this.zDim),this.RoiVolumeTex.format=ce.I,this.RoiVolumeTex.type=ce.P,this.RoiVolumeTex.wrapS=ce.g,this.RoiVolumeTex.wrapT=ce.g,this.RoiVolumeTex.magFilter=ce.z,this.RoiVolumeTex.minFilter=ce.z,this.RoiVolumeTex.needsUpdate=!0):this.set3DTextureFrom1Byte(),this.bufferTexture=new ce.T(this.xDim,this.yDim,{minFilter:ce.u,magFilter:ce.u,format:ce.H,type:ce.P,depthBuffer:!1}),this.origVolumeTex&&this.origVolumeTex.dispose(),this.origVolumeTex=new ce.k(this.bufferR,this.xDim,this.yDim,this.zDim),this.origVolumeTex.format=ce.I,this.origVolumeTex.type=ce.P,this.origVolumeTex.wrapR=ce.g,this.origVolumeTex.wrapS=ce.g,this.origVolumeTex.wrapT=ce.g,this.origVolumeTex.magFilter=ce.z,this.origVolumeTex.minFilter=ce.z,this.origVolumeTex.needsUpdate=!0;var n=ce.I;return t&&(n=ce.H),this.updatableTexture=new ce.k(this.bufferTextureCPU,this.xDim,this.yDim,this.zDim),this.updatableTexture.format=n,this.updatableTexture.type=ce.P,this.updatableTexture.wrapR=ce.g,this.updatableTexture.wrapS=ce.g,this.updatableTexture.wrapT=ce.g,this.updatableTexture.magFilter=ce.u,this.updatableTexture.minFilter=ce.u,this.zDim>1&&this.initRenderer(t,i),this.updatableTexture.needsUpdate=!0,this.eraser=new vt,this.updatableTexture}},{key:"createUpdatableVolumeMask",value:function(e){return this.eraser.createUpdatableVolumeMask(e,this.bufferTextureCPU)}}]),e}(),gt="72px Arial",St=function(){function e(){Object(v.a)(this,e),this.m_textWidth=0,this.m_textHeight=0,this.m_canvas=document.createElement("canvas"),this.m_ctx=this.m_canvas.getContext("2d")}return Object(p.a)(e,[{key:"width",get:function(){return this.m_canvas.width}},{key:"height",get:function(){return this.m_canvas.height}},{key:"textWidth",get:function(){return this.m_textWidth}},{key:"textHeight",get:function(){return this.m_textHeight}},{key:"drawText",value:function(t,i){this.m_canvas.width=1024,this.m_canvas.height=512,this.m_ctx.fillStyle="rgba(255, 255, 255, 0)";this.m_ctx.fillRect(0,0,512,128),this.m_ctx.font=gt,this.m_ctx.fillStyle=i,this.m_ctx.strokeStyle=i,this.m_ctx.textAlign="left",this.m_ctx.textBaseline="top",this.m_ctx.lineWidth=2;var a=0===t.length?"?":t;this.m_textWidth=Math.floor(this.m_ctx.measureText(a).width),this.m_textHeight=e.getFontHeight(gt),this.m_canvas.width=e.ceilPowerOfTwo(this.m_textWidth),this.m_canvas.height=e.ceilPowerOfTwo(this.m_textHeight),this.m_ctx.fillStyle="rgba(255, 255, 255, 0)",this.m_ctx.fillRect(0,0,this.m_canvas.width,this.m_canvas.height),this.m_ctx.font=gt,this.m_ctx.fillStyle=i,this.m_ctx.strokeStyle=i,this.m_ctx.textAlign="left",this.m_ctx.textBaseline="top",this.m_ctx.fillText(a,0,0)}}],[{key:"getFontHeight",value:function(e){var t=document.getElementsByTagName("body")[0],i=document.createElement("div"),a=document.createTextNode("GyW~ig^");i.appendChild(a),i.setAttribute("style","font:".concat(e,";position:absolute;top:0;left:0")),t.appendChild(i);var o=i.offsetHeight;return t.removeChild(i),o}},{key:"ceilPowerOfTwo",value:function(e){for(var t=1;t<30;t++){var i=1<<t;if(i>=e)return i}return-1}}]),e}(),yt=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this)).m_canvas=new St,a.m_align=new ce.Q(0,0),a.m_side=ce.m,a.m_antialias=!0,a.m_text=e,a}return Object(p.a)(i,[{key:"getText",value:function(){return this.m_text}},{key:"setText",value:function(e){this.m_text!==e&&(this.m_text=e,this.updateText())}},{key:"getFont",value:function(){return this.m_font}},{key:"updateText",value:function(){console.log("Use virtual method for ".concat(this.m_text))}},{key:"cleanUp",value:function(){this.texture&&this.texture.dispose()}},{key:"applyAntiAlias",value:function(){!1===this.antialias&&(this.texture.magFilter=ce.z,this.texture.minFilter=ce.v)}}]),i}(ce.B),xt=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={texture1:{type:"t",value:null}},this.m_strShaderVertex="\n      varying vec3 vecNormal;\n      varying vec3 vecPos;\n      varying vec2 vecUV;\n      void main() {\n        vecPos = position;\n        vecNormal = normal;\n        vecUV = uv;\n        gl_Position = vec4(position, 1.0);\n      }\n    ",this.m_strShaderFragment="\n      varying vec3 vecNormal;\n      varying vec3 vecPos;\n      varying vec2 vecUV;\n\n      uniform sampler2D texture1;\n\n      void main() {\n        vec2 texCoord = vecUV;\n        vec4 vColTex = texture2D(texture1, texCoord, 0.0);\n        float sum = (vColTex.x + vColTex.y + vColTex.z) / 3.0;\n        if (sum < 20.0 / 256.0)\n          discard;\n        gl_FragColor = vec4(vColTex.x, vColTex.y, vColTex.z, sum);\n      }\n    "}return Object(p.a)(e,[{key:"create",value:function(e){this.m_uniforms.texture1.value=e,this.m_material=new ce.K({blending:ce.h,blendEquation:ce.a,blendSrc:ce.M,blendDst:ce.C,uniforms:this.m_uniforms,vertexShader:this.m_strShaderVertex,fragmentShader:this.m_strShaderFragment}),this.m_material.needsUpdate=!0}}]),e}(),bt=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).m_mesh=null,a.m_material=null,a.m_renderedTextHeight=0,a.m_xMin=3,a.m_xMax=-3,a.m_yMin=3,a.m_yMax=-3,a}return Object(p.a)(i,[{key:"getRenderedTextHeight",value:function(){return this.m_renderedTextHeight}},{key:"updateText",value:function(e,t,a,o,r,n,s){var l=this;this.cleanUp(),null!==this.m_mesh&&(this.remove(this.m_mesh),this.m_mesh=null,this.m_material=null),this.m_canvas.drawText(this.m_text,s),this.m_renderedTextHeight=a;var m=a,h=m*(this.m_canvas.m_textWidth/this.m_canvas.m_textHeight);if(this.m_texture=new ce.N(this.m_canvas.m_canvas),this.m_texture.needsUpdate=!0,null===this.m_material){this.m_matTexturePlain=new xt,this.m_matTexturePlain.create(this.m_texture),this.m_material=this.m_matTexturePlain.m_material,this.m_material.blending=ce.h,this.m_material.blendEquation=ce.a,this.m_material.blendSrc=ce.M,this.m_material.blendDst=ce.C,this.m_geometry=new ce.r;var u=this.m_canvas.m_textWidth/this.m_canvas.m_canvas.width,c=this.m_canvas.m_textHeight/this.m_canvas.m_canvas.height;this.m_xMin=i.getXMin(e,o,h),this.m_xMax=i.getXMax(e,o,h),this.m_yMin=i.getYMin(t,r,m),this.m_yMax=i.getYMax(t,r,m);var d=.05,_=new ce.R(this.m_xMin,this.m_yMin,d),f=new ce.R(this.m_xMax,this.m_yMin,d),v=new ce.R(this.m_xMin,this.m_yMax,d),p=new ce.R(this.m_xMax,this.m_yMax,d);this.m_geometry.vertices.push(_),this.m_geometry.vertices.push(f),this.m_geometry.vertices.push(v),this.m_geometry.vertices.push(p),this.m_geometry.faceVertexUvs[0].push([new ce.Q(0,1-c),new ce.Q(u,1-c),new ce.Q(0,1)]),this.m_geometry.faceVertexUvs[0].push([new ce.Q(u,1),new ce.Q(0,1),new ce.Q(u,1-c)]);var g=new ce.R;ce.O.getNormal(_,f,v,g),this.m_geometry.faces.push(new ce.n(0,1,2,g)),this.m_geometry.faces.push(new ce.n(3,2,1,g)),this.m_mesh=new ce.y(this.m_geometry,this.m_material),this.add(this.m_mesh);var S=document.createElement("canvas"),y=S.getContext("2d");S.width=32,S.height=32,y.fillStyle=n,y.fillRect(0,0,S.width,S.height);var x=new ce.N(S);x.needsUpdate=!0,this.m_matTextureBox=new xt,this.m_matTextureBox.create(x,(function(e){l.m_boxMaterial=e;var t=.06;l.m_boxGeometry=new ce.r;var i,a=new ce.R(l.m_xMin,l.m_yMin,t),o=new ce.R(l.m_xMax,l.m_yMin,t),r=new ce.R(l.m_xMin,l.m_yMax,t),n=new ce.R(l.m_xMax,l.m_yMax,t);l.m_boxGeometry.vertices.push(a),l.m_boxGeometry.vertices.push(o),l.m_boxGeometry.vertices.push(r),l.m_boxGeometry.vertices.push(n),ce.O.getNormal(a,o,r,i),l.m_boxGeometry.faces.push(new ce.n(0,1,2,i)),l.m_boxGeometry.faces.push(new ce.n(3,2,1,i)),l.m_boxMesh=new ce.y(l.m_boxGeometry,l.m_boxMaterial),l.add(l.m_boxMesh)}))}else this.m_material.map=this.m_texture}}],[{key:"getXMin",value:function(e,t,a){return t===i.ALIGN_LEFT?e:t===i.ALIGN_RIGHT?e-a:t===i.ALIGN_CENTER?e-.5*a:0}},{key:"getXMax",value:function(e,t,a){return t===i.ALIGN_LEFT?e+a:t===i.ALIGN_RIGHT?e:t===i.ALIGN_CENTER?e+.5*a:0}},{key:"getYMin",value:function(e,t,a){return t===i.ALIGN_TOP?e-a:t===i.ALIGN_BOTTOM?e:t===i.ALIGN_CENTER?e-.5*a:0}},{key:"getYMax",value:function(e,t,a){return t===i.ALIGN_TOP?e:t===i.ALIGN_BOTTOM?e+a:t===i.ALIGN_CENTER?e+.5*a:0}}]),i}(yt);bt.ALIGN_LEFT=0,bt.ALIGN_RIGHT=1,bt.ALIGN_TOP=2,bt.ALIGN_BOTTOM=3,bt.ALIGN_CENTER=4;var Dt=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment=""}return Object(p.a)(e,[{key:"create",value:function(){return this.m_strShaderVertex="\n      void main() {\n        gl_Position = vec4(position, 1.0);\n      }\n    ",this.m_strShaderFragment="\n      void main() {\n        gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);\n      }\n    ",new ce.K({vertexShader:this.m_strShaderVertex,fragmentShader:this.m_strShaderFragment,wireframe:!0})}}]),e}(),Tt=.11,Et=function(){function e(t,i,a,o,r,n,s){Object(v.a)(this,e),this.createWithMaterial(t,i,a,o,r,n,s),this.m_xS=a,this.m_yS=o,this.m_xE=r,this.m_yE=n}return Object(p.a)(e,[{key:"createWithMaterial",value:function(e,t,i,a,o,r,n){this.m_scene=e,this.m_lineWidth=t;var s=new ce.Q(o-i,r-a),l=new ce.Q(+s.y,-s.x);l.normalize(),l.multiplyScalar(t);var m=new ce.R(i-l.x,a-l.y,Tt),h=new ce.R(i+l.x,a+l.y,Tt),u=new ce.R(o-l.x,r-l.y,Tt),c=new ce.R(o+l.x,r+l.y,Tt);this.m_geo=new ce.r,this.m_geo.vertices.push(m),this.m_geo.vertices.push(h),this.m_geo.vertices.push(u),this.m_geo.vertices.push(c);var d=new ce.R(0,0,1);this.m_geo.faces.push(new ce.n(0,1,3,d)),this.m_geo.faces.push(new ce.n(3,2,0,d)),this.m_mesh=new ce.y(this.m_geo,n),this.m_scene.add(this.m_mesh),console.log("Line added to scene: ".concat(i,",").concat(a," -> ").concat(o,",").concat(r," "))}},{key:"getRenderObject",value:function(){return this.m_mesh}},{key:"getxS",value:function(){return this.m_xS}},{key:"getyS",value:function(){return this.m_yS}},{key:"getxE",value:function(){return this.m_xE}},{key:"getyE",value:function(){return this.m_yE}}]),e}(),Mt=function(){function e(t,i){Object(v.a)(this,e),this.m_scene=t,this.m_lineWidth=i,this.m_runningState=!1,this.m_xPixelSize=-1,this.m_yPixelSize=-1;var a=new Dt;this.m_linesMaterial=a.create(),this.m_distances=[],this.m_vertexes=[],this.m_xStart=-1,this.m_yStart=-1,this.m_textWidthScr=.03,this.m_textColor="rgba(255, 255, 255, 255)",this.m_textBgColor="rgb(65, 65, 65)",this.m_zoom=1}return Object(p.a)(e,[{key:"clearLines",value:function(){for(var e=this.m_distances.length,t=0;t<e;++t){var i=this.m_distances.pop();this.m_scene.remove(i.line.getRenderObject()),this.m_scene.remove(i.text)}this.m_runningState=!1,this.m_vertexes=[]}},{key:"updateLines",value:function(e,t,i){for(var a=this.m_distances.length,o=0;o<a;++o){this.m_scene.remove(this.m_distances[o].line.getRenderObject()),this.m_scene.remove(this.m_distances[o].text);var r=(this.m_vertexes[2*o].xZ-t)/e-(1-1/e),n=(this.m_vertexes[2*o].yZ-i)/e+(1-1/e);if(null==this.m_vertexes[2*o+1])break;var s=(this.m_vertexes[2*o+1].xZ-t)/e-(1-1/e),l=(this.m_vertexes[2*o+1].yZ-i)/e+(1-1/e),m=new Et(this.m_scene,this.m_lineWidth,r,n,s,l,this.m_linesMaterial);this.m_distances[o].line=m,this.m_distances[o].text.updateText(.5*(r+s)-0,.5*(n+l)-0,this.m_textWidthScr,bt.ALIGN_CENTER,bt.ALIGN_CENTER,this.m_textBgColor,this.m_textColor),this.m_scene.add(this.m_distances[o].text)}}},{key:"updateZoom",value:function(e){this.m_zoom=e}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"isRunning",value:function(){return this.m_runningState}},{key:"onMouseDown",value:function(e,t,i,a,o){this.m_runningState=!this.m_runningState;var r=(e+(1-1/i))*i+a,n=(t-(1-1/i))*i+o;if(this.m_runningState){this.m_xStart=e,this.m_yStart=t;var s=new Et(this.m_scene,this.m_lineWidth,e,t,e,t,this.m_linesMaterial),l=new bt("0 mm");l.updateText(e,t,this.m_textWidthScr,bt.ALIGN_CENTER,bt.ALIGN_CENTER,this.m_textBgColor,this.m_textColor),this.m_scene.add(l),this.m_distances.push({line:s,text:l}),this.m_vertexes.push({xZ:r,yZ:n})}else this.m_vertexes.push({xZ:r,yZ:n}),this.m_xStart=-1,this.m_yStart=-1}},{key:"test",value:function(){new Et(this.m_scene,this.m_lineWidth,-1,1,-.5,.5,this.m_linesMaterial)}},{key:"onMouseMove",value:function(e,t,i){if(this.m_runningState){var a=this.m_distances.pop();this.m_scene.remove(a.line.getRenderObject());var o=new Et(this.m_scene,this.m_lineWidth,this.m_xStart,this.m_yStart,e,t,this.m_linesMaterial);this.m_scene.remove(a.text);var r="".concat((i*Math.sqrt((e-this.m_xStart)*(e-this.m_xStart)*this.m_xPixelSize*this.m_xPixelSize+(t-this.m_yStart)*(t-this.m_yStart)*this.m_yPixelSize*this.m_yPixelSize)).toFixed(2)," mm"),n=new bt(r);n.updateText(.5*(e+this.m_xStart)-0,.5*(t+this.m_yStart)-0,this.m_textWidthScr,bt.ALIGN_CENTER,bt.ALIGN_CENTER,this.m_textBgColor,this.m_textColor),this.m_scene.add(n),this.m_distances.push({line:o,text:n})}}},{key:"updateVertexes",value:function(e,t,i){this.m_vertexes=[];for(var a=0;a<this.m_distances.length;++a){var o=(this.m_distances[a].line.getxS()+(1-1/e))*e+t,r=(this.m_distances[a].line.getyS()-(1-1/e))*e+i;this.m_vertexes.push({xZ:o,yZ:r}),o=(this.m_distances[a].line.getxE()+(1-1/e))*e+t,r=(this.m_distances[a].line.getyE()-(1-1/e))*e+i,this.m_vertexes.push({xZ:o,yZ:r})}}}]),e}(),wt="distance",Rt="angle",kt="area",Ot="rect",At="text",Ct="grad",It="cobr",Ft="bifi",Pt="zoom",Ut="delete",Xt="edit",zt=function(){function e(t,i,a){Object(v.a)(this,e),this.m_width=i,this.m_height=a,this.m_material=null,this.m_mesh=null,console.log("Graphics2d create size = ".concat(i," * ").concat(a)),this.m_scene=t,this.m_materialsTex2d=null,this.m_material=null,this.m_zoom=1,this.m_savePosX=0,this.m_savePosY=0,this.m_posX=0,this.m_posY=0,this.m_move=!1,this.m_wProjScreen=i,this.m_hProjScreen=a,this.m_showTileTexture=!1;var o=1/i,r=1/a;this.m_lineWidth=2*(o>r?o:r),this.m_lineWidth=.002,this.m_textTime=-1e3,this.m_text=null,this.m_toolType=wt,this.m_distanceTool=new Mt(this.m_scene,this.m_lineWidth)}return Object(p.a)(e,[{key:"set2dToolType",value:function(e){this.m_toolType=e}},{key:"onFileLoaded",value:function(){this.m_distanceTool.clearLines(),this.m_angleTool.clearLines(),this.m_areaTool.clearLines(),this.m_rectTool.clearLines(),this.m_textTool.clear(),this.m_deleteTool.clearLines(),this.m_editTool.clearLines()}},{key:"clear2DTools",value:function(){this.m_distanceTool.clearLines(),this.m_angleTool.clearLines(),this.m_areaTool.clearLines(),this.m_rectTool.clearLines(),this.m_textTool.clear(),this.m_deleteTool.clearLines(),this.m_editTool.clearLines()}},{key:"default2DTools",value:function(){this.m_zoom=1,this.m_posX=0,this.m_posY=0,this.m_savePosX=0,this.m_savePosY=0,this.m_materialsTex2d.m_uniforms.posX.value=this.m_posX,this.m_materialsTex2d.m_uniforms.posY.value=this.m_posY,this.m_materialsTex2d.m_uniforms.zoom.value=this.m_zoom,this.updateLines()}},{key:"fov2Tan",value:function(e){return Math.tan(ce.w.degToRad(.5*e))}},{key:"tan2Fov",value:function(e){return 2*ce.w.radToDeg(Math.atan(e))}},{key:"onKeyDown",value:function(e,t){}},{key:"onMouseDown",value:function(e,t){if(null!==this.m_volumeData&&null!==this.m_volumeHeader&&!(e>this.m_wProjScreen||t>this.m_hProjScreen)&&!this.m_levelSetMode){var i=2*e-1,a=2*t-1;switch(this.m_toolType){case wt:this.m_distanceTool.onMouseDown(i,a,this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;case Rt:this.m_angleTool.onMouseDown(i,a,this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;case At:this.m_textTool.onMouseDown(i,a,this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;case kt:this.m_areaTool.onMouseDown(i,a,this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;case Ot:this.m_rectTool.onMouseDown(i,a,this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;case Ct:case It:case Ft:break;case Pt:this.m_move=!0,this.m_moveTool.onMouseDown(i,a);break;case Ut:this.m_deleteTool.onMouseDown(i,a,this.m_distanceTool.m_distances,this.m_angleTool.m_angles,this.m_rectTool.m_areas,this.m_areaTool.m_distances,this.m_textTool.m_textArr,this.m_distanceTool.m_vertexes,this.m_angleTool.m_vertexes,this.m_rectTool.m_vertexes,this.m_areaTool.m_vertexes2,this.m_areaTool.m_last_lengths,this.m_areaTool.m_vertexes,this.m_areaTool,this.m_textTool.m_vertexes),console.log("".concat(this.m_areaTool.last_length));break;case Xt:this.m_editTool.onMouseDown();break;default:console.log("Unexpected 2d tool")}}}},{key:"onMouseUp",value:function(e,t){if(null!==this.m_volumeData&&null!==this.m_volumeHeader&&!(e>this.m_wProjScreen||t>this.m_hProjScreen)){var i=2*e-1,a=2*t-1;if(this.m_levelSetMode)return null!==this.m_levelSetCircle&&this.clearLevelSetCenter(),void this.drawLevelSetCenter(i,a);switch(this.m_toolType){case wt:case Rt:case kt:case Ot:case At:case It:case Ft:break;case Pt:this.m_move=!1,this.m_moveTool.onMouseUp(),this.m_savePosX=this.m_posX,this.m_savePosY=this.m_posY;break;case Ut:break;case Xt:this.m_editTool.onMouseUp();break;default:console.log("Unexpected 2d tool")}}}},{key:"onMouseMove",value:function(e,t){if(null!==this.m_volumeData&&null!==this.m_volumeHeader&&!(e>this.m_wProjScreen||t>this.m_hProjScreen)){var i=2*e-1,a=2*t-1;switch(this.m_toolType){case wt:this.m_distanceTool.onMouseMove(i,a,this.m_zoom);break;case Rt:this.m_angleTool.onMouseMove(i,a);break;case kt:this.m_areaTool.onMouseMove(i,a);break;case Ot:this.m_rectTool.onMouseMove(i,a,this.m_zoom);break;case At:case Ct:case It:case Ft:break;case Pt:this.m_move&&this.updateMove(i,a);break;case Ut:this.m_deleteTool.onMouseMove(i,a,this.m_zoom,this.m_distanceTool.m_distances,this.m_angleTool.m_angles,this.m_rectTool.m_areas,this.m_areaTool.m_distances,this.m_textTool.m_textArr);break;case Xt:this.m_editTool.onMouseMove(i,a,this.m_zoom,this.m_distanceTool.m_distances,this.m_angleTool.m_angles,this.m_rectTool.m_areas,this.m_areaTool.m_distances,this.m_areaTool,this.m_textTool,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_distanceTool.updateVertexes(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_angleTool.updateVertexes(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;default:console.log("Unexpected 2d tool")}}}},{key:"onMouseWheel",value:function(e){switch(this.m_toolType){case wt:case Rt:case kt:case Ot:case At:case It:case Ft:break;case Pt:this.m_zoomTool.onMouseWheel(e),this.updateZoom(),this.createMarkLinesAndText();break;case Ut:case Xt:break;default:console.log("Unexpected 2d tool")}}},{key:"updateLines",value:function(){this.m_distanceTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_angleTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_rectTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_textTool.updateAll(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_areaTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_deleteTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_editTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen)}},{key:"updateMove",value:function(e,t){var i=2-2*this.m_zoom,a=this.m_moveTool.onMouseMove(e,t);this.m_savePosX+a.x<=Math.abs(i)&&this.m_savePosX+a.x>0?(this.m_posX=this.m_savePosX+a.x,this.m_materialsTex2d.m_uniforms.posX.value=this.m_posX):this.m_savePosX+a.x>Math.abs(i)?(this.m_posX=Math.abs(i),this.m_materialsTex2d.m_uniforms.posX.value=this.m_posX):(this.m_posX=0,this.m_materialsTex2d.m_uniforms.posX.value=this.m_posX),this.m_savePosY+a.y>=-1*Math.abs(i)&&this.m_savePosY+a.y<0?(this.m_posY=this.m_savePosY+a.y,this.m_materialsTex2d.m_uniforms.posY.value=this.m_posY):this.m_savePosY+a.y<-1*Math.abs(i)?(this.m_posY=-1*Math.abs(i),this.m_materialsTex2d.m_uniforms.posY.value=this.m_posY):(this.m_posY=0,this.m_materialsTex2d.m_uniforms.posY.value=this.m_posY),this.updateLines()}},{key:"updateZoom",value:function(){this.m_materialsTex2d.m_uniforms.zoom.value=this.m_zoomTool.m_zoom,this.m_zoom=this.m_zoomTool.m_zoom;var e=2-2*this.m_zoom;this.m_posX>e&&(this.m_posX=e,this.m_materialsTex2d.m_uniforms.posX.value=this.m_posX),this.m_posY<-1*e&&this.m_posY<0&&(this.m_posY=-1*e,this.m_materialsTex2d.m_uniforms.posY.value=this.m_posY),this.updateLines()}},{key:"updateText",value:function(){}}],[{key:"shortenString",value:function(e){var t=e,i=e.length;if(i>20){var a=e.substring(0,6),o=e.substring(i-5,i);t="".concat(a,"...").concat(o)}return t}}]),e}(),Lt=.1,Nt=.902,Vt=.773,Bt=.5,jt=.4,Gt=.3,Wt=.0025,Ht=.0033,qt=.0025,Yt=.0029,Zt=175,Kt=function(){function e(t){var i=this;Object(v.a)(this,e),this.curFileDataType=t.curFileDataType,this.sceneReadyCounter=0,this.renderCounter=0,this.scene=new ce.J,this.sceneClipPlane=new ce.J,this.scene23D=new ce.J,this.graphics23d=null,this.sceneSphere=new ce.J,this.meshSphere=null,this.newScene=new ce.J,this.renderScene=0,this.planeGeometry=null,this.props=t,this.mesh=null,this.renderer=null,this.texTF=null,this.volTexture=null,this.origVolumeTex=null,this.texRoiId=null,this.texRoiColor=null,this.RoiVolumeTex=null,this.volTextureMask=null,this.texVolumeAO=null,this.bfTexture=null,this.ffTexture=null,this.renderToTexture=null,this.geometry=null,this.geometrySphere=null,this.geometryWireFrameSphere=null,this.matBF=null,this.matFF=null,this.matScreenTex=null,this.matWireFrame=null,this.matRenderToTexture=null,this.matVolumeRender=null,this.volumeUpdater=null,this.checkFrameBufferMode=0,this.eraserStarted=!1,this.lockEraserBuffersUpdating=!1,this.planeCenterPt=new ce.R(-.5,-.5,.7);var a=new Ie;this.context=a.createWebGLContext(),this.isWebGL2=a.useWebGL2(),this.canvas3d=a.getCanvas(),this.renderer=new ce.U({antialias:!1,canvas:this.canvas3d,preserveDrawingBuffer:!0,context:this.context}),this.renderer.autoClearStencil=!1,this.renderer.autoClearColor=!1,this.renderer||console.log("cant create 3d renderer"),this.windowWidth=Math.floor(t.width),this.windowHeight=Math.floor(t.height),console.log("Window: ".concat(this.windowWidth," x ").concat(this.windowHeight));var o=this.windowWidth/this.windowHeight;this.camera=new ce.E(60,o,.01,3),this.camera.position.z=10,this.renderer.setSize(this.windowWidth,this.windowHeight),this.renderer.setClearColor(0),t.mount.appendChild(this.renderer.domElement),this.orbitControl=new Fe(this.renderer.domElement,this.camera,this.scene,this.mesh,(function(){i.updateCutPlanes(),i.updateLightDir()})),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!0,this.RENDER_STATE={ENABLED:0,ONCE:1,DISABLED:2},this.renderState=this.RENDER_STATE.ENABLED,this.fps=0,this.isoThreshold=0,this.isEraseMode=!1,this.eraserRadius=10,this.eraserDepth=20,this.eraserSrart=!1,this.lockEraserBuffersUpdating=!1,this.eraserMouseDown=!1,this.m_eraser=null,this.isSculptingMode=!1,this.sculptingCapturedVertex=null,this.sculptingSphereCenter=new ce.R(0,0,0),this.sculptingSphereSize=1,this.vBoxVirt={x:1,y:1,z:1}}return Object(p.a)(e,[{key:"setFileDataType",value:function(e){this.curFileDataType=e}},{key:"removeSphereFromSphereScene",value:function(){null!==this.meshSphere&&this.sceneSphere.remove(this.meshSphere),this.meshSphere=null,this.geometrySphere=null}},{key:"addSphereToSphereScene",value:function(){var e=new dt,t=new ce.R(.5,.5,.5),i=e.create(t,2);if(i<1)return i;for(var a=e.getNumVertices(),o=e.getNumTriangles(),r=[],n=[],s=[],l=0;l<a;l++){var m=e.getVertex(l),h=new ce.R(m.x,m.y,m.z);r.push(m.x,m.y,m.z),h.normalize(),s.push(h.x,h.y,h.z)}for(var u=0,c=0;u<o;u++,c+=3){var d=e.getTriangle(u);n.push(d[0],d[1],d[2])}this.geometrySphere=new ce.f;var _=new Float32Array(r),f=new Float32Array(s),v=new Uint8Array(n);return this.geometrySphere.addAttribute("position",new ce.e(_,3)),this.geometrySphere.addAttribute("normal",new ce.e(f,3)),this.geometrySphere.setIndex(new ce.e(v,1)),this.computeGeometrySphereUVs(),this.meshSphere=new ce.y(this.geometrySphere),this.sceneSphere.add(this.meshSphere),this.meshSphere}},{key:"updateMeshSphere",value:function(){}},{key:"isVolumeLoaded",value:function(){return null!==this.matVolumeRender}},{key:"fov2Tan",value:function(e){return Math.tan(ce.w.degToRad(.5*e))}},{key:"tan2Fov",value:function(e){return 2*ce.w.radToDeg(Math.atan(e))}},{key:"screenshot",value:function(e,t){if(null===this.renderer)return null;var i=null;if("undefined"===typeof e)i=this.renderer.domElement.toDataURL("image/png");else{var a=this.camera.aspect,o=this.camera.fov,r=this.fov2Tan(this.camera.fov)*Math.min(this.windowWidth,this.windowHeight)/this.windowHeight,n=e/t;this.camera.aspect=n,this.camera.fov=this.tan2Fov(r/Math.min(n,1)),this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.render(),i=this.renderer.domElement.toDataURL("image/png"),this.camera.aspect=a,this.camera.fov=o,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.windowWidth,this.windowHeight),this.render()}return i}},{key:"setMaskFlag",value:function(e){this.matVolumeRender.defines.MaskFlag=e,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.MaskFlag=e,this.matRenderToTexture.needsUpdate=!0}},{key:"switchToTool23D",value:function(e){this.Tool23D=e,this.Tool23D?this.graphics23d=new zt(this.scene23D,this.windowWidth,this.windowHeight):this.graphics23d=null}},{key:"switchToVolumeRender",value:function(){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.isRoiVolume>0?(this.matVolumeRender.defines.isoRenderFlag=4,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=4,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE):(this.matVolumeRender.defines.isoRenderFlag=0,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=0,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE))}},{key:"switchToFullVolumeRender",value:function(){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.isRoiVolume>0?(this.matVolumeRender.defines.isoRenderFlag=4,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=4,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE):(this.matVolumeRender.defines.isoRenderFlag=3,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=3,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE))}},{key:"switchToIsosurfRender",value:function(){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.isRoiVolume>0?(this.matVolumeRender.defines.isoRenderFlag=5,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=5,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE,this.volumeUpdater.switchToRoiMapRender()):(this.matVolumeRender.defines.isoRenderFlag=1,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=1,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE))}},{key:"switchToFLATRender",value:function(){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.matVolumeRender.defines.isoRenderFlag=2,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=2,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE)}},{key:"setIsoThresholdValue",value:function(e){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.matRenderToTexture.uniforms.isoThreshold.value=e,this.matRenderToTexture.uniforms.isoThreshold.needsUpdate=!0,this.matVolumeRender.uniforms.isoThreshold.value=e,this.matVolumeRender.uniforms.isoThreshold.needsUpdate=!0,this.isoThreshold=e,this.renderState=this.RENDER_STATE.ONCE)}},{key:"setOpacityBarrier",value:function(e){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.matVolumeRender.uniforms.opacityBarrier.value=Zt*e,this.matVolumeRender.uniforms.opacityBarrier.needsUpdate=!0,this.matRenderToTexture.uniforms.opacityBarrier.value=Zt*e,this.matRenderToTexture.uniforms.opacityBarrier.needsUpdate=!0)}},{key:"updateBrightness",value:function(e){null!==this.matRenderToTexture&&(this.matRenderToTexture.uniforms.brightness3D.value=e,this.matRenderToTexture.uniforms.brightness3D.needsUpdate=!0),null!==this.matVolumeRender&&(this.matVolumeRender.uniforms.brightness3D.value=e,this.matVolumeRender.uniforms.brightness3D.needsUpdate=!0)}},{key:"updateContrast",value:function(e){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.matRenderToTexture.uniforms.contrast3D.value=e,this.matVolumeRender.uniforms.contrast3D.value=e,this.matRenderToTexture.uniforms.contrast3D.needsUpdate=!0,this.matVolumeRender.uniforms.contrast3D.needsUpdate=!0)}},{key:"setAmbientTextureMode",value:function(e){this.texVolumeAO&&this.texVolumeAO.dispose(),this.volumeUpdater.ambientTexture.set(this.volTexture,e),this.texVolumeAO=this.volumeUpdater.ambientTexture.get(),this.matRenderToTexture.defines.useAmbientTex=1,this.matVolumeRender.defines.useAmbientTex=1,this.matRenderToTexture.needsUpdate=!0,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.uniforms.texVolumeAO.value=this.texVolumeAO,this.matRenderToTexture.uniforms.texVolumeAO.needsUpdate=!0,this.matVolumeRender.uniforms.texVolumeAO.value=this.texVolumeAO,this.matVolumeRender.uniforms.texVolumeAO.needsUpdate=!0}},{key:"offAmbientTextureMode",value:function(){this.texVolumeAO&&this.texVolumeAO.dispose(),this.matRenderToTexture.defines.useAmbientTex=0,this.matVolumeRender.defines.useAmbientTex=0,this.matRenderToTexture.needsUpdate=!0,this.matVolumeRender.needsUpdate=!0}},{key:"updateZCutPlane",value:function(e){this.planeCenterPt.z=1.4*e,this.updateCutPlanes()}},{key:"setTransferFuncVec3",value:function(e,t){null!==this.matRenderToTexture&&(this.matRenderToTexture.uniforms.t_function1min.value=0===t?new ce.S(Lt,0,0,e[0]):new ce.S(0,.8,0,e[0]),this.matRenderToTexture.uniforms.t_function1min.needsUpdate=!0,this.matRenderToTexture.uniforms.t_function1max.value=new ce.S(1,0,0,e[1]),this.matRenderToTexture.uniforms.t_function1max.needsUpdate=!0,this.matRenderToTexture.uniforms.t_function2min.value=new ce.S(1,Nt,Vt,e[2]),this.matRenderToTexture.uniforms.t_function2min.needsUpdate=!0,this.matRenderToTexture.uniforms.t_function2max.value=new ce.S(Bt,jt,Gt,e[2]),this.matRenderToTexture.uniforms.t_function2max.needsUpdate=!0,this.matRenderToTexture.uniforms.stepSize.value=new ce.S(Wt,Ht,qt,Yt),this.matRenderToTexture.uniforms.stepSize.needsUpdate=!0,this.matVolumeRender.uniforms.t_function1min.value=0===t?new ce.S(Lt,0,0,e[0]):new ce.S(0,.8,0,e[0]),this.matVolumeRender.uniforms.t_function1min.needsUpdate=!0,this.matVolumeRender.uniforms.t_function1max.value=new ce.S(1,0,0,e[1]),this.matVolumeRender.uniforms.t_function1max.needsUpdate=!0,this.matVolumeRender.uniforms.t_function2min.value=new ce.S(1,Nt,Vt,e[2]),this.matVolumeRender.uniforms.t_function2min.needsUpdate=!0,this.matVolumeRender.uniforms.t_function2max.value=new ce.S(Bt,jt,Gt,e[2]),this.matVolumeRender.uniforms.t_function2max.needsUpdate=!0,this.matVolumeRender.uniforms.stepSize.value=new ce.S(Wt,Ht,qt,Yt),this.matVolumeRender.uniforms.stepSize.needsUpdate=!0)}},{key:"computeGeometryUVs",value:function(e,t){this.geometry.computeBoundingBox();var i=this.geometry.boundingBox.max,a=this.geometry.boundingBox.min,o=new ce.R(0-a.x,0-a.y,0-a.z),r=new ce.R(i.x-a.x,i.y-a.y,i.z-a.z);this.geo_offset1=new ce.R(0,0,0),this.geo_offset1=o,this.geo_offset2=new ce.R(0,0,0),this.geo_offset2.x=e.x+.5,this.geo_offset2.y=e.y-.5,this.geo_offset2.z=e.z-.5,this.geo_scale=new ce.R(0,0,0),this.geo_scale.x=(t.x-e.x)/r.x,this.geo_scale.y=(t.y-e.y)/r.y,this.geo_scale.z=(t.z-e.z)/r.z;for(var n=new Float32Array(3*this.geometry.getAttribute("position").count),s=0;s<this.geometry.getAttribute("position").count;s++){var l=this.geometry.getAttribute("position").getX(s),m=this.geometry.getAttribute("position").getY(s),h=this.geometry.getAttribute("position").getZ(s);n[3*s+0]=-l,n[3*s+1]=m,n[3*s+2]=h}this.geometry.addAttribute("uvw",new ce.e(n,3)),this.geometry.getAttribute("uvw").needsUpdate=!0}},{key:"computeGeometrySphereUVs",value:function(){for(var e=new Float32Array(3*this.geometrySphere.getAttribute("position").count),t=0;t<this.geometrySphere.getAttribute("position").count;t++){var i=this.geometrySphere.getAttribute("position").getX(t),a=this.geometrySphere.getAttribute("position").getY(t),o=this.geometrySphere.getAttribute("position").getZ(t);e[3*t+0]=-i/this.vBoxVirt.x,e[3*t+1]=+a/this.vBoxVirt.y,e[3*t+2]=+o/this.vBoxVirt.z}this.geometrySphere.addAttribute("uvw",new ce.e(e,3)),this.geometrySphere.getAttribute("uvw").needsUpdate=!0}},{key:"createClipPlaneGeometry",value:function(){var e=this;(new We).create(this.bfTexture,(function(t){e.planeGeometry=new ce.F(2,2);var i=new ce.y(e.planeGeometry,t);e.sceneClipPlane.add(i)}))}},{key:"updateClipPlaneGeometry",value:function(){var e=new Float32Array(3*this.planeGeometry.getAttribute("position").count),t=new ce.x;t.getInverse(this.mesh.matrix);var i=new ce.x;i.getInverse(this.camera.projectionMatrix);var a=new ce.x;a.copy(this.camera.matrixWorld);for(var o=0;o<this.planeGeometry.getAttribute("position").count;o++){var r=new ce.R;r.x=this.planeGeometry.getAttribute("position").getX(o),r.y=this.planeGeometry.getAttribute("position").getY(o),r.z=this.planeGeometry.getAttribute("position").getZ(o)+.001,r.applyMatrix4(i),r.applyMatrix4(a),r.applyMatrix4(t),e[3*o+0]=-r.x,e[3*o+1]=r.y,e[3*o+2]=r.z}this.planeGeometry.addAttribute("uvw",new ce.e(e,3)),this.planeGeometry.getAttribute("uvw").needsUpdate=!0}},{key:"getScreen2WorldTransform",value:function(){var e=new ce.x;e.getInverse(this.mesh.matrix);var t=new ce.x;t.getInverse(this.camera.projectionMatrix);var i=new ce.x;return i.copy(this.camera.matrixWorld),t.multiply(i),t.multiply(e),t}},{key:"initWithVolume",value:function(e,t,i,a,o,r){var n=this,s=t.x>t.y?t.x:t.y;s=t.z>s?t.z:s,this.vBoxVirt.x=t.x/s,this.vBoxVirt.y=t.y/s,this.vBoxVirt.z=t.z/s,this.isoThreshold=this.curFileDataType.thresholdIsosurf,this.volume=e,this.nonEmptyBoxMin=i,this.nonEmptyBoxMax=a,this.matWireFrame=null,this.removeSphereFromSphereScene();var l=new Ve;this.matWireFrame=l.create(this.bfTexture,this.ffTexture),this.addSphereToSphereScene(),this.renderScene=0,this.sceneReadyCounter=0,this.renderCounter=0;var m=null,h=null,u=null;if(this.sceneClipPlane&&(this.sceneClipPlane=new ce.J),this.scene){null!==this.mesh&&this.scene.remove(this.mesh),null!==this.geometry&&this.geometry.dispose(),this.mesh=null,this.geometry=new ce.f,this.geometry.fromGeometry(new ce.d(1,1,1)),this.computeGeometryUVs(i,a),this.geometry.scale(this.vBoxVirt.x,this.vBoxVirt.y,this.vBoxVirt.z),this.camera.position.set(0,0,1.5),this.camera.lookAt(new ce.R(0,0,0));var c=this.volume.m_xDim,d=this.volume.m_yDim,_=this.volume.m_zDim;if(console.log("3D tex size = ".concat(c," ").concat(d," ").concat(_)),this.volTexture&&this.volTexture.dispose(),this.eraserStarted=!1,this.isRoiVolume=o,this.roiPalette=null,!0===o){var f=new ie;this.roiPalette=f.getPalette256();var v=this.roiPalette[1e3],p=this.roiPalette[1001],g=this.roiPalette[1002];console.log("RoiPalette: pal[250] = ".concat(g,", ").concat(p,", ").concat(v))}if(this.volumeUpdater=new pt,this.volTexture=this.volumeUpdater.createUpdatableVolumeTex(this.volume,o,this.roiPalette),this.origVolumeTex=this.volumeUpdater.origVolumeTex,this.texTF=this.volumeUpdater.createTransferFuncTexture(),this.volTextureMask&&this.volTextureMask.dispose(),this.texVolumeAO&&this.texVolumeAO.dispose(),this.renderer.getContext().getExtension("EXT_color_buffer_float")){this.bfTexture&&this.bfTexture.dispose(),this.bfTexture=new ce.T(this.windowWidth,this.windowHeight,{minFilter:ce.u,magFilter:ce.u,format:ce.H,type:ce.p,depthBuffer:!0});this.bufferBFTextureCPU=new Float32Array(4*this.windowWidth*this.windowHeight),this.ffTexture&&this.ffTexture.dispose(),this.ffTexture=new ce.T(this.windowWidth,this.windowHeight,{minFilter:ce.u,magFilter:ce.u,format:ce.H,type:ce.p,depthBuffer:!0}),this.bufferFFTextureCPU=new Float32Array(4*this.windowWidth*this.windowHeight),this.renderfTexture&&this.renderToTexture.dispose();this.xSmallTexSize=Math.floor(this.windowWidth/3),this.ySmallTexSize=Math.floor(this.windowHeight/3),this.renderToTexture=new ce.T(this.xSmallTexSize,this.ySmallTexSize,{minFilter:ce.z,magFilter:ce.z,format:ce.H,type:ce.p,depthBuffer:!0}),this.bufferRenderToTextureCPU=new Float32Array(4*this.xSmallTexSize*this.ySmallTexSize)}else console.log("cant create float texture");this.createClipPlaneGeometry(),this.matWireFrame&&(this.matWireFrame.uniforms.texBF.value=this.bfTexture,this.matWireFrame.uniforms.texBF.needsUpdate=!0,this.matWireFrame.uniforms.texFF.value=this.ffTexture,this.matWireFrame.uniforms.texFF.needsUpdate=!0),u=new Be,this.matScreenTex=u.create(this.ffTexture),(new Xe).create((function(e){n.matBF=e,n.sceneReadyCounter++})),(m=new Ne).m_uniforms.PlaneX.value=new ce.S(-1,0,0,.5),m.m_uniforms.PlaneY.value=new ce.S(0,-1,0,.5),m.m_uniforms.PlaneZ.value=new ce.S(0,0,-1,.5),m.create(this.bfTexture.texture,(function(e){n.matFF=e,n.sceneReadyCounter++})),this.mesh=new ce.y(this.geometry),this.orbitControl.setMesh(this.mesh),this.orbitControl.setWireMesh(this.meshSphere);for(var S=[],y=0;y<64;++y){var x=2*Math.random()-1,b=2*Math.random()-1,D=-Math.random();S.push(new ce.R(x,b,D))}this.matRenderToTextureThreeGS=new Ye,this.matRenderToTextureThreeGS.m_uniforms.colorMap1D.value=this.colorMapTexture,this.matRenderToTextureThreeGS.create(this.texTF,this.volTexture,null,this.texVolumeAO,this.bfTexture.texture,this.ffTexture.texture,S,(function(e){e.uniforms.t_function1min.value=new ce.S(Lt,0,0,n.curFileDataType.thresholdTissue1),e.uniforms.t_function1max.value=new ce.S(1,0,0,n.curFileDataType.thresholdTissue2),e.uniforms.t_function2min.value=new ce.S(1,Nt,Vt,n.curFileDataType.thresholdIsosurf),e.uniforms.t_function2max.value=new ce.S(Bt,jt,Gt,n.curFileDataType.thresholdIsosurf),e.uniforms.stepSize.value=new ce.S(Wt,Ht,qt,Yt),e.uniforms.texSize.value=c,e.uniforms.isoThreshold.value=n.curFileDataType.thresholdIsosurf,e.uniforms.brightness3D.value=n.curFileDataType.brightness,e.uniforms.opacityBarrier.value=Zt*n.curFileDataType.opacityTissue,e.uniforms.volumeSizeZ.value=_,e.uniforms.xDim.value=c,e.uniforms.yDim.value=d,e.uniforms.lightDir.value=new ce.R(n.curFileDataType.lightDirComp,n.curFileDataType.lightDirComp,n.curFileDataType.lightDirComp),e.uniforms.needsUpdate=!0,n.matRenderToTexture=e,n.sceneReadyCounter++}));(h=new Qe).m_uniforms.isoSurfTexel.value=new ce.Q(3/this.windowWidth,3/this.windowHeight),h.create(this.renderToTexture.texture,(function(e){e.uniforms.needsUpdate=!0,n.sceneReadyCounter++})),this.matSkullThreeGS=new et,this.matSkullThreeGS.m_uniforms.isoSurfTexel.value=new ce.Q(3/this.windowWidth,3/this.windowHeight),this.matSkullThreeGS.m_uniforms.colorMap1D.value=this.colorMapTexture,this.matSkullThreeGS.create(this.texTF,this.volTexture,null,this.texVolumeAO,this.bfTexture.texture,this.ffTexture.texture,this.renderToTexture.texture,S,(function(e){e.uniforms.t_function1min.value=new ce.S(Lt,0,0,n.curFileDataType.thresholdTissue1),e.uniforms.t_function1max.value=new ce.S(1,0,0,n.curFileDataType.thresholdTissue2),e.uniforms.t_function2min.value=new ce.S(1,Nt,Vt,n.curFileDataType.thresholdIsosurf),e.uniforms.t_function2max.value=new ce.S(Bt,jt,Gt,n.curFileDataType.thresholdIsosurf),e.uniforms.stepSize.value=new ce.S(Wt,Ht,qt,Yt),e.uniforms.texSize.value=c,e.uniforms.isoThreshold.value=n.curFileDataType.thresholdIsosurf,e.uniforms.brightness3D.value=n.curFileDataType.brightness,e.uniforms.volumeSizeZ.value=_,e.uniforms.xDim.value=c,e.uniforms.yDim.value=d,e.uniforms.opacityBarrier.value=Zt*n.curFileDataType.opacityTissue,e.uniforms.lightDir.value=new ce.R(n.curFileDataType.lightDirComp,n.curFileDataType.lightDirComp,n.curFileDataType.lightDirComp),e.uniforms.needsUpdate=!0,n.scene.add(n.mesh),n.matVolumeRender=e,r?n.switchToFullVolumeRender():n.switchToVolumeRender(),n.mesh.material=n.matVolumeRender,n.meshSphere.material=n.matVolumeRender,n.sceneReadyCounter++}))}}},{key:"setTransferFuncColors",value:function(e){this.volumeUpdater.setTransferFuncColors(e)}},{key:"updateTransferFuncTexture",value:function(e,t){return this.volumeUpdater.updateTransferFuncTexture(e,t)}},{key:"updateSelectedRoiMap",value:function(e){this.volumeUpdater.updateSelectedRoiMap(e)}},{key:"updateCutPlanes",value:function(){if(this.mesh){var e=new ce.x;1===this.renderScene?e.getInverse(e.extractRotation(this.meshSphere.matrix)):e.getInverse(e.extractRotation(this.mesh.matrix));var t=new ce.R(-1,0,0),i=new ce.R(0,-1,0),a=new ce.R(0,0,-1),o=(new ce.R).copy(this.planeCenterPt);o.applyMatrix4(e),t.applyMatrix4(e),i.applyMatrix4(e),a.applyMatrix4(e),null!==this.matFF&&(this.matFF.uniforms.PlaneX.value.x=t.x,this.matFF.uniforms.PlaneX.value.y=t.y,this.matFF.uniforms.PlaneX.value.z=t.z,this.matFF.uniforms.PlaneX.value.w=-o.dot(t),this.matFF.uniforms.PlaneY.value.x=i.x,this.matFF.uniforms.PlaneY.value.y=i.y,this.matFF.uniforms.PlaneY.value.z=i.z,this.matFF.uniforms.PlaneY.value.w=-o.dot(i),this.matFF.uniforms.PlaneZ.value.x=-a.x,this.matFF.uniforms.PlaneZ.value.y=a.y,this.matFF.uniforms.PlaneZ.value.z=a.z,this.matFF.uniforms.PlaneZ.value.w=-o.dot(a))}}},{key:"updateLightDir",value:function(){if(this.mesh){var e=new ce.x;0===this.renderScene?e.getInverse(e.extractRotation(this.mesh.matrix)):e.getInverse(e.extractRotation(this.meshSphere.matrix));var t=new ce.R(1,1,1);t.normalize(),t.applyMatrix4(e),t.x=-t.x,this.matRenderToTexture.uniforms.lightDir.value=t,this.matRenderToTexture.uniforms.lightDir.needsUpdate=!0,this.matVolumeRender.uniforms.lightDir.value=t,this.matVolumeRender.uniforms.lightDir.needsUpdate=!0}else console.log("UpdateLightDir call mesh is not created")}},{key:"isReadyToRender",value:function(){return 5===this.sceneReadyCounter&&!(null===this.matVolumeRender||null===this.matBF||null===this.matFF||null===this.matRenderToTexture)}},{key:"render",value:function(){if(this.isReadyToRender())if(null!==this.matVolumeRender&&null!==this.matBF&&null!==this.matFF&&null!==this.matRenderToTexture){if(0===this.checkFrameBufferMode&&(this.checkFrameBufferMode=1),0===this.renderScene){this.updateLightDir(),this.updateClipPlaneGeometry(),this.updateCutPlanes(),this.renderer.setRenderTarget(this.bfTexture),this.renderer.clear(),this.renderer.state.buffers.depth.setClear(0),this.scene.overrideMaterial=this.matBF,this.renderer.render(this.scene,this.camera,this.bfTexture);var e=this.renderer.getContext();this.isEraseMode&&!this.lockEraserBuffersUpdating&&e.readPixels(0,0,this.windowWidth,this.windowHeight,e.RGBA,e.FLOAT,this.bufferBFTextureCPU),this.renderer.setRenderTarget(this.ffTexture),this.renderer.clear(),this.renderer.state.buffers.depth.setClear(1),this.renderer.render(this.sceneClipPlane,this.camera,this.ffTexture),this.scene.overrideMaterial=this.matFF,this.renderer.render(this.scene,this.camera,this.ffTexture),this.isEraseMode&&!this.lockEraserBuffersUpdating&&e.readPixels(0,0,this.windowWidth,this.windowHeight,e.RGBA,e.FLOAT,this.bufferFFTextureCPU),this.renderer.setRenderTarget(),this.renderer.clear(),this.renderer.state.buffers.depth.setClear(0),this.scene.overrideMaterial=this.matRenderToTexture,this.renderer.render(this.scene,this.camera,this.renderToTexture),this.isEraseMode&&!this.lockEraserBuffersUpdating&&e.readPixels(0,0,this.xSmallTexSize,this.ySmallTexSize,e.RGBA,e.FLOAT,this.bufferRenderToTextureCPU),this.scene.overrideMaterial=null,this.renderer.render(this.scene,this.camera),this.renderer.autoClearDepth=!1,this.Tool23D&&this.renderer.render(this.scene23D,this.camera),this.renderer.autoClearDepth=!0}this.renderCounter++}else;}},{key:"setStepsize",value:function(e){var t=1/(100+700*e);null!==this.matRenderToTexture&&(this.matRenderToTexture.uniforms.stepSize.value=new ce.S(t,t,t,t),this.matRenderToTexture.uniforms.needsUpdate=!0),null!==this.matVolumeRender&&(this.matVolumeRender.uniforms.stepSize.value=new ce.S(t,t,t,t),this.matVolumeRender.uniforms.needsUpdate=!0)}},{key:"getVertexProjectionToScreen",value:function(e,t){var i=e.clone();i.applyMatrix4(this.meshSphere.matrixWorld),i.project(this.camera);var a=.5*this.windowWidth,o=.5*this.windowHeight,r=a+a*i.x,n=o+o*i.y;t.x=r,t.y=n;var s=e.clone();return s.applyMatrix4(this.meshSphere.matrixWorld),s.applyMatrix3(this.camera.normalMatrix),s.z}},{key:"setEraserMode",value:function(e){if(this.isEraseMode=e,this.orbitControl.setEraserMode(e),!this.eraserStarted&&e){this.eraserStarted=!0;var t={xDim:this.volume.m_xDim,yDim:this.volume.m_yDim,zDim:this.volume.m_zDim,bufBF:this.bufferBFTextureCPU,bufFF:this.bufferFFTextureCPU,bufTex:this.bufferRenderToTextureCPU};this.volTextureMask=this.volumeUpdater.createUpdatableVolumeMask(t),this.matSkullThreeGS.m_uniforms.texVolumeMask.value=this.volTextureMask,this.matRenderToTextureThreeGS.m_uniforms.texVolumeMask.value=this.volTextureMask}e?this.setMaskFlag(1):this.setMaskFlag(0)}},{key:"undoEraser",value:function(){this.volumeUpdater.eraser.undoLastErasing()}},{key:"setEraserStart",value:function(e){this.eraserStart=e}},{key:"onMouseDown",value:function(e,t){this.Tool23D?this.graphics23d.onMouseDown(e/this.windowWidth,t/this.windowHeight):(this.orbitControl.onMouseDown(e,t),1===this.checkFrameBufferMode&&(this.renderState=this.RENDER_STATE.ENABLED,this.eraserMouseDown=!0,this.isEraseMode&&this.eraserStart&&(this.lockEraserBuffersUpdating=!0,this.volumeUpdater.eraser.eraseStart(e,t,this.windowWidth,this.matVolumeRender.uniforms.isoThreshold.value,!0))))}},{key:"onMouseMove",value:function(e,t){this.Tool23D?this.graphics23d.onMouseMove(e/this.windowWidth,t/this.windowHeight):1===this.checkFrameBufferMode&&(this.renderState=this.RENDER_STATE.ENABLED,this.isEraseMode&&this.eraserMouseDown&&this.eraserStart?this.volumeUpdater.eraser.eraseStart(e,t,this.windowWidth,this.matVolumeRender.uniforms.isoThreshold.value,!1):this.orbitControl.onMouseMove(e,t))}},{key:"onMouseUp",value:function(e,t){this.Tool23D?this.graphics23d.onMouseUp(e/this.windowWidth,t/this.windowHeight):(this.orbitControl.onMouseUp(),1===this.checkFrameBufferMode&&(this.lockEraserBuffersUpdating=!1,this.eraserMouseDown=!1,this.renderState=this.RENDER_STATE.ONCE))}},{key:"onMouseWheel",value:function(e){var t=Math.max(-1,Math.min(1,e.deltaY||-e.detail));this.orbitControl.onZoom(-t),1===this.checkFrameBufferMode&&(this.renderState=this.RENDER_STATE.ONCE)}}]),e}(),Qt=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onMode=a.onMode.bind(Object(y.a)(a)),a.isLoaded=!1,a.volume=null,a.start=a.start.bind(Object(y.a)(a)),a.stop=a.stop.bind(Object(y.a)(a)),a.animate=a.animate.bind(Object(y.a)(a)),a.renderScene=a.renderScene.bind(Object(y.a)(a)),a.setVolRenderToStore=a.setVolRenderToStore.bind(Object(y.a)(a)),a.onKeyDown=a.onKeyDown.bind(Object(y.a)(a)),a.onKeyUp=a.onKeyUp.bind(Object(y.a)(a)),a.m_mount=null,a.m_volumeRenderer3D=null,a.m_distanceTool=null,a.m_renderer=null,a.m_frameId=null,a.m_prevMode=c.RAYCAST,a.m_fileDataType={thresholdIsosurf:.46,thresholdTissue1:.09,thresholdTissue2:.3,opacityTissue:.53,startRotX:.5*-Math.PI,startRotY:Math.PI,lightDirComp:-.5773,brightness:.56},a.state={wRender:0,hRender:0},a}return Object(p.a)(i,[{key:"setVolRenderToStore",value:function(e){var t=this.props;t.dispatch({type:m.SET_VOLUME_Renderer,volumeRenderer:e}),t.dispatch({type:m.SET_SLIDER_3DR,slider3d_r:Number.parseFloat(.09)}),t.dispatch({type:m.SET_SLIDER_3DG,slider3d_g:Number.parseFloat(.3)}),t.dispatch({type:m.SET_SLIDER_3DB,slider3d_b:Number.parseFloat(.46)}),t.dispatch({type:m.SET_SLIDER_Opacity,sliderOpacity:Number.parseFloat(.53)}),t.dispatch({type:m.SET_SLIDER_Isosurface,sliderIsosurface:Number.parseFloat(.46)}),t.dispatch({type:m.SET_SLIDER_Brightness,sliderBrightness:Number.parseFloat(.56)}),t.dispatch({type:m.SET_SLIDER_Cut,sliderCut:Number.parseFloat(1)}),t.dispatch({type:m.SET_SLIDER_Quality,sliderQuality:Number.parseFloat(.35)})}},{key:"start",value:function(){null===this.m_frameId&&(this.m_frameId=requestAnimationFrame(this.animate))}},{key:"stop",value:function(){cancelAnimationFrame(this.m_frameId),this.m_frameId=null}},{key:"animate",value:function(){this.renderScene(),this.m_frameId=window.requestAnimationFrame(this.animate)}},{key:"renderScene",value:function(){null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.render()}},{key:"onMode",value:function(e){this.props.dispatch({type:m.SET_MODE_3D,mode3d:e})}},{key:"componentDidMount",value:function(){var e=this.m_mount.clientWidth>0?this.m_mount.clientWidth:200,t=this.m_mount.clientHeight>0?this.m_mount.clientHeight:200;if(0===this.state.wRender&&(this.setState({wRender:e}),this.setState({hRender:t})),null===this.m_volumeRenderer3D&&(this.m_volumeRenderer3D=new Kt({curFileDataType:this.m_fileDataType,width:e,height:t,mount:this.m_mount})),this.setVolRenderToStore(this.m_volumeRenderer3D),null!==this.volume&&!1===this.isLoaded&&null!==this.m_volumeRenderer3D){var i=this.props,a=i.volumeSet,o=i.volumeIndex,r=4===a.getVolume(o).m_bytesPerVoxel;i.modeView===h.VIEW_3D?this.m_volumeRenderer3D.initWithVolume(this.volume,this.volume.m_boxSize,{x:0,y:0,z:0},{x:1,y:1,z:1},r,!0):this.m_volumeRenderer3D.initWithVolume(this.volume,this.volume.m_boxSize,{x:0,y:0,z:0},{x:1,y:1,z:1},r,!1),this.isLoaded=!0}this.start(),this.m_mount.focus()}},{key:"componentWillUnmount",value:function(){this.stop(),null!==this.m_renderer&&this.m_mount.removeChild(this.m_renderer.domElement),this.m_volumeRenderer3D=null}},{key:"_onMouseMove",value:function(e){if(null!==this.m_volumeRenderer3D){var t=this.m_mount.getBoundingClientRect(),i=e.clientX-t.left,a=e.clientY-t.top;this.m_volumeRenderer3D.onMouseMove(i,-(this.state.hRender-a),this.props.ereaseStart)}}},{key:"_onMouseDown",value:function(e){if(null!==this.m_volumeRenderer3D){var t=this.m_mount.getBoundingClientRect(),i=e.clientX-t.left,a=e.clientY-t.top;this.m_volumeRenderer3D.onMouseDown(i,-(this.state.hRender-a),this.props.ereaseStart)}}},{key:"_onMouseUp",value:function(){null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.onMouseUp()}},{key:"_onWheel",value:function(e){null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.onMouseWheel(e)}},{key:"onClick",value:function(e){e.stopPropagation()}},{key:"onTouchStart",value:function(e){if(void 0!==this.m_mount&&null!==this.m_mount){var t=e.changedTouches,i=t.length;if(i>=2&&console.log("onTouchStart. numTouches == 2"),i>=1){var a=this.m_mount.getBoundingClientRect(),o=t[i-1].pageX-a.left,r=t[i-1].pageY-a.top;null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.onMouseDown(o,this.state.hRender-r,this.props.ereaseStart)}}}},{key:"onTouchMove",value:function(e){if(void 0!==this.m_mount&&null!==this.m_mount){var t=e.changedTouches,i=t.length;if(i>=2&&console.log("onTouchStart. numTouches == 2"),i>=1){var a=this.m_mount.getBoundingClientRect(),o=t[i-1].pageX-a.left,r=t[i-1].pageY-a.top;null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.onMouseMove(o,this.state.hRender-r,this.props.ereaseStart)}}}},{key:"onTouchEnd",value:function(){null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.onMouseUp()}},{key:"onKeyDown",value:function(e){"Control"===e.key&&(console.log("Ctrl key was pressed"),this.props.volumeRenderer.setEraserStart(!0))}},{key:"onKeyUp",value:function(e){"Control"===e.key&&(console.log("Ctrl key was released"),this.props.volumeRenderer.setEraserStart(!1))}},{key:"render",value:function(){var e=this,t=this.props,i=null,a=t.volumeSet;if(a.getNumVolumes()>0){var r=t.volumeIndex;i=a.getVolume(r)}null!==i&&(this.volume=i);var n=t.mode3d,s=t.modeView;null!==this.m_volumeRenderer3D&&(this.m_volumeRenderer3D.switchToTool23D(t.isTool3D),s!==h.VIEW_3D?(n===c.RAYCAST&&(this.m_prevMode=c.RAYCAST,this.m_volumeRenderer3D.setTransferFuncVec3([t.slider3d_r,t.slider3d_g,t.slider3d_b],0),this.m_volumeRenderer3D.switchToVolumeRender()),n===c.ISO&&(this.m_prevMode=c.ISO,this.m_volumeRenderer3D.switchToIsosurfRender(),this.m_volumeRenderer3D.setIsoThresholdValue(t.sliderIsosurface)),n===c.RAYFAST&&(this.m_prevMode=c.RAYFAST,this.m_volumeRenderer3D.switchToFLATRender()),n===c.EREASER&&(this.m_prevMode=c.RAYFAST,this.m_volumeRenderer3D.switchToIsosurfRender(),this.m_volumeRenderer3D.setIsoThresholdValue(t.sliderIsosurface),this.m_volumeRenderer3D.volumeUpdater.eraser.setEraserRadius(t.sliderErRadius),this.m_volumeRenderer3D.volumeUpdater.eraser.setEraserDepth(t.sliderErDepth))):this.m_volumeRenderer3D.switchToFullVolumeRender(),this.m_volumeRenderer3D.setOpacityBarrier(t.sliderOpacity),this.m_volumeRenderer3D.updateBrightness(t.sliderBrightness),this.m_volumeRenderer3D.updateZCutPlane(t.sliderCut-.5),this.m_volumeRenderer3D.setStepsize(t.sliderQuality),this.m_volumeRenderer3D.updateContrast(t.sliderContrast3D)),null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.render();var l=o.a.createElement("div",{style:{width:"100%",height:"100%"},ref:function(t){e.m_mount=t},onMouseMove:this._onMouseMove.bind(this),onMouseDown:this._onMouseDown.bind(this),onMouseUp:this._onMouseUp.bind(this),onTouchStart:this.onTouchStart.bind(this),onTouchEnd:this.onTouchEnd.bind(this),onTouchMove:this.onTouchMove.bind(this),onClick:this.onClick.bind(this),onWheel:this._onWheel.bind(this)}),m=o.a.createElement("div",{width:this.state.wRender,height:this.state.hRender,ref:function(t){e.m_mount=t},onMouseMove:this._onMouseMove.bind(this),onMouseDown:this._onMouseDown.bind(this),onMouseUp:this._onMouseUp.bind(this),onTouchStart:this.onTouchStart.bind(this),onTouchEnd:this.onTouchEnd.bind(this),onTouchMove:this.onTouchMove.bind(this),onClick:this.onClick.bind(this),tabIndex:"1",onKeyDown:function(t){return e.onKeyDown(t)},onKeyUp:function(t){return e.onKeyUp(t)},onWheel:this._onWheel.bind(this)});return this.state.wRender>0?m:l}}]),i}(o.a.Component),Jt=Object(s.b)((function(e){return e}))(Qt),$t=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).m_updateEnable=!0,a}return Object(p.a)(i,[{key:"onChangeSliderBrightness",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderBrightness.slider.get();this.props.dispatch({type:m.SET_SLIDER_Brightness,sliderBrightness:Number.parseFloat(e)})}},{key:"onChangeSliderCut",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderCut.slider.get();this.props.dispatch({type:m.SET_SLIDER_Cut,sliderCut:Number.parseFloat(e)})}},{key:"onChangeSliderQuality",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderQuality.slider.get();this.props.dispatch({type:m.SET_SLIDER_Quality,sliderQuality:Number.parseFloat(e)})}},{key:"onChangeSliderContrast3D",value:function(){this.m_updateEnable=!1;var e=this.refs.sliderContrast3D.slider.get();this.props.dispatch({type:m.SET_SLIDER_Contrast3D,sliderContrast3D:Number.parseFloat(e)})}},{key:"shouldComponentUpdate",value:function(e){var t=this.m_updateEnable;return this.props.isTool3D===e.isTool3D&&this.props.modeView===e.modeView||(t=!0),t}},{key:"render",value:function(){var e=this.props,t=e.modeView,i=[e.sliderBrightness],a=[e.sliderCut],r=[e.sliderQuality],n=o.a.createElement(Oe,null),s=o.a.createElement(Ce,null),l=new Array(h.VIEW_COUNT);l[h.VIEW_3D_LIGHT]=n,l[h.VIEW_3D]=s;var m=l[t],u=o.a.createElement(he.a,{as:"ul",variant:"flush"},o.a.createElement(he.a.Item,null,o.a.createElement("p",null," Brightness "),o.a.createElement(P.a,{onSlide:this.onChangeSliderBrightness.bind(this),ref:"sliderBrightness",range:{min:0,max:1},"overflow-scroll":"true",start:i,connect:[!1,!1],step:.02,tooltips:!0})),o.a.createElement(he.a.Item,null,o.a.createElement("p",null," Quality "),o.a.createElement(P.a,{onSlide:this.onChangeSliderQuality.bind(this),ref:"sliderQuality",range:{min:0,max:1},"overflow-scroll":"true",start:r,connect:[!1,!1],step:.02,tooltips:!0}))),c=o.a.createElement(he.a,{as:"ul",variant:"flush"},o.a.createElement(he.a.Item,null,o.a.createElement("p",null," Cut plane opacity "),o.a.createElement(P.a,{onSlide:this.onChangeSliderContrast3D.bind(this),ref:"sliderContrast3D",range:{min:0,max:1},"overflow-scroll":"true",start:i,connect:[!1,!1],step:.02,tooltips:!0})),o.a.createElement(ne,null)),d={minHeight:882..toString()+"px"};return o.a.createElement(x.a,null,o.a.createElement(b.a,{xs:12,sm:!0,md:!0,lg:4},m,o.a.createElement(he.a.Item,{as:"ul",variant:"flush"},o.a.createElement("p",null," Cut "),o.a.createElement(P.a,{onSlide:this.onChangeSliderCut.bind(this),ref:"sliderCut",range:{min:0,max:1},"overflow-scroll":"true",start:a,connect:[!1,!1],step:.01,tooltips:!0})),!1===e.isTool3D?u:c),o.a.createElement(b.a,{xs:12,sm:!0,md:!0,lg:8,style:d},o.a.createElement(Jt,null)))}}]),i}(o.a.Component),ei=Object(s.b)((function(e){return e}))($t),ti=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(){return Object(v.a)(this,i),t.apply(this,arguments)}return Object(p.a)(i,[{key:"render",value:function(){var e=this.props.modeView,t=o.a.createElement(R,null),i=o.a.createElement(ye,null),a=o.a.createElement(ei,null),r=new Array(h.VIEW_COUNT);return r[h.VIEW_MPR]=t,r[h.VIEW_2D]=i,r[h.VIEW_3D_LIGHT]=a,r[h.VIEW_3D]=a,r[e]}}]),i}(o.a.Component),ii=Object(s.b)((function(e){return e}))(ti),ai=i(205),oi=i(203),ri=i(199),ni=i(132),si=i(135),li=i.n(si),mi=i(136),hi=i.n(mi),ui=function(){function e(){Object(v.a)(this,e)}return Object(p.a)(e,null,[{key:"getResultString",value:function(t){switch(t){case e.SUCCESS:return"Success";case e.UNKNOWN:return"Unknown";case e.BAD_DICOM:return"Bad Dicom";case e.BAD_HEADER:return"Bad header";case e.UNSUPPORTED_ENDIANNESS:return"Unsupported endianness";case e.UNSUPPORTED_COLOR_FORMAT:return"Unsupported color format";case e.WRONG_HEADER_DATA_SIZE:return"Wrong header data size";case e.WRONG_HEADER_DIMENSIONS:return"Wrong header dimensions";case e.WRONG_HEADER_DATA_TYPE:return"Wrong header data type";case e.WRONG_HEADER_BITS_PER_PIXEL:return"Wrong header bits per pixel";case e.WRONG_HEADER_MAGIC:return"Wrong header magic";case e.ERROR_PROCESS_HISTOGRAM:return"Wrong histogram";case e.WRONG_IMAGE_DIM_X:return"Wrong image dim x";case e.WRONG_IMAGE_DIM_Y:return"Wrong image dim y";case e.WRONG_IMAGE_DIM_Z:return"Wrong image dim z";case e.ERROR_PIXELS_TAG_NOT_FOUND:return"Pixels tag is not found";case e.ERROR_NO_MEMORY:return"No memory during loading";case e.ERROR_CANT_OPEN_URL:return"Cant open file via url";case e.ERROR_WRONG_NUM_SLICES:return"Wrong number of slices";case e.ERROR_HISTOGRAM_DETECT_RIDGES:return"Error detect histogram ridges";case e.ERROR_SCALING:return"Error scaling 16 bit data into 8 bit";case e.ERROR_INVALID_SLICE_INDEX:return"Invalid slice index. Possible reason: incomplete dicom folder";case e.ERROR_TOO_SMALL_DATA_SIZE:return"Too small input data size";case e.ERROR_TOO_LARGE_DATA_SIZE:return"Too large input data size";case e.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED:return"Compressed image formats read is not supported";default:return"Unknown error code"}}}]),e}();ui.SUCCESS=0,ui.UNKNOWN=1,ui.BAD_DICOM=2,ui.BAD_HEADER=3,ui.UNSUPPORTED_ENDIANNESS=4,ui.UNSUPPORTED_COLOR_FORMAT=5,ui.WRONG_HEADER_DATA_SIZE=6,ui.WRONG_HEADER_DIMENSIONS=7,ui.WRONG_HEADER_DATA_TYPE=8,ui.WRONG_HEADER_BITS_PER_PIXEL=9,ui.WRONG_HEADER_MAGIC=10,ui.ERROR_PROCESS_HISTOGRAM=11,ui.WRONG_IMAGE_DIM_X=12,ui.WRONG_IMAGE_DIM_Y=13,ui.ERROR_PIXELS_TAG_NOT_FOUND=14,ui.ERROR_NO_MEMORY=15,ui.ERROR_CANT_OPEN_URL=16,ui.ERROR_WRONG_NUM_SLICES=17,ui.ERROR_HISTOGRAM_DETECT_RIDGES=18,ui.ERROR_SCALING=19,ui.ERROR_INVALID_SLICE_INDEX=20,ui.ERROR_TOO_SMALL_DATA_SIZE=21,ui.ERROR_TOO_LARGE_DATA_SIZE=22,ui.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED=23;var ci=null,di=function(){function e(t){Object(v.a)(this,e),ci||(ci=this),this.m_url=t,this.m_request=null,this.readFile=this.readFile.bind(this)}return Object(p.a)(e,[{key:"readFile",value:function(e,t){var i=this;if(this.m_request=new XMLHttpRequest,this.m_request||console.log("Cant create object request"),!("withCredentials"in this.m_request))return this.m_request=null,void console.log("This browser cant support CORS requests");this.m_request.open("GET",this.m_url,!0),this.m_request.responseType="arraybuffer",this.m_request.addEventListener("load",(function(t){var i=t.target.response;if(null===i)console.log("Bad response type. Expect object type in response.");else if(e){var a=new TextDecoder("utf-8"),o=i.byteLength;o>4e3&&(o=4e3);var r=i.slice(0,o),n=a.decode(r);"<!DOCTYPE"===n.substr(0,9)&&console.log("Error load data from URL. Read result is "+n),e(i)}}),!1),this.m_request.addEventListener("error",(function(){var e="Error accessing file ".concat(i.m_url);t(e)}),!1),this.m_request.send();if(404===this.m_request.status){var a="Cant access url =  ".concat(this.m_url);t(a)}}}]),e}(),_i=6403,fi=6407,vi=6408,pi=function(){function e(){Object(v.a)(this,e),this.m_header={m_id:"",m_endianness:0,m_glType:0,m_glTypeSize:0,m_glFormat:0,m_glInternalFormat:0,m_glBaseInternalFormat:0,m_pixelWidth:0,m_pixelHeight:0,m_pixelDepth:0,m_numberOfArrayElements:0,m_numberOfFaces:0,m_numberOfMipmapLevels:0,m_bytesOfKeyValueData:0},this.m_boxSize={x:0,y:0,z:0}}return Object(p.a)(e,[{key:"readFromBuffer",value:function(t,i,a,o){var r=new Uint8Array(i),n=0;if(void 0!==a&&a(0),0===r.length)return void 0!==o&&o(ui.BAD_HEADER),ui.BAD_HEADER;var s,l=[171,75,84,88,32,49,49,187,13,10,26,10],m=l.length,h=!0;for(s=0;s<m;s++){if(r[n]!==l[s]){h=!1;break}this.m_header.m_id+=String.fromCharCode(r[n]),n+=1}if(!h)return console.log("KTX HEADER IS WRONG"),void 0!==o&&o(ui.BAD_HEADER),ui.BAD_HEADER;var u=67305985;if(this.m_header.m_endianness=e.readInt(r,n),n+=4,this.m_header.m_endianness!==u){var c=this.m_header.m_endianness.toString(16);return console.log("ENDIANNESS IS WRONG. Found = ".concat(c," , but should be = ").concat(u.toString(16))),void 0!==o&&o(ui.UNSUPPORTED_ENDIANNESS),ui.UNSUPPORTED_ENDIANNESS}if(this.m_header.m_glType=e.readInt(r,n),n+=4,this.m_header.m_glTypeSize=e.readInt(r,n),n+=4,this.m_header.m_glFormat=e.readInt(r,n),n+=4,this.m_header.m_glFormat!==_i&&this.m_header.m_glFormat!==fi&&this.m_header.m_glFormat!==vi)return console.log("KTX header.m_glFormat is WRONG"),void 0!==o&&o(ui.UNSUPPORTED_COLOR_FORMAT),ui.UNSUPPORTED_COLOR_FORMAT;this.m_header.m_glInternalFormat=e.readInt(r,n),n+=4,this.m_header.m_glBaseInternalFormat=e.readInt(r,n),n+=4,this.m_header.m_pixelWidth=e.readInt(r,n),n+=4,this.m_header.m_pixelHeight=e.readInt(r,n),n+=4,this.m_header.m_pixelDepth=e.readInt(r,n),n+=4,t.m_xDim=this.m_header.m_pixelWidth,t.m_yDim=this.m_header.m_pixelHeight,t.m_zDim=this.m_header.m_pixelDepth;var d=this.m_header,_=8192;if(d.m_pixelWidth<4||d.m_pixelHeight<4||d.m_pixelDepth<4)return console.log("KTX dims too small: ".concat(d.m_pixelWidth," * ").concat(d.m_pixelHeight," * ").concat(d.m_pixelDepth)),void 0!==o&&o(ui.WRONG_IMAGE_DIM_X),ui.WRONG_IMAGE_DIM_X;if(d.m_pixelWidth>_||d.m_pixelHeight>_||d.m_pixelDepth>_)return console.log("KTX dims too large: ".concat(d.m_pixelWidth," * ").concat(d.m_pixelHeight," * ").concat(d.m_pixelDepth)),void 0!==o&&o(ui.WRONG_IMAGE_DIM_X),ui.WRONG_IMAGE_DIM_X;this.m_header.m_numberOfArrayElements=e.readInt(r,n),n+=4,this.m_header.m_numberOfFaces=e.readInt(r,n),n+=4,this.m_header.m_numberOfMipmapLevels=e.readInt(r,n),n+=4,this.m_header.m_bytesOfKeyValueData=e.readInt(r,n),n+=4;var f=0;if(this.m_header.m_glFormat===_i?f=1:this.m_header.m_glFormat===fi?f=3:this.m_header.m_glFormat===vi&&(f=4),this.m_header.m_bytesOfKeyValueData>0){var v,p,g,S,y,x,b=n;for(n+=this.m_header.m_bytesOfKeyValueData;b<n;){var D="",T=void 0;for(T=r[b+=4];0!==T;b++)0!==(T=r[b])&&(D=D.concat(String.fromCharCode(T)));if(console.log("UDataString = ".concat(D)),"fBoxMin"===D)v=e.readFloat(r,b),b+=4,p=e.readFloat(r,b),b+=4,g=e.readFloat(r,b),b+=4,console.log("vBoxMix = ".concat(v," * ").concat(p," * ").concat(g));else if("fBoxMax"===D){S=e.readFloat(r,b),b+=4,y=e.readFloat(r,b),b+=4,x=e.readFloat(r,b),b+=4,this.m_boxSize.x=S-v,this.m_boxSize.y=y-p,this.m_boxSize.z=x-g,console.log("vBox = ".concat(this.m_boxSize.x," * ").concat(this.m_boxSize.y," * ").concat(this.m_boxSize.z));break}}}this.m_dataSize=e.readInt(r,n),n+=4;var E,M=this.m_header.m_pixelWidth*this.m_header.m_pixelHeight*this.m_header.m_pixelDepth*f;if(this.m_dataSize!==M)return console.log("!!! not implemented yet"),void 0!==o&&o(ui.WRONG_HEADER_DATA_SIZE),ui.WRONG_HEADER_DATA_SIZE;this.m_dataArray=new Uint8Array(this.m_dataSize);var w=!1;for(E=29;E>=0&&!w;E--){1<<E<this.m_dataSize&&(w=!0)}E++;(E-=3)<=0&&(E=1);for(var R=(1<<E)-1,k=0;k<this.m_dataSize;k++){if(this.m_dataArray[k]=r[n],n+=1,void 0!==a&&0===(k&R)&&k>0)a(k/this.m_dataSize)}if(0===this.m_boxSize.x){var O=.3;this.m_boxSize.x=O*this.m_header.m_pixelWidth,this.m_boxSize.x=O*this.m_header.m_pixelWidth,this.m_boxSize.y=O*this.m_header.m_pixelHeight,this.m_boxSize.z=O*this.m_header.m_pixelDepth,console.log("vBox = ".concat(this.m_boxSize.x," * ").concat(this.m_boxSize.y," * ").concat(this.m_boxSize.z))}return t.m_bytesPerVoxel=f,t.m_dataArray=this.m_dataArray,t.m_dataSize=this.m_dataSize,t.m_boxSize=this.m_boxSize,console.log("KTX Loaded successfully with dim = ".concat(t.m_xDim,"*").concat(t.m_yDim,"*").concat(t.m_zDim,". bpp=").concat(t.m_bytesPerVoxel)),this.m_isLoadedSuccessfull=!0,void 0!==a&&a(1),void 0!==o&&o(ui.SUCCESS),ui.SUCCESS}},{key:"readFromUrl",value:function(e,t,i,a){var o=this;console.log("LoadedKtx. staring read ".concat(t)),this.m_fileLoader=new di(t),this.m_fileLoader.readFile((function(t){o.readFromBuffer(e,t,i,a)}),(function(e){console.log("LoaderKtx. Error read file: ".concat(e)),a(ui.ERROR_CANT_OPEN_URL,null,0,null)}))}}],[{key:"readInt",value:function(e,t){for(var i=0,a=0;a<4;a++){i=(i<<8)+e[t+3-a]}return i}},{key:"readFloat",value:function(e,t){var i=new ArrayBuffer(4),a=new DataView(i);a.setUint8(0,e[t+0]),a.setUint8(1,e[t+1]),a.setUint8(2,e[t+2]),a.setUint8(3,e[t+3]);return a.getFloat32(0,!0)}}]),e}(),gi=function(){function e(){Object(v.a)(this,e),this.m_littleEndian=!0,this.m_header={m_id:"",m_endianness:0,m_glType:0,m_glTypeSize:0,m_glFormat:0,m_glInternalFormat:0,m_glBaseInternalFormat:0,m_pixelWidth:0,m_pixelHeight:0,m_pixelDepth:0,m_numberOfArrayElements:0,m_numberOfFaces:0,m_numberOfMipmapLevels:0,m_bytesOfKeyValueData:0},this.m_xDim=0,this.m_yDim=0,this.m_zDim=0,this.m_boxSize={x:0,y:0,z:0}}return Object(p.a)(e,[{key:"readIntFromBuffer",value:function(e,t){return this.m_littleEndian?e[t+0]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24:e[t+3]|e[t+2]<<8|e[t+1]<<16|e[t+0]<<24}},{key:"readShortFromBuffer",value:function(e,t){return this.m_littleEndian?e[t+0]|e[t+1]<<8:e[t+1]|e[t+0]<<8}},{key:"readFloatFromBuffer",value:function(e,t){var i=new ArrayBuffer(4),a=new DataView(i);return a.setUint8(0,e[t+0]),a.setUint8(1,e[t+1]),a.setUint8(2,e[t+2]),a.setUint8(3,e[t+3]),a.getFloat32(0,this.m_littleEndian)}},{key:"readFromBuffer",value:function(e,t,i,a){var o=new Uint8Array(t),r=o.length;if(r<8)return a&&a(ui.ERROR_TOO_SMALL_DATA_SIZE,null,0,null),!1;if(r>=241172480)return a&&a(ui.ERROR_TOO_LARGE_DATA_SIZE,null,0,null),!1;var n=348;if(r<n)return console.log("Nifti header too small"),a&&a(ui.BAD_HEADER,null,0,null),!1;console.log("Nifti loader. Start parse ".concat(r," bytes..."));var s=0,l=this.readIntFromBuffer(o,s);if(l>2<<24&&(this.m_littleEndian=!1,l=this.readIntFromBuffer(o,s)),s+=4,l!==n)return console.log("Nifti first int wrong: ".concat(l,", but should be ").concat(n)),a&&a(ui.BAD_HEADER,null,0,null),!1;s+=10,s+=18,s+=4,s+=2,s+=1,s+=1;var m=this.readShortFromBuffer(o,s);s+=2;if(m<3)return console.log("Nifti header wrong num dimensions: ".concat(m,", but should be at least 3")),a&&a(ui.WRONG_HEADER_DIMENSIONS,null,0,null),!1;this.m_xDim=this.readShortFromBuffer(o,s),s+=2,this.m_yDim=this.readShortFromBuffer(o,s),s+=2,this.m_zDim=this.readShortFromBuffer(o,s),s+=2,s+=8,s+=4,s+=4,s+=4,s+=2;var h=this.readShortFromBuffer(o,s);s+=2;var u=this.readShortFromBuffer(o,s);s+=2;var c=256,d=512,_=0;if(_|=2===h,_|=4===h,_|=16===h,_|=h===c,!(_|=h===d))return console.log("Nifti header read. This data type (".concat(h,") is not supported")),a&&a(ui.WRONG_HEADER_DATA_TYPE,null,0,null),!1;if(!(8===u|16===u|32===u))return console.log("Nifti wrong bitPix: ".concat(u,", but should be 8,16 or 32")),a&&a(ui.WRONG_HEADER_BITS_PER_PIXEL,null,0,null),!1;s+=2,s+=4;var f=this.readFloatFromBuffer(o,s);s+=4;var v=this.readFloatFromBuffer(o,s);s+=4;var p=this.readFloatFromBuffer(o,s);s+=4,this.m_boxSize.x=this.m_xDim*f,this.m_boxSize.y=this.m_yDim*v,this.m_boxSize.z=this.m_zDim*p;if(this.m_boxSize.x<1e-5){this.m_boxSize.x=312,this.m_boxSize.y=312,this.m_boxSize.z=312}console.log("Nifti physic volume size: ".concat(this.m_boxSize.x," * ").concat(this.m_boxSize.y," * ").concat(this.m_boxSize.z));for(var g=o.slice(148,228),S="",y=!0,x=0;x<80&&y;x++)(y=g[x]>=20&&g[x]<255)&&(S=S.concat(String.fromCharCode(g[x])));if(!(110===o[(s=344)+0]&&43===o[s+1]&&49===o[s+2]))return console.log("Nifti hdr bad magic: ".concat(o[s+0],", ").concat(o[s+1],", ").concat(o[s+2])),a&&a(ui.WRONG_HEADER_MAGIC,null,0,null),!1;s+=4;var b,D=this.m_xDim*this.m_yDim*this.m_zDim,T=s,E=!1;for(b=29;b>=0&&!E;b--){1<<b<D&&(E=!0)}b++,(b-=3)<=0&&(b=1);var M,w,R=(1<<b)-1,k=0;if(w=0,4===h||h===d)for(M=0;M<D;M++){var O=this.readShortFromBuffer(o,T+w);if(w+=2,O>k&&(k=O),i&&0===(M&R)&&M>0)i(0+M/D*.5)}if(h===c||2===h)for(M=0;M<D;M++){var A=o[T+w];if(w++,A>k&&(k=A),i&&0===(M&R)&&M>0)i(0+M/D*.5)}if(16===h)for(M=0;M<D;M++){var C=this.readFloatFromBuffer(o,T+w),I=Math.floor(C)+1;if(w+=4,I>k&&(k=I),i&&0===(M&R)&&M>0)i(0+M/D*.5)}var F=new Float32Array(k+1);for(M=0;M<k+1;M++)F[M]=0;if(w=0,4===h||h===d)for(M=0;M<D;M++){var P=this.readShortFromBuffer(o,T+w);w+=2,F[P]++}if(16===h)for(M=0;M<D;M++){var U=Math.floor(this.readFloatFromBuffer(o,T+w));w+=4,F[U]++}if(h===c||2===h)for(M=0;M<D;M++){var X=o[T+w];w++,F[X]++}var z=new be;z.assignArray(k,F);z.smoothHistogram(.8,!1);var L=z.getLastMaxIndex(4);L<4&&(L=k),console.log("LoaderNifti. get Last max peak: ".concat(L," / ").concat(z.m_numColors)),k=L;var N=255,V=D*(u/8),B=new Uint8Array(D),j=130560/k;if(j<=4)return console.log("Bad scaling: image will be 0"),a&&a(ui.ERROR_PROCESS_HISTOGRAM,null,0,null),!1;if(w=0,4===h||h===d)for(M=0;M<D;M++){var G=this.readShortFromBuffer(o,T+w);if(w+=2,G=(G=G*j>>9)<=N?G:N,B[M]=G,i&&0===(M&R)&&M>0)i(.5+M/D*.5)}if(h===c||2===h)for(M=0;M<D;M++){var W=o[T+w];if(w++,W=(W=W*j>>9)<=N?W:N,B[M]=W,i&&0===(M&R)&&M>0)i(.5+M/D*.5)}if(16===h)for(M=0;M<D;M++){var H=Math.floor(this.readFloatFromBuffer(o,T+w));if(w+=4,H=(H=H*j>>9)<=N?H:N,B[M]=H,i&&0===(M&R)&&M>0)i(.5+M/D*.5)}var q,Y,Z,K=this.m_xDim*this.m_yDim,Q=0*K,J=(this.m_zDim-1)*K;for(Y=0;Y<this.m_yDim;Y++){var $=Y*this.m_xDim;for(q=0;q<this.m_xDim;q++){B[Q+$+q]=0,B[J+$+q]=0}}var ee=this.m_xDim-1;for(Z=0;Z<this.m_zDim;Z++){var te=Z*K;for(Y=0;Y<this.m_yDim;Y++){B[te+Y*this.m_xDim+0]=0,B[te+Y*this.m_xDim+ee]=0}}var ie=(this.m_yDim-1)*this.m_xDim;for(Z=0;Z<this.m_zDim;Z++){var ae=Z*K;for(q=0;q<this.m_xDim;q++){B[ae+0+q]=0,B[ae+ie+q]=0}}e.m_xDim=this.m_xDim,e.m_yDim=this.m_yDim,e.m_zDim=this.m_zDim;e.m_bytesPerVoxel=1,e.m_dataArray=B,e.m_dataSize=D,e.m_boxSize=this.m_boxSize,console.log("Nifti header read OK. Volume pixels = ".concat(this.m_xDim," * ").concat(this.m_yDim," * ").concat(this.m_zDim));var oe=6403,re={m_pixelWidth:this.m_xDim,m_pixelHeight:this.m_yDim,m_pixelDepth:this.m_zDim,m_glType:5121,m_glTypeSize:1,m_glFormat:oe,m_glInternalFormat:oe,m_glBaseInternalFormat:oe};return i&&i(1),a&&a(ui.SUCCESS,re,V,B),!0}},{key:"readFromUrl",value:function(e,t,i,a){var o=this;return console.log("LoadedNifti. staring read ".concat(t)),this.m_fileLoader=new di(t),this.m_fileLoader.readFile((function(t){return o.readFromBuffer(e,t,i,a)}),(function(e){console.log("LoadedNifti. Error read file: ".concat(e)),a(ui.ERROR_CANT_OPEN_URL,null,0,null)})),!0}}]),e}(),Si=function(){function e(){Object(v.a)(this,e),this.TAGS=[[2,0,"OB","FileMetaInfoGroupLength"],[2,1,"OB","FileMetaInformationVersion"],[2,2,"UI","MediaStoredSOPClassUID"],[2,3,"UI","MediaStoredSOPInstanceUID"],[2,16,"UI","TransferSyntaxUID"],[2,18,"UI","ImplementationClassUID"],[2,19,"UI","ImplementationVersionName"],[2,22,"UI","SourceApplicationEntityTitle"],[2,256,"UI","PrivateInformationCreatorUID"],[2,258,"UI","PrivateInformation"],[8,0,"UL","IdentifyingGroupLength"],[8,1,"UI","LengthToEnd"],[8,5,"CS","SpecificCharacterSet"],[8,6,"SQ","LanguageCodeSequence"],[8,8,"CS","ImageType"],[8,16,"SH","RecognitionCode"],[8,18,"DA","InstanceCreationDate"],[8,19,"TM","InstanceCreationTime"],[8,20,"UI","InstanceCreatorUID"],[8,22,"UI","SOPClassUID"],[8,24,"UI","SOPInstanceUID"],[8,26,"UI","RelatedGeneralSOPClassUID"],[8,27,"UI","OriginalSpecializedSOPClassUID"],[8,32,"DA","StudyDate"],[8,33,"DA","SeriesDate"],[8,34,"DA","AcquisitionDate"],[8,35,"DA","ContentDate"],[8,36,"DA","OverlayDate"],[8,37,"DA","CurveDate"],[8,42,"DT","AcquisitionDateTime"],[8,48,"TM","StudyTime"],[8,49,"TM","SeriesTime"],[8,50,"TM","AcquisitionTime"],[8,51,"TM","ContentTime"],[8,52,"TM","OverlayTime"],[8,53,"TM","CurveTime"],[8,64,"US","DataSetType"],[8,65,"LO","DataSetSubtype"],[8,66,"CS","NuclearMedicineSeriesType"],[8,80,"SH","AccessionNumber"],[8,81,"SQ","IssuerOfAccessionNumberSequence"],[8,82,"CS","QueryRetrieveLevel"],[8,84,"AE","RetrieveAETitle"],[8,86,"CS","InstanceAvailability"],[8,88,"UI","FailedSOPInstanceUIDList"],[8,96,"CS","Modality"],[8,112,"XX","Manufacturer"],[8,128,"XX","InstitutionName"],[8,129,"XX","InstitutionAddress"],[8,144,"XX","ReferringPhysicansName"],[8,4112,"XX","StationName"],[8,4144,"XX","StudyDescription"],[8,4158,"LO","SeriesDescription"],[8,4160,"XX","InstitutionDepartmentName"],[8,4176,"XX","PerformingPhysicansName"],[8,4192,'"XX','"Unkown'],[8,4224,"XX","AdmittingDiagnosesDescription"],[8,4240,"XX","ManufacturterModelName"],[8,4369,"XX","ReferencedPerformedProcStepSeq"],[8,4416,"XX","ReferencedImageSequence"],[8,4432,"UI","ReferencedSOP\u200bClassUID"],[8,4437,"UI","ReferencedSOP\u200bInstanceUID"],[8,8465,'"XX','"DerivationDescription'],[8,8466,'"XX','"SourceImageSequence'],[9,16,"LO","PrivateCreator"],[9,17,"??",'"Unknown'],[9,18,"??",'"Unknown'],[9,4097,"XX","PrivateTag"],[9,4098,"XX","PrivateTag"],[9,4100,"XX","PrivateTag"],[9,4135,"XX","PrivateTag"],[9,4144,"XX","PrivateTag"],[9,4145,"XX","PrivateTag"],[9,4323,"XX","PrivateTag"],[9,4329,"XX","PrivateTag"],[16,0,"UL","PatientGroupLength"],[16,16,"PN","PatientName"],[16,32,"LO","PatientID"],[16,33,"LO","IssuerOfPatientID"],[16,34,"CS","TypeOfPatientID"],[16,36,"SQ","IssuerOfPatientIDQualifiersSequence"],[16,48,"DA","PatientBirthDate"],[16,50,"TM","PatientBirthTime"],[16,64,"CS","PatientGender"],[16,80,"SQ","PatientInsurancePlanCodeSequence"],[16,257,"SQ","PatientPrimaryLanguageCodeSequence"],[16,258,"SQ","PatientPrimaryLanguageModifierCodeSequence"],[16,4096,"LO","OtherPatientIDs"],[16,4097,"PN","OtherPatientNames"],[16,4098,"SQ","OtherPatientIDsSequence"],[16,4101,"PN","PatientBirthName"],[16,4112,"AS","PatientAge"],[16,4128,"DS","PatientSize"],[16,4129,"SQ","PatientSizeCodeSequence"],[16,4144,"DS","PatientWeight"],[16,4160,"LO","PatientAddress"],[16,4176,"LO","InsurancePlanIdentification"],[16,4192,"PN","PatientMotherBirthName"],[16,4224,"LO","MilitaryRank"],[16,4225,"LO","BranchOfService"],[16,4240,"LO","MedicalRecordLocator"],[16,8192,"LO","MedicalAlerts"],[16,8464,"LO","Allergies"],[16,8528,"LO","CountryOfResidence"],[16,8530,"LO","RegionOfResidence"],[16,8532,"SH","PatientTelephoneNumbers"],[16,8544,"SH","EthnicGroup"],[16,8576,"SH","Occupation"],[16,8608,"CS","SmokingStatus"],[16,8624,"LT","AdditionalPatientHistory"],[16,8640,"US","PregnancyStatus"],[16,8656,"DA","LastMenstrualDate"],[16,8688,"LO","PatientReligiousPreference"],[16,8705,"LO","PatientSpeciesDescription"],[16,8706,"SQ","PatientSpeciesCodeSequence"],[16,8707,"CS","PatientSexNeutered"],[16,8720,"CS","AnatomicalOrientationType"],[16,8850,"LO","PatientBreedDescription"],[16,8851,"SQ","PatientBreedCodeSequence"],[16,8852,"SQ","BreedRegistrationSequence"],[16,8853,"LO","BreedRegistrationNumber"],[16,8854,"SQ","BreedRegistryCodeSequence"],[16,8855,"PN","ResponsiblePerson"],[16,8856,"CS","ResponsiblePersonRole"],[16,8857,"LO","ResponsibleOrganization"],[16,16384,"LT","PatientComments"],[16,37937,"FL","ExaminedBodyThickness"],[24,0,"UL","AcquisitionGroupLength"],[24,32,"XX","ScanningSequence"],[24,33,"XX","SequenceVariant"],[24,34,"XX","ScanOptions"],[24,35,"XX","MrAcquisionType"],[24,36,"??",'"SequenceName'],[24,37,"XX","AngioFlag"],[24,80,"XX","SliceThickness"],[24,96,"DS","KVP"],[24,128,"XX","RepetitionTime"],[24,129,"XX","EchoTime"],[24,130,"XX","InversionTime"],[24,131,"XX","NumberOfAverages"],[24,132,"XX","ImagingFrequency"],[24,133,"XX","ImagedNucleus"],[24,134,"XX","EchoNumber"],[24,135,"XX","MagneticFieldStrength"],[24,136,"XX","SpacingBetweenSlices"],[24,137,"XX","NumberOfPhaseEncodingSteps"],[24,144,"XX","DataCollectionDiameter"],[24,145,"XX","EchoTrainLength"],[24,147,"XX","ProcentSampling"],[24,148,"XX","ProcentPhaseFieldOfView"],[24,149,"XX","PixelBandwidth"],[24,4096,"XX","DeviceSerialNumber"],[24,4098,"??","DeviceUID"],[24,4099,"??","DeviceID"],[24,4100,"??","PlateID"],[24,4101,"??","GeneratorID"],[24,4102,"??","GridID"],[24,4103,"??",'"CassetteID'],[24,4104,"??","GantryID"],[24,4112,"??","SecondaryCaptureDeviceID"],[24,4113,"??","HardcopyCreationDeviceID"],[24,4114,"??","DateOfSecondaryCapture"],[24,4116,"??","TimeOfSecondaryCapture"],[24,4118,"??","SecondaryCaptureDeviceManufacturer"],[24,4119,"??","HardcopyDeviceManufacturer"],[24,4120,"??","SecondaryCaptureDeviceModelName"],[24,4121,"??","SecondaryCaptureDeviceSoftwareVers"],[24,4122,"??","HardcopyDeviceSoftwareVersion"],[24,4123,"??","HardcopyDeviceModelName"],[24,4128,"XX","SoftwareVersions"],[24,4144,"XX","ProtocolName"],[24,4225,"XX",'"LowR-RValue'],[24,4226,"XX",'"HiR-RValue'],[24,4227,"XX",'"IntervalsAcquired'],[24,4228,"XX",'"IntervalsRejected'],[24,4232,"XX","HeartRate"],[24,4240,"XX","CardiacNumberOfImages"],[24,4244,"XX","TriggerWindow"],[24,4352,"XX","ReconstructionDiameter"],[24,4368,"XX","DistanceSourceToDetector"],[24,4369,"XX","DistanceSourceToPatient"],[24,4373,"XX","Unknown"],[24,4384,"XX","GantryDetectorTilt"],[24,4400,"XX","TableHeight"],[24,4416,"XX","RotationDirection"],[24,4432,"XX","ExposureTime"],[24,4433,"XX","XRayTubeCurrent"],[24,4434,"XX","Exposure"],[24,4446,"XX",'"Unknown'],[24,4448,"XX","FilterType"],[24,4452,"XX",'"unknown'],[24,4454,"XX",'"unknown'],[24,4456,"XX",'"unknown'],[24,4464,"XX","GeneratorPower"],[24,4480,"XX",'"Unknown'],[24,4496,"XX","FocalSpot"],[24,4624,"XX","ConvolutionKernel"],[24,4688,"XX","ReceiveCoilName"],[24,4880,"XX","AcquisionMatrix"],[24,4882,"XX","InPlanePhaseEncodingDirection"],[24,4884,"XX","FlipAngle"],[24,4885,"XX","VariableFlipAngleFlag"],[24,4886,"XX","SAR"],[24,5120,"XX","unknown"],[24,5632,"XX",'"ShutterShape'],[24,5634,"XX","ShutterLeftVerticalEdge"],[24,5636,"XX",'"ShutterRightVerticalEdge'],[24,5638,"XX",'"ShutterUpperHorizontalEdge'],[24,5640,"XX",'"ShutterLowerHorizontalEdge'],[24,5648,"XX",'"CenterOfCircularShutter'],[24,5650,"XX",'"RadiusOfCircularShutter'],[24,5664,"XX",'"VerticesOfPolygonalShutter'],[24,5666,"XX",'"ShutterPresentationValue'],[24,5667,"XX",'"ShutterOverlayGroup'],[24,5668,"XX",'"ShutterPresentationColorCIELabVal'],[24,5888,"XX","Unknown"],[24,5890,"XX","Unknown"],[24,5892,"XX","Unknown"],[24,5894,"XX","Unknown"],[24,5896,"XX","Unknown"],[24,16384,"XX",'"AcquisitionComments'],[24,20480,"XX","OutputPower"],[24,20512,"XX","Unknown"],[24,20513,"XX",'"Unknown'],[24,20736,"XX","PatientPosition"],[24,20737,"XX","ViewPosition"],[24,24576,"XX","Unknown"],[24,37633,"XX","CTAcquisitionTypeSequence"],[24,37634,"XX","AcquisitionType"],[24,37635,"XX","TubeAngle"],[24,37636,"XX","CTAcquisitionDetailsSequence"],[24,37637,"XX","RevolutionTime"],[24,37638,"XX","SingleCollimationWidth"],[24,37639,"XX","TotalCollimationWidth"],[24,37640,"XX","CTTableDynamicsSequence"],[24,37641,"XX","TableSpeed"],[24,37648,"XX","TableFeedPerRotation"],[24,37649,"XX","SpiralPitchFactor"],[24,37650,"XX","CTGeometrySequence"],[24,37651,"XX","DataCollectionCenterPatient"],[24,37652,"XX","CTReconstructionSequence"],[24,37653,"XX","ReconstructionAlgorithm"],[24,37654,"XX","ConvolutionKernelGroup"],[24,37655,"XX","ReconstructionFieldOfView"],[24,37656,"XX","ReconstructionTargetCenterPatient"],[24,37657,"XX","ReconstructionAngle"],[24,37664,"XX","ImageFilter"],[24,37665,"XX","CTExposureSequenc"],[24,37666,"XX","ReconstructionPixelSpacing"],[24,37667,"XX","ExposureModulationType"],[24,37668,"XX","EstimatedDoseSaving"],[24,37669,"XX","CTXRayDetailsSequence"],[24,37670,"XX","CTPositionSequence"],[24,37671,"XX","TablePosition"],[24,37672,"XX","ExposureTimeInMilliSec"],[24,37673,"XX","CTImageFrameTypeSequence"],[24,37680,"XX","XRayTubeCurrentInMilliAmps"],[25,16,"LO","PrivateCreator"],[25,4098,"XX","NumberOfCellsInDetector"],[25,4099,"XX","CellsNumberAtTheta"],[25,4100,"XX","CellsSpacing"],[25,4111,"XX","HorizFrameOfRef"],[25,4113,"XX","SeriesContrast"],[25,4114,"XX","LastPSeq"],[25,4115,"XX","StartNumberOfBaseLine"],[25,4116,"XX","EndNumberOfBaseLine"],[25,4117,"XX","StartNumberForEnchancedScans"],[25,4118,"XX","EndNumberForEnchancedScans"],[25,4119,"XX","SeriesPlane"],[25,4120,"XX","FirstScanRas"],[25,4121,"XX","FirstScanLocation"],[25,4122,"XX","LastScanRas"],[25,4123,"XX","LastScanLoc"],[25,4126,"XX","DisplayFieldOfView"],[25,4131,"XX","TableSpeed"],[25,4132,"XX","MidScanTime"],[25,4133,"XX","MidScanFlag"],[25,4134,"XX","DegreesOfAzimuth"],[25,4135,"XX","GantryPeriod"],[25,4138,"XX","XRayOnPosition"],[25,4139,"XX","XRayOffPosition"],[25,4140,"XX","NumberOfTriggers"],[25,4142,"XX","AngleOfFirstView"],[25,4143,"XX","TriggerFrequency"],[25,4153,"XX","ScanFovType"],[25,4160,"XX","StatReconFlag"],[25,4161,"XX","ComputeType"],[25,4162,"XX","SegmentNumber"],[25,4163,"XX","TotalSegmentsRequested"],[25,4164,"XX","InterscanDelay"],[25,4167,"XX","ViewCompressionFactor"],[25,4170,"XX","TotalNoOfRefChannels"],[25,4171,"XX","DataSizeForScanData"],[25,4178,"XX","ReconPostProcflag"],[25,4183,"XX","CTWaterNumber"],[25,4184,"XX","CTBoneNumber"],[25,4186,"XX","AcquisitionDuration"],[25,4190,"XX","NumberOfChannels"],[25,4191,"XX","IncrementBetweenChannels"],[25,4192,"XX","StartingView"],[25,4193,"XX","NumberOfViews"],[25,4194,"XX","IncrementBetweenViews"],[25,4202,"XX","DependantOnNoViewsProcessed"],[25,4221,"DS","SecondEcho"],[25,4222,"SS","NumberOfEchoes"],[25,4223,"DS","TableDelta"],[25,4225,"SS","Contiguous"],[25,4228,"DS","PeakSAR"],[25,4231,"DS","CardiacRepetitionTime"],[25,4232,"SS","ImagesPerCardiacCycle"],[25,4234,"SS","ActualReceiveGainAnalog"],[25,4235,"SS","ActualReceiveGainDigital"],[25,4237,"DS","DelayAfterTrigger"],[25,4239,"SS","Swappf"],[25,4240,"SS","PauseInterval"],[25,4241,"DS","PulseTime"],[25,4242,"SL","SliceOffsetOnFreqAxis"],[25,4243,"DS","CenterFrequency"],[25,4244,"SS","TransmitGain"],[25,4245,"SS","AnalogReceiverGain"],[25,4246,"SS","DigitalReceiverGain"],[25,4247,"SL","BitmapDefiningCVs"],[25,4251,"SS","PulseSeqMode"],[25,4252,"LO","PulseSeqName"],[25,4253,"DT","PulseSeqDate"],[25,4254,"LO","InternalPulseSeqName"],[25,4255,"SS","TransmittingCoil"],[25,4256,"SS","SurfaceCoilType"],[25,4257,"SS","ExtremityCoilFlag"],[25,4258,"SL","RawDataRunNumber"],[25,4259,"UL","CalibratedFieldStrength"],[25,4260,"SS","SATFatWaterBone"],[25,4263,"DS","UserData01"],[25,4264,"DS","UserData02"],[25,4265,"DS","UserData03"],[25,4266,"DS","UserData04"],[25,4267,"DS","UserData05"],[25,4268,"DS","UserData06"],[25,4269,"DS","UserData07"],[25,4270,"DS","UserData08"],[25,4271,"DS","UserData09"],[25,4272,"DS","UserData10"],[25,4273,"DS","UserData11"],[25,4274,"DS","UserData12"],[25,4275,"DS","UserData13"],[25,4276,"DS","UserData14"],[25,4277,"DS","UserData15"],[25,4278,"DS","UserData16"],[25,4279,"DS","UserData17"],[25,4280,"DS","UserData18"],[25,4281,"DS","UserData19"],[25,4282,"DS","UserData20"],[25,4283,"DS","UserData21"],[25,4284,"DS","UserData22"],[25,4285,"DS","UserData23"],[25,4286,"DS","ProjectionAngle"],[25,4288,"SS","SaturationPlanes"],[25,4290,"SS","SATLocationR"],[25,4291,"SS","SATLocationL"],[25,4292,"SS","SATLocationA"],[25,4293,"SS","SATLocationP"],[25,4294,"SS","SATLocationH"],[25,4295,"SS","SATLocationF"],[25,4296,"SS","SATThicknessR-L"],[25,4297,"SS","SATThicknessA-P"],[25,4298,"SS","SATThicknessH-F"],[25,4299,"SS","PrescribedFlowAxis"],[25,4300,"SS","VelocityEncoding"],[25,4301,"SS","ThicknessDisclaimer"],[25,4302,"SS","PrescanType"],[25,4303,"SS","PrescanStatus"],[25,4306,"SS","ProjectionAlgorithm"],[25,4307,"SH","ProjectionAlgorithm"],[25,4309,"SS","FractionalEcho"],[25,4311,"SS","CardiacPhases"],[25,4312,"SS","VariableEchoflag"],[25,4313,"DS","ConcatenatedSAT"],[25,4319,"DS","UserData"],[25,4320,"DS","UserData"],[25,4322,"DS","VelocityEncodeScale"],[25,4338,"SS","FastPhases"],[25,4345,"DS","TransmissionGain"],[32,0,"UL","RelationshipGroupLength"],[32,13,"UI","StudyInstanceID"],[32,14,"UI","SeriesInstanceID"],[32,16,"IS","StudyID"],[32,17,"IS","SeriesNumber"],[32,18,"IS","AcquisionNumber"],[32,19,"IS","ImageNumber"],[32,32,"IS","PatientOrientation"],[32,50,"DS","ImagePosition"],[32,55,"DS","ImageOrientation"],[32,64,"XX","PositionReferenceIndicator"],[32,65,"XX","SliceLocation"],[32,82,"UI","FrameOfRefefernceID"],[32,96,"XX","Laterality"],[32,4098,"XX","ImagesInAcquision"],[32,4160,"LO","PositionReferenceIndicator"],[32,4161,"DS","SliceLocation"],[32,36950,"XX","StackId"],[32,36951,"XX","InStackPositionNumber"],[33,16,"LO","PrivateCreator"],[33,4099,"XX","SeriesFromWhichPrescribed"],[33,4101,"XX","GenesisVersionNow"],[33,4103,"XX","SeriesRecordChecksum"],[33,4120,"XX","GenesisVersionNow"],[33,4121,"XX","AcqreconRecordChecksum"],[33,4128,"XX","TableStartLocation"],[33,4149,"XX","SeriesFromWhichPrescribed"],[33,4150,"XX","ImageFromWhichPrescribed"],[33,4151,"XX","ScreenFormat"],[33,4170,"XX","AnatomicalReferenceForScout"],[33,4175,"XX","LocationsInAcquisition"],[33,4176,"XX","GraphicallyPrescribed"],[33,4177,"XX","RotationFromSourceXRot"],[33,4178,"XX","RotationFromSourceYRot"],[33,4179,"XX","RotationFromSourceZRot"],[33,4180,"XX","ImagePosition"],[33,4181,"XX","ImageOrientation"],[33,4182,"XX","IntegerSlop"],[33,4183,"XX","IntegerSlop"],[33,4184,"XX","IntegerSlop"],[33,4185,"XX","IntegerSlop"],[33,4186,"XX","IntegerSlop"],[33,4187,"XX","FloatSlop"],[33,4188,"XX","FloatSlop"],[33,4189,"XX","FloatSlop"],[33,4190,"XX","FloatSlop"],[33,4191,"XX","FloatSlop"],[33,4225,"XX","AutoWindowLevelAlpha"],[33,4226,"XX","AutoWindowLevelBeta"],[33,4227,"XX","AutoWindowLevelWindow"],[33,4228,"XX","ToWindowLevelLevel"],[33,4240,"XX","TubeFocalSpotPosition"],[33,4241,"XX","BiopsyPosition"],[33,4242,"XX","BiopsyTLocation"],[33,4243,"XX","BiopsyRefLocation"],[35,16,"LO","PrivateCreator"],[35,4097,"XX","NumberOfSeriesInStudy"],[35,4098,"XX","NumberOfUnarchivedSeries"],[35,4112,"XX","ReferenceImageField"],[35,4176,"XX","SummaryImage"],[35,4208,"XX","StartTimeSecsInFirstAxial"],[35,4212,"SL","NoofUpdatesToHeader"],[35,4221,"SS","IndicatesIfTheStudyHasCompleteInfo"],[35,4224,"LO","CRFilmFormat"],[37,16,"LO","PrivateCreator"],[37,4102,"SS","LastPulseSequenceUsed"],[37,4103,"SL","ImagesInSeries"],[37,4112,"SL","LandmarkCounter"],[37,4113,"SS","NumberOfAcquisitions"],[37,4116,"SL","IndicatesNoofUpdatesToHeader"],[37,4119,"SL","SeriesCompleteFlag"],[37,4120,"SL","NumberOfImagesArchived"],[37,4121,"SL","LastImageNumberUsed"],[37,4122,"SH","PrimaryReceiverSuiteAndHost"],[37,4123,"OB","ProtocolDataBlock"],[39,16,"LO","PrivateCreator"],[39,4102,"XX","ImageArchiveFlag"],[39,4112,"XX","ScoutType"],[39,4124,"XX","VmaMamp"],[39,4125,"XX","VmaPhase"],[39,4126,"XX","VmaMod"],[39,4127,"XX","VmaClip"],[39,4128,"XX","SmartScanOnOffFlag"],[39,4144,"XX","ForeignImageRevision"],[39,4145,"XX","ImagingMode"],[39,4146,"XX","PulseSequence"],[39,4147,"XX","ImagingOptions"],[39,4149,"XX","PlaneType"],[39,4150,"XX","ObliquePlane"],[39,4160,"XX","RASLetterOfImageLocation"],[39,4161,"XX","ImageLocation"],[39,4162,"XX","CenterRCoordOfPlaneImage"],[39,4163,"XX","CenterACoordOfPlaneImage"],[39,4164,"XX","CenterSCoordOfPlaneImage"],[39,4165,"XX","NormalRCoord"],[39,4166,"XX","NormalACoord"],[39,4167,"XX","NormalSCoord"],[39,4168,"XX","RCoordOfTopRightCorner"],[39,4169,"XX","ACoordOfTopRightCorner"],[39,4170,"XX","SCoordOfTopRightCorner"],[39,4171,"XX","RCoordOfBottomRightCorner"],[39,4172,"XX","ACoordOfBottomRightCorner"],[39,4173,"XX","SCoordOfBottomRightCorner"],[39,4176,"XX","TableStartLocation"],[39,4177,"XX","TableEndLocation"],[39,4192,"FL","ImageDimensionX"],[39,4193,"FL","ImageDimensionY"],[39,4194,"FL","NumberOfExcitations"],[40,0,"UL","ImagePresentationGroupLength"],[40,2,"US","SamplesPerPixel"],[40,4,"CS","PhotometricInterpretation"],[40,6,"US","Planar\u200bConfiguration"],[40,8,"XX","NumberOfFrames"],[40,16,"US","Rows"],[40,17,"US","Columns"],[40,48,"DS","PixelSpacing"],[40,256,"US","BitsAllocated"],[40,257,"US","BitsStored"],[40,258,"US","HighBit"],[40,259,"US","PixelRepresentation"],[40,262,"XX","SmallestImagePixelValue"],[40,263,"XX","LargestImagePixelValue"],[40,288,"US","PixelAddingValue"],[40,769,"CS","BurnderInAnnotation"],[40,771,"CS","Longitudinal\u200bTemporal\u200bInformation\u200bModified"],[40,4176,"DS","WindowCenter"],[40,4177,"DS","WindowWidth"],[40,4178,"DS","RescaleIntercept"],[40,4179,"DS","RescaleSlope"],[40,4180,"LO","RescaleType"],[40,4181,"LO","Window\u200bCenter\u200bWidth\u200bExplanation"],[41,16,"LO","PrivateCreator"],[41,4117,"SL","LowerRangeOfPixels1h"],[41,4118,"SL","LowerRangeOfPixels1i"],[41,4119,"SL","LowerRangeOfPixels2"],[41,4120,"SL","UpperRangeOfPixels2"],[41,4134,"SS","VersionOfTheHdrStruct"],[41,4145,"LO","PrivateTag"],[41,4146,"UL","PrivateTag"],[41,4147,"UL","PrivateTag"],[41,4148,"SL","AdvantageCompOverflow"],[41,4149,"SL","AdvantageCompUnderflow"],[50,0,"UL","StudyGroupLength"],[50,12,"XX","StrudyPriorityId"],[50,4128,"XX","ScheduledStudyLocation"],[50,4144,"XX","ReasonForStudy"],[50,4192,"XX","RequestedProcedureDescription"],[56,16,"XX","AdmissionId"],[56,80,"XX","SpecialNeeds"],[56,1280,"XX","PatientState"],[64,0,"UL","TextGroupLength"],[64,578,"XX","PerformedStationName"],[64,579,"XX","PerformedLocation"],[64,580,"XX","PerformedProcedureStepStartDate"],[64,581,"XX","PerformedProcedureStepStartTime"],[64,595,"XX","PerformedProcedureStepId"],[64,596,"XX","PerformedProcedureStepDescription"],[64,597,"LO","PerformedProcedureTypeDescription"],[64,640,"XX",'"CommentsOnPerformedProcedureStep'],[64,801,"XX","FilmConsumptionSequence"],[64,4097,"XX","RequestedProcedureId"],[64,4098,"XX","Unknown"],[64,4099,"XX","Unknown"],[64,4100,"XX","PatientTransportArrangments"],[64,4101,"XX","RequestedProcedureLocation"],[64,4112,"XX","NamesOfIntendentRecipientsOfResults"],[64,5120,"XX","RequestedProcedureComments"],[64,9216,"XX","ImagingServiceRequestComments"],[64,12289,"XX","Unknown"],[67,16,"LO","PrivateCreator"],[67,4097,"XX","BitmapOfPrescanOptions"],[67,4098,"XX","GradientOffsetInX"],[67,4099,"XX","GradientOffsetInY"],[67,4100,"XX","GradientOffsetInZ"],[67,4101,"XX","ImgIsOriginalOrUnoriginal"],[67,4102,"XX","NumberOfEPIShots"],[67,4103,"XX","ViewsPerSegment"],[67,4104,"XX","RespiratoryRateBpm"],[67,4105,"XX","RespiratoryTriggerPoint"],[67,4106,"XX","TypeOfReceiverUsed"],[67,4107,"XX","PeakRateOfChangeOfGradientField"],[67,4108,"XX","LimitsInUnitsOfPercent"],[67,4109,"XX","PSDEstimatedLimit"],[67,4110,"XX","PSDEstimatedLimitInTeslaPerSecond"],[67,4111,"XX","Saravghead"],[67,4112,"XX","WindowValue"],[67,4113,"XX","TotalInputViews"],[67,4114,"XX","XRayChain"],[67,4115,"XX","DeconKernelParameters"],[67,4116,"XX","CalibrationParameters"],[67,4117,"XX","TotalOutputViews"],[67,4118,"XX","NumberOfOverranges"],[67,4119,"XX","IBHImageScaleFactors"],[67,4120,"XX","BBHCoefficients"],[67,4121,"XX","NumberOfBBHChainsToBlend"],[67,4122,"XX","StartingChannelNumber"],[67,4123,"XX","PpscanParameters"],[67,4124,"XX","GEImageIntegrity"],[67,4125,"XX","LevelValue"],[67,4126,"XX","DeltaStartTime"],[67,4127,"XX","MaxOverrangesInAView"],[67,4128,"XX","AvgOverrangesAllViews"],[67,4129,"XX","CorrectedAfterGlowTerms"],[67,4133,"XX","ReferenceChannels"],[67,4134,"XX","NoViewsRefChansBlocked"],[67,4135,"XX","ScanPitchRatio"],[67,4136,"XX","UniqueImageIden"],[67,4137,"XX","HistogramTables"],[67,4138,"XX","UserDefinedData"],[67,4139,"XX","PrivateScanOptions"],[67,4140,"XX","EffectiveEchoSpacing"],[67,4141,"XX","StringSlopField1"],[67,4142,"XX","StringSlopField2"],[67,4143,"XX","RawDataType"],[67,4144,"XX","RawDataType"],[67,4145,"XX","RACordOfTargetReconCenter"],[67,4146,"XX","RawDataType"],[67,4147,"XX","NegScanspacing"],[67,4148,"XX","OffsetFrequency"],[67,4149,"XX","UserUsageTag"],[67,4150,"XX","UserFillMapMSW"],[67,4151,"XX","UserFillMapLSW"],[67,4152,"XX","User25_48"],[67,4153,"XX","SlopInt6_9"],[67,4160,"XX","TriggerOnPosition"],[67,4161,"XX","DegreeOfRotation"],[67,4162,"XX","DASTriggerSource"],[67,4163,"XX","DASFpaGain"],[67,4164,"XX","DASOutputSource"],[67,4165,"XX","DASAdInput"],[67,4166,"XX","DASCalMode"],[67,4167,"XX","DASCalFrequency"],[67,4168,"XX","DASRegXm"],[67,4169,"XX","DASAutoZero"],[67,4170,"XX","StartingChannelOfView"],[67,4171,"XX","DASXmPattern"],[67,4172,"XX","TGGCTriggerMode"],[67,4173,"XX","StartScanToXrayOnDelay"],[67,4174,"XX","DurationOfXrayOn"],[67,4192,"XX","SlopInt10_17"],[67,4193,"XX","ScannerStudyEntityUID"],[67,4194,"XX","ScannerStudyID"],[67,4207,"XX","ScannerTableEntry"],[67,4221,"US","ReconModeFlagWord "],[67,4224,"LO","CoilIDData"],[67,4225,"LO","GECoilName"],[67,4226,"LO","SystemConfigurationInformation"],[67,4227,"DS","AssetRFactors"],[67,4228,"LO","AdditionalAssetData"],[67,4233,"LO","GoverningBodyAndSARDefinition"],[67,4234,"CS","PrivateInPlanePhaseEncodingDirection"],[67,4240,"LO","SARDefinition"],[67,4241,"DS","SARValue"],[67,4245,"LO","PrescanReuseString"],[67,4246,"CS","ContentQualification"],[67,4247,"LO","ImageFilteringParameters"],[67,4250,"IS","RxStackIdentification"],[67,4266,"LO","AdditionalFilteringParameters"],[67,4273,"SS","ExcitationMode"],[69,16,"LO","PrivateCreator"],[69,4097,"XX","NumberOfMacroRowsInDetector"],[69,4098,"XX","MacroWidthAtISOCenter"],[69,4099,"XX","DASType"],[69,4100,"XX","DASGain"],[69,4102,"XX","TableDirectionInOrOut"],[69,4103,"XX","ZSmoothingFactor"],[69,4104,"XX","ViewWeightingMode"],[69,4105,"XX","SigmaRowNumberWhichRowsWereUsed"],[69,4106,"XX","MinimumDasValueFoundInTheScanData"],[69,4107,"XX","MaximumOffsetShiftValueUsed"],[69,4108,"XX","NumberOfViewsShifted"],[69,4109,"XX","ZTrackingFlag"],[69,4110,"XX","MeanZError"],[69,4111,"XX","ZTrackingMaximumError"],[69,4112,"XX","StartingViewForRow2a"],[69,4113,"XX","NumberOfViewsInRow2a"],[69,4114,"XX","StartingViewForRow1a"],[69,4115,"XX","SigmaMode"],[69,4116,"XX","NumberOfViewsInRow1a"],[69,4117,"XX","StartingViewForRow2b"],[69,4118,"XX","NumberOfViewsInRow2b"],[69,4119,"XX","StartingViewForRow1b"],[69,4120,"XX","NumberOfViewsInRow1b"],[69,4129,"XX","PrivateTag"],[69,4130,"XX","PrivateTag"],[69,4146,"XX","PrivateTag"],[83,16,"LO","PrivateCreator"],[83,4128,"XX","PrivateTag"],[83,4160,"XX","PrivateTag"],[83,4161,"XX","PrivateTag"],[83,4162,"XX","PrivateTag"],[83,4163,"XX","PrivateTag"],[83,4194,"XX","PrivateTag"],[136,320,"XX","StorageMediaFileSetUid"],[136,512,"XX","IconImageSequence"],[8193,4099,"XX","Unknown"],[8193,4106,"XX","Unknown"],[8193,4206,"XX","Unknown"],[8197,18,"XX","Unknown"],[8197,19,"XX","Unknown"],[8197,20,"XX","Unknown"],[8197,4627,"XX","Unknown"],[8197,5126,"XX","Unknown"],[21811,4611,"XX",'"Unknown'],[21811,21777,"XX",'"Unknown'],[32736,0,"IM","PixelDataGroupLength"],[32736,16,"IM","PixelData"]]}return Object(p.a)(e,[{key:"getVr",value:function(e,t){for(var i="",a=this.TAGS.length,o=0;o<a;o++)this.TAGS[o][0]===e&&this.TAGS[o][1]===t&&(i=this.TAGS[o][2]);return 0===t&&(i="UL"),i}},{key:"getTextDesc",value:function(e,t){for(var i="?",a=this.TAGS.length,o=0;o<a;o++)this.TAGS[o][0]===e&&this.TAGS[o][1]===t&&(i=this.TAGS[o][3]);return i}}]),e}(),yi=function e(){Object(v.a)(this,e),this.m_patientName="",this.m_patientDateOfBirth="",this.m_studyDescr="",this.m_studyDate="",this.m_seriesTime="",this.m_seriesDescr="",this.m_bodyPartExamined="",this.m_institutionName="",this.m_operatorsName="",this.m_physicansName="",this.m_patientId="",this.m_patientGender="",this.m_acquisionTime="",this.m_manufacturerName="",this.m_sliceInfo=[]},xi=[2,16],bi=[2,0],Di=[32736,16],Ti=function(){function e(t,i,a,o,r,n,s,l){Object(v.a)(this,e),this.m_group=t,this.m_element=i,this.m_vr=a,this.m_value=o,this.m_offsetStart=r,this.m_offsetValue=n,this.m_offsetEnd=s,this.m_littleEndian=l}return Object(p.a)(e,[{key:"value",value:function(){return this.m_value}},{key:"isTransformSyntax",value:function(){return this.m_group===xi[0]&&this.m_element===xi[1]}},{key:"isMetaLength",value:function(){return this.m_group===bi[0]&&this.m_element===bi[1]}},{key:"isPixelData",value:function(){return this.m_group===Di[0]&&this.m_element===Di[1]}}]),e}(),Ei=function(){function e(){Object(v.a)(this,e)}return Object(p.a)(e,null,[{key:"getHash",value:function(e){for(var t=e.length,i=53*t,a=0;a<t;a++){i=(i*=137211941^e.charCodeAt(a))<<27|i>>5,i&=1073741823}return i}}]),e}(),Mi=function(){function e(){Object(v.a)(this,e),this.m_image=null,this.m_sliceNumber=0,this.m_sliceLocation=0,this.m_patientName="",this.m_studyDescr="",this.m_studyDate="",this.m_seriesTime="",this.m_seriesDescr="",this.m_bodyPartExamined="",this.m_hash=0,this.m_xDim=0,this.m_yDim=0}return Object(p.a)(e,[{key:"buildHash",value:function(){var e=this.m_patientName+this.m_studyDescr+this.m_studyDate+this.m_seriesTime+this.m_seriesDescr+this.m_bodyPartExamined;this.m_hash=Ei.getHash(e)}}]),e}(),wi=function(){function e(t){Object(v.a)(this,e),console.assert(void 0!==t),console.assert("number"===typeof t,"hash shold be number"),this.m_hash=t,this.m_slices=[],this.m_minSlice=555555555555.5,this.m_maxSlice=-555555555555.5}return Object(p.a)(e,[{key:"addSlice",value:function(e){console.assert(void 0!==e),console.assert(e instanceof Mi,"added slice should be DicomSlice object"),this.m_slices.push(e),this.m_minSlice=e.m_sliceNumber<this.m_minSlice?e.m_sliceNumber:this.m_minSlice,this.m_maxSlice=e.m_sliceNumber>this.m_maxSlice?e.m_sliceNumber:this.m_maxSlice}}]),e}(),Ri=function(){function e(){Object(v.a)(this,e),this.m_series=[]}return Object(p.a)(e,[{key:"destroy",value:function(){this.m_series=[]}},{key:"getSeries",value:function(){return this.m_series}},{key:"addSlice",value:function(e){console.assert(void 0!==e),console.assert(e instanceof Mi,"should be DicomSlice object"),console.assert(void 0!==e.m_hash),console.assert(0!==e.m_hash);var t=this.getSerieIndex(e);if(t<0){var i=new wi(e.m_hash);this.m_series.push(i),t=this.m_series.length-1}this.m_series[t].addSlice(e)}},{key:"getSerieIndex",value:function(e){for(var t=this.m_series.length,i=0;i<t;i++){if(this.m_series[i].m_hash===e.m_hash)return i}return-1}}]),e}(),ki=function e(){Object(v.a)(this,e),this.m_sliceName="",this.m_fileName="",this.m_tags=[]},Oi=function e(){Object(v.a)(this,e),this.m_tag="",this.m_attrName="",this.m_attrValue=""},Ai=function(){function e(){Object(v.a)(this,e)}return Object(p.a)(e,[{key:"isValidUrl",value:function(e){var t=e.match(/^((ftp|http|https):\/\/)?(([\S]+)\.)?([\S]+)\.([A-z]{2,})(:\d{1,6})?\/[\S]+/),i=e.match(/(ftp|http|https):\/\/([\d]+)\.([\d]+)\.([\d]+)\.([\d]+)(:([\d]+))?\/([\S]+)/);return null!==t||null!==i}},{key:"getFileNameFromUrl",value:function(e){var t=e.lastIndexOf("/");if(t<0&&(t=e.lastIndexOf("\\")),t<0)return console.log("getFileNameFromUrl: wrong URL!"),"";var i=e.substring(t+1);return i=i.length<=40?i:i.substring(0,40)}},{key:"getFolderNameFromUrl",value:function(e){var t=e.lastIndexOf("/");return t<0&&(t=e.lastIndexOf("\\")),t<0?(console.log("getFolderNameFromUrl: wrong URL!"),""):e.substring(0,t)}},{key:"isUrlExists",value:function(e){var t=null;window.XMLHttpRequest&&(t=new XMLHttpRequest);t.open("GET",e,!0),t.send();return 404!==t.status}},{key:"encodeUrl",value:function(e){for(var t="",i=!1,a=e.length,o=0;o<a;o++){var r=e[o];if(i&&!("/"===r||"."===r||"-"===r||"_"===r)){var n=e.charCodeAt(o);t+=String.fromCharCode(n+1)}else t+=r;i="."===r||i}return t}},{key:"decodeUrl",value:function(e){for(var t="",i=!1,a=e.length,o=0;o<a;o++){var r=e[o];if(i&&!("/"===r||"."===r||"-"===r||"_"===r)){var n=e.charCodeAt(o);t+=String.fromCharCode(n-1)}else t+=r;i="."===r||i}return console.log("".concat(t)),t}}]),e}(),Ci=!1,Ii=[68,73,67,77],Fi=4294967295,Pi=1073741823,Ui=[32,19],Xi=[32736,16],zi=[40,256],Li=[40,16],Ni=[40,17],Vi=[40,258],Bi=[40,262],ji=[40,263],Gi=[40,288],Wi=[40,48],Hi=[40,4176],qi=[40,4177],Yi=[40,4178],Zi=[40,4179],Ki=[40,4180],Qi=[40,259],Ji=[32,50],$i=[32,4161],ea=[40,2],ta=[8,4158],ia=[8,49],aa=[65534,57357],oa=[65534,57565],ra=[32,17],na=[24,80],sa=[24,21],la="1.2.840.10008.1.2.4",ma="1.2.840.10008.1.2.4.57",ha="1.2.840.10008.1.2.4.70",ua="1.2.840.10008.1.2.4.50",ca='"1.2.840.10008.1.2.4.51',da="1.2.840.10008.1.2.4.90",_a="1.2.840.10008.1.2.4.91",fa="1.2.840.10008.1.2.5",va=[16,16],pa=[16,32],ga=[16,48],Sa=[16,64],ya=[8,32],xa=[8,4144],ba=[8,50],Da=[8,128],Ta=[8,144],Ea=[8,112],Ma=[8,4208],wa=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(v.a)(this,e),this.m_xDim=-1,this.m_yDim=-1,this.m_zDim=t,this.m_needScaleDownTexture=i,this.m_folder=null,this.m_isLoadedSuccessfull=!1,this.m_dataSize=0,this.m_dataArray=null,this.m_dictionary=new Si,this.m_imageNumber=-1,this.m_errors=[],this.m_transformSyntax="",this.m_loaders=[],this.m_xDim=-1,this.m_yDim=-1,this.m_bitsPerPixel=-1,this.m_padValue=-1073741823,this.m_windowCenter=Pi,this.m_windowWidth=Pi,this.m_rescaleIntercept=0,this.m_rescaleSlope=1,this.m_rescaleHounsfield=!1,this.m_pixelRepresentaionSigned=!1,this.m_littleEndian=!0,this.m_samplesPerPixel=1,this.m_seriesNumber=-1,this.m_seriesDescr="",this.m_boxSize={x:1,y:1,z:1},this.m_nonEmptyBoxMin={x:0,y:0,z:0},this.m_nonEmptyBoxMax={x:1,y:1,z:1},this.m_slicesVolume=new Ri,this.m_newTagEvent=new CustomEvent("newTag",{detail:{group:null,element:null,desc:null,value:null,imageNumber:null,fileName:null}}),this.m_dicomInfo=new yi,this.m_pixelSpacing={x:0,y:0,z:0},this.m_filesLoadedCounter=0,this.m_numLoadedFiles=t,this.m_imagePosMin={x:1e12,y:1e12,z:1e12},this.m_imagePosMax={x:-1e12,y:-1e12,z:-1e12},this.m_sliceLocMin=1e12,this.m_sliceLocMax=-1e12,this.runLoader=this.runLoader.bind(this)}return Object(p.a)(e,[{key:"getBoxSize",value:function(){return this.m_boxSize}},{key:"getNonEmptyBoxMin",value:function(){return this.m_nonEmptyBoxMin}},{key:"getNonEmptyBoxMax",value:function(){return this.m_nonEmptyBoxMax}},{key:"getDicomInfo",value:function(){return this.m_dicomInfo}},{key:"createVolumeFromSlices",value:function(e,t,i){console.assert(null!=e,"Null volume"),console.assert(e instanceof Oa,"Should be volume set"),console.assert("number"===typeof t,"index should be number"),console.assert("number"===typeof i,"index should be number");var a=null;t<e.getNumVolumes()?a=e.getVolume(t):(a=new _e,e.addVolume(a),a=e.getVolume(t),console.assert(null!==a));for(var o=this.m_slicesVolume.m_series.length,r=-1,n=0;n<o;n++)if(this.m_slicesVolume.m_series[n].m_hash===i){r=n;break}console.assert(r>=0);var s=this.m_slicesVolume.m_series[r],l=s.m_slices[0],m=s.m_slices.length;this.m_xDim=l.m_xDim,this.m_yDim=l.m_yDim,this.m_zDim=s.m_slices.length;var h,u,c=this.m_xDim*this.m_yDim,d={x:this.m_imagePosMax.x-this.m_imagePosMin.x,y:this.m_imagePosMax.y-this.m_imagePosMin.y,z:this.m_imagePosMax.z-this.m_imagePosMin.z},_=1e-5;Math.abs(this.m_pixelSpacing.z)>_?h=this.m_pixelSpacing.z*this.m_zDim:(h=d.z,Math.abs(h)<_&&(h=d.x,Math.abs(h)<_&&(h=d.y))),h<_&&(h=1),this.m_pixelSpacing.x*this.m_pixelSpacing.y<_&&(this.m_pixelSpacing.x=1,this.m_pixelSpacing.y=1),this.m_pixelSpacing.z=h/this.m_zDim,this.m_boxSize.z=this.m_zDim*this.m_pixelSpacing.z,this.m_boxSize.x=this.m_xDim*this.m_pixelSpacing.x,this.m_boxSize.y=this.m_yDim*this.m_pixelSpacing.y,console.log("createVolumeFromSlices. Volume local phys dim: ".concat(this.m_boxSize.x," * ").concat(this.m_boxSize.y," * ").concat(this.m_boxSize.z));var f,v=null;if(!this.m_littleEndian)for(var p=0;p<o;p++){var g=this.m_slicesVolume.m_series[p];if(g.m_hash===i)for(var S=0;S<m;S++){var y=g.m_slices[S],x=y.m_image;for(c=y.m_xDim*y.m_yDim,u=0;u<c;u++){var b=x[u];x[u]=b>>8|b<<8&65535}}}for(var D=0;D<o;D++){var T=this.m_slicesVolume.m_series[D];if(T.m_hash===i)for(var E=0;E<m;E++){var M=T.m_slices[E];for(c=M.m_xDim*M.m_yDim,u=0;u<c;u++){var w=M.m_image[u];w===this.m_padValue&&(w=0),M.m_image[u]=w}}}for(var R=-1073741823,k=1073741823,O=0;O<o;O++){var A=this.m_slicesVolume.m_series[O];if(A.m_hash===i)for(var C=0;C<m;C++){var I=A.m_slices[C],F=I.m_image;for(c=I.m_xDim*I.m_yDim,u=0;u<c;u++){var P=F[u]*this.m_rescaleSlope+this.m_rescaleIntercept;k=P<k?P:k,R=P>R?P:R}}}console.log("Build Volume. min/max value=".concat(k,"/").concat(R,". Volume dim = ").concat(this.m_xDim,"*").concat(this.m_yDim,"*").concat(this.m_zDim)),console.log("Min slice number = ".concat(s.m_minSlice)),console.log("Max slice number = ".concat(s.m_maxSlice)),R=R-k>0?R:R+1;var U=Math.floor((1<<19)/(R-k));if(U<=4)return console.log("Bad scaling: image will be 0"),ui.ERROR_SCALING;var X=s.m_slices,z=s.m_maxSlice-s.m_minSlice+1;z!==m&&console.log("Sort by location! N slices by tags = ".concat(z,", but N readed slices = ").concat(m));for(var L=X[0].m_sliceNumber,N=X[0].m_sliceNumber,V=0;V<m;V++){var B=X[V].m_sliceNumber;L=B<L?B:L,N=B>N?B:N}N-L>0?X.sort((function(e,t){return e.m_sliceNumber-t.m_sliceNumber})):X.sort((function(e,t){return e.m_sliceLocation-t.m_sliceLocation}));for(var j=0,G=0;G<m;G++)X[G].m_sliceNumber=j,j++;if(this.m_zDim=m,f=this.m_xDim*this.m_yDim*this.m_zDim,null===(v=new Uint8Array(f)))return console.log("no memory"),ui.ERROR_NO_MEMORY;for(u=0;u<f;u++)v[u]=0;for(var W=0;W<m;W++){var H=X[W];c=H.m_xDim*H.m_yDim;var q=H.m_image,Y=H.m_sliceNumber;if(Y>=s.m_slices.length&&((Y=H.m_sliceNumber-s.m_minSlice)<0||Y>=this.m_zDim))return console.log("Invalid z slice reference"),ui.ERROR_INVALID_SLICE_INDEX;if(null!==q){var Z=Y*c;if(this.m_windowCenter!==Pi&&this.m_windowWidth!==Pi){var K=this.m_windowCenter-.5*this.m_windowWidth;for(u=0;u<c;u++){var Q=q[u]*this.m_rescaleSlope+this.m_rescaleIntercept,J=0;J=(J=(J=this.m_rescaleHounsfield?Math.floor(255*(Q-K)/this.m_windowWidth):Math.floor(127+128*(Q-this.m_windowCenter)/(this.m_windowWidth/2)))>=0?J:0)<255?J:255,v[Z+u]=J}}else for(u=0;u<c;u++){var $=(q[u]*this.m_rescaleSlope+this.m_rescaleIntercept-k)*U>>11;$=$<=255?$:255,v[Z+u]=$}}}var ee=this.m_xDim*this.m_yDim*this.m_zDim;if(this.m_needScaleDownTexture&&ee>67108864){var te=512,ie=this.m_xDim<=te?this.m_xDim:te,ae=this.m_yDim<=te?this.m_yDim:te;v=VolumeTools.scaleTextureDown(this,v,ie,ae,120),c=this.m_xDim*this.m_yDim,console.log("Volume scaled down to: ".concat(ie," * ").concat(ae," * ").concat(120,"."))}if(this.m_zDim>4){var oe,re,ne,se,le,me=(ne=0)*this.m_xDim*this.m_yDim,he=(ne=this.m_zDim-1)*this.m_xDim*this.m_yDim;for(re=0;re<this.m_yDim;re++)for(se=re*this.m_xDim,oe=0;oe<this.m_xDim;oe++)v[me+se+oe]=0,v[he+se+oe]=0;var ue=oe=0,ce=oe=this.m_xDim-1;for(ne=0;ne<this.m_zDim;ne++)for(le=ne*this.m_xDim*this.m_yDim,re=0;re<this.m_yDim;re++)v[le+(se=re*this.m_xDim)+ue]=0,v[le+se+ce]=0;var de=(re=0)*this.m_xDim,fe=(re=this.m_yDim-1)*this.m_xDim;for(ne=0;ne<this.m_zDim;ne++)for(le=ne*this.m_xDim*this.m_yDim,oe=0;oe<this.m_xDim;oe++)v[le+oe+de]=0,v[le+oe+fe]=0}var ve=6403,pe={m_pixelWidth:this.m_xDim,m_pixelHeight:this.m_yDim,m_pixelDepth:this.m_zDim,m_glType:5121,m_glTypeSize:1,m_glFormat:ve,m_glInternalFormat:ve,m_glBaseInternalFormat:ve},ge=this.m_callbackComplete;ge&&ge(ui.SUCCESS,pe,f,v);return a.m_xDim=this.m_xDim,a.m_yDim=this.m_yDim,a.m_zDim=this.m_zDim,a.m_dataArray=v,a.m_dataSize=f,a.m_bytesPerVoxel=1,a.m_boxSize.x=this.m_boxSize.x,a.m_boxSize.y=this.m_boxSize.y,a.m_boxSize.z=this.m_boxSize.z,a.m_patientName=this.m_dicomInfo.m_patientName,a.m_patientBirth=this.m_dicomInfo.m_patientDateOfBirth,a.m_seriesDescr=this.m_dicomInfo.m_seriesDescr,a.m_studyDescr=this.m_dicomInfo.m_studyDescr,a.m_studyDate=this.m_dicomInfo.m_studyDate,a.m_seriesTime=this.m_dicomInfo.m_seriesTime,a.m_bodyPartExamined=this.m_dicomInfo.m_bodyPartExamined,a.m_institutionName=this.m_dicomInfo.m_institutionName,a.m_operatorsName=this.m_dicomInfo.m_operatorsName,a.m_physicansName=this.m_dicomInfo.m_physicansName,a.createIcon(),ui.SUCCESS}},{key:"getNextTag",value:function(t,i){if(i>=t.byteLengh)return null;var a=!0,o=0,r=0,n=0,s=i,l="";this.m_metaFinished?(a=this.m_littleEndian,o=t.getUint16(i,a)):(o=t.getUint16(i,1),-1!==this.m_metaFinishedOffset&&i>=this.m_metaFinishedOffset||2!==o?(this.m_metaFinished=1,a=this.m_littleEndian,o=t.getUint16(i,a)):a=!0),this.m_metaFound||2!==o||(this.m_metaFound=!0),i+=2,r=t.getUint16(i,a),i+=2,this.m_explicit||!this.m_metaFinished?(l=e.getStringAt(t,i,2),!this.m_metaFound&&this.m_metaFinished&&-1===e.getVrsStringIndex(l)?(l=Si.getVr(o,r),n=t.getUint32(i,a),i+=4,this.m_explicit=!1):(i+=2,-1!==e.getDataVrsStringIndex(l)?(i+=2,n=t.getUint32(i,a),i+=4):(n=t.getUint16(i,a),i+=2))):(l=this.m_dictionary.getVr(o,r),(n=t.getUint32(i,a))===Fi&&(l="SQ"),i+=4);var m=i,h=null;if("SQ"===l){if(n===Fi){for(var u=0,c=0;u!==oa[0]||c!==oa[1];){u=t.getUint16(i,a),i+=2,c=t.getUint16(i,a),i+=2;var d=t.getUint32(i,a);if(i+=4,d===Fi){for(;!(u===aa[0]&&c===aa[1]||u===oa[0]&&c===oa[1]);){i=this.getNextTag(t,i).m_offsetEnd,u=t.getUint16(i,a),c=t.getUint16(i+2,a)}i+=8}else i+=d}n=0}}else n>0&&(n===Fi&&o===Xi[0]&&r===Xi[1]&&(n=t.byteLength-i),h=t.buffer.slice(i,i+n));if(4294967295===n)return null;var _=new Ti(o,r,l,h,s,m,i+=n,this.m_littleEndian);if(_&&(this.m_newTagEvent.detail.group=o.toString(16),this.m_newTagEvent.detail.element=r.toString(16),this.m_newTagEvent.detail.desc=this.m_dictionary.getTextDesc(o,r),this.m_newTagEvent.detail.value=e.getAttrValueAsString(_),this.m_newTagEvent.detail.imageNumber=o===Ui[0]&&r===Ui[1]?parseInt(this.m_newTagEvent.detail.value,10):-1,dispatchEvent(this.m_newTagEvent)),_.isTransformSyntax()){var f=_.m_value.byteLength,v=new DataView(_.m_value),p=e.getStringAt(v,0,f);"1.2.840.10008.1.2"===p?(this.m_explicit=!1,this.m_littleEndian=!0):"1.2.840.10008.1.2.2"===p?(this.m_explicit=!0,this.m_littleEndian=!1):"1.2.840.10008.1.2.1.99"===p?(this.m_needsDeflate=!0,this.m_explicit=!0,this.m_littleEndian=!0):p==la?this.m_transformSyntax=la:p==ha?this.m_transformSyntax=ha:p==ma?this.m_transformSyntax=ma:p==ua?this.m_transformSyntax=ua:p==ca?this.m_transformSyntax=ca:p==da?this.m_transformSyntax=da:p==_a?this.m_transformSyntax=_a:p==fa?this.m_transformSyntax=fa:(this.m_explicit=!0,this.m_littleEndian=!0)}else _.isMetaLength()&&(this.m_metaFinishedOffset=_.m_value[0]+i);return _}},{key:"readFromGoogleBuffer",value:function(t,i,a,o,r,n){var s=new DataView(o),l=(s.byteLength,e.getStringAt(s,64,32));if("Content-Type: application/dicom;"===l){var m=o.slice(136);new DataView(m);return this.readFromBuffer(t,i,a,m,r,n)}return console.log("readFromGoogleBuffer. bad content type = ".concat(l)),ui.BAD_HEADER}},{key:"readFromBuffer",value:function(t,i,a,o,r,n){"number"!==typeof t&&console.log("LoaderDicom.readFromBuffer: bad indexFile argument"),"string"!==typeof i&&console.log("LoaderDicom.readFromBuffer: bad fileName argument"),"object"!==typeof o&&console.log("LoaderDicom.readFromBuffer: bad arrBuf argument");var s=this.m_dicomInfo,l=new ki,m="Slice "+t.toString();l.m_sliceName=m,l.m_fileName=i,l.m_tags=[],s.m_sliceInfo.push(l);var h=new DataView(o);if(null===h)return console.log("No memory"),ui.ERROR_NO_MEMORY;if(h.byteLength<144)return this.m_error=ui.ERROR_TOO_SMALL_DATA_SIZE,void 0!==n&&n(ui.ERROR_TOO_SMALL_DATA_SIZE),ui.ERROR_TOO_SMALL_DATA_SIZE;for(var u=0;u<4;u++){if(h.getUint8(128+u)!==Ii[u])return this.m_errors[t]=-1,console.log("Dicom readFromBuffer. Wrong header in file: ".concat(i)),void 0!==n&&n(ui.WRONG_HEADER_MAGIC),ui.WRONG_HEADER_MAGIC}var c=128;c+=4,this.m_littleEndian=!0,this.m_explicit=!0,this.m_metaFound=!1,this.m_metaFinished=!1,this.m_metaFinishedOffset=-1,this.m_needsDeflate=!1,this.m_imageNumber=-1,this.m_xDim=-1,this.m_yDim=-1,this.m_bitsPerPixel=-1,this.m_windowCenter=-1,this.m_windowWidth=-1;var d,_=0,f=0,v=!1;for(d=this.getNextTag(h,c);null!==d;){if(d.isPixelData()){v=!0;break}if(c=d.m_offsetEnd,null===(d=this.getNextTag(h,c)))break;var p=this.m_dicomInfo,g=p.m_sliceInfo.length,S=p.m_sliceInfo[g-1],y=new Oi;y.m_tag="("+e.numberToHexString(d.m_group)+","+e.numberToHexString(d.m_element)+")";var x=this.m_dictionary.getTextDesc(d.m_group,d.m_element);y.m_attrName=x.length>1?x:"";var b=e.getAttrValueAsString(d);if(b=null!==b?b:"",y.m_attrValue=b,S.m_tags.push(y),d.m_group===Ui[0]&&d.m_element===Ui[1]){var D=d.m_value.byteLength,T=new DataView(d.m_value),E=e.getStringAt(T,0,D);this.m_imageNumber=parseInt(E,10)-1}if(d.m_group===Li[0]&&d.m_element===Li[1]){var M=d.m_value.byteLength,w=new DataView(d.m_value),R=2===M?w.getUint16(0,this.m_littleEndian):w.getUint32(0,this.m_littleEndian);if(this.m_yDim<0)this.m_yDim=R;else if(this.m_yDim!==R)return console.log("Bad image size y"),void 0!==n&&n(ui.WRONG_IMAGE_DIM_Y),ui.WRONG_IMAGE_DIM_Y}if(d.m_group===Ni[0]&&d.m_element===Ni[1]){var k=d.m_value.byteLength,O=new DataView(d.m_value),A=2===k?O.getUint16(0,this.m_littleEndian):O.getUint32(0,this.m_littleEndian);if(this.m_xDim<0)this.m_xDim=A;else if(this.m_xDim!==A)return console.log("Bad image size x"),void 0!==n&&n(ui.WRONG_IMAGE_DIM_X),ui.WRONG_IMAGE_DIM_X}if(d.m_group===zi[0]&&d.m_element===zi[1]){var C=d.m_value.byteLength,I=new DataView(d.m_value);this.m_bitsPerPixel=2===C?I.getUint16(0,this.m_littleEndian):I.getUint32(0,this.m_littleEndian)}if(d.m_group===Hi[0]&&d.m_element===Hi[1]&&null!=d.m_value&&d.m_value.byteLength>0){var F=d.m_value.byteLength,P=new DataView(d.m_value),U=e.getStringAt(P,0,F);this.m_windowCenter=parseInt(U,10)}if(d.m_group===qi[0]&&d.m_element===qi[1]&&null!=d.m_value&&d.m_value.byteLength>0){var X=d.m_value.byteLength,z=new DataView(d.m_value),L=e.getStringAt(z,0,X);this.m_windowWidth=parseInt(L,10)}if(d.m_group===Yi[0]&&d.m_element===Yi[1]&&null!=d.m_value&&d.m_value.byteLength>0){var N=d.m_value.byteLength,V=new DataView(d.m_value),B=e.getStringAt(V,0,N);this.m_rescaleIntercept=parseInt(B,10)}if(d.m_group===Zi[0]&&d.m_element===Zi[1]&&null!=d.m_value&&d.m_value.byteLength>0){var j=d.m_value.byteLength,G=new DataView(d.m_value),W=e.getStringAt(G,0,j);this.m_rescaleSlope=parseInt(W,10)}if(d.m_group===Ki[0]&&d.m_element===Ki[1]&&null!=d.m_value&&d.m_value.byteLength>0){var H=d.m_value.byteLength,q=new DataView(d.m_value);"HU"===e.getStringAt(q,0,H)&&(this.m_rescaleHounsfield=!0)}if(d.m_group===Qi[0]&&d.m_element===Qi[1]&&null!=d.m_value&&d.m_value.byteLength>0){var Y=d.m_value.byteLength,Z=new DataView(d.m_value);1===(2===Y?Z.getUint16(0,this.m_littleEndian):Z.getUint32(0,this.m_littleEndian))&&(this.m_pixelRepresentaionSigned=!0)}if(d.m_group===ra[0]&&d.m_element===ra[1]&&null!=d.m_value&&d.m_value.byteLength>0){var K=d.m_value.byteLength,Q=new DataView(d.m_value),J=e.getStringAt(Q,0,K);this.m_seriesNumber=parseInt(J,10)}if(d.m_group===ta[0]&&d.m_element===ta[1]&&null!==d.m_value){var $=d.m_value.byteLength,ee=new DataView(d.m_value);this.m_seriesDescr=e.getStringAt(ee,0,$)}if(d.m_group===Vi[0]&&d.m_element===Vi[1]){var te=d.m_value.byteLength,ie=new DataView(d.m_value),ae=2===te?ie.getUint16(0,this.m_littleEndian):ie.getUint32(0,this.m_littleEndian);_=(1<<ae+1)-1}if(d.m_group===Bi[0]&&d.m_element===Bi[1]){var oe=d.m_value.byteLength,re=new DataView(d.m_value);2===oe?re.getInt16(0,this.m_littleEndian):re.getInt32(0,this.m_littleEndian)}if(d.m_group===ji[0]&&d.m_element===ji[1]){var ne=d.m_value.byteLength,se=new DataView(d.m_value);2===ne?se.getInt16(0,this.m_littleEndian):se.getInt32(0,this.m_littleEndian)}if(d.m_group===Gi[0]&&d.m_element===Gi[1]){var le=d.m_value.byteLength,me=new DataView(d.m_value);f=2===le?me.getUint16(0,this.m_littleEndian):me.getUint32(0,this.m_littleEndian),this.m_padValue=f}if(d.m_group===Wi[0]&&d.m_element===Wi[1]){var he=d.m_value.byteLength,ue=new DataView(d.m_value),ce=e.getStringAt(ue,0,he).split("\\");2===ce.length&&(this.m_pixelSpacing.x=parseFloat(ce[0]),this.m_pixelSpacing.y=parseFloat(ce[1]))}if(d.m_group===Ji[0]&&d.m_element===Ji[1]){var de=d.m_value.byteLength,_e=new DataView(d.m_value),fe=e.getStringAt(_e,0,de).split("\\");if(3===fe.length){var ve=parseFloat(fe[0]),pe=parseFloat(fe[1]),ge=parseFloat(fe[2]);this.m_imagePosMin.x=ve<this.m_imagePosMin.x?ve:this.m_imagePosMin.x,this.m_imagePosMin.y=pe<this.m_imagePosMin.y?pe:this.m_imagePosMin.y,this.m_imagePosMin.z=ge<this.m_imagePosMin.z?ge:this.m_imagePosMin.z,this.m_imagePosMax.x=ve>this.m_imagePosMax.x?ve:this.m_imagePosMax.x,this.m_imagePosMax.y=pe>this.m_imagePosMax.y?pe:this.m_imagePosMax.y,this.m_imagePosMax.z=ge>this.m_imagePosMax.z?ge:this.m_imagePosMax.z}}if(d.m_group===na[0]&&d.m_element===na[1]){var Se=d.m_value.byteLength,ye=new DataView(d.m_value),xe=e.getStringAt(ye,0,Se);this.m_pixelSpacing.z=parseFloat(xe)}if(d.m_group===$i[0]&&d.m_element===$i[1]){var be=d.m_value.byteLength,De=new DataView(d.m_value),Te=e.getStringAt(De,0,be),Ee=parseFloat(Te);this.m_sliceLocation=Ee,this.m_sliceLocMin=Ee<this.m_sliceLocMin?Ee:this.m_sliceLocMin,this.m_sliceLocMax=Ee>this.m_sliceLocMax?Ee:this.m_sliceLocMax}if(d.m_group===ea[0]&&d.m_element===ea[1]){var Me=d.m_value.byteLength,we=new DataView(d.m_value);this.m_samplesPerPixel=2===Me?we.getUint16(0,this.m_littleEndian):we.getUint32(0,this.m_littleEndian)}if(d.m_group===ta[0]&&d.m_element===ta[1]&&null!==d.m_value){var Re=d.m_value.byteLength,ke=new DataView(d.m_value),Oe=e.getStringAt(ke,0,Re);this.m_dicomInfo.m_seriesDescr=Oe}if(d.m_group===ia[0]&&d.m_element===ia[1]&&null!==d.m_value){var Ae=d.m_value.byteLength,Ce=new DataView(d.m_value),Ie=e.getStringAt(Ce,0,Ae),Fe=Ie.substring(0,2),Pe=Ie.substring(2,4),Ue=Ie.substring(4,Ie.length),Xe="".concat(Fe,":").concat(Pe,":").concat(Ue);this.m_dicomInfo.m_seriesTime=Xe}if(d.m_group===va[0]&&d.m_element===va[1]&&null!==d.m_value){var ze=d.m_value.byteLength,Le=new DataView(d.m_value);this.m_dicomInfo.m_patientName=e.getUtf8StringAt(Le,0,ze),this.m_dicomInfo.m_patientName=this.m_dicomInfo.m_patientName.trim()}if(d.m_group===pa[0]&&d.m_element===pa[1]&&null!==d.m_value){var Ne=d.m_value.byteLength,Ve=new DataView(d.m_value);this.m_dicomInfo.m_patientId=e.getStringAt(Ve,0,Ne)}if(d.m_group===Sa[0]&&d.m_element===Sa[1]&&null!==d.m_value){var Be=d.m_value.byteLength,je=new DataView(d.m_value);this.m_dicomInfo.m_patientGender=e.getStringAt(je,0,Be)}if(d.m_group===ga[0]&&d.m_element===ga[1]&&null!==d.m_value){var Ge=d.m_value.byteLength,We=new DataView(d.m_value),He=e.getStringAt(We,0,Ge),qe=He.substring(0,4),Ye=He.substring(4,6),Ze=He.substring(6);this.m_dicomInfo.m_patientDateOfBirth="".concat(Ze,"/").concat(Ye,"/").concat(qe)}if(d.m_group===ya[0]&&d.m_element===ya[1]&&null!==d.m_value){var Ke=d.m_value.byteLength,Qe=new DataView(d.m_value),Je=e.getStringAt(Qe,0,Ke),$e=Je.substring(0,4),et=Je.substring(4,6),tt=Je.substring(6);this.m_dicomInfo.m_studyDate="".concat(tt,"/").concat(et,"/").concat($e)}if(d.m_group===xa[0]&&d.m_element===xa[1]&&null!==d.m_value){var it=d.m_value.byteLength,at=new DataView(d.m_value),ot=e.getStringAt(at,0,it);this.m_dicomInfo.m_studyDescr=ot,this.m_dicomInfo.m_studyDescr=this.m_dicomInfo.m_studyDescr.trim()}if(d.m_group===sa[0]&&d.m_element===sa[1]&&null!==d.m_value){var rt=d.m_value.byteLength,nt=new DataView(d.m_value);this.m_dicomInfo.m_bodyPartExamined=e.getStringAt(nt,0,rt)}if(d.m_group===ba[0]&&d.m_element===ba[1]&&null!==d.m_value){var st=d.m_value.byteLength,lt=new DataView(d.m_value);this.m_dicomInfo.m_acquisionTime=e.getStringAt(lt,0,st)}if(d.m_group===Da[0]&&d.m_element===Da[1]&&null!==d.m_value){var mt=d.m_value.byteLength,ht=new DataView(d.m_value);this.m_dicomInfo.m_institutionName=e.getUtf8StringAt(ht,0,mt),this.m_dicomInfo.m_institutionName=this.m_dicomInfo.m_institutionName.trim()}if(d.m_group===Ma[0]&&d.m_element===Ma[1]&&null!==d.m_value){var ut=d.m_value.byteLength,ct=new DataView(d.m_value);this.m_dicomInfo.m_operatorsName=e.getUtf8StringAt(ct,0,ut),this.m_dicomInfo.m_operatorsName=this.m_dicomInfo.m_operatorsName.trim()}if(d.m_group===Ta[0]&&d.m_element===Ta[1]&&null!==d.m_value){var dt=d.m_value.byteLength,_t=new DataView(d.m_value);this.m_dicomInfo.m_physicansName=e.getUtf8StringAt(_t,0,dt),this.m_dicomInfo.m_physicansName=this.m_dicomInfo.m_physicansName.trim()}if(d.m_group===Ea[0]&&d.m_element===Ea[1]&&null!==d.m_value){var ft=d.m_value.byteLength,vt=new DataView(d.m_value);this.m_dicomInfo.m_manufacturerName=e.getStringAt(vt,0,ft),this.m_dicomInfo.m_manufacturerName=this.m_dicomInfo.m_manufacturerName.trim()}}if(!v)return void 0!==n&&n(ui.ERROR_PIXELS_TAG_NOT_FOUND),ui.ERROR_PIXELS_TAG_NOT_FOUND;if(this.m_transformSyntax.length>1)return void 0!==n&&n(ui.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED),ui.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED;var pt=Math.floor(this.m_xDim*this.m_yDim*(this.m_bitsPerPixel/8)*this.m_samplesPerPixel);if(pt!==d.m_value.byteLength||0===_)return console.log("Wrong image pixels size. Readed ".concat(d.m_value.byteLength,", but expected ").concat(pt)),void 0!==n&&n(ui.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED),ui.WRONG_HEADER_DATA_SIZE;var gt=this.m_xDim*this.m_yDim,St=new Mi;if(null===St)return console.log("No memory"),ui.ERROR_NO_MEMORY;if(this.m_pixelRepresentaionSigned?St.m_image=new Int16Array(gt):St.m_image=new Uint16Array(gt),null===St.m_image)return console.log("No memory"),ui.ERROR_NO_MEMORY;St.m_sliceNumber=this.m_imageNumber,St.m_sliceLocation=this.m_sliceLocation,St.m_patientName=this.m_dicomInfo.m_patientName,St.m_studyDescr=this.m_dicomInfo.m_studyDescr,St.m_studyDate=this.m_dicomInfo.m_studyDate,St.m_seriesTime=this.m_dicomInfo.m_seriesTime,St.m_seriesDescr=this.m_dicomInfo.m_seriesDescr,St.m_bodyPartExamined=this.m_dicomInfo.m_bodyPartExamined,St.m_institutionName=this.m_dicomInfo.m_institutionName,St.m_operatorsName=this.m_dicomInfo.m_operatorsName,St.m_physicansName=this.m_dicomInfo.m_physicansName,St.buildHash(),St.m_xDim=this.m_xDim,St.m_yDim=this.m_yDim;var yt=St.m_image,xt=new DataView(d.m_value);if(null===xt)return console.log("No memory"),ui.ERROR_NO_MEMORY;var bt;if(8===this.m_bitsPerPixel){if(1===this.m_samplesPerPixel)for(bt=0;bt<gt;bt++){var Dt=xt.getUint8(bt);yt[bt]=Dt}else if(3===this.m_samplesPerPixel){var Tt=0;for(bt=0;bt<gt;bt++,Tt+=3){var Et=xt.getUint8(Tt+0),Mt=xt.getUint8(Tt+1),wt=xt.getUint8(Tt+2);yt[bt]=Math.floor((Et+Mt+wt)/3)}}}else if(16===this.m_bitsPerPixel){var Rt=0;for(bt=0;bt<gt;bt++){var kt=xt.getUint16(Rt,this.m_littleEndian);Rt+=2,yt[bt]=kt}}else console.log("TODO: need to implement reading non-8 and non-16 bit dicom images");return this.m_error=0,this.m_slicesVolume.addSlice(St),void 0!==n&&n(ui.SUCCESS),ui.SUCCESS}},{key:"readFromUrl",value:function(e,t,i,a){var o=this;console.assert(null!=e,"Null volume"),console.assert(e instanceof Oa,"Should be volume set"),console.assert(null!=t,"Null string url"),console.assert("string"===typeof t,"Should be string in url");var r=new Ai;if(!r.isValidUrl(t))return console.log("readFromUrl: not vaild URL = = ".concat(t," ")),!1;this.m_folder=r.getFolderNameFromUrl(t);var n=this.m_folder+"/file_list.txt";console.log("readFromUrl: load file = ".concat(n," "));var s=new di(n);return this.m_callbackComplete=a,this.m_callbackProgress=i,this.m_fileListCounter=0,s.readFile((function(t){return o.m_fileListCounter+=1,1!==o.m_fileListCounter||o.readReadyFileList(e,t,i,a)}),(function(e){return console.log("Error read file: ".concat(e)),a(ui.ERROR_CANT_OPEN_URL,null,0,null),!1})),!0}},{key:"readReadyFileList",value:function(e,t,i,a){console.assert(null!=e,"Null volume"),console.assert(e instanceof Oa,"Should be volume set"),console.assert(null!=t,"Null array"),console.assert("ArrayBuffer"===t.constructor.name,"Should be ArrayBuf in arrBuf");var o=new Uint8Array(t),r=String.fromCharCode.apply(null,o),n=r.substr(0,64);console.log("Loaded file list. Started with:  ".concat(n," ..."));for(var s=r.split("\n"),l=s.length,m=l-1;m>=0;m--)s[m].endsWith("\r")&&(s[m]=s[m].substring(0,s[m].length-1)),s[m].length<4&&s.pop();l=s.length,this.m_zDim=l,console.log("Loaded file list. ".concat(l," files will be loaded. 1st file in list is = ").concat(s[0])),console.log("Loaded file list. Last file in list is = ".concat(s[l-1]));for(var h=0;h<l;h++)this.m_errors[h]=-1,this.m_loaders[h]=null;this.m_pixelSpacing={x:0,y:0,z:0},this.m_filesLoadedCounter=0,this.m_numFailsLoad=0,this.m_numLoadedFiles=l,this.m_imagePosMin={x:1e12,y:1e12,z:1e12},this.m_imagePosMax={x:-1e12,y:-1e12,z:-1e12},this.m_sliceLocMin=1e12,this.m_sliceLocMax=-1e12;for(var u=0;u<this.m_numLoadedFiles&&this.m_numFailsLoad<1;u++){var c="".concat(this.m_folder,"/").concat(s[u]);this.m_loaders[u]=new di(c);var d=this.m_loaders[u];if(!this.runLoader(e,s[u],d,u,i,a,!1))return!1}return!0}},{key:"runLoader",value:function(e,t,i,a,o,r,n){var s=this;return this.m_fromGoogle=n,i.readFile((function(i){var n,l=s.m_filesLoadedCounter/s.m_numLoadedFiles;if(void 0!==o&&0===(7&s.m_filesLoadedCounter)&&o(l),void 0!==o&&s.m_filesLoadedCounter+1===s.m_numLoadedFiles&&o(1),s.m_newTagEvent.detail.fileName=t,(n=s.m_fromGoogle?s.readFromGoogleBuffer(a,t,l,i,o,r):s.readFromBuffer(a,t,l,i,o,r))!==ui.SUCCESS&&0===s.m_numFailsLoad&&(s.m_numFailsLoad+=1,null!==r))return r(n,null,0,null,t),!1;if(s.m_filesLoadedCounter+=1,s.m_filesLoadedCounter===s.m_numLoadedFiles){Ci;var m,h={x:s.m_imagePosMax.x-s.m_imagePosMin.x,y:s.m_imagePosMax.y-s.m_imagePosMin.y,z:s.m_imagePosMax.z-s.m_imagePosMin.z},u=1e-5;Math.abs(s.m_pixelSpacing.z)>u?m=s.m_pixelSpacing.z*s.m_zDim:(m=h.z,Math.abs(m)<u&&(m=h.x,Math.abs(m)<u&&(m=h.y))),m<u&&(m=1),s.m_pixelSpacing.z=m/s.m_zDim,s.m_boxSize.z=s.m_zDim*s.m_pixelSpacing.z,s.m_boxSize.x=s.m_xDim*s.m_pixelSpacing.x,s.m_boxSize.y=s.m_yDim*s.m_pixelSpacing.y,console.log("Volume local phys dim: ".concat(s.m_boxSize.x," * ").concat(s.m_boxSize.y," * ").concat(s.m_boxSize.z));var c=s.m_slicesVolume.getSeries();0===c.length&&(s.m_slicesVolume.buildSeriesInfo(),c=s.m_slicesVolume.getSeries());var d=c[0].m_hash,_=s.createVolumeFromSlices(e,0,d);if(null!==r)return r(_),!0}return!0}),(function(e){return console.log("Error read file: ".concat(e)),!1})),!0}}],[{key:"getVrsStringIndex",value:function(e){for(var t=["AE","AS","AT","CS","DA","DS","DT","FL","FD","IS","LO","LT","OB","OD","OF","OW","PN","SH","SL","SS","ST","TM","UI","UL","UN","US","UT"],i=t.length,a=0;a<i;a++)if(t[a]===e)return a;return-1}},{key:"getDataVrsStringIndex",value:function(e){for(var t=["OB","OW","OF","SQ","UT","UN"],i=t.length,a=0;a<i;a++)if(t[a]===e)return a;return-1}},{key:"getStringAt",value:function(e,t,i){for(var a="",o=0;o<i;o++){var r=e.getUint8(t+o);0!==r&&(a+=String.fromCharCode(r))}return a}},{key:"getUtf8StringAt",value:function(e,t,i){for(var a="",o=0;o<i;){var r=e.getUint8(t+o);switch(o++,94==r&&(r=32),r>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a+=String.fromCharCode(r);break;case 12:case 13:var n=e.getUint8(t+o);o++,a+=String.fromCharCode((31&r)<<6|63&n);break;case 14:var s=e.getUint8(t+o);o++;var l=e.getUint8(t+o);o++,a+=String.fromCharCode((15&r)<<12|(63&s)<<6|(63&l)<<0)}}return a}},{key:"getAttrValueAsString",value:function(t){if(null===t.m_value)return"SQ"===t.m_vr?"(Sequence Data)":null;var i=new DataView(t.m_value),a=null,o=null,r=0;switch(t.m_vr){case"AE":return e.getStringAt(i,0,t.m_value.byteLength);case"AS":switch(a=e.getStringAt(i,0,t.m_value.byteLength),o=Number(a.slice(0,3)).toString(),a[3]){case"D":return"".concat(o," days");case"W":return"".concat(o," weeks");case"M":return"".concat(o," months");case"Y":return"".concat(o," years");default:return null}case"CS":return e.getStringAt(i,0,t.m_value.byteLength);case"DA":return a=e.getStringAt(i,0,t.m_value.byteLength),new Date("".concat(a.slice(0,4),"-").concat(a.slice(4,6),"-").concat(a.slice(6,8))).toLocaleDateString();case"DS":case"DT":return e.getStringAt(i,0,t.m_value.byteLength);case"FL":for(o=i.getFloat32(0,t.m_littleEndian).toString(),r=4;r+4<=i.byteLength;)o="".concat(o," \\ ").concat(i.getFloat32(r,t.m_littleEndian).toString()),r+=4;return o;case"FD":for(o=i.getFloat64(0,t.m_littleEndian).toString(),r=8;r+4+4<=i.byteLength;)o="".concat(o," \\ ").concat(i.getFloat64(r,t.m_littleEndian).toString()),r+=8;return o;case"IS":case"LO":case"LT":case"PN":case"SH":return e.getStringAt(i,0,t.m_value.byteLength);case"SL":for(o=i.getInt32(0,t.m_littleEndian).toString(),r=4;r+2<=i.byteLength;)o="".concat(o," \\ ").concat(i.getInt16(r,t.m_littleEndian).toString()),r+=4;return o;case"SS":for(o=i.getInt16(0,t.m_littleEndian).toString(),r=2;r+2<=i.byteLength;)o="".concat(o," \\ ").concat(i.getInt16(r,t.m_littleEndian).toString()),r+=2;return o;case"ST":return e.getStringAt(i,0,t.m_value.byteLength);case"TM":return a=e.getStringAt(i,0,t.m_value.byteLength),t.m_value.byteLength>=2&&(o="".concat(Number(a.slice(0,2)),"h")),t.m_value.byteLength>=4&&(o="".concat(o," ").concat(Number(a.slice(2,4)),"m")),t.m_value.byteLength>4&&(o="".concat(o," ").concat(parseFloat(a.slice(4,t.m_value.byteLength)),"s")),o;case"UI":return e.getStringAt(i,0,t.m_value.byteLength);case"UL":for(o=i.getUint32(0,t.m_littleEndian).toString(),r=4;r+4<=i.byteLength;)o="".concat(o," \\ ").concat(i.getUint32(r,t.m_littleEndian).toString()),r+=4;return o;case"US":for(o=i.getUint16(0,t.m_littleEndian).toString(),r=2;r+2<=i.byteLength;)o="".concat(o," \\ ").concat(i.getUint16(r,t.m_littleEndian).toString()),r+=2;return o;case"UT":return e.getStringAt(i,0,t.m_value.byteLength);default:return null}}},{key:"numberToHexString",value:function(e){for(var t=e.toString(16),i=4-t.length,a="",o=0;o<i;o++)a+="0";return"0x"+a+t}}]),e}(),Ra=function(){function e(){Object(v.a)(this,e),this.m_file=null,this.m_reader=null,this.m_request=null}return Object(p.a)(e,[{key:"readLocal",value:function(e){var t=this;return new Promise((function(i){t.m_file=e,t.m_reader=new FileReader,t.m_reader.addEventListener("load",(function(e){var t=e.target.result;i&&i(t)})),t.m_reader.readAsArrayBuffer(t.m_file)}))}},{key:"readFromUrl",value:function(e){var t=this;return new Promise((function(i,a){t.m_url=e,t.m_request=null;if(t.m_request=new XMLHttpRequest,!("withCredentials"in t.m_request))return t.m_request=null,void console.log("This browser cant support CORS requests");t.m_request.open("GET",t.m_url,!0),t.m_request.responseType="arraybuffer",t.m_request.addEventListener("load",(function(e){var t=e.target.response;null===t?console.log("Bad response type. Expect object type in response."):i(t)}),!1),t.m_request.addEventListener("error",(function(e){var t="Error event happend for XMLHttpRequest: loaded = ".concat(e.loaded,", total = ").concat(e.total);console.log(t),a(t)}),!1),t.m_request.send()}))}}]),e}(),ka=function(){function e(){Object(v.a)(this,e)}return Object(p.a)(e,[{key:"readFromBufferHeader",value:function(t,i,a,o){console.assert(null!=t,"Null volume"),console.assert(t instanceof _e,"Should be volume"),console.assert(null!=i,"Null array"),console.assert("ArrayBuffer"===i.constructor.name,"Should be ArrayBuf in arrBuf");var r=new Uint8Array(i);if(348!==r.length)return o&&o(ui.WRONG_HEADER_DATA_SIZE,null,0,null),!1;var n=0,s=e.readIntFromBuffer(r,n);if(n+=4,348!==s)return console.log("Hdr first int wrong: ".concat(s,", but should be ").concat(348)),o&&o(ui.BAD_HEADER,null,0,null),!1;var l=e.getStringAt(r,n,10);if(n+=10,t.m_dataType=0,"CHAR"===l&&(t.m_dataType=2,t.m_bytesPerVoxel=1),"SHORT"===l&&(t.m_dataType=4,t.m_bytesPerVoxel=2),0===t.m_dataType)return console.log("Hdr wrong data type. Should be CHAR or SHORT, but found: ".concat(l)),o&&o(ui.BAD_HEADER,null,0,null),!1;console.log("Hdr read data type = ".concat(l));n+=18;var m=e.readIntFromBuffer(r,n);n+=4;if(16384!==m)return console.log("Hdr wrong extents in header. Should be ".concat(16384,", but found: ").concat(m)),o&&o(ui.BAD_HEADER,null,0,null),!1;n+=2;var h=e.readByteFromBuffer(r,n);n+=1;if(114!==h)return console.log("Hdr wrong regular in header. Should be ".concat(114,", but found: ").concat(h)),o&&o(ui.BAD_HEADER,null,0,null),!1;n+=1,n+=2;var u=e.readShortFromBuffer(r,n);n+=2;var c=e.readShortFromBuffer(r,n);n+=2;var d=e.readShortFromBuffer(r,n);n+=2,t.m_xDim=u,t.m_yDim=c,t.m_zDim=d,console.log("HDR: volume dim = ".concat(t.m_xDim," * ").concat(t.m_yDim," * ").concat(t.m_zDim," "));n+=8;n+=4;n+=8,n+=2;var _=e.readShortFromBuffer(r,n);if(n+=2,2===t.m_dataType&&2!==_)return console.log("Wrong data tye for char typed header"),!1;if(4===t.m_dataType&&4!==_)return console.log("Wrong data tye for signed short typed header"),!1;var f=e.readShortFromBuffer(r,n);if(n+=2,2===t.m_dataType&&8!==f)return console.log("Wrong bits pix for char typed header"),!1;if(4===t.m_dataType&&16!==f)return console.log("Wrong bits pix for word typed header"),!1;n+=2,n+=4;var v=e.readFloatFromBuffer(r,n);n+=4;var p=e.readFloatFromBuffer(r,n);n+=4;var g=e.readFloatFromBuffer(r,n);n+=4;return n+=16,t.m_boxSize.x=t.m_xDim*v,t.m_boxSize.y=t.m_yDim*p,t.m_boxSize.z=t.m_zDim*g,console.log("HDR: physic size = ".concat(t.m_boxSize.x," * ").concat(t.m_boxSize.y," * ").concat(t.m_boxSize.z," ")),!0}},{key:"readFromBufferImage",value:function(e,t,i,a){console.assert(null!=e,"Null volume"),console.assert(e instanceof _e,"Should be volume"),console.assert(null!=t,"Null array"),console.assert("ArrayBuffer"===t.constructor.name,"Should be ArrayBuf in arrBuf");var o=new Uint8Array(t).length;return o<8?(a&&a(ui.ERROR_TOO_SMALL_DATA_SIZE,null,0,null),!1):o>=241172480?(a&&a(ui.ERROR_TOO_LARGE_DATA_SIZE,null,0,null),!1):(e.m_imageBufferSize=o,e.m_arrBuf=t,console.log("readFromBufferImage complete with ".concat(o," bytes in image ")),!0)}},{key:"createVolumeFromHeaderAndImage",value:function(e){console.assert(null!=e,"Null volume"),console.assert(e instanceof _e,"Should be volume");var t=0;2===e.m_dataType&&(t=1),4===e.m_dataType&&(t=2);var i=e.m_xDim*e.m_yDim*e.m_zDim,a=i*t;if(a!==e.m_imageBufferSize)return console.log("HDR: wrong IMG data size. Read: ".concat(e.m_imageBufferSize,", but expected ").concat(a," ")),!1;var o=e.m_arrBuf;if(4===e.m_dataType){var r,n=new Uint16Array(o);e.m_dataArray=new Uint8Array(i);var s=0;for(r=0;r<i;r++)s=n[r]>s?n[r]:s;s++;for(r=0;r<i;r++)e.m_dataArray[r]=Math.floor(255*n[r]/s)}else if(2===e.m_dataType){var l=new Uint8Array(o);e.m_dataArray=l}return e.m_bytesPerVoxel=1,e.m_dataSize=e.m_imageBufferSize,!0}},{key:"createRoiVolumeFromHeaderAndImage",value:function(e,t){console.assert(null!=e,"Null volume"),console.assert(e instanceof _e,"Should be volume"),console.assert(null!=t,"Null volume"),console.assert(t instanceof _e,"Should be volume");if(1!==e.m_bytesPerVoxel)return console.log("createRoiVolumeFromHeaderAndImage: bad volDst. m_bytesPerVoxel should be 1"),!1;if(1!==t.m_bytesPerVoxel)return console.log("createRoiVolumeFromHeaderAndImage: bad volRoi"),!1;if(e.m_xDim!==t.m_xDim||e.m_yDim!==t.m_yDim||e.m_zDim!==t.m_zDim)return console.log("createRoiVolumeFromHeaderAndImage: different volumes sizes"),!1;for(var i=e.m_xDim*e.m_yDim*e.m_zDim,a=new Uint8Array(4*i),o=t.m_arrBuf,r=new Uint8Array(o),n=0,s=0;s<i;s++,n+=4)a[n+0]=e.m_dataArray[s],a[n+1]=0,a[n+2]=0,a[n+3]=r[s];e.m_dataArray=a;return e.m_bytesPerVoxel=4,console.log("createRoiVolumeFromHeaderAndImage: success"),!0}},{key:"readFromUrl",value:function(e,t,i,a){console.log("readFromUrl. going to read from ".concat(t," ..."));var o=new Ai;if(!o.isValidUrl(t))return console.log("readFromUrl: not vaild URL = = ".concat(t," ")),!1;this.m_folder=o.getFolderNameFromUrl(t);var r=o.getFileNameFromUrl(t),n=/(\w+)_intn.(h|hdr)/.exec(r);if(3!==n.length)return console.log("LoaderHdr.readFromUrl: bad URL name = ".concat(t,". Should be in template NNN_intn.h ")),!1;var s=n[1],l=this.m_folder+"/"+s+"_intn.h",m=this.m_folder+"/"+s+"_intn.img",h=this.m_folder+"/"+s+"_mask.h",u=this.m_folder+"/"+s+"_mask.img",c=[];return c.push(l),c.push(m),c.push(h),c.push(u),this.readFromUrls(c,e,i,a)}},{key:"readFromUrls",value:function(e,t,i,a){var o=this;console.assert(null!=t,"Null volume set"),console.assert(t instanceof Oa,"Should be volume set");var r=e.length;if(2===r){var n=e[0],s=e[1],l=new Ra,m=new Ra,h=n.indexOf(".h");if(-1===h&&(h=n.indexOf(".hdr")),-1===h){var u=n;n=s,s=u}var c=t.getVolume(0);l.readFromUrl(n).then((function(e){o.readFromBufferHeader(c,e,a,i),console.log("Load success HDR file: ".concat(n)),m.readFromUrl(s).then((function(e){o.readFromBufferImage(c,e,a,i),console.log("Load success IMG file: ".concat(s)),o.createVolumeFromHeaderAndImage(c),a(ui.SUCCESS)}))}),(function(e){return console.log("HDR File read error",e),a(ui.ERROR_CANT_OPEN_URL,null,0,null),!1}))}else{if(4!==r)return console.log("Error read hdr files. Should be ".concat(2," files")),!1;var d=e[0],_=e[1],f=e[2],v=e[3],p=new Ra,g=new Ra,S=new Ra,y=new Ra,x=new _e,b=t.getVolume(0);p.readFromUrl(d).then((function(e){o.readFromBufferHeader(b,e,a,i),console.log("Load success HDR file: ".concat(d)),g.readFromUrl(_).then((function(e){o.readFromBufferImage(b,e,a,i),console.log("Load success IMG file: ".concat(_)),S.readFromUrl(f).then((function(e){o.readFromBufferHeader(x,e,a,i),y.readFromUrl(v).then((function(e){o.readFromBufferImage(x,e,a,i),o.createVolumeFromHeaderAndImage(b),o.createRoiVolumeFromHeaderAndImage(b,x),a(ui.SUCCESS)}))}))}))}),(function(e){return console.log("HDR File read error",e),!1}))}return!0}}],[{key:"readByteFromBuffer",value:function(e,t){return e[t]}},{key:"readIntFromBuffer",value:function(e,t){return e[t+0]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24}},{key:"readShortFromBuffer",value:function(e,t){return e[t+0]|e[t+1]<<8}},{key:"readFloatFromBuffer",value:function(e,t){var i=new ArrayBuffer(4),a=new DataView(i);a.setUint8(0,e[t+0]),a.setUint8(1,e[t+1]),a.setUint8(2,e[t+2]),a.setUint8(3,e[t+3]);return a.getFloat32(0,!0)}},{key:"getStringAt",value:function(e,t,i){for(var a="",o=0;o<i;o++){var r=e[t+o];if(0===r)break;a+=String.fromCharCode(r)}return a}}]),e}(),Oa=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).m_numVolumes=0,a.m_volumes=[],a.m_patientName="",a.m_patientBirth="",a.m_seriesDescr="",a.m_studyDescr="",a.m_studyDate="",a.m_seriesTime="",a.m_bodyPartExamined="",a.m_institutionName="",a.m_operatorsName="",a.m_physicansName="",a}return Object(p.a)(i,[{key:"addVolume",value:function(e){console.assert(e instanceof _e,"VolumeSet.addVolume: arg must be Volume"),this.m_volumes.push(e),this.m_numVolumes++}},{key:"getNumVolumes",value:function(){return this.m_numVolumes}},{key:"getVolume",value:function(e){return console.assert(Number.isInteger(e),"VolumeSet.getVolume: arg must be number"),console.assert(e<this.m_numVolumes,"index of volume should be in range"),console.assert(e>=0,"index of volume should be non negative"),e<0||e>=this.m_numVolumes?null:this.m_volumes[e]}},{key:"render",value:function(){return o.a.createElement("p",null,">")}},{key:"readFromKtx",value:function(e,t,i){console.assert(null!=e),console.assert("ArrayBuffer"===e.constructor.name,"Should be ArrayBuf in arrBuf");var a=new pi,o=this.getVolume(0);return a.readFromBuffer(o,e,t,i)}},{key:"readFromKtxUrl",value:function(e,t,i){var a=new pi,o=this.getVolume(0);a.readFromUrl(o,e,t,i)}},{key:"readFromNiiUrl",value:function(e,t,i){var a=new gi,o=this.getVolume(0);return a.readFromUrl(o,e,t,i)}},{key:"readFromDicomUrl",value:function(e,t,i){return new wa(0).readFromUrl(this,e,t,i)}},{key:"readFromHdrUrl",value:function(e,t,i){return(new ka).readFromUrl(this,e,t,i)}},{key:"readFromNifti",value:function(e,t,i){var a=new gi,o=this.getVolume(0);return a.readFromBuffer(o,e,t,i)}},{key:"readFromDicom",value:function(e,t,i,a){return e.readFromBuffer(0,"file???",0,t,i,a)}},{key:"readSingleSliceFromDicom",value:function(e,t,i,a,o,r,n){return e.readFromBuffer(t,i,a,o,r,n)}}]),i}(o.a.Component),Aa=i(198),Ca=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onModalShow=a.onModalShow.bind(Object(y.a)(a)),a.onModalHide=a.onModalHide.bind(Object(y.a)(a)),a.onButton0=a.onButton0.bind(Object(y.a)(a)),a.onButton1=a.onButton1.bind(Object(y.a)(a)),a.onButton2=a.onButton2.bind(Object(y.a)(a)),a.onButton3=a.onButton3.bind(Object(y.a)(a)),a.onButton4=a.onButton4.bind(Object(y.a)(a)),a.onButton5=a.onButton5.bind(Object(y.a)(a)),a.onButton6=a.onButton6.bind(Object(y.a)(a)),a.onButton7=a.onButton7.bind(Object(y.a)(a)),a.onDemo=a.onDemo.bind(Object(y.a)(a)),a.state={showModalDemo:!1},a}return Object(p.a)(i,[{key:"onModalShow",value:function(){this.setState({showModalDemo:!0})}},{key:"onModalHide",value:function(){this.setState({showModalDemo:!1})}},{key:"onDemo",value:function(e){var t=this.props.onSelectDemo;(0,this.props.onHide)(),t(e)}},{key:"onButton0",value:function(){this.onDemo(0)}},{key:"onButton1",value:function(){this.onDemo(1)}},{key:"onButton2",value:function(){this.onDemo(2)}},{key:"onButton3",value:function(){this.onDemo(3)}},{key:"onButton4",value:function(){this.onDemo(4)}},{key:"onButton5",value:function(){this.onDemo(5)}},{key:"onButton6",value:function(){this.onDemo(6)}},{key:"onButton7",value:function(){this.onDemo(7)}},{key:"render",value:function(){var e=this.props.stateVis,t=this.props.onHide,i=[{tooltip:"Lungs 20101108 from ktx",image:"images/thumb_lungs.png",alt:"lungs",func:this.onButton0},{tooltip:"Brain set from ktx",image:"images/thumb_brain.png",alt:"lungs",func:this.onButton1},{tooltip:"Grandmother (gm3) from nifti",image:"images/thumb_gm3_512_512_165.png",alt:"gm3",func:this.onButton2},{tooltip:"Woman pelvis from dicom",image:"images/thumb_woman_pelvis.png",alt:"woman_pelvis",func:this.onButton3},{tooltip:"Lungs 00cba...957e from dicom",image:"images/thumb_ocb.png",alt:"lungs_ocb",func:this.onButton4},{tooltip:"CT 256^3 from ktx",image:"images/thumb_ct_256.png",alt:"ct_256",func:this.onButton5},{tooltip:"Lungs 256^3 from ktx",image:"images/thumb_lungs_256.png",alt:"lungs_256",func:this.onButton6},{tooltip:"Brain with ROI (colored) from Hdr+Img",image:"images/thumb_set.png",alt:"hdr_set_roi",func:this.onButton7}];return o.a.createElement(oi.a,{show:e,onHide:t},o.a.createElement(oi.a.Header,{closeButton:!0},o.a.createElement(oi.a.Title,null,"Load demo data")),o.a.createElement(oi.a.Body,null,o.a.createElement(T.a,null,o.a.createElement(x.a,null,i.map((function(e,t){var i="id_".concat(t),a=e.tooltip,r=e.image,n=e.alt,s=e.func;return o.a.createElement(b.a,{xs:6,md:4,key:i},o.a.createElement(C.a,{placement:"top",delay:{show:150,hide:300},overlay:o.a.createElement(I.a,{id:i},a)},o.a.createElement(A.a,{variant:"light",onClick:s},o.a.createElement(Aa.a,{src:r,alt:n,thumbnail:!0}))))}))))))}}]),i}(o.a.Component),Ia=Object(s.b)((function(e){return e}))(Ca),Fa=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onModalShow=a.onModalShow.bind(Object(y.a)(a)),a.onModalHide=a.onModalHide.bind(Object(y.a)(a)),a.onClick=a.onClick.bind(Object(y.a)(a)),a.onDemo=a.onDemo.bind(Object(y.a)(a)),a.state={showModalDemo:!1},a}return Object(p.a)(i,[{key:"onModalShow",value:function(){this.setState({showModalDemo:!0})}},{key:"onModalHide",value:function(){this.setState({showModalDemo:!1})}},{key:"onDemo",value:function(e){var t=this.props.onSelectDemo;(0,this.props.onHide)(),t(e)}},{key:"logObject",value:function(e,t){var i="";for(var a in t)i.length>0&&(i+="\n"),i+=a+" = "+t[a];console.log("".concat(e,"\n").concat(i))}},{key:"onClick",value:function(e){this.m_onHideFunc();var t=e.target.innerHTML,a=i.getIndex(this.m_arrMenu,t);a>=0&&void 0!==this.m_funcDemo&&this.m_funcDemo(a)}},{key:"render",value:function(){var e=this,t=this.props.arrMenu;this.m_arrMenu=t;var i=this.props.stateVis;return this.m_onHideFunc=this.props.onHide,this.m_funcDemo=this.props.onSelectDemo,o.a.createElement(oi.a,{show:i,onHide:this.m_onHideFunc},o.a.createElement(oi.a.Header,{closeButton:!0},o.a.createElement(oi.a.Title,null,"Load from Google cloud")),o.a.createElement(oi.a.Body,null,o.a.createElement(he.a,null,t.map((function(t,i){var a="id_".concat(i),r=t.tooltip;return o.a.createElement(C.a,{key:a,placement:"top",delay:{show:150,hide:300},overlay:o.a.createElement(I.a,{id:a},r)},o.a.createElement(he.a.Item,{key:a,onClick:e.onClick},t.text))})))))}}],[{key:"getIndex",value:function(e,t){for(var i=e.length,a=0;a<i;a++)if(e[a].text===t)return a;return-1}}]),i}(o.a.Component),Pa=Object(s.b)((function(e){return e}))(Fa),Ua=1073741823,Xa=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).m_objCanvas=null,a.m_dataMin=Ua,a.m_dataMax=Ua,a.onButtonCancel=a.onButtonCancel.bind(Object(y.a)(a)),a.onButtonApply=a.onButtonApply.bind(Object(y.a)(a)),a.state={showModalWindowCenterWidth:!1,windowMin:-350,windowMax:1650},a}return Object(p.a)(i,[{key:"onModalHide",value:function(){this.setState({showModalWindowCenterWidth:!1})}},{key:"reset",value:function(){this.m_dataMin=Ua,this.m_dataMax=Ua,this.setState({windowMin:-350}),this.setState({windowMax:1650})}},{key:"onButtonCancel",value:function(){this.reset(),(0,this.props.onHide)(!1)}},{key:"onButtonApply",value:function(){this.reset();var e=this.props,t=e.loaderDicom,i=e.volumeSet;t.m_windowCenter=.5*(this.state.windowMin+this.state.windowMax),t.m_windowWidth=this.state.windowMax-this.state.windowMin;for(var a=t.m_slicesVolume.getSeries(),o=a.length,r=0;r<o;r++){var n=a[r].m_hash;t.createVolumeFromSlices(i,r,n)}(0,this.props.onHide)(!0)}},{key:"componentDidMount",value:function(){this.props.onRef(this),this.renderPreview()}},{key:"componentWillUnmount",value:function(){this.props.onRef(void 0)}},{key:"componentDidUpdate",value:function(){this.renderPreview()}},{key:"drawSlice",value:function(e,t,i,a,o,r,n){for(var s=r[0].m_slices,l=s.length,m=s[0].m_sliceNumber,h=s[0].m_sliceNumber,u=0;u<l;u++){var c=s[u].m_sliceNumber;m=c<m?c:m,h=c>h?c:h}h-m>0?s.sort((function(e,t){return e.m_sliceNumber-t.m_sliceNumber})):s.sort((function(e,t){return e.m_sliceLocation-t.m_sliceLocation}));for(var d=0,_=0;_<l;_++)s[_].m_sliceNumber=d,d++;n.m_zDim=l;var f,v=s[Math.floor(l/2)],p=v.m_image,g=v.m_xDim,S=v.m_yDim,y=-1073741823,x=1073741823,b=g*S;for(f=0;f<b;f++){var D=p[f];if(!n.m_littleEndian)D=D>>8|D<<8&65535;var T=(D=D===n.m_padValue?0:D)*n.m_rescaleSlope+n.m_rescaleIntercept;x=T<x?T:x,y=T>y?T:y}var E=this.state.windowMin,M=this.state.windowMax,w=Math.floor(.5*(M+E)),R=M-E;if(Math.floor((1<<19)/(y-x))<=4)console.log("Bad scaling: image will be 0");else{var k=new Uint8Array(b),O=w-.5*R;for(f=0;f<b;f++){var A=p[f];if(!n.m_littleEndian)A=A>>8|A<<8&65535;var C=(A=A===n.m_padValue?0:A)*n.m_rescaleSlope+n.m_rescaleIntercept,I=0;I=(I=(I=n.m_rescaleHounsfield?Math.floor(255*(C-O)/R):Math.floor(127+128*(C-w)/(R/2)))>=0?I:0)<255?I:255,k[0+f]=I}for(var F=0,P=g/t,U=S/i,X=0,z=0;z<i;z++,X+=U)for(var L=Math.floor(X)*g,N=0,V=0;V<t;V++,N+=P){var B=k[0+L+Math.floor(N)];o[F+0]=B,o[F+1]=B,o[F+2]=B,o[F+3]=255,F+=4}e.putImageData(a,0,0)}}},{key:"renderPreview",value:function(){var e=this.m_objCanvas;if(null!==e){var t=e.clientWidth,i=e.clientHeight,a=e.getContext("2d"),o=this.props;a.fillStyle="rgb(40, 40, 40)",a.fillRect(0,0,t,i);var r=a.createImageData(t,i),n=r.data,s=o.loaderDicom;if(null!==s){var l=s.m_slicesVolume.m_series;0!==l.length&&this.drawSlice(a,t,i,r,n,l,s)}}}},{key:"onSliderWindowRange",value:function(){var e=this.refs.sliderRange.slider.get(),t=parseInt(e[0]),i=parseInt(e[1]);this.setState({windowMin:t}),this.setState({windowMax:i})}},{key:"getDataMinMax",value:function(e,t){var i=t.m_slicesVolume.m_series;if(0!==i.length){var a,o=i[0].m_slices[0],r=o.m_image,n=-1073741823,s=1073741823,l=o.m_xDim*o.m_yDim;for(a=0;a<l;a++){var m=r[a];if(!t.m_littleEndian)m=m>>8|m<<8&65535;var h=(m=m===t.m_padValue?0:m)*t.m_rescaleSlope+t.m_rescaleIntercept;s=h<s?h:s,n=h>n?h:n}this.m_dataMin=s,this.m_dataMax=n}}},{key:"initWindowRange",value:function(){var e=this.props,t=e.loaderDicom;if(null!==t){var i=!0;if(i=t.m_windowCenter!==Ua&&i,i=t.m_windowWidth!==Ua&&i,i=!(t.m_windowWidth<=0)&&i){var a=Math.floor(t.m_windowCenter-t.m_windowWidth/2),o=Math.floor(t.m_windowCenter+t.m_windowWidth/2);this.setState({windowMin:a}),this.setState({windowMax:o})}this.getDataMinMax(e,t)}}},{key:"render",value:function(){var e=this,t=this.props.stateVis,i=this.props.onHide,a=o.a.createElement("canvas",{ref:function(t){e.m_objCanvas=t},style:{width:"500px",height:"400px"},width:"500px",height:"400px"}),r=0,n=5e3,s=n-r,l=50;this.m_dataMin!==Ua&&(r=this.m_dataMin,s=(n=this.m_dataMax)-r,l=Math.floor(s/32));var m={min:Math.floor(r-s/4),max:Math.floor(n+s/4)},h=[Math.floor(this.state.windowMin),Math.floor(this.state.windowMax)];return o.a.createElement(oi.a,{show:t,onHide:i,size:"xl"},o.a.createElement(oi.a.Header,{closeButton:!0},o.a.createElement(oi.a.Title,null,"Select window center and width to display Dicom")),o.a.createElement(oi.a.Body,null,o.a.createElement(T.a,null,o.a.createElement(x.a,null,o.a.createElement(b.a,{xs:!0,md:!0,lg:"12",ref:function(t){e.m_objCol=t}},o.a.createElement("p",{className:"text-center"},a))),o.a.createElement(he.a,null,o.a.createElement(he.a.Item,null,"Window range ",o.a.createElement("p",null," ")),o.a.createElement(he.a.Item,null,o.a.createElement(P.a,{onSlide:this.onSliderWindowRange.bind(this),ref:"sliderRange",range:m,start:h,step:l,connect:!0,tooltips:!0}))),o.a.createElement(x.a,null,o.a.createElement(b.a,{xs:!0,md:!0,lg:"5"}),o.a.createElement(b.a,{xs:!0,md:!0,lg:"2"},o.a.createElement(A.a,{onClick:this.onButtonApply},"Apply")),o.a.createElement(b.a,{xs:!0,md:!0,lg:"5"})))))}}]),i}(o.a.Component),za=Object(s.b)((function(e){return e}))(Xa),La=function(){function e(t){Object(v.a)(this,e),this.m_store=t,this.m_arrFileNames=null,this.m_errors=[],this.m_loaders=[],this.m_loaderDicom=null,this.callbackReadProgress=this.callbackReadProgress.bind(this),this.callbackReadComplete=this.callbackReadComplete.bind(this),this.m_fileName="???"}return Object(p.a)(e,[{key:"callbackReadProgress",value:function(e){var t=Math.floor(100*e),i=this.m_store.uiApp;0===t&&i.doShowProgressBar("Loading..."),t>=99?i.doHideProgressBar():i.doSetProgressBarRatio(t)}},{key:"callbackReadComplete",value:function(e){if(e!==ui.SUCCESS){console.log("onCompleteFromUrlKtx. Bad result: ".concat(e));var t=[],i=ui.getResultString(e);return t.push(i),void this.finalizeFailedLoadedVolume(this.m_volume,this.m_fileName,t)}this.finalizeSuccessLoadedVolume(this.m_volume,this.m_fileName)}},{key:"finalizeFailedLoadedVolume",value:function(e,t,i){var a=this.m_store;a.dispatch({type:m.SET_IS_LOADED,isLoaded:!1}),a.dispatch({type:m.SET_VOLUME,volume:null}),a.dispatch({type:m.SET_ERR_ARRAY,arrErrors:i}),a.dispatch({type:m.SET_FILENAME,fileName:t}),a.uiApp.doHideProgressBar()}},{key:"finalizeSuccessLoadedVolume",value:function(e,t){if(null!==e.m_dataArray){e.makeDimensions4x();var i=this.m_store;i.dispatch({type:m.SET_VOLUME,volume:e}),i.dispatch({type:m.SET_IS_LOADED,isLoaded:!0}),i.dispatch({type:m.SET_FILENAME,fileName:t}),i.dispatch({type:m.SET_ERR_ARRAY,arrErrors:[]});var a=new de;a.createFromRawVolume(e),i.dispatch({type:m.SET_TEXTURE3D,texture3d:a}),i.dispatch({type:m.SET_MODE_VIEW,modeView:h.VIEW_2D}),i.dispatch({type:m.SET_MODE_3D,mode3d:c.RAYCAST})}}},{key:"loadFromUrlArray",value:function(e,t){void 0===e&&console.log("LoaderUrlDicom: no argument in constr");var i=typeof e;"object"!==i&&console.log("LoaderUrlDicom: bad argument type: ".concat(i,", but expected object")),this.m_arrFileNames=e;var a,o=new Ai,r=this.m_arrFileNames.length;console.log("LoaderUrlDicom.loadFromUrlArray: start loading: ".concat(r," files")),console.log("LoaderUrlDicom.loadFromUrlArray: from ".concat(e[0]," .. to ").concat(e[r-1],"  ")),this.m_loaderDicom=new wa(r,!1),this.m_volume=new _e;var n=this.callbackReadProgress,s=this.callbackReadComplete;n(0),this.m_loaderDicom.m_numLoadedFiles=r,this.m_loaderDicom.m_filesLoadedCounter=0,this.m_loaderDicom.m_numFailsLoad=0;for(var l=0;l<r;l++)this.m_loaderDicom.m_errors[l]=-1,this.m_loaderDicom.m_loaders[l]=null;for(this.m_loaderDicom.m_zDim=r,a=0;a<r;a++){var m=this.m_arrFileNames[a];if(!o.isValidUrl(m))return console.log("LoaderUrlDicom.loadFromUrlArray: url is not valid = ".concat(m)),!1;0===a&&(this.m_fileName=o.getFileNameFromUrl(m)),this.m_loaders[a]=new di(m);var h=this.m_loaders[a];if(!this.m_loaderDicom.runLoader(this.m_volume,m,h,a,n,s,t))return!1}return!0}}]),e}(),Na=i(8),Va=i.n(Na),Ba=function(){function e(){Object(v.a)(this,e),this.m_loaderDicom=null}return Object(p.a)(e,[{key:"loadDicomfir",value:function(e,t){var i=new DataView(t),a=null;try{a=Va.a.Series.parseImage(i)}catch(f){return console.log("error parse dcm file buffer"),ui.BAD_DICOM}if(void 0===a||null===a)return ui.BAD_DICOM;var o,r=[4,4640];o=Va.a.Utils.dec2hex(r[0])+Va.a.Utils.dec2hex(r[1]);var n=a.tags[o];if(void 0!==n)for(var s=n.value.length,l=0;l<s;l++){var m=n.value[l];if(57344===m.element&&65534===m.group)for(var h=m.value.length,u=0;u<h;u++){var c=m.value[u];if(5168===c.element&&c.group,5376===c.element&&4===c.group){var d=c.value[0],_=c.value[1];console.log("image nm = ".concat(d," / ").concat(_))}}}return ui.SUCCESS}},{key:"loadSingleSlice",value:function(e,t,i){var a=new DataView(i),o=null;try{o=Va.a.Series.parseImage(a)}catch(_e){return console.log("error parse dcm file buffer"),ui.BAD_DICOM}if(void 0===o||null===o)return ui.BAD_DICOM;var r=o.getRows(),n=o.getCols(),s=o.getBitsAllocated();8!==s&&16!==s&&console.log("Parse Dicom data. Strange bits per pixel = "+s.toString());var l=o.getPatientName(),m=o.getImageDescription(),h=o.getStudyDate(),u=o.getStudyTime(),c=o.getSeriesDescription(),d=this.m_loaderDicom.m_dicomInfo,_=new Mi;_.m_sliceNumber=e,_.m_sliceLocation=-1,_.m_patientName=l,_.m_studyDescr=m,_.m_studyDate=h,_.m_seriesTime=u,_.m_seriesDescr=c,_.m_bodyPartExamined="NonExistInDiakonReader",_.buildHash(),this.m_loaderDicom.m_minSlice=0,this.m_loaderDicom.m_maxSlice=0,this.m_loaderDicom.m_pixelSpacing.x=0,this.m_loaderDicom.m_pixelSpacing.y=0,this.m_loaderDicom.m_pixelSpacing.z=0,this.m_loaderDicom.m_xDim=n,this.m_loaderDicom.m_yDim=r,e<this.m_loaderDicom.m_slicesVolume.m_minSlice&&(this.m_loaderDicom.m_slicesVolume.m_minSlice=e),e>this.m_loaderDicom.m_slicesVolume.m_maxSlice&&(this.m_loaderDicom.m_slicesVolume.m_maxSlice=e),this.m_loaderDicom.m_newTagEvent.detail.fileName=t;var f=new ki,v="Slice "+e.toString();f.m_sliceName=v,f.m_fileName=t,f.m_tags=[],d.m_sliceInfo.push(f);var p=[Va.a.Tag.TAG_ROWS,Va.a.Tag.TAG_COLS,Va.a.Tag.TAG_ACQUISITION_MATRIX,Va.a.Tag.TAG_NUMBER_OF_FRAMES,Va.a.Tag.TAG_NUMBER_TEMPORAL_POSITIONS,Va.a.Tag.TAG_PIXEL_SPACING,Va.a.Tag.TAG_SLICE_THICKNESS,Va.a.Tag.TAG_SLICE_GAP,Va.a.Tag.TAG_TR,Va.a.Tag.TAG_FRAME_TIME,Va.a.Tag.TAG_BITS_ALLOCATED,Va.a.Tag.TAG_BITS_STORED,Va.a.Tag.TAG_PIXEL_REPRESENTATION,Va.a.Tag.TAG_HIGH_BIT,Va.a.Tag.TAG_PHOTOMETRIC_INTERPRETATION,Va.a.Tag.TAG_SAMPLES_PER_PIXEL,Va.a.Tag.TAG_PLANAR_CONFIG,Va.a.Tag.TAG_PALETTE_RED,Va.a.Tag.TAG_PALETTE_GREEN,Va.a.Tag.TAG_PALETTE_BLUE,Va.a.Tag.TAG_DATA_SCALE_SLOPE,Va.a.Tag.TAG_DATA_SCALE_INTERCEPT,Va.a.Tag.TAG_DATA_SCALE_ELSCINT,Va.a.Tag.TAG_PIXEL_BANDWIDTH,Va.a.Tag.TAG_IMAGE_MIN,Va.a.Tag.TAG_IMAGE_MAX,Va.a.Tag.TAG_WINDOW_CENTER,Va.a.Tag.TAG_WINDOW_WIDTH,Va.a.Tag.TAG_PATIENT_NAME,Va.a.Tag.TAG_PATIENT_ID,Va.a.Tag.TAG_STUDY_DATE,Va.a.Tag.TAG_STUDY_TIME,Va.a.Tag.TAG_STUDY_DES,Va.a.Tag.TAG_IMAGE_TYPE,Va.a.Tag.TAG_IMAGE_COMMENTS,Va.a.Tag.TAG_SEQUENCE_NAME,Va.a.Tag.TAG_MODALITY,Va.a.Tag.TAG_FRAME_OF_REF_UID,Va.a.Tag.TAG_STUDY_UID,Va.a.Tag.TAG_SERIES_DESCRIPTION,Va.a.Tag.TAG_SERIES_INSTANCE_UID,Va.a.Tag.TAG_SERIES_NUMBER,Va.a.Tag.TAG_ECHO_NUMBER,Va.a.Tag.TAG_TEMPORAL_POSITION,Va.a.Tag.TAG_IMAGE_NUM,Va.a.Tag.TAG_SLICE_LOCATION,Va.a.Tag.TAG_IMAGE_ORIENTATION,Va.a.Tag.TAG_IMAGE_POSITION,Va.a.Tag.TAG_SLICE_LOCATION_VECTOR,Va.a.Tag.TAG_LUT_SHAPE,[40,288]],g=[16,48],S=[24,21],y=[8,128],x=[8,4208],b=[8,144];d.m_patientName=o.getPatientName(),d.m_patientDateOfBirth=Va.a.Image.getSingleValueSafely(o.getTag(g[0],g[1]),0),d.m_seriesDescr=c,d.m_studyDescr=m,d.m_studyDate=h,d.m_seriesTime=u,d.m_bodyPartExamined=Va.a.Image.getSingleValueSafely(o.getTag(S[0],S[1]),0),d.m_institutionName=Va.a.Image.getSingleValueSafely(o.getTag(y[0],y[1]),0),d.m_operatorsName=Va.a.Image.getSingleValueSafely(o.getTag(x[0],x[1]),0),d.m_physicansName=Va.a.Image.getSingleValueSafely(o.getTag(b[0],b[1]),0);for(var D,T=p.length,E=0;E<T;E++){var M=Va.a.Utils.dec2hex(p[E][0])+Va.a.Utils.dec2hex(p[E][1]),w=o.tags[M];if(void 0!==w){var R=w.value,k=w.group,O=w.element,A=new wa;A.m_tag="("+wa.numberToHexString(k)+","+wa.numberToHexString(O)+")";var C=this.m_loaderDicom.m_dictionary.getTextDesc(k,O);A.m_attrName=C.length>1?C:"";var I="";null!==R&&(I=R.toString()),A.m_attrValue=I,f.m_tags.push(A)}}D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_SLICE_LOCATION[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_SLICE_LOCATION[1]);var F=o.tags[D];if(void 0!==F){var P=F.value[0];_.m_sliceLocation=P,this.m_sliceLocMin=P<this.m_sliceLocMin?P:this.m_sliceLocMin,this.m_sliceLocMax=P>this.m_sliceLocMax?P:this.m_sliceLocMax}D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_IMAGE_NUM[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_IMAGE_NUM[1]);var U=o.tags[D];if(void 0!==U&&null!==U.value){var X=U.value[0];_.m_sliceNumber=X}D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_SAMPLES_PER_PIXEL[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_SAMPLES_PER_PIXEL[1]);var z=o.tags[D];if(void 0!==z){var L=z.value[0];this.m_loaderDicom.m_samplesPerPixel=L}D=Va.a.Utils.dec2hex(40)+Va.a.Utils.dec2hex(288);var N=o.tags[D];if(void 0!==N){var V=N.value[0];V<0&&(V=-(65535^V)-1),this.m_loaderDicom.m_padValue=V}D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_WINDOW_CENTER[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_WINDOW_CENTER[1]);var B=o.tags[D];void 0!==B&&(this.m_loaderDicom.m_windowCenter=B.value[0]),D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_WINDOW_WIDTH[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_WINDOW_WIDTH[1]);var j=o.tags[D];void 0!==j&&(this.m_loaderDicom.m_windowWidth=j.value[0]),D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_DATA_SCALE_INTERCEPT[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_DATA_SCALE_INTERCEPT[1]);var G=o.tags[D];void 0!==G&&(this.m_loaderDicom.m_rescaleIntercept=G.value[0]),D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_DATA_SCALE_SLOPE[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_DATA_SCALE_SLOPE[1]);var W=o.tags[D];void 0!==W&&(this.m_loaderDicom.m_rescaleSlope=W.value[0]);var H=[40,4180];D=Va.a.Utils.dec2hex(H[0])+Va.a.Utils.dec2hex(H[1]);var q=o.tags[D];void 0!==q&&null!==q.value&&"HU"===q.value[0]&&(this.m_loaderDicom.m_rescaleHounsfield=!0),D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_PIXEL_REPRESENTATION[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_PIXEL_REPRESENTATION[1]);var Y=o.tags[D];void 0!==Y&&1===Y.value[0]&&(this.m_loaderDicom.m_pixelRepresentaionSigned=!0),D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_PIXEL_SPACING[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_PIXEL_SPACING[1]);var Z=o.tags[D];if(void 0!==Z){var K=Z.value;2===K.length&&(this.m_loaderDicom.m_pixelSpacing.x=parseFloat(K[0]),this.m_loaderDicom.m_pixelSpacing.y=parseFloat(K[1]))}D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_SLICE_THICKNESS[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_SLICE_THICKNESS[1]);var Q=o.tags[D];if(void 0!==Q){var J=Q.value;1===J.length&&(this.m_loaderDicom.m_pixelSpacing.z=parseFloat(J[0]))}D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_IMAGE_POSITION[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_IMAGE_POSITION[1]);var $=o.tags[D];if(void 0!==$){if(3===$.value.length){var ee=$.value[0],te=$.value[1],ie=$.value[2];this.m_loaderDicom.m_imagePosMin.x=ee<this.m_loaderDicom.m_imagePosMin.x?ee:this.m_loaderDicom.m_imagePosMin.x,this.m_loaderDicom.m_imagePosMin.y=te<this.m_loaderDicom.m_imagePosMin.y?te:this.m_loaderDicom.m_imagePosMin.y,this.m_loaderDicom.m_imagePosMin.z=ie<this.m_loaderDicom.m_imagePosMin.z?ie:this.m_loaderDicom.m_imagePosMin.z,this.m_loaderDicom.m_imagePosMax.x=ee>this.m_loaderDicom.m_imagePosMax.x?ee:this.m_loaderDicom.m_imagePosMax.x,this.m_loaderDicom.m_imagePosMax.y=te>this.m_loaderDicom.m_imagePosMax.y?te:this.m_loaderDicom.m_imagePosMax.y,this.m_loaderDicom.m_imagePosMax.z=ie>this.m_loaderDicom.m_imagePosMax.z?ie:this.m_loaderDicom.m_imagePosMax.z}}D=Va.a.Utils.dec2hex(Va.a.Tag.TAG_TRANSFER_SYNTAX[0])+Va.a.Utils.dec2hex(Va.a.Tag.TAG_TRANSFER_SYNTAX[1]);var ae=o.tags[D];void 0!==ae&&("1.2.840.10008.1.2.2"===ae.value[0]&&(this.m_loaderDicom.m_littleEndian=!1));this.m_loaderDicom.m_slicesVolume.addSlice(_);var oe=o.getRawData();if(oe.byteLength!==n*r*Math.floor(s/8)*this.m_loaderDicom.m_samplesPerPixel)return console.log("Error read Dicom via Diakon parser"),ui.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED;this.m_loaderDicom.m_pixelRepresentaionSigned?_.m_image=new Int16Array(n*r):_.m_image=new Uint16Array(n*r);var re=n*r;if(1===this.m_loaderDicom.m_samplesPerPixel)for(var ne=new Uint16Array(oe),se=0;se<re;se++)_.m_image[se]=ne[se];else if(3===this.m_loaderDicom.m_samplesPerPixel)for(var le=new Uint8Array(oe),me=0,he=0;he<re;he++,me+=3){var ue=le[me+0],ce=le[me+1],de=le[me+2];_.m_image[he]=Math.floor((ue+ce+de)/3)}return _.m_xDim=n,_.m_yDim=r,ui.SUCCESS}},{key:"readSlice",value:function(e,t,i,a){return this.m_loaderDicom=e,this.loadSingleSlice(t,i,a)}},{key:"readSingleSlice",value:function(e,t,i,a,o){var r;if(this.m_loaderDicom=t,(r=this.loadSingleSlice(i,a,o))!==ui.SUCCESS)return r;var n=this.m_loaderDicom.m_dicomInfo;return e.dispatch({type:m.SET_DICOM_INFO,dicomInfo:n}),e.dispatch({type:m.SET_LOADER_DICOM,loaderDicom:this.m_loaderDicom}),r}}]),e}(),ja=function(){function e(){Object(v.a)(this,e),this.m_loaderDaikon=new Ba,this.readReadyFileList=this.readReadyFileList.bind(this)}return Object(p.a)(e,[{key:"readFromUrl",value:function(e,t,i,a){var o=this;console.assert(null!=e,"Null volume"),console.assert(e instanceof Oa,"Should be volume set"),console.assert(null!=t,"Null string url"),console.assert("string"===typeof t,"Should be string in url");var r=new Ai;if(!r.isValidUrl(t))return console.log("readFromUrl: not vaild URL = = ".concat(t," ")),!1;this.m_folder=r.getFolderNameFromUrl(t);var n=this.m_folder+"/file_list.txt";console.log("readFromUrl: load file = ".concat(n," ")),a(0);var s=new di(n);return this.m_fileListCounter=0,s.readFile((function(t){return o.m_fileListCounter+=1,1!==o.m_fileListCounter||o.readReadyFileList(e,t,i,a)}),(function(e){return console.log("Error read file: ".concat(e)),!1})),!0}},{key:"readReadyFileList",value:function(e,t,i,a){var o=this,r=new Uint8Array(t),n=String.fromCharCode.apply(null,r),s=n.substr(0,64);console.log("Loaded file list. Started with:  ".concat(s," ..."));for(var l=n.split("\n"),m=l.length,h=m-1;h>=0;h--)l[h].endsWith("\r")&&(l[h]=l[h].substring(0,l[h].length-1)),l[h].length<4&&l.pop();m=l.length,this.m_loaders=[],this.m_errors=[];for(var u=0;u<m;u++)this.m_errors[u]=-1,this.m_loaders[u]=null;var c=m;console.log("Loaded file list. ".concat(m," files will be loaded. 1st file in list is = ").concat(l[0])),console.log("Loaded file list. Last file in list is = ".concat(l[m-1])),this.m_loaderDaikon.m_loaderDicom=new wa(m),this.m_loaderDaikon.m_loaderDicom.m_pixelSpacing={x:0,y:0,z:0},this.m_boxSize={x:1,y:1,z:1},this.m_filesLoadedCounter=0,this.m_numFailsLoad=0,this.m_numLoadedFiles=m,this.m_loaderDaikon.m_loaderDicom.m_imagePosMin={x:1e12,y:1e12,z:1e12},this.m_loaderDaikon.m_loaderDicom.m_imagePosMax={x:-1e12,y:-1e12,z:-1e12},this.m_loaderDaikon.m_sliceLocMin=1e12,this.m_loaderDaikon.m_sliceLocMax=-1e12;for(var d=function(t){var r="".concat(o.m_folder,"/").concat(l[t]);o.m_loaders[t]=new di(r),o.m_loaders[t].readFile((function(n){var s=o.m_filesLoadedCounter/o.m_numLoadedFiles;void 0!==a&&0===(7&o.m_filesLoadedCounter)&&a(s);var l=o.m_loaderDaikon.loadSingleSlice(t,r,n);if(l!==ui.SUCCESS)return l;if(o.m_filesLoadedCounter+=1,o.m_filesLoadedCounter===o.m_numLoadedFiles){false;var m,h={x:o.m_loaderDaikon.m_loaderDicom.m_imagePosMax.x-o.m_loaderDaikon.m_loaderDicom.m_imagePosMin.x,y:o.m_loaderDaikon.m_loaderDicom.y-o.m_loaderDaikon.m_loaderDicom.m_imagePosMin.y,z:o.m_loaderDaikon.m_loaderDicom.m_imagePosMax.z-o.m_loaderDaikon.m_loaderDicom.m_imagePosMin.z},u=1e-5;Math.abs(o.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.z)>u?m=o.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.z*c:(m=h.z,Math.abs(m)<u&&(m=h.x,Math.abs(m)<u&&(m=h.y))),m<u&&(m=1);var d=o.m_loaderDaikon.m_loaderDicom.m_xDim,_=o.m_loaderDaikon.m_loaderDicom.m_yDim;o.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.z=m/c,o.m_boxSize.z=c*o.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.z,o.m_boxSize.x=d*o.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.x,o.m_boxSize.y=_*o.m_loaderDaikon.m_loaderDicom.m_pixelSpacing.y,console.log("LoadDcmUrlDaikon. Volume local phys dim: ".concat(o.m_boxSize.x," * ").concat(o.m_boxSize.y," * ").concat(o.m_boxSize.z));var f=o.m_loaderDaikon.m_loaderDicom.m_slicesVolume.getSeries();0===f.length&&(o.m_loaderDaikon.m_loaderDicom.m_slicesVolume.buildSeriesInfo(),f=o.m_loaderDaikon.m_loaderDicom.m_slicesVolume.getSeries());var v=f[0].m_hash,p=o.m_loaderDaikon.m_loaderDicom.createVolumeFromSlices(e,0,v);if(null!==a&&a(1),null!==i)return i(p),!0}}))},_=0;_<this.m_numLoadedFiles&&this.m_numFailsLoad<1;_++)d(_);return ui.SUCCESS}}]),e}(),Ga={demoUrls:[],googleCloudDemoActivce:!1,arrMenuGoogle:[{text:"Demo lungs AA",tooltip:"Load some lungs model"},{text:"Demo head BB",tooltip:"Load some strange head"},{text:"Demo alien CC",tooltip:"Write here smth please"}],demoWomanPelvisPrefix:"",demoWomanPelvisUrls:[],demoLungsPrefix:"",demoLungsUrls:[]},Wa=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onButtonLocalFile=a.onButtonLocalFile.bind(Object(y.a)(a)),a.handleFileSelected=a.handleFileSelected.bind(Object(y.a)(a)),a.onFileContentReadSingleFile=a.onFileContentReadSingleFile.bind(Object(y.a)(a)),a.onFileContentReadMultipleDicom=a.onFileContentReadMultipleDicom.bind(Object(y.a)(a)),a.onFileContentReadMultipleHdr=a.onFileContentReadMultipleHdr.bind(Object(y.a)(a)),a.setErrorString=a.setErrorString.bind(Object(y.a)(a)),a.onModalUrlShow=a.onModalUrlShow.bind(Object(y.a)(a)),a.onModalUrlHide=a.onModalUrlHide.bind(Object(y.a)(a)),a.onClickLoadUrl=a.onClickLoadUrl.bind(Object(y.a)(a)),a.callbackReadCompleteUrlKtxNii=a.callbackReadCompleteUrlKtxNii.bind(Object(y.a)(a)),a.onModalDemoOpenShow=a.onModalDemoOpenShow.bind(Object(y.a)(a)),a.onModalDemoOpenHide=a.onModalDemoOpenHide.bind(Object(y.a)(a)),a.onDemoSelected=a.onDemoSelected.bind(Object(y.a)(a)),a.onModalWindowCWHide=a.onModalWindowCWHide.bind(Object(y.a)(a)),a.onModalGoogleShow=a.onModalGoogleShow.bind(Object(y.a)(a)),a.onModalGoogleHide=a.onModalGoogleHide.bind(Object(y.a)(a)),a.onGoogleSelected=a.onGoogleSelected.bind(Object(y.a)(a)),a.onModalDicomSeriesHide=a.onModalDicomSeriesHide.bind(Object(y.a)(a)),a.onDicomSerieSelected=a.onDicomSerieSelected.bind(Object(y.a)(a)),a.callbackReadProgress=a.callbackReadProgress.bind(Object(y.a)(a)),a.callbackReadComplete=a.callbackReadComplete.bind(Object(y.a)(a)),a.callbackReadSingleDicomComplete=a.callbackReadSingleDicomComplete.bind(Object(y.a)(a)),a.callbackReadMultipleComplete=a.callbackReadMultipleComplete.bind(Object(y.a)(a)),a.callbackCompleteMultipleDicom=a.callbackCompleteMultipleDicom.bind(Object(y.a)(a)),a.m_fileNameOnLoad="",a.m_fileName="",a.m_fileIndex=0,a.m_fileReader=null,a.state={strUrl:"",showModalUrl:!1,showModalDemo:!1,showModalGoogle:!1,showModalWindowCW:!1,onLoadCounter:1},a.m_volumeSet=null,a.m_volumeRoi=null,a.m_updateEnable=!0,a.roiMode=!1,a}return Object(p.a)(i,[{key:"finalizeSuccessLoadedVolume",value:function(e,t){var i=this.props;console.assert(e instanceof Oa,"finalizeSuccessLoadedVolume: should be VolumeSet"),console.assert(e.getNumVolumes()>=1,"finalizeSuccessLoadedVolume: should be more or 1 volume");var a=e.getVolume(0);if(console.assert(null!==a,"finalizeSuccessLoadedVolume: should be non zero volume"),null!==a.m_dataArray){console.log("success loaded volume from ".concat(t)),a.makeDimensions4x(),i.isLoaded&&i.dispatch({type:m.SET_IS_LOADED,isLoaded:!1}),i.dispatch({type:m.SET_VOLUME_SET,volumeSet:e}),i.dispatch({type:m.SET_VOLUME_INDEX,volumeIndex:0}),i.dispatch({type:m.SET_IS_LOADED,isLoaded:!0}),i.dispatch({type:m.SET_FILENAME,fileName:t}),i.dispatch({type:m.SET_ERR_ARRAY,arrErrors:[]});var o=new de;o.createFromRawVolume(a),i.dispatch({type:m.SET_TEXTURE3D,texture3d:o}),i.dispatch({type:m.SET_MODE_VIEW,modeView:h.VIEW_2D}),i.dispatch({type:m.SET_MODE_3D,mode3d:c.RAYCAST})}}},{key:"setErrorString",value:function(e){var t=this.props,i=[];i.push(e),t.dispatch({type:m.SET_IS_LOADED,isLoaded:!1}),t.dispatch({type:m.SET_ERR_ARRAY,arrErrors:i}),t.dispatch({type:m.SET_VOLUME_SET,volume:null})}},{key:"finalizeFailedLoadedVolume",value:function(e,t,i){console.assert(void 0!==i);var a=this.props;a.dispatch({type:m.SET_IS_LOADED,isLoaded:!1}),a.dispatch({type:m.SET_VOLUME_SET,volume:null}),a.dispatch({type:m.SET_ERR_ARRAY,arrErrors:i}),a.dispatch({type:m.SET_FILENAME,fileName:t}),a.uiApp.doHideProgressBar()}},{key:"callbackReadProgress",value:function(e){var t=Math.floor(100*e),i=this.props.uiApp;null!==i&&(0===t&&i.doShowProgressBar("Loading..."),t>=99?i.doHideProgressBar():i.doSetProgressBarRatio(t))}},{key:"callbackReadComplete",value:function(e){if(void 0===e)console.log("callbackReadComplete. should be errCode");else if(e!==ui.SUCCESS){var t=ui.getResultString(e);this.setErrorString(t)}if(this.props.uiApp.doHideProgressBar(),e===ui.SUCCESS)this.finalizeSuccessLoadedVolume(this.m_volumeSet,this.m_fileName);else{console.log("callbackReadComplete failed! reading ".concat(this.m_fileName," file"));var i=[],a=ui.getResultString(e);i.push(a),this.finalizeFailedLoadedVolume(this.m_volumeSet,this.m_fileName,i)}}},{key:"callbackReadSingleDicomComplete",value:function(e){if(e===ui.SUCCESS){var t=this.props;return t.dispatch({type:m.SET_VOLUME_SET,volumeSet:this.m_volumeSet}),t.dispatch({type:m.SET_VOLUME_INDEX,volumeIndex:0}),t.dispatch({type:m.SET_LOADER_DICOM,loaderDicom:this.m_loader}),this.childModalWindowCenterWidth.initWindowRange(),void this.setState({showModalWindowCW:!0})}this.callbackReadComplete(e)}},{key:"callbackReadMultipleComplete",value:function(e){if(e!==ui.SUCCESS){var t=ui.getResultString(e);this.setErrorString(t)}}},{key:"onFileReadSingleUncompressedFile",value:function(e,t,i,a){this.m_fileName.endsWith(".ktx")||this.m_fileName.endsWith(".KTX")?this.m_volumeSet.readFromKtx(e,t,i):this.m_fileName.endsWith(".nii")||this.m_fileName.endsWith(".NII")?this.m_volumeSet.readFromNifti(e,t,i):this.m_fileName.endsWith(".dcm")||this.m_fileName.endsWith(".DCM")?(this.m_loader=new wa,this.m_loader.m_zDim=1,this.m_loader.m_numFiles=1,this.m_volumeSet.readFromDicom(this.m_loader,e,t,a)):this.m_fileName.endsWith(".hdr")||this.m_fileName.endsWith(".HDR")?console.log("cant read single hdr file: ".concat(this.m_fileName)):this.m_fileName.endsWith(".img")||this.m_fileName.endsWith(".IMG")?console.log("cant read single img file: ".concat(this.m_fileName)):console.log("onFileContentReadSingleFile: unknown file type: ".concat(this.m_fileName))}},{key:"onFileContentReadSingleFile",value:function(){var e=this.m_fileReader.result;this.onFileReadSingleBuffer(e)}},{key:"readSliceDicomViaDaikon",value:function(e,t,i,a){return(new Ba).readSlice(this.m_loader,e,t,a)}},{key:"onFileReadSingleBuffer",value:function(e){if(this.m_fileName.endsWith(".dcm")||this.m_fileName.endsWith(".DCM")){var t=new Ba,i=this.props,a=this.m_fileIndex,o=this.m_fileName;this.m_loader=new wa(1);var r=t.readSingleSlice(i,this.m_loader,a,o,e);return this.callbackReadSingleDicomComplete(r),r}console.log("UiOpenMenu. onFileReadSingleBuffer ..."),this.m_volumeSet=new Oa,this.m_volumeSet.addVolume(new _e);var n=this.callbackReadProgress,s=this.callbackReadComplete,l=this.callbackReadSingleDicomComplete;if(this.m_fileName.endsWith(".ktx")||this.m_fileName.endsWith(".KTX"))this.m_volumeSet.readFromKtx(e,n,s);else if(this.m_fileName.endsWith(".nii")||this.m_fileName.endsWith(".NII"))this.m_volumeSet.readFromNifti(e,n,s);else if(this.m_fileName.endsWith(".dcm")||this.m_fileName.endsWith(".DCM")){this.m_loader=new wa,this.m_loader.m_zDim=1,this.m_loader.m_numFiles=1,this.m_volumeSet.readFromDicom(this.m_loader,e,n,l);var h=this.m_loader.m_dicomInfo,u=h.m_sliceInfo[0];u.m_fileName=this.m_fileName,u.m_sliceName="Slice 0",this.props.dispatch({type:m.SET_DICOM_INFO,dicomInfo:h})}else this.m_fileName.endsWith(".hdr")||this.m_fileName.endsWith(".HDR")?console.log("cant read single hdr file: ".concat(this.m_fileName)):this.m_fileName.endsWith(".img")||this.m_fileName.endsWith(".IMG")?console.log("cant read single img file: ".concat(this.m_fileName)):console.log("onFileContentReadSingleFile: unknown file type: ".concat(this.m_fileName))}},{key:"onFileContentReadMultipleHdr",value:function(){if(2===this.m_numFiles||4===this.m_numFiles){var e=this.m_fileName.endsWith("hdr")||this.m_fileName.endsWith("HDR");console.log("onFileContentReadMultipleHdr: read file ".concat(this.m_fileName,". Ratio=").concat(this.m_fileIndex," / ").concat(this.m_numFiles)),this.m_fileIndex++;var t=this.m_fileIndex/this.m_numFiles,i=this.m_fileReader.result;this.m_fileIndex<=1&&(0===this.m_volumeSet.getNumVolumes()&&this.m_volumeSet.addVolume(new _e),this.callbackReadProgress(0)),4===this.m_numFiles&&null===this.m_volumeRoi&&(this.m_volumeRoi=new _e);var a=/([\S]+)\.[\S]+/.exec(this.m_fileName),o=!1,r=!1;if(2===a.length){var n=a[1];n.endsWith("_mask")&&(o=!0),n.endsWith("_intn")&&(r=!0)}var s=this.m_volumeSet.getVolume(0);if(this.m_fileIndex>2&&(s=this.m_volumeRoi),r&&(s=this.m_volumeSet.getVolume(0)),o&&(s=this.m_volumeRoi,this.roiMode=!0,4!==this.m_numFiles))console.log("You need to load 4 files, if one of them has _mask in name");else{var l=!1;if(l=e?this.m_loader.readFromBufferHeader(s,i,null,null):this.m_loader.readFromBufferImage(s,i,null,null),s=this.m_volumeSet.getVolume(0),l&&this.m_fileIndex===this.m_numFiles){var m=!1;2===this.m_numFiles?m=this.m_loader.createVolumeFromHeaderAndImage(s):4===this.m_numFiles&&(m=this.m_loader.createVolumeFromHeaderAndImage(s))&&(m=this.m_loader.createRoiVolumeFromHeaderAndImage(s,this.m_volumeRoi)),this.callbackReadProgress(1),m?this.callbackReadComplete(ui.SUCCESS):this.callbackReadComplete(ui.FAIL)}if(this.m_fileIndex<this.m_numFiles){this.callbackReadProgress(t),this.m_fileReader.onloadend=this.onFileContentReadMultipleHdr;var h=this.m_files[this.m_fileIndex];this.m_fileName=h.name,this.m_fileReader.readAsArrayBuffer(h)}}}else console.log("onFileContentReadMultipleHdr: can read ".concat(2," or ").concat(4," files for multiple hdr loader"))}},{key:"callbackCompleteMultipleDicom",value:function(e){if(e!==ui.SUCCESS){var t=ui.getResultString(e);this.setErrorString(t)}}},{key:"onFileContentReadMultipleDicom",value:function(){var e=this.m_fileReader.result;this.m_fileIndex++;var t=this.m_fileIndex/this.m_numFiles;if(this.m_fileIndex<=1){var i=new _e;this.m_volumeSet.addVolume(i),this.callbackReadProgress(0)}var a;this.callbackCompleteMultipleDicom;if((a=this.readSliceDicomViaDaikon(this.m_fileIndex-1,this.m_fileName,t,e))!==ui.SUCCESS&&console.log("onFileContentReadMultipleDicom. Error read individual file"),a===ui.SUCCESS&&this.m_fileIndex===this.m_numFiles){var o=this.props;return o.dispatch({type:m.SET_VOLUME_INDEX,volumeIndex:0}),o.dispatch({type:m.SET_VOLUME_SET,volumeSet:this.m_volumeSet}),o.dispatch({type:m.SET_LOADER_DICOM,loaderDicom:this.m_loader}),this.callbackReadProgress(1),this.callbackReadComplete(ui.SUCCESS),this.childModalWindowCenterWidth.initWindowRange(),void this.setState({showModalWindowCW:!0})}if(a===ui.SUCCESS){if(this.m_fileIndex<this.m_numFiles){var r=Math.floor(this.m_numFiles/16);this.m_fileIndex%r===0&&this.callbackReadProgress(t),this.m_fileReader.onloadend=this.onFileContentReadMultipleDicom;var n=this.m_files[this.m_fileIndex];this.m_fileName=n.name,this.m_fileReader.readAsArrayBuffer(n)}}else{var s=[],l=this.props.arrErrors[0];s.push(l),this.finalizeFailedLoadedVolume(this.m_volumeSet,this.m_fileName,s)}}},{key:"handleFileSelected",value:function(e){var t=this;if(void 0!==e.target.files){var i=e.target.files.length;if(console.log("UiOpenMenu. Trying to open ".concat(i," files")),i<=0)return;if(console.log("UiOpenMenu. handleFileSelected. file[0] = ".concat(e.target.files[0].name)),this.m_volumeSet=new Oa,1===i){var a=e.target.files[0];if(this.m_fileName=a.name,this.m_fileName.endsWith(".gz")){this.m_unzippedBuffer=null,this.m_fileName=this.m_fileName.slice(0,-3);var o=this.props,r=li.a.createGunzip();return hi()(a).pipe(r),r.on("data",(function(e){var i=o.uiApp;if(null==t.m_unzippedBuffer)i.doShowProgressBar("Read gzip...");else{var r=t.m_unzippedBuffer.length,n=a.size,s=Math.floor(100*r*.28/n);i.doSetProgressBarRatio(s)}var l=e.length;if(null==t.m_unzippedBuffer)t.m_unzippedBuffer=new Uint8Array(l),t.m_unzippedBuffer.set(e,0);else{var m=t.m_unzippedBuffer.length,h=new Uint8Array(m+l);h.set(t.m_unzippedBuffer,0),h.set(e,m),t.m_unzippedBuffer=h}})),r.on("close",(function(){console.log("gzip on close")})),void r.on("end",(function(){o.uiApp.doHideProgressBar();var e=t.m_unzippedBuffer.length;if(e<128)console.log("Too small ungzipped data: "+e.toString()+" bytes. canat read volume data");else{for(var i=[0,0,1,92],a=!0,r=0;r<4;r++)t.m_unzippedBuffer[r]!==i[r]&&(a=!1);for(var n=!0,s=0;s<4;s++)t.m_unzippedBuffer[s]!==i[3-s]&&(n=!1);a||n?(console.log("ungzip done with "+e.toString()+" bytes. Correct nifti header detected"),t.onFileReadSingleBuffer(t.m_unzippedBuffer)):console.log("Wrong nifi header, cant read gzipped file")}}))}this.m_fileReader=new FileReader,this.m_fileReader.onloadend=this.onFileContentReadSingleFile,this.m_fileReader.readAsArrayBuffer(a)}else{if(this.m_files=Array.from(e.target.files),this.m_fileIndex=0,this.m_numFiles=i,this.m_fileReader=new FileReader,this.m_loader=null,e.target.files[0].name.endsWith(".dcm")){for(var n=0,s=i-1;s>=0;s--)this.m_files[s].name.endsWith(".dcm")?n++:this.m_files.splice(s,1);i=n,this.m_numFiles=n,this.m_loader=new wa(i);var l=this.m_loader.m_dicomInfo,h=this.props;h.dispatch({type:m.SET_DICOM_INFO,dicomInfo:l}),h.dispatch({type:m.SET_LOADER_DICOM,loaderDicom:this.m_loader}),this.m_fileReader.onloadend=this.onFileContentReadMultipleDicom}else(e.target.files[0].name.endsWith(".hdr")||e.target.files[0].name.endsWith(".img"))&&(this.m_loader=new ka(i),this.m_fileReader.onloadend=this.onFileContentReadMultipleHdr);this.m_volumeRoi=null;var u=e.target.files[0];this.m_fileName=u.name,this.m_fileReader.readAsArrayBuffer(u)}}}},{key:"buildFileSelector",value:function(){var e=document.createElement("input");return e.setAttribute("type","file"),e.onchange=this.handleFileSelected,e}},{key:"onButtonLocalFile",value:function(e){console.log("Losing my mind"),e.preventDefault(),console.log(e),this.m_fileSelector.click()}},{key:"onModalUrlShow",value:function(){console.log("onModalUrlShow"),this.setState({strUrl:""}),this.setState({showModalUrl:!0})}},{key:"onModalUrlHide",value:function(){console.log("onModalUrlHide"),this.setState({showModalUrl:!1})}},{key:"onChangeUrlString",value:function(e){var t=e.target.value;this.setState({strUrl:t})}},{key:"callbackReadCompleteUrlKtxNii",value:function(e){if(e!==ui.SUCCESS){console.log("onCompleteFromUrlKtx. Bad result: ".concat(e));var t=[],i=ui.getResultString(e);return t.push(i),void this.finalizeFailedLoadedVolume(this.m_volumeSet,this.m_fileName,t)}this.finalizeSuccessLoadedVolume(this.m_volumeSet,this.m_fileName),this.callbackReadComplete(ui.SUCCESS,null,0,null)}},{key:"loadFromUrl",value:function(e){var t=new Ai;if(t.isValidUrl(e))if(this.m_url=e,this.m_fileName=t.getFileNameFromUrl(e),this.m_volumeSet=new Oa,this.m_volumeSet.addVolume(new _e),e.endsWith(".ktx")){var i=this.callbackReadProgress,a=this.callbackReadCompleteUrlKtxNii;this.callbackReadProgress(0),this.m_volumeSet.readFromKtxUrl(e,i,a)}else if(e.endsWith(".nii")){var o=this.callbackReadProgress,r=this.callbackReadCompleteUrlKtxNii;this.callbackReadProgress(0),this.m_volumeSet.readFromNiiUrl(e,o,r)}else{if(e.endsWith(".dcm"))return(new ja).readFromUrl(this.m_volumeSet,e,this.callbackReadCompleteUrlKtxNii,this.callbackReadProgress);if(e.endsWith(".h")){var n=this.callbackReadProgress,s=this.callbackReadCompleteUrlKtxNii;this.callbackReadProgress(0),this.m_volumeSet.readFromHdrUrl(e,n,s)}else console.log("UiOpenMenu. Unknow file type from URL = ".concat(e))}else{var l="UiOpenMenu. Bad URL = ".concat(e);console.log(l),this.setErrorString(l)}}},{key:"onClickLoadUrl",value:function(){this.setState({showModalUrl:!1});var e=this.state.strUrl;console.log("onClickLoadUrl with strUrl = ".concat(e)),this.loadFromUrl(e)}},{key:"onModalDemoOpenShow",value:function(){this.setState({showModalDemo:!0})}},{key:"onModalDemoOpenHide",value:function(){this.setState({showModalDemo:!1})}},{key:"arrNumToStr",value:function(e){for(var t=e.length,i="",a=0;a<t;a++){var o=e[a];i=i.concat(String.fromCharCode(o))}return i}},{key:"onModalGoogleShow",value:function(){this.setState({showModalGoogle:!0})}},{key:"onModalGoogleHide",value:function(){this.setState({showModalGoogle:!1})}},{key:"onGoogleSelected",value:function(e){console.log("onGoogleSelected(".concat(e,") ... "))}},{key:"onDemoSelected",value:function(e){var t=Ga.demoUrls;if(t.length>=8){var i=t[e];return console.log("onDemoSelected: load file ".concat(i,", config[ ").concat(e," ]")),void this.loadFromUrl(i)}var a="";if(0===e){a=(new Ai).decodeUrl("https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/31212219.luy")}else if(1===e){a=(new Ai).decodeUrl("https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/tfu11.luy")}else if(2===e){a=(new Ai).decodeUrl("https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/hn4_623_623_276.ojj")}else if(3===e){var o=Ga.demoWomanPelvisUrls.length;if(0!==o){for(var r=Ga.demoWomanPelvisPrefix,n=[],s=0;s<o;s++){var l=Ga.demoWomanPelvisUrls[s],m="".concat(r).concat(l);n.push(m)}var h=this.props;return void new La(h).loadFromUrlArray(n,!1)}a=(new Ai).decodeUrl("https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/xpnbo_qfmwjt/wig.:12.edn")}else if(4===e){var u=Ga.demoLungsUrls.length;if(0!==u){var c=Ga.demoLungsPrefix;console.log("config. Lungs prefix = ".concat(c));for(var d=[],_=0;_<u;_++){var f=Ga.demoLungsUrls[_],v="".concat(c).concat(f);d.push(v)}var p=this.props;return void new La(p).loadFromUrlArray(d,!1)}a=(new Ai).decodeUrl("https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/11dcb1:2gb5be73dd4311b768bfc:68f/145784245dcfg6fb26gg:f1d91:1611b.edn")}else if(5===e){a=(new Ai).decodeUrl("https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/du_367_367_367.luy")}else if(6===e){a=(new Ai).decodeUrl("https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/mvoht_367_367_367.luy")}else if(7===e){a=(new Ai).decodeUrl("https://med3web.pqfotpvsdf.fqbn.dpn/nfe4xfc3131/ies/tfu_jouo.i")}else console.log("onDemoSelected. not implemented for index = ".concat(e));a.length>0&&this.loadFromUrl(a)}},{key:"shouldComponentUpdate",value:function(){return!0}},{key:"onModalDicomSeriesHide",value:function(){this.props.dispatch({type:m.SET_DICOM_SERIES,dicomSeries:[]})}},{key:"onDicomSerieSelected",value:function(e){var t=this.props,i=t.dicomSeries[e].m_hash;this.m_loader.createVolumeFromSlices(this.m_volumeSet,e,i),this.finalizeSuccessLoadedVolume(this.m_volumeSet,this.m_fileName),console.log("onFileContentReadMultipleDicom read all ".concat(this.m_numFiles," files")),t.dispatch({type:m.SET_DICOM_SERIES,dicomSeries:[]})}},{key:"onModalWindowCWHide",value:function(e){if(this.setState({showModalWindowCW:!1}),e){this.finalizeSuccessLoadedVolume(this.m_volumeSet,this.m_fileName);var t=this.props,i=null;void 0!==this.m_loader&&(i=this.m_loader.m_slicesVolume.getSeries(),t.dispatch({type:m.SET_DICOM_SERIES,dicomSeries:i}));var a=t.graphics2d;null!==a&&a.forceUpdate()}}},{key:"componentDidMount",value:function(){this.m_fileSelector=this.buildFileSelector();var e=this.m_fileNameOnLoad;if(e.length>0&&this.state.onLoadCounter>0){this.setState({onLoadCounter:0});setTimeout(this.loadFromUrl(e),50)}}},{key:"render",value:function(){var e=this,t=Ga.googleCloudDemoActivce,i=this.props.fileNameOnLoad;this.m_fileNameOnLoad=i;if(i.length>2)return o.a.createElement("p",null);var a=t?o.a.createElement(ai.a.Item,{onClick:this.onModalGoogleShow},o.a.createElement("i",{className:"fas fa-brain"}),"Google cloud models"):o.a.createElement("p",null),r=o.a.createElement(ai.a.Item,{href:"#actionOpenDemo",onClick:this.onModalDemoOpenShow},o.a.createElement("i",{className:"fas fa-brain"}),"Demo models Open"),n=o.a.createElement(ai.a.Divider,null);return o.a.createElement(ai.a,{id:"basic-nav-dropdown",title:o.a.createElement("div",{style:{display:"inline-block"}},o.a.createElement("i",{className:"fas fa-folder-open"}),"Open333")},o.a.createElement(ai.a.Item,{href:"#actionOpenComputer",onClick:function(t){return e.onButtonLocalFile(t)}},o.a.createElement("i",{className:"fas fa-desktop"}),"Computer"),o.a.createElement(ai.a.Item,{href:"#actionOpenUrl",onClick:this.onModalUrlShow},o.a.createElement("i",{className:"fas fa-globe-americas"}),"Url"),n,a,r,o.a.createElement(oi.a,{show:this.state.showModalUrl,onHide:this.onModalUrlHide},o.a.createElement(oi.a.Title,null,"Load data from external source"),o.a.createElement(oi.a.Header,{closeButton:!0},o.a.createElement(oi.a.Body,null,o.a.createElement(ri.a,{className:"mb-3"},o.a.createElement(ri.a.Prepend,null,o.a.createElement(ri.a.Text,{id:"inputGroup-sizing-default"},"Input URL to open")),o.a.createElement(ni.a,{placeholder:"Enter URL here","aria-label":"Default","aria-describedby":"inputGroup-sizing-default",onChange:this.onChangeUrlString.bind(this)}),o.a.createElement(ri.a.Append,null,o.a.createElement(A.a,{variant:"outline-secondary",onClick:this.onClickLoadUrl},"Load")))))),o.a.createElement(Ia,{stateVis:this.state.showModalDemo,onHide:this.onModalDemoOpenHide,onSelectDemo:this.onDemoSelected}),o.a.createElement(Pa,{stateVis:this.state.showModalGoogle,onHide:this.onModalGoogleHide,onSelectDemo:this.onGoogleSelected,arrMenu:Ga.arrMenuGoogle}),o.a.createElement(za,{stateVis:this.state.showModalWindowCW,volSet:this.m_volumeSet,onHide:this.onModalWindowCWHide,onRef:function(t){return e.childModalWindowCenterWidth=t}}))}}]),i}(o.a.Component),Ha=Object(s.b)((function(e){return e}))(Wa),qa=i(200),Ya=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).m_needModeMpr=!0,a.m_needMode2d=!0,a.m_needMode3dLight=!0,a.m_needMode3d=!0,a.onModeMpr=a.onModeMpr.bind(Object(y.a)(a)),a.onMode2d=a.onMode2d.bind(Object(y.a)(a)),a.onMode3dLight=a.onMode3dLight.bind(Object(y.a)(a)),a.onMode3d=a.onMode3d.bind(Object(y.a)(a)),a.onTool3d=a.onTool3d.bind(Object(y.a)(a)),a.onView3d=a.onView3d.bind(Object(y.a)(a)),a}return Object(p.a)(i,[{key:"onMode",value:function(e){this.props.dispatch({type:m.SET_MODE_VIEW,modeView:e})}},{key:"onTool_View",value:function(e){var t=this.props;t.dispatch({type:m.SET_IS_TOOL3D,isTool3D:e}),t.dispatch({type:m.SET_SLIDER_Contrast3D,sliderContrast3D:0})}},{key:"onModeMpr",value:function(){this.onMode(h.VIEW_MPR)}},{key:"onMode2d",value:function(){this.onMode(h.VIEW_2D)}},{key:"onMode3dLight",value:function(){this.onMode(h.VIEW_3D_LIGHT)}},{key:"onMode3d",value:function(){this.onMode(h.VIEW_3D)}},{key:"onTool3d",value:function(){this.onTool_View(!0)}},{key:"onView3d",value:function(){this.onTool_View(!1)}},{key:"logObject",value:function(e,t){var i="";for(var a in t)i.length>0&&(i+="\n"),i+=a+" = "+t[a];console.log("".concat(e,"\n").concat(i))}},{key:"render",value:function(){var e=this.props,t=e.modeView,i=e.isTool3D;t!==h.VIEW_MPR||this.m_needModeMpr||(t=h.VIEW_2D),t!==h.VIEW_3D_LIGHT||this.m_needMode3dLight||(t=h.VIEW_2D),t!==h.VIEW_3D||this.m_needMode3d||(t=h.VIEW_2D),t!==h.VIEW_2D||this.m_needMode2d||(t=h.VIEW_3D);var a=t===h.VIEW_2D?"primary":"secondary",r=t===h.VIEW_3D_LIGHT?"primary":"secondary",n=t===h.VIEW_3D?"primary":"secondary",s=t===h.VIEW_3D_LIGHT&&!0===i?"primary":"secondary",l=t===h.VIEW_3D_LIGHT&&!1===i?"primary":"secondary",m=o.a.createElement(C.a,{key:"3d",placement:"bottom",overlay:o.a.createElement(I.a,null,"Show volume in 3d mode with old rendering")},o.a.createElement(A.a,{variant:n,onClick:this.onMode3d},"3D")),u=o.a.createElement(O.a,{className:"mr-2","aria-label":"Top group"},o.a.createElement(C.a,{key:"view",placement:"bottom",overlay:o.a.createElement(I.a,null,"Show volume in 3d mode with fast rendering")},o.a.createElement(A.a,{variant:l,onClick:this.onView3d},"View")),o.a.createElement(C.a,{key:"tool",placement:"bottom",overlay:o.a.createElement(I.a,null,"Show volume in 2d mode per slice on selected orientation")},o.a.createElement(A.a,{variant:s,onClick:this.onTool3d},"Tool"))),c=!1,d=e.volumeSet;if(d.getNumVolumes()>0){var _=e.volumeIndex,f=d.getVolume(_);null!==f&&4!==f.m_bytesPerVoxel&&(c=!0)}return o.a.createElement(qa.a,{"ria-label":"Toolbar with button groups"},o.a.createElement(O.a,{className:"mr-2","aria-label":"Top group"},o.a.createElement(C.a,{key:"2d",placement:"bottom",overlay:o.a.createElement(I.a,null,"Show volume in 2d mode per slice on selected orientation")},o.a.createElement(A.a,{variant:a,onClick:this.onMode2d},"2D")),o.a.createElement(C.a,{key:"3dLight",placement:"bottom",overlay:o.a.createElement(I.a,null,"Show volume in 3d mode with fast rendering")},o.a.createElement(A.a,{variant:r,onClick:this.onMode3dLight},"3D",o.a.createElement("span",{className:"fa fa-bolt"}))),c?m:""),t===h.VIEW_3D_LIGHT?u:"")}}]),i}(o.a.Component),Za=Object(s.b)((function(e){return e}))(Ya),Ka=i(56),Qa=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).animate=a.animate.bind(Object(y.a)(a)),a.m_mount=null,a.m_frameId=null,a}return Object(p.a)(i,[{key:"animate",value:function(){this.renderWithCtx(),this.m_frameId=window.requestAnimationFrame(this.animate)}},{key:"start",value:function(){null===this.m_frameId&&(this.m_frameId=requestAnimationFrame(this.animate))}},{key:"stop",value:function(){cancelAnimationFrame(this.m_frameId),this.m_frameId=null}},{key:"componentDidMount",value:function(){this.start()}},{key:"componentWillUnmount",value:function(){this.stop()}},{key:"render",value:function(){var e=this;return o.a.createElement("canvas",{className:"img-responsive",style:{border:"0px solid black"},ref:function(t){e.m_mount=t},"min-width":"240px",width:"240px",height:"200px"})}},{key:"drawCentral",value:function(e,t,i,a){e.strokeStyle="rgb(190, 190, 190)",e.lineWidth=4;var o=Math.floor(.5*t),r=200;e.beginPath(),e.moveTo(o,Math.floor(195*i/r)),e.lineTo(o,Math.floor(88*i/r)),e.stroke();for(var n=20*t/240,s=0;s<=5;s++){var l=s/5,m=Math.floor(131+64*l),h=8e-4*a+l*(3.1415926*.4),u=Math.floor(.2*n+.8*n*Math.cos(h));e.beginPath(),e.moveTo(o-.5*u,m),e.lineTo(o+.5*u,m),e.stroke()}var c=[112,89,112,81,112,62,112,49,113,36,104,31,94,32,94,20,96,8,108,8,112,11,120,12,128,11,132,8,146,8,146,20,146,32,136,31,127,36,128,49,128,62,128,81,128,89,119,88],d=Math.floor(c.length/2),_=Math.floor(d/2);e.fillStyle="rgb(255, 210, 210)",e.beginPath(),e.moveTo(o,Math.floor(88*i/r));for(var f=0,v=0;v<_;v++,f+=4){var p=Math.floor(t*c[f+0]/240),g=Math.floor(i*c[f+1]/r),S=Math.floor(t*c[f+2]/240),y=Math.floor(i*c[f+3]/r);e.quadraticCurveTo(p,g,S,y)}e.stroke(),e.fill()}},{key:"drawHeart",value:function(e,t,a,o,r,n,s,l){var m=240,h=200,u=[186,195,179,195,171,188,149,166,132,126,123,111,131,100,145,78,145,60,150,47,159,50,184,56,203,49,213,41,217,51,226,77,218,104,208,134,208,158,207,167,203,175,196,195,186,195],c=Math.floor((u.length-1)/2),d={x:0,y:0},_={x:0,y:0};i.vecTransform(o,r,s,n,u[0],u[1],d),i.vecTransform(o,r,s,n,u[26],u[27],_);var f=Math.floor(t*d.x/m),v=Math.floor(a*d.y/h),p=Math.floor(t*_.x/m),g=Math.floor(a*_.y/h),S=e.createLinearGradient(f,v,p,g);S.addColorStop(0,"rgb(86, 0, 0)"),S.addColorStop(1,"rgb(255, 170, 170)"),e.fillStyle=S,e.beginPath(),i.vecTransform(o,r,s,n,u[0],u[1],d);var y=Math.floor(t*d.x/m),x=Math.floor(a*d.y/h);e.moveTo(y,x);for(var b=2,D=0;D<c;D++,b+=4){i.vecTransform(o,r,s,n,u[b+0],u[b+1],d),i.vecTransform(o,r,s,n,u[b+2],u[b+3],_);var T=Math.floor(t*d.x/m),E=Math.floor(a*d.y/h),M=Math.floor(t*_.x/m),w=Math.floor(a*_.y/h);e.quadraticCurveTo(T,E,M,w)}e.stroke(),e.fill();var R=[[151,75,154,68,155,61,151,55],[145,89,156,86,165,82,172,77,177,69,177,61],[143,100,157,101,168,98,179,94,186,87,192,80,197,76,205,75],[146,109,160,107,172,107,183,112,192,119,199,125,200,130,198,137,195,142,189,144],[145,123,160,124,171,128,178,138,183,151,184,160,181,168],[149,142,161,146,167,153,171,158,171,164]],k="rgba(180, 180, 180, "+l.toFixed(2)+")";e.strokeStyle=k,e.lineWidth=1;for(var O=R.length,A=0;A<O;A++){var C=R[A],I=C.length;e.beginPath();for(var F=0,P=0;P<I;P++,F+=2){i.vecTransform(o,r,s,n,C[F+0],C[F+1],d);var U=Math.floor(t*d.x/m),X=Math.floor(a*d.y/h);0===P?e.moveTo(U,X):e.lineTo(U,X)}e.stroke();var z=-1,L=-1;F=0;for(var N=0;N<I;N++,F+=2){i.vecTransform(o,r,s,n,C[F+0],C[F+1],d);var V=Math.floor(t*d.x/m),B=Math.floor(a*d.y/h);0===N||i.drawLeave(e,z,L,V,B,N),z=V,L=B}}}},{key:"renderWithCtx",value:function(){var e=this.m_mount;if(null!==e){var t=e.getContext("2d"),i=e.clientWidth,a=e.clientHeight;if(i*a!==0){t.fillStyle="rgb(250, 250, 250)",t.fillRect(0,0,i,a);var o=Date.now();this.drawCentral(t,i,a,o);var r=Math.abs(Math.cos(.001*o)),n=.6+.4*r,s=Math.abs(Math.cos(.001*o+1.57)),l=.6+.4*s;this.drawHeart(t,i,a,178,112,!1,l,s);this.drawHeart(t,i,a,62,112,!0,n,r)}}}}],[{key:"vecTransform",value:function(e,t,i,a,o,r,n){var s=a?178-o:o-178,l=r-112;n.x=e+s*i,n.y=t+l*i}},{key:"drawLeave",value:function(e,t,i,a,o,r){var n=a-t,s=o-i,l=0===(1&r)?78.5/180:-78.5/180,m=n*Math.cos(l)-s*Math.sin(l),h=n*Math.sin(l)+s*Math.cos(l),u=Math.floor(.5*(t+a)),c=Math.floor(.5*(i+o));e.beginPath(),e.moveTo(u,c),e.lineTo(Math.floor(u+.8*m),Math.floor(c+.8*h)),e.stroke()}}]),i}(o.a.Component),Ja=Object(s.b)((function(e){return e}))(Qa),$a=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).state={modalShow:!1},a.onShow=a.onShow.bind(Object(y.a)(a)),a.onHide=a.onHide.bind(Object(y.a)(a)),a}return Object(p.a)(i,[{key:"onShow",value:function(){this.setState({modalShow:!0})}},{key:"onHide",value:function(){this.setState({modalShow:!1})}},{key:"render",value:function(){var e=Ka.version,t=Ka.name,i=Ka.description,a=Ka.author,r=Ka.year,n=o.a.createElement(A.a,{onClick:this.onShow,variant:"secondary"},o.a.createElement("i",{className:"fa fa-question-circle"}),"About"),s=o.a.createElement(C.a,{key:"about",placement:"bottom",overlay:o.a.createElement(I.a,null,"See detailed information about this app")},o.a.createElement(A.a,{onClick:this.onShow,variant:"secondary"},o.a.createElement("i",{className:"fa fa-question-circle"}),"About")),l=this.state.modalShow?n:s;return o.a.createElement(M.a.Item,null,l,o.a.createElement(oi.a,{show:this.state.modalShow,onHide:this.onHide},o.a.createElement(oi.a.Title,null,t),o.a.createElement(oi.a.Header,null,o.a.createElement(oi.a.Body,{className:"text-center"},o.a.createElement(Ja,null),o.a.createElement("p",null,i),o.a.createElement("p",null,o.a.createElement("b",null,"Version: ")," ",e),o.a.createElement("p",null,o.a.createElement("b",null,"Copyright: ")," ",r," ",a))),o.a.createElement(oi.a.Footer,null,o.a.createElement(A.a,{onClick:this.onHide,variant:"secondary"},"Close"))))}}]),i}(o.a.Component),eo=i(202),to=!0,io=function(){function e(){Object(v.a)(this,e)}return Object(p.a)(e,null,[{key:"writeIntToBuffer",value:function(e,t,i){new DataView(t,i).setInt32(0,e,to)}},{key:"writeShortToBuffer",value:function(e,t,i){new DataView(t,i).setInt16(0,e,to)}},{key:"writeFloatToBuffer",value:function(e,t,i){new DataView(t,i).setFloat32(0,e,to)}},{key:"fpsToDimInfo",value:function(e,t,i){return 3&e|(3&t)<<2|(3&i)<<4}},{key:"writeBuffer",value:function(t,i){var a=i.x,o=i.y,r=i.z;(a<=0||o<=0||r<=0)&&console.log("SaverNifti. volume pixels dim is bad: ".concat(a," * ").concat(o," * ").concat(r," "));var n=i.pixdim1,s=i.pixdim2,l=i.pixdim3,m=1e-5;(n>5||s>5||l>5)&&console.log("SaverNifti. volume grid size is too much: ".concat(n," * ").concat(s," * ").concat(l," ")),(n<m||s<m||l<m)&&console.log("SaverNifti. volume grid size is too min: ".concat(n," * ").concat(s," * ").concat(l," ")),t.length!==a*o*r&&console.log("SaverNifti. bad input volume size = ".concat(t.length,", expected = ").concat(a,"*").concat(o,"*").concat(r));for(var h=1e6,u=-1e6,c=a*o*r,d=0;d<c;d++)h=t[d]<h?t[d]:h,u=t[d]>u?t[d]:u;u-h<60&&console.log("SaverNifti. bad input volume data range: [".concat(h," .. ").concat(u,"]"));var _=new ArrayBuffer(348+2*t.length),f=new Uint8Array(_),v=0;e.writeIntToBuffer(348,_,v),v+=4,v+=10,v+=18,v+=4,v+=2,v+=1;var p=e.fpsToDimInfo(1,2,3);f[v]=p,v+=1;e.writeShortToBuffer(3,_,v),v+=2,e.writeShortToBuffer(i.x,_,v),v+=2,e.writeShortToBuffer(i.y,_,v),v+=2,e.writeShortToBuffer(i.z,_,v),v+=2,v+=8,v+=4,v+=4,v+=4,v+=2;e.writeShortToBuffer(512,_,v),v+=2;e.writeShortToBuffer(16,_,v),v+=2,v+=2,v+=4,e.writeFloatToBuffer(i.pixdim1,_,v),v+=4,e.writeFloatToBuffer(i.pixdim2,_,v),v+=4,e.writeFloatToBuffer(i.pixdim3,_,v),v+=4,v+=16;e.writeFloatToBuffer(352,_,v),v+=4;e.writeFloatToBuffer(1,_,v),v+=4;e.writeFloatToBuffer(0,_,v),v+=4;f[v+=2]=1;f[++v]=10,v++,v+=16,v+=8,v+=80,v+=24;e.writeShortToBuffer(1,_,v),v+=2,e.writeShortToBuffer(1,_,v),v+=2;f[(v=344)+0]=110,f[v+1]=43,f[v+2]=49,v+=4;var g=new Uint16Array(t);return new Uint16Array(_,v).set(g),_}}]),e}(),ao=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onModalShow=a.onModalShow.bind(Object(y.a)(a)),a.onModalHide=a.onModalHide.bind(Object(y.a)(a)),a.onButtonSave=a.onButtonSave.bind(Object(y.a)(a)),a.onTexChange=a.onTexChange.bind(Object(y.a)(a)),a.handleFormSubmit=a.handleFormSubmit.bind(Object(y.a)(a)),a.onSaveNifti=a.onSaveNifti.bind(Object(y.a)(a)),a.m_hideFunc=null,a.state={showModalSaveNifti:!1,text:"dump"},a}return Object(p.a)(i,[{key:"onButtonSave",value:function(){this.m_hideFunc(),this.onSaveNifti()}},{key:"onModalShow",value:function(){this.setState({showModalSaveNifti:!0})}},{key:"onModalHide",value:function(){this.setState({showModalSaveNifti:!1})}},{key:"handleFormSubmit",value:function(e){e.preventDefault(),this.m_hideFunc(),this.onSaveNifti()}},{key:"onTexChange",value:function(e){var t=e.target.value;this.setState({text:t})}},{key:"onSaveNifti",value:function(){var e=this.props,t=e.volumeSet,i=e.volumeIndex,a=t.getVolume(i),o=a.m_xDim,r=a.m_yDim,n=a.m_zDim,s={x:o,y:r,z:n,pixdim1:a.m_boxSize.x/o,pixdim2:a.m_boxSize.y/r,pixdim3:a.m_boxSize.z/n},l=a.m_dataArray,m=e.volumeRenderer;null!==m&&(l=m.volumeUpdater.bufferR);var h=io.writeBuffer(l,s),u=new Blob([h],{type:"application/octet-stream"}),c=window.URL.createObjectURL(u),d=this.state.text;d.endsWith(".nii")||(d=d.concat(".nii"));var _=document.createElement("a");_.download=d,_.innerHTML="Download File",_.href=c,_.onclick=function(e){return document.body.removeChild(e.target)},_.style.display="none",document.body.appendChild(_),_.click()}},{key:"render",value:function(){var e=this,t=this.props.stateVis,i=this.props.onHide;return this.m_hideFunc=i,o.a.createElement(oi.a,{show:t,onHide:i},o.a.createElement(oi.a.Body,null,o.a.createElement(oi.a.Title,null,"Save as Nifti"),o.a.createElement(se.a,{onSubmit:function(t){return e.handleFormSubmit(t)}},o.a.createElement(eo.a,null,o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,o.a.createElement(se.a.Control,{required:!0,type:"text",placeholder:"Enter file name here",defaultValue:this.state.text,onChange:this.onTexChange})),o.a.createElement("th",null,o.a.createElement(se.a.Label,{className:"text-left"},".nii")))))),o.a.createElement(x.a,null,o.a.createElement(b.a,{lg:!0,xl:"2"},o.a.createElement(A.a,{onClick:this.onButtonSave},"Save")),o.a.createElement(b.a,{lg:!0,xl:"2"},o.a.createElement(A.a,{onClick:i},"Cancel")),o.a.createElement(b.a,{lg:!0,xl:"8"}))))}}]),i}(o.a.Component),oo=Object(s.b)((function(e){return e}))(ao),ro=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onModalSaveNiftiShow=a.onModalSaveNiftiShow.bind(Object(y.a)(a)),a.onModalSaveNiftiHide=a.onModalSaveNiftiHide.bind(Object(y.a)(a)),a.state={showModalSaveNifti:!1},a}return Object(p.a)(i,[{key:"componentDidMount",value:function(){}},{key:"onModalSaveNiftiShow",value:function(){this.setState({showModalSaveNifti:!0})}},{key:"onModalSaveNiftiHide",value:function(){this.setState({showModalSaveNifti:!1})}},{key:"render",value:function(){var e=this,t=!this.props.isLoaded;return o.a.createElement(ai.a,{id:"save-nav-dropdown",disabled:t,title:o.a.createElement("div",{style:{display:"inline-block"}},o.a.createElement("i",{className:"fas fa-save"}),"Save")},o.a.createElement(ai.a.Item,{onClick:function(t){return e.onModalSaveNiftiShow(t)}},o.a.createElement("i",{className:"fas fa-globe"}),"Save to Nifti"),o.a.createElement(oo,{stateVis:this.state.showModalSaveNifti,onHide:this.onModalSaveNiftiHide}))}}]),i}(o.a.Component),no=Object(s.b)((function(e){return e}))(ro),so=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onModalHide=a.onModalHide.bind(Object(y.a)(a)),a.state={showModalDemo:!1,currentSlice:0},a}return Object(p.a)(i,[{key:"onModalHide",value:function(){this.setState({showModalDemo:!1})}},{key:"onSelectSlice",value:function(e){var t=e.target.value.split(" "),i=parseInt(t[1]);console.log("onSelectSlice. index = ".concat(i)),this.setState({currentSlice:i})}},{key:"render",value:function(){var e=this.props.stateVis,t=this.props.onHide,i=this.props.dicomInfo,a=[],r=[];return null!==i&&(a=i.m_sliceInfo).length>0&&(r=a[this.state.currentSlice].m_tags),o.a.createElement(oi.a,{show:e,onHide:t,size:"xl"},o.a.createElement(oi.a.Header,{closeButton:!0},o.a.createElement(oi.a.Title,null,"Dicom information")),o.a.createElement(oi.a.Body,null,o.a.createElement(se.a,null,o.a.createElement(se.a.Group,{controlId:"modalDicomTags.slice"},o.a.createElement(se.a.Label,null,"Choose slice"),o.a.createElement(se.a.Control,{as:"select",onChange:this.onSelectSlice.bind(this)},a.map((function(e,t){var i=e.m_sliceName+" ("+e.m_fileName+")";return o.a.createElement("option",{key:t,value:i}," ",i," ")}))))),o.a.createElement(eo.a,{striped:!0,bordered:!0,responsive:!0},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,"Tag"),o.a.createElement("th",null,"Attribute Name"),o.a.createElement("th",null,"Attribute Value"))),o.a.createElement("tbody",null,r.map((function(e,t){var i=e.m_tag,a=e.m_attrName,r=e.m_attrValue.length>0?e.m_attrValue:"_";return o.a.createElement("tr",{key:t},o.a.createElement("td",null,i),o.a.createElement("td",null,a),o.a.createElement("td",null,r))}))))))}}]),i}(o.a.Component),lo=Object(s.b)((function(e){return e}))(so),mo=function(){function e(){Object(v.a)(this,e)}return Object(p.a)(e,null,[{key:"bytesFromBase64",value:function(e){for(var t=window.atob(e),i=new Uint8Array(t.length),a=0;a<i.length;++a)i[a]=t[a].charCodeAt(0);return i.buffer}},{key:"bytesToBase64",value:function(e){for(var t=new Uint8Array(e),i="",a=0;a<t.byteLength;a++)i+=String.fromCharCode(t[a]);return window.btoa(i)}},{key:"dataUriToBlob",value:function(t){var i=t.split(/[:;,]/),a=i.length;return a>=3&&"base64"===i[a-2]?new Blob([e.bytesFromBase64(i[a-1])]):null}},{key:"showScreenshotInNewWindow",value:function(e){window.open("about:blank","Screenshot","width=800,height=600").document.write('<body style="margin:0"><img src="'.concat(e,'" alt="from canvas" /></body>'))}},{key:"saveScreenShotToFile",value:function(t,i){var a=e.dataUriToBlob(t);if("undefined"!==typeof window&&window.navigator&&window.navigator.msSaveBlob)window.navigator.msSaveBlob(a,i);else if("undefined"!==typeof document){var o=document.createElement("a");o.download=i,o.innerHTML="download",o.href=window.URL.createObjectURL(a),document.body.appendChild(o),o.click(),document.body.removeChild(o)}}},{key:"formatTwoDigits",value:function(e){return e>=10?e:"0".concat(e)}},{key:"getFormattedDateString",value:function(){var t=new Date,i=t.getUTCFullYear(),a=e.formatTwoDigits(1+t.getUTCMonth()),o=e.formatTwoDigits(t.getUTCDate()),r=e.formatTwoDigits(t.getHours()),n=e.formatTwoDigits(t.getMinutes()),s=e.formatTwoDigits(t.getSeconds());return"".concat(i).concat(a).concat(o,"-").concat(r).concat(n).concat(s)}},{key:"makeScreenshot",value:function(t,i,a){var o=t.screenshot(i,a);if(null!==o){var r=e.getFormattedDateString(),n="screenshot-".concat(r,".png");e.saveScreenShotToFile(o,n)}}}]),e}(),ho=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onModalDicomTagsShow=a.onModalDicomTagsShow.bind(Object(y.a)(a)),a.onModalDicomTagsHide=a.onModalDicomTagsHide.bind(Object(y.a)(a)),a.onModalScreenshot=a.onModalScreenshot.bind(Object(y.a)(a)),a.state={showModalDicomTags:!1},a}return Object(p.a)(i,[{key:"onModalDicomTagsShow",value:function(){this.setState({showModalDicomTags:!0})}},{key:"onModalDicomTagsHide",value:function(){this.setState({showModalDicomTags:!1})}},{key:"onModalScreenshot",value:function(){var e=this.props,t=e.modeView;if(t===h.VIEW_2D){var i=e.graphics2d;mo.makeScreenshot(i,800,600)}else if(t===h.VIEW_3D||t===h.VIEW_3D_LIGHT){var a=e.volumeRenderer;mo.makeScreenshot(a,800,600)}else console.log("onModalScreenshot. not implemented yet")}},{key:"componentDidMount",value:function(){}},{key:"render",value:function(){var e=!this.props.isLoaded;return o.a.createElement(ai.a,{id:"save-nav-dropdown",disabled:e,title:o.a.createElement("div",{style:{display:"inline-block"}},o.a.createElement("i",{className:"fas fa-book"}),"Report")},o.a.createElement(ai.a.Item,{onClick:this.onModalDicomTagsShow},o.a.createElement("i",{className:"fas fa-clipboard-list"}),"Show tags"),o.a.createElement(ai.a.Item,{onClick:this.onModalScreenshot},o.a.createElement("i",{className:"fas fa-camera"}),"Screenshot"),o.a.createElement(lo,{stateVis:this.state.showModalDicomTags,onHide:this.onModalDicomTagsHide}))}}]),i}(o.a.Component),uo=Object(s.b)((function(e){return e}))(ho),co=function(){function e(){Object(v.a)(this,e),this.m_xDim=0,this.m_yDim=0,this.m_zDim=0,this.m_stack3d=null,this.m_maxStack3d=0,this.m_indexStack3d=0,this.m_numFilled3d=0}return Object(p.a)(e,[{key:"floodFill3dThreshold",value:function(t,i,a,o,r,n){var s=t*i,l=[],m=255;for(this.m_numFilled3d=0,0!==e.isVisible(o,r.x+r.y*t+r.z*t*i,n)&&console.log("Bad seed point: ".concat(r.x,", ").concat(r.y,", ").concat(r.z)),l.push({x:r.x,y:r.y,z:r.z});0!==l.length;){var h=l.pop(),u=void 0,c=h.y,d=h.z,_=c*t,f=d*s,v=0;for(u=h.x;u>=0&&!e.isVisible(o,u+_+f,n);u--)v=u+1;v=u+1;var p=0;for(u=h.x;u<t&&!e.isVisible(o,u+_+f,n);u++)p=u-1;p=u-1;var g=m,S=m,y=m,x=m;for(u=v;u<=p;u++)o[u+_+f]=m,this.m_numFilled3d++,c>0&&e.isVisible(o,u+_+f-t,n)!==g&&0===(g=m-g)&&l.push({x:u,y:c-1,z:d}),c<i-1&&e.isVisible(o,u+_+f+t,n)!==S&&0===(S=m-S)&&l.push({x:u,y:c+1,z:d}),d>3&&e.isVisible(o,u+_+f-s,n)!==y&&0===(y=m-y)&&l.push({x:u,y:c,z:d-1}),d<a-1-3&&e.isVisible(o,u+_+f+s,n)!==x&&0===(x=m-x)&&l.push({x:u,y:c,z:d+1})}return 1}}],[{key:"isVisible",value:function(e,t,i){return e[t]<=i?0:255}}]),e}(),_o=40,fo=function(){function e(t,i,a,o){Object(v.a)(this,e),this.m_xDim=i,this.m_yDim=a,this.m_zDim=o,this.m_volTexSrc=t}return Object(p.a)(e,[{key:"findSeedPointOnCentralSlice",value:function(e){var t,i,a=Math.floor(this.m_zDim/2),o=Math.floor(this.m_yDim/2),r=-1,n=-1,s=a*this.m_xDim*this.m_yDim,l=-1,m=170/512;for(i=0;i<o;i++){l=i*this.m_xDim;var h=0;for(t=0;t<this.m_xDim;t++)h+=this.m_volTexSrc[t+l+s]>_o?1:0;if(!(h/this.m_xDim<m?1:0))break;r=i}for(i=this.m_yDim-1;i>o;i--){l=i*this.m_xDim;var u=0;for(t=0;t<this.m_xDim;t++)u+=this.m_volTexSrc[t+l+s]>_o?1:0;if(!(u/this.m_xDim<m?1:0))break;n=i}var c=Math.floor(r+.13274336283185842*(n-r)),d=Math.floor(n-.17699115044247787*(n-r));r=c,n=d;var _=new Float32Array(8),f=!1;for(i=r;i<=n&&!f;i++){for(t=0;t<8;t++)_[t]=0;l=i*this.m_xDim;for(t=0;t<this.m_xDim;t++){_[this.m_volTexSrc[t+l+s]>>5]+=1}for(t=0;t<8;t++)_[t]/=this.m_xDim;if(_[0]<.7){f=!0;break}}var v=0,p=Math.floor(this.m_xDim/2);for(t=0;t<p&&!((v=this.m_volTexSrc[t+l+s])>_o);t++);for(t+=8;t<p&&!((v=this.m_volTexSrc[t+l+s])<_o);t++);if(t===p)return 1;for(var g=0;g<8&&!((v=this.m_volTexSrc[t+l+s])>_o);g++)t++;return v>_o?1:(e.x=t,e.y=i,e.z=a,0)}},{key:"findSeedPointOnFirstSlice",value:function(e){var t,i,a=this.m_volTexSrc,o=!1,r=Math.floor(7*this.m_xDim/512),n=Math.floor(.2*this.m_yDim),s=Math.floor(.8*this.m_yDim),l=Math.floor(.2*this.m_xDim),m=Math.floor(.8*this.m_xDim),h=2*this.m_xDim*this.m_yDim;for(i=n;i<s&&!o;i++){var u=i*this.m_xDim;for(t=l;t<m&&!o;t++){if(!(a[t+u+h]>=50)){var c=0,d=void 0,_=void 0,f=void 0;for(f=0,_=i-1;_>=0;_--,f++){if(a[t+_*this.m_xDim+h]>50&&f>r){c++;break}}for(f=0,_=i+1;_<this.m_yDim;_++,f++){if(a[t+_*this.m_xDim+h]>50){f>r&&c++;break}}for(f=0,d=t-1;d>=0;d--,f++){if(a[d+i*this.m_xDim+h]>50){f>r&&c++;break}}for(f=0,d=t+1;d<this.m_xDim;d++,f++){if(a[d+i*this.m_xDim+h]>50){f>r&&c++;break}}if(4===c){o=!0,e.x=t,e.y=i;for(var v=0,p=255,g=0,S=0;S<2;S++)for(var y=(S+2)*this.m_xDim*this.m_yDim,x=-2;x<=2;x++)for(var b=(x+i)*this.m_xDim,D=-2;D<=2;D++){var T=a[D+t+b+y];T<17&&(v+=T,g++,T<p&&(p=T,e.x=D+t,e.y=x+i))}e.z=Math.floor(v/g);break}}}}return o?0:1}}]),e}(),vo=function(){function e(t){Object(v.a)(this,e),this.VESSEL=!0,this.m_xDim=t.m_xDim,this.m_yDim=t.m_yDim,this.m_zDim=t.m_zDim,this.xBorderMin=0,this.yBorderMin=0,this.xBorderMax=0,this.yBorderMax=0,this.m_volTexSrc=t.m_dataArray,this.m_volTexMask=new Uint8Array(this.m_xDim*this.m_yDim*this.m_zDim),this.m_volTexMask1=new Uint8Array(this.m_xDim*this.m_yDim*this.m_zDim),this.m_volTexMask2=new Uint8Array(this.m_xDim*this.m_yDim*this.m_zDim),this.m_ratioUpdate=0}return Object(p.a)(e,[{key:"detectNonEmptyBox",value:function(e,t,i,a){var o,r,n,s,l=t*i,m=Math.floor(t/2),h=Math.floor(i/2);for(s=!0,o=0;o<m&&s;o++)for(r=0;r<i&&s;r++)for(n=0;n<a&&s;n++){e[n*l+r*t+o]>8&&(s=!1)}for(this.xBorderMin=o-1,s=!0,o=t-1;o>m&&s;o--)for(r=0;r<i&&s;r++)for(n=0;n<a&&s;n++){e[n*l+r*t+o]>8&&(s=!1)}for(this.xBorderMax=o+1,s=!0,r=0;r<h&&s;r++)for(o=0;o<t&&s;o++)for(n=0;n<a&&s;n++){e[n*l+r*t+o]>8&&(s=!1)}for(this.yBorderMin=r-1,s=!0,r=i-1;r>h&&s;r--)for(o=0;o<t&&s;o++)for(n=0;n<a&&s;n++){e[n*l+r*t+o]>8&&(s=!1)}this.yBorderMax=r+1}},{key:"delatation",value:function(){var e,t,i,a,o,r,n=0,s=0,l=0,m=0;for(i=0;i<this.m_zDim;i++)for(t=this.yBorderMin;t<this.yBorderMax;t++)for(e=this.xBorderMin;e<this.xBorderMax;e++){for(l=0,r=-1;r<2;r++)for(n=(i+r)*this.m_xDim*this.m_yDim,o=-1;o<2;o++)for(s=(t+o)*this.m_xDim,a=-1;a<2;a++)255===this.m_volTexMask[e+a+s+n]&&l++;m=0,l>0&&(m=255),this.m_volTexMask1[e+t*this.m_xDim+i*this.m_xDim*this.m_yDim]=m}}},{key:"erosion",value:function(){var e,t,i,a,o,r,n=0,s=0,l=0,m=0;for(i=0;i<this.m_zDim;i++)for(t=this.yBorderMin;t<this.yBorderMax;t++)for(e=this.xBorderMin;e<this.xBorderMax;e++)if(l=e+t*this.m_xDim+i*this.m_xDim*this.m_yDim,this.m_volTexMask2[l]=this.m_volTexMask1[l],this.m_volTexMask1[l]!==this.m_volTexMask[l]){for(m=0,r=-1;r<2;r++)for(n=(i+r)*this.m_xDim*this.m_yDim,o=-1;o<2;o++)for(s=(t+o)*this.m_xDim,a=-1;a<2;a++)0===this.m_volTexMask1[e+a+s+n]&&m++;m>0&&(this.m_volTexMask2[l]=0)}}},{key:"run",value:function(){var e=this.m_xDim*this.m_yDim*this.m_zDim,t=255;if(0===this.m_ratioUpdate){this.vSeed={x:0,y:0,z:0};var i;if(this.seedPoints=new fo(this.m_volTexSrc,this.m_xDim,this.m_yDim,this.m_zDim),i=this.seedPoints.findSeedPointOnCentralSlice(this.vSeed))return console.log("Lungs Central fill run: seed point not found"),i;for(var a=0;a<e;a++)this.m_volTexMask[a]=this.m_volTexSrc[a];return this.m_ratioUpdate=20,!1}if(20===this.m_ratioUpdate){return this.fillTool=new co,this.fillTool.floodFill3dThreshold(this.m_xDim,this.m_yDim,this.m_zDim,this.m_volTexMask,this.vSeed,40),this.m_ratioUpdate=50,!1}if(50===this.m_ratioUpdate){var o,r=255;if(this.VESSEL)for(o=0;o<e;o++){var n=0;this.m_volTexMask[o]===r&&(n=r),this.m_volTexMask[o]=n}else for(o=0;o<e;o++){var s=0;this.m_volTexMask[o]===r&&(s=Math.floor(6.375*this.m_volTexSrc[o])),this.m_volTexSrc[o]=s}return this.m_ratioUpdate=80,!1}if(80===this.m_ratioUpdate){var l;for(l=0;l<e;l++){var m=0;this.m_volTexMask[l]===t&&(m=t),this.m_volTexMask[l]=m}this.detectNonEmptyBox(this.m_volTexMask,this.m_xDim,this.m_yDim,this.m_zDim),this.delatation(),this.erosion();for(var h=0;h<e;h++)this.m_volTexMask1[h]=this.m_volTexSrc[h];var u=this.seedPoints.findSeedPointOnFirstSlice(this.vSeed);return u?(console.log("Airway fill run: seed point not found"),u):(this.minv=this.vSeed.z,this.vSeed.z=2,console.log("Airway fill run: seed point: ".concat(this.vSeed.x," ").concat(this.vSeed.y," ").concat(this.minv)),this.m_ratioUpdate=90,!1)}if(90===this.m_ratioUpdate){this.fillTool.floodFill3dThreshold(this.m_xDim,this.m_yDim,this.m_zDim,this.m_volTexMask1,this.vSeed,this.minv);for(var c=0;c<e;c++){var d=.5*this.m_volTexMask[c];this.m_volTexMask2[c]-this.m_volTexMask[c]===t&&(d=128+this.m_volTexSrc[c]),this.m_volTexMask1[c]===t&&(d=t),this.m_volTexSrc[c]=d}}return!0}}]),e}();vo.RESULT_NA=0,vo.RESULT_COMPLETED=1,vo.RESULT_BAD_HIST=2,vo.RESULT_SEED_X_NOT_FOUND=3;var po=function(){function e(){Object(v.a)(this,e),this.m_numVertices=0,this.m_vertices=null,this.m_normals=null,this.m_numTriangles=0,this.m_numTrianglesAllocated=0,this.m_indices=null,this.m_matColor=null,this.m_isWireframe=0,this.m_boxSize=null,this.m_boxCenter=null}return Object(p.a)(e,[{key:"createFromTetrahedronGenerator",value:function(e){var t=e.getNumVertices(),i=e.getNumTriangles();this.m_numVertices=t,this.m_numTriangles=i;this.m_vertices=new Float32Array(4*t),this.m_indices=new Uint32Array(3*i);for(var a=0,o=0;a<t;a++,o+=4){var r=e.getVertex(a);this.m_vertices[o+0]=r.x,this.m_vertices[o+1]=r.y,this.m_vertices[o+2]=r.z,this.m_vertices[o+3]=1}for(var n=0,s=0;n<i;n++,s+=3){var l=e.getTriangle(n);this.m_indices[s+0]=l[0],this.m_indices[s+1]=l[1],this.m_indices[s+2]=l[2]}return 1}},{key:"fromBufferGeometry",value:function(e){var t=new ce.r;t.fromBufferGeometry(e),t.mergeVertices();var i=t.vertices.length,a=t.faces.length;this.m_numVertices=i,this.m_numTriangles=a;this.m_vertices=new Float32Array(4*i),this.m_indices=new Uint32Array(3*a);for(var o=0,r=0;o<i;o++,r+=4){var n=t.vertices[o];this.m_vertices[r+0]=n.x,this.m_vertices[r+1]=n.y,this.m_vertices[r+2]=n.z,this.m_vertices[r+3]=1}for(var s=0,l=0;s<a;s++,l+=3){var m=t.faces[s];this.m_indices[l+0]=m.a,this.m_indices[l+1]=m.b,this.m_indices[l+2]=m.c}return 1}},{key:"createFromEllipse",value:function(e,t,i,a){var o,r,n=3.1415926535,s=i*a;this.m_numTriangles=2*s,this.m_numVertices=i*(a+1),this.m_vertices=new Float32Array(4*this.m_numVertices),this.m_indices=new Uint32Array(3*this.m_numTriangles);var l=0,m=.5*n*.97;for(r=0;r<=a;r++){var h=r/a*(2*m)-m;for(o=0;o<i;o++){var u=o/i*n*2,c=t.y*Math.sin(h),d=Math.cos(h),_=t.x*d*Math.cos(u),f=t.z*d*Math.sin(u);this.m_vertices[l+0]=e.x+_,this.m_vertices[l+1]=e.y+c,this.m_vertices[l+2]=e.z+f,this.m_vertices[l+3]=0,l+=4}}for(l=0,r=0;r<a;r++){var v=r*i;for(o=0;o<i;o++){var p=o+1;p>=i&&(p=0),this.m_indices[l+0]=v+p+i,this.m_indices[l+1]=v+p,this.m_indices[l+2]=v+o,l+=3,this.m_indices[l+0]=v+o,this.m_indices[l+1]=v+o+i,this.m_indices[l+2]=v+p+i,l+=3}}}},{key:"getNumVertices",value:function(){return this.m_numVertices}},{key:"getVertices",value:function(){return this.m_vertices}},{key:"getNormals",value:function(){return this.m_normals}},{key:"getNumTriangles",value:function(){return this.m_numTriangles}},{key:"getIndices",value:function(){return this.m_indices}},{key:"saveGeoToObjFile",value:function(e){for(var t="# Render geometry save\n",i=this.m_numVertices,a=i.toString(),o=this.m_numTriangles,r=o.toString(),n=0,s=0;n<i;n++,s+=4){var l=this.m_vertices[s+0],m=this.m_vertices[s+1],h=this.m_vertices[s+2],u=l.toString(),c=m.toString(),d=h.toString();t=(t=(t=(t=(t=(t=(t=t.concat("v  ")).concat(u)).concat(" ")).concat(c)).concat(" ")).concat(d)).concat("\n")}var _="# ".concat(a," vertices\n");t=(t=t.concat(_)).concat("g TetraObj\n");for(var f=0,v=0;f<o;f++,v+=3){var p=1+this.m_indices[v+0],g=1+this.m_indices[v+1],S=1+this.m_indices[v+2],y="f ".concat(p," ").concat(g," ").concat(S,"\n");t=t.concat(y)}var x="# ".concat(r," triangles\n");t=t.concat(x);var b=(new TextEncoder).encode(t),D=new Blob([b],{type:"application/octet-stream"}),T=URL.createObjectURL(D),E=document.createElement("a");E.setAttribute("href",T),E.setAttribute("download",e);var M=document.createEvent("MouseEvents");M.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),E.dispatchEvent(M)}},{key:"createNormalsForGeometry",value:function(){this.m_normals=new Array(this.m_numVertices);for(var e=0;e<this.m_numVertices;e++)this.m_normals[e]=new ce.R;for(var t=new Array(this.m_numTriangles),i=0;i<this.m_numTriangles;i++)t[i]=new ce.R;var a,o;for(a=0,o=0;a<this.m_numTriangles;a++,o+=3){var r=4*this.m_indices[o+0],n=4*this.m_indices[o+1],s=4*this.m_indices[o+2],l=new ce.R,m=new ce.R,h=new ce.R;l.x=this.m_vertices[r+0],l.y=this.m_vertices[r+1],l.z=this.m_vertices[r+2],m.x=this.m_vertices[n+0],m.y=this.m_vertices[n+1],m.z=this.m_vertices[n+2],h.x=this.m_vertices[s+0],h.y=this.m_vertices[s+1],h.z=this.m_vertices[s+2];var u=new ce.R,c=new ce.R;u.subVectors(m,l),c.subVectors(h,m);var d=new ce.R;d.crossVectors(u,c);if(d.lengthSq()<1e-8){return-10}t[a].set(d.x,d.y,d.z)}for(var _=0;_<this.m_numVertices;_++)this.m_normals[_].set(0,0,0);for(a=0,o=0;a<this.m_numTriangles;a++,o+=3){var f=this.m_indices[o+0],v=this.m_indices[o+1],p=this.m_indices[o+2],g=t[a];this.m_normals[f].add(g),this.m_normals[v].add(g),this.m_normals[p].add(g)}for(var S=0;S<this.m_numVertices;S++){if(this.m_normals[S].lengthSq()<1e-8){return-20}this.m_normals[S].normalize()}return 1}}]),e}(),go=16,So=function(){function e(){Object(v.a)(this,e),this.m_vertNeib=null}return Object(p.a)(e,[{key:"performSmoothStep",value:function(e,t,i,a,o){var r,n,s;null===this.m_vertNeib&&(this.m_vertNeib=new Int32Array(e*go),this.getVerticesNeighbours(e,t,i,a));var l=new ce.R(0,0,0);for(r=0,n=0;r<e;r++,n+=4){var m=new ce.R(t[n+0],t[n+1],t[n+2]);l.add(m)}var h=1/e;l.multiplyScalar(h);var u=0;for(r=0,n=0,s=0;r<e;r++,n+=4,s+=go){for(var c=new ce.R(0,0,0),d=0,_=0;_<go;_++){var f=this.m_vertNeib[s+_];if(-1===f)break;var v=4*f;c.x+=t[v+0],c.y+=t[v+1],c.z+=t[v+2],d++}if(0!==d){var p=1/d;c.multiplyScalar(p);var g=new ce.R(t[n+0],t[n+1],t[n+2]),S=new ce.R,y=.3;S.x=.7*g.x+c.x*y,S.y=.7*g.y+c.y*y,S.z=.7*g.z+c.z*y,u+=S.distanceTo(g),o[n+0]=S.x,o[n+1]=S.y,o[n+2]=S.z}}for(u/=e,r=0,n=0;r<e;r++,n+=4){var x=new ce.R(o[n+0],o[n+1],o[n+2]),b=new ce.R;b.subVectors(x,l),b.normalize(),b.multiplyScalar(u),x.add(b),o[n+0]=x.x,o[n+1]=x.y,o[n+2]=x.z}return 1}},{key:"getVerticesNeighbours",value:function(e,t,i,a){var o,r,n=go*e;for(o=0;o<n;o++)this.m_vertNeib[o]=-1;for(o=0,r=0;o<i;o++,r+=3){var s=a[r+0],l=a[r+1],m=a[r+2];this.addNeib(s,l),this.addNeib(s,m),this.addNeib(l,s),this.addNeib(l,m),this.addNeib(m,s),this.addNeib(m,l)}}},{key:"addNeib",value:function(e,t){var i,a=e*go,o=!1;for(i=0;i<go&&!o&&-1!==this.m_vertNeib[a+i];i++)this.m_vertNeib[a+i]===t&&(o=!0);if(!o){for(i=0;i<go&&-1!==this.m_vertNeib[a+i];i++);i>=go&&console.log("asserion failed for i < LAPSMOOTH_NUM_NEIBS"),this.m_vertNeib[a+i]=t}}}]),e}(),yo=function(){function e(){Object(v.a)(this,e)}return Object(p.a)(e,[{key:"constructoir",value:function(){this.m_stack3d=[],this.m_maxStack3d=0,this.m_indexStack3d=0,this.m_numFilled3d=0}},{key:"createStack3d",value:function(e){this.m_maxStack3d=Math.floor(.3*e),this.m_stack3d=[];for(var t=0;t<this.m_maxStack3d;t++)this.m_stack3d.push(new ce.R);return this.m_indexStack3d=0,this.m_numFilled3d=0,1}},{key:"destroyStack3d",value:function(){this.m_stack3d=null}},{key:"stack3dPush",value:function(e){return this.m_indexStack3d>=this.m_maxStack3d?0:(this.m_stack3d[this.m_indexStack3d].x=e.x,this.m_stack3d[this.m_indexStack3d].y=e.y,this.m_stack3d[this.m_indexStack3d].z=e.z,this.m_indexStack3d++,1)}},{key:"stack3dPop",value:function(){if(this.m_indexStack3d<=0)return null;this.m_indexStack3d--;var e=new ce.R;return e.x=this.m_stack3d[this.m_indexStack3d].x,e.y=this.m_stack3d[this.m_indexStack3d].y,e.z=this.m_stack3d[this.m_indexStack3d].z,e}},{key:"stack3dEIsEmpty",value:function(){return this.m_indexStack3d<=0}},{key:"detectSeedPoint3d",value:function(e,t,i,a,o,r){for(var n=Math.floor(t/2),s=Math.floor(i/2),l=2*(n-1),m=2*(s-1),h=0,u=0;u<m;u++){var c=Math.floor(u/2);0!==(1&u)&&(c=-c);for(var d=s+c,_=d*e*t,f=0;f<l;f++){var v=Math.floor(f/2);0!==(1&f)&&(v=-v);var p=n+v,g=p*e,S=-1,y=-1,x=void 0;for(x=0;x<e-1;x++){if(a[x+g+_]>0&&0===a[x+1+g+_]&&(S=x),0===a[x+g+_]&&a[x+1+g+_]>0&&S>=0)if((y=x+1)-S+1>1&&(o[h].x=Math.floor((S+y)/2),o[h].y=p,o[h].z=d,++h>=r))return h}}}return h}},{key:"floodFill3d",value:function(e,t,i,a,o){var r=e*t,n=this.createStack3d(e*t*i);if(1!==n)return n;var s=255;for(this.m_numFilled3d=0,this.stack3dPush(o);!this.stack3dEIsEmpty();){var l=void 0,m=this.stack3dPop(),h=m.y,u=m.z,c=h*e,d=u*r;for(l=m.x;l>=0&&0===a[l+c+d];)l--;var _=l+1;for(l=m.x;l<e&&0===a[l+c+d];)l++;var f=l-1,v=s,p=s,g=s,S=s;for(l=_;l<=f;l++){if(a[l+c+d]=s,this.m_numFilled3d++,h>0&&a[l+c-e+d]!==v&&0===(v=s-v)){var y=new ce.R(l,h-1,u),x=this.stack3dPush(y);if(1!==x)return x}if(h<t-1&&a[l+c+e+d]!==p&&0===(p=s-p)){var b=new ce.R(l,h+1,u),D=this.stack3dPush(b);if(1!==D)return D}if(u>0&&a[l+c+d-r]!==g&&0===(g=s-g)){var T=new ce.R(l,h,u-1),E=this.stack3dPush(T);if(1!==E)return E}if(u<i-1&&a[l+c+d+r]!==S&&0===(S=s-S)){var M=new ce.R(l,h,u+1),w=this.stack3dPush(M);if(1!==w)return w}}}return this.destroyStack3d(),1}}]),e}(),xo=function(){function e(){Object(v.a)(this,e)}return Object(p.a)(e,null,[{key:"renderTriangle",value:function(e,t,i,a,o){var r=e*t,n=new ce.R,s=new ce.R,l=new ce.R;n.x=o[1].x-o[0].x,n.y=o[1].y-o[0].y,n.z=o[1].z-o[0].z,s.x=o[2].x-o[0].x,s.y=o[2].y-o[0].y,s.z=o[2].z-o[0].z,l.x=o[2].x-o[1].x,l.y=o[2].y-o[1].y,l.z=o[2].z-o[1].z;var m=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z),h=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z),u=Math.sqrt(l.x*l.x+l.y*l.y+l.z*l.z),c=m>h?m:h;c=u>c?u:c;var d=Math.floor(1.2*c),_=new ce.R,f=new ce.R;_.x=n.x/d,_.y=n.y/d,_.z=n.z/d,f.x=s.x/d,f.y=s.y/d,f.z=s.z/d;for(var v=new ce.R(o[0].x,o[0].y,o[0].z),p=new ce.R(o[0].x,o[0].y,o[0].z),g=new ce.R,S=new ce.R,y=new ce.R,x=0;x<=d;x++){g.x=p.x-v.x,g.y=p.y-v.y,g.z=p.z-v.z,S.x=g.x/d,S.y=g.y/d,S.z=g.z/d,y.x=v.x,y.y=v.y,y.z=v.z;for(var b=255,D=0;D<=d;D++){var T=Math.floor(y.x),E=Math.floor(y.y),M=Math.floor(y.z);if(T>=0&&E>=0&&M>=0&&T<e&&E<t&&M<i)a[T+E*e+M*r]=b;if(T=Math.floor(y.x)+1,E=Math.floor(y.y)+0,M=Math.floor(y.z)+0,T>=0&&E>=0&&M>=0&&T<e&&E<t&&M<i)a[T+E*e+M*r]=b;if(T=Math.floor(y.x)+0,E=Math.floor(y.y)+1,M=Math.floor(y.z)+0,T>=0&&E>=0&&M>=0&&T<e&&E<t&&M<i)a[T+E*e+M*r]=b;if(T=Math.floor(y.x)+0,E=Math.floor(y.y)+0,M=Math.floor(y.z)+1,T>=0&&E>=0&&M>=0&&T<e&&E<t&&M<i)a[T+E*e+M*r]=b;if(T=Math.floor(y.x)-1,E=Math.floor(y.y)+0,M=Math.floor(y.z)+0,T>=0&&E>=0&&M>=0&&T<e&&E<t&&M<i)a[T+E*e+M*r]=b;if(T=Math.floor(y.x)+0,E=Math.floor(y.y)-1,M=Math.floor(y.z)+0,T>=0&&E>=0&&M>=0&&T<e&&E<t&&M<i)a[T+E*e+M*r]=b;if(T=Math.floor(y.x)+0,E=Math.floor(y.y)+0,M=Math.floor(y.z)-1,T>=0&&E>=0&&M>=0&&T<e&&E<t&&M<i)a[T+E*e+M*r]=b;y.x+=S.x,y.y+=S.y,y.z+=S.z}v.x+=_.x,v.y+=_.y,v.z+=_.z,p.x+=f.x,p.y+=f.y,p.z+=f.z}}},{key:"generateFromFaces",value:function(t,i,a,o,r,n){var s,l,m=r.getNumTriangles(),h=r.getIndices(),u=r.getVertices();console.log("VolumeGeberator. render triangles");var c=t*i*a;for(s=0;s<c;s++)o[s]=0;var d=[];for(d.push(new ce.R),d.push(new ce.R),d.push(new ce.R),s=0,l=0;s<m;s++,l+=3){var _=h[l+0],f=h[l+1],v=h[l+2];d[0].x=u[4*_+0],d[0].y=u[4*_+1],d[0].z=u[4*_+2],d[1].x=u[4*f+0],d[1].y=u[4*f+1],d[1].z=u[4*f+2],d[2].x=u[4*v+0],d[2].y=u[4*v+1],d[2].z=u[4*v+2],e.renderTriangle(t,i,a,o,d)}if(console.log("VolumeGeberator. fill internal"),n){var p=new yo,g=t*i*a,S=new Uint8Array(g),y=[];for(s=0;s<16;s++)y.push(new ce.R);var x=p.detectSeedPoint3d(t,i,a,o,y,16);console.log("VolGen. Detected ".concat(x," seed points"));for(var b=!1,D=0;D<x;D++){var T=y[D];for(s=0;s<g;s++)S[s]=o[s];console.log("VolGen. Try to flood fill from ".concat(T.x,", ").concat(T.y,", ").concat(T.z," ")),console.log("VolGen. inside volume ".concat(t,", ").concat(i,", ").concat(a," "));var E=p.floodFill3d(t,i,a,S,T);console.log("VolGen. Result fill = ".concat(E,". numDraws = ").concat(p.m_numFilled3d));if(1===E&&255!==S[1+1*t+1*t*i]){b=!0;break}}if(b)for(s=0;s<g;s++)o[s]=S[s];if(!b)return!1}return!0}}]),e}(),bo=4096,Do=function(){function e(){Object(v.a)(this,e),this.m_gaussWeights=new Float32Array(12167)}return Object(p.a)(e,[{key:"gaussSmooth",value:function(e,t,i,a,o,r){var n=Math.floor(2*o+1);if(n>23)return-1;if(r<0||r>8)return-2;if(t<=0||i<=0||a<=0)return-3;if(t>bo||i>bo||a>bo)return-4;if(null===e)return-5;if(e.length<t*i*a)return-6;for(var s=n*n*n,l=1/(2*r*r),m=t*i*a,h=new Uint8Array(m),u=0,c=0,d=0;d<n;d++)for(var _=d-o,f=0;f<n;f++)for(var v=f-o,p=0;p<n;p++){var g=p-o,S=g*g+v*v+_*_,y=1/Math.exp(S*l);this.m_gaussWeights[c]=y,u+=this.m_gaussWeights[c],c+=1}for(var x=1/u,b=0;b<s;b++)this.m_gaussWeights[b]*=x;for(var D=t*i,T=0;T<a;T++)for(var E=0;E<i;E++)for(var M=0;M<t;M++){for(var w=0,R=0,k=-o;k<=+o;k++){var O=T+k;O=(O=O<0?0:O)>=a?a-1:O;for(var A=-o;A<=+o;A++){var C=E+A;C=(C=C<0?0:C)>=i?i-1:C;for(var I=-o;I<=+o;I++){var F=M+I;F=(F=F<0?0:F)>=t?t-1:F;var P=this.m_gaussWeights[R];R+=1,w+=e[O*D+C*t+F]*P}}}var U=Math.floor(w);U=U<=255?U:255,h[T*D+E*t+M]=U}for(var X=0;X<m;X++)e[X]=h[X];return 1}}],[{key:"buildSmoothedHistogram",value:function(e,t,i,a){if(null===e)return-1;if(null===t)return-2;if(e.length!==t.length)return-3;if(e.length!==i)return-4;if(a<0||a>64)return-5;var o=Math.floor(i/60);o>32&&(o=32);for(var r=0;r<i;r++){for(var n=0,s=0,l=-o;l<=+o;l++){var m=l/o;m=m>=0?m:-m;var h=r+l,u=e[h=(h=h>=0?h:0)<i?h:i-1],c=Math.exp(-m*a);n+=u*c,s+=c}n/=s,t[r]=Math.floor(n)}return 1}},{key:"scaleDownXYtwice",value:function(e,t){for(var i=Math.floor(e.m_xDim/2),a=Math.floor(e.m_yDim/2),o=e.m_zDim,r=e.m_xDim*e.m_yDim,n=i*a,s=new Uint8Array(i*a*o),l=0;l<e.m_zDim;l++)for(var m=l*r,h=l*n,u=0;u<a;u++)for(var c=(u+u)*e.m_xDim,d=u*i,_=0;_<i;_++){var f=m+c+(_+_),v=(t[f+0]+t[f+1]+t[f+e.m_xDim]+t[f+e.m_xDim+1])/4;s[h+d+_]=v}return e.m_xDim=i,e.m_yDim=a,void 0!==e.m_pixelSpacing&&(e.m_pixelSpacing.x*=2,e.m_pixelSpacing.y*=2),s}},{key:"scaleTextureDown",value:function(e,t,i,a,o){var r=10,n=new Uint8Array(i*a*o),s=e.m_xDim,l=e.m_yDim,m=e.m_zDim;if(!(s>i||l>a||m>o))return null;for(var h=s*l,u=Math.floor((s<<r)/i),c=Math.floor((l<<r)/a),d=Math.floor((m<<r)/o),_=0,f=512,v=f+d,p=0;p<o;p++,f+=d,v+=d)for(var g=f>>r,S=v>>r,y=512,x=y+c,b=0;b<a;b++,y+=c,x+=c)for(var D=y>>r,T=x>>r,E=512,M=E+u,w=0;w<i;w++,E+=u,M+=u){for(var R=E>>r,k=M>>r,O=0,A=0,C=g,I=g*h;C<S;C++,I+=h)for(var F=D,P=D*s;F<T;F++,P+=s)for(var U=R;U<k;U++){O+=t[U+P+I],A++}O=Math.floor(O/A),n[_++]=O}return e.m_xDim=i,e.m_yDim=a,e.m_zDim=o,n}},{key:"scaleDown",value:function(e,t,i,a,o,r,n,s){for(var l=Math.floor(t/r),m=Math.floor(i/n),h=Math.floor(a/s),u=0,c=0;c<h;c++)for(var d=(c+0)*s,_=(c+1)*s,f=0;f<m;f++)for(var v=(f+0)*n,p=(f+1)*n,g=0;g<l;g++){for(var S=(g+0)*r,y=(g+1)*r,x=0,b=0,D=d;D<_;D++)for(var T=D*t*i,E=v;E<p;E++)for(var M=E*t,w=S;w<y;w++){x+=e[w+M+T],b++}x/=b,o[u++]=Math.floor(x)}}},{key:"contrastEnchanceUnsharpMask",value:function(t,i,a,o,r,n,s,l){var m=arguments.length>8&&void 0!==arguments[8]&&arguments[8];if("number"!==typeof i||"number"!==typeof a||"number"!==typeof o)return e.VOLTOOLS_ERROR_BAD_NUMBER;if("object"!==typeof t)return e.VOLTOOLS_ERROR_BAD_ARRAY;if("object"!==typeof r)return e.VOLTOOLS_ERROR_BAD_ARRAY;if(l<1)return e.VOLTOOLS_ERROR_BAD_MULTIPLIER;var h=256;if(l>=h)return e.VOLTOOLS_ERROR_BAD_MULTIPLIER;if(i<=1||a<=1||o<=1)return e.VOLTOOLS_ERROR_BAD_DIMENSION;var u=4096;if(i>=u||a>=u||o>=u)return e.VOLTOOLS_ERROR_BAD_DIMENSION;for(var c=2,d=c*n+1,_=d*d*d,f=i*a,v=new Float32Array(_),p=1/(c*s*s),g=0,S=0,y=0;y<d;y++)for(var x=y-n,b=0;b<d;b++)for(var D=b-n,T=0;T<d;T++){var E=T-n,M=1*E*E+D*D+x*x,w=1/Math.exp(M*p);v[S]=w,g+=v[S],S++}for(var R=1/g,k=0;k<_;k++)v[k]*=R;for(var O=0;O<o;O++)for(var A=0;A<a;A++)for(var C=0;C<i;C++){for(var I=0,F=0,P=-n;P<=+n;P++)for(var U=O+P,X=(U=U<0?0:U>=o?o-1:U)*f,z=-n;z<=+n;z++)for(var L=A+z,N=(L=L<0?0:L>=a?a-1:L)*i,V=-n;V<=+n;V++){var B=C+V;B=B<0?0:B>=i?i-1:B;var j=v[F];F++;var G=B+N+X,W=t[G];I+=j*W}var H=t[S=C+A*i+O*f],q=H-I,Y=2,Z=q>Y||q<-Y?q*l:0,K=H+Z;K=K<0?0:K;var Q=255;if(H=(H=Math.floor(K))>Q?Q:H,r[S]=H,m){var J=16383;if(0===(S&J)){var $=100,ee=S*$/(i*a*o);console.log("contrastEnchanceUnsharpMask: ".concat(ee," %"))}}}return e.VOLTOOLS_ERROR_OK}},{key:"makeTextureSizeEven",value:function(e,t,i,a){if(t%4===0&&i%4===0&&a%4===0)return e;var o,r=t+3&-4,n=i+3&-4,s=a+3&-4,l=r*n*s,m=new Uint8Array(l);for(o=0;o<l;o++)m[o]=0;for(var h=0;h<a;h++)for(var u=h*t*i,c=h*r*n,d=0;d<i;d++)for(var _=d*t,f=d*r,v=0;v<t;v++){var p=e[v+_+u];m[v+f+c]=p}return console.log("modified texture size is: ".concat(r," * ").concat(n," * ").concat(s)),m}},{key:"extract2dSliceFrom3dTexture",value:function(e,t,i,a,o,r,n){var s=e*t*i;4*s!==a.length&&console.log("!!! wrong volume texture size: ".concat(s));if(0===o){var l=r;console.log("x slice is: ".concat(l," from ").concat(e,"*").concat(t,"*").concat(i," volume"));var m,h,u=t,c=i,d=0;for(h=0;h<c;h++){var _=h*e*t;for(m=0;m<u;m++){var f=4*(_+m*e+l);n[d+0]=a[f+0],n[d+1]=a[f+1],n[d+2]=a[f+2],n[d+3]=255,d+=4}}}if(1===o){var v=r,p=v*e;console.log("y slice is: ".concat(v," from ").concat(e,"*").concat(t,"*").concat(i," volume"));var g,S,y=e,x=i,b=0;for(S=0;S<x;S++){var D=S*e*t;for(g=0;g<y;g++){var T=4*(D+p+g);n[b+0]=a[T+0],n[b+1]=a[T+1],n[b+2]=a[T+2],n[b+3]=255,b+=4}}}if(2===o){var E=r;console.log("z slice is: ".concat(E," from ").concat(e,"*").concat(t,"*").concat(i," volume"));var M,w,R=E*e*t,k=e,O=t,A=0;for(w=0;w<O;w++){var C=w*e;for(M=0;M<k;M++){var I=4*(R+C+M);n[A+0]=a[I+0],n[A+1]=a[I+1],n[A+2]=a[I+2],n[A+3]=255,A+=4}}}}},{key:"get2dCoordFromTiled3dCoord",value:function(e,t,i,a,o,r,n,s){var l=1/a,m=o*l,h=r*l,u=Math.floor(n*i);m+=u%a*l,h+=Math.floor(u/a)*l;m+=.5/(e*a),h+=.5/(t*a),s.x=m,s.y=h}},{key:"extract2dSliceFromTiled3dTexture",value:function(t,i,a,o,r,n,s,l){var m=Math.pow(2,1+Math.floor(Math.log(Math.sqrt(a))/Math.log(2))),h=o.length,u=t*m,c=i*m;h!==u*c*4&&console.log("Wrong 2d tiled vol size. Size = ".concat(h));var d=255;if(0===r){var _,f,v=n/t;console.log("extract2dSlice... fx = ".concat(v));var p=i,g=a,S=0;for(f=0;f<g;f++){var y=f/g;for(_=0;_<p;_++){var x=_/p,b={x:0,y:0};e.get2dCoordFromTiled3dCoord(t,i,a,m,v,x,y,b);var D=4*(Math.floor(b.x*u)+Math.floor(b.y*c)*u);l?(s[S+0]=o[D+0],s[S+1]=o[D+1],s[S+2]=o[D+2],s[S+3]=d):(s[S+0]=o[D+3],s[S+1]=o[D+3],s[S+2]=o[D+3],s[S+3]=d),S+=4}}}if(1===r){var T,E,M=n/i;console.log("extract2dSlice... fy = ".concat(M));var w=t,R=a,k=0;for(E=0;E<R;E++){var O=E/R;for(T=0;T<w;T++){var A=T/w,C={x:0,y:0};e.get2dCoordFromTiled3dCoord(t,i,a,m,A,M,O,C);var I=4*(Math.floor(C.x*u)+Math.floor(C.y*c)*u);l?(s[k+0]=o[I+0],s[k+1]=o[I+1],s[k+2]=o[I+2],s[k+3]=d):(s[k+0]=o[I+3],s[k+1]=o[I+3],s[k+2]=o[I+3],s[k+3]=d),k+=4}}}if(2===r){var F,P,U=n/a;console.log("extract2dSlice... fz = ".concat(U,". dim = ").concat(t,"*").concat(i,"*").concat(a,". zDimSqrt = ").concat(m));var X=t,z=i,L=0;for(P=0;P<z;P++){var N=P/z;for(F=0;F<X;F++){var V=F/X,B={x:0,y:0};e.get2dCoordFromTiled3dCoord(t,i,a,m,V,N,U,B);var j=4*(Math.floor(B.x*u)+Math.floor(B.y*c)*u);l?(s[L+0]=o[j+0],s[L+1]=o[j+1],s[L+2]=o[j+2],s[L+3]=d):(s[L+0]=o[j+3],s[L+1]=o[j+3],s[L+2]=o[j+3],s[L+3]=d),L+=4}}}}},{key:"isPowerOfTwo",value:function(e){for(var t=1;t<31;t++){if(e===1<<t)return!0}return!1}},{key:"getGreatOrEqualPowerOfTwo",value:function(e){for(var t=1;t<31;t++){var i=1<<t;if(e===i)return e;var a=1<<t+1;if(e>i&&e<a)return a}return-1}},{key:"getLessOrEqualPowerOfTwo",value:function(e){for(var t=31;t>0;t--){var i=1<<t;if(e===i)return e;var a=1<<t-1;if(e>a&&e<i)return a}return-1}},{key:"makeTextureSizePowerOfTwoUp",value:function(e,t,i,a,o,r){var n=a;o<t&&console.log("Error: ".concat(o," < ").concat(t)),r<i&&console.log("Error: ".concat(r," < ").concat(i));var s=Math.floor((o-t)/2),l=Math.floor((r-i)/2),m=t*i*a,h=Math.floor(e.length/m);1!==h&&4!==h&&console.log("Error source volume bpp:  = ".concat(t," * ").concat(i," * ").concat(a,", bpp = ").concat(h));var u,c=o*r*n*h,d=new Uint8Array(c);for(u=0;u<c;u++)d[u]=0;var _=0;if(1===h)for(var f=0;f<a;f++)for(var v=f*o*r,p=0;p<i;p++)for(var g=s+(p+l)*o+v,S=0;S<t;S++,g++){var y=e[_];d[g]=y,_++}else if(4===h)for(var x=0;x<a;x++)for(var b=x*o*r,D=0;D<i;D++)for(var T=s+(D+l)*o+b,E=0;E<t;E++,T++){var M=_+_+_+_,w=T+T+T+T,R=void 0;R=e[M],d[w]=R,w++,R=e[++M],d[w]=R,w++,R=e[++M],d[w]=R,w++,R=e[++M],d[w]=R,_++}return d}},{key:"makeTextureSizePowerOfTwoDown",value:function(e,t,i,a,o,r){var n=a;o>=t&&console.log("Error: ".concat(o," >= ").concat(t)),r>=i&&console.log("Error: ".concat(r," >= ").concat(i));var s=t/o,l=i/r,m=t*i*a,h=Math.floor(e.length/m);1!==h&&4!==h&&console.log("Error source volume bpp:  = ".concat(t," * ").concat(i," * ").concat(a,", bpp = ").concat(h));var u,c=o*r*n*h,d=new Uint8Array(c);for(u=0;u<c;u++)d[u]=0;var _=0;if(1===h)for(var f=0;f<n;f++)for(var v=f*t*i,p=0;p<r;p++)for(var g=Math.floor((p+0)*l),S=Math.floor((p+1)*l),y=0;y<o;y++){for(var x=Math.floor((y+0)*s),b=Math.floor((y+1)*s),D=0,T=0,E=g;E<S;E++)for(var M=x;M<b;M++){D+=e[v+E*t+M],T++}D/=T,d[_]=D,_++}else if(4===h)for(var w=0;w<n;w++)for(var R=w*t*i,k=0;k<r;k++)for(var O=Math.floor((k+0)*l),A=Math.floor((k+1)*l),C=0;C<o;C++,_++){for(var I=Math.floor((C+0)*s),F=Math.floor((C+1)*s),P=0,U=0,X=0,z=0,L=0,N=O;N<A;N++)for(var V=I;V<F;V++){var B=4*(R+N*t+V);z+=e[B],X+=e[++B],U+=e[++B],P+=e[++B],L++}z/=L,X/=L,U/=L,P/=L,d[_]=z,d[++_]=X,d[++_]=U,d[++_]=P,_++}return d}},{key:"detectNonEmptyBox",value:function(e,t,i,a,o,r){var n,s,l,m,h=t*i,u=Math.floor(t/2),c=Math.floor(i/2),d=Math.floor(a/2),_=0,f=0,v=0,p=0,g=0,S=0,y=Math.floor(e.length/(t*i*a));if(1===y){for(m=!0,n=0;n<u&&m;n++)for(s=0;s<i&&m;s++)for(l=0;l<a&&m;l++){e[l*h+s*t+n]>8&&(m=!1)}for(_=n,m=!0,n=t-1;n>u&&m;n--)for(s=0;s<i&&m;s++)for(l=0;l<a&&m;l++){e[l*h+s*t+n]>8&&(m=!1)}for(p=n,m=!0,s=0;s<c&&m;s++)for(n=0;n<t&&m;n++)for(l=0;l<a&&m;l++){e[l*h+s*t+n]>8&&(m=!1)}for(f=s,m=!0,s=i-1;s>c&&m;s--)for(n=0;n<t&&m;n++)for(l=0;l<a&&m;l++){e[l*h+s*t+n]>8&&(m=!1)}for(g=s,m=!0,l=0;l<d&&m;l++)for(n=0;n<t&&m;n++)for(s=0;s<i&&m;s++){e[l*h+s*t+n]>8&&(m=!1)}for(v=l,m=!0,l=a-1;l>d&&m;l--)for(n=0;n<t&&m;n++)for(s=0;s<i&&m;s++){e[l*h+s*t+n]>8&&(m=!1)}S=l}else if(4===y){for(m=!0,n=0;n<u&&m;n++)for(s=0;s<i&&m;s++)for(l=0;l<a&&m;l++){e[4*(l*h+s*t+n)+3]>8&&(m=!1)}for(_=n,m=!0,n=t-1;n>u&&m;n--)for(s=0;s<i&&m;s++)for(l=0;l<a&&m;l++){e[4*(l*h+s*t+n)+3]>8&&(m=!1)}for(p=n,m=!0,s=0;s<c&&m;s++)for(n=0;n<t&&m;n++)for(l=0;l<a&&m;l++){e[4*(l*h+s*t+n)+3]>8&&(m=!1)}for(f=s,m=!0,s=i-1;s>c&&m;s--)for(n=0;n<t&&m;n++)for(l=0;l<a&&m;l++){e[4*(l*h+s*t+n)+3]>8&&(m=!1)}for(g=s,m=!0,l=0;l<d&&m;l++)for(n=0;n<t&&m;n++)for(s=0;s<i&&m;s++){e[4*(l*h+s*t+n)+3]>8&&(m=!1)}for(v=l,m=!0,l=a-1;l>d&&m;l--)for(n=0;n<t&&m;n++)for(s=0;s<i&&m;s++){e[4*(l*h+s*t+n)+3]>8&&(m=!1)}S=l}o.x=_/t,o.y=f/i,o.z=v/a,r.x=p/t,r.y=g/i,r.z=S/a}}]),e}();Do.VOLTOOLS_ERROR_OK=1,Do.VOLTOOLS_ERROR_BAD_MULTIPLIER=-1,Do.VOLTOOLS_ERROR_BAD_DIMENSION=-2,Do.VOLTOOLS_ERROR_BAD_ARRAY=-3,Do.VOLTOOLS_ERROR_BAD_NUMBER=-4;var To=256,Eo=function(){function e(){Object(v.a)(this,e),this.m_state=-1,this.m_pixelsSrc=null,this.m_xDim=0,this.m_yDim=0,this.m_zDim=0,this.m_xWorldBox=0,this.m_yWorldBox=0,this.m_zWorldBox=0,this.m_imageGauss=null,this.m_imageUniformity=null,this.m_verticesNew=null,this.m_lapSmoother=null,this.m_imageSrc=null,this.m_imageGrad=null,this.m_gaussStage=-1,this.m_uniformityStage=-1,this.m_geoStage=-1,this.m_histogram=new Int32Array(To),this.m_colorProbability=new Float32Array(To),this.m_colorKoefs=new Float32Array(To);for(var t=0;t<To;t++)this.m_histogram[t]=0,this.m_colorProbability[t]=0,this.m_colorKoefs[t]=0;this.m_sphereCenter=null,this.m_sphereRadius=null,this.m_indexMinColor=-1,this.m_updateCounter=0,this.m_geoRender=null,this.m_wasAllocated=!1,this.m_xScale=1,this.m_yScale=1,this.m_zScale=1}return Object(p.a)(e,[{key:"setSphereCenter",value:function(e,t,i){this.m_sphereCenter=new ce.R,this.m_sphereCenter.set(e,t,i)}},{key:"setSphereRadius",value:function(e,t,i){this.m_sphereRadius=new ce.R,this.m_sphereRadius.set(e,t,i)}},{key:"getSphereCenter",value:function(){return this.m_sphereCenter}},{key:"getSphereRadius",value:function(){return this.m_sphereRadius}},{key:"setupPhysDims",value:function(e,t,i){this.m_xWorldBox=e,this.m_yWorldBox=t,this.m_zWorldBox=i}},{key:"copyScaleUp",value:function(e,t,i,a){if(console.log("perform scale up generated mask ..."),1!==this.m_xScale)for(var o=this.m_xDim/t,r=this.m_yDim/i,n=this.m_zDim/a,s=0,l=0;l<a;l++)for(var m=Math.floor(l*n)*this.m_xDim*this.m_yDim,h=0;h<i;h++)for(var u=Math.floor(h*r)*this.m_xDim,c=0;c<t;c++){var d=Math.floor(c*o)+u+m,_=this.m_pixelsSrc[d];e[s]=_,s++}else console.log("ActiveVolume. copyScaleUp. should be scaled")}},{key:"save",value:function(){var e,t=this.m_xDim*this.m_yDim*this.m_zDim,i=new Uint8Array(t);for(e=0;e<t;e++)i[e]=0;var a=xo.generateFromFaces(this.m_xDim,this.m_yDim,this.m_zDim,i,this.m_geoRender,!0);if(a){console.log("perform clip of source volume by generated mask ...");for(e=0;e<t;e++)0===i[e]&&(this.m_pixelsSrc[e]=Math.floor(this.m_pixelsSrc[e]/6))}else console.log("generateFromFaces returned ".concat(a," !"));i=null}},{key:"createGeoSphere",value:function(){if(0===this.m_xDim){return-1}if(null===this.m_sphereRadius){return-2}var e=new dt,t=new ce.R(.5,.5,.5),i=e.create(t,3);if(i<1)return i;var a=new po;if(1!==a.createFromTetrahedronGenerator(e)){return-3}for(var o=a.getNumVertices(),r=a.getVertices(),n=this.m_sphereRadius.x/this.m_xScale/.5,s=this.m_sphereRadius.y/this.m_yScale/.5,l=this.m_sphereRadius.z/this.m_zScale/.5,m=0,h=0;m<o;m++,h+=4)r[h+0]=this.m_sphereCenter.x/this.m_xScale+r[h+0]*n,r[h+1]=this.m_sphereCenter.y/this.m_yScale+r[h+1]*s,r[h+2]=this.m_sphereCenter.z/this.m_zScale+r[h+2]*l;return this.m_geoRender=a,1}},{key:"createThreeJsGeoFromSphere",value:function(){var e=this.m_geoRender;if(null===e)return console.log("createThreeJsGeoFromSphere. logic error: call createGeoSphere() first"),null;for(var t=1/this.m_xDim,i=1/this.m_yDim,a=1/this.m_zDim,o=e.getVertices(),r=new ce.r,n=0,s=0;n<e.m_numVertices;n++,s+=4){var l=o[s+0]*t-.5,m=o[s+1]*i-.5,h=o[s+2]*a-.5,u=new ce.R(l,m,h);r.vertices.push(u)}for(var c=0,d=0;c<e.m_numTriangles;c++,d+=3){var _=e.m_indices[d+0],f=e.m_indices[d+1],v=e.m_indices[d+2],p=new ce.n(_,f,v);r.faces.push(p)}return r.computeBoundingSphere(),r}},{key:"clipVolumeBySphere",value:function(e,t,i,a,o,r,n){if(null!==o){var s=n.x>n.y?n.x:n.y;s=n.z>s?n.z:s;var l=n.x/s,m=n.y/s,h=n.z/s,u=new po;u.fromBufferGeometry(r);for(var c=u.getNumVertices(),d=u.getVertices(),_=0,f=0;f<c;f++,_+=4){var v=-d[_+0]/l,p=d[_+1]/m,g=d[_+2]/h,S=Math.floor((v+.5)*e),y=Math.floor((p+.5)*t),x=Math.floor((g+.5)*i);d[_+0]=S,d[_+1]=y,d[_+2]=x}for(var b=e*t*i,D=new Uint8Array(b),T=0;T<b;T++)D[T]=0;var E=xo.generateFromFaces(e,t,i,D,u,1);E<0&&console.log("ActVol. generateFromFaces returned ".concat(E," !"));for(var M=0;M<b;M++)o[M]=0!==D[M]?a[M]:0}else console.log("`clipVolumeBySphere. volTexDst == null")}},{key:"sphereEvolve",value:function(t,i,a,o,r,n,s,l,m,h){var u=h.x>h.y?h.x:h.y;u=h.z>u?h.z:u;var c=h.x/u,d=h.y/u,_=h.z/u;if(t<8||i<8||a<8)return console.log("sphereEvolve: too small vol dim = ".concat(t," * ").concat(i," * ").concat(a)),!1;var f=4095;if(t>f||i>f||a>f)return console.log("sphereEvolve: too large vol dim = ".concat(t," * ").concat(i," * ").concat(a)),!1;if("object"!==typeof o)return console.log("sphereEvolve: bad source vol type = ".concat(typeof o)),!1;var v=t*i*a;if(o.length!==v)return console.log("sphereEvolve: bad src vol size = ".concat(o.length,", but expect = ").concat(v)),!1;if(null!==r){if("object"!==typeof r)return console.log("sphereEvolve: bad dest vol type = ".concat(typeof r)),!1;if(r.length!==v)return console.log("sphereEvolve: bad dst vol size = ".concat(r.length,", but expect = ").concat(v)),!1}if("object"!==typeof n)return console.log("sphereEvolve: bad sphere type = ".concat(typeof n)),!1;if(!("getAttribute"in n))return console.log("geoSphere has no getAttribute method"),!1;var p=n.getAttribute("position");if("undefined"===typeof p)return console.log("geoSphere has no position attr"),!1;var g=p.count;if(g<16|g>4095)return console.log("sphereEvolve: bad num vertices in pshere geo = ".concat(g)),!1;console.log("sphereEvolve: num vertices in sphere geo = ".concat(g));var S=p.itemSize;3!==S&&console.log("sphereEvolve: bad vertices num components = ".concat(S," "));var y=n.getAttribute("normal");if("undefined"===typeof y)return console.log("geoSphere has no normal attr"),!1;var x=y.count;if(x!==g)return console.log("sphereEvolve: num vertices ".concat(g," != num normals ").concat(x)),!1;var b=y.itemSize;3!==b&&console.log("sphereEvolve: bad normals num components =  ".concat(b," "));var D=.5,T=Math.floor(t*D),E=Math.floor(i*D),M=Math.floor(a*D),w=t>i?t:i;w=a>w?a:w;var R=t*i,k=Math.sqrt(3),O=Math.floor(.5*w*0),A=Math.floor(.5*w*k);(s<0||s>1)&&console.log("sphereEvolve. Invalid barrier value: ".concat(s,". Should be in [0..1]"));var C=255*s;console.log("Autodetect brain shape with barrier range ".concat(C));for(var I=0;I<g;I++){var F=new ce.R(p.getX(I),p.getY(I),p.getZ(I)),P=new ce.R(y.getX(I)-m.x,y.getY(I)-m.y,y.getZ(I)-m.z);if(P.normalize(),l===e.SPHERE_EVOLVE_FROM_OUTSIDE){var U=void 0,X=void 0,z=void 0,L=void 0,N=-1,V=-1,B=-1,j=-1,G=!1;for(U=A;U>=O&&!G;U--)if(X=T+Math.floor(P.x*U),z=E+Math.floor(P.y*U),L=M+Math.floor(P.z*U),!(X<0||z<0||L<0||X>=t||z>=i||L>=a)){var W=o[X+z*t+L*R];j>0&&W<j&&W<C&&(G=!0),N<0&&W<j&&(N=X,V=z,B=L),j=W}G||(X=N,z=V,L=B);var H=X/t-D,q=z/i-D,Y=L/a-D;p.setXYZ(I,H,q,Y)}if(l===e.SPHERE_EVOLVE_FROM_INSIDE){var Z=void 0,K=void 0,Q=void 0,J=void 0,$=void 0,ee=.5;for(Z=0;Z<2*A;Z++){if(K=F.x+ee*P.x*Z/u,Q=F.y+ee*P.y*Z/u,J=F.z+ee*P.z*Z/u,K<-.5||Q<-.5||J<-.5||K>=ee||Q>=ee||J>=ee){console.log("MysphereEvolve. Stop at exit [".concat(I,"] = ").concat(K,", ").concat(Q,", ").concat(J,", "));break}var te=(-K/c+D)*t,ie=(Q/d+D)*i,ae=(J/_+D)*a,oe=Math.floor(te),re=Math.floor(ie),ne=Math.floor(ae),se=te-oe,le=ie-re,me=ae-ne,he=(1-se)*o[$=oe+re*t+ne*R]+se*o[$+1],ue=(1-se)*o[$=oe+(re+1)*t+ne*R]+se*o[$+1];if((1-me)*((1-le)*he+le*ue)+me*((1-le)*(he=(1-se)*o[$=oe+re*t+(ne+1)*R]+se*o[$+1])+le*(ue=(1-se)*o[$=oe+(re+1)*t+(ne+1)*R]+se*o[$+1]))<C)break}p.setXYZ(I,K,Q,J)}}if(n.getAttribute("position").needsUpdate=!0,null!==r){var de=new po;de.fromBufferGeometry(n);for(var _e=de.getNumVertices(),fe=de.getVertices(),ve=0,pe=0;pe<_e;pe++,ve+=4){var ge=fe[ve+0],Se=fe[ve+1],ye=fe[ve+2],xe=Math.floor((ge+D)*t),be=Math.floor((Se+D)*i),De=Math.floor((ye+D)*a);fe[ve+0]=xe,fe[ve+1]=be,fe[ve+2]=De}for(var Te=new Uint8Array(v),Ee=0;Ee<v;Ee++)Te[Ee]=0;var Me=xo.generateFromFaces(t,i,a,Te,de,1);Me<0&&console.log("ActVol. generateFromFaces returned ".concat(Me," !"));for(var we=0;we<v;we++)r[we]=0!==Te[we]?o[we]:0}return!0}},{key:"skullRemoveStart",value:function(t,i,a,o,r,n,s){var l=8192;if(n!==e.REMOVE_SKULL&&n!==e.CREATE_MASK&&console.log("skullRemoveStart: wrong argument createType"),t>=l||i>=l||a>=l)return console.log("Too bad volume dimension: ".concat(t," * ").concat(i," * ").concat(a)),-1;if(t<=1||i<=1||a<=1)return console.log("Too bad volume dimension: ".concat(t," * ").concat(i," * ").concat(a)),-1;var m=o.length,h=t*i*a;if(m!==h)return console.log("skullRemoveStart: bad vol size = ".concat(m,", expected ").concat(h)),-1;var u=this.create(t,i,a,o);if(1!==u)return u;var c=new dt,d=new ce.R(.5,.5,.5),_=c.create(d,3);if(_<1)return _;var f=new po;if(1!==f.createFromTetrahedronGenerator(c)){return-3}for(var v=Math.floor(.5*(this.m_xDim-1)),p=Math.floor(.5*(this.m_yDim-1)),g=Math.floor(.5*(this.m_zDim-1)),S=f.getNumVertices(),y=f.getVertices(),x=0,b=0;x<S;x++,b+=4)y[b+0]=v+v*y[b+0],y[b+1]=p+p*y[b+1],y[b+2]=g+g*y[b+2];var D=this.getPredictedStepsForActiveVolumeUpdate();D+=12;var T=["REMOVE_SKULL","CREATE_MASK"][n];return console.log("skullRemoveStart. Will be ".concat(D," updates approximately. In ").concat(T," mode ")),this.m_updateCounter=0,this.m_isFinished=!1,this.m_numPredSteps=D,this.m_createType=n,this.m_volTexSrc=o,this.m_volTexDst=r,this.m_needLog=s,f}},{key:"skullRemoveUpdate",value:function(e){return!!(this.m_updateCounter>=this.m_numPredSteps||this.m_isFinished)||(this.updateGeo(e,65535),this.m_isFinished=4===this.m_state,this.m_updateCounter++,!1)}},{key:"skullRemoveStop",value:function(t){if(this.m_createType===e.REMOVE_SKULL){var i=this.m_xDim*this.m_yDim*this.m_zDim,a=new Uint8Array(i),o=xo.generateFromFaces(this.m_xDim,this.m_yDim,this.m_zDim,a,t,1);o<0&&console.log("generateFromFaces returned ".concat(o," !"));for(var r=0;r<i;r++)this.m_volTexDst[r]=0!==a[r]?this.m_volTexSrc[r]:0}else if(this.m_createType===e.CREATE_MASK){var n=xo.generateFromFaces(this.m_xDim,this.m_yDim,this.m_zDim,this.m_volTexDst,t,1);n<0&&console.log("generateFromFaces returned ".concat(n," !"))}return this.m_needLog,1}},{key:"skullRemove",value:function(t,i,a,o,r,n,s){var l=8192;if(n!==e.REMOVE_SKULL&&n!==e.CREATE_MASK&&console.log("skullRemove: wrong argument createType"),t>=l||i>=l||a>=l)return console.log("Too bad volume dimension: ".concat(t," * ").concat(i," * ").concat(a)),-1;if(t<=1||i<=1||a<=1)return console.log("Too bad volume dimension: ".concat(t," * ").concat(i," * ").concat(a)),-1;var m=o.length,h=t*i*a;if(m!==h)return console.log("skullRemove: bad vol size = ".concat(m,", expected ").concat(h)),-1;var u=this.create(t,i,a,o);if(1!==u)return u;var c=new dt,d=new ce.R(.5,.5,.5),_=c.create(d,3);if(_<1)return _;var f=new po;if(1!==f.createFromTetrahedronGenerator(c)){return-3}for(var v=Math.floor(.5*(this.m_xDim-1)),p=Math.floor(.5*(this.m_yDim-1)),g=Math.floor(.5*(this.m_zDim-1)),S=f.getNumVertices(),y=f.getVertices(),x=0,b=0;x<S;x++,b+=4)y[b+0]=v+v*y[b+0],y[b+1]=p+p*y[b+1],y[b+2]=g+g*y[b+2];var D=this.getPredictedStepsForActiveVolumeUpdate();D+=12;var T=["REMOVE_SKULL","CREATE_MASK"][n];console.log("skullRemove. Will be ".concat(D," updates approximately. In ").concat(T," mode "));var E=!1;if(D>0)for(this.m_updateCounter=0;this.m_updateCounter<D&&!E;this.m_updateCounter++)console.log("skullRemove(".concat(this.m_updateCounter,")")),this.updateGeo(f,65535),E=4===this.m_state;if(n===e.REMOVE_SKULL){var M=this.m_xDim*this.m_yDim*this.m_zDim,w=new Uint8Array(M),R=xo.generateFromFaces(this.m_xDim,this.m_yDim,this.m_zDim,w,f,1);R<0&&console.log("generateFromFaces returned ".concat(R," !"));for(var k=0;k<M;k++)r[k]=0!==w[k]?o[k]:0}else if(n===e.CREATE_MASK){var O=xo.generateFromFaces(this.m_xDim,this.m_yDim,this.m_zDim,r,f,1);O<0&&console.log("generateFromFaces returned ".concat(O," !"))}return 1}},{key:"getPredictedStepsForActiveVolumeUpdate",value:function(){var t=this.m_xDim,i=this.m_yDim,a=this.m_zDim,o=t>i?t:i;return(o>a?o:a)-4+2*e.ACT_VOL_NUM_SMOOTH_STAGES+4}},{key:"create",value:function(e,t,i,a){if(e>256||t>256||i>256){this.m_xScale=Math.floor(e/256),this.m_yScale=Math.floor(t/256),this.m_zScale=Math.floor(i/256);var o=this.m_xScale>this.m_yScale?this.m_xScale:this.m_yScale;(o=this.m_zScale>o?this.m_zScale:o)<=1&&(this.m_xScale=this.m_yScale=this.m_zScale=2),this.m_xScale=this.m_xScale>=1?this.m_xScale:1,this.m_yScale=this.m_yScale>=1?this.m_yScale:1,this.m_zScale=this.m_zScale>=1?this.m_zScale:1;var r=Math.floor(e/this.m_xScale),n=Math.floor(t/this.m_yScale),s=Math.floor(i/this.m_zScale),l=new Uint8Array(r*n*s);Do.scaleDown(a,e,t,i,l,this.m_xScale,this.m_yScale,this.m_zScale),this.m_pixelsSrc=l,this.m_wasAllocated=!0,this.m_xDim=r,this.m_yDim=n,this.m_zDim=s,console.log("ActiveVolume. Scaled down to ".concat(r," * ").concat(n," * ").concat(s))}else this.m_xDim=e,this.m_yDim=t,this.m_zDim=i,this.m_pixelsSrc=a,this.m_wasAllocated=!1;this.m_state=0;var m=this.m_xDim*this.m_yDim*this.m_zDim;return this.m_imageGauss=new Float32Array(m),this.m_imageUniformity=new Float32Array(m),this.m_verticesNew=null,this.m_pixelsSrc.length!==m?0:1}},{key:"makeUniformityImage",value:function(e,t,i,a,o,r,n,s,l){var m,h,u,c=1/27,d=r<a-1?r:a-1;for(u=o>1?o:1;u<d;u++){var _=u*t*i;for(h=1;h<i-1;h++){var f=h*t;for(m=1;m<t-1;m++){var v=0,p=0,g=0,S=void 0,y=void 0,x=void 0;for(x=-1;x<=1;x++){var b=(u+x)*t*i;for(y=-1;y<=1;y++){var D=(h+y)*t;for(S=-1;S<=1;S++){var T=e[m+S+D+b];v+=T*S,p+=T*y,g+=T*x}}}v*=c,p*=c,g*=c;var E=Math.sqrt(v*v+p*p+g*g);n[m+f+_]=E,s[m+f+_]=Math.exp(-l*E)}}}}},{key:"startImageSmooth",value:function(){var e,t=this.m_xDim*this.m_yDim*this.m_zDim;for(e=0;e<t;e++)this.m_imageGauss[e]=0,this.m_imageUniformity[e]=0;for(this.m_imageSrc=new Float32Array(t),this.m_imageGrad=new Float32Array(t),e=0;e<t;e++){this.m_imageGrad[e]=0;var i=this.m_pixelsSrc[e];this.m_imageSrc[e]=i}return 1}},{key:"stopImageSmooth",value:function(){this.m_imageGrad=null,this.m_imageSrc=null}},{key:"applyPartGaussSmooth",value:function(e,t,i,a){var o,r,n,s=1+2*i,l=1/(3*a*a),m=0;if(0===e){this.m_gaussMatrix=new Float32Array(6859);var h=0;for(n=-i;n<=+i;n++){var u=n/i;for(r=-i;r<=+i;r++){var c=r/i;for(o=-i;o<=+i;o++){var d=o/i,_=d*d+c*c+u*u,f=Math.exp(-1*_*l);this.m_gaussMatrix[m++]=f,h+=f}}}var v=s*s*s,p=1/h;for(m=0;m<v;m++)this.m_gaussMatrix[m]*=p;var g=this.m_xDim*this.m_yDim*this.m_zDim;for(m=0;m<g;m++)this.m_imageGauss[m]=this.m_imageSrc[m]}var S,y,x,b=e>i?e:i,D=t<this.m_zDim-i?t:this.m_zDim-i;for(x=b;x<D;x++){var T=x*this.m_xDim*this.m_yDim;for(y=i;y<this.m_yDim-i;y++){var E=y*this.m_xDim;for(S=i;S<this.m_xDim-i;S++){var M=0;for(m=0,n=-i;n<=+i;n++){var w=(x+n)*this.m_xDim*this.m_yDim;for(r=-i;r<=+i;r++){var R=(y+r)*this.m_xDim;for(o=-i;o<=+i;o++){var k=S+o,O=this.m_gaussMatrix[m++];M+=this.m_imageSrc[k+R+w]*O}}}this.m_imageGauss[S+E+T]=M}}}}},{key:"getHistogram",value:function(){var t,i=255;for(t=0;t<To;t++)this.m_histogram[t]=0;var a,o,r,n=Math.floor(this.m_zDim/2-4),s=Math.floor(this.m_zDim/2+4),l=Math.floor(this.m_yDim/2-4),m=Math.floor(this.m_yDim/2+4),h=0;for(r=n;r<s;r++){var u=r*this.m_xDim*this.m_yDim;for(o=l;o<m;o++){var c=o*this.m_xDim;for(a=0;a<this.m_xDim;a++){var d=a+c+u,_=this.m_imageGauss[d];_=_<i?_:i,this.m_histogram[Math.floor(_)]++,h++}}}for(t=0;t<To;t++){var f=this.m_histogram[t];this.m_colorProbability[t]=f/h}var v;e.smoothArray(this.m_colorProbability,To,5,1.6);var p=-1;for(t=247;t>9;t--){var g=1,S=0;for(v=t-9;v<=t+9;v++)if(this.m_colorProbability[t]>this.m_colorProbability[v]&&(S=1),this.m_colorProbability[t]<this.m_colorProbability[v]){g=0;break}if(g&&S){p=t;break}}-1===p&&console.log("Bright color cant be detected !");var y=-1;for(t=0;t<p;t++){var x=!0,b=!1,D=t+9<=i?t+9:i;for(v=t-9>=0?t-9:0;v<=D;v++)if(this.m_colorProbability[t]>this.m_colorProbability[v]&&(b=!0),this.m_colorProbability[t]<this.m_colorProbability[v]){x=!1;break}if(x&&b){y=t;break}}-1===y&&console.log("indDarkColor should not be -1"),y>=p&&console.log("indDarkColor should not less then indBrightColor");var T=Math.floor(p/2);for(t=0;t<To;t++)this.m_histogram[t]=0;for(h=0,r=n;r<s;r++){var E=r*this.m_xDim*this.m_yDim;for(o=l;o<m;o++){var M=o*this.m_xDim,w=!1,R=0;for(a=0;a<this.m_xDim-1;a++){var k=a+M+E,O=Math.floor(this.m_imageGauss[k+0])>T?1:0;if(0===(O&(Math.floor(this.m_imageGauss[k+1])<=T?1:0))){if(w){if(R>40)break;if(O)break;R++;var A=Math.floor(this.m_pixelsSrc[k+0]);this.m_histogram[A]++,h++}}else w=!0}}}for(t=0;t<To;t++){var C=this.m_histogram[t];this.m_colorProbability[t]=C/h}for(e.smoothArray(this.m_colorProbability,To,8,2.4),y=-1,t=0;t<p;t++){var I=!0,F=!1,P=t+9<=i?t+9:i;for(v=t-9>=0?t-9:0;v<=P;v++)if(this.m_colorProbability[t]>this.m_colorProbability[v]&&(F=!0),this.m_colorProbability[t]<this.m_colorProbability[v]){I=!1;break}if(I&&F){y=t;break}}var U=-1;for(t=y+1;t<p;t++){var X=!0,z=!1,L=t+9<=i?t+9:i;for(v=t-9>=0?t-9:0;v<=L;v++)if(this.m_colorProbability[t]<this.m_colorProbability[v]&&(z=1),this.m_colorProbability[t]>this.m_colorProbability[v]){X=!1;break}if(X&&z){U=t;break}}for(U<=y&&console.log("indDarkColorMax should be more indDarkColor!"),U>=p&&console.log("indDarkColorMax should be less indBrightColor!"),console.log("ActiveVolume. Dark colors range is [".concat(y,", ").concat(U,"]")),t=0;t<To;t++)this.m_colorProbability[t]=e.smoothStep(y,U,t);return U++,1}},{key:"resetStateForGeoUpdates",value:function(){this.m_geoStage=0,this.m_state=3,this.m_geoRender.createNormalsForGeometry()}},{key:"resetStateToStartUpdates",value:function(){this.m_geoStage=0,this.m_gaussStage=0,this.m_state=0}},{key:"updateGeo",value:function(t,i){if("undefined"===t){console.log("ActiveVolume. updateGeo: geo undefined");return-1}if(null===t){console.log("ActiveVolume. updateGeo: geo null");return-2}if(4===this.m_state)return 1;if(0===this.m_state){var a=t.createNormalsForGeometry();if(1!==a)return console.log("geo.createNormalsForGeometry returned fail"),a;this.startImageSmooth(),this.m_gaussStage=0,this.m_state=1}if(1===this.m_state){var o=Math.floor(this.m_zDim*(this.m_gaussStage+0)/e.ACT_VOL_NUM_SMOOTH_STAGES),r=Math.floor(this.m_zDim*(this.m_gaussStage+1)/e.ACT_VOL_NUM_SMOOTH_STAGES);if(this.applyPartGaussSmooth(o,r,2,1.8),this.m_gaussStage++,this.m_gaussStage>=e.ACT_VOL_NUM_SMOOTH_STAGES)return this.m_state=2,this.m_uniformityStage=0,console.log("UpdateGeo. AV_STATE_PREPARE_UNIFORMITY."),1}if(2===this.m_state){var n=Math.floor(this.m_zDim*(this.m_uniformityStage+0)/e.ACT_VOL_NUM_SMOOTH_STAGES),s=Math.floor(this.m_zDim*(this.m_uniformityStage+1)/e.ACT_VOL_NUM_SMOOTH_STAGES);if(this.makeUniformityImage(this.m_imageGauss,this.m_xDim,this.m_yDim,this.m_zDim,n,s,this.m_imageGrad,this.m_imageUniformity,.07),this.m_uniformityStage++,this.m_uniformityStage>=e.ACT_VOL_NUM_SMOOTH_STAGES){return this.getHistogram(),this.stopImageSmooth(),this.m_geoStage=0,this.m_state=3,1}}if(3===this.m_state){if(null===this.m_verticesNew){var l=t.getNumVertices();this.m_verticesNew=new Float32Array(4*l)}var m=0!==(1&i),h=0!==(2&i),u=0!==(4&i);if(m&&!h&&this.updateGeoByVertexNormals(t,1.1),m&&h&&!u&&this.updateGeoByVertexNormalsAndUniformity(t,1.1),m&&h&&u)this.updateGeoNormalsUniformityColors(t,1.1)&&(console.log("updateGeoNormalsUniformityColors is FINISHED. m_geoStage = ".concat(this.m_geoStage)),this.m_state=4);this.m_geoStage++}return 1}},{key:"getAveUniformityForGeoVertices",value:function(e){var t,i,a=e.getNumVertices(),o=e.getVertices(),r=this.m_xDim*this.m_yDim,n=0;for(t=0,i=0;t<a;t++,i+=4){var s=Math.floor(o[i+0]),l=Math.floor(o[i+1]),m=Math.floor(o[i+2]),h=s+l*this.m_xDim+m*r;n+=this.m_imageUniformity[h]}return n/=a}},{key:"finalizeUpdatesGeo",value:function(e,t){if(t){console.log("geoUpdates are finished in ".concat(this.m_updateCounter," steps"));e.saveGeoToObjFile("geo_final.obj")}}},{key:"updateGeoNormalsUniformityColors",value:function(e,t){var i=e.getNumVertices(),a=e.getVertices(),o=e.getNormals(),r=e.getNumTriangles(),n=e.getIndices();null===this.m_lapSmoother&&(this.m_lapSmoother=new So),this.m_lapSmoother.performSmoothStep(i,a,r,n,this.m_verticesNew);var s,l,m=!1,h=!1;for(s=0,l=0;s<i;s++,l+=4){var u=a[l+0],c=a[l+1],d=a[l+2],_=o[s],f=Math.floor(u),v=Math.floor(c),p=Math.floor(d);m,f>=this.m_xDim&&(h=!0,f=this.m_xDim-1),v>=this.m_yDim&&(h=!0,v=this.m_yDim-1),p>=this.m_zDim&&(h=!0,p=this.m_zDim-1),f<0&&(h=!0,f=0),v<0&&(h=!0,v=0),p<0&&(h=!0,p=0);var g=this.m_xDim*this.m_yDim,S=f+v*this.m_xDim+p*g,y=this.m_imageUniformity[S],x=this.m_imageGauss[S];m;var b=y,D=Math.floor(u+2.5*_.x),T=Math.floor(c+2.5*_.y),E=Math.floor(d+2.5*_.z);m,(D<0||T<0||E<0||D>=this.m_xDim||T>=this.m_yDim||E>=this.m_zDim)&&(h=!0),T=T>=0?T:0,E=E>=0?E:0,D=(D=D>=0?D:0)<this.m_xDim?D:this.m_xDim-1,T=T<this.m_yDim?T:this.m_yDim-1,E=E<this.m_zDim?E:this.m_zDim-1;var M=D+T*this.m_xDim+E*g,w=this.m_imageGauss[M];w>x&&(b*=.3);var R=this.m_colorProbability[Math.floor(x)];b*=R;var k=R<=.9;m;var O=new ce.R;O.x=this.m_verticesNew[l+0]-u,O.y=this.m_verticesNew[l+1]-c,O.z=this.m_verticesNew[l+2]-d,O.normalize(),O.multiplyScalar(t);var A=new ce.R;A.x=_.x*b*t,A.y=_.y*b*t,A.z=_.z*b*t;var C=.3;if(k);else{var I=new ce.R;I.x=u+.7*A.x+O.x*C,I.y=c+.7*A.y+O.y*C,I.z=d+.7*A.z+O.z*C,u=I.x,c=I.y,d=I.z}this.m_verticesNew[l+0]=u,this.m_verticesNew[l+1]=c,this.m_verticesNew[l+2]=d}var F=0;for(s=0,l=0;s<i;s++,l+=4){var P=this.m_verticesNew[l+0]-a[l+0],U=this.m_verticesNew[l+1]-a[l+1],X=this.m_verticesNew[l+2]-a[l+2];F+=P*P+U*U+X*X,a[l+0]=this.m_verticesNew[l+0],a[l+1]=this.m_verticesNew[l+1],a[l+2]=this.m_verticesNew[l+2]}F/=i;if((F=Math.sqrt(F))<.12)return this.finalizeUpdatesGeo(e,m),!0;var z=this.getAveUniformityForGeoVertices(e);if(z<.6)return this.finalizeUpdatesGeo(e,m),!0;if(h)return this.finalizeUpdatesGeo(e,m),!0;return!1}}],[{key:"getBoundingBox",value:function(e,t,i,a,o,r){var n,s,l;r.set(0,0,0),o.set(e,t,i);var m=0;for(l=0;l<i;l++)for(s=0;s<t;s++)for(n=0;n<e;n++){var h=a[m];m++,h<50||(o.x=n<o.x?n:o.x,o.y=s<o.y?s:o.y,o.z=l<o.z?l:o.z,r.x=n>r.x?n:r.x,r.y=s>r.y?s:r.y,r.z=l>r.z?l:r.z)}}},{key:"saveVolumeSliceToFile",value:function(e,t,i,a,o,r){var n=t*i,s=3*t;s=s+3&-4;for(var l=54+3*n,m=new Uint8Array(l),h=0;h<l;h++)m[h]=0;var u=255,c=0;m[c++]=66,m[c++]=77;var d=54+s*i;m[c++]=d&u,d>>=8,m[c++]=d&u,d>>=8,m[c++]=d&u,d>>=8,m[c++]=d&u,c+=4;var _=54;m[c++]=_&u,_>>=8,m[c++]=_&u,_>>=8,m[c++]=_&u,_>>=8,m[c++]=_&u;var f=40;m[c++]=f&u,f>>=8,m[c++]=f&u,f>>=8,m[c++]=f&u,f>>=8,m[c++]=f&u;var v=t;m[c++]=v&u,v>>=8,m[c++]=v&u,v>>=8,m[c++]=v&u,v>>=8,m[c++]=v&u;var p=i;m[c++]=p&u,p>>=8,m[c++]=p&u,p>>=8,m[c++]=p&u,p>>=8,m[c++]=p&u,m[c++]=1,m[c++]=0,m[c++]=24,m[c++]=0,c+=4;var g,S=s*i;m[c++]=S&u,S>>=8,m[c++]=S&u,S>>=8,m[c++]=S&u,S>>=8,m[c++]=S&u,c+=4,c+=4,c+=4,c+=4;var y=o*t*i,x=0;for(g=0;g<n;g++){var b=e[y+g];x=b>x?b:x}console.log("saveVolumeSlice. valMax = ".concat(x));for(g=0;g<n;g++){var D=Math.floor(255*e[y+g]/x);m[c++]=D,m[c++]=D,m[c++]=D}var T=new Blob([m],{type:"application/octet-stream"}),E=URL.createObjectURL(T),M=document.createElement("a");M.setAttribute("href",E),M.setAttribute("download",r);var w=document.createEvent("MouseEvents");w.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),M.dispatchEvent(w)}},{key:"smoothStep",value:function(e,t,i){var a=(i-e)/(t-e);return(a=(a=a>0?a:0)<1?a:1)*a*(3-2*a)}},{key:"smoothArray",value:function(e,t,i,a){for(var o=new Float32Array(To),r=1/(a*a),n=0;n<t;n++){for(var s=0,l=0,m=-i;m<=+i;m++){var h=n+m;h=(h=h>=0?h:0)<t?h:t-1;var u=m/i,c=1/Math.exp(u*u*r);l+=c,s+=e[h]*c}var d=s/l;o[n]=d}for(var _=0;_<t;_++)e[_]=o[_]}}]),e}();Eo.REMOVE_SKULL=0,Eo.CREATE_MASK=1,Eo.SPHERE_EVOLVE_FROM_INSIDE=0,Eo.SPHERE_EVOLVE_FROM_OUTSIDE=1,Eo.ACT_VOL_NUM_SMOOTH_STAGES=64;var Mo=2916e4,wo=function(){function e(){Object(v.a)(this,e),this.m_vol=null,this.m_z=-1,this.m_iter=-1,this.m_pixelsDst=null,this.m_sqrtTable=null}return Object(p.a)(e,[{key:"getPixelsDst",value:function(){return this.m_pixelsDst}},{key:"start",value:function(e){console.assert(null!=e),console.assert(null!==e.m_dataArray),this.m_vol=e,this.m_z=0,this.m_iter=0;var t=e.m_xDim,i=e.m_yDim,a=e.m_zDim;this.m_pixelsDst=new Float32Array(t*i*a),this.m_sqrtTable=new Float32Array(Mo);for(var o=0;o<Mo;o++)this.m_sqrtTable[o]=Math.sqrt(o)}},{key:"normalizeDstImage",value:function(){for(var e=0,t=this.m_vol.m_xDim*this.m_vol.m_yDim*this.m_vol.m_zDim,i=0;i<t;i++){var a=this.m_pixelsDst[i];e=a>e?a:e}for(var o=255/(e+=.9),r=0;r<t;r++)this.m_pixelsDst[r]=Math.floor(this.m_pixelsDst[r]*o)}},{key:"stop",value:function(){this.m_pixelsDst=null,this.m_sqrtTable=null}},{key:"getRatio",value:function(){var e=this.m_vol.m_zDim;return this.m_z/e}},{key:"isFinished",value:function(){console.assert(this.m_z>=0);var e=this.m_vol.m_zDim;return this.m_z>=e}},{key:"update",value:function(){console.assert(this.m_z>=0),console.assert(null!==this.m_pixelsDst);for(var e=this.m_vol.m_dataArray,t=this.m_vol.m_xDim,i=this.m_vol.m_yDim,a=this.m_vol.m_zDim,o=t*i,r=Math.floor((this.m_iter+1)*a/24),n=this.m_z*o,s=this.m_z;s<r;s++)for(var l=0;l<i;l++)for(var m=0;m<t;m++){for(var h=0,u=0,c=0,d=-1;d<=1;d++)for(var _=s+d,f=(_=(_=_>=0?_:0)<a?_:a-1)*o,v=-1;v<=1;v++)for(var p=l+v,g=(p=(p=p>=0?p:0)<i?p:i-1)*t,S=-1;S<=1;S++){var y=m+S,x=e[(y=(y=y>=0?y:0)<t?y:t-1)+g+f],b=1;0===v&&(b*=2),0===d&&(b*=2),h+=S*x*b;var D=1;0===S&&(D*=2),0===d&&(D*=2),u+=v*x*D;var T=1;0===S&&(T*=2),0===v&&(T*=2),c+=d*x*T}var E=h*h+u*u+c*c|0;console.assert(E<Mo),this.m_pixelsDst[n]=this.m_sqrtTable[E],n++}this.m_iter+=1,this.m_z=r}}]),e}(),Ro=function(){function e(){Object(v.a)(this,e),this.m_strShaderVertex="\nvarying vec2 texCoord;\nvoid main() {\n  texCoord = position.xy + vec2(0.5, 0.5);\n  gl_Position = vec4(position * 2.0, 1.0);\n}\n",this.m_strShaderFragment="\nvarying vec2 texCoord;\nprecision highp sampler3D;\nuniform sampler3D texVolume;\nuniform vec3 texelSize;\nuniform float volumeSizeZ;\nuniform float distSigma;\nuniform float valSigma;\nuniform float kernelSize;\nuniform float xDim;\nuniform float yDim;\nuniform float curZ;\n\nfloat filterBlur(vec3 base)\n{\n  float koefDist = 1.0 / (3.0 * distSigma * distSigma);\n  float koefVal = 1.0 / (valSigma * valSigma);\n  float valCenter = texture(texVolume, base + vec3(0.5, 0.5, 0.5)).r;\n  float sumWeights = 0.0;\n  float acc = 0.0;\n\n  float range = kernelSize;\n  float rangePlusHalf = range + 0.5;\n\n  for (float i = -range; i < rangePlusHalf; i += 1.0) {\n    float tz = i / range;\n    for (float j = -range; j < rangePlusHalf; j += 1.0) {\n      float ty = j / range;\n      for (float k = -range; k < rangePlusHalf; k += 1.0)\n      {\n        float tx = k / range;\n        vec3 texc = base + vec3(texelSize.x * i, texelSize.y * j, texelSize.z * k);\n        texc = texc + vec3(0.5, 0.5, 0.5);\n        texc = clamp(texc, vec3(0.0, 0.0, 0.0), vec3(1.0 - texelSize.x, 1.0 - texelSize.y, 1.0 - texelSize.z));\n        float curVal = texture(texVolume, texc).r;\n        float deltaVal = (curVal - valCenter) / 256.0;\n        float weightDist = exp( -(tx * tx + ty * ty + tz * tz) * koefDist);\n        float weightVal = exp( -(deltaVal * deltaVal) * koefVal );\n        float weight = weightDist * weightVal;\n        // float weight = weightDist;\n        acc += curVal * weight;\n        sumWeights += weight;\n      } // for x\n    } // for j\n  } // for i\n\n  // get weighted result intencity\n  acc = acc / sumWeights;\n  return acc;\n  //return valCenter;\n}\n\nvoid main() {\n  vec3 base;\n  base.xy = texCoord;\n  base.z = curZ;\n  base = base - vec3(0.5, 0.5, 0.5);\n  float val = filterBlur(base);\n  gl_FragColor = vec4(val, val, val, 1);\n}\n\n",this.m_bufferTextureCPU=null,this.m_iter=0,this.m_z=0;this.m_uniforms={texVolume:{type:"t",value:null},texelSize:{type:"v3",value:null},volumeSizeZ:{type:"f",value:256},xDim:{type:"f",value:256},yDim:{type:"f",value:256},distSigma:{type:"f",value:.8},valSigma:{type:"f",value:1.6},curZ:{type:"f",value:0},kernelSize:{type:"f",value:0}},this.m_defines={useWebGL2:1}}return Object(p.a)(e,[{key:"getImageDst",value:function(){return this.m_bufferTextureCPU}},{key:"isFinished",value:function(){return this.m_z>=this.m_zDim}},{key:"update",value:function(){for(var e=this.m_zDim,t=e>16?24:2,i=Math.floor((this.m_iter+1)*e/t),a=0,o=this.m_z;o<i;o++){this.m_material.uniforms.curZ.value=o/this.m_zDim,this.m_material.uniforms.curZ.needsUpdate=!0,this.rendererBlur.render(this.sceneBlur,this.cameraOrtho,this.bufferTexture),this.gl.readPixels(0,0,this.m_xDim,this.m_yDim,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.m_frameBuf);for(var r=o*this.m_xDim*this.m_yDim,n=0;n<this.m_yDim;n++)for(var s=n*this.m_xDim,l=0;l<this.m_xDim;l++){var m=this.m_frameBuf[4*(l+s)];this.m_bufferTextureCPU[l+s+r]=m,a=m>a?m:a}}this.m_iter+=1,this.m_z=i}},{key:"setVolumeTextureWebGL2",value:function(e,t){this.m_material.uniforms.distSigma.value=e,this.m_material.uniforms.distSigma.needsUpdate=!0,this.m_material.uniforms.valSigma.value=t,this.m_material.uniforms.valSigma.needsUpdate=!0,this.m_z=0,this.m_iter=0;this.m_frameBuf=new Uint8Array(4*this.m_xDim*this.m_yDim),this.gl=this.rendererBlur.getContext()}},{key:"initRenderer",value:function(e,t){this.sceneBlur=new ce.J,this.cameraOrtho=new ce.D(-this.m_xDim/2,+this.m_xDim/2,+this.m_yDim/2,-this.m_yDim/2,.1,100);var i=new Ie;this.context=i.createWebGLContext(),this.canvas3d=i.getCanvas(),this.rendererBlur=new ce.U({canvas:this.canvas3d,context:this.context});var a=new ce.G(1,1);this.rendererBlur.setSize(this.m_xDim,this.m_yDim);var o=new ce.y(a,this.m_material);this.m_uniforms.volumeSizeZ.value=this.m_zDim,this.m_uniforms.xDim.value=this.m_xDim,this.m_uniforms.yDim.value=this.m_yDim,this.m_defines.useWebGL2=1,this.sceneBlur.add(o),this.m_material.needsUpdate=!0,this.setVolumeTextureWebGL2(e,t)}},{key:"create",value:function(e,t,i,a){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.1,r=1/i*a,n=1/256*o;console.log("BilateralHW params: kernel="+i.toString()+" dist sigma="+r.toString()+" val sigma="+n.toString());var s=e.m_xDim,l=e.m_yDim,m=e.m_zDim;this.m_xDim=s,this.m_yDim=l,this.m_zDim=m;var h=e.m_dataArray;this.m_bufferTextureCPU=new Uint8Array(this.m_xDim*this.m_yDim*this.m_zDim),this.bufferR=new Uint8Array(this.m_xDim*this.m_yDim*this.m_zDim);for(var u=s*l*m,c=0;c<u;c++)this.m_bufferTextureCPU[c]=h[c],this.bufferR[c]=h[c];return this.bufferTexture=new ce.T(this.m_xDim,this.m_yDim,{minFilter:ce.u,magFilter:ce.u,format:ce.H,type:ce.P,depthBuffer:!1}),this.origVolumeTex=new ce.k(this.bufferR,this.m_xDim,this.m_yDim,this.m_zDim),this.origVolumeTex.format=ce.I,this.origVolumeTex.type=ce.P,this.origVolumeTex.wrapR=ce.g,this.origVolumeTex.wrapS=ce.g,this.origVolumeTex.wrapT=ce.g,this.origVolumeTex.magFilter=ce.z,this.origVolumeTex.minFilter=ce.z,this.origVolumeTex.needsUpdate=!0,this.m_material=new ce.K({uniforms:this.m_uniforms,defines:this.m_defines,vertexShader:this.m_strShaderVertex,fragmentShader:this.m_strShaderFragment}),this.m_uniforms.texVolume.value=this.origVolumeTex,this.m_uniforms.texelSize.value=t,this.m_uniforms.kernelSize.value=i,this.m_zDim>=1&&this.initRenderer(r,n),this.m_bufferTextureCPU}}]),e}(),ko=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];Object(v.a)(this,e),this.m_needHw=t,this.m_vol=null,this.m_z=-1,this.m_iter=-1,this.m_pixelsDst=null,this.m_kernel=null,this.m_bilateralHw=null}return Object(p.a)(e,[{key:"getPixelsDst",value:function(){return this.m_needHw?this.m_bilateralHw.getImageDst():this.m_pixelsDst}},{key:"createKernel",value:function(e,t){for(var i=2*e+1,a=i*i*i,o=new Float32Array(a),r=1/(2*t*t),n=0,s=0,l=-e;l<=+e;l++)for(var m=l/e,h=-e;h<=+e;h++)for(var u=h/e,c=-e;c<=+e;c++){var d=c/e,_=Math.exp(-(d*d+u*u+m*m)*r);o[n++]=_,s+=_}for(var f=1/s,v=0;v<a;v++)o[v]*=f;this.m_kernel=o}},{key:"start",value:function(e,t,i){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.1,o=1/t*i;this.createKernel(t,o),this.m_kernelSize=t,console.assert(null!=e),console.assert(null!==e.m_dataArray),this.m_vol=e,this.m_z=0,this.m_iter=0;var r=e.m_xDim,n=e.m_yDim,s=e.m_zDim;if(this.m_pixelsDst=new Float32Array(r*n*s),this.m_needHw){this.m_bilateralHw=new Ro;var l=new ce.R(1/r,1/n,1/s);this.m_bilateralHw.create(e,l,t,i,a)}}},{key:"normalizeDstImage",value:function(){if(!this.m_needHw){for(var e=0,t=this.m_vol.m_xDim*this.m_vol.m_yDim*this.m_vol.m_zDim,i=0;i<t;i++){var a=this.m_pixelsDst[i];e=a>e?a:e}for(var o=255/(e+=.9),r=0;r<t;r++)this.m_pixelsDst[r]=Math.floor(this.m_pixelsDst[r]*o)}}},{key:"stop",value:function(){this.m_pixelsDst=null,this.m_kernel=null}},{key:"getRatio",value:function(){var e=this.m_vol.m_zDim;return this.m_needHw?this.m_bilateralHw.m_z/e:this.m_z/e}},{key:"isFinished",value:function(){console.assert(this.m_z>=0);var e=this.m_vol.m_zDim;if(this.m_needHw){if(this.m_bilateralHw.m_z>=e)return!0}else if(this.m_z>=e)return!0;return!1}},{key:"update",value:function(){if(this.m_needHw)this.m_bilateralHw.update();else{console.assert(this.m_z>=0),console.assert(null!==this.m_pixelsDst);for(var e=this.m_vol.m_dataArray,t=this.m_vol.m_xDim,i=this.m_vol.m_yDim,a=this.m_vol.m_zDim,o=t*i,r=a>16?24:2,n=Math.floor((this.m_iter+1)*a/r),s=this.m_kernel,l=this.m_kernelSize,m=this.m_z*o,h=this.m_z;h<n;h++)for(var u=0;u<i;u++)for(var c=0;c<t;c++){for(var d=0,_=0,f=-l;f<=+l;f++)for(var v=h+f,p=(v=(v=v>=0?v:0)<a?v:a-1)*o,g=-l;g<=+l;g++)for(var S=u+g,y=(S=(S=S>=0?S:0)<i?S:i-1)*t,x=-l;x<=+l;x++){var b=c+x;b=(b=b>=0?b:0)<t?b:t-1,d+=s[_]*e[b+y+p],_++}this.m_pixelsDst[m]=d,m++}this.m_iter+=1,this.m_z=n}}},{key:"testSimple",value:function(){var e=16,t=new _e;t.createEmptyBytesVolume(e,e,e);for(var i=0,a=t.m_dataArray,o=0;o<e;o++)for(var r=0;r<e;r++)for(var n=0;n<e;n++)a[i++]=o<8?0:255;for(this.start(t,2,.3333333333333333);!this.isFinished();)this.update();for(var s=this.getPixelsDst(),l=-1,m=0;m<e;m++){var h=a[136+256*m],u=s[136+256*m];console.log("src val / gauss val = "+h.toString()+" / "+u.toString()),u>=l||console.log("gauss test failed"),l=u}this.stop(),console.log("gauss test completed on a small volume")}}]),e}(),Oo=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onModalShow=a.onModalShow.bind(Object(y.a)(a)),a.onModalHide=a.onModalHide.bind(Object(y.a)(a)),a.onButtonStart=a.onButtonStart.bind(Object(y.a)(a)),a.onChangeSliderKoefDist=a.onChangeSliderKoefDist.bind(Object(y.a)(a)),a.onChangeSliderKoefVal=a.onChangeSliderKoefVal.bind(Object(y.a)(a)),a.onBilateralCallback=a.onBilateralCallback.bind(Object(y.a)(a)),a.m_hideFunc=null,a.m_gauss=null,a.state={showModalGauss:!1,text:"dump"},a.m_kernelSize=10,a.m_koefDist=3,a.m_koefVal=.1,a}return Object(p.a)(i,[{key:"onButtonStart",value:function(){console.log("on button start Bilateral with kernel = "+this.m_kernelSize.toString()),this.m_hideFunc();var e=this.props,t=e.volumeSet,i=e.volumeIndex,a=t.getVolume(i);if(void 0!==a&&null!==a){this.m_vol=a;var o=a.m_xDim,r=a.m_yDim,n=a.m_zDim;if(o*r*n<1)console.log("onButtonBilateral: bad volume! dims = ".concat(o,"*").concat(r,"*").concat(n));else{if(1===a.m_bytesPerVoxel){console.log("onButtonBilateral: start 3d bilateral filtration...");var s=new ko(!0),l=this.m_kernelSize;s.start(a,l,this.m_koefDist,this.m_koefVal),this.m_gauss=s;var m=e.uiApp;m.doShowProgressBar("Apply bilateral filter..."),m.doSetProgressBarRatio(0);this.m_timerId=setTimeout(this.onBilateralCallback,150)}else console.log("onButtonBilateral: supported only 1bpp volumes")}}else console.log("onButtonSobel: no volume!")}},{key:"onBilateralCallback",value:function(){this.m_gauss.update();var e=this.props,t=this.m_gauss.getRatio();t=t<1?t:1,t*=100,t=Math.floor(t);var i=e.uiApp;i.doSetProgressBarRatio(t);var a=this.m_gauss.isFinished();if(a){console.log("onBilateralCallback: iters finished!"),i.doHideProgressBar(),clearInterval(this.m_timerId),this.m_timerId=0;for(var o=e.volumeSet,r=e.volumeIndex,n=o.getVolume(r),s=n.m_xDim*n.m_yDim*n.m_zDim,l=this.m_gauss.getPixelsDst(),u=0;u<s;u++)n.m_dataArray[u]=Math.floor(l[u]);this.m_gauss.stop(),e.dispatch({type:m.SET_VOLUME_SET,volumeSet:o}),e.dispatch({type:m.SET_IS_LOADED,isLoaded:!0});var d=new de;d.createFromRawVolume(n),e.dispatch({type:m.SET_TEXTURE3D,texture3d:d}),e.dispatch({type:m.SET_MODE_VIEW,modeView:h.VIEW_2D}),e.dispatch({type:m.SET_MODE_3D,mode3d:c.RAYCAST})}if(e.graphics2d.forceUpdate(),!a){this.m_timerId=setTimeout(this.onBilateralCallback,150)}}},{key:"onModalShow",value:function(){this.setState({showModalGauss:!0})}},{key:"onModalHide",value:function(){this.setState({showModalGauss:!1})}},{key:"handleFormSubmit",value:function(e){e.preventDefault(),this.m_hideFunc()}},{key:"onChangeSliderKoefDist",value:function(){if(void 0!==this.refs){this.m_updateEnable=!1;var e=0,t=this.refs.slider1.slider.get();"string"===typeof t&&(e=Number.parseFloat(t),this.m_koefDist=e)}}},{key:"onChangeSliderKoefVal",value:function(){if(void 0!==this.refs){this.m_updateEnable=!1;var e=0,t=this.refs.slider2.slider.get();"string"===typeof t&&(e=Number.parseFloat(t),this.m_koefVal=e)}}},{key:"render",value:function(){var e=this,t=this.props.stateVis,i=this.props.onHide;this.m_hideFunc=i;var a=[3],r=[.1];return o.a.createElement(oi.a,{show:t,onHide:i},o.a.createElement(oi.a.Title,null,"Bilateral filtration"),o.a.createElement(oi.a.Body,null,o.a.createElement(eo.a,null,o.a.createElement("tbody",null,o.a.createElement("tr",null,o.a.createElement("td",{style:{paddingBottom:"32px"}},"Select koefficient distance (kd)")),o.a.createElement("tr",null,o.a.createElement("td",null,o.a.createElement(x.a,null,o.a.createElement(b.a,null,o.a.createElement(se.a,{onSubmit:function(t){return e.handleFormSubmit(t)}},o.a.createElement(P.a,{onSlide:this.onChangeSliderKoefDist.bind(this),ref:"slider1",range:{min:.5,max:3},start:a,step:.2,tooltips:true})))))),o.a.createElement("tr",null,o.a.createElement("td",{style:{paddingBottom:"32px"}},"Select koefficient value (kv)")),o.a.createElement("tr",null,o.a.createElement("td",null,o.a.createElement(x.a,null,o.a.createElement(b.a,null,o.a.createElement(se.a,{onSubmit:function(t){return e.handleFormSubmit(t)}},o.a.createElement(P.a,{onSlide:this.onChangeSliderKoefVal.bind(this),ref:"slider2",range:{min:.1,max:4},start:r,step:.2,tooltips:true})))))),o.a.createElement("tr",null,o.a.createElement("td",null,o.a.createElement("b",null,"Hints to setup values:")," ",o.a.createElement("br",null),"kd = 0.5, kv = 0.1 => original image ",o.a.createElement("br",null),"kd = 3.0, kv = 0.1 => denoise image ",o.a.createElement("br",null),"kd = 3.0, kv = 4.0 => image blur")),o.a.createElement("tr",null,o.a.createElement("td",null,o.a.createElement(x.a,null,o.a.createElement(b.a,{lg:!0,xl:"2"},o.a.createElement(A.a,{onClick:this.onButtonStart},"Start")),o.a.createElement(b.a,{lg:!0,xl:"10"}))))))))}}]),i}(o.a.Component),Ao=Object(s.b)((function(e){return e}))(Oo),Co=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onButtonLungsSeg=a.onButtonLungsSeg.bind(Object(y.a)(a)),a.onLungsFillerCallback=a.onLungsFillerCallback.bind(Object(y.a)(a)),a.onButtonDetectBrain=a.onButtonDetectBrain.bind(Object(y.a)(a)),a.onSkullRemoveCallback=a.onSkullRemoveCallback.bind(Object(y.a)(a)),a.onButtonSobel=a.onButtonSobel.bind(Object(y.a)(a)),a.onSobelCallback=a.onSobelCallback.bind(Object(y.a)(a)),a.onButtonBilateral=a.onButtonBilateral.bind(Object(y.a)(a)),a.showModalBilateral=a.showModalBilateral.bind(Object(y.a)(a)),a.hideModalBilateral=a.hideModalBilateral.bind(Object(y.a)(a)),a.state={showModalBilateral:!1},a}return Object(p.a)(i,[{key:"onButtonLungsSeg",value:function(){var e=this.props,t=e.volumeSet,i=e.volumeIndex,a=t.getVolume(i);if(void 0!==a&&null!==a){var o=a.m_xDim,r=a.m_yDim,n=a.m_zDim;if(o*r*n<1)console.log("onButtonDetectBrain: bad volume! dims = ".concat(o,"*").concat(r,"*").concat(n));else{if(1===a.m_bytesPerVoxel){this.lungsFiller=new vo(a);var s=e.uiApp;s.doShowProgressBar("lungsFiller..."),s.doSetProgressBarRatio(0);this.m_timerId=setTimeout(this.onLungsFillerCallback,200)}else console.log("onButtonDetectBrain: supported only 1bpp volumes")}}else console.log("onButtonDetectBrain: no volume!")}},{key:"onLungsFillerCallback",value:function(){var e=this.props,t=this.lungsFiller.m_ratioUpdate;console.log("onLungsFillerCallback: iter counter = ".concat(t));var i=e.uiApp;i.doSetProgressBarRatio(t);var a=this.lungsFiller.run();if(a&&(console.log("`onSkullRemoveCallback: iters finished!"),i.doHideProgressBar(),clearInterval(this.m_timerId),this.m_timerId=0),e.graphics2d.forceUpdate(),!a){this.m_timerId=setTimeout(this.onLungsFillerCallback,200)}}},{key:"onButtonSobel",value:function(){var e=this.props,t=e.volumeSet,i=e.volumeIndex,a=t.getVolume(i);if(void 0!==a&&null!==a){this.m_vol=a;var o=a.m_xDim,r=a.m_yDim,n=a.m_zDim;if(o*r*n<1)console.log("onButtonSobel: bad volume! dims = ".concat(o,"*").concat(r,"*").concat(n));else{if(1===a.m_bytesPerVoxel){console.log("onButtonSobel: start sobel...");var s=new wo;s.start(a),this.m_sobel=s;var l=e.uiApp;l.doShowProgressBar("Apply sobel edge detector..."),l.doSetProgressBarRatio(0);this.m_timerId=setTimeout(this.onSobelCallback,150)}else console.log("onButtonSobel: supported only 1bpp volumes")}}else console.log("onButtonSobel: no volume!")}},{key:"onSobelCallback",value:function(){this.m_sobel.update();var e=this.props,t=this.m_sobel.getRatio();t=t<1?t:1,t*=100,t=Math.floor(t);var i=e.uiApp;i.doSetProgressBarRatio(t);var a=this.m_sobel.isFinished();if(a){console.log("`onSobelCallback: iters finished!"),i.doHideProgressBar(),clearInterval(this.m_timerId),this.m_timerId=0;var o=e.volumeSet,r=e.volumeIndex,n=o.getVolume(r);this.m_sobel.normalizeDstImage();for(var s=n.m_xDim*n.m_yDim*n.m_zDim,l=this.m_sobel.getPixelsDst(),u=0;u<s;u++)n.m_dataArray[u]=Math.floor(l[u]);this.m_sobel.stop(),e.dispatch({type:m.SET_VOLUME_SET,volumeSet:o}),e.dispatch({type:m.SET_IS_LOADED,isLoaded:!0});var d=new de;d.createFromRawVolume(n),e.dispatch({type:m.SET_TEXTURE3D,texture3d:d}),e.dispatch({type:m.SET_MODE_VIEW,modeView:h.VIEW_2D}),e.dispatch({type:m.SET_MODE_3D,mode3d:c.RAYCAST})}if(e.graphics2d.forceUpdate(),!a){this.m_timerId=setTimeout(this.onSobelCallback,150)}}},{key:"onButtonBilateral",value:function(){this.showModalBilateral()}},{key:"onButtonDetectBrain",value:function(){var e=this.props,t=e.volumeSet,i=e.volumeIndex,a=t.getVolume(i);if(void 0!==a&&null!==a){var o=a.m_xDim,r=a.m_yDim,n=a.m_zDim;if(o*r*n<1)console.log("onButtonDetectBrain: bad volume! dims = ".concat(o,"*").concat(r,"*").concat(n));else{var s=a.m_dataArray;if(1===a.m_bytesPerVoxel){var l=new Uint8Array(o*r*n),m=Eo.REMOVE_SKULL,h=new Eo;this.m_actVolume=h;var u=e.uiApp;u.doShowProgressBar("Remove skull..."),u.doSetProgressBarRatio(0),this.m_geoRender=h.skullRemoveStart(o,r,n,s,l,m,!0);this.m_timerId=setTimeout(this.onSkullRemoveCallback,10),m===Eo.CREATE_MASK||Eo.REMOVE_SKULL}else console.log("onButtonDetectBrain: supported only 1bpp volumes")}}else console.log("onButtonDetectBrain: no volume!")}},{key:"onSkullRemoveCallback",value:function(){var e=this.props,t=this.m_actVolume.m_updateCounter/this.m_actVolume.m_numPredSteps;t=t<1?t:1,t*=100;var i=e.uiApp;i.doSetProgressBarRatio(t);var a=this.m_actVolume.skullRemoveUpdate(this.m_geoRender);if(a){console.log("`onSkullRemoveCallback: iters finished!"),i.doHideProgressBar(),clearInterval(this.m_timerId),this.m_timerId=0,this.m_actVolume.skullRemoveStop(this.m_geoRender);var o=e.volumeSet,r=e.volumeIndex,n=o.getVolume(r),s=this.m_actVolume.m_volTexDst;n.m_dataArray=s,e.dispatch({type:m.SET_VOLUME_SET,volumeSet:o}),e.dispatch({type:m.SET_IS_LOADED,isLoaded:!0});var l=new de;l.createFromRawVolume(n),e.dispatch({type:m.SET_TEXTURE3D,texture3d:l}),e.dispatch({type:m.SET_MODE_VIEW,modeView:h.VIEW_2D}),e.dispatch({type:m.SET_MODE_3D,mode3d:c.RAYCAST})}if(e.graphics2d.forceUpdate(),!a){this.m_timerId=setTimeout(this.onSkullRemoveCallback,10)}}},{key:"componentDidMount",value:function(){}},{key:"showModalBilateral",value:function(){this.setState({showModalBilateral:!0})}},{key:"hideModalBilateral",value:function(){this.setState({showModalBilateral:!1})}},{key:"render",value:function(){var e=this,t=!this.props.isLoaded;return o.a.createElement(ai.a,{id:"save-nav-dropdown",disabled:t,title:o.a.createElement("div",{style:{display:"inline-block"}},o.a.createElement("i",{className:"fas fa-broom"}),"Filter")},o.a.createElement(ai.a.Item,{href:"#actionLungsSeg",onClick:function(t){return e.onButtonLungsSeg(t)}},o.a.createElement("i",{className:"fas fa-cloud"}),"Lungs segmentation"),o.a.createElement(ai.a.Item,{href:"#actionDataectBrain",onClick:function(t){return e.onButtonDetectBrain(t)}},o.a.createElement("i",{className:"fas fa-brain"}),"Auto detect brain"),o.a.createElement(ai.a.Item,{href:"#actionSobel",onClick:function(t){return e.onButtonSobel(t)}},"Sobel filter"),o.a.createElement(ai.a.Item,{href:"#actionBilateral",onClick:function(t){return e.onButtonBilateral(t)}},"Bilateral (denoise or smooth)"),o.a.createElement(Ao,{stateVis:this.state.showModalBilateral,onHide:this.hideModalBilateral}))}}]),i}(o.a.Component),Io=Object(s.b)((function(e){return e}))(Co),Fo=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onButtonOk=a.onButtonOk.bind(Object(y.a)(a)),a.onTexChange=a.onTexChange.bind(Object(y.a)(a)),a.handleFormSubmit=a.handleFormSubmit.bind(Object(y.a)(a)),a.m_showFunc=null,a.m_hideFunc=null,a.state={text:""},a}return Object(p.a)(i,[{key:"onTextEntered",value:function(){this.props.graphics2d.m_toolText.setText(this.state.text),this.setState({text:""})}},{key:"onButtonOk",value:function(){this.m_hideFunc(),this.onTextEntered()}},{key:"handleFormSubmit",value:function(e){e.preventDefault(),this.m_hideFunc(),this.onTextEntered()}},{key:"onTexChange",value:function(e){var t=e.target.value;this.setState({text:t})}},{key:"render",value:function(){var e=this,t=this.props.stateVis,i=this.props.onHide,a=this.props.onShow;return this.m_hideFunc=i,this.m_showFunc=a,o.a.createElement(oi.a,{show:t,onHide:i},o.a.createElement(oi.a.Body,null,o.a.createElement(oi.a.Title,null,"Input text"),o.a.createElement(se.a,{onSubmit:function(t){return e.handleFormSubmit(t)}},o.a.createElement(se.a.Control,{required:!0,type:"text",placeholder:"",defaultValue:this.state.text,onChange:this.onTexChange,autoFocus:!0})),o.a.createElement(x.a,null,o.a.createElement(b.a,{lg:!0,xl:"2"},o.a.createElement(A.a,{onClick:i},"Cancel")),o.a.createElement(b.a,{lg:!0,xl:"2"},o.a.createElement(A.a,{onClick:this.onButtonOk},"Ok")),o.a.createElement(b.a,{lg:!0,xl:"8"}))))}}]),i}(o.a.Component),Po=Object(s.b)((function(e){return e}))(Fo),Uo=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onButtonOk=a.onButtonOk.bind(Object(y.a)(a)),a.m_showFunc=null,a.m_hideFunc=null,a.state={title:"",text:""},a}return Object(p.a)(i,[{key:"onButtonOk",value:function(){this.m_hideFunc()}},{key:"render",value:function(){var e=this.props.stateVis,t=this.props.onHide,i=this.props.onShow;this.m_hideFunc=t,this.m_showFunc=i;var a=this.props.title,r=this.props.text;return o.a.createElement(oi.a,{show:e,onHide:t},o.a.createElement(oi.a.Header,{closeButton:!0},o.a.createElement(oi.a.Title,null,a)),o.a.createElement(oi.a.Body,null,o.a.createElement("p",null,r),o.a.createElement(x.a,null,o.a.createElement(b.a,{lg:!0,xl:"2"},o.a.createElement(A.a,{onClick:this.onButtonOk},"Ok")),o.a.createElement(b.a,{lg:!0,xl:"10"}))))}}]),i}(o.a.Component),Xo=Object(s.b)((function(e){return e}))(Uo),zo=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(){return Object(v.a)(this,i),t.apply(this,arguments)}return Object(p.a)(i,[{key:"render",value:function(){var e=this.props.arrErrors;return o.a.createElement(T.a,null,"Errors during read",o.a.createElement(he.a,null,e.map((function(e,t){var i=e,a="key_".concat(t);return o.a.createElement(he.a.Item,{key:a}," ",i," ")}))))}}]),i}(o.a.Component),Lo=Object(s.b)((function(e){return e}))(zo),No=i(137),Vo=function(){function e(){Object(v.a)(this,e),this.m_strUserAgent="",this.m_strVendor="",this.m_isOpera=!1,this.m_isFirefox=!1,this.m_isSafari=!1,this.m_isIE=!1,this.m_isChrome=!1,this.m_isMobileBrowser=!1}return Object(p.a)(e,[{key:"checkWebGlSupported",value:function(){var e=Object(No.createCanvas)(640,480),t=null;try{t=e.getContext("webgl2")}catch(i){t=null}return e=void 0,null!==t}},{key:"checkValidBrowser",value:function(){this.m_strUserAgent=navigator.userAgent.toLowerCase(),this.m_strVendor=navigator.vendor,this.m_isOpera=/opr\/|opios/i.test(this.m_strUserAgent),this.m_isFirefox="undefined"!==typeof InstallTrigger,this.m_isSafari=this.m_strUserAgent.search("safari")>=0&&this.m_strUserAgent.search("chrome")<0,this.m_isIE=!!document.documentMode,this.m_isChrome=/chrome/i.test(navigator.userAgent),this.m_isEdge=navigator.appVersion.indexOf("Edge")>-1,this.m_isEdge&&(this.m_isChrome=!1);var e="".concat("Med3web is designed for Chrome/Firefox/Safari browsers."," ").concat("The application can be slow or unstable in this web browser."),t=this.m_isChrome||this.m_isFirefox||this.m_isSafari||this.m_isOpera;if(!t){console.log("BrowserDetector. ".concat(e,". ").concat("App is specially designed for Chrome/Firefox/Opera/Safari browsers"))}var i=["iphone","ipad","android","blackberry","nokia","opera mini","windows mobile","windows phone","iemobile"];this.m_isMobileBrowser=!1;for(var a=0;a<i.length;a++)this.m_strUserAgent.indexOf(i[a].toLowerCase())>0&&(this.m_isMobileBrowser=!0);return(window.innerWidth<=800||window.innerHeight<=600)&&(this.m_isMobileBrowser=!0),this.m_isMobileBrowser&&console.log("MobileBrowserDetector. ".concat(e,". App can be slow due to detected mobile browser")),!!this.m_isMobileBrowser||t}}]),e}(),Bo=function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(e){var a;return Object(v.a)(this,i),(a=t.call(this,e)).onShowModalText=a.onShowModalText.bind(Object(y.a)(a)),a.onHideModalText=a.onHideModalText.bind(Object(y.a)(a)),a.onShowModalAlert=a.onShowModalAlert.bind(Object(y.a)(a)),a.onHideModalAlert=a.onHideModalAlert.bind(Object(y.a)(a)),a.doShowProgressBar=a.doShowProgressBar.bind(Object(y.a)(a)),a.doHideProgressBar=a.doHideProgressBar.bind(Object(y.a)(a)),a.doSetProgressBarRatio=a.doSetProgressBarRatio.bind(Object(y.a)(a)),a.m_modalText=null,a.m_store=null,a.m_fileNameOnLoad="",a.state={showModalText:!1,showProgressBar:!1,progressBarRatio:55,showModalAlert:!1,strAlertTitle:"???",strAlertText:"???",strProgressMessage:"Loading..."},a}return Object(p.a)(i,[{key:"UNSAFE_componentWillMount",value:function(){var e="",t=window.location.search;if(t.length>0){var i=t.match(/\\?url=(\S+)/);if(null===i)return void console.log("arguments should be in form: ?url=www.xxx.yy/zz/ww");var a=(e=i[1]).match(/^((ftp|http|https):\/\/)?(([\S]+)\.)?([\S]+)\.([A-z]{2,})(:\d{1,6})?\/[\S]+/),o=e.match(/(ftp|http|https):\/\/([\d]+)\.([\d]+)\.([\d]+)\.([\d]+)(:([\d]+))?\/([\S]+)/);if(null===a&&null===o)return void console.log("Not valid URL = ".concat(e));this.m_fileNameOnLoad=e}}},{key:"componentDidMount",value:function(){var e=this.m_store;null===e&&console.log("UiApp. componentDidMount. store is NULL"),e.dispatch({type:m.SET_UI_APP,uiApp:this});var t=new Vo;(this.isWebGl20supported=t.checkWebGlSupported(),this.isWebGl20supported)?t.checkValidBrowser()||(this.setState({strAlertTitle:"Browser compatibility problem detected"}),this.setState({strAlertText:"App is specially designed for Chrome/Firefox/Opera/Safari browsers"}),this.onShowModalAlert()):(this.setState({strAlertTitle:"Browser compatibility problem detected"}),this.setState({strAlertText:"This browser not supported WebGL 2.0. Application functinality is decreased and app can be unstable"}),this.onShowModalAlert())}},{key:"onShowModalText",value:function(){this.setState({showModalText:!0})}},{key:"onHideModalText",value:function(){this.setState({showModalText:!1})}},{key:"onShowModalAlert",value:function(){this.setState({showModalAlert:!0})}},{key:"onHideModalAlert",value:function(){this.setState({showModalAlert:!1})}},{key:"doShowProgressBar",value:function(e){void 0!==e&&null!==e?(this.setState({strProgressMessage:e}),this.setState({showProgressBar:!0})):console.log("doShowProgressBar: need argument - strProgressMsg")}},{key:"doHideProgressBar",value:function(){this.setState({showProgressBar:!1})}},{key:"doSetProgressBarRatio",value:function(e){e>=0&&e<=99&&!1===this.state.showProgressBar&&this.setState({showProgressBar:!0}),this.setState({progressBarRatio:e})}},{key:"render",value:function(){var e=this.props;this.m_store=e;var t=e.isLoaded,i=e.fileName,a=e.arrErrors,r=t?"File: "+i:"Press Open button to load scene",n=this.state.strProgressMessage,s=o.a.createElement(x.a,null,o.a.createElement(b.a,{xs:!0,xl:!0,sm:!0,md:!0,lg:"12",style:{width:"100%"}},n,o.a.createElement(D.a,{animated:!0,variant:"success",now:this.state.progressBarRatio,label:"".concat(this.state.progressBarRatio,"%")}))),l=this.state.showProgressBar?s:o.a.createElement("p",null);return o.a.createElement(T.a,{fluid:"true",style:{height:"100%",minHeight:"100%"}},o.a.createElement(E.a,{bg:"light",variant:"light",expand:"lg"},o.a.createElement(E.a.Brand,null,o.a.createElement($a,null)),o.a.createElement(E.a.Toggle,{"aria-controls":"basic-navbar-nav"}),o.a.createElement(E.a.Collapse,{id:"basic-navbar-nav"},o.a.createElement(M.a,{className:"mr-auto"},o.a.createElement(E.a.Text,{className:"d-none d-sm-block"},r),o.a.createElement(Ha,{fileNameOnLoad:this.m_fileNameOnLoad}),o.a.createElement(no,null),o.a.createElement(uo,null),e.modeView===h.VIEW_2D?o.a.createElement(Io,null):o.a.createElement("p",null),t&&this.isWebGl20supported?o.a.createElement(Za,null):o.a.createElement("p",null)))),l,t?o.a.createElement(ii,null):o.a.createElement("p",null),a.length>0?o.a.createElement(Lo,null):o.a.createElement("p",null),o.a.createElement(Po,{stateVis:this.state.showModalText,onHide:this.onHideModalText,onShow:this.onShowModalText}),o.a.createElement(Xo,{stateVis:this.state.showModalAlert,onHide:this.onHideModalAlert,onShow:this.onShowModalAlert,title:this.state.strAlertTitle,text:this.state.strAlertText}))}}]),i}(o.a.Component),jo=Object(s.b)((function(e){return e}))(Bo),Go=(i(187),function(e){Object(g.a)(i,e);var t=Object(S.a)(i);function i(){return Object(v.a)(this,i),t.apply(this,arguments)}return Object(p.a)(i,[{key:"render",value:function(){return o.a.createElement(jo,null)}}]),i}(o.a.Component)),Wo=Object(s.b)((function(e){return e}))(Go),Ho=document.getElementById("root"),qo=Object(l.b)(f);n.a.render(o.a.createElement(s.a,{store:qo},o.a.createElement(Wo,null)),Ho),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))},56:function(e){e.exports=JSON.parse('{"name":"med3web","fullName":"Med3web 2d/3d Dicom and other medical formats web viewer/editor","description":"Med3web is unique 2d/3d medical volume data web viewer application. You can inspect data both in 2d and 3d modes.","version":"1.0.1","author":"EPAM Systems <mri@epam.com>","year":"2021","license":"Apache-2.0","licenses":[{"type":"Apache-2.0","url":"https://www.apache.org/licenses/LICENSE-2.0"}],"bugs":{"url":"https://github.com/epam/med3web/issues"},"homepage":"https://asimceman.github.io/med3web","private":false,"dependencies":{"-":"0.0.1","@tensorflow/tfjs":"^1.7.4","bootstrap":"^4.5.0","daikon":"^1.2.42","eslint":"^7.27.0","filereader-stream":"^2.0.0","jquery":"^3.5.1","popper.js":"^1.16.1","react":"^16.13.1","react-bootstrap":"^1.0.1","react-bootstrap-table-next":"^3.3.5","react-dom":"^16.13.1","react-nouislider":"^2.0.1","react-redux":"^6.0.0","react-scripts":"4.0.3","redux":"^4.0.5","save-dev":"0.0.1-security","three":"^0.101.1","zlib":"^1.0.5"},"scripts":{"start":"react-scripts start","build":"react-scripts build","test":"react-scripts test","lint":"eslint src/**/*.js","docker":"npm run build && docker run --name med3web -v ./build:/usr/share/nginx/html:ro -d -p 8080:80 nginx","prepare":"husky install","predeploy":"npm run build","deploy":"gh-pages -d build"},"lint-staged":{"*.js":"npm run lint"},"eslintConfig":{"extends":"react-app"},"browserslist":[">0.2%","not dead","not ie > 1","not op_mini all"],"devDependencies":{"@babel/core":"7.14.3","canvas":"^2.6.1","eslint-plugin-react":"7.x.x","gh-pages":"^3.2.3","husky":"^6.0.0","lint-staged":"^11.0.0","node-pre-gyp":"^0.14.0"},"engines":{"node":">=12.16.1","npm":">=6.13.4"}}')}},[[188,1,2]]]);
//# sourceMappingURL=main.82dd9740.chunk.js.map